(function () {
  'use strict';

  const PUBLIC_VAPID_KEY = 'BIkpXBrEUnbZW527GQKacT2wMXZQZIb6ASMxE3xL4NZ9U3Ey2-vEjaY-grU61o8sN_PE3TuBgup8k-m2qMTgXdQ';

  class AppManager {
    constructor() {
      this.host = window.location.hostname;
      this.user = window.hash;
      this.swRegistration = null;
      this.isSubscribed = false;
      this.applicationServerKey = this.urlBase64ToUint8Array(PUBLIC_VAPID_KEY);
      this.urls = [
        '/api/v1/h/recent',
        '/api/v1/h/trending',
        '/api/v1/q/trending/topics',
        '/api/v1/q/trending/people'
      ];
    }

    init() {
      if ('serviceWorker' in navigator && 'PushManager' in window) {
        this.registerServiceWorker()
          .then(() => this.subscribeUserToPush())
          .catch((error) => console.error('Error during initialization:', error));
      } else {
        console.warn('Push messaging is not supported');
      }
    }

    registerServiceWorker() {
      return navigator.serviceWorker.register('/service-worker.js', { scope: '/' })
        .then((registration) => {
          console.log('Service Worker registered successfully:', registration);
          this.swRegistration = registration;

          // register periodic background sync & background sync
          this.registerBackgroundSync(registration);
          this.registerPeriodicSync(registration);

          // add subscription to the window object
          window.swRegistration = registration;

          this.fetchAndCacheData();
          return registration;
        })
        .catch((error) => {
          console.error('Service Worker registration failed:', error);
          throw error;
        });
    }

    subscribeUserToPush() {
      // if not user is logged in, don't subscribe
      if (!this.user) return Promise.resolve();

      return this.swRegistration.pushManager.getSubscription()
        .then(async (subscription) => {
          this.isSubscribed = !(subscription === null);
          if (this.isSubscribed) {
            await this.sendSubscriptionToServer(subscription);
            console.log('User is already subscribed');
            return subscription;
          } else {
            return this.swRegistration.pushManager.subscribe({
              userVisibleOnly: true,
              applicationServerKey: this.applicationServerKey,
            });
          }
        }).then(async (subscription) => await this.sendSubscriptionToServer(subscription));
    }

    registerBackgroundSync = async registration => {
      try {
        // Check if sync registration already exists
        const syncTags = await registration.sync.getTags();
        if (!syncTags.includes('update-notifications')) {
          await registration.sync.register('update-notifications');
          console.log('Background sync registered!');
        } else {
          console.log('Background sync already registered.');
        }
      } catch (error) {
        console.warn("Background Sync could not be registered:");
      }
    }

    registerPeriodicSync = async registration => {
      try {
        // Check if periodic background sync is allowed
        const status = await navigator.permissions.query({
          name: 'periodic-background-sync'
        });
    
        if (status.state === 'granted' && 'periodicSync' in registration) {
          const periodicTags = await registration.periodicSync.getTags();
          if (!periodicTags.includes('fetch-updates')) {
            await registration.periodicSync.register("fetch-updates", {
              minInterval: 24 * 60 * 60 * 1000, // Minimum interval of 1 day
            });
            console.log('Periodic sync registered!');
          } else {
            console.log('Periodic sync already registered.');
          }
        } else {
          console.error('Periodic Background Sync permission denied.');
        }
      } catch (error) {
        console.warn("Periodic Sync could not be registered:");
      }
    }

    sendSubscriptionToServer =  async subscription => {
      try {
        const response = await fetch(`/api/v1/push/subscribe`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(subscription),
        });

        const result = await response.json();
        console.log('Subscription sent to server:', result);
      }
      catch(error){
        console.warn('Error sending push notification subscription to server');
      }  }

    urlBase64ToUint8Array(base64String) {
      const cleanedBase64 = base64String.replace(/[^A-Za-z0-9\-_]/g, '');
      const padding = '='.repeat((4 - (cleanedBase64.length % 4)) % 4);
      const base64 = (cleanedBase64 + padding)
        .replace(/\-/g, '+')
        .replace(/_/g, '/');

      try {
        const rawData = atob(base64);
        const outputArray = new Uint8Array(rawData.length);
        for (let i = 0; i < rawData.length; ++i) {
          outputArray[i] = rawData.charCodeAt(i);
        }
        return outputArray;
      } catch (error) {
        console.error('Error in urlBase64ToUint8Array:', error);
        throw new Error('Invalid base64 string');
      }
    }

    // Fetch data from network and cache it for offline use: urls are defined in the constructor
    fetchAndCacheData = async () => {
      const maxAge = 60 * 1000; // 1 minute
      const fetchOptions = {
        headers: {
          'Content-Type': 'application/json',
          'Max-Age': maxAge,
        },
      };

      try {
        await Promise.all(this.urls.map(url => this.getCacheData(url, maxAge, fetchOptions)));
        
        // log success
        console.log('Data fetched and cached successfully');
      }
      catch (error) {
        console.error('Error fetching and caching data:', error);
        // retry after 5 seconds
        setTimeout(this.fetchAndCacheData, 5000);
      }
    }

    getCacheData = async (url, maxAge, options = {}) => {
      const cacheName = "user-cache";
    
      try {
        const cache = await caches.open(cacheName);
        const cachedResponse = await cache.match(url);
    
        if (cachedResponse) {
          const cachedData = await cachedResponse.json();
          const cacheTime = cachedData.timestamp;
    
          // Check if cache is still valid
          if (Date.now() - cacheTime < maxAge) {
            return { cachedData: true, networkResponse: false };
          }
        }
    
        // If cache doesn't exist or is expired, fetch new data
        const networkResponse = await fetch(url, options);
        const data = await networkResponse.clone().json();
    
        // Store the new data in cache with a timestamp
        const cacheData = {
          data: data,
          timestamp: Date.now()
        };
        
        const cacheResponse = new Response(JSON.stringify(cacheData));
        await cache.put(url, cacheResponse);
    
        return { cachedData: false, networkResponse: true };
      } catch (error) {
        console.error('Error fetching data:', error);
        throw error;
      }
    };

    // Make the AppManager self-initiating
    start() {
      this.init();
    }
  }

  class AppHome extends HTMLElement {
    constructor() {
      // We are not even going to touch this.
      super();

      this.setTitle();

      // let's create our shadow root
      this.shadowObj = this.attachShadow({ mode: "open" });

      this.render();
    }

    setTitle = () => {
      // update title of the document
      document.title = 'Home | Explore, create and contribute to ideas that can change the world';
    }

    render() {
      this.shadowObj.innerHTML = this.getTemplate();
    }

    connectedCallback() {
      // request user to enable notifications
      this.checkNotificationPermission();

      // onpopstate event
      this.onPopEvent();

      // Watch for media query changes
      const mql = window.matchMedia('(max-width: 660px)');

      // fetch content
      const container = this.shadowObj.querySelector('.feeds');
      this.fetchContent(container);

      this.watchMediaQuery(mql);
    }

    checkNotificationPermission = async () => {
      if(window.notify && !window.notify.permission) {
        await window.notify.requestPermission();
      }
    }

    disconnectedCallback() {
      this.enableScroll();
      // clear window.home
      window.home = null;
    }

    // watch for mql changes
    watchMediaQuery = mql => {
      mql.addEventListener('change', () => {
        // Re-render the component
        this.render();

        // call onpopstate event
        this.onPopEvent();
      });
    }

    onPopEvent = () => {
      const outerThis = this;
      // Update state on window.onpopstate
      window.onpopstate = event => {
        // This event will be triggered when the browser's back button is clicked

        if (event.state) {
          if (event.state.popup) {
            return;
          }
          
          if (event.state.page) {
            outerThis.updatePage(event.state.content);
          }
        }
      };
    }

    updatePage = content => {
      // select body
      const body = document.querySelector('body');

      // populate content
      body.innerHTML = content;
    }

    disableScroll() {
      // Get the current page scroll position
      let scrollTop = window.scrollY || document.documentElement.scrollTop;
      let scrollLeft = window.scrollX || document.documentElement.scrollLeft;
      document.body.classList.add("stop-scrolling");

      // if any scroll is attempted, set this to the previous value
      window.onscroll = function () {
        window.scrollTo(scrollLeft, scrollTop);
      };
    }

    enableScroll() {
      document.body.classList.remove("stop-scrolling");
      window.onscroll = function () { };
    }

    getTemplate = () => {
      // Show HTML Here
      return `
      ${this.getBody()}
      ${this.getStyles()}
    `;
    }
    
    fetchContent = container => {
      let intervalId;
    
      const fetchLogic = (getContentFunction) => {
        if (!window.home) return;
        const home = window.home;
        
        if (home.last === true) {
          clearInterval(intervalId);
          return;
        }
        
        if (home.loaded) {
          container.insertAdjacentHTML('beforeend', getContentFunction(home.next));
        }

        // set loaded to false
        window.home.loaded = false;
      };
    
      intervalId = setInterval(() => fetchLogic(this.getStepContent), 500);
    };

    getStepContent = step => {
      if (step === 1) {
        return /* html */`
        <stories-container stories="recent" url="${this.getAttribute('recent-url')}"></stories-container>
      `
      } else if (step === 2) {
        return /* html */`
        <topics-container url="/api/v1/q/trending/topics"></topics-container>
      `
      } else if (step === 3) {
        return /* html */`
        <discover-people url="${this.getAttribute('trending-people')}" home="true"></discover-people>
      `
      } else if (step === 4) {
        return /* html */`
        <home-feed url="${this.getAttribute('feeds-url')}" page="1"></home-feed>
      `
      } else return '';
    }

    getBody = () => {
      const mql = window.matchMedia('(max-width: 660px)');
      if (mql.matches) {
        return /* html */`
        ${this.getTop()}
        <div class="feeds">
          <add-container type="story"></add-container>
          <feed-container url="${this.getAttribute('trending-url')}"></feed-container>
        <div>
      `;
      }
      else {
        return /* html */`
        <div class="feeds">
          ${this.getTop()}
          <add-container type="story"></add-container>
          <feed-container url="${this.getAttribute('trending-url')}"></feed-container>
        </div>
        <div class="side">
          <topics-container url="/api/v1/q/trending/topics"></topics-container>
          ${this.getInfo()}
        </div>
      `;
      }
    }

    getTop = () => {
      return /* html */ `
      <header-wrapper section="Home" type="home"
        user-url="${this.getAttribute('url')}" auth-url="${this.getAttribute('auth-url')}"
        url="${this.getAttribute('url')}" search-url="${this.getAttribute('search-url')}">
      </header-wrapper>
    `
    }

    getInfo = () => {
      return /*html*/`
      <info-container docs="/about/docs" new="/about/new"
       feedback="/about/feedback" request="/about/request" code="/about/code" donate="/about/donate" contact="/about/contact" company="https://github.com/aduki-hub">
      </info-container>
    `
    }

    getStyles() {
      return /* css */`
	    <style>
	      *,
	      *:after,
	      *:before {
	        box-sizing: border-box !important;
	        font-family: inherit;
	        -webkit-box-sizing: border-box !important;
	      }

	      *:focus {
	        outline: inherit !important;
	      }

	      *::-webkit-scrollbar {
	        width: 3px;
	      }

	      *::-webkit-scrollbar-track {
	        background: var(--scroll-bar-background);
	      }

	      *::-webkit-scrollbar-thumb {
	        width: 3px;
	        background: var(--scroll-bar-linear);
	        border-radius: 50px;
	      }

	      h1,
	      h2,
	      h3,
	      h4,
	      h5,
	      h6 {
	        padding: 0;
	        margin: 0;
	        font-family: inherit;
	      }

	      p,
	      ul,
	      ol {
	        padding: 0;
	        margin: 0;
	      }

	      a {
	        text-decoration: none;
	      }

	      :host {
          font-size: 16px;
          padding: 0;
          margin: 0;
          display: flex;
          justify-content: space-between;
          gap: 30px;
        }

        .feeds {
          display: flex;
          flex-flow: column;
          gap: 0;
          width: 63%;
        }

        div.side {
          padding: 25px 0;
          margin: 0;
          background-color: transparent;
          width: 33%;
          height: max-content;
          display: flex;
          flex-flow: column;
          gap: 20px;
          position: sticky;
          top: 0;
          height: 100vh;
          max-height: 100vh;
          overflow-y: scroll;
          scrollbar-width: none;
        }

        div.side::-webkit-scrollbar {
          visibility: hidden;
          display: none;
        }

        @media screen and (max-width:900px) {
         .feeds {
            width: 58%;
          }

          div.side {
            width: 40%;
          }
        }

				@media screen and (max-width:660px) {
					:host {
            font-size: 16px;
						padding: 0;
            margin: 0;
            display: flex;
            flex-flow: column;
            justify-content: space-between;
            gap: 0;
					}

					::-webkit-scrollbar {
						-webkit-appearance: none;
					}
					a {
						cursor: default !important;
          }

          .feeds {
            display: flex;
            flex-flow: column;
            gap: 0;
            padding: 0 0 50px 0;
            width: 100%;
          }

          div.side {
            padding: 0;
            margin: 0;
            width: 100%;
          }
				}
	    </style>
    `;
    }
  }

  class AppPost extends HTMLElement {
    constructor() {
      // We are not even going to touch this.
      super();

      this.setTitle();

      // let's create our shadow root
      this.shadowObj = this.attachShadow({ mode: "open" });

      this.boundHandleWsMessage = this.handleWsMessage.bind(this);
      this.checkAndAddHandler = this.checkAndAddHandler.bind(this);

      this.render();
    }

    setTitle = () => {
      // update title of the document
      document.title = `Post | by ${this.getAttribute('author-name')}`;
    }

    render() {
      this.shadowObj.innerHTML = this.getTemplate();
    }

    connectedCallback() {
      // Change style to flex
      this.style.display='flex';

      this.openUrl();

      // request user to enable notifications
      this.checkNotificationPermission();

      // connect to the WebSocket
      this.checkAndAddHandler();

      // mql query at: 660px
      const mql = window.matchMedia('(max-width: 660px)');

      this.watchMediaQuery(mql);

      // scroll the window to the top and set height to 100vh
      window.scrollTo(0, 0);
    }

    checkNotificationPermission = async () => {
      if(window.notify && !window.notify.permission) {
        await window.notify.requestPermission();
      }
    }

    checkAndAddHandler() {
      this.enableScroll();
      if (window.wss) {
        window.wss.addMessageHandler(this.boundHandleWsMessage);
        // console.log('WebSocket handler added successfully');
      } else {
        // console.log('WebSocket manager not available, retrying...');
        setTimeout(this.checkAndAddHandler, 500); // Retry after 500ms
      }
    }

    disconnectedCallback() {
      this.enableScroll();
      if (window.wss) {
        window.wss.removeMessageHandler(this.boundHandleWsMessage);
      }
    }

    handleWsMessage = message => {
      // Handle the message in this component
      // console.log('Message received in component:', message);
      const data = message.data;

      if (message.type !== 'action') return;

      const user = data?.user;
      const userHash = window.hash;

      const hash = this.getAttribute('hash').toUpperCase();
      const authorHash = this.getAttribute('author-hash').toUpperCase();

      const author = this.shadowObj.querySelector('author-wrapper');

      const wrapper = this.shadowObj.querySelector('action-wrapper');

      const VotesWrapper = this.shadowObj.querySelector('poll-wrapper');

      const target = data.hashes.target;

      // handle connect action
      if (data.action === 'connect' && data.kind === 'user') {
        this.handleConnectAction(data, author, userHash, authorHash);
      }
      else if(hash === target) {
        if (data.action === 'reply') {
          const replies = this.parseToNumber(this.getAttribute('replies')) + data.value;
          this.updateReplies(wrapper, replies);
        }
        else if(data.action === 'view') {
          const views = this.parseToNumber(this.getAttribute('views')) + data.value;
          this.updateViews(wrapper, views);
        }
        else if (data.action === 'like') {
          if(user !== null && user === userHash) {
            return;
          }
          // get likes parsed to number
          const likes = (this.parseToNumber(this.getAttribute('likes')) + data.value);
          // update likes
          this.updateLikes(wrapper, likes);
        }
        else if (data.action === 'vote') {
          if(user !== null && user === userHash) {
            return;
          }
          // update likes
          this.updateVote(VotesWrapper, data.value);
        }
      }
    }

    sendWsMessage(data) {
      window.wss.sendMessage(data);
    }

    handleConnectAction = (data, author, userHash, authorHash) => {
      const to = data.hashes.to;
      if(to === authorHash) {
        const followers = this.parseToNumber(this.getAttribute('author-followers')) + data.value;
        this.setAttribute('author-followers', followers);
        this.updateFollowers(author, followers);

        if (data.hashes.from === userHash) {
          const value = data.value === 1 ? 'true' : 'false';
          // update user-follow/auth-follow attribute
          this.setAttribute('author-follow', value);
          if(author) {
            author.setAttribute('user-follow', value);
          }
        }

        if(author) {
          author.setAttribute('reload', 'true');
        }
      }
    }

    updateLikes = (element, value) => {
      // update likes in the element and this element
      this.setAttribute('likes', value);
      element.setAttribute('likes', value);
      element.setAttribute('reload', 'true');
    }

    updateVote = (element, value) => {
      if(element) {
        element.setAttribute('vote', value);
        element.setAttribute('reload', 'true');
      }
    }

    updateViews = (element, value) => {
      // update views in the element and this element
      this.setAttribute('views', value);
      element.setAttribute('views', value);
      element.setAttribute('reload', 'true');
    }

    updateReplies = (element, value) => {
      // update replies in the element and this element
      this.setAttribute('replies', value);
      element.setAttribute('replies', value);
      element.setAttribute('reload', 'true');
    }

    updateFollowers = (element, value) => {
      if (!element) {
        return;
      }
      element.setAttribute('followers', value);
      element.setAttribute('reload', 'true');
    }

    updateAuthorFollowers = (element, value) => {
      element.setAttribute('author-followers', value);
      element.setAttribute('reload', 'true');
    }

    parseToNumber = str => {
      // Try parsing the string to an integer
      const num = parseInt(str);

      // Check if parsing was successful
      if (!isNaN(num)) {
        return num;
      } else {
        return 0;
      }
    }

    formatDateWithRelativeTime = isoDateStr => {
      // 1. Convert ISO date string with timezone to local Date object
      let date;
      try {
        date = new Date(isoDateStr);
      }
      catch (error) {
        date = new Date(Date.now());
      }

      // Get date
      const localDate = date.toLocaleDateString('en-US', {
        year: 'numeric', month: 'short', day: '2-digit'
      });

      // Get time
      let localTime = date.toLocaleDateString('en-US', {
        hour: 'numeric', minute: '2-digit', hour12: true
      });

      localTime = localTime.split(',')[1].trim();

      return {dateStr: localDate, timeStr: localTime }
    }

    watchMediaQuery = mql => {
      mql.addEventListener('change', () => {

        this.render();
      });
    }

    openUrl = () => {
      // get all the links
      const links = this.shadowObj.querySelectorAll('div#content a');
      const body = document.querySelector('body');

      // loop through the links
      if (!links) return;

      links.forEach(link => {
        // add event listener to the link
        link.addEventListener('click', event => {
          event.preventDefault();
          // get the url
          const url = link.getAttribute('href');

          // link pop up
          let linkPopUp = `<url-popup url="${url}"></url-popup>`;

          // open the popup
          body.insertAdjacentHTML('beforeend', linkPopUp);
        });
      });
    }

    disableScroll() {
      // Get the current page scroll position
      let scrollTop = window.scrollY || document.documentElement.scrollTop;
      let scrollLeft = window.scrollX || document.documentElement.scrollLeft;
      document.body.classList.add("stop-scrolling");

      // if any scroll is attempted, set this to the previous value
      window.onscroll = function () {
        window.scrollTo(scrollLeft, scrollTop);
      };
    }

    enableScroll() {
      document.body.classList.remove("stop-scrolling");
      window.onscroll = function () { };
    }

    getTemplate = () => {
      // Show HTML Here
      return `
      <div class="container">
        ${this.getBody()}
      </div>
      ${this.getStyles()}
    `;
    }

    getBody = () => {
      // Get story type
      const story = this.getAttribute('story');

      const mql = window.matchMedia('(max-width: 660px)');
      if (mql.matches) {
        return /* html */`
        ${this.getTop()}
        ${this.getReply(this.getAttribute('story'))}
        ${this.getAuthor()}
        ${this.getContent()}
        ${this.getPost(story)}
        ${this.getSection()}
      `;
      }
      else {
        return /* html */`
        <div class="feeds">
          ${this.getTop()}
          ${this.getReply(this.getAttribute('story'))}
          ${this.getContent()}
          ${this.getPost(story)}
          ${this.getSection()}
        </div>
        <div class="side">
          ${this.getAuthor()}
          <people-container url="/api/v1/users/recommended" type="profile"></people-container>
          ${this.getInfo()}
        </div>
      `;
      }
    }

    getContent = () => {
      const text = this.innerHTML;
      const parser = new DOMParser();
      const doc = parser.parseFromString(text, 'text/html');
      const parsedHTML = doc.body.innerHTML;
    
      return /* html */`
      <div class="content" id="content">
        ${parsedHTML}
      </div>
    `;
    }

    getPost = story => {
      switch (story) {
        case 'poll':
          return /*html */`
          ${this.getPoll()}
          ${this.getMeta()}
          ${this.getStats()}
        `
        default:
          return /* html */`
          ${this.getImages()}
          ${this.getMeta()}
          ${this.getStats()}
        `
      }
    }

    getSection = () => {
      return /* html */`
      <post-section kind="${this.getAttribute('story')}" url="${this.getAttribute('url')}" active="${this.getAttribute('tab')}" section-title="Post" 
        author-hash="${this.getAttribute('author-hash')}" hash="${this.getAttribute('hash')}" 
        replies="${this.getAttribute('replies')}" likes="${this.getAttribute('likes')}"
        replies-url="${this.getAttribute('replies-url')}" likes-url="${this.getAttribute('likes-url')}">
      </post-section>
    `
    }

    getTop = () => {
      return /* html */ `
      <header-wrapper section="Post" type="post"
        user-url="${this.getAttribute('user-url')}" auth-url="${this.getAttribute('auth-url')}"
        url="${this.getAttribute('story-url')}" search-url="${this.getAttribute('search-url')}">
      </header-wrapper>
    `
    }

    getAuthor = () => {
      let bio = this.getAttribute('author-bio') || 'This author has not provided a bio yet.';
      // replace all " and ' with &quot; and &apos; to avoid breaking the html
      bio = bio.replace(/"/g, '&quot;').replace(/'/g, '&apos;');
      return /* html */`
			<author-wrapper you="${this.getAttribute('author-you')}" hash="${this.getAttribute('author-hash')}" picture="${this.getAttribute('author-img')}" name="${this.getAttribute('author-name')}"
        stories="${this.getAttribute('author-stories')}" replies="${this.getAttribute('author-replies')}"
        followers="${this.getAttribute('author-followers')}" following="${this.getAttribute('author-following')}" user-follow="${this.getAttribute('author-follow')}" contact='${this.getAttribute("author-contact")}'
        verified="${this.getAttribute('author-verified')}" url="/u/${this.getAttribute('author-hash').toLowerCase()}"
        bio="${bio}">
      </author-wrapper>
		`
    }

    getPoll = () =>  {
      return /*html*/`
      <votes-wrapper reload="false" votes="${this.getAttribute('votes')}" selected="${this.getAttribute('selected')}"
        hash="${this.getAttribute('hash')}" wrapper="true"
        end-time="${this.getAttribute('end-time')}" voted="${this.getAttribute('voted')}" options="${this.getAttribute('options')}">
      </votes-wrapper>
    `
    }

    getMeta = () => {
      let dateObject = this.formatDateWithRelativeTime(this.getAttribute('time'));
      return /* html */`
      <div class="meta">
        <span class="sp">on</span>
        <time class="published" datetime="${this.getAttribute('time')}">${dateObject.dateStr}</time>
        <span class="sp">•</span>
        <span class="sp">at</span>
        <span class="time">${dateObject.timeStr}</span>
      </div>
    `
    }

    getStats = () =>  {
      return /*html*/`
      <action-wrapper full="true" kind="${this.getAttribute('story')}" reload="false" likes="${this.getAttribute('likes')}"
        replies="${this.getAttribute('replies')}" liked="${this.getAttribute('liked')}" wrapper="true" images="${this.getAttribute('images')}"
        hash="${this.getAttribute('hash')}" views="${this.getAttribute('views')}" url="${this.getAttribute('url')}" summary="Post by - ${this.getAttribute('author-name')}"
        preview-title="" time="${this.getAttribute('time')}" author-hash="${this.getAttribute('author-hash')}">
        ${this.getHTML()}
      </action-wrapper>
    `
    }

    getHTML = () => {
      const text = this.innerHTML;
      const parser = new DOMParser();
      const doc = parser.parseFromString(text, 'text/html');
      return doc.body.innerHTML;
    }

    getImages = () => {
      const images = this.getAttribute('images');
      if(!images || images === 'null') return '';

      const imageArray = images.split(',');

      // if length is greater is less than 1
      if(imageArray.length < 1) return '';

      // return
      return /* html */`
      <images-wrapper images="${images}"></images-wrapper>
    `
    }

    getInfo = () => {
      return /*html*/`
      <info-container docs="/about/docs" new="/about/new"
       feedback="/about/feedback" request="/about/request" code="/about/code" donate="/about/donate" contact="/about/contact" company="https://github.com/aduki-hub">
      </info-container>
    `
    }

    getReply = story => {
      if (story === 'reply') {
        const parent = this.getAttribute('parent');
        let url = parent.startsWith('P') ? `/api/v1/p/${parent.toLowerCase()}/preview` : `/api/v1/r/${parent.toLowerCase()}/preview`;
        return /*html*/`
        <preview-post url="${url}" hash="${parent}" preview="full"></preview-post>
      `
      } else return '';
    }

    getStyles() {
      return /*css*/`
	    <style>
	      *,
	      *:after,
	      *:before {
	        box-sizing: border-box !important;
	        font-family: inherit;
	        -webkit-box-sizing: border-box !important;
	      }

	      *:focus {
	        outline: inherit !important;
	      }

	      *::-webkit-scrollbar {
	        width: 3px;
	      }

	      *::-webkit-scrollbar-track {
	        background: var(--scroll-bar-background);
	      }

	      *::-webkit-scrollbar-thumb {
	        width: 3px;
	        background: var(--scroll-bar-linear);
	        border-radius: 50px;
	      }

	      h1,
	      h2,
	      h3,
	      h4,
	      h5,
	      h6 {
	        padding: 0;
	        margin: 0;
	        font-family: inherit;
	      }

	      p,
	      ul,
	      ol {
	        padding: 0;
	        margin: 0;
	      }

	      a {
	        text-decoration: none;
	      }

	      :host {
          font-size: 16px;
          padding: 0;
          margin: 0;
          display: flex;
          flex-flow: column;
          gap: 0;
        }

        .container {
          display: flex;
          justify-content: space-between;
          gap: 30px;
          min-height: 100dvh;
        }

        .feeds {
          display: flex;
          flex-flow: column;
          gap: 0;
          width: 63%;
        }

        div.side {
          padding: 25px 0;
          width: 33%;
          display: flex;
          flex-flow: column;
          gap: 20px;
          position: sticky;
          top: 0;
          height: 100vh;
          max-height: 100vh;
          overflow-y: scroll;
          scrollbar-width: none;
        }

        div.side::-webkit-scrollbar {
          visibility: hidden;
          display: none;
        }

        .meta {
          border-bottom: var(--border);
          border-top: var(--border);
          margin: 10px 0 0 0;
          padding: 10px 0;
          display: flex;
          position: relative;
          color: var(--text-color);
          align-items: center;
          font-family: var(--font-text), sans-serif;
          gap: 5px;
          font-size: 1rem;
          font-weight: 600;
        }

        .meta > .sp {
          font-size: 1rem;
          color: var(--gray-color);
          font-weight: 400;
        }

        .content {
          display: flex;
          font-size: 1.05rem; 
          flex-flow: column;
          color: var(--text-color);
          font-family: var(--font-main), sans-serif;
          line-height: 1.4;
          gap: 0;
          margin: 0;
          padding: 3px 0 0;
        }

        .content h6,
        .content h5,
        .content h4,
        .content h3,
        .content h1 {
          padding: 0;
          font-size: 1.3rem !important;
          color: var(--title-color);
          font-weight: 500;
          line-height: 1.5;
          margin: 5px 0;
        }

        .content p {
          margin: 5px 0;
          line-height: 1.4;
        }

        .content a {
          text-decoration: none;
          cursor: pointer;
          color: var(--anchor-color) !important;
        }

        .content a:hover {
          text-decoration: underline;
        }

        .content blockquote {
          margin: 2px 0;
          padding: 5px 0;
          font-style: italic;
          background: var(--background);
          color: var(--text-color);
          font-weight: 400;
          line-height: 1.4;
        }

        .content blockquote p {
          margin: 0;
        }

        .content blockquote * {
          margin: 0;
        }

        .content hr {
          border: none;
          background-color: var(--text-color);
          height: 1px;
          margin: 10px 0;
        }

        .content b,
        .content strong {
          font-weight: 700;
          line-height: 1.4;

        }

        .content ul,
        .content ol {
          margin: 5px 0 15px 20px;
          padding: 0 0 0 15px;
          color: inherit;
          line-height: 1.4;
        }

        .content ul li,
        .content ol li {
          margin: 6px 0;
          padding: 0;
          color: inherit;
        }

        .content code {
          background: var(--gray-background);
          padding: 0 5px;
          font-family: var(--font-mono);
          font-size: 0.9rem;
          border-radius: 5px;
        }

        @media screen and (max-width:900px) {
          .feeds {
            width: 58%;
          }

          div.side {
            width: 40%;
          }
        }

				@media screen and (max-width:660px) {
					:host {
            font-size: 16px;
					}

          .container {
            display: flex;
            flex-flow: column;
            justify-content: flex-start;
            gap: 0;
            min-height: max-content;
          }

					::-webkit-scrollbar {
						-webkit-appearance: none;
					}
					a {
						cursor: default !important;
          }

          .feeds {
            display: flex;
            flex-flow: column;
            gap: 0;
            width: 100%;
          }

          .content {
            display: flex;
            flex-flow: column;
            color: var(--text-color);
            line-height: 1.5;
            gap: 0;
            margin: 0;
          }

          div.side {
            padding: 0;
            width: 100%;
          }

          .meta {
            display: flex;
            position: relative;
            color: var(--text-color);
            align-items: center;
            font-family: var(--font-text), sans-serif;
            font-size: 0.9rem;
            gap: 5px;
            font-weight: 600;
          }

          a,
          .stats > .stat {
            cursor: default !important;
          }

          a,
          span.stat,
          span.action {
            cursor: default !important;
          }

          .content a {
            cursor: default !important;
          }

          .stats.actions > span.play:hover,
          .stats.actions > span.stat:hover,
          .stats.actions > span.action:hover {
            background: none;
          }
				}
	    </style>
    `;
    }
  }

  class AppProfile extends HTMLElement {
    constructor() {
      // We are not even going to touch this.
      super();

      this.setTitle();

      // Check if you is true and convert to boolean
      this._you = this.getAttribute('you') === 'true';

      // let's create our shadow root
      this.shadowObj = this.attachShadow({ mode: "open" });

      this.boundHandleWsMessage = this.handleWsMessage.bind(this);
      this.checkAndAddHandler = this.checkAndAddHandler.bind(this);

      this.render();
    }

    setTitle = () => {
      // update title of the document
      document.title = `User | ${this.getAttribute('name')}`;
    }

    render() {
      this.shadowObj.innerHTML = this.getTemplate();
    }

    static get observedAttributes() {
      return ['url', 'name', 'username', 'you', 'picture', 'verified', 'contact', 'followers', 'following', 'user-follow', 'bio', 'tab', 'stories-url', 'replies-url', 'followers-url', 'following-url', 'search-url', 'auth-url'];
    }

    attributeChangedCallback(name, oldValue, newValue) {
      return;
    }

    connectedCallback() {
      this.enableScroll();
      // Scroll to the top of the page
      window.scrollTo(0, 0);

      // request user to enable notifications
      this.checkNotificationPermission();

      // connect to the WebSocket
      this.checkAndAddHandler();

      // Watch for media query changes
      const mql = window.matchMedia('(max-width: 660px)');

      // Watch for media query changes
      this.watchMediaQuery(mql);
    }

    checkNotificationPermission = async () => {
      if(window.notify && !window.notify.permission) {
        await window.notify.requestPermission();
      }
    }

    checkAndAddHandler() {
      if (window.wss) {
        window.wss.addMessageHandler(this.boundHandleWsMessage);
        // console.log('WebSocket handler added successfully');
      } else {
        // console.log('WebSocket manager not available, retrying...');
        setTimeout(this.checkAndAddHandler, 500); // Retry after 500ms
      }
    }

    disconnectedCallback() {
      this.enableScroll();
      if (window.wss) {
        window.wss.removeMessageHandler(this.boundHandleWsMessage);
      }
    }

    handleWsMessage = message => {
      // Handle the message in this component
      // console.log('Message received in component:', message);
      const data = message.data;

      if (message.type !== 'action') return;

      const userHash = window.hash;

      const authorHash = this.getAttribute('hash').toUpperCase();

      const author = this.shadowObj.querySelector('profile-wrapper');

      // handle connect action
      if (data.action === 'connect' && data.kind === 'user') {
        this.handleConnectAction(data, author, userHash, authorHash);
      }
    }

    sendWsMessage(data) {
      window.wss.sendMessage(data);
    }

    handleConnectAction = (data, author, userHash, authorHash) => {
      const to = data.hashes.to;
      if(to === authorHash) {
        const followers = this.parseToNumber(this.getAttribute('followers')) + data.value;
        this.setAttribute('followers', followers);
        author.setAttribute('followers', followers);

        if (data.hashes.from === userHash) {
          const value = data.value === 1 ? 'true' : 'false';
          // update user-follow/auth-follow attribute
          this.setAttribute('user-follow', value);
          author.setAttribute('user-follow', value);
        }

        // reload the author component
        author.setAttribute('reload', 'true');
      }
    }

    // watch for mql changes
    watchMediaQuery = mql => {
      mql.addEventListener('change', () => {
        // Re-render the component
        this.render();
      });
    }

    formatNumber = n => {
      if (n >= 0 && n <= 999) {
        return n.toString();
      } else if (n >= 1000 && n <= 9999) {
        const value = (n / 1000).toFixed(2);
        return `${value}k`;
      } else if (n >= 10000 && n <= 99999) {
        const value = (n / 1000).toFixed(1);
        return `${value}k`;
      } else if (n >= 100000 && n <= 999999) {
        const value = (n / 1000).toFixed(0);
        return `${value}k`;
      } else if (n >= 1000000 && n <= 9999999) {
        const value = (n / 1000000).toFixed(2);
        return `${value}M`;
      } else if (n >= 10000000 && n <= 99999999) {
        const value = (n / 1000000).toFixed(1);
        return `${value}M`;
      } else if (n >= 100000000 && n <= 999999999) {
        const value = (n / 1000000).toFixed(0);
        return `${value}M`;
      } else if (n >= 1000000000) {
        return "1B+";
      }
      else {
        return 0;
      }
    }

    parseToNumber = num_str => {
      // Try parsing the string to an integer
      const num = parseInt(num_str);

      // Check if parsing was successful
      if (!isNaN(num)) {
        return num;
      } else {
        return 0;
      }
    }

    disableScroll() {
      // Get the current page scroll position
      let scrollTop = window.scrollY || document.documentElement.scrollTop;
      let scrollLeft = window.scrollX || document.documentElement.scrollLeft;
      document.body.classList.add("stop-scrolling");

      // if any scroll is attempted, set this to the previous value
      window.onscroll = function () {
        window.scrollTo(scrollLeft, scrollTop);
      };
    }

    enableScroll() {
      document.body.classList.remove("stop-scrolling");
      window.onscroll = function () { };
    }

    getDate = isoDateStr => {
      const dateIso = new Date(isoDateStr); // ISO strings with timezone are automatically handled
      let userTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
      // userTimezone.replace('%2F', '/')

      // Convert posted time to the current timezone
      const date = new Date(dateIso.toLocaleString('en-US', { timeZone: userTimezone }));

      return `
      ${date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}
    `
    }

    getTemplate = () => {
      // Show HTML Here
      return `
      ${this.getBody()}
      ${this.getStyles()}
    `;
    }

    getBody = () => {
      const authorContent = this.getAuthor();

      const mql = window.matchMedia('(max-width: 660px)');
      if (mql.matches) {
        return /* html */`
        ${this.getTop()}
        ${authorContent}
        ${this.getSection()}
      `;
      }
      else {
        return /* html */`
        <section class="main">
          ${this.getTop()}
          <div class="body">
            ${authorContent}
            ${this.getSection()}
          </div>
        </section>

        <section class="side">
          ${this.getHighlights()}
          <people-container url="/api/v1/users/recommended" type="profile"></people-container>
          ${this.getInfo()}
        </section>
      `;
      }
    }

    getTop = () => {
      return /* html */ `
      <header-wrapper section="Profile" type="profile"
        user-url="${this.getAttribute('url')}" auth-url="${this.getAttribute('auth-url')}"
        url="${this.getAttribute('url')}" search-url="${this.getAttribute('search-url')}">
      </header-wrapper>
    `
    }

    getAuthor = () => {
      // get url
      const url = this.getAttribute('url');

      // trim white spaces and convert to lowercase
      let formattedUrl = url.toLowerCase();
      return /* html */`
      <profile-wrapper name="${this.getAttribute('name')}" hash="${this.getAttribute('hash')}" you="${this._you}" replies="${this.getAttribute('replies')}"
        url="${formattedUrl}" picture="${this.getAttribute('picture')}" verified="${this.getAttribute('verified')}" stories="${this.getAttribute('stories')}"
        followers="${this.getAttribute('followers')}" following="${this.getAttribute('following')}" user-follow="${this.getAttribute('user-follow')}"
        bio="${this.getAttribute('bio')}" contact='${this.getAttribute("contact")}'>
      </profile-wrapper>
    `
    }

    getSection = () => {
      return /* html */`
      <profile-section hash="${this.getAttribute('hash')}" url="${this.getAttribute('url')}" active="${this.getAttribute('tab')}" section-title="Profile" 
        stories-url="${this.getAttribute('stories-url')}" stories="${this.getAttribute('stories')}" contact='${this.getAttribute("contact")}'
        replies-url="${this.getAttribute('replies-url')}" replies="${this.getAttribute('replies')}"
        followers-url="${this.getAttribute('followers-url')}" followers="${this.getAttribute('followers')}"
        following-url="${this.getAttribute('following-url')}" following="${this.getAttribute('following')}">
      </profile-section>
    `
    }

    getHighlights = () => {
      // get url
      const url = this.getAttribute('url');
    
      // trim white spaces and convert to lowercase
      let formattedUrl = url.toLowerCase();

      return /* html */`
      <highlights-container url="/api/v1${formattedUrl}/stats" name="${this.getAttribute('name')}"
        followers="${this.getAttribute('followers')}" following="${this.getAttribute('following')}" 
        stories="${this.getAttribute('stories')}" replies="${this.getAttribute('replies')}">
      </highlights-container>
    `
    }

    getInfo = () => {
      return /*html*/`
      <info-container docs="/about/docs" new="/about/new"
       feedback="/about/feedback" request="/about/request" code="/about/code" donate="/about/donate" contact="/about/contact" company="https://github.com/aduki-hub">
      </info-container>
    `
    }

    getStyles() {
      return /* css */`
	    <style>
	      *,
	      *:after,
	      *:before {
	        box-sizing: border-box !important;
	        font-family: inherit;
	        -webkit-box-sizing: border-box !important;
	      }

	      *:focus {
	        outline: inherit !important;
	      }

	      *::-webkit-scrollbar {
	        width: 3px;
	      }

	      *::-webkit-scrollbar-track {
	        background: var(--scroll-bar-background);
	      }

	      *::-webkit-scrollbar-thumb {
	        width: 3px;
	        background: var(--scroll-bar-linear);
	        border-radius: 50px;
	      }

	      h1,
	      h2,
	      h3,
	      h4,
	      h5,
	      h6 {
	        padding: 0;
	        margin: 0;
	        font-family: inherit;
	      }

	      p,
	      ul,
	      ol {
	        padding: 0;
	        margin: 0;
	      }

	      a {
	        text-decoration: none;
	      }

	      :host {
          font-size: 16px;
          padding: 0;
          margin: 0;
          display: flex;
          width: 100%;
          justify-content: space-between;
          gap: 30px;
          min-height: 100vh;
        }

        section.main {
          /* border: 1px solid #6b7280; */
          display: flex;
          flex-flow: column;
          align-items: start;
          gap: 0;
          width: 63%;
        }

        .body {
          display: flex;
          flex-flow: column;
          gap: 0;
          width: 100%;
        }

        section.side {
          padding: 25px 0;
          width: 33%;
          display: flex;
          flex-flow: column;
          gap: 20px;
          position: sticky;
          top: 0;
          height: 100vh;
          max-height: 100vh;
          overflow-y: scroll;
          scrollbar-width: none;
        }

        section.side::-webkit-scrollbar {
          visibility: hidden;
          display: none;
        }

        @media screen and (max-width:900px) {
          section.main {
            width: 58%;
          }

          section.side {
            width: 40%;
          }
        }

				@media screen and (max-width:660px) {
					:host {
            font-size: 16px;
						padding: 0;
            margin: 0;
            display: flex;
            flex-flow: column;
            justify-content: start;
            gap: 0;
					}

          .top {
            display: flex;
            width: 100%;
            flex-flow: row;
            align-items: center;
            gap: 8px;
          }
          
          .tab-control {
            border-bottom: var(--border-mobile);
            margin: 5px 0 5px 0;
            position: sticky;
            top: 50px;
          }

          .actions > .action {
            cursor: default !important;
            display: flex;
            width: calc(50% - 15px);
            padding: 6px 25px;
          }

          .tab-control > ul.tab > li.tab-item,
					.action,
					a {
						cursor: default !important;
          }

          .section.main {
            display: flex;
            flex-flow: column;
            gap: 0;
            width: 100%;
          }

          section.side {
            padding: 0;
            display: none;
            width: 0%;
          }
				}
	    </style>
    `;
    }
  }

  // noinspection RegExpRedundantEscape

  class AppLogon extends HTMLElement {
    constructor() {

      // We are not even going to touch this.
      super();

      this.setTitle();

      // check if the user is authenticated
      this._authenticated = window.hash ? true : false;

      // let's create our shadow root
      this.shadowObj = this.attachShadow({ mode: 'open' });

      this._step = 0;

      this._success = `
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
				<path	d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0m-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z" />
			</svg>
    `;

      this._failed = `
		  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"	viewBox="0 0 16 16">
				<path	d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0M5.354 4.646a.5.5 0 1 0-.708.708L7.293 8l-2.647 2.646a.5.5 0 0 0 .708.708L8 8.707l2.646 2.647a.5.5 0 0 0 .708-.708L8.707 8l2.647-2.646a.5.5 0 0 0-.708-.708L8 7.293z" />
			</svg>
    `;

      this._data = {
        "register": {},
        "login": {},
        "recovery": {},
        "user": {}
      };

      this.render();
    }

    setTitle = () => {
      document.title = 'Zoanai - Join, Login, Recover, and Explore';
    }

    render() {
      this.shadowObj.innerHTML = this.getTemplate();
    }

    connectedCallback() {
      const outerThis = this;
      const initialName = this.getAttribute('name');
      const contentContainer = this.shadowObj.querySelector('.logon-container');
      if (contentContainer) {
        const contentTitle = contentContainer.querySelector('.head > .logo h2 span.action');
        const stagesContainer = contentContainer.querySelector('.stages');

        // Check if the user is authenticated
        if (outerThis._authenticated) {
          // activate the login
          outerThis.activateLogin(contentContainer, stagesContainer, contentTitle);

          //set content title
          contentTitle.textContent = 'Welcome';
        }
        else {
          if (initialName === 'join') {
            outerThis.activateRegister(contentContainer, stagesContainer, contentTitle);
            outerThis.activateLogin(contentContainer, stagesContainer, contentTitle);
            this.activateForgot(contentContainer, stagesContainer, contentTitle);
          } else if (initialName === 'login') {
            outerThis.loginLoaded(contentContainer, stagesContainer, contentTitle);
          } else if (initialName === 'forgot') {
            outerThis.forgotLoaded(contentContainer, stagesContainer, contentTitle);
          } else if (initialName === 'register') {
            outerThis.registerLoaded(contentContainer, stagesContainer, contentTitle);
          } else {
            outerThis.activateRegister(contentContainer, stagesContainer, contentTitle);
            outerThis.activateLogin(contentContainer, stagesContainer, contentTitle);
            this.activateForgot(contentContainer, stagesContainer, contentTitle);
          }
        }
      }
    }

    setHash = name => {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);

      const cookie = parts.length === 2 ? parts.pop().split(';').shift() : null;

      // add cookie to the window
      window.hash = cookie;
    }

    disconnectedCallback() {
      // Remove all event listeners
    }

    loginLoaded = (contentContainer, stagesContainer, contentTitle) => {
      const outerThis = this;

      contentTitle.textContent = 'Login';
      outerThis.changeStages('login', stagesContainer);
      outerThis.nextStep('login', stagesContainer);

      outerThis.submitEvent('login', contentContainer.querySelector('form'));
      outerThis.prevStep('login', stagesContainer, contentContainer);
    }

    registerLoaded = (contentContainer, stagesContainer, contentTitle) => {
      const outerThis = this;

      contentTitle.textContent = 'Register';
      outerThis.changeStages('register', stagesContainer);
      outerThis.nextStep('register', stagesContainer);

      outerThis.submitEvent('register', contentContainer.querySelector('form'));
      outerThis.prevStep('register', stagesContainer, contentContainer);
    }

    forgotLoaded = (contentContainer, stagesContainer, contentTitle) => {
      const outerThis = this;

      contentTitle.textContent = 'Recover';
      outerThis.changeStages('forgot', stagesContainer);
      outerThis.nextStep('forgot', stagesContainer);

      outerThis.submitEvent('forgot', contentContainer.querySelector('form'));
      outerThis.prevStep('forgot', stagesContainer, contentContainer);
    }

    activateRegister(contentContainer, stagesContainer, contentTitle) {
      const loader = this.getLoader();
      const form = this.getRegistrationForm();
      const outerThis = this;
      const registerButton = contentContainer.querySelector('.welcome > a.register');
      if (registerButton) {
        registerButton.addEventListener('click', e => {
          e.preventDefault();
          e.stopPropagation();

          contentContainer.insertAdjacentHTML('afterbegin', loader);

          const welcome = contentContainer.querySelector('.welcome');

          setTimeout(() => {
            welcome.remove();
            contentTitle.textContent = 'Register';
            outerThis.changeStages('register', stagesContainer);
            outerThis.nextStep('register', stagesContainer);
            stagesContainer.insertAdjacentHTML('afterend', form);

            // Updating History State
            window.history.pushState(
              { content: form, page: 'register' },
              outerThis.getAttribute('register'), outerThis.getAttribute('register')
            );

            contentContainer.querySelector('#loader-container').remove();

            outerThis.submitEvent('register', contentContainer.querySelector('form'));
            outerThis.prevStep('register', stagesContainer, contentContainer);
          }, 1000);

        });
      }
    }

    activateLogin(contentContainer, stagesContainer, contentTitle) {
      const loader = this.getLoader();
      const form = this.getLoginForm();
      const outerThis = this;
      const loginButton = contentContainer.querySelector('a.login');
      if (loginButton) {
        loginButton.addEventListener('click', e => {
          e.preventDefault();
          e.stopPropagation();

          contentContainer.insertAdjacentHTML('afterbegin', loader);

          const welcome = contentContainer.querySelector('.welcome');
          const finish = contentContainer.querySelector('.finish');

          setTimeout(() => {
            if (welcome) {
              welcome.remove();
            }
            if (finish) {
              finish.remove();
            }
            contentTitle.textContent = 'Login';
            outerThis.changeStages('login', stagesContainer);
            outerThis.nextStep('login', stagesContainer);
            stagesContainer.insertAdjacentHTML('afterend', form);

            // Remove the loader
            contentContainer.querySelector('#loader-container').remove();

            // Updating History State
            window.history.pushState(
              { content: form, page: 'login' },
              outerThis.getAttribute('login'), outerThis.getAttribute('login')
            );

            outerThis.submitEvent('login', contentContainer.querySelector('form'));
            outerThis.prevStep('login', stagesContainer, contentContainer);
          }, 1000);

        });
      }
    }

    activateForgot(contentContainer, stagesContainer, contentTitle) {
      const loader = this.getLoader();
      const form = this.getForgotForm();
      const outerThis = this;

      const forgotButton = contentContainer.querySelector('.welcome  a.forgot');
      if (forgotButton) {
        forgotButton.addEventListener('click', e => {
          e.preventDefault();
          e.stopPropagation();
          
          contentContainer.insertAdjacentHTML('afterbegin', loader);

          const welcome = contentContainer.querySelector('.welcome');

          setTimeout(() => {
            if (welcome) {
              welcome.remove();
            }
            welcome.remove();
            contentTitle.textContent = 'Recover';
            outerThis.changeStages('forgot', stagesContainer);
            outerThis.nextStep('forgot', stagesContainer);
            stagesContainer.insertAdjacentHTML('afterend', form);
            
            // Updating History State
            window.history.pushState(
              { content: form, page: 'forgot' },
              outerThis.getAttribute('forgot'), outerThis.getAttribute('forgot')
            );

            contentContainer.querySelector('#loader-container').remove();

            outerThis.submitEvent('forgot', contentContainer.querySelector('form'));
            outerThis.prevStep('forgot', stagesContainer, contentContainer);
          }, 1000);
        });
      }
    }

    changeStages(stageType, stagesContainer) {
      const stages = stagesContainer.querySelectorAll('.no');

      switch (stageType) {
        case 'register':
          stagesContainer.classList.remove('login', 'welcome-stages', 'forgot');
          stagesContainer.classList.add('register');

          stages.forEach((stage, index) => {
            if (index >= 3) {
              stage.style.display = 'none';
            }
            else {
              stage.style.display = 'inline-block';
            }
          });

          break;

        case 'forgot':
          stagesContainer.classList.remove('login', 'welcome-stages', 'register');
          stagesContainer.classList.add('forgot');

          stages.forEach(stage => {
            stage.style.display = 'inline-block';
          });

          break;

        case 'login':
          stagesContainer.classList.remove('register', 'welcome-stages', 'forgot');
          stagesContainer.classList.add('login');

          stages.forEach((stage, index) => {
            if (index >= 2) {
              stage.style.display = 'none';
            }
          });

          break;

        case 'welcome':
          stagesContainer.classList.remove('register', 'login', 'forgot');
          stagesContainer.classList.add('welcome-stages');

          stages.forEach((stage, index) => {
            if (index === 2 || index === 3) {
              stage.style.display = 'none';
            }
          });

          break;
      }
    }

    nextStep(stageType, stagesContainer) {
      const stages = stagesContainer.querySelectorAll('span.stage');

      switch (stageType) {
        case "register":
          if (this._step >= 4) {
            stages[4].classList.remove('active');
            stages[1].classList.add('active');
            this._step = 1;
          }
          else if ((this._step + 1) === 3) {
            stages[stages.length - 1].classList.add('active');
            this._step = (stages.length - 1);
          }
          else {
            stages[this._step + 1].classList.add('active');
            this._step += 1;
          }
          break;
        case "forgot":
          stages[this._step + 1].classList.add('active');
          this._step += 1;
          break;
        case "login":
          if (this._step >= 3) {
            stages[4].classList.remove('active');
            stages[3].classList.remove('active');
            stages[2].classList.remove('active');
            stages[1].classList.add('active');
            this._step = 1;
          }
          else if ((this._step + 1) === 2) {
            stages[stages.length - 1].classList.add('active');
            this._step = (stages.length - 1);
          }
          else {
            stages[this._step + 1].classList.add('active');
            this._step += 1;
          }
          break;
      }
    }

    prevStep(stageType, stagesContainer, contentContainer) {
      const outerThis = this;
      const welcome = this.getWelcome();
      const form = contentContainer.querySelector('form.fields');
      const stages = stagesContainer.querySelectorAll('span.stage');
      const contentTitle = contentContainer.querySelector('.head > .logo h2 span.action');

      const prevButton = form.querySelector('.actions > .action.prev ');

      prevButton.addEventListener('click', e => {
        e.preventDefault();

        prevButton.innerHTML = outerThis.getBtnAltLoader();
        prevButton.style.setProperty("pointer-events", 'none');

        if (stageType === "register") {
          if (outerThis._step <= 1) {
            contentTitle.textContent = "Join";
            setTimeout(() => {
              stages[1].classList.remove('active');
              form.remove();
              stagesContainer.insertAdjacentHTML('afterend', welcome);
              outerThis._step = 0;

              outerThis.activateRegister(contentContainer, stagesContainer, contentTitle);
              outerThis.activateLogin(contentContainer, stagesContainer, contentTitle);
              outerThis.activateForgot(contentContainer, stagesContainer, contentTitle);
            }, 1500);
          }
          else if (outerThis._step === 2) {
            setTimeout(() => {
              stages[outerThis._step].classList.remove('active');
              outerThis._step -= 1;
              const currentFields = form.querySelector('.field.password');
              if (currentFields) {
                currentFields.remove();
              }

              form.insertAdjacentHTML('afterbegin', outerThis.getBioFields());
            }, 1500);
          }
        }
        else if (stageType === "forgot") {
          if (outerThis._step <= 1) {
            contentTitle.textContent = "Join";
            setTimeout(() => {
              stages[1].classList.remove('active');
              form.remove();
              stagesContainer.insertAdjacentHTML('afterend', welcome);
              outerThis._step = 0;

              outerThis.activateRegister(contentContainer, stagesContainer, contentTitle);
              outerThis.activateLogin(contentContainer, stagesContainer, contentTitle);
              outerThis.activateForgot(contentContainer, stagesContainer, contentTitle);
            }, 1500);
          }
          else if (outerThis._step === 2) {
            setTimeout(() => {
              stages[outerThis._step].classList.remove('active');
              outerThis._step -= 1;
              const currentFields = form.querySelector('.forgot.code');
              if (currentFields) {
                currentFields.remove();
              }

              form.insertAdjacentHTML('afterbegin', outerThis.getForgotFields());
            }, 1500);
          }
          else if (outerThis._step === 3) {
            setTimeout(() => {
              stages[outerThis._step].classList.remove('active');
              outerThis._step -= 1;
              const currentFields = form.querySelector('.forgot.password');
              if (currentFields) {
                currentFields.remove();
              }

              form.insertAdjacentHTML('afterbegin', outerThis.getCodeField());
            }, 1500);
          }
        }
        else if (stageType === "login") {
          if (this._step <= 1) {
            contentTitle.textContent = "Join";
            setTimeout(() => {
              stages[1].classList.remove('active');
              form.remove();
              stagesContainer.insertAdjacentHTML('afterend', welcome);
              outerThis._step = 0;

              outerThis.activateRegister(contentContainer, stagesContainer, contentTitle);
              outerThis.activateLogin(contentContainer, stagesContainer, contentTitle);
              outerThis.activateForgot(contentContainer, stagesContainer, contentTitle);
            }, 1500);
          }
        }

        setTimeout(() => {
          prevButton.innerHTML = `<span class="text">Back</span>`;
          prevButton.style.setProperty("pointer-events", 'auto');
        }, 1500);
      });
    }

    submitEvent(stageType, form) {
      const outerThis = this;
      form.addEventListener('submit', e => {
        e.preventDefault();

        switch (stageType) {
          case 'register':
            if (outerThis._step === 1) {
              outerThis.validateBio(form);
            }
            else if (outerThis._step === 2) {
              outerThis.validatePassword(form);
            }
            break;

          case 'forgot':
            if (outerThis._step === 1) {
              outerThis.validateForgotEmail(form);
            }
            else if (outerThis._step === 2) {
              outerThis.validateForgotCode(form);
            }
            else if (outerThis._step === 3) {
              outerThis.validateForgotPassword(form);
            }
            break;
          case 'login':
            outerThis.validateLogin(form);
            break;
        }
      });
    }

    validateLogin(form) {
      const outerThis = this;
      const data = {};
      const submitButton = form.querySelector('.actions > .action.next ');
      const inputField = form.querySelector('.field.login');
      const userKeyGroup = inputField.querySelector('.input-group.user-key');
      const passwordGroup = inputField.querySelector('.input-group.password');

      submitButton.innerHTML = outerThis.getButtonLoader();
      submitButton.style.setProperty("pointer-events", 'none');

      userKeyGroup.classList.remove('success', 'failed');
      passwordGroup.classList.remove('success', 'failed');

      let svg = userKeyGroup.querySelector('svg');
      let passwordSvg = passwordGroup.querySelector('svg');
      let serverMsg = form.querySelector('.server-status');
      if (svg) {
        svg.remove();
      }

      if(passwordSvg) {
        passwordSvg.remove();
      }

      if (serverMsg) {
        serverMsg.remove();
      }

      const userKeyValue = userKeyGroup.querySelector('input').value.trim();
      const passwordValue = passwordGroup.querySelector('input').value.trim();

      const userKeyStatus = userKeyGroup.querySelector('span.status');
      const passwordStatus = passwordGroup.querySelector('span.status');


      if (userKeyValue === '') {
        userKeyStatus.textContent = 'Username or email is required!';
        userKeyGroup.insertAdjacentHTML('beforeend', outerThis._failed);
        userKeyGroup.classList.add('failed');

        setTimeout(() => {
          submitButton.innerHTML = `<span class="text">Login</span>`;
          submitButton.style.setProperty("pointer-events", 'auto');
        }, 1000);
      }
      else {
        userKeyGroup.insertAdjacentHTML('beforeend', this._success);
        setTimeout(() => {
          userKeyGroup.classList.add('success');
        }, 2000);

        data['email'] = userKeyValue;
      }

      if (passwordValue === '') {
        passwordStatus.textContent = 'Password is required!';
        passwordGroup.insertAdjacentHTML('beforeend', outerThis._failed);
        passwordGroup.classList.add('failed');

        setTimeout(() => {
          submitButton.innerHTML = `<span class="text">Login</span>`;
          submitButton.style.setProperty("pointer-events", 'auto');
        }, 1000);
      }
      else {
        passwordGroup.insertAdjacentHTML('beforeend', this._success);
        setTimeout(() => {
          passwordGroup.classList.add('success');
        }, 2000);
        data['password'] = passwordValue;
      }

      if (data['email'] && data['password']) {
        //API CALL
        outerThis.performLogin(form, data);
      }
    }

    performLogin = async (form, data) => {
      const outerThis = this;
      const submitButton = form.querySelector('.actions > .action.next ');

      // Call login API
      const {
        result,
        error
      } = await outerThis.apiLogin(data);

      // If error occurs
      if (error) {
        const errorMsg = outerThis.getServerMsg('Something went wrong, try again!');
        form.insertAdjacentHTML('afterbegin', errorMsg);

        setTimeout(() => {
          submitButton.innerHTML = `<span class="text">Login</span>`;
          submitButton.style.setProperty("pointer-events", 'auto');
        }, 1000);
      }

      // If login is successful
      if (result.success) {
        setTimeout(() => {
          submitButton.innerHTML = `<span class="text">Continue</span>`;
          submitButton.style.setProperty("pointer-events", 'auto');

          outerThis.activateLoginFinish(form.parentElement, result.user.name);
        }, 3000);
      }
      else {
        const errorMsg = outerThis.getServerMsg(result.message);
        form.insertAdjacentHTML('afterbegin', errorMsg);

        setTimeout(() => {
          submitButton.innerHTML = `<span class="text">Login</span>`;
          submitButton.style.setProperty("pointer-events", 'auto');
        }, 1000);
      }
    }

    apiLogin = async data => {
      const outerThis = this;
      const loginUrl = outerThis.getAttribute('api-login');
      try {
        const response = await fetch(loginUrl, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(data),
        });

        const result = await response.json();

        return  {
          result: result,
          error: null
        }
      }
      catch (error) {
        return {
          result: null,
          error: error
        }
      }
    }

    activateBio(form) {
      const stagesContainer = form.parentElement.querySelector('.stages');
      form.firstElementChild.remove();
      this.nextStep('register', stagesContainer);

      form.insertAdjacentHTML('afterbegin', this.getBioFields());
    }

    validateBio(form) {
      const outerThis = this;
      const submitButton = form.querySelector('.actions > .action.next ');
      const inputField = form.querySelector('.field.bio');

      const firstName = inputField.querySelector('.input-group.firstname');
      const lastname = inputField.querySelector('.input-group.lastname');
      const email = inputField.querySelector('.input-group.email');

      submitButton.innerHTML = outerThis.getButtonLoader();
      submitButton.style.setProperty("pointer-events", 'none');


      // Validate names
      if (this.validateName(firstName, submitButton) && this.validateName(lastname, submitButton)) {
        const input = email.querySelector('input').value.trim();

        email.classList.remove('success', 'failed');
        let svg = email.querySelector('svg');
        if (svg) {
          svg.remove();
        }
        const emailStatus = email.querySelector('span.status');

        if (input === '') {
          emailStatus.textContent = 'Enter a valid email!';
          email.insertAdjacentHTML('beforeend', outerThis._failed);
          email.classList.add('failed');

          setTimeout(() => {
            submitButton.innerHTML = `<span class="text">Continue</span>`;
            submitButton.style.setProperty("pointer-events", 'auto');
          }, 1000);
        }
        else {
          // no Inspection
          let validRegex = /^[\w.-]+@[\w-]+\.[\w.-]+$/;

          if (input.match(validRegex)) {

            // Call the API
            outerThis.checkEmail(form, input, email, emailStatus);
          }
          else {
            emailStatus.textContent = 'Enter a valid email!';
            email.insertAdjacentHTML('beforeend', outerThis._failed);
            email.classList.add('failed');

            setTimeout(() => {
              submitButton.innerHTML = `<span class="text">Continue</span>`;
              submitButton.style.setProperty("pointer-events", 'auto');
            }, 1000);
          }
        }
      }
    }

    validateName = (nameElement, submitButton) => {
      const outerThis = this;
      const inputElement = nameElement.querySelector('input');
      const input = nameElement.querySelector('input').value.trim();

      nameElement.classList.remove('success', 'failed');
      let svg = nameElement.querySelector('svg');
      if (svg) {
        svg.remove();
      }
      const nameStatus = nameElement.querySelector('span.status');

      if (input === '') {
        nameStatus.textContent = 'This field is required!';
        nameElement.insertAdjacentHTML('beforeend', outerThis._failed);
        nameElement.classList.add('failed');

        setTimeout(() => {
          submitButton.innerHTML = `<span class="text">Continue</span>`;
          submitButton.style.setProperty("pointer-events", 'auto');
        }, 1000);

        return false;
      }
      else {
        nameStatus.textContent = '';
        nameElement.insertAdjacentHTML('beforeend', this._success);

        if (inputElement.dataset.name === "firstname") {
          this._data.register['first_name'] = input;
        }
        else {
          this._data.register['last_name'] = input;
        }

        nameElement.classList.add('success');

        return true;
      }
    }

    checkEmail = async (form, input, email, emailStatus) =>  {
      const submitButton = form.querySelector('.actions > .action.next');

      // After API call
      const {
        result,
        error
      } = await this.checkIfEmailExists({ email: input });

      // If error occurs
      if (error) {
        const errorMsg = this.getServerMsg('Something went wrong, try again!');
        form.insertAdjacentHTML('afterbegin', errorMsg);

        setTimeout(() => {
          submitButton.innerHTML = `<span class="text">Continue</span>`;
          submitButton.style.setProperty("pointer-events", 'auto');
        }, 1000);
      }

      // If email does not exist
      if (result.success) {
        // Add email to the data object
        this._data.register['email'] = input;

        emailStatus.textContent = result.message;
        email.insertAdjacentHTML('beforeend', this._success);

        email.classList.add('success');

        setTimeout(() => {
          submitButton.innerHTML = `<span class="text">Register</span>`;
          submitButton.style.setProperty("pointer-events", 'auto');
          this.activatePassword(form);
        }, 2000);
      }
      else {
        emailStatus.textContent = result.message;
        email.insertAdjacentHTML('beforeend', this._failed);
        email.classList.add('failed');

        setTimeout(() => {
          submitButton.innerHTML = `<span class="text">Continue</span>`;
          submitButton.style.setProperty("pointer-events", 'auto');
        }, 1000);
      }
    }

    activatePassword = form => {
      const stagesContainer = form.parentElement.querySelector('.stages');
      form.firstElementChild.remove();
      this.nextStep('register', stagesContainer);

      form.insertAdjacentHTML('afterbegin', this.getPasswordFields());
    }

    validatePassword = async form => {
      const outerThis = this;
      const submitButton = form.querySelector('.actions > .action.next');
      const inputField = form.querySelector('.field.password');

      const password = inputField.querySelector('.input-group.password');
      const repeatPassword = inputField.querySelector('.input-group.repeat-password');

      submitButton.innerHTML = outerThis.getButtonLoader();
      submitButton.style.setProperty("pointer-events", 'none');

      const input = password.querySelector('input').value.trim();
      const inputRepeat = repeatPassword.querySelector('input').value.trim();

      password.classList.remove('success', 'failed');
      repeatPassword.classList.remove('success', 'failed');
      let svg = password.querySelector('svg');
      let svgRepeat = repeatPassword.querySelector('svg');
      let serverMsg = form.querySelector('.server-status');
      if(svg){
        svg.remove();
      }
      if (svgRepeat) {
        svgRepeat.remove();
      }

      if (serverMsg) {
        serverMsg.remove();
      }


      const passwordStatus = password.querySelector('span.status');
      const repeatStatus = repeatPassword.querySelector('span.status');

      if (input === '') {
        passwordStatus.textContent = 'Password is required!';
        password.insertAdjacentHTML('beforeend', outerThis._failed);
        password.classList.add('failed');

        setTimeout(() => {
          submitButton.innerHTML = `<span class="text">Continue</span>`;
          submitButton.style.setProperty("pointer-events", 'auto');
        }, 1000);
      }
      else {
        if(this.isPassword(input, password, passwordStatus)){
          if (input === inputRepeat) {
            repeatStatus.textContent = '';
            repeatPassword.insertAdjacentHTML('beforeend', this._success);

            this._data.register['password'] = input;

            // console.log(this._data);

            repeatPassword.classList.add('success');

            // API Call

            const {
              result,
              error
            } = await outerThis.performRegistration(outerThis._data.register);

            if (error) {
              const errorMsg = outerThis.getServerMsg('Something went wrong, try again!');
              form.insertAdjacentHTML('afterbegin', errorMsg);

              setTimeout(() => {
                submitButton.innerHTML = `<span class="text">Continue</span>`;
                submitButton.style.setProperty("pointer-events", 'auto');
              }, 1000);
            }

            if (result.success) {
              this.activateFinish(form.parentElement, result.user);
            }
            else {
              const errorMsg = outerThis.getServerMsg(result.message);
              form.insertAdjacentHTML('afterbegin', errorMsg);

              setTimeout(() => {
                submitButton.innerHTML = `<span class="text">Continue</span>`;
                submitButton.style.setProperty("pointer-events", 'auto');
              }, 1000);
            }
          }
          else {
            repeatStatus.textContent = 'Passwords must match be equal!';
            repeatPassword.insertAdjacentHTML('beforeend', outerThis._failed);
            repeatPassword.classList.add('failed');

            setTimeout(() => {
              submitButton.innerHTML = `<span class="text">Continue</span>`;
              submitButton.style.setProperty("pointer-events", 'auto');
            }, 1000);
          }
        }
        else {
          setTimeout(() => {
            submitButton.innerHTML = `<span class="text">Continue</span>`;
            submitButton.style.setProperty("pointer-events", 'auto');
          }, 1000);
        }
      }
    }

    performRegistration = async data => {
      const outerThis = this;
      const registerUrl = outerThis.getAttribute('api-register');
      try {
        const response = await fetch(registerUrl, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(data),
        });

        const result = await response.json();

        return  {
          result: result,
          error: null
        }
      }
      catch (error) {
        return {
          result: null,
          error: error
        }
      }
    }

    checkIfEmailExists = async data => {
      const outerThis = this;
      const checkEmailUrl = outerThis.getAttribute('api-check-email');
      try {
        const response = await fetch(checkEmailUrl, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(data),
        });

        const result = await response.json();

        return {
          result: result,
          error: null
        }
      }
      catch (error) {
        return {
          result: null,
          error: error
        }
      }
    }

    isPassword(input, password, passwordStatus) {
      const outerThis = this;
      // Regular expressions for each criterion
      const uppercaseRegex = /[A-Z]/;
      const lowercaseRegex = /[a-z]/;
      const digitRegex = /[0-9]/;
      const specialSymbolRegex = /[^A-Za-z0-9]/;

      // Check each criterion
      if (input.length < 6) {
        passwordStatus.textContent = "Password must be at least 6 characters long.";
        password.insertAdjacentHTML('beforeend', outerThis._failed);
        password.classList.add('failed');

        return false;
      }
      else if (!uppercaseRegex.test(input)) {
        passwordStatus.textContent = "Password must contain at least one uppercase letter.";
        password.insertAdjacentHTML('beforeend', outerThis._failed);
        password.classList.add('failed');

        return false;
      }
      else if (!lowercaseRegex.test(input)) {
        passwordStatus.textContent = "Password must contain at least one lowercase letter.";
        password.insertAdjacentHTML('beforeend', outerThis._failed);
        password.classList.add('failed');

        return false;
      }
      else if (!digitRegex.test(input)) {
        passwordStatus.textContent = "Password must contain at least one digit.";
        password.insertAdjacentHTML('beforeend', outerThis._failed);
        password.classList.add('failed');

        return false;
      }
      else if (!specialSymbolRegex.test(input)) {
        passwordStatus.textContent = "Password must contain at least one special symbol.";
        password.insertAdjacentHTML('beforeend', outerThis._failed);
        password.classList.add('failed');

        return false;
      }
      else {
        passwordStatus.textContent = '';
        password.insertAdjacentHTML('beforeend', this._success);

        password.classList.add('success');

        return true;
      }
    }

    activateForgotCode(form) {
      const stagesContainer = form.parentElement.querySelector('.stages');
      const currentEl = form.querySelector('.field.forgot.email');
      if (currentEl) {
        currentEl.remove();
      }
      this.nextStep('forgot', stagesContainer);


      form.insertAdjacentHTML('afterbegin', this.getCodeField());
    }

    activateForgotPassword(form) {
      const stagesContainer = form.parentElement.querySelector('.stages');
      const currentEl = form.querySelector('.field.forgot.code');
      if (currentEl) {
        currentEl.remove();
      }
      // Select and remove server message
      let serverMsg = form.querySelector('.server-status');
      if (serverMsg) {
        serverMsg.remove();
      }
      this.nextStep('forgot', stagesContainer);


      form.insertAdjacentHTML('afterbegin', this.getResetPasswordFields());
    }

    validateForgotEmail(form) {
      const outerThis = this;
      const submitButton = form.querySelector('.actions > .action.next ');

      submitButton.innerHTML = outerThis.getButtonLoader();
      submitButton.style.setProperty("pointer-events", 'none');

      const email = form.querySelector('.input-group.email');

      const input = email.querySelector('input').value.trim();

      email.classList.remove('success', 'failed');
      let svg = email.querySelector('svg');
      if (svg) {
        svg.remove();
      }
      const emailStatus = email.querySelector('span.status');

      if (input === '') {
        emailStatus.textContent = 'Enter a valid email!';
        email.insertAdjacentHTML('beforeend', outerThis._failed);
        email.classList.add('failed');

        setTimeout(() => {
          submitButton.innerHTML = `<span class="text">Continue</span>`;
          submitButton.style.setProperty("pointer-events", 'auto');
        }, 1000);
      }
      else {
        // no Inspection
        let validRegex = /^[\w.-]+@[\w-]+\.[\w.-]+$/;

        if (input.match(validRegex)) {

          // Call the API
          outerThis.checkForgotEmail(form, input, email, emailStatus);
        }
        else {
          emailStatus.textContent = 'Enter a valid email!';
          email.insertAdjacentHTML('beforeend', outerThis._failed);
          email.classList.add('failed');

          setTimeout(() => {
            submitButton.innerHTML = `<span class="text">Continue</span>`;
            submitButton.style.setProperty("pointer-events", 'auto');
          }, 1000);
        }
      }
    }

    validateForgotCode(form) {
      const outerThis = this;
      const submitButton = form.querySelector('.actions > .action.next ');

      const codeInput = form.querySelector('.input-group.code');

      submitButton.innerHTML = outerThis.getButtonLoader();
      submitButton.style.setProperty("pointer-events", 'none');

      const codeStatus = codeInput.querySelector('span.status');

      codeInput.classList.remove('success', 'failed');
      let svg = codeInput.querySelector('svg');
      if (svg) {
        svg.remove();
      }


      // Validate code
      const input = codeInput.querySelector('input').value.trim();

      if (input.length >= 6) {

        // Call the API
        outerThis.checkCode(form, input, codeInput, codeStatus);
      }
      else {
        codeStatus.textContent = 'Code value cant be less than 6 chars long!';
        codeInput.insertAdjacentHTML('beforeend', outerThis._failed);
        codeInput.classList.add('failed');

        setTimeout(() => {
          submitButton.innerHTML = `<span class="text">Continue</span>`;
          submitButton.style.setProperty("pointer-events", 'auto');
        }, 1000);
      }
    }

    validateForgotPassword(form) {
      const outerThis = this;
      const submitButton = form.querySelector('.actions > .action.next');
      const inputField = form.querySelector('.field.password');

      // Select and remove server message
      let serverMsg = form.querySelector('.server-status');
      if (serverMsg) {
        serverMsg.remove();
      }

      const password = inputField.querySelector('.input-group.password');
      const repeatPassword = inputField.querySelector('.input-group.repeat-password');

      submitButton.innerHTML = outerThis.getButtonLoader();
      submitButton.style.setProperty("pointer-events", 'none');

      const input = password.querySelector('input').value.trim();
      const inputRepeat = repeatPassword.querySelector('input').value.trim();

      password.classList.remove('success', 'failed');
      repeatPassword.classList.remove('success', 'failed');
      let svg = password.querySelector('svg');
      let svgRepeat = repeatPassword.querySelector('svg');
      if (svg && svgRepeat) {
        svg.remove();
        svgRepeat.remove();
      }


      const passwordStatus = password.querySelector('span.status');
      const repeatStatus = repeatPassword.querySelector('span.status');

      if (input === '') {
        passwordStatus.textContent = 'Password is required!';
        password.insertAdjacentHTML('beforeend', outerThis._failed);
        password.classList.add('failed');

        setTimeout(() => {
          submitButton.innerHTML = `<span class="text">Continue</span>`;
          submitButton.style.setProperty("pointer-events", 'auto');
        }, 1000);

        return;
      }
      
      if (this.isPassword(input, password, passwordStatus)) {
        if (input === inputRepeat) {
          repeatStatus.textContent = "";
          repeatPassword.insertAdjacentHTML("beforeend", this._success);

          this._data.recovery["password"] = input;

          repeatPassword.classList.add("success");

          // API Call
          this.activateForgotFinish(form.parentElement);
        } else {
          repeatStatus.textContent = "Passwords must match be equal!";
          repeatPassword.insertAdjacentHTML("beforeend", outerThis._failed);
          repeatPassword.classList.add("failed");

          setTimeout(() => {
            submitButton.innerHTML = `<span class="text">Continue</span>`;
            submitButton.style.setProperty("pointer-events", "auto");
          }, 1000);
        }
      } else {
        setTimeout(() => {
          submitButton.innerHTML = `<span class="text">Continue</span>`;
          submitButton.style.setProperty("pointer-events", "auto");
        }, 1000);
      }
    }

    checkForgotEmail = async (form, input, email, emailStatus) => {
      const submitButton = form.querySelector('.actions > .action.next');

      // After API call
      const {
        result,
        error
      } = await this.apiForget({ email: input });

      // If error occurs
      if (error) {
        const errorMsg = this.getServerMsg('Something went wrong, try again!');
        form.insertAdjacentHTML('afterbegin', errorMsg);

        setTimeout(() => {
          submitButton.innerHTML = `<span class="text">Continue</span>`;
          submitButton.style.setProperty("pointer-events", 'auto');
        }, 1000);
      }

      // If email does not exist
      if (!result.success) {
        emailStatus.textContent = result.message;
        email.insertAdjacentHTML('beforeend', this._failed);
        email.classList.add('failed');

        setTimeout(() => {
          submitButton.innerHTML = `<span class="text">Continue</span>`;
          submitButton.style.setProperty("pointer-events", 'auto');
        }, 1000);
      }
      else {
        // Add email to the data object
        this._data.recovery['email'] = input;

        // Add returned user to the local object
        this._data.user = result.user;

        const errorMsg = this.getServerSuccessMsg(result.message);
        form.insertAdjacentHTML('afterbegin', errorMsg);


        emailStatus.textContent = result.message;
        email.insertAdjacentHTML('beforeend', this._success);

        email.classList.add('success');

        setTimeout(() => {
          submitButton.innerHTML = `<span class="text">Continue</span>`;
          submitButton.style.setProperty("pointer-events", 'auto');
          this.activateForgotCode(form);
        }, 2000);
      }
    }

    apiForget = async data => {
      const outerThis = this;
      const url = outerThis.getAttribute('api-forgot-password');
      try {
        const response = await fetch(url, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(data),
        });

        const result = await response.json();

        return {
          result: result,
          error: null
        }
      }
      catch (error) {
        return {
          result: null,
          error: error
        }
      }
    }

    apiVerify = async data => {
      const outerThis = this;
      const url = outerThis.getAttribute('api-verify-token');
      try {
        const response = await fetch(url, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(data),
        });

        const result = await response.json();

        return {
          result: result,
          error: null
        }
      }
      catch (error) {
        return {
          result: null,
          error: error
        }
      }
    }

    apiResetPassword = async data => {
      const outerThis = this;
      const url = outerThis.getAttribute('api-reset-password');
      try {
        const response = await fetch(url, {
          method: "PATCH",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(data),
        });

        const result = await response.json();

        return {
          result: result,
          error: null
        }
      }
      catch (error) {
        return {
          result: null,
          error: error
        }
      }
    }

    checkCode = async (form, input, codeInput, codeStatus) => {
      const outerThis = this;
      const submitButton = form.querySelector('.actions > .action.next');


      // After API call
      const {
        result,
        error
      } = await this.apiVerify({ token: input, email: outerThis._data.recovery['email'] });

      // If error occurs
      if (error) {
        const errorMsg = this.getServerMsg('Something went wrong, try again!');
        form.insertAdjacentHTML('afterbegin', errorMsg);

        setTimeout(() => {
          submitButton.innerHTML = `<span class="text">Continue</span>`;
          submitButton.style.setProperty("pointer-events", 'auto');
        }, 1000);
      }

      // If verification is successful
      if (result.success) {
        codeStatus.textContent = result.message;
        codeInput.insertAdjacentHTML('beforeend', this._success);

        setTimeout(() => {
          codeInput.classList.add('success');
        }, 1000);

        setTimeout(() => {
          submitButton.innerHTML = `<span class="text">Continue</span>`;
          submitButton.style.setProperty("pointer-events", 'auto');
          this.activateForgotPassword(form);
        }, 2000);
      }
      else {
        codeStatus.textContent = result.message;
        codeInput.insertAdjacentHTML('beforeend', this._failed);

        setTimeout(() => {
          submitButton.innerHTML = `<span class="text">Continue</span>`;
          submitButton.style.setProperty("pointer-events", 'auto');
        }, 1000);
      }
    }

    activateFinish(contentContainer, data) {
      const outerThis = this;
      const stagesContainer = contentContainer.querySelector('.stages');
      const contentTitle = contentContainer.querySelector('.head > .logo h2 span.action');
      const finish = this.getRegSuccess(data);
      const form = contentContainer.querySelector('form');

      setTimeout(() => {
        form.remove();
        outerThis.nextStep('register', stagesContainer);
        stagesContainer.insertAdjacentHTML('afterend', finish);

        outerThis.activateLogin(contentContainer, stagesContainer, contentTitle);
      }, 1000);
    }

    activateLoginFinish(contentContainer, name) {
      const outerThis = this;
      // get the next attribute
      const next = this.getAttribute('next') || '/home';

      const stagesContainer = contentContainer.querySelector('.stages');
      const finish = this.getLoginSuccess(name);
      const form = contentContainer.querySelector('form');

      setTimeout(() => {
        form.remove();
        outerThis.nextStep('login', stagesContainer);
        stagesContainer.insertAdjacentHTML('afterend', finish);

        // redirect user after 5 seconds
        outerThis.redirectUser(next);
      }, 1000);
    }

    redirectUser = async url => {
      // set window user(hash)
      this.setHash('hash');

      // destroy the current user-cache
      const userCache  = 'user-cache';

      // delete cache: user-cache
      await caches.delete(userCache);

      // set 5 seconds timeout before redirecting
      setTimeout(() => {
        window.location.replace(url);
      }, 5000);
    }

    activateForgotFinish = async contentContainer => {
      const outerThis = this;
      const stagesContainer = contentContainer.querySelector('.stages');
      const contentTitle = contentContainer.querySelector('.head > .logo h2 span.action');
      const form = contentContainer.querySelector('form');

      // construct data for reset password
      if(!outerThis._data.recovery.email || !outerThis._data.recovery.password) {
        // Show error message
        const errorMsg = outerThis.getServerMsg('Some fields are missing!');
        form.insertAdjacentHTML('afterbegin', errorMsg);
      }

      const resetData = {
        email: outerThis._data.recovery.email,
        password: outerThis._data.recovery.password
      };

      // Call the api for resetting the password
      const {
        result,
        error
      } = await outerThis.apiResetPassword(resetData);

      // If error occurs
      if (error) {
        const errorMsg = outerThis.getServerMsg('Something went wrong, try again!');
        form.insertAdjacentHTML('afterbegin', errorMsg);
      }

      // If reset is successful
      if (result.success) {
        const finish = this.getForgotSuccess(result.user.name);
        setTimeout(() => {
          form.remove();
          outerThis.nextStep('forgot', stagesContainer);
          stagesContainer.insertAdjacentHTML('afterend', finish);

          outerThis.activateLogin(contentContainer, stagesContainer, contentTitle);
        }, 1000);
      }
      else {
        const errorMsg = outerThis.getServerMsg(result.message);
        form.insertAdjacentHTML('afterbegin', errorMsg);
      }
    }

     disableScroll() {
      // Get the current page scroll position
      let scrollTop = window.scrollY || document.documentElement.scrollTop;
      let scrollLeft = window.scrollX || document.documentElement.scrollLeft;
      document.body.classList.add("stop-scrolling");

      // if any scroll is attempted, set this to the previous value
      window.onscroll = function () {
        window.scrollTo(scrollLeft, scrollTop);
      };
    }

    enableScroll() {
      document.body.classList.remove("stop-scrolling");
      window.onscroll = function () { };
    }

    getTemplate() {
      return `
      <div class="logon-container">
        ${this.getHeader()}
        ${this.getStages()}
        ${this.initialInterface(this.getAttribute('name'))}
        ${this.getFooter()}
      </div>

      ${this.getStyles()}
    `
    }

    initialInterface = (startName) => {
      const outerThis = this;
      // check if the user is already logged in
      if (this._authenticated) {
        return outerThis.getAlreadyLoggedIn('You are already logged in!');
      }

      switch (startName) {
        case 'join':
          return outerThis.getWelcome()
        case 'login':
          return outerThis.getLoginForm();
        case 'register':
          return outerThis.getRegistrationForm();
        case 'forgot':
          return outerThis.getForgotForm();
        default:
          return outerThis.getWelcome();
      }
    }

    getLoader() {
      return `
      <div id="loader-container">
				<div class="loader"></div>
			</div>
    `
    }

    getButtonLoader() {
      return `
      <span id="btn-loader">
				<span class="loader"></span>
			</span>
    `
    }

    getBtnAltLoader() {
      return `
      <span id="btn-loader">
				<span class="loader-alt"></span>
			</span>
    `
    }

    getHeader() {
      return `
      <div class="head">
				<div class="logo">
					<h2 class="main">
						<span class="action">Join</span> - Zoanai</h2>
					<span class="slogan">Create and contribute to ideas that can change the world.</span>
				</div>
			</div>
    `
    }

    getStages() {
      return `
      <div class="stages welcome-stages">
				<span class="no stage first active">1</span>
				<span class="no stage second">2</span>
				<span class="no stage third">3</span>
        <span class="no stage fourth">4</span>
				<span class="stage done">
					<span class="left"></span>
					<span class="right"></span>
				</span>
			</div>
    `
    }

    getWelcome() {
      return /*html*/`
      <div class="welcome">
				<p>
					Connect with vibrant minds and share or contribute to ideas that can change the world.
          Join our community today, and start sharing your thoughts.
				</p>
				<a href=${this.getAttribute('login')} class="login">Login</a>
				<a href=${this.getAttribute('register')} class="register">Register</a>
        <p class="forgot">
          Forgot your password? <a href="${this.getAttribute('forgot')}" class="forgot">Click here</a>
        </p>
				<div class="info">
					<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-check-circle-fill"
						viewBox="0 0 16 16">
						<path
							d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0m-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z" />
					</svg>
					By continuing you indicate that you agree to <a href="" class="aduki">aduki's</a> <a href="">Terms of Service</a> and <a href="">Privacy
						Policy</a>.
				</div>
			</div>
    `
    }

    getRegSuccess(data) {
      return /*html*/`
      <div class="finish">
        <h2 class="title">Welcome!</h2>
				<p>
					Dear ${data.name} your account has been created successfully. Please log in into your account to start sharing great ideas.
				</p>
				<a href="/login/" class="login">Login</a>
			</div>
    `
    }

    getLoginSuccess = name => {
      // get the next attribute
      const next = this.getAttribute('next') || '/home';

      const display = next.length > 30 ? next.substring(0, 30) + '..' : next;

      return /*html*/`
      <div class="finish login-success">
        <p>Welcome</p>
        <h2 class="title">${name}</h2>
        <p class="next">
          You've successfully login into your account. You will be redirected to <span class="url">${display}</span> in 5 seconds. 
          Or you can click <a href="${next}">here</a> to continue.
        </p>
			</div>
    `
    }

    getAlreadyLoggedIn = name => {
      // get the next attribute
      const next = this.getAttribute('next') || '/home';
      return /*html*/`
      <div class="welcome login-success">
        <h2 class="title">${name}</h2>
        <p class="next">
          You can continue to with this account or login into another account. Please note that: <span class="warn">This will remove the current session.</span>
        </p>
        <a href="${this.getAttribute('login')}" class="login">Login</a>
				<a href="${next}" class="continue">Continue</a>
			</div>
    `
    }

    getForgotSuccess = name => {
      return /*html*/`
      <div class="finish">
        <h2 class="title">Success!</h2>
				<p>
					Dear ${name} your password has been successfully reset. Please log in into your account.
				</p>
				<a href="/join/login/" class="login">Login</a>
			</div>
    `
    }

    getRegistrationForm() {
      return /* html */`
      <form class="fields initial">
				${this.getBioFields()}
				<div class="actions">
					<button type="button" class="action prev">
						<span class="text">Back</span>
					</button>
					<button type="submit" class="action next">
						<span class="text">Continue</span>
					</button>
				</div>
			</form>
    `
    }

    getServerMsg = text => {
      return /*html*/`
      <p class="server-status">${text}</p>
    `
    }

    getServerSuccessMsg = text => {
      return /*html*/`
      <p class="server-status success">${text}</p>
    `
    }

    getBioFields() {
      return /*html*/`
      <div class="field bio">
				<div class="input-group firstname">
					<label for="firstname" class="center">First name</label>
					<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
						<path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0m-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z" />
					</svg>
					<input data-name="firstname" type="text" name="firstname" id="firstname" placeholder="e.g John" required>
					<span class="status">First name is required</span>
				</div>
				<div class="input-group lastname">
					<label for="lastname" class="center">Last name</label>
					<input data-name="lastname" type="text" name="lastname" id="lastname" placeholder="e.g Doe" required>
					<span class="status">Last name is required</span>
				</div>
				<div class="input-group email">
					<label for="email" class="center">Email</label>
					<input data-name="Email" type="email" name="email" id="email" placeholder="e.g john@example.com" required>
					<span class="status">Email is required</span>
				</div>
			</div>
    `
    }

    getPasswordFields() {
      return /*html*/`
      <div class="field password bio">
				<div class="input-group password">
					<label for="password" class="center">Password</label>
					<input data-name="password" type="password" name="password" id="password" placeholder="Enter your password" required>
					<span class="status">Password is required</span>
				</div>
				<div class="input-group repeat-password">
					<label for="password2" class="center">Repeat password</label>
					<input data-name="password2" type="password" name="password2" id="password2" placeholder="Repeat your password" required>
					<span class="status">Password is required</span>
				</div>
			</div>
    `
    }

    getForgotForm() {
      return /*html*/`
      <form class="fields initial">
				${this.getForgotFields()}
				<div class="actions">
					<button type="button" class="action prev">
						<span class="text">Back</span>
					</button>
					<button type="submit" class="action next">
						<span class="text">Continue</span>
					</button>
				</div>
			</form>
    `
    }

    getForgotFields = () => {
      return `
      <div class="field forgot bio email">
				<div class="input-group email">
					<label for="email" class="center">Your email</label>
					<input data-name="Email" type="email" name="email" id="email" placeholder="e.g john@example.com" required>
					<span class="status">Email is required</span>
				</div>
			</div>
    `
    }

    getCodeField = () => {
      return `
      <div class="field forgot bio code">
        <div class="input-group code">
          <label for="code" class="center">Verify code</label>
          <input data-name="code" type="text" name="code" id="code" placeholder="Enter code sent to your email" required>
          <span class="status">Code is required</span>
        </div>
      </div>
    `
    }

    getResetPasswordFields = () => {
      return `
      <div class="field password bio forgot">
				<div class="input-group password">
					<label for="password" class="center">New Password</label>
					<input data-name="password" type="password" name="password" id="password" placeholder="Enter your new password" required>
					<span class="status">Password is required</span>
				</div>
				<div class="input-group repeat-password">
					<label for="password2" class="center">Repeat password</label>
					<input data-name="password2" type="password" name="password2" id="password2" placeholder="Repeat your password" required>
					<span class="status">Password is required</span>
				</div>
			</div>
    `
    }

    getLoginForm() {
      return `
      <form class="fields initial bio">
				<div class="field login bio">
					<div class="input-group user-key">
						<label for="email" class="center">Email</label>
						<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
							<path
								d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0m-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z" />
						</svg>
						<input data-name="email" type="email" name="email" id="email" placeholder="e.g john@example.com"
							required>
						<span class="status">Username or email is required</span>
					</div>
					<div class="input-group password">
						<label for="password" class="center">Password</label>
						<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
							<path
								d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0m-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z" />
						</svg>
						<input data-name="password" type="password" name="password" id="password" placeholder="Your password"
							required>
						<span class="status">Password is required</span>
					</div>
				</div>
				<div class="actions">
					<button type="button" class="action prev">
						<span class="text">Back</span>
					</button>
					<button type="submit" class="action next">
						<span class="text">Login</span>
					</button>
				</div>
			</form>
    `
    }

    getFooter() {
      const newDate = new Date(Date.now());
      return `
      <ul class="footer">
				<li>
					<span class="dot"></span>
					<a href="" class="copyright">
						<span class="copy">&copy;</span>
						<span class="year">${newDate.getFullYear()}</span>
						aduki Inc.
					</a>
				</li>
				<li>
					<span class="dot"></span>
					<a href="">About</a>
				</li>
				<li>
					<span class="dot"></span>
					<a href="">Community</a>
				</li>
				<li>
					<span class="dot"></span>
					<a href="">What's new</a>
				</li>
				<li>
					<span class="dot"></span>
					<a href="">Terms</a>
				</li>
			</ul>
    `
    }

    getStyles() {
      return /*css*/`
      <style>
        * {
          box-sizing: border-box !important;
        }
        *,
        *:after,
        *:before {
          box-sizing: border-box;
          font-family: var(--font-read), sans-serif;
        }

        *:focus {
          outline: inherit !important;
        }

        *::-webkit-scrollbar {
          width: 3px;
        }

        *::-webkit-scrollbar-track {
          background: #DDDDD7;
        }

        *::-webkit-scrollbar-thumb {
          width: 3px;
          background: linear-gradient(#53595f, #627ea0);
          border-radius: 50px;
        }

        :host{
          width: 100%;
          min-height: 100vh;
          height: 100%;
          display: flex;
          align-items: center;
          justify-content: center;
          background-position: 100%;
          background-size: 1rem 1rem;
          background-color: var(--logon-background);
          background-image: var(--logon-image);
        }

        #loader-container {
          position: absolute;
          top: 0;
          left: 0;
          bottom: 0;
          right: 0;
          z-index: 5;
          background-color: var(--loader-background);
          backdrop-filter: blur(1px);
          -webkit-backdrop-filter: blur(1px);
          display: flex;
          align-items: center;
          justify-content: center;
          border-radius: inherit;
          -webkit-border-radius: inherit;
          -moz-border-radius: inherit;
        }

        #loader-container > .loader {
          width: 35px;
          aspect-ratio: 1;
          --_g: no-repeat radial-gradient(farthest-side, #18A565 94%, #0000);
          --_g1: no-repeat radial-gradient(farthest-side, #21D029 94%, #0000);
          --_g2: no-repeat radial-gradient(farthest-side, #df791a 94%, #0000);
          --_g3: no-repeat radial-gradient(farthest-side, #f09c4e 94%, #0000);
          background:    var(--_g) 0 0,    var(--_g1) 100% 0,    var(--_g2) 100% 100%,    var(--_g3) 0 100%;
          background-size: 30% 30%;
          animation: l38 .9s infinite ease-in-out;
          -webkit-animation: l38 .9s infinite ease-in-out;
        }

        @keyframes l38 {
          100% {
            background-position: 100% 0, 100% 100%, 0 100%, 0 0
          }
        }

        #btn-loader {
          position: absolute;
          top: 0;
          left: 0;
          bottom: 0;
          right: 0;
          z-index: 5;
          display: flex;
          align-items: center;
          justify-content: center;
          border-radius: inherit;
        }

        #btn-loader > .loader-alt {
          width: 20px;
          aspect-ratio: 1;
          --_g: no-repeat radial-gradient(farthest-side, #18A565 94%, #0000);
          --_g1: no-repeat radial-gradient(farthest-side, #21D029 94%, #0000);
          --_g2: no-repeat radial-gradient(farthest-side, #df791a 94%, #0000);
          --_g3: no-repeat radial-gradient(farthest-side, #f09c4e 94%, #0000);
          background:    var(--_g) 0 0,    var(--_g1) 100% 0,    var(--_g2) 100% 100%,    var(--_g3) 0 100%;
          background-size: 30% 30%;
          animation: l38 .9s infinite ease-in-out;
          -webkit-animation: l38 .9s infinite ease-in-out;
        }

        #btn-loader > .loader {
          width: 20px;
          aspect-ratio: 1;
          --_g: no-repeat radial-gradient(farthest-side, #ffffff 94%, #0000);
          --_g1: no-repeat radial-gradient(farthest-side, #ffffff 94%, #0000);
          --_g2: no-repeat radial-gradient(farthest-side, #df791a 94%, #0000);
          --_g3: no-repeat radial-gradient(farthest-side, #f09c4e 94%, #0000);
          background:    var(--_g) 0 0,    var(--_g1) 100% 0,    var(--_g2) 100% 100%,    var(--_g3) 0 100%;
          background-size: 30% 30%;
          animation: l38 .9s infinite ease-in-out;
          -webkit-animation: l38 .9s infinite ease-in-out;
        }

        .logon-container {
          background: var(--logon-background);
          z-index: 3;
          padding: 20px;
          width: 700px;
          height: max-content;
          display: flex;
          flex-flow: column;
          align-items: center;
          justify-content: center;
          gap: 10px;
          box-shadow: var(--logon-shadow);
          border-radius: 10px;
          position: relative;
        }

        .logon-container > .head {
          background-color: transparent;
          margin: 0;
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 0;
          font-family: var(--font-text), sans-serif;
        }

        .logon-container > .head > .logo {
          max-height: max-content;
          position: relative;
          padding: 0;
          display: flex;
          flex-flow: column;
          align-items: center;
          justify-content: center;
          gap: 5px;
        }

        .logon-container >.head>.logo h2 {
          margin: 0;
          padding: 0;
          line-height: 1.4;
          font-weight: 600;
          font-size: 1.8rem;
          color: transparent;
          background: var(--stage-no-linear);
          background-clip: text;
          -webkit-background-clip: text;
          font-family: var(--font-main), monospace;
        }

        .logon-container > .head > .logo span.slogan {
          margin: 0;
          width: 100%;
          color: var(--gray-color);
          line-height: 1.4;
          font-family: var(--font-main), sans-serif;
          font-weight: 400;
          font-size: 0.9rem;
          text-align: center;
        }

        .logon-container > .stages {
          background-color: transparent;
          height: max-content;
          width: max-content;
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 15px;
          margin: 10px 0 10px 0;
        }

        .logon-container > .stages span.done {
          background: var(--stage-done-linear);
          width: 30px;
          height: 30px;
          display: flex;
          align-items: center;
          justify-content: center;
          position: relative;
          border-radius: 50px;
          -webkit-border-radius: 50px;
          -moz-border-radius: 50px;
        }

        .logon-container>.stages span.done > span {
          display: inline-block;
          height: 3px;
          width: 8px;
          position: absolute;
          background-color: var(--white-color);
          border-radius: 5px;
          -webkit-border-radius: 5px;
          -moz-border-radius: 5px;
        }

        .logon-container>.stages span.done > span.left {
          top: 15px;
          left: 7px;
          rotate: 45deg;
        }

        .logon-container>.stages span.done > span.right {
          rotate: -45deg;
          left: 11px;
          width: 14px;
        }

        .logon-container>.stages span.done.active {
          background: var(--stage-active-linear);
        }

        .logon-container > .stages span.no {
          text-align: center;
          font-weight: 600;
          font-size: 1.2rem;
          padding: 3px 2px 0 2px;
          background: var(--stage-done-linear);
          color: var(--white-color);
          width: 30px;
          height: 30px;
          border-radius: 50px;
          -webkit-border-radius: 50px;
          -moz-border-radius: 50px;
        }

        .logon-container > .stages.login span.no.fourth,
        .logon-container > .stages.login span.no.third {
          display: none;
        }

        .logon-container > .stages.welcome-stages span.no.fourth,
        .logon-container > .stages.welcome-stages span.no.third {
          display: none;
        }

        .logon-container > .stages.register span.no.fourth,
        .logon-container > .stages.register span.no.third {
          display: none;
        }

        .logon-container > .stages.forgot span.no.fourth,
        .logon-container > .stages.forgot span.no.third {
          display: none;
        }

        .logon-container > .stages span.no.active {
          background: var(--stage-no-linear);
        }

        .logon-container > .welcome {
          width: 98%;
          display: grid;
          grid-template-columns: 1fr 1fr;
          row-gap: 10px;
          justify-content: center;
        }

        .logon-container > .finish {
          width: 90%;
          display: flex;
          flex-flow: column;
          align-items: center;
          justify-content: center;
        }

        .logon-container > .login-success > h2,
        .logon-container > .finish > h2 {
          grid-column: 1/3;
          margin: 10px 0;
          font-family: var(--font-text), sans-serif;
          text-align: center;
          color: var(--title-color);
          line-height: 1.4;
          font-size: 1.5rem;
        }

        p.server-status {
          grid-column: 1/3;
          margin: 0;
          order: 0;
          text-align: center;
          font-family: var(--font-read), sans-serif;
          color: var(--error-color);
          font-weight: 500;
          line-height: 1.4;
          font-size: 1.18rem;
        }

        p.server-status.success {
          color: transparent;
          background: var(--accent-linear);
          background-clip: text;
          -webkit-background-clip: text;
        }

        .logon-container > .finish  p,
        .logon-container>.welcome  p {
          grid-column: 1/3;
          margin: 0;
          text-align: center;
          font-family: var(--font-read), sans-serif;
          color: var(--highlight-color);
          line-height: 1.4;
          font-size: 1.15rem;
        }

        .logon-container > .finish  p.next > .url,
        .logon-container>.welcome  p.next > .url {
          background: var(--gray-background);
          color: var(--gray-color);
          padding: 2px 5px;
          font-size: 0.95rem;
          font-weight: 400;
          border-radius: 5px;
        }

        .logon-container > .welcome  p.next > a,
        .logon-container > .finish  p.next > a {
          text-decoration: none;
          font-weight: 500;
          color: transparent;
          background: var(--accent-linear);
          background-clip: text;
          -webkit-background-clip: text;
        }

        .logon-container > .welcome  p.next .warn {
          color: var(--error-color);
          font-weight: 500;
          font-size: 0.9rem;
          background: var(--gray-background);
          padding: 2px 5px;
          border-radius: 5px;
        }

        .logon-container > .finish > a,
        .logon-container >.welcome > a {
          background: var(--stage-no-linear);
          text-decoration: none;
          padding: 10px 20px;
          cursor: pointer;
          margin: 20px 0;
          width: 150px;
          justify-self: center;
          text-align: center;
          color: var(--white-color);
          border: none;
          font-size: 1.15rem;
          font-weight: 500;
          border-radius: 15px;
        }

        .logon-container > .welcome > a:last-of-type {
          background: var(--stage-active-linear);
        }

        .logon-container >.welcome > .info {
          grid-column: 1/3;
          text-align: center;
          color: var(--text-color);
          line-height: 1.4;
        }
        
        .logon-container > .welcome > .info svg {
          margin: 0 0 -3px 0;
          color: var(--accent-color);
          width: 18px;
          height: 18px;
        }

        .logon-container > .welcome > .info .aduki {
          color: transparent;
          background: var(--stage-no-linear);
          background-clip: text;
          -webkit-background-clip: text;
          font-weight: 400;
        }

        .logon-container>.welcome>.info a {
          color: var(--gray-color);
          font-size: 1em;
        }

        .logon-container>.welcome>.info a:hover {
          color: transparent;
          text-decoration: underline;
          background: var(--stage-active-linear);
          background-clip: text;
          -webkit-background-clip: text;

        }

        .logon-container >.welcome > p.forgot {
          grid-column: 1/3;
          text-align: center;
          margin: 0 0 10px 0;
          color: var(--text-color);
          line-height: 1.4;
        }

        .logon-container > .welcome > p.forgot a {
          color: var(--gray-color);
          text-decoration: none;
          font-size: 1em;
        }

        .logon-container > .welcome > p.forgot a:hover {
          color: transparent;
          background: var(--accent-linear);
          background-clip: text;
          -webkit-background-clip: text;
        }

        .logon-container > .fields {
          margin: 0 0 20px 0;
          width: 100%;
          display: flex;
          flex-flow: column;
          justify-content: center;
          align-items: center;
          gap: 20px;
        }

        .logon-container > .fields .field.bio{
          display: grid;
          grid-template-columns: 1fr 1fr;
          justify-content: center;
          column-gap: 20px;
          row-gap: 20px;
        }

        .logon-container > .fields > .field {
          width: 90%;
          display: flex;
          flex-flow: column;
          justify-content: center;
          align-items: start;
          gap: 2px;
        }

        .logon-container > .fields.center > .field {
          align-items: center;
        }

        .logon-container > .fields .field .input-group {
          width: 100%;
          display: flex;
          flex-flow: column;
          justify-content: center;
          align-items: start;
          color: var(--text-color);
          gap: 5px;
          position: relative;
          transition: border-color 0.3s ease-in-out;
        }

        .logon-container > .fields .field.bio .input-group {
          width: 100%;
        }

        .logon-container > .fields .field.bio .input-group.code,
        .logon-container > .fields .field.bio .input-group.email {
          grid-column: 1/3;
          width: 100%;
        }

        .logon-container > .fields .field .input-group > svg {
          position: absolute;
          right: 10px;
          top: 38px;
          width: 20px;
          height: 20px;
        }

        .logon-container > .fields .field .input-group > svg {
          display: none;
        }

        .logon-container > .fields .field .input-group.success > svg {
          display: inline-block;
        }
        .logon-container > .fields .field  .input-group.failed > svg {
          display: inline-block;
        }

        .logon-container > .fields .field .input-group.success > svg {
          color: var(--accent-color);
        }

        .logon-container > .fields .field  .input-group.failed > svg {
          color: var(--error-color);
        }

        .logon-container > .fields label {
          padding: 0 0 5px 0;
          color: var(--highlight-color);
          font-weight: 500;
          color: var(--text-color);
        }

        .logon-container > .fields .field.bio label{
          padding: 0 0 0 5px;
        }

        .logon-container > .fields label {
          color: var(--text-color);
          font-size: 1.1rem;
          font-family: var(--font-main),sans-serif;
          transition: all 0.3s ease-in-out;
          pointer-events: none;
        }

        .logon-container > .fields .field input {
          border: var(--input-border);
          background-color: var(--background) !important;
          font-size: 1rem;
          width: 100%;
          height: 40px;
          outline: none;
          padding: 10px 12px;
          border-radius: 12px;
          color: var(--text-color);
        }
        
        .logon-container > .fields .field input:-webkit-autofill,
        .logon-container > .fields .field input:-webkit-autofill:hover, 
        .logon-container > .fields .field input:-webkit-autofill:focus {
          -webkit-box-shadow: 0 0 0px 1000px var(--background) inset;
          -webkit-text-fill-color: var(--text-color) !important;
          transition: background-color 5000s ease-in-out 0s;
          color: var(--text-color) !important;
        }
        
        .logon-container > .fields .field input:autofill {
          filter: none;
          color: var(--text-color) !important;
        }

        .logon-container > .fields .field input:focus {
          border: var(--input-border-focus);
        }

        .logon-container > .fields .field  .input-group.success input,
        .logon-container > .fields .field  .input-group.success input:focus {
          border: var(--input-border-focus);
        }

        .logon-container > .fields .field  .input-group.failed input,
        .logon-container > .fields .field  .input-group.failed input:focus {
          border: var(--input-border-error);
        }

        .logon-container > .fields .field  .input-group.success input {
          color: var(--accent-color);
        }

        .logon-container > .fields .field .input-group.failed input {
          color: var(--error-color);
        }

        .logon-container > .fields label.focused {
          top: -10px;
          font-size: 0.9rem;
          background-color: var(--label-focus-background);
          padding: 0 5px;
        }

        .logon-container > .fields .field span.status {
          color: var(--error-color);
          font-size: 0.95rem;
          display: none;
          padding: 0 0 0 5px;
        }

        .logon-container > .fields .field .input-group.failed span.status {
          color: var(--error-color);
          font-size: 0.8rem;
          display: inline-block;
        }

        .logon-container > .fields .field  .input-group.success span.status {
          color: var(--accent-color);
          font-size: 0.8rem;
          display: inline-block;
        }

        .logon-container > .fields .field  .input-group.success span.status {
          display: none;
        }

        .logon-container > .fields .actions {
          display: flex;
          align-items: center;
          justify-content: space-between;
          width: 90%;
          margin: 20px 0 0 0;
        }

        .logon-container > .fields .actions > .action {
          display: flex;
          flex-flow: row;
          justify-content: center;
          align-items: center;
          gap: 5px;
          border: none;
          border-radius: 15px;
          font-family: var(--font-main), sans-serif;
          line-height: 1.2;
          font-size: 1.2rem;
          font-weight: 500;
          color: var(--highlight-color);
          width: 120px;
          padding: 8px 10px;
          height: 40px;
          cursor: pointer;
          position: relative;
          -webkit-border-radius: 15px;
          -moz-border-radius: 15px;
        }

        .logon-container > .fields .actions > .action.prev {
          background: var(--gray-background);
        }

        .logon-container > .fields .actions > .action.prev svg path {
          fill: var(--text-color);
        }

        .logon-container > .fields .actions > .action.next {
          color: var(--white-color);
          background: var(--stage-no-linear);
        }

        .logon-container >.fields .actions > .action.next svg path {
          fill: var(--white-color);
        }

        .logon-container>.fields .actions>.action.disabled {
          pointer-events: none;
        }

        /* Logon Footer */
        .logon-container >.footer {
          border-top: var(--story-border);
          margin: 10px 0 0 0;
          width: 100%;
          padding: 10px 0 10px 0;
          display: flex;
          flex-flow: row;
          justify-content: center;
          align-items: center;
          gap: 15px;
        }

        .logon-container > .footer > li {
          display: flex;
          flex-flow: row;
          justify-content: center;
          align-items: center;
          gap: 5px;
          font-family: var(--font-read), sans-serif;
          color: var(--gray-color);
          cursor: pointer;
        }

        .logon-container > .footer > li span.dot {
          display: inline-block;
          margin: 2px 0 0 0;
          width: 5px;
          height: 5px;
          background-color: var(--gray-color);
          border-radius: 50px;
          -webkit-border-radius: 50px;
          -moz-border-radius: 50px;
        }

        .logon-container > .footer > li a {
          color: inherit;
          line-height: 1.4;
          text-decoration: none;
          font-size: 1rem;
          font-weight: 400;
        }

        .logon-container > .footer > li:hover {
          color: var(--anchor-color);
          text-decoration: underline;
        }

        .logon-container > .footer > li:hover span.dot {
          background-color: var(--anchor-color);
        }

        .logon-container > .footer > li a.copyright {
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 0;
          font-family: var(--font-read), sans-serif;
        }

        .logon-container > .footer > li a.copyright .year {
          font-family: var(--font-read), sans-serif;
          font-size: 1em;
          padding: 0 5px 0 2px;
          font-weight: 400;
        }

        @media screen and (max-width:700px) {

          :host {
            width: 100%;
            min-height: 100vh;
            height: 100%;
            display: flex;
            align-items: start;
            justify-content: center;
            background-color: var(--background);
            background-position: unset;
            background-size: unset;
            background-image: unset;
          }

          .logon-container > .head {
            background-color: transparent;
            margin: 20px 0 0 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0;
            font-family: var(--font-text), sans-serif;
          }

          .logon-container > .stages {
            background-color: transparent;
            height: max-content;
            width: max-content;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin: 0 0 20px 0;
          }

          .logon-container {
            background: var(--background);
            box-shadow: unset;
            z-index: 3;
            padding: 20px 10px;
            width: 100%;
            height: max-content;
            display: flex;
            flex-flow: column;
            align-items: center;
            justify-content: center;
            gap: 10px;
            border-radius: 0;
            position: relative;
          }

          .logon-container > .welcome {
            width: 100%;
            display: grid;
            grid-template-columns: 1fr 1fr;
            row-gap: 10px;
            justify-content: center;
          }

          .logon-container > .finish > a,
          .logon-container > .welcome > a {
            background: var(--stage-no-linear);
            text-decoration: none;
            padding: 8px 20px;
            cursor: default;
            margin: 20px 0;
            width: 130px;
          }

          .logon-container > .finish  p,
          .logon-container>.welcome  p {
            font-size: 1rem;
          }

          .logon-container > .fields .actions > .action {
            cursor: default;
          }

          .logon-container > .fields .field.bio{
            display: flex;
            flex-flow: column;
            gap: 20px;
          }

          .logon-container > .welcome > .info {
            margin: 20px 0 0 0;
            font-size: 0.9rem;
          }

          .logon-container > .welcome > .info svg {
            margin: 0 0 -3px 0;
            color: var(--accent-color);
            width: 14px;
            height: 14px;
          }

          .logon-container > .footer {
            margin: 10px 0 0 0;
            display: flex;
            flex-flow: row;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            gap: 0;
          }

          .logon-container > .footer > li {
            display: flex;
            margin: 5px 10px 0 0;
            cursor: default;
          }

          .logon-container > .footer > li a {
            color: inherit;
            line-height: 1.4;
            text-decoration: none;
            font-size: 0.9rem;
            font-weight: 400;
          }

          .logon-container > .footer > li:first-of-type {
            order: 5;
          }
        }
      </style>
    `;
    }
  }

  class AppSearch extends HTMLElement {
    constructor() {
      // We are not even going to touch this.
      super();

      // Get default tab
      this._tab = this.getAttribute('tab');

      // get query
      this._query = this.getAttribute('query');

      //Get url in lowercase
      this._url = this.getAttribute('url').trim().toLowerCase();

      this._active = null;

      // let's create our shadow root
      this.shadowObj = this.attachShadow({ mode: "open" });

      this.setTitle();

      this.render();
    }

    setQuery = () => {
      // Check if query q is in the url and update the query
      const url = new URL(window.location.href);
      const q = url.searchParams.get('q');

      if (q !== '' && q !== null && q !== 'null') {
        // update query
        this._query = q;
        this.setAttribute('query', q);
      }
      else {
        const query = this.getAttribute('query');

        if (query !== '' && query !== null && query !== 'null') {
          // update query
          this._query = query;
        }
        else {
          // update query
          this._query = null;
        }
      }
    }

    updateInput = form => {
      // update input value
      if(this._query) {
        form.querySelector('input').value = this._query;
        this.setKey(form);
      }
    }

    setTitle = () => {
      // update title of the document
      if (this._query) {
        document.title = `Search | ${this._query}`;
      }
      else {
        document.title = 'Search | Discover and connect with people, topics and stories';
      }
    }

    render() {
      this.shadowObj.innerHTML = this.getTemplate();
    }

    connectedCallback() {
      this.enableScroll();

      // request user to enable notifications
      this.checkNotificationPermission();

      // Activate tab
      const contentContainer = this.shadowObj.querySelector('div.content-container');
      const tabContainer = this.shadowObj.querySelector('ul#tab');
      const form = this.shadowObj.querySelector('form.search');

      // activate popstate
      this.activateOnPopState();
    
      if (contentContainer && tabContainer && form) {
        this.updateActiveTab(this._tab, tabContainer);
        this.activateTab(contentContainer, tabContainer);
        this.activateForm(form, tabContainer, contentContainer);
        this.updateInput(form);

        const svgBtn = form.querySelector('svg');
        if(svgBtn){
          this.activateBackButton(svgBtn);
        }
      }

      // watch for mql changes
      const mql = window.matchMedia('(max-width: 660px)');

      this.watchMediaQuery(mql, contentContainer);
    }

      checkNotificationPermission = async () => {
      if(window.notify && !window.notify.permission) {
        await window.notify.requestPermission();
      }
    }

    disconnectedCallback() {
      this.enableScroll();
    }

    // watch for mql changes
    watchMediaQuery = mql => {
      mql.addEventListener('change', () => {
        // Re-render the component
        this.render();

        const contentContainer = this.shadowObj.querySelector('div.content-container');
        const tabContainer = this.shadowObj.querySelector('ul#tab');
        const form = this.shadowObj.querySelector('form.search');
      
        if (contentContainer && tabContainer && form) {
          this.updateActiveTab(this._tab, tabContainer);
          this.activateTab(contentContainer, tabContainer);
          this.activateForm(form, tabContainer, contentContainer);
          this.updateInput(form);
        }
      });
    }

     disableScroll() {
      // Get the current page scroll position
      let scrollTop = window.scrollY || document.documentElement.scrollTop;
      let scrollLeft = window.scrollX || document.documentElement.scrollLeft;
      document.body.classList.add("stop-scrolling");

      // if any scroll is attempted, set this to the previous value
      window.onscroll = function () {
        window.scrollTo(scrollLeft, scrollTop);
      };
    }

    enableScroll() {
      document.body.classList.remove("stop-scrolling");
      window.onscroll = function () { };
    }

    updateActiveTab = (active, tabContainer) => {
      // Select tab with active class
      const tab = this.shadowObj.querySelector(`ul#tab > li.${active}`);

      // select line
      const line = tabContainer.querySelector('span.line');

      if (tab && line) {
        tab.classList.add('active');

        // update active tab
        this._active = tab;

        // Calculate half tab width - 10px
        const tabWidth = (tab.offsetWidth/2) - 20;

        // update line
        line.style.left = `${tab.offsetLeft + tabWidth}px`;
      }
      else {
        // Select the stories tab
        const storiesTab = this.shadowObj.querySelector("ul#tab > li.stories");
        storiesTab.classList.add('active');
      }
    }

    activateForm = (form, tabContainer, contentContainer) => {
      const outerThis = this;
      form.addEventListener('submit', e => {
        e.preventDefault();
        e.stopPropagation();

        const query = form.querySelector('input').value;

        if (query.trim() === '') {
          return;
        }

        // update query
        outerThis._query = query;

        // update query attribute
        outerThis.setAttribute('query', outerThis._query);

        // update title of the document
        document.title = `Search query -  ${query}`;

        // update url
        outerThis._url = `/search?q=${query}`;

        // update setKey
        outerThis.setKey(form);

        // update url attribute
        outerThis.setAttribute('url', outerThis._url);

        // update search bar url by adding query
        window.history.replaceState(null, null, outerThis._url);

        // update tab attribute
        outerThis.setAttribute('tab', 'stories');

        // get tab container
        const tab = outerThis.getContainer('stories');

        // remove active tab
        outerThis.removeActiveTab(tabContainer);

        // Set active tab
        outerThis.updateActiveTab('stories', tabContainer);

        // update content
        contentContainer.innerHTML = tab;
      });
    }

    removeActiveTab = tabContainer => {
      // remove active tab
      const activeTab = tabContainer.querySelector('li.tab-item.active');
      if (activeTab) {
        activeTab.classList.remove('active');
      }
    }

    activateTab = (contentContainer, tabContainer) => {
      const outerThis = this;

      const line = tabContainer.querySelector('span.line');
      const tabItems = tabContainer.querySelectorAll('li.tab-item');

      tabItems.forEach(tab => {
        tab.addEventListener('click', e => {
          e.preventDefault();
          e.stopPropagation();

          // Calculate half tab width - 10px
          const tabWidth = (tab.offsetWidth / 2) - 20;

          line.style.left = `${tab.offsetLeft + tabWidth}px`;

          if (tab.dataset.element === outerThis._active.dataset.element) {
            return;
          }
          else {
            outerThis._active.classList.remove('active');
            tab.classList.add('active');
            outerThis._active = tab;

            // update tab attribute  and this._tab
            outerThis._tab = tab.dataset.element;
            outerThis.setAttribute('tab', outerThis._tab);

            // update tab attribute  and this._tab
            outerThis._tab = tab.dataset.element;

            if (tab.dataset.element === "stories") {
              contentContainer.innerHTML = outerThis.getStories();
            } else if (tab.dataset.element === "replies") {
              contentContainer.innerHTML = outerThis.getReplies();
            } else if (tab.dataset.element === "topics") {
              contentContainer.innerHTML = outerThis.getTopics();
            } else if (tab.dataset.element === "people") {
              contentContainer.innerHTML = outerThis.getPeople();
            } else {
              contentContainer.innerHTML = outerThis.getStories();
            }
          }
        });
      });
    }

    updateState = (state, contentContainer) => {
      // populate content
      contentContainer.innerHTML = state.content;
    }

    updateDefault = contentContainer => {
      contentContainer.innerHTML = this.getContainer(this._tab);
    }

    selectCurrentFeed = tab => {
      // Select the current feed
      switch (tab) {
        case "stories":
          return this.getStories();
        case "replies":
          return this.getReplies();
        case "topics":
          return this.getTopics();
        case "people":
          return this.getPeople();
      }
    }

    getTemplate = () => {
      // Show HTML Here
      return `
      ${this.getBody()}
      ${this.getStyles()}
    `;
    }

    activateBackButton = btn => {
      btn.addEventListener('click', () => {
        // check window history is greater or equal to 1
        if (window.history.length >= 1) {
          // check if the history has state
          if (window.history.state) {
            // go back
            window.history.back();
          }
          else {
            // redirect to home
            window.location.href = '/home';
          }
        }
      });
    }

    activateOnPopState = () => {
      const outerThis = this;
      // Update state on window.onpopstate
      window.onpopstate = event => {
        if (event.state) {
          if (event.state.popup) {
            return;
          }

          if (event.state.page) {
            outerThis.updatePage(event.state.content);
          }
        }
      };
    }

    updatePage = content => {
      // select body
      const body = document.querySelector('body');

      // populate content
      body.innerHTML = content;
    }

    setKey = form => {
      const key = this.shadowObj.querySelector('p.search > span.key');

      if (key) {
        if (this._query) {
          key.textContent = this._query;
        }
        else {
          key.parentElement.remove();
        }
      }
      else if (this._query) {
        const html = /* html */`<p class="search">Showing results for <span class="key">${this._query}</span></p>`;
      
        form.insertAdjacentHTML('afterend', html);
      }
      
    }

    getBody = () => {
      const mql = window.matchMedia('(max-width: 660px)');
      if (mql.matches) {
        return /* html */`
        ${this.getForm()}
        ${this.getTab()}
        <div class="content-container">
          ${this.getContainer(this._tab)}
        </div>
      `;
      }
      else {
        return /* html */`
        <section class="main">
          ${this.getForm()}
          ${this.getTab()}
          <div class="content-container">
            ${this.getContainer(this._tab)}
          </div>
        </section>

        <section class="side">
          <topics-container url="/api/v1/q/trending/topics"></topics-container>
          ${this.getInfo()}
        </section>
      `;
      }
    }

    getForm = () => {
      return /*html*/`
      <form action="" method="get" class="search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
          <path d="M15.28 5.22a.75.75 0 0 1 0 1.06L9.56 12l5.72 5.72a.749.749 0 0 1-.326 1.275.749.749 0 0 1-.734-.215l-6.25-6.25a.75.75 0 0 1 0-1.06l6.25-6.25a.75.75 0 0 1 1.06 0Z"></path>
        </svg>
        <div class="contents">
          <input type="text" name="q" id="query" placeholder="What's your query?">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <circle cx="11.7666" cy="11.7667" r="8.98856" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"  stroke-linejoin="round" />
            <path d="M18.0183 18.4853L21.5423 22.0001" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
          </svg>
          <button type="submit">Search</button>
        </div>
      </form>
    `
    }

    getContainer = active => {
      // Switch active tab
      switch (active) {
        case "stories":
          return this.getStories();
        case "replies":
          return this.getReplies();
        case "people":
          return this.getPeople();
        case "topics":
          return this.getTopics();
        default:
          return this.getStories();
      }
    }

    getTopics = () => {
      const trending = this.getAttribute('trending-topics');
      const topics = this.getAttribute('topics-url');
      return /*html*/`
      <topics-feed page="1"
        url="${this._query ? topics + '?q=' + this._query : trending}" ${this._query ? 'query="true"' : ''}
        kind="search">
      </topics-feed>
    `
    }

    getStories = () => {
      const trending = this.getAttribute('trending-stories');
      const stories = this.getAttribute('stories-url');
      return /*html*/`
      <stories-feed page="1"
        url="${this._query ? stories + '?q=' + this._query : trending}" ${this._query ? 'query="true"' : ''}
        kind="search">
      </stories-feed>
    `
    }

    getReplies = () => {
      const replies = this.getAttribute('replies-url');
      const trending = this.getAttribute('trending-replies');
      return /* html */`
      <replies-feed page="1"
        url="${this._query ? replies + '?q=' + this._query : trending}" ${this._query ? 'query="true"' : ''}
        kind="search">
      </replies-feed>
    `
    }

    getPeople = () => {
      const people = this.getAttribute('people-url');
      const trending = this.getAttribute('trending-people');
      return /*html*/`
      <people-feed page="1"
        url="${this._query ? people + '?q=' + this._query : trending}" ${this._query ? 'query="true"' : ''}
        kind="search">
      </people-feed>
    `
    }

    getInfo = () => {
      return /*html*/`
      <info-container docs="/about/docs" new="/about/new"
       feedback="/about/feedback" request="/about/request" code="/about/code" donate="/about/donate" contact="/about/contact" company="https://github.com/aduki-hub">
      </info-container>
    `
    }

    getTab = () => {
      return /* html */`
      <div class="tab-control">
        <ul id="tab" class="tab">
          <li data-element="stories" class="tab-item stories">
            <span class="text">Stories</span>
          </li>
          <li data-element="replies" class="tab-item replies">
            <span class="text">Replies</span>
          </li>
          <li data-element="topics" class="tab-item topics">
            <span class="text">Topics</span>
          </li>
          <li data-element="people" class="tab-item people">
            <span class="text">People</span>
          </li>
          <span class="line"></span>
        </ul>
      </div>
    `
    }

    getStyles() {
      return /* css */`
	    <style>
	      *,
	      *:after,
	      *:before {
	        box-sizing: border-box !important;
	        font-family: inherit;
	        -webkit-box-sizing: border-box !important;
	      }

	      *:focus {
	        outline: inherit !important;
	      }

	      *::-webkit-scrollbar {
	        width: 3px;
	      }

	      *::-webkit-scrollbar-track {
	        background: var(--scroll-bar-background);
	      }

	      *::-webkit-scrollbar-thumb {
	        width: 3px;
	        background: var(--scroll-bar-linear);
	        border-radius: 50px;
	      }

	      h1,
	      h2,
	      h3,
	      h4,
	      h5,
	      h6 {
	        padding: 0;
	        margin: 0;
	        font-family: inherit;
	      }

	      p,
	      ul,
	      ol {
	        padding: 0;
	        margin: 0;
	      }

	      a {
	        text-decoration: none;
	      }

	      :host {
          font-size: 16px;
          padding: 0;
          margin: 0;
          display: flex;
          justify-content: space-between;
          gap: 30px;
        }

        section.main {
          display: flex;
          flex-flow: column;
          align-items: start;
          gap: 0;
          width: 63%;
          min-height: 100vh;
        }

        p.search {
          font-size: 1.15rem;
          font-weight: 500;
          color: var(--text-color);
          font-family: var(--font-text);
          margin: 0 0 5px;
        }

        p.search > span.key {
          font-weight: 500;
          color: transparent;
          background: var(--second-linear);
          background-clip: text;
          -webkit-background-clip: text;
        }

        p.search > span.key:before {
          content: open-quote;
          color: var(--gray-color);
          font-size: 1rem;
          line-height: 1;
        }

        p.search > span.key:after {
          content: close-quote;
          color: var(--gray-color);
          font-size: 1rem;
          line-height: 1;
        }

        form.search {
          background: var(--background);
          padding: 0;
          padding: 22px 0 10px;
          display: flex;
          flex-flow: column;
          align-items: start;
          flex-wrap: nowrap;
          gap: 5px;
          z-index: 6;
          width: 100%;
          position: sticky;
          top: 0;
        }

        form.search > svg {
          position: absolute;
          left: -12px;
          top: calc(50% - 15px);
          color: var(--text-color);
          cursor: pointer;
          width: 40px;
          height: 40px;
        }

        form.search > svg:hover {
          color: var(--accent-color);
        }

        form.search > .contents {
          padding: 0;
          display: flex;
          flex-flow: row;
          align-items: center;
          flex-wrap: nowrap;
          gap: 0;
          margin: 0 0 0 28px;
          width: calc(100% - 28px);
          position: relative;
        }

        form.search > .contents > input {
          border: var(--border-mobile);
          background-color: var(--background) !important;
          display: flex;
          flex-flow: row;
          align-items: center;
          font-family: var(--font-text);
          color: var(--highlight-color);
          font-size: 1rem;
          padding: 8px 10px 8px 35px;
          gap: 0;
          width: 100%;
          border-radius: 18px;
          -webkit-border-radius: 18px;
          -moz-border-radius: 18px;
          -ms-border-radius: 18px;
          -o-border-radius: 18px;
        }
        
        form.search > .contents > input:-webkit-autofill,
        form.search > .contents > input:-webkit-autofill:hover, 
        form.search > .contents > input:-webkit-autofill:focus {
          -webkit-box-shadow: 0 0 0px 1000px var(--background) inset;
          -webkit-text-fill-color: var(--text-color) !important;
          transition: background-color 5000s ease-in-out 0s;
          color: var(--highlight-color) !important;
        }
        
        form.search > .contents > input:autofill {
          filter: none;
          color: var(--highlight-color) !important;
        }

        form.search > .contents > svg {
          position: absolute;
          height: 18px;
          color: var(--gray-color);
          width: 18px;
          left: 10px;
          top: 50%;
          transform: translateY(-50%);
        }

        form.search > .contents > button {
          position: absolute;
          right: 10px;
          top: calc(50% - 14px);
          border: none;
          cursor: pointer;
          color: var(--white-color);
          background: var(--accent-linear);
          height: 28px;
          width: max-content;
          padding: 0 10px;
          font-size: 0.9rem;
          font-weight: 500;
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 0;
          border-radius: 50px;
          -webkit-border-radius: 50px;
          -moz-border-radius: 50px;
        }

        .tab-control {
          border-bottom: var(--border);
          background-color: var(--background);
          display: flex;
          flex-flow: column;
          padding: 5px 0 0 0;
          gap: 0;
          z-index: 5;
          width: 100%;
          position: sticky;
          top: 60px;
        }

        .tab-control > ul.tab {
          height: max-content;
          width: 100%;
          padding: 0;
          margin: 0;
          list-style-type: none;
          display: flex;
          gap: 0;
          align-items: center;
          max-width: 100%;
          overflow-x: scroll;
          -ms-overflow-style: none;
          scrollbar-width: none;
        }

        .tab-control > ul.tab::-webkit-scrollbar {
          display: none !important;
          visibility: hidden;
        }

        .tab-control > ul.tab > li.tab-item {
          color: var(--gray-color);
          font-family: var(--font-text), sans-serif;
          font-weight: 400;
          padding: 6px 20px 8px 0;
          margin: 0;
          display: flex;
          align-items: center;
          cursor: pointer;
          overflow: visible;
          font-size: 0.95rem;
        }

        .tab-control > ul.tab > li.tab-item > .text {
          font-weight: 500;
          font-size: 1rem;
        }

        .tab-control > ul.tab > li.tab-item:hover > .text {
          color: transparent;
          background: var(--accent-linear);
          background-clip: text;
          -webkit-background-clip: text;
        }

        .tab-control > ul.tab > li.active {
          font-size: 0.95rem;
        }

        .tab-control > ul.tab > li.active > .text {
          color: transparent;
          background: var(--accent-linear);
          background-clip: text;
          -webkit-background-clip: text;
          font-family: var(--font-read);
        }

        .tab-control > ul.tab span.line {
          position: absolute;
          z-index: 1;
          background: var(--accent-linear);
          display: inline-block;
          bottom: -3px;
          left: 12px;
          width: 20px;
          min-height: 5px;
          border-top-left-radius: 5px;
          border-top-right-radius: 5px;
          border-bottom-left-radius: 5px;
          border-bottom-right-radius: 5px;
          transition: all 300ms ease-in-out;
        }

        div.content-container {
          padding: 0;
          display: flex;
          flex-flow: column;
          align-items: center;
          flex-wrap: nowrap;
          gap: 15px;
          width: 100%;
        }

        section.side {
          padding: 25px 0;
          width: 33%;
          display: flex;
          flex-flow: column;
          gap: 20px;
          position: sticky;
          top: 0;
          height: 100vh;
          max-height: 100vh;
          overflow-y: scroll;
          scrollbar-width: none;
        }

        section.side::-webkit-scrollbar {
          visibility: hidden;
          display: none;
        }

        @media screen and (max-width:900px) {
          section.main {
            width: 58%;
          }

          section.side {
            width: 40%;
          }
        }

				@media screen and (max-width:660px) {
					:host {
            font-size: 16px;
						padding: 0;
            margin: 0;
            display: flex;
            flex-flow: column;
            justify-content: space-between;
            gap: 0;
					}

					::-webkit-scrollbar {
						-webkit-appearance: none;
					}

          form.search {
            background: var(--background);
            padding: 0;
            padding: 10px 0 10px;
            display: flex;
            flex-flow: column;
            align-items: start;
            flex-wrap: nowrap;
            gap: 5px;
            z-index: 6;
            width: 100%;
            position: sticky;
            top: 0;
          }

          form.search > svg {
            position: absolute;
            left: -12px;
            top: calc(50% - 22px);
            color: var(--text-color);
            cursor: default !important;
            width: 42px;
            height: 42px;
          }

          .tab-control > ul.tab > li.tab-item,
					a {
						cursor: default !important;
          }

          form.search > .contents > input {
            padding: 10px 10px 10px 35px;
            width: 100%;
            border-radius: 18px;
            -webkit-border-radius: 18px;
            -moz-border-radius: 18px;
            -ms-border-radius: 18px;
            -o-border-radius: 18px;
          }

          .section.main {
            display: flex;
            flex-flow: column;
            gap: 0;
            width: 100%;
          }

          .tab-control {
            border: none;
            padding: 0;
            border-bottom: var(--border);
            position: sticky;
            top: 60px;
          }

          section.side {
            padding: 0;
            display: none;
            width: 100%;
          }
				}
	    </style>
    `;
    }
  }

  class AppStory extends HTMLElement {
    constructor() {
      // We are not even going to touch this.
      super();

      this.setTitle(this.getAttribute('story-title'));

      this.viewed = false;

      // let's create our shadow root
      this.shadowObj = this.attachShadow({ mode: "open" });

      this.boundHandleWsMessage = this.handleWsMessage.bind(this);
      this.checkAndAddHandler = this.checkAndAddHandler.bind(this);

      this.topics = this.getTopics();

      this._content = this.innerHTML;

      this.render();
    }

    setTitle = title => {
      // update title of the document
      document.title = `Story | ${title}`;
    }

    getTopics = () => {
      // get the topics
      let topics = this.getAttribute('topics');

      // 
      return topics ? topics.split(',') : ['story'];
    }

    render() {
      this.shadowObj.innerHTML = this.getTemplate();
    }

    connectedCallback() {
      this.enableScroll();
      // Change style to flex
      this.style.display='flex';

      // open urls
      this.openUrl();

      // get the content
      const content = this.shadowObj.querySelector('article.article');

      // adjust the indicator
      this.adjustIndicator(content);

      // connect to the WebSocket
      this.checkAndAddHandler();

      // request user to enable notifications
      this.checkNotificationPermission();

      // Get mql object
      const mql = window.matchMedia('(max-width: 660px)');

      this.watchMediaQuery(mql);

      // view the story
      this.activateView();
    }

    checkNotificationPermission = async () => {
      if(window.notify && !window.notify.permission) {
        await window.notify.requestPermission();
      }
    }

    checkAndAddHandler() {
      if (window.wss) {
        window.wss.addMessageHandler(this.boundHandleWsMessage);
        // console.log('WebSocket handler added successfully');
      } else {
        // console.log('WebSocket manager not available, retrying...');
        setTimeout(this.checkAndAddHandler, 500); // Retry after 500ms
      }
    }

    disconnectedCallback() {
      this.enableScroll();
      if (window.wss) {
        window.wss.removeMessageHandler(this.boundHandleWsMessage);
      }
    }

    handleWsMessage = message => {
      // Handle the message in this component
      // console.log('Message received in component:', message);
      const data = message.data;

      if (message.type !== 'action') return;

      const user = data?.user;
      const userHash = window.hash;

      const hash = this.getAttribute('hash').toUpperCase();
      const authorHash = this.getAttribute('author-hash').toUpperCase();

      const author = this.shadowObj.querySelector('author-wrapper');
      let wrapper = this.shadowObj.querySelector('action-wrapper');

      const target = data.hashes.target;

      // handle connect action
      if (data.action === 'connect' && data.kind === 'user') {
        this.handleConnectAction(data, author, userHash, authorHash);
      }
      else if(hash === target) {
        if (data.action === 'reply') {
          const replies = this.parseToNumber(this.getAttribute('replies')) + data.value;
          this.updateReplies(wrapper, replies);
        }
        else if(data.action === 'view') {
          const views = this.parseToNumber(this.getAttribute('views')) + data.value;
          this.updateViews(wrapper, views);
        }
        else if (data.action === 'like') {
          if(user !== null && user === userHash) {
            return;
          }
          // get likes parsed to number
          const likes = (this.parseToNumber(this.getAttribute('likes')) + data.value);
          // update likes
          this.updateLikes(wrapper, likes);
        }
      }
    }

    sendWsMessage(data) {
      if (window.wss) {
        window.wss.sendMessage(data);
      } else {
        console.warn('WebSocket connection not available. view information not sent.');
      }
    }

    handleConnectAction = (data, author, userHash, authorHash) => {
      const to = data.hashes.to;
      if(to === authorHash) {
        const followers = this.parseToNumber(this.getAttribute('author-followers')) + data.value;
        this.setAttribute('author-followers', followers);
        this.updateFollowers(author, followers);

        if (data.hashes.from === userHash) {
          const value = data.value === 1 ? 'true' : 'false';
          // update user-follow/auth-follow attribute
          this.setAttribute('author-follow', value);
          if(author) {
            author.setAttribute('user-follow', value);
          }
        }

        if(author) {
          author.setAttribute('reload', 'true');
        }
      }
    }

    updateLikes = (element, value) => {
      // update likes in the element and this element
      this.setAttribute('likes', value);
      element.setAttribute('likes', value);
      element.setAttribute('reload', 'true');
    }

    updateViews = (element, value) => {
      // update views in the element and this element
      this.setAttribute('views', value);
      element.setAttribute('views', value);
      element.setAttribute('reload', 'true');
    }

    updateReplies = (element, value) => {
      // update replies in the element and this element
      this.setAttribute('replies', value);
      element.setAttribute('replies', value);
      element.setAttribute('reload', 'true');
    }

    updateFollowers = (element, value) => {
      if (!element) {
        return;
      }
      element.setAttribute('followers', value);
    }

    updateAuthorFollowers = (element, value) => {
      element.setAttribute('author-followers', value);
      element.setAttribute('reload', 'true');
    }

    activateView = () => {
      if (!this.viewed) {
        setTimeout(() => {
          this.sendViewData();
          this.viewed = true;
        }, 5000);
      }
    } 

    sendViewData() {
      const authorHash = this.getAttribute('author-hash').toUpperCase();
      // check if the author is the user
      if (authorHash === window.hash) return;

      const hash = this.getAttribute('hash').toUpperCase();

      const viewData = {
        type: 'action',
        frontend: true,
        data: {
          kind: 'story',
          publish: true,
          hashes: { target: hash },
          action: 'view',
          value: 1
        }
      };

      // send the view data
      this.sendWsMessage(viewData);
    }

    watchMediaQuery = mql => {
      mql.addEventListener('change', () => {
        // Re-render the component
        this.render();
      });
    }

    parseToNumber = str => {
      // Try parsing the string to an integer
      const num = parseInt(str);

      // Check if parsing was successful
      if (!isNaN(num)) {
        return num;
      } else {
        return 0;
      }
    }

    openUrl = () => {
      // get all the links
      const links = this.shadowObj.querySelectorAll('article.article a');
      const body = document.querySelector('body');

      // loop through the links
      if (!links) return;
      
      links.forEach(link => {
        // add event listener to the link
        link.addEventListener('click', event => {
          event.preventDefault();
          // get the url
          const url = link.getAttribute('href');

          // link pop up
          let linkPopUp = `<url-popup url="${url}"></url-popup>`;

          // open the popup
          body.insertAdjacentHTML('beforeend', linkPopUp);
        });
      });
    }

    adjustIndicator = content => {
      // get total height of the content(including padding and scroll height)
      const totalHeight = content.scrollHeight;

      // get the scroll position of the content
      const scrollPosition = document.documentElement.scrollTop;

      // calculate the percentage of the scroll position
      const scrollPercentage = (scrollPosition / totalHeight) * 100;

      // get the indicator
      const indicator = this.shadowObj.querySelector('.indicator');

      // if percentage is greater than 100, set the indicator to 100%
      if (scrollPercentage >= 100) {
        indicator.style.width = `100%`;
        return;
      }

      // set the width of the indicator
      indicator.style.width = `${scrollPercentage}%`;


      // add scroll event listener to body but check if the content is still in view
      document.addEventListener('scroll', () => {
        // get total height of the content(minus padding)
        const totalHeight = content.scrollHeight;

        // get the scroll position of the content in the y-axis
        const scrollPosition = document.documentElement.scrollTop;

        // calculate the percentage of the scroll position
        const scrollPercentage = (scrollPosition / totalHeight) * 100;

        // if the scroll position is greater than the total height of the content, set the indicator to 100%
        if (scrollPosition >= totalHeight) {
          indicator.style.width = `100%`;
          return;
        }

        // if percentage + 8  is greater than 100, set the indicator to 100%
        if (scrollPercentage >= 100) {
          indicator.style.width = `100%`;
          return;
        }

        // set the width of the indicator
        indicator.style.width = `${scrollPercentage}%`;
      });
    }

    disableScroll() {
      // Get the current page scroll position
      let scrollTop = window.scrollY || document.documentElement.scrollTop;
      let scrollLeft = window.scrollX || document.documentElement.scrollLeft;
      document.body.classList.add("stop-scrolling");

      // if any scroll is attempted, set this to the previous value
      window.onscroll = function () {
        window.scrollTo(scrollLeft, scrollTop);
      };
    }

    enableScroll() {
      document.body.classList.remove("stop-scrolling");
      window.onscroll = function () { };
    }

    getDate = isoDateStr => {
      const dateIso = new Date(isoDateStr); // ISO strings with timezone are automatically handled
      let userTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
      // userTimezone.replace('%2F', '/')

      // Convert posted time to the current timezone
      const date = new Date(dateIso.toLocaleString('en-US', { timeZone: userTimezone }));

      return `
      ${date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}
    `
    }

    formatDateWithRelativeTime = isoDateStr => {
      // 1. Convert ISO date string with timezone to local Date object
      let date;
      try {
        date = new Date(isoDateStr);
      }
      catch (error) {
        date = new Date(Date.now());
      }

      // Get date
      const localDate = date.toLocaleDateString('en-US', {
        year: 'numeric', month: 'short', day: '2-digit'
      });

      // Get time
      let localTime = date.toLocaleDateString('en-US', {
        hour: 'numeric', minute: '2-digit', hour12: true
      });

      localTime = localTime.split(',')[1].trim();

      return { dateStr: localDate, timeStr: localTime }
    }

    getTemplate = () => {
      // Show HTML Here
      return `
      ${this.getBody()}
      ${this.getStyles()}
    `;
    }

    getBody = () => {
      const mql = window.matchMedia('(max-width: 660px)');
      if (mql.matches) {
        return /* html */`
        ${this.getTop()}
        <span class="indicator"></span>
        ${this.getAuthor()}
        <div class="content" id="content-container">
          ${this.getHeader()}
          ${this.getContent()}
          ${this.getMeta()}
          ${this.getStats()}
          ${this.getSection()}
        </div>
      `;
      }
      else {
        return /* html */`
        <div class="content" id="content-container">
          ${this.getTop()}
          <span class="indicator"></span>
          ${this.getHeader()}
          ${this.getContent()}
          ${this.getMeta()}
          ${this.getStats()}
          ${this.getSection()}
        </div>

        <section class="side">
          ${this.getAuthor()}
          <topics-container url="/api/v1/q/trending/topics"></topics-container>
          ${this.getInfo()}
        </section>
      `;
      }
    }

    getHeader = () => {
      let str = this.topics[0];
      let formatted = str.toLowerCase().replace(/(^|\s)\S/g, match => match.toUpperCase());
      return /*html*/`
      <div class="head">
        <span class="topic">${formatted}</span>
        <h1 class="story-title">${this.getAttribute('story-title')}</h1>
      </div>
    `
    }

    getContent = () => {
      const text = this.innerHTML;
      const parser = new DOMParser();
      const doc = parser.parseFromString(text, 'text/html');
      const parsedHTML = doc.body.innerHTML;
    
      return /* html */`
      <article class="article" id="article">
        ${parsedHTML}
      </article>
    `;
    }

    getTop = () => {
      return /* html */ `
      <header-wrapper section="Story" type="story"
        user-url="${this.getAttribute('user-url')}" auth-url="${this.getAttribute('auth-url')}"
        url="${this.getAttribute('story-url')}" search-url="${this.getAttribute('search-url')}">
      </header-wrapper>
    `
    }

    getAuthor = () => {
      const contact = this.getAttribute("author-contact");
      let bio = this.getAttribute('author-bio') || 'This author has not provided a bio yet.';
      // replace all " and ' with &quot; and &apos; to avoid breaking the html
      bio = bio.replace(/"/g, '&quot;').replace(/'/g, '&apos;');
      return /* html */`
			<author-wrapper hash="${this.getAttribute('author-hash')}" picture="${this.getAttribute('author-img')}" name="${this.getAttribute('author-name')}"
        followers="${this.getAttribute('author-followers')}" following="${this.getAttribute('author-following')}" user-follow="${this.getAttribute('author-follow')}"
        stories="${this.getAttribute('author-stories')}" replies="${this.getAttribute('author-replies')}" contact='${contact}'
        verified="${this.getAttribute('author-verified')}" url="${this.getAttribute('author-url')}" you="${this.getAttribute('author-you')}"
        bio="${bio}">
      </author-wrapper>
		`
    }

    getSection = () => {
      return /* html */`
      <post-section url="${this.getAttribute('url')}" active="${this.getAttribute('tab')}" section-title="Story" 
        author-hash="${this.getAttribute('author-hash')}" hash="${this.getAttribute('hash')}"
        replies="${this.getAttribute('replies')}" likes="${this.getAttribute('likes')}" kind="story"
        replies-url="${this.getAttribute('replies-url')}" likes-url="${this.getAttribute('likes-url')}">
      </post-section>
    `
    }

    getInfo = () => {
      return /*html*/`
      <info-container docs="/about/docs" new="/about/new"
       feedback="/about/feedback" request="/about/request" code="/about/code" donate="/about/donate" contact="/about/contact" company="https://github.com/aduki-hub">
      </info-container>
    `
    }

    getMeta = () => {
      let dateObject = this.formatDateWithRelativeTime(this.getAttribute('time'));
      return /* html */`
      <div class="meta">
        <span class="sp">on</span>
        <time class="published" datetime="${this.getAttribute('time')}">${dateObject.dateStr}</time>
        <span class="sp">•</span>
        <span class="sp">at</span>
        <span class="time">${dateObject.timeStr}</span>
      </div>
    `
    }

    getStats = () => {
      return /*html*/`
      <action-wrapper full="true" kind="story" reload="false" likes="${this.getAttribute('likes')}" images="${this.getAttribute('images')}"
        replies="${this.getAttribute('replies')}" liked="${this.getAttribute('liked')}" wrapper="true"
        hash="${this.getAttribute('hash')}" views="${this.getAttribute('views')}"  url="${this.getAttribute('url')}" summary="${this.getAttribute('story-title')}"
        preview-title="${this.getAttribute('story-title')}" time="${this.getAttribute('time')}"
        author-hash="${this.getAttribute('author-hash')}">
        ${this.getHTML()}
      </action-wrapper>
    `
    }
    
    getHTML = () => {
      const text = this.innerHTML;
      const parser = new DOMParser();
      const doc = parser.parseFromString(text, 'text/html');
      return doc.body.innerHTML;
    }

    getStyles() {
      return /* css */`
	    <style>
	      *,
	      *:after,
	      *:before {
	        box-sizing: border-box !important;
	        font-family: inherit;
	        -webkit-box-sizing: border-box !important;
	      }

	      *:focus {
	        outline: inherit !important;
	      }

	      *::-webkit-scrollbar {
	        width: 3px;
	      }

	      *::-webkit-scrollbar-track {
	        background: var(--scroll-bar-background);
	      }

	      *::-webkit-scrollbar-thumb {
	        width: 3px;
	        background: var(--scroll-bar-linear);
	        border-radius: 50px;
	      }

	      h1,
	      h2,
	      h3,
	      h4,
	      h5,
	      h6 {
	        padding: 0;
	        margin: 0;
	        font-family: inherit;
	      }

	      p,
	      ul,
	      ol {
	        padding: 0;
	        margin: 0;
	      }

	      a {
	        text-decoration: none;
	      }

	      :host {
          font-size: 16px;
          display: flex;
          width: 100%;
          gap: 30px;
          min-height: 100vh;
          justify-content: space-between;
        }

        div.content {
          padding: 0;
          width: 63%;
          display: flex;
          flex-flow: column;
          gap: 0;
        }

        /* Responses */
        div.content section.responses {
          display: flex;
          flex-flow: column;
          gap: 0;
        }

        section.side {
          padding: 25px 0;
          margin: 0;
          background-color: transparent;
          width: 33%;
          height: max-content;
          display: flex;
          flex-flow: column;
          gap: 20px;
          position: sticky;
          top: 0;
          height: 100vh;
          max-height: 100vh;
          overflow-y: scroll;
          scrollbar-width: none;
        }

        section.side::-webkit-scrollbar {
          visibility: hidden;
          display: none;
        }

        span.indicator {
          display: flex;
          z-index: 4;
          width: 0%;
          height: 3px;
          background: var(--alt-linear);
          border-radius: 5px;
          transition: width 0.3s;
          position: sticky;
          top: 60px;
          left: 0;
        }

        div.head {
          display: flex;
          flex-flow: column;
          gap: 0;
          margin: 15px 0 0;
        }

        div.head > .topic {
          width: max-content;
          color: var(--gray-color);
          padding: 3px 10px 3px 10px;
          background: var(--light-linear);
          font-family: var(--font-read), sans-serif;
          font-size: 0.8rem;
          font-weight: 500;
          border-radius: 10px;
          -webkit-border-radius: 10px;
          -moz-border-radius: 10px;
        }

        div.head > h1.story-title {
          margin: 15px 0 10px;
          padding: 0;
          font-weight: 700;
          font-size: 1.7rem;
          line-height: 1.2;
          font-family: var(--font-main), sans-serif;
          color: var(--title-color);
        }

        .meta {
          border-bottom: var(--border);
          border-top: var(--border);
          margin: 5px 0 0 0;
          padding: 10px 0;
          display: flex;
          position: relative;
          color: var(--text-color);
          align-items: center;
          font-family: var(--font-text), sans-serif;
          gap: 5px;
          font-size: 1rem;
          font-weight: 600;
        }

        .meta > .sp {
          font-size: 1rem;
          color: var(--gray-color);
          font-weight: 400;
        }

        article.article {
          margin: 3px 0 0;
          font-size: 1.05rem;
          display: flex;
          flex-flow: column;
          color: var(--read-color);
          font-family: var(--font-main), sans-serif;
          gap: 0;
          font-size: 1rem;
          font-weight: 400;
        }

        article.article * {
          font-size: inherit;
          line-height: 1.3;
          color: inherit;
          font-family: inherit;
        }

        article.article h6,
        article.article h5,
        article.article h4,
        article.article h3,
        article.article h1 {
          padding: 0;
          color: var(--title-color);
          font-weight: 500;
          line-height: 1.5;
          margin: 10px 0;
          font-family: var(--font-main), sans-serif;
        }

        article.article h6 {
          font-size: initial;
        }

        article.article h5 {
          font-size: initial;
        }

        article.article h4 {
          font-size: 1.25rem;
        }

        article.article h3 {
          font-size: 1.3rem !important;;
        }

        article.article h2 {
          font-size: 1.35rem !important;
          color: var(--title-color);
          font-weight: 600;
          line-height: 1.2;
          margin: 0;
          padding: 2px 0 0 13px;
          margin: 10px 0 10px;
          position: relative;
        }

        article.article h2:before {
          content: "";
          position: absolute;
          bottom: 10%;
          left: 0;
          width: 2px;
          height: 80%;
          background: var(--action-linear);
          border-radius: 5px;
        }

        article.article .intro p {
          margin: 0 0 5px 0;
          line-height: 1.4;
        }

        article.article p {
          margin: 5px 0;
          line-height: 1.4;
        }

        article.article a {
          text-decoration: none;
          cursor: pointer;
          color: var(--anchor-color) !important;
        }

        article.article a:hover {
          text-decoration: underline;
        }

        article.article blockquote {
          margin: 10px 0;
          padding: 5px 15px;
          font-style: italic;
          border-left: 2px solid var(--gray-color);
          background: var(--background);
          color: var(--text-color);
          font-weight: 400;
        }

        article.article blockquote:before {
          content: open-quote;
          color: var(--gray-color);
          font-size: 1.5rem;
          line-height: 1;
          margin: 0 0 0 -5px;
        }

        article.article blockquote:after {
          content: close-quote;
          color: var(--gray-color);
          font-size: 1.5rem;
          line-height: 1;
          margin: 0 0 0 -5px;
        }

        article.article blockquote p {
          margin: 0;
        }

        article.article blockquote * {
          margin: 0;
        }

        article.article hr {
          border: none;
          background-color: var(--gray-color);
          height: 1px;
          margin: 10px 0;
        }

        article.article ul,
        article.article ol {
          margin: 5px 0 15px 20px;
          padding: 0 0 0 15px;
          color: inherit;
        }

        article.article ul li,
        article.article ol li {
          padding: 5px 0;
        }

        article.article code {
          background: var(--gray-background);
          padding: 0 5px;
          font-family: var(--font-mono);
          font-size: 0.9rem;
          border-radius: 5px;
        }

        article.article img {
          max-width: 100%;
          height: auto;
          object-fit: contain;
          border-radius: 5px;
        }

        article.article figure {
          max-width: 100% !important;
          height: auto;
          width: max-content;
          padding: 0;
          max-width: 100%;
          display: block;
          margin-block-start: 5px;
          margin-block-end: 5px;
          margin-inline-start: 0 !important;
          margin-inline-end: 0 !important;
        }

        @media screen and (max-width:900px) {
          div.content {
            width: 58%;
          }

          section.side {
            width: 40%;
          }
        }

				@media screen and (max-width:660px) {
					:host {
            font-size: 16px;
						padding: 0;
            margin: 0;
            display: flex;
            min-height: max-content;
            height: max-content;
            flex-flow: column;
            gap: 0;
					}

          div.content .head {
            margin: 10px 0 0 0;
          }

          div.content {
            padding: 0;
            width: 100%;
            display: flex;
            flex-flow: column;
            gap: 0;
          }

					.action,
					a {
						cursor: default !important;
          }

          section.side {
            padding: 0;
            display: none;
            width: 0%;
          }
          a {
            cursor: default !important;
          }

          span.indicator {
            display: flex;
            width: 10%;
            height: 3px;
            border-radius: 5px;
            transition: width 0.3s;
            position: sticky;
            top: 50px;
            left: 0;
          }

          .meta {
            display: flex;
            position: relative;
            color: var(--text-color);
            align-items: center;
            font-family: var(--font-text), sans-serif;
            font-size: 0.9rem;
            gap: 5px;
            font-weight: 600;
          }

          a,
          span.action {
            cursor: default !important;
          }
				}
	    </style>
    `;
    }
  }

  class AppTopic extends HTMLElement {
    constructor() {
      // We are not even going to touch this.
      super();

      this.setTitle(this.getAttribute('name'));

      // check if the user is authenticated
      this._authenticated = window.hash ? true : false;

      // let's create our shadow root
      this.shadowObj = this.attachShadow({ mode: "open" });

      this.boundHandleWsMessage = this.handleWsMessage.bind(this);
      this.checkAndAddHandler = this.checkAndAddHandler.bind(this);

      this.render();
    }

    setTitle = title => {
      document.title = `Topic | ${title}`;
    }

    render() {
      this.shadowObj.innerHTML = this.getTemplate();
    }

    connectedCallback() {
      this.enableScroll();
      this.style.display = 'flex';
      // onpopstate event
      this.onPopEvent();

      // connect to the WebSocket
      this.checkAndAddHandler();

      // request user to enable notifications
      this.checkNotificationPermission();

      // perform actions
      this.performActions();

      // open highlights
      this.openHighlights(document.querySelector('body'));

      // Watch for media query changes
      const mql = window.matchMedia('(max-width: 660px)');
      this.watchMediaQuery(mql);
    }

    checkAndAddHandler() {
      if (window.wss) {
        window.wss.addMessageHandler(this.boundHandleWsMessage);
        // console.log('WebSocket handler added successfully');
      } else {
        // console.log('WebSocket manager not available, retrying...');
        setTimeout(this.checkAndAddHandler, 500); // Retry after 500ms
      }
    }

      checkNotificationPermission = async () => {
      if(window.notify && !window.notify.permission) {
        await window.notify.requestPermission();
      }
    }

    disconnectedCallback() {
      this.enableScroll();
      if (window.wss) {
        window.wss.removeMessageHandler(this.boundHandleWsMessage);
      }
    }

    handleWsMessage = message => {
      // Handle the message in this component
      // console.log('Message received in component:', message);
      const data = message.data;

      if (message.type !== 'action') return;

      const userHash = window.hash;

      const hash = this.getAttribute('hash').toUpperCase();
      const authorHash = this.getAttribute('author-hash').toUpperCase();

      const author = this.shadowObj.querySelector('author-wrapper');

      const target = data.hashes.target;

      // handle connect action
      if (data.action === 'connect' && data.kind === 'user') {
        this.handleConnectAction(data, author, userHash, authorHash);
      }
      else if (data.kind === 'topic' && target === hash) {
        this.handleTopicAction(data, data.value, userHash);

      }
    }

    sendWsMessage(data) {
      window.wss.sendMessage(data);
    }

    handleConnectAction = (data, author,userHash, authorHash) => {
      const to = data.hashes.to;
      if(to === authorHash) {
        const followers = this.parseToNumber(this.getAttribute('author-followers')) + data.value;
        this.setAttribute('author-followers', followers);
        this.updateFollowers(author, followers);

        if (data.hashes.from === userHash) {
          const value = data.value === 1 ? 'true' : 'false';
          // update user-follow/auth-follow attribute
          this.setAttribute('author-follow', value);
          if(author) {
            author.setAttribute('user-follow', value);
          }
        }

        if(author) {
          author.setAttribute('reload', 'true');
        }
      }
    }

    handleTopicAction = (data, value, userHash) => {
      if (data.user === userHash)  return;

      // if action is follow
      if (data.action === 'follow') {
        this.updateFollowers(value === 1);
      }
      else if (data.action === 'subscribe') {
        const subscribers = this.parseToNumber(this.getAttribute('subscribers')) + value;
        this.setAttribute('subscribers', subscribers.toString());
      }
    }

    // watch for mql changes
    watchMediaQuery = mql => {
      mql.addEventListener('change', () => {
        // Re-render the component
        this.render();

        // call onpopstate event
        this.onPopEvent();

        // perform actions
        this.performActions();

        // open highlights
        this.openHighlights(document.querySelector('body'));
      });
    }

    openHighlights = body => {
      // Get the stats action and subscribe action
      const statsBtn = this.shadowObj.querySelector('.actions > .action#stats-action');

      // add event listener to the stats action
      if (statsBtn) {
        statsBtn.addEventListener('click', e => {
          e.preventDefault();
          e.stopPropagation();

          // Open the highlights popup
          body.insertAdjacentHTML('beforeend', this.getHighlights());
        });
      }
    }

    // perform actions
    performActions = () => {
      const outerThis = this;
      // get body 
      const body = document.querySelector('body');

      // get url to 
      let hash = this.getAttribute('hash');
      // trim and convert to lowercase
      hash = hash.trim().toLowerCase();

      // base api
      const url = '/api/v1/t/' + hash;

      // Get the follow action and subscribe action
      const followBtn = this.shadowObj.querySelector('.actions>.action#follow-action');
      const subscribeBtn = this.shadowObj.querySelector('.actions>.action#subscribe-action');

      // add event listener to the follow action
      if (followBtn && subscribeBtn) {
        // construct options
        const options = {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json',
          }
        };

        followBtn.addEventListener('click', e => {
          e.preventDefault();
          e.stopPropagation();

          let action = false;

          // Check if the user is authenticated
          if (!this._authenticated) {
            // Open the join popup
            this.openJoin(body);
          } 
          else if (followBtn.classList.contains('following')) {
            action = true;
            outerThis.updateFollowBtn(false, followBtn);
            // Follow the topic
            this.followTopic(`${url}/follow`, options, followBtn, action);
          }
          else {
            outerThis.updateFollowBtn(true, followBtn);
            // Follow the topic
            this.followTopic(`${url}/follow`, options, followBtn, action);
          }
        });

        subscribeBtn.addEventListener('click', e=> {
          e.preventDefault();
          e.stopPropagation();

          let action = false;

          // Check if the user is authenticated
          if (!this._authenticated) {
            // Open the join popup
            this.openJoin(body);
          } 
          else if (subscribeBtn.classList.contains('subscribed')) {
            action = true;
            outerThis.updateSubscribeBtn(false, subscribeBtn);

            // Subscribe to the topic
            this.subscribeToTopic(`${url}/subscribe`, options, subscribeBtn, action);
          }
          else {
            outerThis.updateSubscribeBtn(true, subscribeBtn);

            // Subscribe to the topic
            this.subscribeToTopic(`${url}/subscribe`, options, subscribeBtn, action);
          }
        });
      }
    }

    followTopic = (url, options, followBtn, followed) => {
      const outerThis = this;
      this.fetchWithTimeout(url, options)
        .then(response => {
          response.json()
          .then(data => {
            // If data has unverified, open the join popup
            if (data.unverified) {
              // Get body
              const body = document.querySelector('body');

              // Open the join popup
              outerThis.openJoin(body);

              // revert the follow button
              outerThis.updateFollowBtn(followed, followBtn);
            }

            // if success is false, show toast message
            if (!data.success) {
              outerThis.showToast(data.message, false);

              // revert the follow button
              outerThis.updateFollowBtn(followed, followBtn);
            }
            else {
              // Show toast message
              outerThis.showToast(data.message, true);

              // Check for followed boolean
              outerThis.updateFollowBtn(data.followed, followBtn);

              // Update the followers
              outerThis.updateFollowers(data.followed);
            }
          });
        })
        .catch(_error => {
          // console.log(_error);
          // show toast message
          outerThis.showToast('An error occurred!', false);

          // revert the follow button
          outerThis.updateFollowBtn(followed, followBtn);
        });
    }

    subscribeToTopic = (url, options, subscribeBtn, subscribed) => {
      this.fetchWithTimeout(url, options)
        .then(response => {
          response.json()
          .then(data => {
            // Check if the user is unverified
            if (data.unverified) {
              // Get body
              const body = document.querySelector('body');

              // Open the join popup
              this.openJoin(body);

              // revert the subscribe button
              this.updateSubscribeBtn(subscribed, subscribeBtn);
            }

            // if success is false, show toast message
            if (!data.success) {
              this.showToast(data.message, false);

              // revert the subscribe button
              this.updateSubscribeBtn(subscribed, subscribeBtn);
            }
            else {
              // Show toast message
              this.showToast(data.message, true);

              // Check for subscribed boolean
              this.updateSubscribeBtn(data.subscribed, subscribeBtn);

              // update the subscribers attribute
              const value = data.subscribed ? 1 : -1;

              // Get subscribers attribute
              let subscribers = this.parseToNumber(this.getAttribute('subscribers')) + value;

              // if subscribers is less than 0, set it to 0
              subscribers = subscribers < 0 ? 0 : subscribers;

              // Set the subscribers attribute
              this.setAttribute('subscribers', subscribers.toString());
            }
          });
         })
        .catch(_error => {
          // show toast message
          this.showToast('An error occurred while subscribing to the topic', false);

          // revert the subscribe button
          this.updateSubscribeBtn(subscribed, subscribeBtn);
        });
    }

    fetchWithTimeout = async (url, options = {}, timeout = 9500) => {
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), timeout);
    
      try {
        const response = await fetch(url, {
          ...options,
          signal: controller.signal
        });

        return response;
      } catch (error) {
        if (error.name === 'AbortError') {
          throw new Error('Request timed out');
        }
        throw new Error(`Network error: ${error.message}`);
      } finally {
        clearTimeout(timeoutId);
      }
    };;

    updateSubscribeBtn = (subscribed, btn) => {
      if (subscribed) {
        // Change the text to subscribed
        btn.textContent = 'subscribed';

        // remove the subscribe class
        btn.classList.remove('subscribe');

        // add the subscribed class
        btn.classList.add('subscribed');
      }
      else {
        // Change the text to subscribe
        btn.textContent = 'subscribe';

        // remove the subscribed class
        btn.classList.remove('subscribed');

        // add the subscribe class
        btn.classList.add('subscribe');
      }
    }

    updateFollowBtn = (following, btn) => {
      if (following) {
        // Change the text to following
        btn.textContent = 'following';

        // remove the follow class
        btn.classList.remove('follow');

        // add the following class
        btn.classList.add('following');
      }
      else {
        // Change the text to follow
        btn.textContent = 'follow';

        // remove the following class
        btn.classList.remove('following');

        // add the follow class
        btn.classList.add('follow');
      }
    }

    showToast = (text, success) => {
      // Get the toast element
      const toast = this.getToast(text, success);

      // Get body element
      const body = document.querySelector('body');

      // Insert the toast into the DOM
      body.insertAdjacentHTML('beforeend', toast);

      // Remove the toast after 3 seconds
      setTimeout(() => {
        // Select the toast element
        const toast = body.querySelector('.toast');

        // Remove the toast
        if(toast) {
          toast.remove();
        }
      }, 3000);
    }

    getToast = (text, success) => {
      if (success) {
        return /* html */`
        <div class="toast true">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" fill="currentColor">
          <path d="M8 16A8 8 0 1 1 8 0a8 8 0 0 1 0 16Zm3.78-9.72a.751.751 0 0 0-.018-1.042.751.751 0 0 0-1.042-.018L6.75 9.19 5.28 7.72a.751.751 0 0 0-1.042.018.751.751 0 0 0-.018 1.042l2 2a.75.75 0 0 0 1.06 0Z"></path>
        </svg>
          <p class="toast-message">${text}</p>
        </div>
      `;
      }
      else {
        return /* html */`
      <div class="toast false">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" fill="currentColor">
          <path d="M2.343 13.657A8 8 0 1 1 13.658 2.343 8 8 0 0 1 2.343 13.657ZM6.03 4.97a.751.751 0 0 0-1.042.018.751.751 0 0 0-.018 1.042L6.94 8 4.97 9.97a.749.749 0 0 0 .326 1.275.749.749 0 0 0 .734-.215L8 9.06l1.97 1.97a.749.749 0 0 0 1.275-.326.749.749 0 0 0-.215-.734L9.06 8l1.97-1.97a.749.749 0 0 0-.326-1.275.749.749 0 0 0-.734.215L8 6.94Z"></path>
        </svg>
          <p class="toast-message">${text}</p>
        </div>
      `;
      }
      
    }

    openJoin = body => {
      // Insert getJoin beforeend
      body.insertAdjacentHTML('beforeend', this.getJoin());
    }

    getJoin = () => {
      // get url from the : only the path
      const url = window.location.pathname;

      return /* html */`
      <join-popup register="/join/register" login="/join/login" next="${url}"></join-popup>
    `
    }

    updateFollowers = (followed) => {
      const outerThis = this;
      let value = followed ? 1 : -1;
      // Get followers attribute : convert to number then add value

      let followers = this.parseToNumber(this.getAttribute('followers')) + value;

      // if followers is less than 0, set it to 0
      followers = followers < 0 ? 0 : followers;

      // Set the followers attribute
      this.setAttribute('followers', followers.toString());

      // select the followers element
      const followersStat = outerThis.shadowObj.querySelector('.stats > span.followers');
      if (followersStat) {
        // select no element
        const no = followersStat.querySelector('.no');
        const text = followersStat.querySelector('.text');

        // Update the followers
        no.textContent = this.formatNumber(followers);

        // Update the text
        text.textContent = followers === 1 ? 'follower' : 'followers';
      }
    }

    onPopEvent = () => {
      const outerThis = this;
      // Update state on window.onpopstate
      window.onpopstate = event => {
        // This event will be triggered when the browser's back button is clicked

        if (event.state) {
          if (event.state.popup) {
            return;
          }

          if (event.state.page) {
            outerThis.updatePage(event.state.content);
          }
        }
      };
    }

    updatePage = content => {
      // select body
      const body = document.querySelector('body');

      // populate content
      body.innerHTML = content;
    }

    disableScroll() {
      // Get the current page scroll position
      let scrollTop = window.scrollY || document.documentElement.scrollTop;
      let scrollLeft = window.scrollX || document.documentElement.scrollLeft;
      document.body.classList.add("stop-scrolling");

      // if any scroll is attempted, set this to the previous value
      window.onscroll = function () {
        window.scrollTo(scrollLeft, scrollTop);
      };
    }

    enableScroll() {
      document.body.classList.remove("stop-scrolling");
      window.onscroll = function () { };
    }

    getDate = isoDateStr => {
      const dateIso = new Date(isoDateStr); // ISO strings with timezone are automatically handled
      let userTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
      // userTimezone.replace('%2F', '/')

      // Convert posted time to the current timezone
      const date = new Date(dateIso.toLocaleString('en-US', { timeZone: userTimezone }));

      return `
      ${date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}
    `
    }

    formatNumber = n => {
      if (n >= 0 && n <= 999) {
        return n.toString();
      } else if (n >= 1000 && n <= 9999) {
        const value = (n / 1000).toFixed(2);
        return `${value}k`;
      } else if (n >= 10000 && n <= 99999) {
        const value = (n / 1000).toFixed(1);
        return `${value}k`;
      } else if (n >= 100000 && n <= 999999) {
        const value = (n / 1000).toFixed(0);
        return `${value}k`;
      } else if (n >= 1000000 && n <= 9999999) {
        const value = (n / 1000000).toFixed(2);
        return `${value}M`;
      } else if (n >= 10000000 && n <= 99999999) {
        const value = (n / 1000000).toFixed(1);
        return `${value}M`;
      } else if (n >= 100000000 && n <= 999999999) {
        const value = (n / 1000000).toFixed(0);
        return `${value}M`;
      } else if (n >= 1000000000) {
        return "1B+";
      }
      else {
        return 0;
      }
    }

    parseToNumber = num_str => {
      // Try parsing the string to an integer
      const num = parseInt(num_str);

      // Check if parsing was successful
      if (!isNaN(num)) {
        return num;
      } else {
        return 0;
      }
    }

    getTemplate = () => {
      // Show HTML Here
      return `
      ${this.getBody()}
      ${this.getStyles()}
    `;
    }

    getBody = () => {
      const mql = window.matchMedia('(max-width: 660px)');
      if (mql.matches) {
        return /* html */`
        ${this.getTop()}
        ${this.getAuthor()}
        ${this.getHeader()}
        ${this.getSection()}
      `;
      }
      else {
        return /* html */`
        <section class="main">
          ${this.getTop()}
          ${this.getHeader()}
          ${this.getSection()}
        </section>

        <section class="side">
          ${this.getAuthor()}
          <topics-container url="/api/v1/q/trending/topics"></topics-container>
          ${this.getInfo()}
        </section>
      `;
      }
    }

    getStories = () => {
      return `
      <stories-feed stories="all" url="/U0A89BA6/stories"></stories-feed>
    `
    }

    getHeader = () => {
      let str = this.getAttribute('name');
      // Replace all - with space 
      str = str.replace(/-/g, ' ');

      // capitalize the first letter of the string
      str = str.charAt(0).toUpperCase() + str.slice(1);
      return /*html*/`
      <div class="head">
        <div class="text-content">
          <div class="topic-head">
            <div class="topic">
              <h2> ${str} </h2>
              <p class="info">Discover, read, and contribute to the topic.</p>
            </div>
            ${this.getStats()}
          </div>
          ${this.getActions()}
        </div>
      </div>
    `
    }

    parseContent = content => {
      // Remove all HTML tags
      const noHtmlContent = content.replace(/<\/?[^>]+(>|$)/g, "");
    
      // Split the content by the next line
      const lines = noHtmlContent.split('\n');
    
      // Create a paragraph for each line
      return lines.map(line => `<p>${line}</p>`).join('');
    }

    parseHTML = text => {
      // Create a temporary element to help with parsing
      const tempElement = document.createElement('div');
      
      // Check if the text is encoded (contains &lt; or &gt;)
      if (text.includes('&lt;') || text.includes('&gt;')) {
        // Create a textarea element to decode the HTML entities
        const textarea = document.createElement('textarea');
        textarea.innerHTML = text;
        tempElement.innerHTML = textarea.value;
      } else {
          // Directly set the innerHTML for plain HTML
        tempElement.innerHTML = text;
      }
      
      // Return the parsed HTML
      return tempElement.innerHTML;
    }

    getTop = () => {
      //get url from the attribute
      let url = this.getAttribute('url');
      // trim and convert to lowercase
      url = url.trim().toLowerCase();
      return /* html */ `
      <header-wrapper section="Topic" type="topic" url="${url}"></header-wrapper>
    `
    }

    getInfo = () => {
      return /*html*/`
      <info-container docs="/about/docs" new="/about/new"
       feedback="/about/feedback" request="/about/request" code="/about/code" donate="/about/donate" contact="/about/contact" company="https://github.com/aduki-hub">
      </info-container>
    `
    }

    getArticle = () => {
      return /* html */`
      <article class="article">
       ${this.parseHTML(this.innerHTML)}
      </article>
    `
    }

    getSection = () => {
      return /* html */`
      <topic-section hash="${this.getAttribute('hash')}" url="${this.getAttribute('url')}" active="${this.getAttribute('tab')}"
        slug="${this.getAttribute('slug')}" stories="${this.getAttribute('stories')}" page="1"
        stories-url="${this.getAttribute('stories-url')}">
        ${this.getArticle()}
      </topic-section>
    `
    }

    getStats = () => {
      // Get followers
      let followers = this.parseToNumber(this.getAttribute('followers'));

      const followersText = followers === 1 ? 'follower' : 'followers';

      // Get stories
      let stories = this.parseToNumber(this.getAttribute('stories'));

      const storiesText = stories === 1 ? 'story' : 'stories';

      // Format the number
      let formattedStories = this.formatNumber(stories);
      let formattedFollowers = this.formatNumber(followers);

      return /*html*/`
      <div class="stats">
        <span class="followers followers-stat">
          <span class="no">${formattedFollowers}</span>
          <span class="text">${followersText}</span>
        </span>
        <span class="sp">•</span>
        <span class="stories">
          <span class="no">${formattedStories}</span>
          <span class="text">${storiesText}</span>
        </span>
      </div>
    `
    }

    getAuthor = () => {
      let bio = this.getAttribute('author-bio') || 'This author has not provided a bio yet.';
      // replace all " and ' with &quot; and &apos; to avoid breaking the html
      bio = bio.replace(/"/g, '&quot;').replace(/'/g, '&apos;');
      return /* html */`
			<author-wrapper you="${this.getAttribute('author-you')}" hash="${this.getAttribute('author-hash')}" picture="${this.getAttribute('author-img')}" name="${this.getAttribute('author-name')}"
        stories="${this.getAttribute('author-stories')}" replies="${this.getAttribute('author-replies')}" contact='${this.getAttribute("author-contact")}'
        followers="${this.getAttribute('author-followers')}" following="${this.getAttribute('author-following')}" user-follow="${this.getAttribute('author-follow')}"
        verified="${this.getAttribute('author-verified')}" url="/u/${this.getAttribute('author-hash').toLowerCase()}"
        bio="${bio}">
      </author-wrapper>
		`
    }

    getActions = () => {
      // Get url
      let url = this.getAttribute('url');

      // trim the url and convert to lowercase
      url = url.trim().toLowerCase();
      return /* html */`
      <div class="actions">
        <span class="action stats" id="stats-action">stats</span>
        ${this.checkFollow(this.getAttribute('topic-follow'))}
        ${this.checkSubscribed(this.getAttribute('subscribed'))}
      </div>
    `
    }

    checkFollow = following => {
      if (following === 'true') {
        return /*html*/`
			  <span class="action following" id="follow-action">following</span>
			`
      }
      else {
        return /*html*/`
			  <span class="action follow" id="follow-action">follow</span>
			`
      }
    }

    checkSubscribed = subscribed => {
      if (subscribed === 'true') {
        return /*html*/`
			  <span class="action subscribed" id="subscribe-action">subscribed</span>
			`
      }
      else {
        return /*html*/`
			  <span class="action subscribe" id="subscribe-action">subscribe</span>
			`
      }
    }

    getHighlights = () => {
      return /* html */`
      <topic-popup url="/api/v1/t/${this.getAttribute('hash').toLowerCase()}/stats" name="${this.getAttribute('name')}" views="${this.getAttribute('views')}"
        followers="${this.getAttribute('followers')}" subscribers="${this.getAttribute('subscribers')}" 
        stories="${this.getAttribute('stories')}">
      </topic-popup>
    `
    }

    getStyles() {
      return /* css */`
	    <style>
	      *,
	      *:after,
	      *:before {
	        box-sizing: border-box !important;
	        font-family: inherit;
	        -webkit-box-sizing: border-box !important;
	      }

	      *:focus {
	        outline: inherit !important;
	      }

	      *::-webkit-scrollbar {
	        width: 3px;
	      }

	      *::-webkit-scrollbar-track {
	        background: var(--scroll-bar-background);
	      }

	      *::-webkit-scrollbar-thumb {
	        width: 3px;
	        background: var(--scroll-bar-linear);
	        border-radius: 50px;
	      }

	      h1,
	      h2,
	      h3,
	      h4,
	      h5,
	      h6 {
	        padding: 0;
	        margin: 0;
	        font-family: inherit;
	      }

	      p,
	      ul,
	      ol {
	        padding: 0;
	        margin: 0;
	      }

	      a {
	        text-decoration: none;
	      }

	      :host {
          font-size: 16px;
          padding: 0;
          margin: 0;
          display: flex;
          justify-content: space-between;
          gap: 30px;
        }

        section.main {
          display: flex;
          flex-flow: column;
          align-items: start;
          gap: 0;
          width: 63%;
          min-height: 100vh
        }

        .head {
          display: flex;
          flex-flow: column;
          gap: 0;
          padding: 0;
          width: 100%;
        }

        .text-content {
          display: flex;
          flex-flow: column;
          gap: 15px;
          color: var(--title-color);
        }

        .text-content > .topic-head {
          display: flex;
          flex-flow: column;
          gap: 8px;
        }

        .text-content > .topic-head .topic {
          display: flex;
          flex-flow: column;
          gap: 0;
        }

        .text-content > .topic-head .topic > h2 {
          font-size: 1.4rem;
          font-weight: 600;
          font-family: var(--font-main), sans-serif;
          margin: 0;
          color: var(--title-color);
        }

        .text-content > .topic-head .topic > p.info {
          margin: 0;
          font-size: 0.8rem;
          font-weight: 500;
          font-family: var(--font-text), sans-serif;
          margin: 0;
          color: var(--gray-color);
        }

        .stats {
          padding: 0;
          display: flex;
          align-items: center;
          gap: 5px;
          font-weight: 400;
          color: var(--gray-color);
          font-family: var(--font-mono), monospace;
          font-size: 1rem;
        }

        .stats .sp {
          font-family: var(--font-main), sans-serif;
          font-size: 1rem;
          margin: -2px 0 0 0;
        }

        .stats > span {
          display: flex;
          font-weight: 400;
          align-items: center;
          gap: 3px;
        }

        .stats > span > .text {
          font-family: var(--font-main), sans-serif;
          font-size: 0.9rem;
          font-weight: 400;
          display: flex;
          align-items: center;
          gap: 4px;
        }

        .stats > span >  .no {
          font-weight: 500;
          color: var(--text-color);
          font-family: var(--font-main), sans-serif;
          font-size: 0.9rem;
        }

        .text-content > .sub-text {
          margin: 8px 0 15px;
          font-size: 1rem;
          color: var(--text-color);
          line-height: 1.3;
          font-family: var(--font-main);
          display: flex;
          flex-flow: column;
          gap: 8px;
        }

        .text-content > .actions {
          width: 100%;
          display: flex;
          flex-flow: row;
          gap: 20px;
          padding: 3px 0 10px 0;
          margin: 0;
        }

        .text-content > .actions > .action {
          text-decoration: none;
          padding: 2px 10px 3px 10px;
          font-weight: 400;
          background: var(--accent-linear);
          color: var(--white-color);
          font-family: var(--font-main), sans-serif;
          cursor: pointer;
          text-transform: lowercase;
          width: max-content;
          font-size: 0.89rem;
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 10px;
          border-radius: 10px;
        }

        .text-content > .actions > .action.stats {
          background: var(--second-linear);
        }

        .text-content > .actions > .action.edit,
        .text-content > .actions > .action.following,
        .text-content > .actions > .action.subscribed {
          padding: 2px 10px 3px 10px;
          font-weight: 400;
          background: unset;
          border: var(--action-border);
          color: var(--gray-color);
        }

        div.content-container {
          margin: 0;
          padding: 0;
          display: flex;
          flex-flow: column;
          align-items: start;
          flex-wrap: nowrap;
          gap: 15px;
          width: 100%;
        }

        section.side {
          padding: 25px 0;
          width: 33%;
          display: flex;
          flex-flow: column;
          gap: 20px;
          position: sticky;
          top: 0;
          height: 100vh;
          max-height: 100vh;
          overflow-y: scroll;
          scrollbar-width: none;
        }

        section.side::-webkit-scrollbar {
          visibility: hidden;
          display: none;
        }

        @media screen and (max-width:900px) {
          section.main {
            width: 58%;
          }

          section.side {
            width: 40%;
          }
        }

				@media screen and (max-width:660px) {
					:host {
            font-size: 16px;
						padding: 0;
            margin: 0;
            display: flex;
            flex-flow: column;
            justify-content: space-between;
            gap: 0;
					}

          
          .text-content > .topic-head {
            padding: 15px 0 0 0;
          }

          .text-content > .actions {
            border-bottom: none;
          }

					.action,
					a {
						cursor: default !important;
          }

          .section.main {
            display: flex;
            flex-flow: column;
            gap: 0;
            width: 100%;
          }

          section.side {
            padding: 0;
            display: none;
            width: 0%;
          }
				}
	    </style>
    `;
    }
  }

  class AppUser extends HTMLElement {
    constructor() {
      // We are not even going to touch this.
      super();

      this.setTitle();

      this.boundHandleWsMessage = this.handleWsMessage.bind(this);
      this.checkAndAddHandler = this.checkAndAddHandler.bind(this);

      this._open = this.setOpen(this.getAttribute('current'));

      this._current = this.getAttribute('current') || 'stats';

      // let's create our shadow root
      this.shadowObj = this.attachShadow({ mode: "open" });

      this.render();
    }

    setTitle = () => {
      // update title of the document
      document.title = 'Account - Manage your account settings, and view your stats';
    }

    render() {
      this.shadowObj.innerHTML = this.getTemplate();
    }

    setOpen = current => {
      if(current === '' || current === null || !current) {
        return true;
      }

      return false;
    }

    connectedCallback() {
      this.enableScroll();
      // Add this component handler to the window wss object
      this.checkAndAddHandler();

      // request user to enable notifications
      this.checkNotificationPermission();

      // Check if the display is greater than 600px using mql
      const mql = window.matchMedia('(max-width: 660px)');

      // update the current tab
      this.updateCurrent(this._current);

      const tabContainer = this.shadowObj.querySelector('section.tab');
      const contentContainer = this.shadowObj.querySelector('div.content-container');

      // get url
      let url = this.getAttribute('user-url');

      url = url.trim().toLowerCase();

      // Get the body
      const body = document.querySelector('body');

      // select the button
      const btn = this.shadowObj.querySelector('section.tab > div.header > svg');

      // select the header-wrapper
      const headerWrapper = this.shadowObj.querySelector('header-wrapper');

      // Watch for media query changes
      this.watchMediaQuery(mql);

      // get tab where class is this._current
      const currentTab = tabContainer.querySelector(`li.${this._current}`);

      if (currentTab && headerWrapper && tabContainer && contentContainer && btn) {
        // Update the header-wrapper section attribute
        this.updateCurrentText(currentTab, headerWrapper);

        // Activate the tab
        this.activateTab(mql.matches, headerWrapper, tabContainer, contentContainer);

        // activate the button
        this.activateBtn(mql.matches, contentContainer, tabContainer, btn);

        // populate the current contents
        this.populateCurrent(tabContainer, contentContainer);

        this.activateCloseTabs(mql.matches, btn, contentContainer, tabContainer);
      }

      if (url && body) {
        // Open user profile
        this.handleUserClick(url, body);
      }
    }

    checkNotificationPermission = async () => {
      if(window.notify && !window.notify.permission) {
        await window.notify.requestPermission();
      }
    }

    activateThemeIcons = () => {
      const btns = this.shadowObj.querySelectorAll('div.themes > .themes-container > .theme > button');
      if (btns) {
        // select the other btn and remove activated class
        btns.forEach(btn => {
          btn.addEventListener('click', event => {
            event.preventDefault();
            const currentTheme = btn.getAttribute('name');
            this.setTheme(currentTheme);
    
            // select the other btn and remove activated class
            btns.forEach(btnInner => {
              btnInner.classList.remove('activated');
              btnInner.textContent = 'Activate';
            });
    
            // update 
            btn.classList.toggle('activated');
            btn.textContent = 'Activated';
          });
        });
      }
    }

    setTheme = currentTheme =>{
      // Check the current theme
      const htmlElement = document.documentElement;
      const metaThemeColor = document.querySelector("meta[name=theme-color]");

      // Check if the current theme is: system
      if (currentTheme === 'system') {
        // Get the system theme
        currentTheme = this.getSystemTheme();

        // Update the data-theme attribute
        htmlElement.setAttribute('data-theme', currentTheme);

        // Store the preference in local storage
        localStorage.setItem('theme', 'system');

        // Update the theme-color meta tag
        metaThemeColor.setAttribute("content", currentTheme === 'dark' ? '#000000' : '#ffffff');
        return;
      }
      
      // Update the data-theme attribute
      htmlElement.setAttribute('data-theme', currentTheme);
      
      // Store the preference in local storage
      localStorage.setItem('theme', currentTheme);

      // Update the theme-color meta tag
      metaThemeColor.setAttribute("content", currentTheme === 'dark' ? '#000000' : '#ffffff');
    }

    getSystemTheme = () => {
      return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
    }

    logout = async () => {
      // unsubscribe from push notifications
      try {
        await this.handleUserLogout();
      } catch (error) {
        console.error('Error unsubscribing from push notifications', error);
      }

      // remove theme from local storage
      localStorage.removeItem('theme');

      // destroy the current user-cache
      const userCache  = 'user-cache';

      // delete cache: user-cache
      await caches.delete(userCache);

      // remove the user  from the window object
      window.hash = null;

      // redirect to home page
      window.location.href = '/logout';
    }

    // Assuming you have a service worker registered and the user is logged out
    handleUserLogout = async () => {
      // Check if the service worker is registered
      if ('serviceWorker' in navigator) {
        const registration = await navigator.serviceWorker.getRegistration();

        if (registration) {
          // Check for existing push subscription
          const subscription = await registration.pushManager.getSubscription();

          if (subscription) {
            // Unsubscribe from push notifications
            const successfulUnsubscribe = await subscription.unsubscribe();

            if (successfulUnsubscribe) {
              console.log('Successfully unsubscribed from push notifications.');
              // Optionally, remove the subscription from your server
              await this.removeSubscriptionFromServer();
            } else {
              console.error('Failed to unsubscribe from push notifications.');
            }
          } else {
            console.log('No existing subscription found.');
          }
        } else {
          console.log('Service worker not registered.');
        }
      } else {
        console.log('Service workers are not supported in this browser.');
      }
    }

    removeSubscriptionFromServer = async () => {
      // Remove the subscription from the server
      await fetch('/api/v1/push/unsubscribe', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        }
      })
      .then(response => {
        const result = response.json();
        console.log('Subscription removed from server:', result);
      })
      .catch(error => {console.error('Error removing subscription from server:', error);});
    }

    checkAndAddHandler() {
      if (window.wss) {
        window.wss.addMessageHandler(this.boundHandleWsMessage);
        console.log('WebSocket handler added successfully');
      } else {
        console.log('WebSocket manager not available, retrying...');
        setTimeout(this.checkAndAddHandler, 500); // Retry after 500ms
      }
    }

    disconnectedCallback() {
      this.enableScroll();
      if (window.wss) {
        window.wss.removeMessageHandler(this.boundHandleWsMessage);
      }
    }

    handleWsMessage = message => {
      // Handle the message in this component
      // console.log('Message received in component:', data);
      if (message.type !== 'action') return;
    }

    sendWsMessage(data) {
      window.wss.sendMessage(data);
    }

    // Open user profile
    handleUserClick = (url, body) => {
      const outerThis = this;
      // get a.meta.link
      const content = this.shadowObj.querySelector('section.tab > div.header > .name > a.username');

      // Get full post
      const profile =  this.getProfile();

      if(body && content) { 
        content.addEventListener('click', event => {
          event.preventDefault();
          
          // replace and push states
          outerThis.replaceAndPushStates(url, body, profile);

          body.innerHTML = profile;
        });
      }
    }

    replaceAndPushStates = (url, body, profile) => {
      // get the first custom element in the body
      const firstElement = body.firstElementChild;

      // convert the custom element to a string
      const elementString = firstElement.outerHTML;
    
      // get window location
      const pageUrl = window.location.href;
      window.history.replaceState(
        { page: 'page', content: elementString },
        url, pageUrl
      );

      // Updating History State
      window.history.pushState(
        { page: 'page', content: profile},
        url, url
      );
    }

    activateBtn = (mql, contentContainer, tabContainer, btn) => {
      // select all tabs
      const tabs = tabContainer.querySelectorAll('ul.tab');

      if(!btn || !tabs) return;

      // add event listener to button
      btn.addEventListener('click', () => {
          
        // check for mobile view
        if (mql) {
          // open tabs
          this.openCloseTabs(tabs, btn, contentContainer, tabContainer);
        }
        else {
          // go back in history if history is available or go to home
          window.history.back();
        }
      });
    }

    activateCloseTabs = (mql, btn, contentContainer, tabContainer) => {
      const tabs = tabContainer.querySelectorAll('ul.tab');
      // Check if open is true
      if (mql && this._open) {
        // add gap to the tab container
        tabContainer.style.setProperty('gap', '10px');

        tabs.forEach(tab => {
          // set max-height to max-content
          tab.style.setProperty('max-height', 'max-content');
        });

        // display content container to none
        contentContainer.style.setProperty('display', 'none');

        // rotate the button
        btn.style.setProperty('transform', 'rotate(180deg)');

        // Update open to true
        this._open = true;
      }
    }

    openCloseTabs = (tabs, btn, contentContainer, tabContainer) => {
      // Check if open is true
      if (this._open) {
        // add gap to the tab container
        tabContainer.style.setProperty('gap', '0');

        // close all tabs
        tabs.forEach(tab => {
          // set max-height to zero
          tab.style.setProperty('max-height', '0');
        });

        // display content container to flex
        contentContainer.style.setProperty('display', 'flex');

        // rotate the button
        btn.style.setProperty('transform', 'rotate(0deg)');

        // Update open to false
        this._open = false;
      }
      else {
        // add gap to the tab container
        tabContainer.style.setProperty('gap', '10px');

        tabs.forEach(tab => {
          // set max-height to max-content
          tab.style.setProperty('max-height', 'max-content');
        });

        // display content container to none
        contentContainer.style.setProperty('display', 'none');

        // rotate the button
        btn.style.setProperty('transform', 'rotate(180deg)');

        // Update open to true
        this._open = true;
      }
    }

    updateCurrent = current => {
      // select current tab
      const tab = this.shadowObj.querySelector(`section.tab li.${current}`);

      // if tab is available
      if (tab) {
        // add active class to tab
        tab.classList.add('active');
      }
    }

    activateTab = (mql, headerWrapper, tabContainer, contentContainer) => {
      const outerThis = this;

      // select all tab
      const tabSections = tabContainer.querySelectorAll('ul.tab');

      // select btn 
      let btn = tabContainer.querySelector('div.header > svg');

      const tabItems = tabContainer.querySelectorAll('li.tab-item');
      let activeTab = tabContainer.querySelector('li.tab-item.active');

      tabItems.forEach(tab => {
        tab.addEventListener('click', e => {
          e.preventDefault();
          e.stopPropagation();

          // stop immediate propagation
          e.stopImmediatePropagation();

          // Check for mobile view
          if (mql) {
            // Open all tabs
            outerThis.openCloseTabs(tabSections, btn, contentContainer, tabContainer);
          }

          if (tab.dataset.name !== activeTab.dataset.name) {
            activeTab.classList.remove('active');

            // Update current attribute
            this.setAttribute('current', tab.dataset.name);

            // update current text
            this.updateCurrentText(tab, headerWrapper);

            // Add loader
            contentContainer.innerHTML = this.getLoader();

            tab.classList.add('active');
            activeTab = tab;

            // Change content
            this.changeContent(tab, contentContainer);
          }
        });
      });

      // Update state on window.onpopstate
      window.onpopstate = event => {
        // This event will be triggered when the browser's back button is clicked

        // Check if event state is available
        if (event.state) {
          if (event.state.popup) {
            return;
          }
          
          if (event.state.page) {
            outerThis.updatePage(event.state.content);
          }
          else if (event.state.tab) {
            // Select the state tab
            const tab = tabContainer.querySelector(`li.${event.state.tab}`);

            if (tab) {
              activeTab.classList.remove('active');

              //Update status
              this._status = false;

              // Update current attribute
              this.setAttribute('current', tab.dataset.name);

              // Update current text
              this.updateCurrentText(tab, headerWrapper);

              tab.classList.add('active');
              activeTab = tab;

              // Remove any child elements of the content container which is not section
              const children = Array.from(contentContainer.children);
              if (children) {
                children.forEach(child => {
                  if (!child.classList.contains('remains')) {
                    child.remove();
                  }
                });
              }

              outerThis.updateState(event.state, contentContainer);
            }
          }
        }
        else {
          // Select li with class name as current and content Container
          const currentTab = tabContainer.querySelector(`section.tab li.${outerThis._current}`);
          if (currentTab) {
            activeTab.classList.remove('active');

            // Update status
            activeTab = currentTab;
            currentTab.classList.add('active');

            //update current text
            outerThis.updateCurrentText(currentTab, headerWrapper);

            outerThis.populateContent(outerThis._current, contentContainer);
          }
        }
      };
    }

    updatePage = content => {
      // select body
      const body = document.querySelector('body');

      // populate content
      body.innerHTML = content;
    }

    updateState = (state, contentContainer)=> {
      // populate content
      this.populateContent(state.tab, contentContainer);
    }

    watchMediaQuery = mql => {
      const outerThis = this;
      mql.addEventListener('change', () => {
        // select the button
      
        outerThis.render();

        // update the current tab
        outerThis.updateCurrent(outerThis._current);

        const btn = outerThis.shadowObj.querySelector('section.tab > div.header > svg');
        const tabContainer = outerThis.shadowObj.querySelector('section.tab');
        const contentContainer = outerThis.shadowObj.querySelector('div.content-container');

        // Populate the current contents
        outerThis.populateCurrent(tabContainer, contentContainer);

        // Activate the tab
        outerThis.activateTab(mql.matches, tabContainer, contentContainer);

        // activate the button
        this.activateBtn(mql.matches, contentContainer, tabContainer, btn);
      });
    }

    updateCurrentText = (tab, headerWrapper) => {
      // Get the span.text from tab
      const text = tab.querySelector('span.text');

      // change section attribute of header-wrapper
      headerWrapper.setAttribute('section', text.textContent);
    }

    disableScroll() {
      // Get the current page scroll position
      let scrollTop = window.scrollY || document.documentElement.scrollTop;
      let scrollLeft = window.scrollX || document.documentElement.scrollLeft;
      document.body.classList.add("stop-scrolling");

      // if any scroll is attempted, set this to the previous value
      window.onscroll = function () {
        window.scrollTo(scrollLeft, scrollTop);
      };
    }

    enableScroll() {
      document.body.classList.remove("stop-scrolling");
      window.onscroll = function () { };
    }

    changeContent = (tab, contentContainer) =>  {
      const outerThis = this;

      // Select loader
      const loader = this.shadowObj.querySelector('#loader-container');

      setTimeout(() => {
        if (loader) {
          loader.remove();
        }

        // Populate Content
        outerThis.populateContent(tab.dataset.name, contentContainer);

        // Updating History State
        window.history.pushState(
          { tab: tab.dataset.name },
          tab.dataset.name, `${tab.getAttribute('url')}`
        );
      }, 300);
    }

    populateCurrent = (tabContainer, contentContainer) =>  {
      const outerThis = this;

      // Select li with class name as current and content Container
      const currentItem = tabContainer.querySelector(`li.${this._current}`);

      // If selection is available
      if(currentItem) {
        currentItem.classList.add('active');

        // Select loader
        const loader = this.shadowObj.querySelector('#loader-container');

        // Set timeout to remove loader
        setTimeout(() => {
          if(loader) {
            loader.remove();
          }

          // Populate Content
          outerThis.populateContent(outerThis._current, contentContainer);
        }, 100);
      }
    }

    populateContent = (name, contentContainer) => {
      if (name === 'stats') {
        contentContainer.innerHTML = this.getStats();
      } else if (name === 'name') {
        contentContainer.innerHTML = this.getFormName();
      } else if (name === 'bio') {
        contentContainer.innerHTML = this.getFormBio();
      } else if (name === 'picture') {
        contentContainer.innerHTML = this.getFormProfile();
      } else if (name === 'socials') {
        contentContainer.innerHTML = this.getFormSocial();
      } else if (name === 'email') {
        contentContainer.innerHTML = this.getFormEmail();
      } else if (name === 'privacy') {
        contentContainer.innerHTML = this.getSoon();
      } else if (name === 'password') {
        contentContainer.innerHTML = this.getFormPassword();
      } else if (name === 'topics') {
        contentContainer.innerHTML = this.getSoon();
      } else if (name === 'activity') {
        contentContainer.innerHTML = this.getActivity();
      } else if (name === 'updates') {
        contentContainer.innerHTML = this.getUpdates();
      } else if (name === 'typography') {
        contentContainer.innerHTML = this.getSoon();
      } else if (name === 'theme') {
        contentContainer.innerHTML = this.getThemes();
        this.activateThemeIcons();
      } else if (name === 'content') {
        contentContainer.innerHTML = this.getContent();
      } else if (name === 'logout') {
        this.logout();
      }
      else {
        contentContainer.innerHTML = this.getStats();
      }
    }

    getDate = (isoTimeString) => {
      const currentDate = new Date();
      const targetDate = new Date(isoTimeString);

      const diffYears = currentDate.getFullYear() - targetDate.getFullYear();
      const diffMonths = currentDate.getMonth() - targetDate.getMonth();

      let formattedString = "Since ";

      // Build the formatted string based on the time difference
      if (diffYears > 0 || diffMonths >= 12) {
        formattedString += targetDate.toLocaleDateString(undefined, {
          month: 'short',
          year: 'numeric'
        });
      } else if (diffMonths > 0) {
        formattedString += targetDate.toLocaleDateString(undefined, {
          month: 'short',
          year: 'numeric'
        });
      } else {
        formattedString += "Now";
      }

      return formattedString;
    }

    getLoader() {
      return `
      <div id="loader-container">
				<div class="loader"></div>
			</div>
    `
    }

    getTemplate = () => {
      // Show HTML Here
      return `
      ${this.getBody()}
      ${this.getStyles()}
    `;
    }

    getBody = () => {
      const mql = window.matchMedia('(max-width: 660px)');
      if (mql.matches) {
        return /* html */`
        <main class="profile">
          ${this.getTop()}
          <section class="content">
            ${this.getTab()}
            <div class="content-container">
              ${this.getLoader()}
            </div>
          </section>
        </main>
      `;
      }
      else {
        return /* html */`
        <main class="profile">
          ${this.getTab()}
          <section class="content">
            ${this.getTop()}
            <div class="content-container">
              ${this.getLoader()}
            </div>
          </section>
        </main>
      `;
      }
    }

    checkVerified = verified => {
      if (verified === 'true') {
        return /*html*/`
        <svg width="26" height="26" viewBox="0 0 26 26" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M16.3592 1.41412C15.9218 0.966482 15.3993 0.610789 14.8224 0.367944C14.2455 0.125098 13.6259 0 13 0C12.3741 0 11.7545 0.125098 11.1776 0.367944C10.6007 0.610789 10.0782 0.966482 9.64079 1.41412L8.62993 2.45091L7.18354 2.43304C6.55745 2.42563 5.93619 2.54347 5.35631 2.77964C4.77642 3.01581 4.24962 3.36554 3.80687 3.80826C3.36413 4.25098 3.01438 4.77775 2.77819 5.3576C2.542 5.93744 2.42415 6.55866 2.43156 7.18472L2.44781 8.63102L1.41421 9.64181C0.966543 10.0792 0.610827 10.6017 0.367967 11.1785C0.125106 11.7554 0 12.3749 0 13.0008C0 13.6267 0.125106 14.2462 0.367967 14.8231C0.610827 15.3999 0.966543 15.9224 1.41421 16.3598L2.44944 17.3706L2.43156 18.8169C2.42415 19.443 2.542 20.0642 2.77819 20.644C3.01438 21.2239 3.36413 21.7506 3.80687 22.1934C4.24962 22.6361 4.77642 22.9858 5.35631 23.222C5.93619 23.4582 6.55745 23.576 7.18354 23.5686L8.62993 23.5523L9.64079 24.5859C10.0782 25.0335 10.6007 25.3892 11.1776 25.6321C11.7545 25.8749 12.3741 26 13 26C13.6259 26 14.2455 25.8749 14.8224 25.6321C15.3993 25.3892 15.9218 25.0335 16.3592 24.5859L17.3701 23.5507L18.8165 23.5686C19.4426 23.576 20.0638 23.4582 20.6437 23.222C21.2236 22.9858 21.7504 22.6361 22.1931 22.1934C22.6359 21.7506 22.9856 21.2239 23.2218 20.644C23.458 20.0642 23.5758 19.443 23.5684 18.8169L23.5522 17.3706L24.5858 16.3598C25.0335 15.9224 25.3892 15.3999 25.632 14.8231C25.8749 14.2462 26 13.6267 26 13.0008C26 12.3749 25.8749 11.7554 25.632 11.1785C25.3892 10.6017 25.0335 10.0792 24.5858 9.64181L23.5506 8.63102L23.5684 7.18472C23.5758 6.55866 23.458 5.93744 23.2218 5.3576C22.9856 4.77775 22.6359 4.25098 22.1931 3.80826C21.7504 3.36554 21.2236 3.01581 20.6437 2.77964C20.0638 2.54347 19.4426 2.42563 18.8165 2.43304L17.3701 2.44929L16.3592 1.41412Z" 
            fill="currentColor" id="top"/>
          <path d="M15.3256 4.97901C15.0228 4.6691 14.661 4.42285 14.2616 4.25473C13.8623 4.08661 13.4333 4 13 4C12.5667 4 12.1377 4.08661 11.7384 4.25473C11.339 4.42285 10.9772 4.6691 10.6744 4.97901L9.97457 5.69678L8.97322 5.68441C8.53977 5.67928 8.10967 5.76086 7.70821 5.92437C7.30675 6.08787 6.94204 6.32999 6.63553 6.63649C6.32901 6.94298 6.08688 7.30767 5.92336 7.70911C5.75985 8.11054 5.67826 8.54061 5.68339 8.97403L5.69464 9.97532L4.97907 10.6751C4.66914 10.9779 4.42288 11.3396 4.25475 11.739C4.08661 12.1383 4 12.5673 4 13.0006C4 13.4339 4.08661 13.8628 4.25475 14.2621C4.42288 14.6615 4.66914 15.0232 4.97907 15.326L5.69577 16.0258L5.68339 17.0271C5.67826 17.4605 5.75985 17.8906 5.92336 18.292C6.08688 18.6935 6.32901 19.0581 6.63553 19.3646C6.94204 19.6711 7.30675 19.9133 7.70821 20.0768C8.10967 20.2403 8.53977 20.3218 8.97322 20.3167L9.97457 
            20.3055L10.6744 21.021C10.9772 21.3309 11.339 21.5771 11.7384 21.7453C12.1377 21.9134 12.5667 22 13 22C13.4333 22 13.8623 21.9134 14.2616 21.7453C14.661 21.5771 15.0228 21.3309 15.3256 21.021L16.0254 20.3043L17.0268 20.3167C17.4602 20.3218 17.8903 20.2403 18.2918 20.0768C18.6932 19.9133 19.058 19.6711 19.3645 19.3646C19.671 19.0581 19.9131 18.6935 20.0766 18.292C20.2402 17.8906 20.3217 17.4605 20.3166 17.0271L20.3054 16.0258L21.0209 15.326C21.3309 15.0232 21.5771 14.6615 21.7453 14.2621C21.9134 13.8628 22 13.4339 22 13.0006C22 12.5673 21.9134 12.1383 21.7453 11.739C21.5771 11.3396 21.3309 10.9779 21.0209 10.6751L20.3042 9.97532L20.3166 8.97403C20.3217 8.54061 20.2402 8.11054 20.0766 7.70911C19.9131 7.30767 19.671 6.94298 19.3645 6.63649C19.058 6.32999 18.6932 6.08787 18.2918 5.92437C17.8903 5.76086 17.4602 5.67928 17.0268 5.68441L16.0254 5.69566L15.3256 4.97901ZM15.6485 11.7113L12.2732 15.0864C12.2209 15.1388 12.1588 15.1803 12.0905 15.2087C12.0222 15.2371 11.9489 15.2517 11.8749 15.2517C11.8009 15.2517 11.7276 15.2371 11.6593 15.2087C11.5909 15.1803 11.5289 15.1388 11.4766 15.0864L9.78893 13.3988C9.73662 13.3465 9.69513 13.2844 9.66683 13.2161C9.63852 13.1478 9.62395 13.0745 9.62395 13.0006C9.62395 12.9266 9.63852 12.8534 9.66683 12.785C9.69513 12.7167 9.73662 12.6546 9.78893 12.6023C9.84123 12.55 9.90333 12.5085 9.97166 12.4802C10.04 12.4519 10.1132 12.4373 10.1872 12.4373C10.2612 12.4373 10.3344 12.4519 10.4028 12.4802C10.4711 12.5085 10.5332 12.55 10.5855 12.6023L11.8749 13.8927L14.8519 10.9147C14.9576 10.8091 15.1008 10.7498 15.2502 10.7498C15.3996 10.7498 15.5429 10.8091 15.6485 10.9147C15.7542 11.0204 15.8135 11.1636 15.8135 11.313C15.8135 11.4624 15.7542 11.6056 15.6485 11.7113Z" 
            fill="currentColor" id="bottom"/>
        </svg>
			`
      }
      else {
        return ''
      }
    }

    getTop = () => {
      return /* html */ `
      <header-wrapper section="Your stats" type="user"
        user-url="${this.getAttribute('url')}" auth-url="${this.getAttribute('auth-url')}"
        url="${this.getAttribute('url')}" search-url="${this.getAttribute('search-url')}">
      </header-wrapper>
    `
    }

    getFormName = () =>  {
      // Get name and split it into first and last name if there two spaces combine the rest
      const name = this.getAttribute('user-name');
      const nameArray = name.split(' ');
      let firstName = nameArray[0];
      let lastName = nameArray[1];
      if (nameArray.length > 2) {
        for (let i = 2; i < nameArray.length; i++) {
          lastName += ` ${nameArray[i]}`;
        }
      }

      return /* html */`
      <name-form  method="PATCH" url="/user/name" api="/api/v1/u/edit/name"
        first-name="${firstName}" last-name="${lastName}">
      </name-form>
    `;
    }

    getFormBio = () =>  {
      return /* html */`
      <bio-form method="PATCH" url="/user/bio" api="/api/v1/u/edit/bio"
        bio="${this.getAttribute('user-bio')}">
      </bio-form>
    `;
    }

    getFormProfile = () =>  {
      return /* html */`
      <profile-form method="PATCH" url="/user/profile" api="/api/v1/u/edit/profile"
        profile-image="${this.getAttribute('user-img')}">
      </profile-form>
    `;
    }

    getFormSocial = () =>  {
      const socials = {
        email: this.getAttribute('user-email') || '',
        x: this.getAttribute('user-x') || '',
        threads: this.getAttribute('user-threads') || '',
        linkedin: this.getAttribute('user-linkedin') || '',
        link: this.getAttribute('user-link') || ''
      };
      return /* html */`
      <social-form method="PATCH" url="/user/socials" api="/api/v1/u/edit/contact"
        email="${socials.email}" x="${socials.x}"
        threads="${socials.threads}" linkedin="${socials.linkedin}" link="${socials.link}">
      </social-form>
    `;
    }

    getFormEmail = () =>  {
      return /* html */`
      <email-form method="PATCH" url="/user/email" api="/api/v1/u/edit/email"
        email="${this.getAttribute('email')}">
      </email-form>
    `;
    }

    getFormPassword = () =>  {
      return /* html */`
      <password-form method="PATCH" url="/user/password" api="/api/v1/u/edit/password">
      </password-form>
    `;
    }

    getActivity = () =>  {
      return /* html */`
      <activity-container url="/user/activity" api-all="/api/v1/c/all" api-users="/api/v1/c/users"
        api-stories="/api/v1/c/stories" api-replies="/api/v1/c/replies" api-topics="/api/v1/c/topics">
      </activity-container>
    `;
    }

    getStats = () =>  {
      return /* html */`
      <stat-container url="/user/stats" api="/api/v1/u/stats" stories-stats="/api/v1/user/stats/stories" replies-stats="/api/v1/user/stats/replies"></stat-container>
    `;
    }

    getContent = () =>  {
      return /* html */`
      <content-container url="/user/content" tab="stories"
        stories="/api/v1/user/content/stories" replies="/api/v1/user/content/replies">
      </content-container>
    `;
    }

    getSoon = () => {
      return /* html */`
      <div class="privacy coming-soon">
        <h3 class="title">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" fill="currentColor">
            <path
              d="M.143 2.31a.75.75 0 0 1 1.047-.167l14.5 10.5a.75.75 0 1 1-.88 1.214l-2.248-1.628C11.346 13.19 9.792 14 8 14c-1.981 0-3.67-.992-4.933-2.078C1.797 10.832.88 9.577.43 8.9a1.619 1.619 0 0 1 0-1.797c.353-.533.995-1.42 1.868-2.305L.31 3.357A.75.75 0 0 1 .143 2.31Zm1.536 5.622A.12.12 0 0 0 1.657 8c0 .021.006.045.022.068.412.621 1.242 1.75 2.366 2.717C5.175 11.758 6.527 12.5 8 12.5c1.195 0 2.31-.488 3.29-1.191L9.063 9.695A2 2 0 0 1 6.058 7.52L3.529 5.688a14.207 14.207 0 0 0-1.85 2.244ZM8 3.5c-.516 0-1.017.09-1.499.251a.75.75 0 1 1-.473-1.423A6.207 6.207 0 0 1 8 2c1.981 0 3.67.992 4.933 2.078 1.27 1.091 2.187 2.345 2.637 3.023a1.62 1.62 0 0 1 0 1.798c-.11.166-.248.365-.41.587a.75.75 0 1 1-1.21-.887c.148-.201.272-.382.371-.53a.119.119 0 0 0 0-.137c-.412-.621-1.242-1.75-2.366-2.717C10.825 4.242 9.473 3.5 8 3.5Z">
            </path>
          </svg>
          <span class="text">
            Wait, I can explain 🤭, this feature is under development
          </span>
        </h3>
        <p class="info">
          We are constantly working on improving our platform and adding new features. <br /> Our team is currently developing this feature and it will be available in the near future. <br />
          We appreciate your patience and understanding. Stay tuned for updates and exciting announcements.<br /> <br />
          Thank you for being a part of our community!
        </p>
      </div>
    `
    }

    getThemes = () =>  {
      // get theme from local storage
      const theme = localStorage.getItem('theme') || 'light';

      return /* html */`
      <div class="themes">
        <div class="top">
          <p class="desc">
            Choose a theme that suits your preference. You can switch between light and dark themes at any time.<br>
            <span>Note that in the near future, we will be adding more themes to choose from, and will also allow you to create or customize your own theme.</span>
          </p>
        </div>
        <div class="themes-container">
          ${this.getCurrentTheme(theme)}
        </div>
        <p class="soon">
          More themes will appear here once they are available. Stay tuned for updates and exciting announcements.
        </p>
      </div>
    `;
    }

    getCurrentTheme = data => {
      if (data === 'dark') {
        return /*html*/`
        <div class="theme">
          <h4 class="name">Light</h4>
          <p class="description">Light background, dark-colored text, improves readability.</p>
          <button class="btn" name="light">Activate</button>
        </div>
        <div class="theme">
          <h4 class="name">Dark</h4>
          <p class="description">Dark background, light-colored text, reduces eye strain.
          </p>
          <button class="btn activated" name="dark">Activated</button>
        </div>
        <div class="theme">
          <h4 class="name">System</h4>
          <p class="description">Set the app's theme based on your system settings.</p>
          <button class="btn" name="system">Activate</button>
        </div>
      `
      } else if (data === 'system') {
        return /*html*/`
        <div class="theme">
          <h4 class="name">Light</h4>
          <p class="description">Light background, dark-colored text, improves readability.</p>
          <button class="btn" name="light">Activate</button>
        </div>
        <div class="theme">
          <h4 class="name">Dark</h4>
          <p class="description">Dark background, light-colored text, reduces eye strain.</p>
          <button class="btn" name="dark">Activate</button>
        </div>
        <div class="theme">
          <h4 class="name">System</h4>
          <p class="description">Set the app's theme based on your system settings.</p>
          <button class="btn activated" name="system">Activated</button>
        </div>
      `
      }
      else {
        return /*html*/`
        <div class="theme">
          <h4 class="name">Light</h4>
          <p class="description">Light background, dark-colored text, improves readability.</p>
          <button class="btn activated" name="light">Activated</button>
        </div>
        <div class="theme">
          <h4 class="name">Dark</h4>
          <p class="description">Dark background, light-colored text, reduces eye strain.
          </p>
          <button class="btn" name="dark">Activate</button>
        </div>
        <div class="theme">
          <h4 class="name">System</h4>
          <p class="description">Set the app's theme based on your system settings.</p>
          <button class="btn" name="system">Activate</button>
        </div>
      `
      }
    }

    getUpdates = () => {
      return /* html */`
      <update-container url="/user/updates" api-all="/api/v1/n/all" api-users="/api/v1/n/users" notification="true"
        api-stories="/api/v1/n/stories" api-replies="/api/v1/n/replies" api-topics="/api/v1/n/topics">
      </update-container>
    `;
    }

    getTab = () =>  {
      return /* html */`
      <section class="tab remains">
        ${this.getHeader()}
        <ul class="tab public">
          <li url="/user/stats" class="tab-item stats" data-name="stats">
            <span class="line"></span>
            <a href="/user/stats" class="tab-link">
              <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16" width="16" height="16">
                <path d="M9.533.753V.752c.217 2.385 1.463 3.626 2.653 4.81C13.37 6.74 14.498 7.863 14.498 10c0 3.5-3 6-6.5 6S1.5 13.512 1.5 10c0-1.298.536-2.56 1.425-3.286.376-.308.862 0 1.035.454C4.46 8.487 5.581 8.419 6 8c.282-.282.341-.811-.003-1.5C4.34 3.187 7.035.75 8.77.146c.39-.137.726.194.763.607ZM7.998 14.5c2.832 0 5-1.98 5-4.5 0-1.463-.68-2.19-1.879-3.383l-.036-.037c-1.013-1.008-2.3-2.29-2.834-4.434-.322.256-.63.579-.864.953-.432.696-.621 1.58-.046 2.73.473.947.67 2.284-.278 3.232-.61.61-1.545.84-2.403.633a2.79 2.79 0 0 1-1.436-.874A3.198 3.198 0 0 0 3 10c0 2.53 2.164 4.5 4.998 4.5Z"></path>
              </svg>
              <span class="text">Your stats</span>
            </a>
          </li>
          <li url="/user/name" class="tab-item name" data-name="name">
            <span class="line"></span>
            <a href="/user/name" class="tab-link">
              <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 512 512" width="16px" height="16px">
                <path d="M256 48C141.1 48 48 141.1 48 256s93.1 208 208 208c13.3 0 24 10.7 24 24s-10.7 24-24 24C114.6 512 0 397.4 0 256S114.6 0 256 0S512 114.6 512 256v28c0 50.8-41.2 92-92 92c-31.1 0-58.7-15.5-75.3-39.2C322.7 360.9 291.1 376 256 376c-66.3 0-120-53.7-120-120s53.7-120 120-120c28.8 0 55.2 10.1 75.8 27c4.3-6.6 11.7-11 20.2-11c13.3 0 24 10.7 24 24v80 28c0 24.3 19.7 44 44 44s44-19.7 44-44V256c0-114.9-93.1-208-208-208zm72 208a72 72 0 1 0 -144 0 72 72 0 1 0 144 0z"/>
              </svg>
              <span class="text">Your name</span>
            </a>
          </li>
          <li url="/user/bio" class="tab-item bio" data-name="bio">
            <span class="line"></span>
            <a href="/user/bio" class="tab-link">
              <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor"  width="16px" height="16px" viewBox="0 0 512 512">
                <path d="M441.2 59.1L453.1 71c9.4 9.4 9.4 24.6 0 33.9L432 126.1 386.3 80.4l20.8-21.1c9.4-9.5 24.6-9.5 34.1-.1zM231.9 236.8L352.6 114.5 398.1 160 276.6 281.6c-3.3 3.3-7.5 5.6-12 6.5L215 298.5l10.4-49.7c.9-4.5 3.2-8.7 6.4-11.9zM373 25.5L197.7 203.1c-9.7 9.8-16.4 22.3-19.2 35.8l-18 85.7c-1.7 7.9 .8 16.2 6.5 21.9s14 8.2 21.9 6.5l85.5-17.9c13.7-2.9 26.3-9.7 36.1-19.6L487.1 138.9c28.1-28.1 28.1-73.7 0-101.8L475.1 25.2C446.9-3.1 401-2.9 373 25.5zm-48.3-7.9C302.9 11.4 279.8 8 256 8C119 8 8 119 8 256S119 504 256 504c13.3 0 24-10.7 24-24s-10.7-24-24-24C145.5 456 56 366.5 56 256S145.5 56 256 56c9.7 0 19.3 .7 28.7 2l40-40.4zM454.1 228.4c1.2 9 1.9 18.2 1.9 27.6c0 57.4-46.6 104-104 104c-13.3 0-24 10.7-24 24s10.7 24 24 24c83.9 0 152-68.1 152-152c0-23.6-3.3-46.4-9.4-68l-40.4 40.5z"/>
              </svg>
              <span class="text">Your bio</span>
            </a>
          </li>
          <li url="/user/picture" class="tab-item picture"  data-name="picture">
            <span class="line"></span>
            <a href="/user/picture" class="tab-link">
              <svg aria-hidden="true" height="16" fill="currentColor" viewBox="0 0 16 16" width="16">
                <path d="M10.561 8.073a6.005 6.005 0 0 1 3.432 5.142.75.75 0 1 1-1.498.07 4.5 4.5 0 0 0-8.99 0 .75.75 0 0 1-1.498-.07 6.004 6.004 0 0 1 3.431-5.142 3.999 3.999 0 1 1 5.123 0ZM10.5 5a2.5 2.5 0 1 0-5 0 2.5 2.5 0 0 0 5 0Z"></path>
              </svg>
              <span class="text">Your picture</span>
            </a>
          </li>
          <li url="/user/socials" class="tab-item socials" data-name="socials">
            <span class="line"></span>
            <a href="/user/socials" class="tab-link">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 640 512">
                <path d="M580.3 267.2c56.2-56.2 56.2-147.3 0-203.5C526.8 10.2 440.9 7.3 383.9 57.2l-6.1 5.4c-10 8.7-11 23.9-2.3 33.9s23.9 11 33.9 2.3l6.1-5.4c38-33.2 95.2-31.3 130.9 4.4c37.4 37.4 37.4 98.1 0 135.6L433.1 346.6c-37.4 37.4-98.2 37.4-135.6 0c-35.7-35.7-37.6-92.9-4.4-130.9l4.7-5.4c8.7-10 7.7-25.1-2.3-33.9s-25.1-7.7-33.9 2.3l-4.7 5.4c-49.8 57-46.9 142.9 6.6 196.4c56.2 56.2 147.3 56.2 203.5 0L580.3 267.2zM59.7 244.8C3.5 301 3.5 392.1 59.7 448.2c53.6 53.6 139.5 56.4 196.5 6.5l6.1-5.4c10-8.7 11-23.9 2.3-33.9s-23.9-11-33.9-2.3l-6.1 5.4c-38 33.2-95.2 31.3-130.9-4.4c-37.4-37.4-37.4-98.1 0-135.6L207 165.4c37.4-37.4 98.1-37.4 135.6 0c35.7 35.7 37.6 92.9 4.4 130.9l-5.4 6.1c-8.7 10-7.7 25.1 2.3 33.9s25.1 7.7 33.9-2.3l5.4-6.1c49.9-57 47-142.9-6.5-196.5c-56.2-56.2-147.3-56.2-203.5 0L59.7 244.8z" />
              </svg>
              <span class="text">Your socials</span>
            </a>
          </li>
          <li url="/user/theme" class="tab-item theme" data-name="theme">
            <span class="line"></span>
            <a href="/user/theme" class="tab-link">
              <svg height="16" viewBox="0 0 16 16" fill="currentColor" width="16">
                <path d="M11.134 1.535c.7-.509 1.416-.942 2.076-1.155.649-.21 1.463-.267 2.069.34.603.601.568 1.411.368 2.07-.202.668-.624 1.39-1.125 2.096-1.011 1.424-2.496 2.987-3.775 4.249-1.098 1.084-2.132 1.839-3.04 2.3a3.744 3.744 0 0 1-1.055 3.217c-.431.431-1.065.691-1.657.861-.614.177-1.294.287-1.914.357A21.151 21.151 0 0 1 .797 16H.743l.007-.75H.749L.742 16a.75.75 0 0 1-.743-.742l.743-.008-.742.007v-.054a21.25 21.25 0 0 1 .13-2.284c.067-.647.187-1.287.358-1.914.17-.591.43-1.226.86-1.657a3.746 3.746 0 0 1 3.227-1.054c.466-.893 1.225-1.907 2.314-2.982 1.271-1.255 2.833-2.75 4.245-3.777ZM1.62 13.089c-.051.464-.086.929-.104 1.395.466-.018.932-.053 1.396-.104a10.511 10.511 0 0 0 1.668-.309c.526-.151.856-.325 1.011-.48a2.25 2.25 0 1 0-3.182-3.182c-.155.155-.329.485-.48 1.01a10.515 10.515 0 0 0-.309 1.67Zm10.396-10.34c-1.224.89-2.605 2.189-3.822 3.384l1.718 1.718c1.21-1.205 2.51-2.597 3.387-3.833.47-.662.78-1.227.912-1.662.134-.444.032-.551.009-.575h-.001V1.78c-.014-.014-.113-.113-.548.027-.432.14-.995.462-1.655.942Zm-4.832 7.266-.001.001a9.859 9.859 0 0 0 1.63-1.142L7.155 7.216a9.7 9.7 0 0 0-1.161 1.607c.482.302.889.71 1.19 1.192Z"></path>
              </svg>
              <span class="text">Appearance</span>
            </a>
          </li>
        </ul>
        <ul class="tab security">
          <span class="title">Security</span>
          <li url="/user/email" class="tab-item email"  data-name="email">
            <span class="line"></span>
            <a href="/user/email" class="tab-link">
              <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" width="16px" height="16px" viewBox="0 0 512 512">
                <path d="M64 112c-8.8 0-16 7.2-16 16v22.1L220.5 291.7c20.7 17 50.4 17 71.1 0L464 150.1V128c0-8.8-7.2-16-16-16H64zM48 212.2V384c0 8.8 7.2 16 16 16H448c8.8 0 16-7.2 16-16V212.2L322 328.8c-38.4 31.5-93.7 31.5-132 0L48 212.2zM0 128C0 92.7 28.7 64 64 64H448c35.3 0 64 28.7 64 64V384c0 35.3-28.7 64-64 64H64c-35.3 0-64-28.7-64-64V128z" />
              </svg>
              <span class="text">Your email</span>
            </a>
          </li>
          <li url="/user/privacy" class="tab-item privacy" data-name="privacy">
            <span class="line"></span>
            <a href="/user/privacy" class="tab-link">
              <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" width="16px" height="16px" viewBox="0 0 512 512">
                <path
                  d="M73 127L256 49.4 439 127c5.9 2.5 9.1 7.8 9 12.8c-.4 91.4-38.4 249.3-186.3 320.1c-3.6 1.7-7.8 1.7-11.3 0C102.4 389 64.5 231.2 64 139.7c0-5 3.1-10.2 9-12.8zM457.7 82.8L269.4 2.9C265.2 1 260.7 0 256 0s-9.2 1-13.4 2.9L54.3 82.8c-22 9.3-38.4 31-38.3 57.2c.5 99.2 41.3 280.7 213.6 363.2c16.7 8 36.1 8 52.8 0C454.8 420.7 495.5 239.2 496 140c.1-26.2-16.3-47.9-38.3-57.2zM160 154.4V272c0 53 43 96 96 96s96-43 96-96V154.4c0-5.8-4.7-10.4-10.4-10.4h-.2c-3.4 0-6.5 1.6-8.5 4.3l-40 53.3c-3 4-7.8 6.4-12.8 6.4H232c-5 0-9.8-2.4-12.8-6.4l-40-53.3c-2-2.7-5.2-4.3-8.5-4.3h-.2c-5.8 0-10.4 4.7-10.4 10.4zM216 256a16 16 0 1 1 0 32 16 16 0 1 1 0-32zm64 16a16 16 0 1 1 32 0 16 16 0 1 1 -32 0z" />
              </svg>
              <span class="text">Your privacy</span>
            </a>
          </li>
          <li url="/user/password" class="tab-item password" data-name="password">
            <span class="line"></span>
            <a href="/user/password" class="tab-link">
              <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" width="16px" height="16px" viewBox="0 0 512 512">
                <path d="M73 127L256 49.4 439 127c5.9 2.5 9.1 7.8 9 12.8c-.4 91.4-38.4 249.3-186.3 320.1c-3.6 1.7-7.8 1.7-11.3 0C102.4 389 64.5 231.2 64 139.7c0-5 3.1-10.2 9-12.8zM457.7 82.8L269.4 2.9C265.2 1 260.7 0 256 0s-9.2 1-13.4 2.9L54.3 82.8c-22 9.3-38.4 31-38.3 57.2c.5 99.2 41.3 280.7 213.6 363.2c16.7 8 36.1 8 52.8 0C454.8 420.7 495.5 239.2 496 140c.1-26.2-16.3-47.9-38.3-57.2zM312 208c0-30.9-25.1-56-56-56s-56 25.1-56 56c0 22.3 13.1 41.6 32 50.6V328c0 13.3 10.7 24 24 24s24-10.7 24-24V258.6c18.9-9 32-28.3 32-50.6z" />
              </svg>
              <span class="text">Your password</span>
            </a>
          </li>
        </ul>
        <ul class="tab activity">
          <span class="title">Activity</span>
          <li url="/user/content" class="tab-item content" data-name="content">
            <span class="line"></span>
            <a href="/user/content" class="tab-link">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" fill="currentColor">
                <path d="M7.122.392a1.75 1.75 0 0 1 1.756 0l5.003 2.902c.83.481.83 1.68 0 2.162L8.878 8.358a1.75 1.75 0 0 1-1.756 0L2.119 5.456a1.251 1.251 0 0 1 0-2.162ZM8.125 1.69a.248.248 0 0 0-.25 0l-4.63 2.685 4.63 2.685a.248.248 0 0 0 .25 0l4.63-2.685ZM1.601 7.789a.75.75 0 0 1 1.025-.273l5.249 3.044a.248.248 0 0 0 .25 0l5.249-3.044a.75.75 0 0 1 .752 1.298l-5.248 3.044a1.75 1.75 0 0 1-1.756 0L1.874 8.814A.75.75 0 0 1 1.6 7.789Zm0 3.5a.75.75 0 0 1 1.025-.273l5.249 3.044a.248.248 0 0 0 .25 0l5.249-3.044a.75.75 0 0 1 .752 1.298l-5.248 3.044a1.75 1.75 0 0 1-1.756 0l-5.248-3.044a.75.75 0 0 1-.273-1.025Z"></path>
              </svg>
              <span class="text">Your content</span>
            </a>
          </li>
          <li url="/user/activity" class="tab-item activity" data-name="activity">
            <span class="line"></span>
            <a href="/user/activity" class="tab-link">
              <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16" width="16" height="16">
                <path d="M11.93 8.5a4.002 4.002 0 0 1-7.86 0H.75a.75.75 0 0 1 0-1.5h3.32a4.002 4.002 0 0 1 7.86 0h3.32a.75.75 0 0 1 0 1.5Zm-1.43-.75a2.5 2.5 0 1 0-5 0 2.5 2.5 0 0 0 5 0Z"></path>
              </svg>
              <span class="text">Your activity</span>
            </a>
          </li>
          <li url="/user/updates" class="tab-item updates" data-name="updates">
            <span class="line"></span>
            <a href="/user/updates" class="tab-link">
              <svg height="16" viewBox="0 0 16 16" fill="currentColor" width="16">
                <path d="M8 16a2 2 0 0 0 1.985-1.75c.017-.137-.097-.25-.235-.25h-3.5c-.138 0-.252.113-.235.25A2 2 0 0 0 8 16ZM3 5a5 5 0 0 1 10 0v2.947c0 .05.015.098.042.139l1.703 2.555A1.519 1.519 0 0 1 13.482 13H2.518a1.516 1.516 0 0 1-1.263-2.36l1.703-2.554A.255.255 0 0 0 3 7.947Zm5-3.5A3.5 3.5 0 0 0 4.5 5v2.947c0 .346-.102.683-.294.97l-1.703 2.556a.017.017 0 0 0-.003.01l.001.006c0 .002.002.004.004.006l.006.004.007.001h10.964l.007-.001.006-.004.004-.006.001-.007a.017.017 0 0 0-.003-.01l-1.703-2.554a1.745 1.745 0 0 1-.294-.97V5A3.5 3.5 0 0 0 8 1.5Z"></path>
              </svg>
              <span class="text">Your updates</span>
            </a>
          </li>
          <li url="/user/topics" class="tab-item topics" data-name="topics">
            <span class="line"></span>
            <a href="/user/topics" class="tab-link">
              <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16" width="16" height="16">
                <path
                  d="M0 2.75C0 1.783.784 1 1.75 1h8.5c.967 0 1.75.783 1.75 1.75v5.5A1.75 1.75 0 0 1 10.25 10H7.061l-2.574 2.573A1.457 1.457 0 0 1 2 11.543V10h-.25A1.75 1.75 0 0 1 0 8.25Zm1.75-.25a.25.25 0 0 0-.25.25v5.5c0 .138.112.25.25.25h1a.75.75 0 0 1 .75.75v2.189L6.22 8.72a.747.747 0 0 1 .53-.22h3.5a.25.25 0 0 0 .25-.25v-5.5a.25.25 0 0 0-.25-.25Zm12.5 2h-.5a.75.75 0 0 1 0-1.5h.5c.967 0 1.75.783 1.75 1.75v5.5A1.75 1.75 0 0 1 14.25 12H14v1.543a1.457 1.457 0 0 1-2.487 1.03L9.22 12.28a.749.749 0 1 1 1.06-1.06l2.22 2.219V11.25a.75.75 0 0 1 .75-.75h1a.25.25 0 0 0 .25-.25v-5.5a.25.25 0 0 0-.25-.25Zm-5.47.28-3 3a.747.747 0 0 1-1.06 0l-1.5-1.5a.749.749 0 1 1 1.06-1.06l.97.969L7.72 3.72a.749.749 0 1 1 1.06 1.06Z">
                </path>
              </svg>
              <span class="text">Your topics</span>
            </a>
          </li>
        </ul>
        <ul class="tab preference">
          <span class="title">Preference</span>
          <li url="/user/typography" class="tab-item typography" data-name="typography">
            <span class="line"></span>
            <a href="/user/typography" class="tab-link">
              <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16" width="16" height="16">
                <path d="M6.71 10H2.332l-.874 2.498a.75.75 0 0 1-1.415-.496l3.39-9.688a1.217 1.217 0 0 1 2.302.018l3.227 9.681a.75.75 0 0 1-1.423.474Zm3.13-4.358C10.53 4.374 11.87 4 13 4c1.5 0 3 .939 3 2.601v5.649a.75.75 0 0 1-1.448.275C13.995 12.82 13.3 13 12.5 13c-.77 0-1.514-.231-2.078-.709-.577-.488-.922-1.199-.922-2.041 0-.694.265-1.411.887-1.944C11 7.78 11.88 7.5 13 7.5h1.5v-.899c0-.54-.5-1.101-1.5-1.101-.869 0-1.528.282-1.84.858a.75.75 0 1 1-1.32-.716ZM6.21 8.5 4.574 3.594 2.857 8.5Zm8.29.5H13c-.881 0-1.375.22-1.637.444-.253.217-.363.5-.363.806 0 .408.155.697.39.896.249.21.63.354 1.11.354.732 0 1.26-.209 1.588-.449.35-.257.412-.495.412-.551Z"></path>
              </svg>
              <span class="text">Typography</span>
            </a>
          </li>
        </ul>
        <ul class="tab preference">
          <span class="title">Account</span>
          <li url="/user/logout" class="tab-item logout" data-name="logout">
            <span class="line"></span>
            <a href="/user/logout" class="tab-link">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" fill="currentColor">
                <path d="M2 2.75C2 1.784 2.784 1 3.75 1h2.5a.75.75 0 0 1 0 1.5h-2.5a.25.25 0 0 0-.25.25v10.5c0 .138.112.25.25.25h2.5a.75.75 0 0 1 0 1.5h-2.5A1.75 1.75 0 0 1 2 13.25Zm10.44 4.5-1.97-1.97a.749.749 0 0 1 .326-1.275.749.749 0 0 1 .734.215l3.25 3.25a.75.75 0 0 1 0 1.06l-3.25 3.25a.749.749 0 0 1-1.275-.326.749.749 0 0 1 .215-.734l1.97-1.97H6.75a.75.75 0 0 1 0-1.5Z"></path>
              </svg>
              <span class="text">Logout</span>
            </a>
          </li>
        </ul>
      </section>
    `;
    }

    getHeader = () => {
      // Get name and check if it's greater than 20 characters
      const name = this.getAttribute('user-name');

      return /* html */`
      <div class="header remains">
        ${this.getIcon()}
        <div class="profile">
          ${this.getPicture(this.getAttribute('user-img'))}
        </div>
        <div class="name">
          <h4 class="name">${name}</h4>
          <a href="${this.getAttribute('user-url')}" class="username">
            <span class="text">${this.getAttribute('user-username')}</span>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" fill="currentColor">
              <path d="M4.53 4.75A.75.75 0 0 1 5.28 4h6.01a.75.75 0 0 1 .75.75v6.01a.75.75 0 0 1-1.5 0v-4.2l-5.26 5.261a.749.749 0 0 1-1.275-.326.749.749 0 0 1 .215-.734L9.48 5.5h-4.2a.75.75 0 0 1-.75-.75Z" />
            </svg>
          </a>
        </div>
      </div>
    `
    }

    getPicture = picture => {
      // check if picture is empty || null || === "null"
      if (picture === '' || picture === null || picture === 'null') {
        return /*html*/`
        <div class="avatar svg">
          <div class="svg-avatar">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
              <path d="M12 2.5a5.5 5.5 0 0 1 3.096 10.047 9.005 9.005 0 0 1 5.9 8.181.75.75 0 1 1-1.499.044 7.5 7.5 0 0 0-14.993 0 .75.75 0 0 1-1.5-.045 9.005 9.005 0 0 1 5.9-8.18A5.5 5.5 0 0 1 12 2.5ZM8 8a4 4 0 1 0 8 0 4 4 0 0 0-8 0Z"></path>
            </svg>
          </div>
          ${this.checkVerified(this.getAttribute('verified'))}
        </div>
      `
      }
      else {
        return /*html*/`
        <div class="avatar">
          <img src="${picture}" alt="Author picture" async lazy="true">
          ${this.checkVerified(this.getAttribute('verified'))}
        </div>
      `
      }
    }

    getIcon = () => {
      // check for mobile
      const isMobile = window.matchMedia('(max-width: 660px)').matches;

      if (isMobile) {
        return /* html */`
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" fill="currentColor">
          <path d="M12.78 5.22a.749.749 0 0 1 0 1.06l-4.25 4.25a.749.749 0 0 1-1.06 0L3.22 6.28a.749.749 0 1 1 1.06-1.06L8 8.939l3.72-3.719a.749.749 0 0 1 1.06 0Z"></path>
        </svg>
      `
      }
      else {
        return /* html */`
        <svg class="top-btn" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" fill="currentColor">
          <path d="M9.78 12.78a.75.75 0 0 1-1.06 0L4.47 8.53a.75.75 0 0 1 0-1.06l4.25-4.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042L6.06 8l3.72 3.72a.75.75 0 0 1 0 1.06Z"></path>
        </svg>
      `
      }
    }

    getProfile = () => {
      // get url
      let url = this.getAttribute('user-url');
   
      // trim white spaces and convert to lowercase
      url = url.trim().toLowerCase();

     return /* html */`
    <app-profile tab="stories" you="true" url="${url}" tab="stories"
      stories-url="${this.getAttribute('stories-url')}" replies-url="${this.getAttribute('replies-url')}"
      stories="${this.getAttribute('stories')}" replies="${this.getAttribute('replies')}"
      followers-url="/api/v1${url}/followers" following-url="/api/v1${url}/following" contact='${this.getAttribute("user-contact")}'
      hash="${this.getAttribute('hash')}" picture="${this.getAttribute('user-img')}" verified="${this.getAttribute('user-verified')}"
      name="${this.getAttribute('user-name')}" followers="${this.getAttribute('user-followers')}"
      following="${this.getAttribute('user-following')}" user-follow="${this.getAttribute('user-follow')}" bio="${this.getAttribute('user-bio')}">
    </app-profile>
   `
   }

    getStyles() {
      return /* css */`
	    <style>
	      *,
	      *:after,
	      *:before {
	        box-sizing: border-box !important;
	        font-family: inherit;
	        -webkit-box-sizing: border-box !important;
	      }

	      *:focus {
	        outline: inherit !important;
	      }

	      *::-webkit-scrollbar {
	        width: 3px;
	      }

	      *::-webkit-scrollbar-track {
	        background: var(--scroll-bar-background);
	      }

	      *::-webkit-scrollbar-thumb {
	        width: 3px;
	        background: var(--scroll-bar-linear);
	        border-radius: 50px;
	      }

	      h1,
	      h2,
	      h3,
	      h4,
	      h5,
	      h6 {
	        padding: 0;
	        margin: 0;
	        font-family: inherit;
	      }

	      p,
	      ul,
	      ol {
	        padding: 0;
	        margin: 0;
	      }

	      a {
	        text-decoration: none;
	      }

	      :host {
          font-size: 16px;
          padding: 0;
          margin: 0;
          display: flex;
          flex-flow: column;
          gap: 0px;
        }

        .top-nav {
          border-bottom: var(--border);
          color: var(--title-color);
          display: flex;
          flex-flow: row;
          align-items: center;
          background-color: var(--background);
          padding: 0;
          gap: 0;
          max-height: 50px;
          min-height: 50px;
          margin: 0 0 5px;
          gap: 0;
          width: 100%;
          position: sticky;
          top: 0;
          z-index: 100;
        }

        .top-nav h3 {
          display: flex;
          flex-flow: row;
          align-items: center;
          margin: 0;
          padding: 0;
          font-family: var(--font-main), sans-serif;
          font-size: 1.2rem;
          font-weight: 600;
        }

        .top-nav svg {
          cursor: pointer;
          width: 35px;
          height: 35px;
          margin: 0 0 0 -8px;
        }

        #loader-container {
          position: absolute;
          top: 0;
          left: 0;
          bottom: calc(40% - 35px);
          right: 0;
          z-index: 5;
          background-color: var(--loader-background);
          backdrop-filter: blur(1px);
          -webkit-backdrop-filter: blur(1px);
          display: flex;
          align-items: center;
          justify-content: center;
          border-radius: inherit;
          -webkit-border-radius: inherit;
          -moz-border-radius: inherit;
        }

        #loader-container > .loader {
          width: 35px;
          aspect-ratio: 1;
          --_g: no-repeat radial-gradient(farthest-side, #18A565 94%, #0000);
          --_g1: no-repeat radial-gradient(farthest-side, #21D029 94%, #0000);
          --_g2: no-repeat radial-gradient(farthest-side, #df791a 94%, #0000);
          --_g3: no-repeat radial-gradient(farthest-side, #f09c4e 94%, #0000);
          background:    var(--_g) 0 0,    var(--_g1) 100% 0,    var(--_g2) 100% 100%,    var(--_g3) 0 100%;
          background-size: 30% 30%;
          animation: l38 .9s infinite ease-in-out;
          -webkit-animation: l38 .9s infinite ease-in-out;
        }

        @keyframes l38 {
          100% {
            background-position: 100% 0, 100% 100%, 0 100%, 0 0
          }
        }

        main.profile {
          padding: 0;
          margin: 0;
          display: flex;
          justify-content: space-between;
          gap: 30px;
          min-height: 100vh;
        }

        section.tab {
          padding: 0 0 30px 0;
          width: 25%;
          display: flex;
          background-color: var(--background);
          flex-flow: column;
          position: sticky;
          top: 0;
          gap: 10px;
          height: max-content;
          max-height: 100vh;
          overflow-y: auto;
          scrollbar-width: none;
          -ms-overflow-style: none;
        }

        section.tab::-webkit-scrollbar {
          display: none;
          visibility: hidden;
        }

        section.tab > div.header {
          display: flex;
          width: 100%;
          background-color: var(--background);
          gap: 0;
          padding: 22px 0 5px 0;
          max-height: max-content;
          margin: 0;
          display: flex;
          align-items: center;
          position: sticky;
          top: 0;
          z-index: 5;
        }

        section.tab > div.header > svg {
          cursor: pointer;
          color: var(--title-color);
          width: 35px;
          height: 35px;
          margin: 0 0 0 -5px;
        }

        section.tab > div.header > svg:hover {
          color: var(--accent-color);
        }

        section.tab > div.header > .profile {
          display: flex;
          align-items: center;
          justify-content: center;
          position: relative;
          margin: 0 3px 0 0;
          width: 45px;
          height: 45px;
          min-width: 45px;
          min-height: 45px;
          border-radius: 50%;
          -webkit-border-radius: 50%;
          -moz-border-radius: 50%;
          -ms-border-radius: 50%;
          -o-border-radius: 50%;
        }

        section.tab > div.header > .profile .avatar {
          display: flex;
          align-items: center;
          justify-content: center;
          width: 100%;
          height: 100%;
          min-width: 100%;
          min-height: 100%;
          border-radius: 50%;
          -webkit-border-radius: 50%;
          -moz-border-radius: 50%;
        }

        section.tab > div.header > .profile .avatar.svg {
          background: var(--gray-background);
          max-width: 45px;
          max-height: 45px;
        }

        section.tab > div.header > .profile .avatar img {
          width: 100%;
          height: 100%;
          overflow: hidden;
          object-fit: cover;
          border-radius: 50%;
          -webkit-border-radius: 50%;
          -moz-border-radius: 50%;
          -ms-border-radius: 50%;
          -o-border-radius: 50%;
        }

         section.tab > div.header > .profile .avatar .svg-avatar {
          display: flex;
          align-items: center;
          justify-content: center;
          width: 100%;
          height: 100%;
          border-radius: 50%;
          -webkit-border-radius: 50%;
          -moz-border-radius: 50%;
        }

        section.tab > div.header > .profile .avatar .svg-avatar svg {
          width: 30px;
          height: 30px;
          color: var(--gray-color);
          display: inline-block;
          margin: 0 0 5px 0;
        }

        section.tab > div.header > .profile .avatar > svg {
          position: absolute;
          bottom: -2px;
          right: -4px;
          width: 23px;
          height: 23px;
          z-index: 1;
          display: flex;
          align-items: center;
          justify-content: center;
          border-radius: 50%;
        }

        section.tab > div.header > .profile .avatar > svg path#top {
          color: var(--background);
        }
        
        section.tab > div.header > .profile .avatar > svg path#bottom {
          color: var(--alt-color);
        }

        section.tab > div.header > .name {
          margin: 0 0 0 5px;
          display: flex;
          justify-content: center;
          flex-flow: column;
          gap: 3px;
          width: calc(100% - 80px);
          max-width: calc(100% - 80px);
        }

        section.tab > div.header > .name > h4.name {
          margin: 0;
          display: flex;
          align-items: center;
          width: 100%;
          max-width: 100%;
          gap: 5px;
          color: var(--title-color);
          font-family: var(--font-main), sans-serif;
          font-size: 1rem;
          font-weight: 500;
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
        }

        section.tab > div.header > .name > a.username {
          color: var(--gray-color);
          font-family: var(--font-mono), monospace;
          font-size: 0.9rem;
          font-weight: 500;
          width: max-content;
          text-decoration: none;
          display: flex;
          gap: 2px;
          align-items: center;
        }

        section.tab > div.header > .name > a.username:hover {
          color: transparent;
          background: var(--accent-linear);
          background-clip: text;
          -webkit-background-clip: text;
        }

        section.tab > div.header > .name > a.username:hover svg {
          color: var(--accent-color);
        }

        section.tab > ul.tab {
          border-top: var(--border-mobile);
          list-style-type: none;
          width: 100%;
          padding: 0;
          margin: 0;
          display: flex;
          flex-flow: column;
          gap: 0;
        }

        section.tab > ul.tab.public {
          border: none;
        }

        section.tab > ul.tab > li.tab-item {
          position: relative;
          padding: 0;
          color: var(--text-color);
          font-family: var(--font-text), sans-serif;
          margin: 0;
          width: 100%;
          cursor: pointer;
          display: flex;
          align-items: center;
          justify-content: start;
        }

        section.tab > ul.tab > span.title {
          color: var(--highlight-color);
          display: inline-block;
          padding: 15px 10px 6px 10px;
          font-size: 0.9rem;
          font-weight: 600;
        }

        section.tab > ul.tab > li.tab-item > span.line {
          position: absolute;
          display: none;
          left: -10px;
          top: calc(40% / 2);
          width: 4px;
          height: 60%;
          background: var(--accent-linear);
          border-radius: 5px;
          -webkit-border-radius: 5px;
          -moz-border-radius: 5px;
          -ms-border-radius: 5px;
          -o-border-radius: 5px;
        }

        section.tab > ul.tab > li.tab-item.active > span.line {
          display: inline-block;
        }

        section.tab > ul.tab > li.tab-item > a.tab-link {
          width: 100%;
          display: flex;
          align-items: center;
          text-decoration: none;
          color: var(--text-color);
          font-family: var(--font-main), sans-serif;
          padding: 7px 10px 6px 10px;
          gap: 10px;
          border-radius: 9px;
          -webkit-border-radius: 9px;
          -moz-border-radius: 9px;
          -ms-border-radius: 9px;
          -o-border-radius: 9px;
        }

        section.tab > ul.tab > li.tab-item.logout > a.tab-link {
          color: var(--error-color);
        }

        section.tab > ul.tab > li.tab-item > a.tab-link:hover {
          background: var(--tab-background);
        }
        section.tab > ul.tab > li.tab-item.active > a.tab-link {
          background-color: var(--tab-background);
          color: var(--highlight-color);
        }

        section.tab > ul.tab > li.tab-item.active.logout > a.tab-link {
          color: var(--error-color);
        }

        section.content {
          display: flex;
          position: relative;
          flex-flow: column;
          align-items: start;
          padding: ;
          gap: 0;
          width: 70%;
        }

        section.content > div.content-container {
          display: flex;
          flex-flow: column;
          position: relative;
          padding: 0;
          margin: 0;
          width: 100%;
          min-height: 70vh;
        }

        div.coming-soon {
          display: flex;
          flex-flow: column;
          align-items: center;
          justify-content: center;
          padding: 0;
          width: 100%;
          min-height: max-content;
          height: 100%;
        }

        div.coming-soon > .title {
          color: var(--title-color);
          font-family: var(--title-text), sans-serif;
          font-size: 1.3rem;
          font-weight: 600;
          margin: 0 0 10px 0;
          line-height: 1.5;
          display: flex;
          flex-flow: column;
          align-items: center;
          justify-content: center;
        }

        div.coming-soon > .title svg {
          color: var(--error-color);
          width: 25px;
          height: 25px;
          margin: 0 0 10px 0;
        }

        div.coming-soon > .title span.text {
          color: var(--text-color);
          font-family: var(--font-text), sans-serif;
          font-size: inherit;
          font-weight: 600;
          text-align: center;
        }

        div.coming-soon > p.info {
          color: var(--gray-color);
          font-family: var(--font-main), sans-serif;
          font-size: 1rem;
          margin: 0 0 10px 0;
          font-weight: 400;
          line-height: 1.5;
          text-align: center;
        }

        div.themes {
          display: flex;
          flex-flow: column;
          padding: 0;
          width: 100%;
          height: max-content;
          gap: 10px;
          min-height: max-content;
          height: max-content;
        }

        div.themes > .top > .desc {
          margin: 0;
          padding: 10px 0 0;
          color: var(--text-color);
          line-height: 1.2;
          font-size: 1rem;
          font-family: var(--font-main), sans-serif;
        }

        div.themes > .top > .desc > span {
          display: inline-block;
          margin: 10px 0 5px;
          color: var(--gray-color);
          font-size: 0.85rem;
          font-style: italic;
          font-family: var(--font-read), sans-serif;
        }

        div.themes > .themes-container {
          display: flex;
          color: var(--text-color);
          padding: 0;
          gap: 20px;
          width: 100%;
          min-height: max-content;
          height: 100%;
        }

        div.themes > .themes-container > .theme {
          display: flex;
          flex-flow:column;
          justify-content: space-between;
          color: var(--text-color);
          padding: 0;
          gap: 5px;
          width: 100%;
          height: 100%;
        }

        div.themes > .themes-container > .theme h4.name {
          margin: 0;
          font-weight: 600;
          font-size: 1.15rem;
          color: var(--title-color);
        }

        div.themes > .themes-container > .theme p.description {
          margin: 0 0 5px;
          font-size: 0.95rem;
          color: var(--gray-color);
        }

        div.themes > .themes-container > .theme button {
          display: flex;
          align-items: center;
          justify-content: center;
          padding: 4px 15px 5px;
          height: max-content;
          width: max-content;
          border-radius: 10px;
          -webkit-border-radius: 10px;
          -moz-border-radius: 10px;
          background: var(--accent-linear);
          color: var(--white-color);
          font-weight: 500;
          font-size: 0.9rem;
          line-height: 1.3;
          font-weight: 500;
          font-family: var(--font-text), sans-serif;
          cursor: pointer;
          outline: none;
          border: none;
          text-transform: capitalize;
        }

        div.themes > .themes-container > .theme button.activated {
          background: none;
          padding: 4px 10px 5px;
          color: var(--highlight-color);
          background-color: var(--gray-background);
        }

        div.themes p.soon {
          margin: 5px 0;
          padding: 10px 0;
          color: var(--gray-color);
          font-size: 0.85rem;
          font-style: italic;
          font-family: var(--font-read), sans-serif;
          border-top: var(--border);
        }

				@media screen and (max-width:900px) {
          section.tab {
            padding: 0;
            width: 33%;
          }
          section.content {
            width: 62%;
          }

          div.themes > .themes-container {
            flex-flow: column;
            gap: 0;
          }

          div.themes > .themes-container > .theme {
            display: flex;
            flex-flow:column;
            color: var(--text-color);
            margin: 0 0 5px;
            padding: 10px 0;
            gap: 5px;
            width: 100%;
            min-height: max-content;
            height: 100%;
            border-top: var(--border);
          }

          div.themes > .themes-container > .theme:last-of-type {
            margin: 0;
            padding: 10px 0 0;
          }
        }

				@media screen and (max-width:660px) {
					:host {
            font-size: 16px;
					}

          div.themes > .themes-container > .theme button,
          svg {
            cursor: default !important;
          }

          main.profile {
            padding: 0;
            width: 100%;
            margin: 0;
            display: flex;
            flex-flow: column;
            justify-content: start;
            gap: 0;
            min-height: max-content;
            height: max-content;
            max-height: max-content;
          }

           section.content {
            display: flex;
            flex-flow: column;
            align-items: start;
            min-height: 70vh;
            padding: 0;
            gap: 0;
            width: 100%;
          }

          section.tab {
            padding: 0;
            width: 100%;
            min-width: 100%;
            max-height: max-content;
            display: flex;
            flex-flow: column;
            gap: 0;
            height: max-content;
            position: unset;
          }
  
          section.tab > ul.tab > span.title {
            color: var(--text-color);
            display: inline-block;
            padding: 5px 10px;
            font-size: 0.9rem;
            font-weight: 600;
          }

          section.tab > div.header > .name {
            margin: 0 0 0 5px;
            display: flex;
            justify-content: center;
            flex-flow: column;
            gap: 0;
            width: calc(100% - 90px);
            max-width: calc(100% - 90px);
          }

          section.tab > div.header {
            padding: 10px 0;
            border-bottom: var(--border);
            display: flex;
            position: relative;
          }

          section.tab > div.header > svg {
            transition: all 0.3s ease-in-out;
            position: absolute;
            right: 10px;
            top: 18px;
            width: 23px;
            height: 23px;
            margin: 0 0 0 -5px;
          }

          section.tab > ul.tab {
            border-top: var(--border);
            transition: all 0.5s ease;
            border: none;
            max-height: 0;
            margin: 0;
            padding: 0;
            overflow: hidden;
          }

          section.tab > ul.tab > li.tab-item,
          a {
            cursor: default !important;
          }

          div.coming-soon {
            display: flex;
            flex-flow: column;
            align-items: center;
            justify-content: center;
            margin: 15px 0 0 0;
            padding: 20px 0;
            width: 100%;
            min-height: max-content;
            height: 100%;
          }
				}
	    </style>
    `;
    }
  }

  class AppOffline extends HTMLElement {
    constructor() {
      // We are not even going to touch this.
      super();

      this.setTitle();

      // let's create our shadow root
      this.shadowObj = this.attachShadow({ mode: "open" });

      this.render();
    }

    setTitle = () => {
      // update title of the document
      document.title = 'Home | Explore, create and contribute to ideas that can change the world';
    }

    render() {
      this.shadowObj.innerHTML = this.getTemplate();
    }

    connectedCallback() {
      //Scroll the window to the top
      window.scrollTo(0, 0);

      // request user to enable notifications
      this.checkNotificationPermission();

      // onpopstate event
      this.onPopEvent();

      // Watch for media query changes
      const mql = window.matchMedia('(max-width: 660px)');

      // fetch content
      const container = this.shadowObj.querySelector('.feeds');
      this.fetchContent(container);

      this.watchMediaQuery(mql);
    }

    checkNotificationPermission = async () => {
      if(window.notify && !window.notify.permission) {
        await window.notify.requestPermission();
      }
    }

    disconnectedCallback() {
      this.enableScroll();
      // clear window.home
      window.home = null;
    }

    // watch for mql changes
    watchMediaQuery = mql => {
      mql.addEventListener('change', () => {
        // Re-render the component
        this.render();

        // fetch content
        const container = this.shadowObj.querySelector('.feeds');
        this.fetchContent(container);

        // call onpopstate event
        this.onPopEvent();
      });
    }

    onPopEvent = () => {
      const outerThis = this;
      // Update state on window.onpopstate
      window.onpopstate = event => {
        // This event will be triggered when the browser's back button is clicked

        if (event.state) {
          if (event.state.popup) {
            return;
          }
          
          if (event.state.page) {
            outerThis.updatePage(event.state.content);
          }
        }
      };
    }

    updatePage = content => {
      // select body
      const body = document.querySelector('body');

      // populate content
      body.innerHTML = content;
    }

    disableScroll() {
      // Get the current page scroll position
      let scrollTop = window.scrollY || document.documentElement.scrollTop;
      let scrollLeft = window.scrollX || document.documentElement.scrollLeft;
      document.body.classList.add("stop-scrolling");

      // if any scroll is attempted, set this to the previous value
      window.onscroll = function () {
        window.scrollTo(scrollLeft, scrollTop);
      };
    }

    enableScroll() {
      document.body.classList.remove("stop-scrolling");
      window.onscroll = function () { };
    }

    getTemplate = () => {
      // Show HTML Here
      return `
      ${this.getBody()}
      ${this.getStyles()}
    `;
    }

    fetchContent = container => {
      let intervalId;
    
      const fetchLogic = (getContentFunction) => {
        if (!window.home) return;
        const home = window.home;
        
        if (home.last === true) {
          clearInterval(intervalId);
          return;
        }
        
        if (home.loaded) {
          container.insertAdjacentHTML('beforeend', getContentFunction(home.next));
        }

        // set loaded to false
        window.home.loaded = false;
      };
    
      intervalId = setInterval(() => fetchLogic(this.getStepContent), 500);
    };

    getStepContent = step => {
      if (step === 1) {
        return /* html */`
        <stories-container stories="recent" url="${this.getAttribute('recent-url')}" offline="true"></stories-container>
      `
      } else if (step === 2) {
        return /* html */`
        <topics-container url="/api/v1/q/trending/topics" offline="true"></topics-container>
      `
      } else return '';
    }

    getBody = () => {
      const mql = window.matchMedia('(max-width: 660px)');
      if (mql.matches) {
        return /* html */`
        ${this.getTop()}
        <div class="feeds">
          <add-container type="story"></add-container>
          <feed-container url="${this.getAttribute('trending-url')}" offline="true"></feed-container>
        <div>
      `;
      }
      else {
        return /* html */`
        <div class="feeds">
          ${this.getTop()}
          <add-container type="story"></add-container>
          <feed-container url="${this.getAttribute('trending-url')}" offline="true"></feed-container>
        </div>
        <div class="side">
          <topics-container url="/api/v1/q/trending/topics" offline="true"></topics-container>
          ${this.getInfo()}
        </div>
      `;
      }
    }

    getTop = () => {
      return /* html */ `
      <header-wrapper section="Home" type="home"
        user-url="${this.getAttribute('url')}" auth-url="${this.getAttribute('auth-url')}"
        url="${this.getAttribute('url')}" search-url="${this.getAttribute('search-url')}">
      </header-wrapper>
    `
    }

    getInfo = () => {
      return /*html*/`
      <info-container docs="/about/docs" new="/about/new"
       feedback="/about/feedback" request="/about/request" code="/about/code" donate="/about/donate" contact="/about/contact" company="https://github.com/aduki-hub">
      </info-container>
    `
    }

    getStyles() {
      return /* css */`
	    <style>
	      *,
	      *:after,
	      *:before {
	        box-sizing: border-box !important;
	        font-family: inherit;
	        -webkit-box-sizing: border-box !important;
	      }

	      *:focus {
	        outline: inherit !important;
	      }

	      *::-webkit-scrollbar {
	        width: 3px;
	      }

	      *::-webkit-scrollbar-track {
	        background: var(--scroll-bar-background);
	      }

	      *::-webkit-scrollbar-thumb {
	        width: 3px;
	        background: var(--scroll-bar-linear);
	        border-radius: 50px;
	      }

	      h1,
	      h2,
	      h3,
	      h4,
	      h5,
	      h6 {
	        padding: 0;
	        margin: 0;
	        font-family: inherit;
	      }

	      p,
	      ul,
	      ol {
	        padding: 0;
	        margin: 0;
	      }

	      a {
	        text-decoration: none;
	      }

	      :host {
          font-size: 16px;
          padding: 0;
          margin: 0;
          display: flex;
          justify-content: space-between;
          gap: 30px;
        }

        .feeds {
          display: flex;
          flex-flow: column;
          gap: 0;
          width: 63%;
        }

        div.side {
          padding: 25px 0;
          margin: 0;
          background-color: transparent;
          width: 33%;
          height: max-content;
          display: flex;
          flex-flow: column;
          gap: 20px;
          position: sticky;
          top: 0;
          height: 100vh;
          max-height: 100vh;
          overflow-y: scroll;
          scrollbar-width: none;
        }

        div.side::-webkit-scrollbar {
          visibility: hidden;
          display: none;
        }

        @media screen and (max-width:900px) {
         .feeds {
            width: 58%;
          }

          div.side {
            width: 40%;
          }
        }

				@media screen and (max-width:660px) {
					:host {
            font-size: 16px;
						padding: 0;
            margin: 0;
            display: flex;
            flex-flow: column;
            justify-content: space-between;
            gap: 0;
					}

					::-webkit-scrollbar {
						-webkit-appearance: none;
					}
					a {
						cursor: default !important;
          }

          .feeds {
            display: flex;
            flex-flow: column;
            gap: 0;
            padding: 0 0 50px 0;
            width: 100%;
          }

          div.side {
            padding: 0;
            margin: 0;
            width: 100%;
          }
				}
	    </style>
    `;
    }
  }

  // WebSocketManager.js
  class WebSocketManager {
    constructor(host, port=3001, reconnectInterval = 5000, maxReconnectAttempts = 60) {
      if (WebSocketManager.instance) {
        return WebSocketManager.instance;
      }
      
      this.url = `wss://${host}:${port}/events`;
      this.reconnectInterval = reconnectInterval;
      this.maxReconnectAttempts = maxReconnectAttempts;
      this.reconnectAttempts = 0;
      this.ws = null;
      this.messageHandlers = new Set();

      WebSocketManager.instance = this;
    }

    connect() {
      if (this.ws && this.ws.readyState !== WebSocket.CLOSED) return;

      this.ws = new WebSocket(this.url);

      this.ws.onopen = () => {
        console.log('WebSocket connection established');
        this.reconnectAttempts = 0;
      };

      this.ws.onmessage = this.handleMessage.bind(this);
      this.ws.onerror = this.handleError.bind(this);
      this.ws.onclose = this.handleClose.bind(this);
    }

    handleError(error) {
      console.error('WebSocket error:', error);
    }

    handleClose() {
      console.log('WebSocket connection closed');
      this.reconnect();
    }

    reconnect() {
      if (this.reconnectAttempts >= this.maxReconnectAttempts) {
        console.log('Max reconnection attempts reached. Stopping reconnection.');
        return;
      }

      this.reconnectAttempts++;
      console.log(`Attempting to reconnect (${this.reconnectAttempts}/${this.maxReconnectAttempts})...`);
      setTimeout(() => this.connect(), this.reconnectInterval);
    }

    sendMessage(data) {
      if (this.ws && this.ws.readyState === WebSocket.OPEN) {
        // console.log('Sending message:', data);
        this.ws.send(JSON.stringify(data));
      } else {
        console.warn('WebSocket is not open. Message not sent.');
      }
    }

    handleMessage(event) {
      if (!event || event === undefined || !event.data) return;
      try {
        const data = JSON.parse(event.data);
        
        this.messageHandlers.forEach(handler => {
          if (typeof handler === 'function') {
            try {
              if (!data) return;
              handler(data);
            } catch (handlerError) {
              console.error('Error in message handler:', handlerError);
            }
          } else {
            console.warn('Invalid handler found:', handler);
          }
        });
      } catch (error) {
        console.error('Error parsing message:', error);
      }
    }

    addMessageHandler(handler) {
      // console.log('Adding message handler:', handler);
      if (typeof handler === 'function') {
        this.messageHandlers.add(handler);
      } else {
        console.error('Attempted to add invalid handler:', handler);
      }
    }

    removeMessageHandler(handler) {
      this.messageHandlers.delete(handler);
    }
  }

  class NotificationManager {
    constructor() {
      this.isSupported = "Notification" in window;
      this.permission = this.checkPermission();
    }

    checkPermission() {
      if (!this.isSupported) {
        console.warn("This browser does not support desktop notifications");
        return false;
      }
      return Notification.permission === "granted";
    }

    async requestPermission() {
      if (!this.isSupported) {
        console.warn("Notifications not supported");
        return false;
      }
      const permission = await Notification.requestPermission();
      this.permission = permission === "granted";
      console.log(this.permission ? "Notification permission granted" : "Notification permission denied");
      return this.permission;
    }

    async notify(title, options = {}) {
      if (!this.permission) {
        console.log("Notification permission not granted. Requesting permission...");
        if (!(await this.requestPermission())) {
          console.warn("Failed to get notification permission");
          return null;
        }
      }

      const notification = new Notification(title, options);
      if (options.link) {
        notification.onclick = () => {
          window.open(options.link, '_blank');
        };
      }
      return notification;
    }

    removeNotification(notification) {
      if (notification && typeof notification.close === 'function') {
        notification.close();
      }
    }

    removeAllNotifications() {
      if ("serviceWorker" in navigator && navigator.serviceWorker.controller) {
        navigator.serviceWorker.ready.then(registration => {
          registration.getNotifications().then(notifications => {
            notifications.forEach(notification => notification.close());
          });
        });
      }
    }
  }

  /**
   * @license Copyright (c) 2003-2024, CKSource Holding sp. z o.o. All rights reserved.
   * For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-oss-license
   */
  function e(e,t){return t.forEach((function(t){t&&"string"!=typeof t&&!Array.isArray(t)&&Object.keys(t).forEach((function(i){if("default"!==i&&!(i in e)){var n=Object.getOwnPropertyDescriptor(t,i);Object.defineProperty(e,i,n.get?n:{enumerable:!0,get:function(){return t[i]}});}}));})),Object.freeze(e)}let t;try{t={window:window,document:document};}catch(e){t={window:{},document:{}};}var i=t;function n(){try{return navigator.userAgent.toLowerCase()}catch(e){return ""}}const s=n(),o={isMac:r(s),isWindows:a(s),isGecko:l(s),isSafari:c(s),isiOS:d(s),isAndroid:h(s),isBlink:u(s),get isMediaForcedColors(){return !!i.window.matchMedia&&i.window.matchMedia("(forced-colors: active)").matches},get isMotionReduced(){return !!i.window.matchMedia&&i.window.matchMedia("(prefers-reduced-motion)").matches},features:{isRegExpUnicodePropertySupported:m()}};function r(e){return e.indexOf("macintosh")>-1}function a(e){return e.indexOf("windows")>-1}function l(e){return !!e.match(/gecko\/\d+/)}function c(e){return e.indexOf(" applewebkit/")>-1&&-1===e.indexOf("chrome")}function d(e){return !!e.match(/iphone|ipad/i)||r(e)&&navigator.maxTouchPoints>0}function h(e){return e.indexOf("android")>-1}function u(e){return e.indexOf("chrome/")>-1&&e.indexOf("edge/")<0}function m(){let e=!1;try{e=0==="ć".search(new RegExp("[\\p{L}]","u"));}catch(e){}return e}function g(e,t,i,n){i=i||function(e,t){return e===t};const s=Array.isArray(e)?e:Array.prototype.slice.call(e),o=Array.isArray(t)?t:Array.prototype.slice.call(t),r=function(e,t,i){const n=f(e,t,i);if(-1===n)return {firstIndex:-1,lastIndexOld:-1,lastIndexNew:-1};const s=p(e,n),o=p(t,n),r=f(s,o,i),a=e.length-r,l=t.length-r;return {firstIndex:n,lastIndexOld:a,lastIndexNew:l}}(s,o,i),a=n?function(e,t){const{firstIndex:i,lastIndexOld:n,lastIndexNew:s}=e;if(-1===i)return Array(t).fill("equal");let o=[];i>0&&(o=o.concat(Array(i).fill("equal")));s-i>0&&(o=o.concat(Array(s-i).fill("insert")));n-i>0&&(o=o.concat(Array(n-i).fill("delete")));s<t&&(o=o.concat(Array(t-s).fill("equal")));return o}(r,o.length):function(e,t){const i=[],{firstIndex:n,lastIndexOld:s,lastIndexNew:o}=t;o-n>0&&i.push({index:n,type:"insert",values:e.slice(n,o)});s-n>0&&i.push({index:n+(o-n),type:"delete",howMany:s-n});return i}(o,r);return a}function f(e,t,i){for(let n=0;n<Math.max(e.length,t.length);n++)if(void 0===e[n]||void 0===t[n]||!i(e[n],t[n]))return n;return -1}function p(e,t){return e.slice(t).reverse()}function b(e,t,i){i=i||function(e,t){return e===t};const n=e.length,s=t.length;if(n>200||s>200||n+s>300)return b.fastDiff(e,t,i,!0);let o,r;if(s<n){const i=e;e=t,t=i,o="delete",r="insert";}else o="insert",r="delete";const a=e.length,l=t.length,c=l-a,d={},h={};function u(n){const s=(void 0!==h[n-1]?h[n-1]:-1)+1,c=void 0!==h[n+1]?h[n+1]:-1,u=s>c?-1:1;d[n+u]&&(d[n]=d[n+u].slice(0)),d[n]||(d[n]=[]),d[n].push(s>c?o:r);let m=Math.max(s,c),g=m-n;for(;g<a&&m<l&&i(e[g],t[m]);)g++,m++,d[n].push("equal");return m}let m,g=0;do{for(m=-g;m<c;m++)h[m]=u(m);for(m=c+g;m>c;m--)h[m]=u(m);h[c]=u(c),g++;}while(h[c]!==l);return d[c].slice(1)}b.fastDiff=g;class v{source;name;path;stop;off;return;constructor(e,t){this.source=e,this.name=t,this.path=[],this.stop=function e(){e.called=!0;},this.off=function e(){e.called=!0;};}}const y=new Array(256).fill("").map(((e,t)=>("0"+t.toString(16)).slice(-2)));function k(){const[e,t,i,n]=crypto.getRandomValues(new Uint32Array(4));return "e"+y[255&e]+y[e>>8&255]+y[e>>16&255]+y[e>>24&255]+y[255&t]+y[t>>8&255]+y[t>>16&255]+y[t>>24&255]+y[255&i]+y[i>>8&255]+y[i>>16&255]+y[i>>24&255]+y[255&n]+y[n>>8&255]+y[n>>16&255]+y[n>>24&255]}const C={get(e="normal"){return "number"!=typeof e?this[e]||this.normal:e},highest:1e5,high:1e3,normal:0,low:-1e3,lowest:-1e5};function x(e,t){const i=C.get(t.priority);for(let n=0;n<e.length;n++)if(C.get(e[n].priority)<i)return void e.splice(n,0,t);e.push(t);}const A="https://ckeditor.com/docs/ckeditor5/latest/support/error-codes.html";class E extends Error{context;data;constructor(e,t,i){super(function(e,t){const i=new WeakSet,n=(e,t)=>{if("object"==typeof t&&null!==t){if(i.has(t))return `[object ${t.constructor.name}]`;i.add(t);}return t},s=t?` ${JSON.stringify(t,n)}`:"",o=I(e);return e+s+o}(e,i)),this.name="CKEditorError",this.context=t,this.data=i;}is(e){return "CKEditorError"===e}static rethrowUnexpectedError(e,t){if(e.is&&e.is("CKEditorError"))throw e;const i=new E(e.message,t);throw i.stack=e.stack,i}}function T(e,t){console.warn(...P(e,t));}function I(e){return `\nRead more: ${A}#error-${e}`}function P(e,t){const i=I(e);return t?[e,t,i]:[e,i]}const V="43.1.0",R=new Date(2024,8,5);if(globalThis.CKEDITOR_VERSION)throw new E("ckeditor-duplicated-modules",null);globalThis.CKEDITOR_VERSION=V;const B=Symbol("listeningTo"),O=Symbol("emitterId"),M=Symbol("delegations"),L=F(Object);function F(e){if(!e)return L;return class extends e{on(e,t,i){this.listenTo(this,e,t,i);}once(e,t,i){let n=!1;this.listenTo(this,e,((e,...i)=>{n||(n=!0,e.off(),t.call(this,e,...i));}),i);}off(e,t){this.stopListening(this,e,t);}listenTo(e,t,i,n={}){let s,o;this[B]||(this[B]={});const r=this[B];D(e)||N(e);const a=D(e);(s=r[a])||(s=r[a]={emitter:e,callbacks:{}}),(o=s.callbacks[t])||(o=s.callbacks[t]=[]),o.push(i),function(e,t,i,n,s){t._addEventListener?t._addEventListener(i,n,s):e._addEventListener.call(t,i,n,s);}(this,e,t,i,n);}stopListening(e,t,i){const n=this[B];let s=e&&D(e);const o=n&&s?n[s]:void 0,r=o&&t?o.callbacks[t]:void 0;if(!(!n||e&&!o||t&&!r))if(i){W(this,e,t,i);-1!==r.indexOf(i)&&(1===r.length?delete o.callbacks[t]:W(this,e,t,i));}else if(r){for(;i=r.pop();)W(this,e,t,i);delete o.callbacks[t];}else if(o){for(t in o.callbacks)this.stopListening(e,t);delete n[s];}else {for(s in n)this.stopListening(n[s].emitter);delete this[B];}}fire(e,...t){try{const i=e instanceof v?e:new v(this,e),n=i.name;let s=$(this,n);if(i.path.push(this),s){const e=[i,...t];s=Array.from(s);for(let t=0;t<s.length&&(s[t].callback.apply(this,e),i.off.called&&(delete i.off.called,this._removeEventListener(n,s[t].callback)),!i.stop.called);t++);}const o=this[M];if(o){const e=o.get(n),s=o.get("*");e&&U(e,i,t),s&&U(s,i,t);}return i.return}catch(e){E.rethrowUnexpectedError(e,this);}}delegate(...e){return {to:(t,i)=>{this[M]||(this[M]=new Map),e.forEach((e=>{const n=this[M].get(e);n?n.set(t,i):this[M].set(e,new Map([[t,i]]));}));}}}stopDelegating(e,t){if(this[M])if(e)if(t){const i=this[M].get(e);i&&i.delete(t);}else this[M].delete(e);else this[M].clear();}_addEventListener(e,t,i){!function(e,t){const i=z(e);if(i[t])return;let n=t,s=null;const o=[];for(;""!==n&&!i[n];)i[n]={callbacks:[],childEvents:[]},o.push(i[n]),s&&i[n].childEvents.push(s),s=n,n=n.substr(0,n.lastIndexOf(":"));if(""!==n){for(const e of o)e.callbacks=i[n].callbacks.slice();i[n].childEvents.push(s);}}(this,e);const n=H(this,e),s={callback:t,priority:C.get(i.priority)};for(const e of n)x(e,s);}_removeEventListener(e,t){const i=H(this,e);for(const e of i)for(let i=0;i<e.length;i++)e[i].callback==t&&(e.splice(i,1),i--);}}}function N(e,t){e[O]||(e[O]=t||k());}function D(e){return e[O]}function z(e){return e._events||Object.defineProperty(e,"_events",{value:{}}),e._events}function H(e,t){const i=z(e)[t];if(!i)return [];let n=[i.callbacks];for(let t=0;t<i.childEvents.length;t++){const s=H(e,i.childEvents[t]);n=n.concat(s);}return n}function $(e,t){let i;return e._events&&(i=e._events[t])&&i.callbacks.length?i.callbacks:t.indexOf(":")>-1?$(e,t.substr(0,t.lastIndexOf(":"))):null}function U(e,t,i){for(let[n,s]of e){s?"function"==typeof s&&(s=s(t.name)):s=t.name;const e=new v(t.source,s);e.path=[...t.path],n.fire(e,...i);}}function W(e,t,i,n){t._removeEventListener?t._removeEventListener(i,n):e._removeEventListener.call(t,i,n);}["on","once","off","listenTo","stopListening","fire","delegate","stopDelegating","_addEventListener","_removeEventListener"].forEach((e=>{F[e]=L.prototype[e];}));var j="object"==typeof global&&global&&global.Object===Object&&global,q="object"==typeof self&&self&&self.Object===Object&&self,G=j||q||Function("return this")(),K=G.Symbol,Z=Object.prototype,J=Z.hasOwnProperty,Q=Z.toString,Y=K?K.toStringTag:void 0;var X=Object.prototype.toString;var ee="[object Null]",te="[object Undefined]",ie=K?K.toStringTag:void 0;function ne(e){return null==e?void 0===e?te:ee:ie&&ie in Object(e)?function(e){var t=J.call(e,Y),i=e[Y];try{e[Y]=void 0;var n=!0;}catch(e){}var s=Q.call(e);return n&&(t?e[Y]=i:delete e[Y]),s}(e):function(e){return X.call(e)}(e)}function se(e){return null!=e&&"object"==typeof e}var oe="[object Symbol]";function re(e){return "symbol"==typeof e||se(e)&&ne(e)==oe}function ae(e,t){for(var i=-1,n=null==e?0:e.length,s=Array(n);++i<n;)s[i]=t(e[i],i,e);return s}var le=Array.isArray,ce=1/0,de=K?K.prototype:void 0,he=de?de.toString:void 0;function ue(e){if("string"==typeof e)return e;if(le(e))return ae(e,ue)+"";if(re(e))return he?he.call(e):"";var t=e+"";return "0"==t&&1/e==-ce?"-0":t}var me=/\s/;var ge=/^\s+/;function fe(e){return e?e.slice(0,function(e){for(var t=e.length;t--&&me.test(e.charAt(t)););return t}(e)+1).replace(ge,""):e}function pe(e){var t=typeof e;return null!=e&&("object"==t||"function"==t)}var be=NaN,we=/^[-+]0x[0-9a-f]+$/i,_e=/^0b[01]+$/i,ve=/^0o[0-7]+$/i,ye=parseInt;function ke(e){if("number"==typeof e)return e;if(re(e))return be;if(pe(e)){var t="function"==typeof e.valueOf?e.valueOf():e;e=pe(t)?t+"":t;}if("string"!=typeof e)return 0===e?e:+e;e=fe(e);var i=_e.test(e);return i||ve.test(e)?ye(e.slice(2),i?2:8):we.test(e)?be:+e}function Ce(e){return e}var xe="[object AsyncFunction]",Ae="[object Function]",Ee="[object GeneratorFunction]",Te="[object Proxy]";function Se(e){if(!pe(e))return !1;var t=ne(e);return t==Ae||t==Ee||t==xe||t==Te}var Ie=G["__core-js_shared__"],Pe=function(){var e=/[^.]+$/.exec(Ie&&Ie.keys&&Ie.keys.IE_PROTO||"");return e?"Symbol(src)_1."+e:""}();var Ve=Function.prototype.toString;function Re(e){if(null!=e){try{return Ve.call(e)}catch(e){}try{return e+""}catch(e){}}return ""}var Be=/^\[object .+?Constructor\]$/,Oe=Function.prototype,Me=Object.prototype,Le=Oe.toString,Fe=Me.hasOwnProperty,Ne=RegExp("^"+Le.call(Fe).replace(/[\\^$.*+?()[\]{}|]/g,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$");function De(e){return !(!pe(e)||(t=e,Pe&&Pe in t))&&(Se(e)?Ne:Be).test(Re(e));var t;}function ze(e,t){var i=function(e,t){return null==e?void 0:e[t]}(e,t);return De(i)?i:void 0}var He=ze(G,"WeakMap"),$e=Object.create,Ue=function(){function e(){}return function(t){if(!pe(t))return {};if($e)return $e(t);e.prototype=t;var i=new e;return e.prototype=void 0,i}}();function We(e,t){var i=-1,n=e.length;for(t||(t=Array(n));++i<n;)t[i]=e[i];return t}var je=Date.now;var qe=function(){try{var e=ze(Object,"defineProperty");return e({},"",{}),e}catch(e){}}(),Ge=function(e){var t=0,i=0;return function(){var n=je(),s=16-(n-i);if(i=n,s>0){if(++t>=800)return arguments[0]}else t=0;return e.apply(void 0,arguments)}}(qe?function(e,t){return qe(e,"toString",{configurable:!0,enumerable:!1,value:(i=t,function(){return i}),writable:!0});var i;}:Ce);var Ke=9007199254740991,Ze=/^(?:0|[1-9]\d*)$/;function Je(e,t){var i=typeof e;return !!(t=null==t?Ke:t)&&("number"==i||"symbol"!=i&&Ze.test(e))&&e>-1&&e%1==0&&e<t}function Qe(e,t,i){"__proto__"==t&&qe?qe(e,t,{configurable:!0,enumerable:!0,value:i,writable:!0}):e[t]=i;}function Ye(e,t){return e===t||e!=e&&t!=t}var Xe=Object.prototype.hasOwnProperty;function et(e,t,i){var n=e[t];Xe.call(e,t)&&Ye(n,i)&&(void 0!==i||t in e)||Qe(e,t,i);}function tt(e,t,i,n){var s=!i;i||(i={});for(var o=-1,r=t.length;++o<r;){var a=t[o],l=void 0;void 0===l&&(l=e[a]),s?Qe(i,a,l):et(i,a,l);}return i}var it=Math.max;function nt(e,t){return Ge(function(e,t,i){return t=it(void 0===t?e.length-1:t,0),function(){for(var n=arguments,s=-1,o=it(n.length-t,0),r=Array(o);++s<o;)r[s]=n[t+s];s=-1;for(var a=Array(t+1);++s<t;)a[s]=n[s];return a[t]=i(r),function(e,t,i){switch(i.length){case 0:return e.call(t);case 1:return e.call(t,i[0]);case 2:return e.call(t,i[0],i[1]);case 3:return e.call(t,i[0],i[1],i[2])}return e.apply(t,i)}(e,this,a)}}(e,t,Ce),e+"")}var st=9007199254740991;function ot(e){return "number"==typeof e&&e>-1&&e%1==0&&e<=st}function rt(e){return null!=e&&ot(e.length)&&!Se(e)}function at(e){return nt((function(t,i){var n=-1,s=i.length,o=s>1?i[s-1]:void 0,r=s>2?i[2]:void 0;for(o=e.length>3&&"function"==typeof o?(s--,o):void 0,r&&function(e,t,i){if(!pe(i))return !1;var n=typeof t;return !!("number"==n?rt(i)&&Je(t,i.length):"string"==n&&t in i)&&Ye(i[t],e)}(i[0],i[1],r)&&(o=s<3?void 0:o,s=1),t=Object(t);++n<s;){var a=i[n];a&&e(t,a,n,o);}return t}))}var lt=Object.prototype;function ct(e){var t=e&&e.constructor;return e===("function"==typeof t&&t.prototype||lt)}function dt(e){return se(e)&&"[object Arguments]"==ne(e)}var ht=Object.prototype,ut=ht.hasOwnProperty,mt=ht.propertyIsEnumerable,gt=dt(function(){return arguments}())?dt:function(e){return se(e)&&ut.call(e,"callee")&&!mt.call(e,"callee")};var ft="object"==typeof exports&&exports&&!exports.nodeType&&exports,pt=ft&&"object"==typeof module&&module&&!module.nodeType&&module,bt=pt&&pt.exports===ft?G.Buffer:void 0,wt=(bt?bt.isBuffer:void 0)||function(){return !1},_t={};function vt(e){return function(t){return e(t)}}_t["[object Float32Array]"]=_t["[object Float64Array]"]=_t["[object Int8Array]"]=_t["[object Int16Array]"]=_t["[object Int32Array]"]=_t["[object Uint8Array]"]=_t["[object Uint8ClampedArray]"]=_t["[object Uint16Array]"]=_t["[object Uint32Array]"]=!0,_t["[object Arguments]"]=_t["[object Array]"]=_t["[object ArrayBuffer]"]=_t["[object Boolean]"]=_t["[object DataView]"]=_t["[object Date]"]=_t["[object Error]"]=_t["[object Function]"]=_t["[object Map]"]=_t["[object Number]"]=_t["[object Object]"]=_t["[object RegExp]"]=_t["[object Set]"]=_t["[object String]"]=_t["[object WeakMap]"]=!1;var yt="object"==typeof exports&&exports&&!exports.nodeType&&exports,kt=yt&&"object"==typeof module&&module&&!module.nodeType&&module,Ct=kt&&kt.exports===yt&&j.process,xt=function(){try{var e=kt&&kt.require&&kt.require("util").types;return e||Ct&&Ct.binding&&Ct.binding("util")}catch(e){}}(),At=xt&&xt.isTypedArray,Et=At?vt(At):function(e){return se(e)&&ot(e.length)&&!!_t[ne(e)]},Tt=Object.prototype.hasOwnProperty;function St(e,t){var i=le(e),n=!i&&gt(e),s=!i&&!n&&wt(e),o=!i&&!n&&!s&&Et(e),r=i||n||s||o,a=r?function(e,t){for(var i=-1,n=Array(e);++i<e;)n[i]=t(i);return n}(e.length,String):[],l=a.length;for(var c in e)!t&&!Tt.call(e,c)||r&&("length"==c||s&&("offset"==c||"parent"==c)||o&&("buffer"==c||"byteLength"==c||"byteOffset"==c)||Je(c,l))||a.push(c);return a}function It(e,t){return function(i){return e(t(i))}}var Pt=It(Object.keys,Object),Vt=Object.prototype.hasOwnProperty;function Rt(e){return rt(e)?St(e):function(e){if(!ct(e))return Pt(e);var t=[];for(var i in Object(e))Vt.call(e,i)&&"constructor"!=i&&t.push(i);return t}(e)}var Bt=Object.prototype.hasOwnProperty;function Ot(e){if(!pe(e))return function(e){var t=[];if(null!=e)for(var i in Object(e))t.push(i);return t}(e);var t=ct(e),i=[];for(var n in e)("constructor"!=n||!t&&Bt.call(e,n))&&i.push(n);return i}function Mt(e){return rt(e)?St(e,!0):Ot(e)}var Lt=at((function(e,t){tt(t,Mt(t),e);})),Ft=/\.|\[(?:[^[\]]*|(["'])(?:(?!\1)[^\\]|\\.)*?\1)\]/,Nt=/^\w*$/;function Dt(e,t){if(le(e))return !1;var i=typeof e;return !("number"!=i&&"symbol"!=i&&"boolean"!=i&&null!=e&&!re(e))||(Nt.test(e)||!Ft.test(e)||null!=t&&e in Object(t))}var zt=ze(Object,"create");var Ht=Object.prototype.hasOwnProperty;var $t=Object.prototype.hasOwnProperty;function Ut(e){var t=-1,i=null==e?0:e.length;for(this.clear();++t<i;){var n=e[t];this.set(n[0],n[1]);}}function Wt(e,t){for(var i=e.length;i--;)if(Ye(e[i][0],t))return i;return -1}Ut.prototype.clear=function(){this.__data__=zt?zt(null):{},this.size=0;},Ut.prototype.delete=function(e){var t=this.has(e)&&delete this.__data__[e];return this.size-=t?1:0,t},Ut.prototype.get=function(e){var t=this.__data__;if(zt){var i=t[e];return "__lodash_hash_undefined__"===i?void 0:i}return Ht.call(t,e)?t[e]:void 0},Ut.prototype.has=function(e){var t=this.__data__;return zt?void 0!==t[e]:$t.call(t,e)},Ut.prototype.set=function(e,t){var i=this.__data__;return this.size+=this.has(e)?0:1,i[e]=zt&&void 0===t?"__lodash_hash_undefined__":t,this};var jt=Array.prototype.splice;function qt(e){var t=-1,i=null==e?0:e.length;for(this.clear();++t<i;){var n=e[t];this.set(n[0],n[1]);}}qt.prototype.clear=function(){this.__data__=[],this.size=0;},qt.prototype.delete=function(e){var t=this.__data__,i=Wt(t,e);return !(i<0)&&(i==t.length-1?t.pop():jt.call(t,i,1),--this.size,!0)},qt.prototype.get=function(e){var t=this.__data__,i=Wt(t,e);return i<0?void 0:t[i][1]},qt.prototype.has=function(e){return Wt(this.__data__,e)>-1},qt.prototype.set=function(e,t){var i=this.__data__,n=Wt(i,e);return n<0?(++this.size,i.push([e,t])):i[n][1]=t,this};var Gt=ze(G,"Map");function Kt(e,t){var i,n,s=e.__data__;return ("string"==(n=typeof(i=t))||"number"==n||"symbol"==n||"boolean"==n?"__proto__"!==i:null===i)?s["string"==typeof t?"string":"hash"]:s.map}function Zt(e){var t=-1,i=null==e?0:e.length;for(this.clear();++t<i;){var n=e[t];this.set(n[0],n[1]);}}Zt.prototype.clear=function(){this.size=0,this.__data__={hash:new Ut,map:new(Gt||qt),string:new Ut};},Zt.prototype.delete=function(e){var t=Kt(this,e).delete(e);return this.size-=t?1:0,t},Zt.prototype.get=function(e){return Kt(this,e).get(e)},Zt.prototype.has=function(e){return Kt(this,e).has(e)},Zt.prototype.set=function(e,t){var i=Kt(this,e),n=i.size;return i.set(e,t),this.size+=i.size==n?0:1,this};var Jt="Expected a function";function Qt(e,t){if("function"!=typeof e||null!=t&&"function"!=typeof t)throw new TypeError(Jt);var i=function(){var n=arguments,s=t?t.apply(this,n):n[0],o=i.cache;if(o.has(s))return o.get(s);var r=e.apply(this,n);return i.cache=o.set(s,r)||o,r};return i.cache=new(Qt.Cache||Zt),i}Qt.Cache=Zt;var Yt=/[^.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|$))/g,Xt=/\\(\\)?/g,ei=function(e){var t=Qt(e,(function(e){return 500===i.size&&i.clear(),e})),i=t.cache;return t}((function(e){var t=[];return 46===e.charCodeAt(0)&&t.push(""),e.replace(Yt,(function(e,i,n,s){t.push(n?s.replace(Xt,"$1"):i||e);})),t}));function ti(e){return null==e?"":ue(e)}function ii(e,t){return le(e)?e:Dt(e,t)?[e]:ei(ti(e))}var ni=1/0;function si(e){if("string"==typeof e||re(e))return e;var t=e+"";return "0"==t&&1/e==-ni?"-0":t}function oi(e,t){for(var i=0,n=(t=ii(t,e)).length;null!=e&&i<n;)e=e[si(t[i++])];return i&&i==n?e:void 0}function ri(e,t,i){var n=null==e?void 0:oi(e,t);return void 0===n?i:n}function ai(e,t){for(var i=-1,n=t.length,s=e.length;++i<n;)e[s+i]=t[i];return e}var li=It(Object.getPrototypeOf,Object),ci="[object Object]",di=Function.prototype,hi=Object.prototype,ui=di.toString,mi=hi.hasOwnProperty,gi=ui.call(Object);function fi(e){if(!se(e)||ne(e)!=ci)return !1;var t=li(e);if(null===t)return !0;var i=mi.call(t,"constructor")&&t.constructor;return "function"==typeof i&&i instanceof i&&ui.call(i)==gi}function pi(e,t,i){var n=-1,s=e.length;t<0&&(t=-t>s?0:s+t),(i=i>s?s:i)<0&&(i+=s),s=t>i?0:i-t>>>0,t>>>=0;for(var o=Array(s);++n<s;)o[n]=e[n+t];return o}var bi=RegExp("[\\u200d\\ud800-\\udfff\\u0300-\\u036f\\ufe20-\\ufe2f\\u20d0-\\u20ff\\ufe0e\\ufe0f]");function wi(e){return bi.test(e)}var _i="\\ud800-\\udfff",vi="["+_i+"]",yi="[\\u0300-\\u036f\\ufe20-\\ufe2f\\u20d0-\\u20ff]",ki="\\ud83c[\\udffb-\\udfff]",Ci="[^"+_i+"]",xi="(?:\\ud83c[\\udde6-\\uddff]){2}",Ai="[\\ud800-\\udbff][\\udc00-\\udfff]",Ei="(?:"+yi+"|"+ki+")"+"?",Ti="[\\ufe0e\\ufe0f]?",Si=Ti+Ei+("(?:\\u200d(?:"+[Ci,xi,Ai].join("|")+")"+Ti+Ei+")*"),Ii="(?:"+[Ci+yi+"?",yi,xi,Ai,vi].join("|")+")",Pi=RegExp(ki+"(?="+ki+")|"+Ii+Si,"g");function Vi(e){return wi(e)?function(e){return e.match(Pi)||[]}(e):function(e){return e.split("")}(e)}var Ri,Bi=(Ri="toUpperCase",function(e){var t,i,n,s,o=wi(e=ti(e))?Vi(e):void 0,r=o?o[0]:e.charAt(0),a=o?(t=o,i=1,s=t.length,n=void 0===n?s:n,!i&&n>=s?t:pi(t,i,n)).join(""):e.slice(1);return r[Ri]()+a});function hn(e){var t=this.__data__=new qt(e);this.size=t.size;}hn.prototype.clear=function(){this.__data__=new qt,this.size=0;},hn.prototype.delete=function(e){var t=this.__data__,i=t.delete(e);return this.size=t.size,i},hn.prototype.get=function(e){return this.__data__.get(e)},hn.prototype.has=function(e){return this.__data__.has(e)},hn.prototype.set=function(e,t){var i=this.__data__;if(i instanceof qt){var n=i.__data__;if(!Gt||n.length<199)return n.push([e,t]),this.size=++i.size,this;i=this.__data__=new Zt(n);}return i.set(e,t),this.size=i.size,this};var un="object"==typeof exports&&exports&&!exports.nodeType&&exports,mn=un&&"object"==typeof module&&module&&!module.nodeType&&module,gn=mn&&mn.exports===un?G.Buffer:void 0,fn=gn?gn.allocUnsafe:void 0;function pn(e,t){if(t)return e.slice();var i=e.length,n=fn?fn(i):new e.constructor(i);return e.copy(n),n}function bn(){return []}var wn=Object.prototype.propertyIsEnumerable,_n=Object.getOwnPropertySymbols,vn=_n?function(e){return null==e?[]:(e=Object(e),function(e,t){for(var i=-1,n=null==e?0:e.length,s=0,o=[];++i<n;){var r=e[i];t(r,i,e)&&(o[s++]=r);}return o}(_n(e),(function(t){return wn.call(e,t)})))}:bn;var yn=Object.getOwnPropertySymbols?function(e){for(var t=[];e;)ai(t,vn(e)),e=li(e);return t}:bn;function kn(e,t,i){var n=t(e);return le(e)?n:ai(n,i(e))}function Cn(e){return kn(e,Rt,vn)}function xn(e){return kn(e,Mt,yn)}var An=ze(G,"DataView"),En=ze(G,"Promise"),Tn=ze(G,"Set"),Sn="[object Map]",In="[object Promise]",Pn="[object Set]",Vn="[object WeakMap]",Rn="[object DataView]",Bn=Re(An),On=Re(Gt),Mn=Re(En),Ln=Re(Tn),Fn=Re(He),Nn=ne;(An&&Nn(new An(new ArrayBuffer(1)))!=Rn||Gt&&Nn(new Gt)!=Sn||En&&Nn(En.resolve())!=In||Tn&&Nn(new Tn)!=Pn||He&&Nn(new He)!=Vn)&&(Nn=function(e){var t=ne(e),i="[object Object]"==t?e.constructor:void 0,n=i?Re(i):"";if(n)switch(n){case Bn:return Rn;case On:return Sn;case Mn:return In;case Ln:return Pn;case Fn:return Vn}return t});var Dn=Object.prototype.hasOwnProperty;var zn=G.Uint8Array;function Hn(e){var t=new e.constructor(e.byteLength);return new zn(t).set(new zn(e)),t}var $n=/\w*$/;var Un=K?K.prototype:void 0,Wn=Un?Un.valueOf:void 0;function jn(e,t){var i=t?Hn(e.buffer):e.buffer;return new e.constructor(i,e.byteOffset,e.length)}var qn="[object Boolean]",Gn="[object Date]",Kn="[object Map]",Zn="[object Number]",Jn="[object RegExp]",Qn="[object Set]",Yn="[object String]",Xn="[object Symbol]",es="[object ArrayBuffer]",ts="[object DataView]",is="[object Float32Array]",ns="[object Float64Array]",ss="[object Int8Array]",os="[object Int16Array]",rs="[object Int32Array]",as="[object Uint8Array]",ls="[object Uint8ClampedArray]",cs="[object Uint16Array]",ds="[object Uint32Array]";function hs(e,t,i){var n,s,o,r=e.constructor;switch(t){case es:return Hn(e);case qn:case Gn:return new r(+e);case ts:return function(e,t){var i=t?Hn(e.buffer):e.buffer;return new e.constructor(i,e.byteOffset,e.byteLength)}(e,i);case is:case ns:case ss:case os:case rs:case as:case ls:case cs:case ds:return jn(e,i);case Kn:return new r;case Zn:case Yn:return new r(e);case Jn:return (o=new(s=e).constructor(s.source,$n.exec(s))).lastIndex=s.lastIndex,o;case Qn:return new r;case Xn:return n=e,Wn?Object(Wn.call(n)):{}}}function us(e){return "function"!=typeof e.constructor||ct(e)?{}:Ue(li(e))}var ms=xt&&xt.isMap,gs=ms?vt(ms):function(e){return se(e)&&"[object Map]"==Nn(e)};var fs=xt&&xt.isSet,ps=fs?vt(fs):function(e){return se(e)&&"[object Set]"==Nn(e)},bs=1,ws=2,_s=4,vs="[object Arguments]",ys="[object Function]",ks="[object GeneratorFunction]",Cs="[object Object]",xs={};function As(e,t,i,n,s,o){var r,a=t&bs,l=t&ws,c=t&_s;if(i&&(r=s?i(e,n,s,o):i(e)),void 0!==r)return r;if(!pe(e))return e;var d=le(e);if(d){if(r=function(e){var t=e.length,i=new e.constructor(t);return t&&"string"==typeof e[0]&&Dn.call(e,"index")&&(i.index=e.index,i.input=e.input),i}(e),!a)return We(e,r)}else {var h=Nn(e),u=h==ys||h==ks;if(wt(e))return pn(e,a);if(h==Cs||h==vs||u&&!s){if(r=l||u?{}:us(e),!a)return l?function(e,t){return tt(e,yn(e),t)}(e,function(e,t){return e&&tt(t,Mt(t),e)}(r,e)):function(e,t){return tt(e,vn(e),t)}(e,function(e,t){return e&&tt(t,Rt(t),e)}(r,e))}else {if(!xs[h])return s?e:{};r=hs(e,h,a);}}o||(o=new hn);var m=o.get(e);if(m)return m;o.set(e,r),ps(e)?e.forEach((function(n){r.add(As(n,t,i,n,e,o));})):gs(e)&&e.forEach((function(n,s){r.set(s,As(n,t,i,s,e,o));}));var g=d?void 0:(c?l?xn:Cn:l?Mt:Rt)(e);return function(e,t){for(var i=-1,n=null==e?0:e.length;++i<n&&!1!==t(e[i],i,e););}(g||e,(function(n,s){g&&(n=e[s=n]),et(r,s,As(n,t,i,s,e,o));})),r}xs[vs]=xs["[object Array]"]=xs["[object ArrayBuffer]"]=xs["[object DataView]"]=xs["[object Boolean]"]=xs["[object Date]"]=xs["[object Float32Array]"]=xs["[object Float64Array]"]=xs["[object Int8Array]"]=xs["[object Int16Array]"]=xs["[object Int32Array]"]=xs["[object Map]"]=xs["[object Number]"]=xs[Cs]=xs["[object RegExp]"]=xs["[object Set]"]=xs["[object String]"]=xs["[object Symbol]"]=xs["[object Uint8Array]"]=xs["[object Uint8ClampedArray]"]=xs["[object Uint16Array]"]=xs["[object Uint32Array]"]=!0,xs["[object Error]"]=xs[ys]=xs["[object WeakMap]"]=!1;function Es(e){return As(e,4)}var Ts=1,Ss=4;function Is(e){return As(e,Ts|Ss)}var Ps=1,Vs=4;function Rs(e,t){return As(e,Ps|Vs,t="function"==typeof t?t:void 0)}function Bs(e){var t=-1,i=null==e?0:e.length;for(this.__data__=new Zt;++t<i;)this.add(e[t]);}function Os(e,t){for(var i=-1,n=null==e?0:e.length;++i<n;)if(t(e[i],i,e))return !0;return !1}function Ms(e,t){return e.has(t)}Bs.prototype.add=Bs.prototype.push=function(e){return this.__data__.set(e,"__lodash_hash_undefined__"),this},Bs.prototype.has=function(e){return this.__data__.has(e)};var Ls=1,Fs=2;function Ns(e,t,i,n,s,o){var r=i&Ls,a=e.length,l=t.length;if(a!=l&&!(r&&l>a))return !1;var c=o.get(e),d=o.get(t);if(c&&d)return c==t&&d==e;var h=-1,u=!0,m=i&Fs?new Bs:void 0;for(o.set(e,t),o.set(t,e);++h<a;){var g=e[h],f=t[h];if(n)var p=r?n(f,g,h,t,e,o):n(g,f,h,e,t,o);if(void 0!==p){if(p)continue;u=!1;break}if(m){if(!Os(t,(function(e,t){if(!Ms(m,t)&&(g===e||s(g,e,i,n,o)))return m.push(t)}))){u=!1;break}}else if(g!==f&&!s(g,f,i,n,o)){u=!1;break}}return o.delete(e),o.delete(t),u}function Ds(e){var t=-1,i=Array(e.size);return e.forEach((function(e,n){i[++t]=[n,e];})),i}function zs(e){var t=-1,i=Array(e.size);return e.forEach((function(e){i[++t]=e;})),i}var Hs=1,$s=2,Us="[object Boolean]",Ws="[object Date]",js="[object Error]",qs="[object Map]",Gs="[object Number]",Ks="[object RegExp]",Zs="[object Set]",Js="[object String]",Qs="[object Symbol]",Ys="[object ArrayBuffer]",Xs="[object DataView]",eo=K?K.prototype:void 0,to=eo?eo.valueOf:void 0;var io=1,no=Object.prototype.hasOwnProperty;var so=1,oo="[object Arguments]",ro="[object Array]",ao="[object Object]",lo=Object.prototype.hasOwnProperty;function co(e,t,i,n,s,o){var r=le(e),a=le(t),l=r?ro:Nn(e),c=a?ro:Nn(t),d=(l=l==oo?ao:l)==ao,h=(c=c==oo?ao:c)==ao,u=l==c;if(u&&wt(e)){if(!wt(t))return !1;r=!0,d=!1;}if(u&&!d)return o||(o=new hn),r||Et(e)?Ns(e,t,i,n,s,o):function(e,t,i,n,s,o,r){switch(i){case Xs:if(e.byteLength!=t.byteLength||e.byteOffset!=t.byteOffset)return !1;e=e.buffer,t=t.buffer;case Ys:return !(e.byteLength!=t.byteLength||!o(new zn(e),new zn(t)));case Us:case Ws:case Gs:return Ye(+e,+t);case js:return e.name==t.name&&e.message==t.message;case Ks:case Js:return e==t+"";case qs:var a=Ds;case Zs:var l=n&Hs;if(a||(a=zs),e.size!=t.size&&!l)return !1;var c=r.get(e);if(c)return c==t;n|=$s,r.set(e,t);var d=Ns(a(e),a(t),n,s,o,r);return r.delete(e),d;case Qs:if(to)return to.call(e)==to.call(t)}return !1}(e,t,l,i,n,s,o);if(!(i&so)){var m=d&&lo.call(e,"__wrapped__"),g=h&&lo.call(t,"__wrapped__");if(m||g){var f=m?e.value():e,p=g?t.value():t;return o||(o=new hn),s(f,p,i,n,o)}}return !!u&&(o||(o=new hn),function(e,t,i,n,s,o){var r=i&io,a=Cn(e),l=a.length;if(l!=Cn(t).length&&!r)return !1;for(var c=l;c--;){var d=a[c];if(!(r?d in t:no.call(t,d)))return !1}var h=o.get(e),u=o.get(t);if(h&&u)return h==t&&u==e;var m=!0;o.set(e,t),o.set(t,e);for(var g=r;++c<l;){var f=e[d=a[c]],p=t[d];if(n)var b=r?n(p,f,d,t,e,o):n(f,p,d,e,t,o);if(!(void 0===b?f===p||s(f,p,i,n,o):b)){m=!1;break}g||(g="constructor"==d);}if(m&&!g){var w=e.constructor,_=t.constructor;w==_||!("constructor"in e)||!("constructor"in t)||"function"==typeof w&&w instanceof w&&"function"==typeof _&&_ instanceof _||(m=!1);}return o.delete(e),o.delete(t),m}(e,t,i,n,s,o))}function ho(e,t,i,n,s){return e===t||(null==e||null==t||!se(e)&&!se(t)?e!=e&&t!=t:co(e,t,i,n,ho,s))}var uo=1,mo=2;function go(e){return e==e&&!pe(e)}function fo(e,t){return function(i){return null!=i&&(i[e]===t&&(void 0!==t||e in Object(i)))}}function po(e){var t=function(e){for(var t=Rt(e),i=t.length;i--;){var n=t[i],s=e[n];t[i]=[n,s,go(s)];}return t}(e);return 1==t.length&&t[0][2]?fo(t[0][0],t[0][1]):function(i){return i===e||function(e,t,i,n){var s=i.length,o=s;if(null==e)return !o;for(e=Object(e);s--;){var r=i[s];if(r[2]?r[1]!==e[r[0]]:!(r[0]in e))return !1}for(;++s<o;){var a=(r=i[s])[0],l=e[a],c=r[1];if(r[2]){if(void 0===l&&!(a in e))return !1}else {var d=new hn;if(!ho(c,l,uo|mo,n,d))return !1}}return !0}(i,0,t)}}function bo(e,t){return null!=e&&t in Object(e)}function wo(e,t){return null!=e&&function(e,t,i){for(var n=-1,s=(t=ii(t,e)).length,o=!1;++n<s;){var r=si(t[n]);if(!(o=null!=e&&i(e,r)))break;e=e[r];}return o||++n!=s?o:!!(s=null==e?0:e.length)&&ot(s)&&Je(r,s)&&(le(e)||gt(e))}(e,t,bo)}var _o=1,vo=2;function yo(e){return Dt(e)?(t=si(e),function(e){return null==e?void 0:e[t]}):function(e){return function(t){return oi(t,e)}}(e);var t;}function ko(e){return "function"==typeof e?e:null==e?Ce:"object"==typeof e?le(e)?(t=e[0],i=e[1],Dt(t)&&go(i)?fo(si(t),i):function(e){var n=ri(e,t);return void 0===n&&n===i?wo(e,t):ho(i,n,_o|vo)}):po(e):yo(e);var t,i;}var Co=function(e,t,i){for(var n=-1,s=Object(e),o=i(e),r=o.length;r--;){var a=o[++n];if(!1===t(s[a],a,s))break}return e};function xo(e,t){return e&&Co(e,t,Rt)}var Ao,Eo=(Ao=xo,function(e,t){if(null==e)return e;if(!rt(e))return Ao(e,t);for(var i=e.length,n=-1,s=Object(e);++n<i&&!1!==t(s[n],n,s););return e}),To=function(){return G.Date.now()},So="Expected a function",Io=Math.max,Po=Math.min;function Vo(e,t,i){var n,s,o,r,a,l,c=0,d=!1,h=!1,u=!0;if("function"!=typeof e)throw new TypeError(So);function m(t){var i=n,o=s;return n=s=void 0,c=t,r=e.apply(o,i)}function g(e){var i=e-l;return void 0===l||i>=t||i<0||h&&e-c>=o}function f(){var e=To();if(g(e))return p(e);a=setTimeout(f,function(e){var i=t-(e-l);return h?Po(i,o-(e-c)):i}(e));}function p(e){return a=void 0,u&&n?m(e):(n=s=void 0,r)}function b(){var e=To(),i=g(e);if(n=arguments,s=this,l=e,i){if(void 0===a)return function(e){return c=e,a=setTimeout(f,t),d?m(e):r}(l);if(h)return clearTimeout(a),a=setTimeout(f,t),m(l)}return void 0===a&&(a=setTimeout(f,t)),r}return t=ke(t)||0,pe(i)&&(d=!!i.leading,o=(h="maxWait"in i)?Io(ke(i.maxWait)||0,t):o,u="trailing"in i?!!i.trailing:u),b.cancel=function(){void 0!==a&&clearTimeout(a),c=0,n=l=s=a=void 0;},b.flush=function(){return void 0===a?r:p(To())},b}function Ro(e,t,i){(void 0!==i&&!Ye(e[t],i)||void 0===i&&!(t in e))&&Qe(e,t,i);}function Bo(e,t){if(("constructor"!==t||"function"!=typeof e[t])&&"__proto__"!=t)return e[t]}function Oo(e,t,i,n,s,o,r){var a=Bo(e,i),l=Bo(t,i),c=r.get(l);if(c)Ro(e,i,c);else {var d,h=o?o(a,l,i+"",e,t,r):void 0,u=void 0===h;if(u){var m=le(l),g=!m&&wt(l),f=!m&&!g&&Et(l);h=l,m||g||f?le(a)?h=a:se(d=a)&&rt(d)?h=We(a):g?(u=!1,h=pn(l,!0)):f?(u=!1,h=jn(l,!0)):h=[]:fi(l)||gt(l)?(h=a,gt(a)?h=function(e){return tt(e,Mt(e))}(a):pe(a)&&!Se(a)||(h=us(l))):u=!1;}u&&(r.set(l,h),s(h,l,n,o,r),r.delete(l)),Ro(e,i,h);}}function Mo(e,t,i,n,s){e!==t&&Co(t,(function(o,r){if(s||(s=new hn),pe(o))Oo(e,t,r,i,Mo,n,s);else {var a=n?n(Bo(e,r),o,r+"",e,t,s):void 0;void 0===a&&(a=o),Ro(e,r,a);}}),Mt);}at((function(e,t,i,n){Mo(e,t,i,n);}));function Wo(e,t){var i=-1,n=rt(e)?Array(e.length):[];return Eo(e,(function(e,s,o){n[++i]=t(e,s,o);})),n}var jo="[object String]";function qo(e){return "string"==typeof e||!le(e)&&se(e)&&ne(e)==jo}function Go(e){return se(e)&&1===e.nodeType&&!fi(e)}function Ko(e,t){return ho(e,t)}var Zo=at((function(e,t,i){Mo(e,t,i);}));function Jo(e,t){return null==(e=function(e,t){return t.length<2?e:oi(e,pi(t,0,-1))}(e,t=ii(t,e)))||delete e[si((i=t,n=null==i?0:i.length,n?i[n-1]:void 0))];var i,n;}function Qo(e,t,i){return null==e?e:function(e,t,i){if(!pe(e))return e;for(var n=-1,s=(t=ii(t,e)).length,o=s-1,r=e;null!=r&&++n<s;){var a=si(t[n]),l=i;if("__proto__"===a||"constructor"===a||"prototype"===a)return e;if(n!=o){var c=r[a];void 0===(l=void 0)&&(l=pe(c)?c:Je(t[n+1])?[]:{});}et(r,a,l),r=r[a];}return e}(e,t,i)}function er(e,t,i){var n=!0,s=!0;if("function"!=typeof e)throw new TypeError("Expected a function");return pe(i)&&(n="leading"in i?!!i.leading:n,s="trailing"in i?!!i.trailing:s),Vo(e,t,{leading:n,maxWait:t,trailing:s})}const tr=Symbol("observableProperties"),ir=Symbol("boundObservables"),nr=Symbol("boundProperties"),sr=Symbol("decoratedMethods"),or=Symbol("decoratedOriginal"),rr=ar(F());function ar(e){if(!e)return rr;return class extends e{set(e,t){if(pe(e))return void Object.keys(e).forEach((t=>{this.set(t,e[t]);}),this);lr(this);const i=this[tr];if(e in this&&!i.has(e))throw new E("observable-set-cannot-override",this);Object.defineProperty(this,e,{enumerable:!0,configurable:!0,get:()=>i.get(e),set(t){const n=i.get(e);let s=this.fire(`set:${e}`,e,t,n);void 0===s&&(s=t),n===s&&i.has(e)||(i.set(e,s),this.fire(`change:${e}`,e,s,n));}}),this[e]=t;}bind(...e){if(!e.length||!hr(e))throw new E("observable-bind-wrong-properties",this);if(new Set(e).size!==e.length)throw new E("observable-bind-duplicate-properties",this);lr(this);const t=this[nr];e.forEach((e=>{if(t.has(e))throw new E("observable-bind-rebind",this)}));const i=new Map;return e.forEach((e=>{const n={property:e,to:[]};t.set(e,n),i.set(e,n);})),{to:cr,toMany:dr,_observable:this,_bindProperties:e,_to:[],_bindings:i}}unbind(...e){if(!this[tr])return;const t=this[nr],i=this[ir];if(e.length){if(!hr(e))throw new E("observable-unbind-wrong-properties",this);e.forEach((e=>{const n=t.get(e);n&&(n.to.forEach((([e,t])=>{const s=i.get(e),o=s[t];o.delete(n),o.size||delete s[t],Object.keys(s).length||(i.delete(e),this.stopListening(e,"change"));})),t.delete(e));}));}else i.forEach(((e,t)=>{this.stopListening(t,"change");})),i.clear(),t.clear();}decorate(e){lr(this);const t=this[e];if(!t)throw new E("observablemixin-cannot-decorate-undefined",this,{object:this,methodName:e});this.on(e,((e,i)=>{e.return=t.apply(this,i);})),this[e]=function(...t){return this.fire(e,t)},this[e][or]=t,this[sr]||(this[sr]=[]),this[sr].push(e);}stopListening(e,t,i){if(!e&&this[sr]){for(const e of this[sr])this[e]=this[e][or];delete this[sr];}super.stopListening(e,t,i);}[tr];[sr];[nr];[ir]}}function lr(e){e[tr]||(Object.defineProperty(e,tr,{value:new Map}),Object.defineProperty(e,ir,{value:new Map}),Object.defineProperty(e,nr,{value:new Map}));}function cr(...e){const t=function(...e){if(!e.length)throw new E("observable-bind-to-parse-error",null);const t={to:[]};let i;"function"==typeof e[e.length-1]&&(t.callback=e.pop());return e.forEach((e=>{if("string"==typeof e)i.properties.push(e);else {if("object"!=typeof e)throw new E("observable-bind-to-parse-error",null);i={observable:e,properties:[]},t.to.push(i);}})),t}(...e),i=Array.from(this._bindings.keys()),n=i.length;if(!t.callback&&t.to.length>1)throw new E("observable-bind-to-no-callback",this);if(n>1&&t.callback)throw new E("observable-bind-to-extra-callback",this);var s;t.to.forEach((e=>{if(e.properties.length&&e.properties.length!==n)throw new E("observable-bind-to-properties-length",this);e.properties.length||(e.properties=this._bindProperties);})),this._to=t.to,t.callback&&(this._bindings.get(i[0]).callback=t.callback),s=this._observable,this._to.forEach((e=>{const t=s[ir];let i;t.get(e.observable)||s.listenTo(e.observable,"change",((n,o)=>{i=t.get(e.observable)[o],i&&i.forEach((e=>{ur(s,e.property);}));}));})),function(e){let t;e._bindings.forEach(((i,n)=>{e._to.forEach((s=>{t=s.properties[i.callback?0:e._bindProperties.indexOf(n)],i.to.push([s.observable,t]),function(e,t,i,n){const s=e[ir],o=s.get(i),r=o||{};r[n]||(r[n]=new Set);r[n].add(t),o||s.set(i,r);}(e._observable,i,s.observable,t);}));}));}(this),this._bindProperties.forEach((e=>{ur(this._observable,e);}));}function dr(e,t,i){if(this._bindings.size>1)throw new E("observable-bind-to-many-not-one-binding",this);this.to(...function(e,t){const i=e.map((e=>[e,t]));return Array.prototype.concat.apply([],i)}(e,t),i);}function hr(e){return e.every((e=>"string"==typeof e))}function ur(e,t){const i=e[nr].get(t);let n;i.callback?n=i.callback.apply(e,i.to.map((e=>e[0][e[1]]))):(n=i.to[0],n=n[0][n[1]]),Object.prototype.hasOwnProperty.call(e,t)?e[t]=n:e.set(t,n);}["set","bind","unbind","decorate","on","once","off","listenTo","stopListening","fire","delegate","stopDelegating","_addEventListener","_removeEventListener"].forEach((e=>{ar[e]=rr.prototype[e];}));class mr{_replacedElements;constructor(){this._replacedElements=[];}replace(e,t){this._replacedElements.push({element:e,newElement:t}),e.style.display="none",t&&e.parentNode.insertBefore(t,e.nextSibling);}restore(){this._replacedElements.forEach((({element:e,newElement:t})=>{e.style.display="",t&&t.remove();})),this._replacedElements=[];}}function fr(e){let t=0;for(const i of e)t++;return t}function pr(e,t){const i=Math.min(e.length,t.length);for(let n=0;n<i;n++)if(e[n]!=t[n])return n;return e.length==t.length?"same":e.length<t.length?"prefix":"extension"}function br(e){return !(!e||!e[Symbol.iterator])}function wr(e,t,i={},n=[]){const s=i&&i.xmlns,o=s?e.createElementNS(s,t):e.createElement(t);for(const e in i)o.setAttribute(e,i[e]);!qo(n)&&br(n)||(n=[n]);for(let t of n)qo(t)&&(t=e.createTextNode(t)),o.appendChild(t);return o}class _r{_config;constructor(e,t){this._config={},t&&this.define(vr(t)),e&&this._setObjectToTarget(this._config,e);}set(e,t){this._setToTarget(this._config,e,t);}define(e,t){this._setToTarget(this._config,e,t,!0);}get(e){return this._getFromSource(this._config,e)}*names(){for(const e of Object.keys(this._config))yield e;}_setToTarget(e,t,i,n=!1){if(fi(t))return void this._setObjectToTarget(e,t,n);const s=t.split(".");t=s.pop();for(const t of s)fi(e[t])||(e[t]={}),e=e[t];if(fi(i))return fi(e[t])||(e[t]={}),e=e[t],void this._setObjectToTarget(e,i,n);n&&void 0!==e[t]||(e[t]=i);}_getFromSource(e,t){const i=t.split(".");t=i.pop();for(const t of i){if(!fi(e[t])){e=null;break}e=e[t];}return e?vr(e[t]):void 0}_setObjectToTarget(e,t,i){Object.keys(t).forEach((n=>{this._setToTarget(e,n,t[n],i);}));}}function vr(e){return Rs(e,yr)}function yr(e){return Go(e)||"function"==typeof e?e:void 0}function kr(e){if(e){if(e.defaultView)return e instanceof e.defaultView.Document;if(e.ownerDocument&&e.ownerDocument.defaultView)return e instanceof e.ownerDocument.defaultView.Node}return !1}function Cr(e){const t=Object.prototype.toString.apply(e);return "[object Window]"==t||"[object global]"==t}const xr=Ar(F());function Ar(e){if(!e)return xr;return class extends e{listenTo(e,t,i,n={}){if(kr(e)||Cr(e)){const s={capture:!!n.useCapture,passive:!!n.usePassive},o=this._getProxyEmitter(e,s)||new Er(e,s);this.listenTo(o,t,i,n);}else super.listenTo(e,t,i,n);}stopListening(e,t,i){if(kr(e)||Cr(e)){const n=this._getAllProxyEmitters(e);for(const e of n)this.stopListening(e,t,i);}else super.stopListening(e,t,i);}_getProxyEmitter(e,t){return function(e,t){const i=e[B];return i&&i[t]?i[t].emitter:null}(this,Tr(e,t))}_getAllProxyEmitters(e){return [{capture:!1,passive:!1},{capture:!1,passive:!0},{capture:!0,passive:!1},{capture:!0,passive:!0}].map((t=>this._getProxyEmitter(e,t))).filter((e=>!!e))}}}["_getProxyEmitter","_getAllProxyEmitters","on","once","off","listenTo","stopListening","fire","delegate","stopDelegating","_addEventListener","_removeEventListener"].forEach((e=>{Ar[e]=xr.prototype[e];}));class Er extends(F()){_domNode;_options;constructor(e,t){super(),N(this,Tr(e,t)),this._domNode=e,this._options=t;}_domListeners;attach(e){if(this._domListeners&&this._domListeners[e])return;const t=this._createDomListener(e);this._domNode.addEventListener(e,t,this._options),this._domListeners||(this._domListeners={}),this._domListeners[e]=t;}detach(e){let t;!this._domListeners[e]||(t=this._events[e])&&t.callbacks.length||this._domListeners[e].removeListener();}_addEventListener(e,t,i){this.attach(e),F().prototype._addEventListener.call(this,e,t,i);}_removeEventListener(e,t){F().prototype._removeEventListener.call(this,e,t),this.detach(e);}_createDomListener(e){const t=t=>{this.fire(e,t);};return t.removeListener=()=>{this._domNode.removeEventListener(e,t,this._options),delete this._domListeners[e];},t}}function Tr(e,t){let i=function(e){return e["data-ck-expando"]||(e["data-ck-expando"]=k())}(e);for(const e of Object.keys(t).sort())t[e]&&(i+="-"+e);return i}function Ir(e){const t=[];let i=e;for(;i&&i.nodeType!=Node.DOCUMENT_NODE;)t.unshift(i),i=i.parentNode;return t}function Pr(e){return e instanceof HTMLTextAreaElement?e.value:e.innerHTML}function Vr(e){const t=e.ownerDocument.defaultView.getComputedStyle(e);return {top:parseInt(t.borderTopWidth,10),right:parseInt(t.borderRightWidth,10),bottom:parseInt(t.borderBottomWidth,10),left:parseInt(t.borderLeftWidth,10)}}function Rr(e){if(!e.target)return null;const t=e.target.ownerDocument,i=e.clientX,n=e.clientY;let s=null;return t.caretRangeFromPoint&&t.caretRangeFromPoint(i,n)?s=t.caretRangeFromPoint(i,n):e.rangeParent&&(s=t.createRange(),s.setStart(e.rangeParent,e.rangeOffset),s.collapse(!0)),s}function Br(e){return "[object Text]"==Object.prototype.toString.call(e)}function Or(e){return "[object Range]"==Object.prototype.toString.apply(e)}function Mr(e){return e&&e.parentNode?e.offsetParent===i.document.body?null:e.offsetParent:null}const Lr=["top","right","bottom","left","width","height"];class Fr{top;right;bottom;left;width;height;_source;constructor(e){const t=Or(e);if(Object.defineProperty(this,"_source",{value:e._source||e,writable:!0,enumerable:!1}),zr(e)||t)if(t){const t=Fr.getDomRangeRects(e);Nr(this,Fr.getBoundingRect(t));}else Nr(this,e.getBoundingClientRect());else if(Cr(e)){const{innerWidth:t,innerHeight:i}=e;Nr(this,{top:0,right:t,bottom:i,left:0,width:t,height:i});}else Nr(this,e);}clone(){return new Fr(this)}moveTo(e,t){return this.top=t,this.right=e+this.width,this.bottom=t+this.height,this.left=e,this}moveBy(e,t){return this.top+=t,this.right+=e,this.left+=e,this.bottom+=t,this}getIntersection(e){const t={top:Math.max(this.top,e.top),right:Math.min(this.right,e.right),bottom:Math.min(this.bottom,e.bottom),left:Math.max(this.left,e.left),width:0,height:0};if(t.width=t.right-t.left,t.height=t.bottom-t.top,t.width<0||t.height<0)return null;{const e=new Fr(t);return e._source=this._source,e}}getIntersectionArea(e){const t=this.getIntersection(e);return t?t.getArea():0}getArea(){return this.width*this.height}getVisible(){const e=this._source;let t=this.clone();if(Dr(e))return t;let i,n=e,s=e.parentNode||e.commonAncestorContainer;for(;s&&!Dr(s);){const e="visible"===((o=s)instanceof HTMLElement?o.ownerDocument.defaultView.getComputedStyle(o).overflow:"visible");n instanceof HTMLElement&&"absolute"===Hr(n)&&(i=n);const r=Hr(s);if(e||i&&("relative"===r&&e||"relative"!==r)){n=s,s=s.parentNode;continue}const a=new Fr(s),l=t.getIntersection(a);if(!l)return null;l.getArea()<t.getArea()&&(t=l),n=s,s=s.parentNode;}var o;return t}isEqual(e){for(const t of Lr)if(this[t]!==e[t])return !1;return !0}contains(e){const t=this.getIntersection(e);return !(!t||!t.isEqual(e))}toAbsoluteRect(){const{scrollX:e,scrollY:t}=i.window,n=this.clone().moveBy(e,t);if(zr(n._source)){const e=Mr(n._source);e&&function(e,t){const i=new Fr(t),n=Vr(t);let s=0,o=0;s-=i.left,o-=i.top,s+=t.scrollLeft,o+=t.scrollTop,s-=n.left,o-=n.top,e.moveBy(s,o);}(n,e);}return n}excludeScrollbarsAndBorders(){const e=this._source;let t,i,n;if(Cr(e))t=e.innerWidth-e.document.documentElement.clientWidth,i=e.innerHeight-e.document.documentElement.clientHeight,n=e.getComputedStyle(e.document.documentElement).direction;else {const s=Vr(e);t=e.offsetWidth-e.clientWidth-s.left-s.right,i=e.offsetHeight-e.clientHeight-s.top-s.bottom,n=e.ownerDocument.defaultView.getComputedStyle(e).direction,this.left+=s.left,this.top+=s.top,this.right-=s.right,this.bottom-=s.bottom,this.width=this.right-this.left,this.height=this.bottom-this.top;}return this.width-=t,"ltr"===n?this.right-=t:this.left+=t,this.height-=i,this.bottom-=i,this}static getDomRangeRects(e){const t=[],i=Array.from(e.getClientRects());if(i.length)for(const e of i)t.push(new Fr(e));else {let i=e.startContainer;Br(i)&&(i=i.parentNode);const n=new Fr(i.getBoundingClientRect());n.right=n.left,n.width=0,t.push(n);}return t}static getBoundingRect(e){const t={left:Number.POSITIVE_INFINITY,top:Number.POSITIVE_INFINITY,right:Number.NEGATIVE_INFINITY,bottom:Number.NEGATIVE_INFINITY,width:0,height:0};let i=0;for(const n of e)i++,t.left=Math.min(t.left,n.left),t.top=Math.min(t.top,n.top),t.right=Math.max(t.right,n.right),t.bottom=Math.max(t.bottom,n.bottom);return 0==i?null:(t.width=t.right-t.left,t.height=t.bottom-t.top,new Fr(t))}}function Nr(e,t){for(const i of Lr)e[i]=t[i];}function Dr(e){return !!zr(e)&&e===e.ownerDocument.body}function zr(e){return null!==e&&"object"==typeof e&&1===e.nodeType&&"function"==typeof e.getBoundingClientRect}function Hr(e){return e instanceof HTMLElement?e.ownerDocument.defaultView.getComputedStyle(e).position:"static"}class $r{_element;_callback;static _observerInstance=null;static _elementCallbacks=null;constructor(e,t){$r._observerInstance||$r._createObserver(),this._element=e,this._callback=t,$r._addElementCallback(e,t),$r._observerInstance.observe(e);}get element(){return this._element}destroy(){$r._deleteElementCallback(this._element,this._callback);}static _addElementCallback(e,t){$r._elementCallbacks||($r._elementCallbacks=new Map);let i=$r._elementCallbacks.get(e);i||(i=new Set,$r._elementCallbacks.set(e,i)),i.add(t);}static _deleteElementCallback(e,t){const i=$r._getElementCallbacks(e);i&&(i.delete(t),i.size||($r._elementCallbacks.delete(e),$r._observerInstance.unobserve(e))),$r._elementCallbacks&&!$r._elementCallbacks.size&&($r._observerInstance=null,$r._elementCallbacks=null);}static _getElementCallbacks(e){return $r._elementCallbacks?$r._elementCallbacks.get(e):null}static _createObserver(){$r._observerInstance=new i.window.ResizeObserver((e=>{for(const t of e){const e=$r._getElementCallbacks(t.target);if(e)for(const i of e)i(t);}}));}}function Ur(e,t){e instanceof HTMLTextAreaElement&&(e.value=t),e.innerHTML=t;}function Wr(e){return t=>t+e}function jr(e){let t=0;for(;e.previousSibling;)e=e.previousSibling,t++;return t}function qr(e,t,i){e.insertBefore(i,e.childNodes[t]||null);}function Gr(e){return e&&e.nodeType===Node.COMMENT_NODE}function Kr(e){try{i.document.createAttribute(e);}catch(e){return !1}return !0}function Zr(e){return !!e&&(Br(e)?Zr(e.parentElement):!!e.getClientRects&&!!e.getClientRects().length)}function Jr({element:e,target:t,positions:n,limiter:s,fitInViewport:o,viewportOffsetConfig:r}){Se(t)&&(t=t()),Se(s)&&(s=s());const a=Mr(e),l=function(e){e=Object.assign({top:0,bottom:0,left:0,right:0},e);const t=new Fr(i.window);return t.top+=e.top,t.height-=e.top,t.bottom-=e.bottom,t.height-=e.bottom,t}(r),c=new Fr(e),d=Qr(t,l);let h;if(!d||!l.getIntersection(d))return null;const u={targetRect:d,elementRect:c,positionedElementAncestor:a,viewportRect:l};if(s||o){if(s){const e=Qr(s,l);e&&(u.limiterRect=e);}h=function(e,t){const{elementRect:i}=t,n=i.getArea(),s=e.map((e=>new Yr(e,t))).filter((e=>!!e.name));let o=0,r=null;for(const e of s){const{limiterIntersectionArea:t,viewportIntersectionArea:i}=e;if(t===n)return e;const s=i**2+t**2;s>o&&(o=s,r=e);}return r}(n,u);}else h=new Yr(n[0],u);return h}function Qr(e,t){const i=new Fr(e).getVisible();return i?i.getIntersection(t):null}class Yr{name;config;_positioningFunctionCoordinates;_options;_cachedRect;_cachedAbsoluteRect;constructor(e,t){const i=e(t.targetRect,t.elementRect,t.viewportRect,t.limiterRect);if(!i)return;const{left:n,top:s,name:o,config:r}=i;this.name=o,this.config=r,this._positioningFunctionCoordinates={left:n,top:s},this._options=t;}get left(){return this._absoluteRect.left}get top(){return this._absoluteRect.top}get limiterIntersectionArea(){const e=this._options.limiterRect;return e?e.getIntersectionArea(this._rect):0}get viewportIntersectionArea(){return this._options.viewportRect.getIntersectionArea(this._rect)}get _rect(){return this._cachedRect||(this._cachedRect=this._options.elementRect.clone().moveTo(this._positioningFunctionCoordinates.left,this._positioningFunctionCoordinates.top)),this._cachedRect}get _absoluteRect(){return this._cachedAbsoluteRect||(this._cachedAbsoluteRect=this._rect.toAbsoluteRect()),this._cachedAbsoluteRect}}function Xr(e){const t=e.parentNode;t&&t.removeChild(e);}function ea({target:e,viewportOffset:t=0,ancestorOffset:i=0,alignToTop:n,forceScroll:s}){const o=la(e);let r=o,a=null;for(t=function(e){if("number"==typeof e)return {top:e,bottom:e,left:e,right:e};return e}(t);r;){let l;l=ca(r==o?e:a),na({parent:l,getRect:()=>da(e,r),alignToTop:n,ancestorOffset:i,forceScroll:s});const c=da(e,r);if(ia({window:r,rect:c,viewportOffset:t,alignToTop:n,forceScroll:s}),r.parent!=r){if(a=r.frameElement,r=r.parent,!a)return}else r=null;}}function ia({window:e,rect:t,alignToTop:i,forceScroll:n,viewportOffset:s}){const o=t.clone().moveBy(0,s.bottom),r=t.clone().moveBy(0,-s.top),a=new Fr(e).excludeScrollbarsAndBorders(),l=i&&n,c=[r,o].every((e=>a.contains(e)));let{scrollX:d,scrollY:h}=e;const u=d,m=h;l?h-=a.top-t.top+s.top:c||(oa(r,a)?h-=a.top-t.top+s.top:sa(o,a)&&(h+=i?t.top-a.top-s.top:t.bottom-a.bottom+s.bottom)),c||(ra(t,a)?d-=a.left-t.left+s.left:aa(t,a)&&(d+=t.right-a.right+s.right)),d==u&&h===m||e.scrollTo(d,h);}function na({parent:e,getRect:t,alignToTop:i,forceScroll:n,ancestorOffset:s=0,limiterElement:o}){const r=la(e),a=i&&n;let l,c,d;const h=o||r.document.body;for(;e!=h;)c=t(),l=new Fr(e).excludeScrollbarsAndBorders(),d=l.contains(c),a?e.scrollTop-=l.top-c.top+s:d||(oa(c,l)?e.scrollTop-=l.top-c.top+s:sa(c,l)&&(e.scrollTop+=i?c.top-l.top-s:c.bottom-l.bottom+s)),d||(ra(c,l)?e.scrollLeft-=l.left-c.left+s:aa(c,l)&&(e.scrollLeft+=c.right-l.right+s)),e=e.parentNode;}function sa(e,t){return e.bottom>t.bottom}function oa(e,t){return e.top<t.top}function ra(e,t){return e.left<t.left}function aa(e,t){return e.right>t.right}function la(e){return Or(e)?e.startContainer.ownerDocument.defaultView:e.ownerDocument.defaultView}function ca(e){if(Or(e)){let t=e.commonAncestorContainer;return Br(t)&&(t=t.parentNode),t}return e.parentNode}function da(e,t){const i=la(e),n=new Fr(e);if(i===t)return n;{let e=i;for(;e!=t;){const t=e.frameElement,i=new Fr(t).excludeScrollbarsAndBorders();n.moveBy(i.left,i.top),e=e.parent;}}return n}const ha={ctrl:"⌃",cmd:"⌘",alt:"⌥",shift:"⇧"},ua={ctrl:"Ctrl+",alt:"Alt+",shift:"Shift+"},ma={37:"←",38:"↑",39:"→",40:"↓",9:"⇥",33:"Page Up",34:"Page Down"},ga=ka(),fa=Object.fromEntries(Object.entries(ga).map((([e,t])=>{let i;return i=t in ma?ma[t]:e.charAt(0).toUpperCase()+e.slice(1),[t,i]})));function pa(e){let t;if("string"==typeof e){if(t=ga[e.toLowerCase()],!t)throw new E("keyboard-unknown-key",null,{key:e})}else t=e.keyCode+(e.altKey?ga.alt:0)+(e.ctrlKey?ga.ctrl:0)+(e.shiftKey?ga.shift:0)+(e.metaKey?ga.cmd:0);return t}function ba(e){return "string"==typeof e&&(e=function(e){return e.split("+").map((e=>e.trim()))}(e)),e.map((e=>"string"==typeof e?function(e){if(e.endsWith("!"))return pa(e.slice(0,-1));const t=pa(e);return (o.isMac||o.isiOS)&&t==ga.ctrl?ga.cmd:t}(e):e)).reduce(((e,t)=>t+e),0)}function wa(e){let t=ba(e);return Object.entries(o.isMac||o.isiOS?ha:ua).reduce(((e,[i,n])=>(t&ga[i]&&(t&=~ga[i],e+=n),e)),"")+(t?fa[t]:"")}function _a(e){return e==ga.arrowright||e==ga.arrowleft||e==ga.arrowup||e==ga.arrowdown}function va(e,t){const i="ltr"===t;switch(e){case ga.arrowleft:return i?"left":"right";case ga.arrowright:return i?"right":"left";case ga.arrowup:return "up";case ga.arrowdown:return "down"}}function ya(e,t){const i=va(e,t);return "down"===i||"right"===i}function ka(){const e={pageup:33,pagedown:34,arrowleft:37,arrowup:38,arrowright:39,arrowdown:40,backspace:8,delete:46,enter:13,space:32,esc:27,tab:9,ctrl:1114112,shift:2228224,alt:4456448,cmd:8912896};for(let t=65;t<=90;t++){e[String.fromCharCode(t).toLowerCase()]=t;}for(let t=48;t<=57;t++)e[t-48]=t;for(let t=112;t<=123;t++)e["f"+(t-111)]=t;return Object.assign(e,{"'":222,",":108,"-":109,".":110,"/":111,";":186,"=":187,"[":219,"\\":220,"]":221,"`":223}),e}const Ca=["ar","ara","dv","div","fa","per","fas","he","heb","ku","kur","ug","uig"];function xa(e){return Ca.includes(e)?"rtl":"ltr"}function Aa(e){return Array.isArray(e)?e:[e]}function Ea(e,t,n=1,s){if("number"!=typeof n)throw new E("translation-service-quantity-not-a-number",null,{quantity:n});const o=s||i.window.CKEDITOR_TRANSLATIONS,r=function(e){return Object.keys(e).length}(o);1===r&&(e=Object.keys(o)[0]);const a=t.id||t.string;if(0===r||!function(e,t,i){return !!i[e]&&!!i[e].dictionary[t]}(e,a,o))return 1!==n?t.plural:t.string;const l=o[e].dictionary,c=o[e].getPluralForm||(e=>1===e?0:1),d=l[a];if("string"==typeof d)return d;return d[Number(c(n))]}i.window.CKEDITOR_TRANSLATIONS||(i.window.CKEDITOR_TRANSLATIONS={});class Ta{uiLanguage;uiLanguageDirection;contentLanguage;contentLanguageDirection;t;translations;constructor({uiLanguage:e="en",contentLanguage:t,translations:i}={}){this.uiLanguage=e,this.contentLanguage=t||this.uiLanguage,this.uiLanguageDirection=xa(this.uiLanguage),this.contentLanguageDirection=xa(this.contentLanguage),this.translations=function(e){return Array.isArray(e)?e.reduce(((e,t)=>Zo(e,t))):e}(i),this.t=(e,t)=>this._t(e,t);}get language(){return console.warn("locale-deprecated-language-property: The Locale#language property has been deprecated and will be removed in the near future. Please use #uiLanguage and #contentLanguage properties instead."),this.uiLanguage}_t(e,t=[]){t=Aa(t),"string"==typeof e&&(e={string:e});const i=!!e.plural?t[0]:1;return function(e,t){return e.replace(/%(\d+)/g,((e,i)=>i<t.length?t[i]:e))}(Ea(this.uiLanguage,e,i,this.translations),t)}}class Sa extends(F()){_items;_itemMap;_idProperty;_bindToCollection;_bindToExternalToInternalMap;_bindToInternalToExternalMap;_skippedIndexesFromExternal;constructor(e={},t={}){super();const i=br(e);if(i||(t=e),this._items=[],this._itemMap=new Map,this._idProperty=t.idProperty||"id",this._bindToExternalToInternalMap=new WeakMap,this._bindToInternalToExternalMap=new WeakMap,this._skippedIndexesFromExternal=[],i)for(const t of e)this._items.push(t),this._itemMap.set(this._getItemIdBeforeAdding(t),t);}get length(){return this._items.length}get first(){return this._items[0]||null}get last(){return this._items[this.length-1]||null}add(e,t){return this.addMany([e],t)}addMany(e,t){if(void 0===t)t=this._items.length;else if(t>this._items.length||t<0)throw new E("collection-add-item-invalid-index",this);let i=0;for(const n of e){const e=this._getItemIdBeforeAdding(n),s=t+i;this._items.splice(s,0,n),this._itemMap.set(e,n),this.fire("add",n,s),i++;}return this.fire("change",{added:e,removed:[],index:t}),this}get(e){let t;if("string"==typeof e)t=this._itemMap.get(e);else {if("number"!=typeof e)throw new E("collection-get-invalid-arg",this);t=this._items[e];}return t||null}has(e){if("string"==typeof e)return this._itemMap.has(e);{const t=e[this._idProperty];return t&&this._itemMap.has(t)}}getIndex(e){let t;return t="string"==typeof e?this._itemMap.get(e):e,t?this._items.indexOf(t):-1}remove(e){const[t,i]=this._remove(e);return this.fire("change",{added:[],removed:[t],index:i}),t}map(e,t){return this._items.map(e,t)}forEach(e,t){this._items.forEach(e,t);}find(e,t){return this._items.find(e,t)}filter(e,t){return this._items.filter(e,t)}clear(){this._bindToCollection&&(this.stopListening(this._bindToCollection),this._bindToCollection=null);const e=Array.from(this._items);for(;this.length;)this._remove(0);this.fire("change",{added:[],removed:e,index:0});}bindTo(e){if(this._bindToCollection)throw new E("collection-bind-to-rebind",this);return this._bindToCollection=e,{as:e=>{this._setUpBindToBinding((t=>new e(t)));},using:e=>{"function"==typeof e?this._setUpBindToBinding(e):this._setUpBindToBinding((t=>t[e]));}}}_setUpBindToBinding(e){const t=this._bindToCollection,i=(i,n,s)=>{const o=t._bindToCollection==this,r=t._bindToInternalToExternalMap.get(n);if(o&&r)this._bindToExternalToInternalMap.set(n,r),this._bindToInternalToExternalMap.set(r,n);else {const i=e(n);if(!i)return void this._skippedIndexesFromExternal.push(s);let o=s;for(const e of this._skippedIndexesFromExternal)s>e&&o--;for(const e of t._skippedIndexesFromExternal)o>=e&&o++;this._bindToExternalToInternalMap.set(n,i),this._bindToInternalToExternalMap.set(i,n),this.add(i,o);for(let e=0;e<t._skippedIndexesFromExternal.length;e++)o<=t._skippedIndexesFromExternal[e]&&t._skippedIndexesFromExternal[e]++;}};for(const e of t)i(0,e,t.getIndex(e));this.listenTo(t,"add",i),this.listenTo(t,"remove",((e,t,i)=>{const n=this._bindToExternalToInternalMap.get(t);n&&this.remove(n),this._skippedIndexesFromExternal=this._skippedIndexesFromExternal.reduce(((e,t)=>(i<t&&e.push(t-1),i>t&&e.push(t),e)),[]);}));}_getItemIdBeforeAdding(e){const t=this._idProperty;let i;if(t in e){if(i=e[t],"string"!=typeof i)throw new E("collection-add-invalid-id",this);if(this.get(i))throw new E("collection-add-item-already-exists",this)}else e[t]=i=k();return i}_remove(e){let t,i,n,s=!1;const o=this._idProperty;if("string"==typeof e?(i=e,n=this._itemMap.get(i),s=!n,n&&(t=this._items.indexOf(n))):"number"==typeof e?(t=e,n=this._items[t],s=!n,n&&(i=n[o])):(n=e,i=n[o],t=this._items.indexOf(n),s=-1==t||!this._itemMap.get(i)),s)throw new E("collection-remove-404",this);this._items.splice(t,1),this._itemMap.delete(i);const r=this._bindToInternalToExternalMap.get(n);return this._bindToInternalToExternalMap.delete(n),this._bindToExternalToInternalMap.delete(r),this.fire("remove",n,t),[n,t]}[Symbol.iterator](){return this._items[Symbol.iterator]()}}function Ia(e){const t=e.next();return t.done?null:t.value}class Pa extends(Ar(ar())){_elements=new Set;_nextEventLoopTimeout=null;constructor(){super(),this.set("isFocused",!1),this.set("focusedElement",null);}get elements(){return Array.from(this._elements.values())}add(e){if(this._elements.has(e))throw new E("focustracker-add-element-already-exist",this);this.listenTo(e,"focus",(()=>this._focus(e)),{useCapture:!0}),this.listenTo(e,"blur",(()=>this._blur()),{useCapture:!0}),this._elements.add(e);}remove(e){e===this.focusedElement&&this._blur(),this._elements.has(e)&&(this.stopListening(e),this._elements.delete(e));}destroy(){this.stopListening();}_focus(e){clearTimeout(this._nextEventLoopTimeout),this.focusedElement=e,this.isFocused=!0;}_blur(){clearTimeout(this._nextEventLoopTimeout),this._nextEventLoopTimeout=setTimeout((()=>{this.focusedElement=null,this.isFocused=!1;}),0);}}class Va{_listener;constructor(){this._listener=new(Ar());}listenTo(e){this._listener.listenTo(e,"keydown",((e,t)=>{this._listener.fire("_keydown:"+pa(t),t);}));}set(e,t,i={}){const n=ba(e),s=i.priority;this._listener.listenTo(this._listener,"_keydown:"+n,((e,n)=>{i.filter&&!i.filter(n)||(t(n,(()=>{n.preventDefault(),n.stopPropagation(),e.stop();})),e.return=!0);}),{priority:s});}press(e){return !!this._listener.fire("_keydown:"+pa(e),e)}stopListening(e){this._listener.stopListening(e);}destroy(){this.stopListening();}}function Ra(e){return br(e)?new Map(e):function(e){const t=new Map;for(const i in e)t.set(i,e[i]);return t}(e)}function La(e,t,i,n){if(Math.max(t.length,e.length)>1e4)return e.slice(0,i).concat(t).concat(e.slice(i+n,e.length));{const s=Array.from(e);return s.splice(i,n,...t),s}}function Fa(e,t){let i;function n(...s){n.cancel(),i=setTimeout((()=>e(...s)),t);}return n.cancel=()=>{clearTimeout(i);},n}function Na(e){function t(e){return e.length>=40&&e.length<=255?"VALID":"INVALID"}if(!e)return "INVALID";let i="";try{i=atob(e);}catch(e){return "INVALID"}const n=i.split("-"),s=n[0],o=n[1];if(!o)return t(e);try{atob(o);}catch(i){try{if(atob(s),!atob(s).length)return t(e)}catch(i){return t(e)}}if(s.length<40||s.length>255)return "INVALID";let r="";try{atob(s),r=atob(o);}catch(e){return "INVALID"}if(8!==r.length)return "INVALID";const a=Number(r.substring(0,4)),l=Number(r.substring(4,6))-1,c=Number(r.substring(6,8)),d=new Date(a,l,c);return d<R||isNaN(Number(d))?"INVALID":"VALID"}function Da(e){return !!e&&1==e.length&&/[\u0300-\u036f\u1ab0-\u1aff\u1dc0-\u1dff\u20d0-\u20ff\ufe20-\ufe2f]/.test(e)}function za(e){return !!e&&1==e.length&&/[\ud800-\udbff]/.test(e)}function Ha(e){return !!e&&1==e.length&&/[\udc00-\udfff]/.test(e)}function $a(e,t){return za(e.charAt(t-1))&&Ha(e.charAt(t))}function Ua(e,t){return Da(e.charAt(t))}const Wa=qa();function ja(e,t){const i=String(e).matchAll(Wa);return Array.from(i).some((e=>e.index<t&&t<e.index+e[0].length))}function qa(){const e=/\p{Regional_Indicator}{2}/u.source,t="(?:"+[/\p{Emoji}[\u{E0020}-\u{E007E}]+\u{E007F}/u,/\p{Emoji}\u{FE0F}?\u{20E3}/u,/\p{Emoji}\u{FE0F}/u,/(?=\p{General_Category=Other_Symbol})\p{Emoji}\p{Emoji_Modifier}*/u].map((e=>e.source)).join("|")+")";return new RegExp(`${e}|${t}(?:‍${t})*`,"ug")}class Ga extends(ar()){editor;_disableStack=new Set;constructor(e){super(),this.editor=e,this.set("isEnabled",!0);}forceDisabled(e){this._disableStack.add(e),1==this._disableStack.size&&(this.on("set:isEnabled",Ka,{priority:"highest"}),this.isEnabled=!1);}clearForceDisabled(e){this._disableStack.delete(e),0==this._disableStack.size&&(this.off("set:isEnabled",Ka),this.isEnabled=!0);}destroy(){this.stopListening();}static get isContextPlugin(){return !1}}function Ka(e){e.return=!1,e.stop();}class Za extends(ar()){editor;_isEnabledBasedOnSelection;_affectsData;_disableStack;constructor(e){super(),this.editor=e,this.set("value",void 0),this.set("isEnabled",!1),this._affectsData=!0,this._isEnabledBasedOnSelection=!0,this._disableStack=new Set,this.decorate("execute"),this.listenTo(this.editor.model.document,"change",(()=>{this.refresh();})),this.listenTo(e,"change:isReadOnly",(()=>{this.refresh();})),this.on("set:isEnabled",(t=>{if(!this.affectsData)return;const i=e.model.document.selection,n=!("$graveyard"==i.getFirstPosition().root.rootName)&&e.model.canEditAt(i);(e.isReadOnly||this._isEnabledBasedOnSelection&&!n)&&(t.return=!1,t.stop());}),{priority:"highest"}),this.on("execute",(e=>{this.isEnabled||e.stop();}),{priority:"high"});}get affectsData(){return this._affectsData}set affectsData(e){this._affectsData=e;}refresh(){this.isEnabled=!0;}forceDisabled(e){this._disableStack.add(e),1==this._disableStack.size&&(this.on("set:isEnabled",Ja,{priority:"highest"}),this.isEnabled=!1);}clearForceDisabled(e){this._disableStack.delete(e),0==this._disableStack.size&&(this.off("set:isEnabled",Ja),this.refresh());}execute(...e){}destroy(){this.stopListening();}}function Ja(e){e.return=!1,e.stop();}class Ya extends(F()){_context;_plugins=new Map;_availablePlugins;_contextPlugins;constructor(e,t=[],i=[]){super(),this._context=e,this._availablePlugins=new Map;for(const e of t)e.pluginName&&this._availablePlugins.set(e.pluginName,e);this._contextPlugins=new Map;for(const[e,t]of i)this._contextPlugins.set(e,t),this._contextPlugins.set(t,e),e.pluginName&&this._availablePlugins.set(e.pluginName,e);}*[Symbol.iterator](){for(const e of this._plugins)"function"==typeof e[0]&&(yield e);}get(e){const t=this._plugins.get(e);if(!t){let t=e;throw "function"==typeof e&&(t=e.pluginName||e.name),new E("plugincollection-plugin-not-loaded",this._context,{plugin:t})}return t}has(e){return this._plugins.has(e)}init(e,t=[],i=[]){const n=this,s=this._context;!function e(t,i=new Set){t.forEach((t=>{a(t)&&(i.has(t)||(i.add(t),t.pluginName&&!n._availablePlugins.has(t.pluginName)&&n._availablePlugins.set(t.pluginName,t),t.requires&&e(t.requires,i)));}));}(e),h(e);const o=[...function e(t,i=new Set){return t.map((e=>a(e)?e:n._availablePlugins.get(e))).reduce(((t,n)=>i.has(n)?t:(i.add(n),n.requires&&(h(n.requires,n),e(n.requires,i).forEach((e=>t.add(e)))),t.add(n))),new Set)}(e.filter((e=>!c(e,t))))];!function(e,t){for(const i of t){if("function"!=typeof i)throw new E("plugincollection-replace-plugin-invalid-type",null,{pluginItem:i});const t=i.pluginName;if(!t)throw new E("plugincollection-replace-plugin-missing-name",null,{pluginItem:i});if(i.requires&&i.requires.length)throw new E("plugincollection-plugin-for-replacing-cannot-have-dependencies",null,{pluginName:t});const s=n._availablePlugins.get(t);if(!s)throw new E("plugincollection-plugin-for-replacing-not-exist",null,{pluginName:t});const o=e.indexOf(s);if(-1===o){if(n._contextPlugins.has(s))return;throw new E("plugincollection-plugin-for-replacing-not-loaded",null,{pluginName:t})}if(s.requires&&s.requires.length)throw new E("plugincollection-replaced-plugin-cannot-have-dependencies",null,{pluginName:t});e.splice(o,1,i),n._availablePlugins.set(t,i);}}(o,i);const r=function(e){return e.map((e=>{let t=n._contextPlugins.get(e);return t=t||new e(s),n._add(e,t),t}))}(o);return u(r,"init").then((()=>u(r,"afterInit"))).then((()=>r));function a(e){return "function"==typeof e}function l(e){return a(e)&&!!e.isContextPlugin}function c(e,t){return t.some((t=>t===e||(d(e)===t||d(t)===e)))}function d(e){return a(e)?e.pluginName||e.name:e}function h(e,i=null){e.map((e=>a(e)?e:n._availablePlugins.get(e)||e)).forEach((e=>{!function(e,t){if(a(e))return;if(t)throw new E("plugincollection-soft-required",s,{missingPlugin:e,requiredBy:d(t)});throw new E("plugincollection-plugin-not-found",s,{plugin:e})}(e,i),function(e,t){if(!l(t))return;if(l(e))return;throw new E("plugincollection-context-required",s,{plugin:d(e),requiredBy:d(t)})}(e,i),function(e,i){if(!i)return;if(!c(e,t))return;throw new E("plugincollection-required",s,{plugin:d(e),requiredBy:d(i)})}(e,i);}));}function u(e,t){return e.reduce(((e,i)=>i[t]?n._contextPlugins.has(i)?e:e.then(i[t].bind(i)):e),Promise.resolve())}}destroy(){const e=[];for(const[,t]of this)"function"!=typeof t.destroy||this._contextPlugins.has(t)||e.push(t.destroy());return Promise.all(e)}_add(e,t){this._plugins.set(e,t);const i=e.pluginName;if(i){if(this._plugins.has(i))throw new E("plugincollection-plugin-name-conflict",null,{pluginName:i,plugin1:this._plugins.get(i).constructor,plugin2:e});this._plugins.set(i,t);}}}class Xa{config;plugins;locale;t;editors;static defaultConfig;static builtinPlugins;_contextOwner=null;constructor(e){const{translations:t,...i}=e||{};this.config=new _r(i,this.constructor.defaultConfig);const n=this.constructor.builtinPlugins;this.config.define("plugins",n),this.plugins=new Ya(this,n);const s=this.config.get("language")||{};this.locale=new Ta({uiLanguage:"string"==typeof s?s:s.ui,contentLanguage:this.config.get("language.content"),translations:t}),this.t=this.locale.t,this.editors=new Sa;}initPlugins(){const e=this.config.get("plugins")||[],t=this.config.get("substitutePlugins")||[];for(const i of e.concat(t)){if("function"!=typeof i)throw new E("context-initplugins-constructor-only",null,{Plugin:i});if(!0!==i.isContextPlugin)throw new E("context-initplugins-invalid-plugin",null,{Plugin:i})}return this.plugins.init(e,[],t)}destroy(){return Promise.all(Array.from(this.editors,(e=>e.destroy()))).then((()=>this.plugins.destroy()))}_addEditor(e,t){if(this._contextOwner)throw new E("context-addeditor-private-context");this.editors.add(e),t&&(this._contextOwner=e);}_removeEditor(e){return this.editors.has(e)&&this.editors.remove(e),this._contextOwner===e?this.destroy():Promise.resolve()}_getEditorConfig(){const e={};for(const t of this.config.names())["plugins","removePlugins","extraPlugins"].includes(t)||(e[t]=this.config.get(t));return e}static create(e){return new Promise((t=>{const i=new this(e);t(i.initPlugins().then((()=>i)));}))}}class el extends(ar()){context;constructor(e){super(),this.context=e;}destroy(){this.stopListening();}static get isContextPlugin(){return !0}}const tl=new WeakMap;let il=!1;function nl({view:e,element:t,text:i,isDirectHost:n=!0,keepOnFocus:s=!1}){const o=e.document;function r(i){tl.get(o).set(t,{text:i,isDirectHost:n,keepOnFocus:s,hostElement:n?t:null}),e.change((e=>ll(o,e)));}tl.has(o)||(tl.set(o,new Map),o.registerPostFixer((e=>ll(o,e))),o.on("change:isComposing",(()=>{e.change((e=>ll(o,e)));}),{priority:"high"})),t.is("editableElement")&&t.on("change:placeholder",((e,t,i)=>{r(i);})),t.placeholder?r(t.placeholder):i&&r(i),i&&function(){il||T("enableplaceholder-deprecated-text-option");il=!0;}();}function ol(e,t){return !t.hasClass("ck-placeholder")&&(e.addClass("ck-placeholder",t),!0)}function rl(e,t){return !!t.hasClass("ck-placeholder")&&(e.removeClass("ck-placeholder",t),!0)}function al(e,t){if(!e.isAttached())return !1;const i=Array.from(e.getChildren()).some((e=>!e.is("uiElement")));if(i)return !1;const n=e.document,s=n.selection.anchor;return (!n.isComposing||!s||s.parent!==e)&&(!!t||(!n.isFocused||!!s&&s.parent!==e))}function ll(e,t){const i=tl.get(e),n=[];let s=!1;for(const[e,o]of i)o.isDirectHost&&(n.push(e),cl(t,e,o)&&(s=!0));for(const[e,o]of i){if(o.isDirectHost)continue;const i=dl(e);i&&(n.includes(i)||(o.hostElement=i,cl(t,e,o)&&(s=!0)));}return s}function cl(e,t,i){const{text:n,isDirectHost:s,hostElement:o}=i;let r=!1;o.getAttribute("data-placeholder")!==n&&(e.setAttribute("data-placeholder",n,o),r=!0);return (s||1==t.childCount)&&al(o,i.keepOnFocus)?ol(e,o)&&(r=!0):rl(e,o)&&(r=!0),r}function dl(e){if(e.childCount){const t=e.getChild(0);if(t.is("element")&&!t.is("uiElement")&&!t.is("attributeElement"))return t}return null}let hl=class{is(){throw new Error("is() method is abstract")}},ul=class extends(F(hl)){document;parent;constructor(e){super(),this.document=e,this.parent=null;}get index(){let e;if(!this.parent)return null;if(-1==(e=this.parent.getChildIndex(this)))throw new E("view-node-not-found-in-parent",this);return e}get nextSibling(){const e=this.index;return null!==e&&this.parent.getChild(e+1)||null}get previousSibling(){const e=this.index;return null!==e&&this.parent.getChild(e-1)||null}get root(){let e=this;for(;e.parent;)e=e.parent;return e}isAttached(){return this.root.is("rootElement")}getPath(){const e=[];let t=this;for(;t.parent;)e.unshift(t.index),t=t.parent;return e}getAncestors(e={}){const t=[];let i=e.includeSelf?this:this.parent;for(;i;)t[e.parentFirst?"push":"unshift"](i),i=i.parent;return t}getCommonAncestor(e,t={}){const i=this.getAncestors(t),n=e.getAncestors(t);let s=0;for(;i[s]==n[s]&&i[s];)s++;return 0===s?null:i[s-1]}isBefore(e){if(this==e)return !1;if(this.root!==e.root)return !1;const t=this.getPath(),i=e.getPath(),n=pr(t,i);switch(n){case"prefix":return !0;case"extension":return !1;default:return t[n]<i[n]}}isAfter(e){return this!=e&&(this.root===e.root&&!this.isBefore(e))}_remove(){this.parent._removeChildren(this.index);}_fireChange(e,t){this.fire(`change:${e}`,t),this.parent&&this.parent._fireChange(e,t);}toJSON(){const e=Es(this);return delete e.parent,e}};ul.prototype.is=function(e){return "node"===e||"view:node"===e};let ml=class e extends ul{_textData;constructor(e,t){super(e),this._textData=t;}get data(){return this._textData}get _data(){return this.data}set _data(e){this._fireChange("text",this),this._textData=e;}isSimilar(t){return t instanceof e&&(this===t||this.data===t.data)}_clone(){return new e(this.document,this.data)}};ml.prototype.is=function(e){return "$text"===e||"view:$text"===e||"text"===e||"view:text"===e||"node"===e||"view:node"===e};let gl=class extends hl{textNode;data;offsetInText;constructor(e,t,i){if(super(),this.textNode=e,t<0||t>e.data.length)throw new E("view-textproxy-wrong-offsetintext",this);if(i<0||t+i>e.data.length)throw new E("view-textproxy-wrong-length",this);this.data=e.data.substring(t,t+i),this.offsetInText=t;}get offsetSize(){return this.data.length}get isPartial(){return this.data.length!==this.textNode.data.length}get parent(){return this.textNode.parent}get root(){return this.textNode.root}get document(){return this.textNode.document}getAncestors(e={}){const t=[];let i=e.includeSelf?this.textNode:this.parent;for(;null!==i;)t[e.parentFirst?"push":"unshift"](i),i=i.parent;return t}};gl.prototype.is=function(e){return "$textProxy"===e||"view:$textProxy"===e||"textProxy"===e||"view:textProxy"===e};class fl{_patterns=[];constructor(...e){this.add(...e);}add(...e){for(let t of e)("string"==typeof t||t instanceof RegExp)&&(t={name:t}),this._patterns.push(t);}match(...e){for(const t of e)for(const e of this._patterns){const i=pl(t,e);if(i)return {element:t,pattern:e,match:i}}return null}matchAll(...e){const t=[];for(const i of e)for(const e of this._patterns){const n=pl(i,e);n&&t.push({element:i,pattern:e,match:n});}return t.length>0?t:null}getElementName(){if(1!==this._patterns.length)return null;const e=this._patterns[0],t=e.name;return "function"==typeof e||!t||t instanceof RegExp?null:t}}function pl(e,t){if("function"==typeof t)return t(e);const i={};return t.name&&(i.name=function(e,t){if(e instanceof RegExp)return !!t.match(e);return e===t}(t.name,e.name),!i.name)||t.attributes&&(i.attributes=function(e,t){const i=new Set(t.getAttributeKeys());fi(e)?(void 0!==e.style&&T("matcher-pattern-deprecated-attributes-style-key",e),void 0!==e.class&&T("matcher-pattern-deprecated-attributes-class-key",e)):(i.delete("style"),i.delete("class"));return bl(e,i,(e=>t.getAttribute(e)))}(t.attributes,e),!i.attributes)||t.classes&&(i.classes=function(e,t){return bl(e,t.getClassNames(),(()=>{}))}(t.classes,e),!i.classes)||t.styles&&(i.styles=function(e,t){return bl(e,t.getStyleNames(!0),(e=>t.getStyle(e)))}(t.styles,e),!i.styles)?null:i}function bl(e,t,i){const n=function(e){if(Array.isArray(e))return e.map((e=>fi(e)?(void 0!==e.key&&void 0!==e.value||T("matcher-pattern-missing-key-or-value",e),[e.key,e.value]):[e,!0]));if(fi(e))return Object.entries(e);return [[e,!0]]}(e),s=Array.from(t),o=[];if(n.forEach((([e,t])=>{s.forEach((n=>{(function(e,t){return !0===e||e===t||e instanceof RegExp&&t.match(e)})(e,n)&&function(e,t,i){if(!0===e)return !0;const n=i(t);return e===n||e instanceof RegExp&&!!String(n).match(e)}(t,n,i)&&o.push(n);}));})),n.length&&!(o.length<n.length))return o}class wl{_styles;_styleProcessor;constructor(e){this._styles={},this._styleProcessor=e;}get isEmpty(){return !Object.entries(this._styles).length}get size(){return this.isEmpty?0:this.getStyleNames().length}setTo(e){this.clear();const t=function(e){let t=null,i=0,n=0,s=null;const o=new Map;if(""===e)return o;";"!=e.charAt(e.length-1)&&(e+=";");for(let r=0;r<e.length;r++){const a=e.charAt(r);if(null===t)switch(a){case":":s||(s=e.substr(i,r-i),n=r+1);break;case'"':case"'":t=a;break;case";":{const t=e.substr(n,r-n);s&&o.set(s.trim(),t.trim()),s=null,i=r+1;break}}else a===t&&(t=null);}return o}(e);for(const[e,i]of t)this._styleProcessor.toNormalizedForm(e,i,this._styles);}has(e){if(this.isEmpty)return !1;const t=this._styleProcessor.getReducedForm(e,this._styles).find((([t])=>t===e));return Array.isArray(t)}set(e,t){if(pe(e))for(const[t,i]of Object.entries(e))this._styleProcessor.toNormalizedForm(t,i,this._styles);else this._styleProcessor.toNormalizedForm(e,t,this._styles);}remove(e){const t=vl(e);!function(e,t){null==e||Jo(e,t);}(this._styles,t),delete this._styles[e],this._cleanEmptyObjectsOnPath(t);}getNormalized(e){return this._styleProcessor.getNormalized(e,this._styles)}toString(){return this.isEmpty?"":this.getStylesEntries().map((e=>e.join(":"))).sort().join(";")+";"}getAsString(e){if(this.isEmpty)return;if(this._styles[e]&&!pe(this._styles[e]))return this._styles[e];const t=this._styleProcessor.getReducedForm(e,this._styles).find((([t])=>t===e));return Array.isArray(t)?t[1]:void 0}getStyleNames(e=!1){if(this.isEmpty)return [];if(e)return this._styleProcessor.getStyleNames(this._styles);return this.getStylesEntries().map((([e])=>e))}clear(){this._styles={};}getStylesEntries(){const e=[],t=Object.keys(this._styles);for(const i of t)e.push(...this._styleProcessor.getReducedForm(i,this._styles));return e}_cleanEmptyObjectsOnPath(e){const t=e.split(".");if(!(t.length>1))return;const i=t.splice(0,t.length-1).join("."),n=ri(this._styles,i);if(!n)return;!Object.keys(n).length&&this.remove(i);}}class _l{_normalizers;_extractors;_reducers;_consumables;constructor(){this._normalizers=new Map,this._extractors=new Map,this._reducers=new Map,this._consumables=new Map;}toNormalizedForm(e,t,i){if(pe(t))yl(i,vl(e),t);else if(this._normalizers.has(e)){const n=this._normalizers.get(e),{path:s,value:o}=n(t);yl(i,s,o);}else yl(i,e,t);}getNormalized(e,t){if(!e)return Zo({},t);if(void 0!==t[e])return t[e];if(this._extractors.has(e)){const i=this._extractors.get(e);if("string"==typeof i)return ri(t,i);const n=i(e,t);if(n)return n}return ri(t,vl(e))}getReducedForm(e,t){const i=this.getNormalized(e,t);if(void 0===i)return [];if(this._reducers.has(e)){return this._reducers.get(e)(i)}return [[e,i]]}getStyleNames(e){const t=Array.from(this._consumables.keys()).filter((t=>{const i=this.getNormalized(t,e);return i&&"object"==typeof i?Object.keys(i).length:i})),i=new Set([...t,...Object.keys(e)]);return Array.from(i)}getRelatedStyles(e){return this._consumables.get(e)||[]}setNormalizer(e,t){this._normalizers.set(e,t);}setExtractor(e,t){this._extractors.set(e,t);}setReducer(e,t){this._reducers.set(e,t);}setStyleRelation(e,t){this._mapStyleNames(e,t);for(const i of t)this._mapStyleNames(i,[e]);}_mapStyleNames(e,t){this._consumables.has(e)||this._consumables.set(e,[]),this._consumables.get(e).push(...t);}}function vl(e){return e.replace("-",".")}function yl(e,t,i){let n=i;pe(i)&&(n=Zo({},ri(e,t),i)),Qo(e,t,n);}let kl=class e extends ul{name;_unsafeAttributesToRender=[];_attrs;_children;_classes;_styles;_customProperties=new Map;constructor(e,t,i,n){if(super(e),this.name=t,this._attrs=function(e){const t=Ra(e);for(const[e,i]of t)null===i?t.delete(e):"string"!=typeof i&&t.set(e,String(i));return t}(i),this._children=[],n&&this._insertChild(0,n),this._classes=new Set,this._attrs.has("class")){const e=this._attrs.get("class");Cl(this._classes,e),this._attrs.delete("class");}this._styles=new wl(this.document.stylesProcessor),this._attrs.has("style")&&(this._styles.setTo(this._attrs.get("style")),this._attrs.delete("style"));}get childCount(){return this._children.length}get isEmpty(){return 0===this._children.length}getChild(e){return this._children[e]}getChildIndex(e){return this._children.indexOf(e)}getChildren(){return this._children[Symbol.iterator]()}*getAttributeKeys(){this._classes.size>0&&(yield "class"),this._styles.isEmpty||(yield "style"),yield*this._attrs.keys();}*getAttributes(){yield*this._attrs.entries(),this._classes.size>0&&(yield ["class",this.getAttribute("class")]),this._styles.isEmpty||(yield ["style",this.getAttribute("style")]);}getAttribute(e){if("class"==e)return this._classes.size>0?[...this._classes].join(" "):void 0;if("style"==e){const e=this._styles.toString();return ""==e?void 0:e}return this._attrs.get(e)}hasAttribute(e){return "class"==e?this._classes.size>0:"style"==e?!this._styles.isEmpty:this._attrs.has(e)}isSimilar(t){if(!(t instanceof e))return !1;if(this===t)return !0;if(this.name!=t.name)return !1;if(this._attrs.size!==t._attrs.size||this._classes.size!==t._classes.size||this._styles.size!==t._styles.size)return !1;for(const[e,i]of this._attrs)if(!t._attrs.has(e)||t._attrs.get(e)!==i)return !1;for(const e of this._classes)if(!t._classes.has(e))return !1;for(const e of this._styles.getStyleNames())if(!t._styles.has(e)||t._styles.getAsString(e)!==this._styles.getAsString(e))return !1;return !0}hasClass(...e){for(const t of e)if(!this._classes.has(t))return !1;return !0}getClassNames(){return this._classes.keys()}getStyle(e){return this._styles.getAsString(e)}getNormalizedStyle(e){return this._styles.getNormalized(e)}getStyleNames(e){return this._styles.getStyleNames(e)}hasStyle(...e){for(const t of e)if(!this._styles.has(t))return !1;return !0}findAncestor(...e){const t=new fl(...e);let i=this.parent;for(;i&&!i.is("documentFragment");){if(t.match(i))return i;i=i.parent;}return null}getCustomProperty(e){return this._customProperties.get(e)}*getCustomProperties(){yield*this._customProperties.entries();}getIdentity(){const e=Array.from(this._classes).sort().join(","),t=this._styles.toString(),i=Array.from(this._attrs).map((e=>`${e[0]}="${e[1]}"`)).sort().join(" ");return this.name+(""==e?"":` class="${e}"`)+(t?` style="${t}"`:"")+(""==i?"":` ${i}`)}shouldRenderUnsafeAttribute(e){return this._unsafeAttributesToRender.includes(e)}_clone(e=!1){const t=[];if(e)for(const i of this.getChildren())t.push(i._clone(e));const i=new this.constructor(this.document,this.name,this._attrs,t);return i._classes=new Set(this._classes),i._styles.set(this._styles.getNormalized()),i._customProperties=new Map(this._customProperties),i.getFillerOffset=this.getFillerOffset,i._unsafeAttributesToRender=this._unsafeAttributesToRender,i}_appendChild(e){return this._insertChild(this.childCount,e)}_insertChild(e,t){this._fireChange("children",this);let i=0;const n=function(e,t){if("string"==typeof t)return [new ml(e,t)];br(t)||(t=[t]);return Array.from(t).map((t=>"string"==typeof t?new ml(e,t):t instanceof gl?new ml(e,t.data):t))}(this.document,t);for(const t of n)null!==t.parent&&t._remove(),t.parent=this,t.document=this.document,this._children.splice(e,0,t),e++,i++;return i}_removeChildren(e,t=1){this._fireChange("children",this);for(let i=e;i<e+t;i++)this._children[i].parent=null;return this._children.splice(e,t)}_setAttribute(e,t){const i=String(t);this._fireChange("attributes",this),"class"==e?Cl(this._classes,i):"style"==e?this._styles.setTo(i):this._attrs.set(e,i);}_removeAttribute(e){return this._fireChange("attributes",this),"class"==e?this._classes.size>0&&(this._classes.clear(),!0):"style"==e?!this._styles.isEmpty&&(this._styles.clear(),!0):this._attrs.delete(e)}_addClass(e){this._fireChange("attributes",this);for(const t of Aa(e))this._classes.add(t);}_removeClass(e){this._fireChange("attributes",this);for(const t of Aa(e))this._classes.delete(t);}_setStyle(e,t){this._fireChange("attributes",this),"string"!=typeof e?this._styles.set(e):this._styles.set(e,t);}_removeStyle(e){this._fireChange("attributes",this);for(const t of Aa(e))this._styles.remove(t);}_setCustomProperty(e,t){this._customProperties.set(e,t);}_removeCustomProperty(e){return this._customProperties.delete(e)}};function Cl(e,t){const i=t.split(/\s+/);e.clear(),i.forEach((t=>e.add(t)));}kl.prototype.is=function(e,t){return t?t===this.name&&("element"===e||"view:element"===e):"element"===e||"view:element"===e||"node"===e||"view:node"===e};class xl extends kl{constructor(e,t,i,n){super(e,t,i,n),this.getFillerOffset=Al;}}function Al(){const e=[...this.getChildren()],t=e[this.childCount-1];if(t&&t.is("element","br"))return this.childCount;for(const t of e)if(!t.is("uiElement"))return null;return this.childCount}xl.prototype.is=function(e,t){return t?t===this.name&&("containerElement"===e||"view:containerElement"===e||"element"===e||"view:element"===e):"containerElement"===e||"view:containerElement"===e||"element"===e||"view:element"===e||"node"===e||"view:node"===e};class El extends(ar(xl)){constructor(e,t,i,n){super(e,t,i,n),this.set("isReadOnly",!1),this.set("isFocused",!1),this.set("placeholder",void 0),this.bind("isReadOnly").to(e),this.bind("isFocused").to(e,"isFocused",(t=>t&&e.selection.editableElement==this)),this.listenTo(e.selection,"change",(()=>{this.isFocused=e.isFocused&&e.selection.editableElement==this;}));}destroy(){this.stopListening();}}El.prototype.is=function(e,t){return t?t===this.name&&("editableElement"===e||"view:editableElement"===e||"containerElement"===e||"view:containerElement"===e||"element"===e||"view:element"===e):"editableElement"===e||"view:editableElement"===e||"containerElement"===e||"view:containerElement"===e||"element"===e||"view:element"===e||"node"===e||"view:node"===e};const Tl=Symbol("rootName");class Sl extends El{constructor(e,t){super(e,t),this.rootName="main";}get rootName(){return this.getCustomProperty(Tl)}set rootName(e){this._setCustomProperty(Tl,e);}set _name(e){this.name=e;}}Sl.prototype.is=function(e,t){return t?t===this.name&&("rootElement"===e||"view:rootElement"===e||"editableElement"===e||"view:editableElement"===e||"containerElement"===e||"view:containerElement"===e||"element"===e||"view:element"===e):"rootElement"===e||"view:rootElement"===e||"editableElement"===e||"view:editableElement"===e||"containerElement"===e||"view:containerElement"===e||"element"===e||"view:element"===e||"node"===e||"view:node"===e};let Il=class{direction;boundaries;singleCharacters;shallow;ignoreElementEnd;_position;_boundaryStartParent;_boundaryEndParent;constructor(e={}){if(!e.boundaries&&!e.startPosition)throw new E("view-tree-walker-no-start-position",null);if(e.direction&&"forward"!=e.direction&&"backward"!=e.direction)throw new E("view-tree-walker-unknown-direction",e.startPosition,{direction:e.direction});this.boundaries=e.boundaries||null,e.startPosition?this._position=Pl._createAt(e.startPosition):this._position=Pl._createAt(e.boundaries["backward"==e.direction?"end":"start"]),this.direction=e.direction||"forward",this.singleCharacters=!!e.singleCharacters,this.shallow=!!e.shallow,this.ignoreElementEnd=!!e.ignoreElementEnd,this._boundaryStartParent=this.boundaries?this.boundaries.start.parent:null,this._boundaryEndParent=this.boundaries?this.boundaries.end.parent:null;}[Symbol.iterator](){return this}get position(){return this._position}skip(e){let t,i;do{i=this.position,t=this.next();}while(!t.done&&e(t.value));t.done||(this._position=i);}next(){return "forward"==this.direction?this._next():this._previous()}_next(){let e=this.position.clone();const t=this.position,i=e.parent;if(null===i.parent&&e.offset===i.childCount)return {done:!0,value:void 0};if(i===this._boundaryEndParent&&e.offset==this.boundaries.end.offset)return {done:!0,value:void 0};let n;if(i instanceof ml){if(e.isAtEnd)return this._position=Pl._createAfter(i),this._next();n=i.data[e.offset];}else n=i.getChild(e.offset);if(n instanceof kl){if(this.shallow){if(this.boundaries&&this.boundaries.end.isBefore(e))return {done:!0,value:void 0};e.offset++;}else e=new Pl(n,0);return this._position=e,this._formatReturnValue("elementStart",n,t,e,1)}if(n instanceof ml){if(this.singleCharacters)return e=new Pl(n,0),this._position=e,this._next();let i,s=n.data.length;return n==this._boundaryEndParent?(s=this.boundaries.end.offset,i=new gl(n,0,s),e=Pl._createAfter(i)):(i=new gl(n,0,n.data.length),e.offset++),this._position=e,this._formatReturnValue("text",i,t,e,s)}if("string"==typeof n){let n;if(this.singleCharacters)n=1;else {n=(i===this._boundaryEndParent?this.boundaries.end.offset:i.data.length)-e.offset;}const s=new gl(i,e.offset,n);return e.offset+=n,this._position=e,this._formatReturnValue("text",s,t,e,n)}return e=Pl._createAfter(i),this._position=e,this.ignoreElementEnd?this._next():this._formatReturnValue("elementEnd",i,t,e)}_previous(){let e=this.position.clone();const t=this.position,i=e.parent;if(null===i.parent&&0===e.offset)return {done:!0,value:void 0};if(i==this._boundaryStartParent&&e.offset==this.boundaries.start.offset)return {done:!0,value:void 0};let n;if(i instanceof ml){if(e.isAtStart)return this._position=Pl._createBefore(i),this._previous();n=i.data[e.offset-1];}else n=i.getChild(e.offset-1);if(n instanceof kl)return this.shallow?(e.offset--,this._position=e,this._formatReturnValue("elementStart",n,t,e,1)):(e=new Pl(n,n.childCount),this._position=e,this.ignoreElementEnd?this._previous():this._formatReturnValue("elementEnd",n,t,e));if(n instanceof ml){if(this.singleCharacters)return e=new Pl(n,n.data.length),this._position=e,this._previous();let i,s=n.data.length;if(n==this._boundaryStartParent){const t=this.boundaries.start.offset;i=new gl(n,t,n.data.length-t),s=i.data.length,e=Pl._createBefore(i);}else i=new gl(n,0,n.data.length),e.offset--;return this._position=e,this._formatReturnValue("text",i,t,e,s)}if("string"==typeof n){let n;if(this.singleCharacters)n=1;else {const t=i===this._boundaryStartParent?this.boundaries.start.offset:0;n=e.offset-t;}e.offset-=n;const s=new gl(i,e.offset,n);return this._position=e,this._formatReturnValue("text",s,t,e,n)}return e=Pl._createBefore(i),this._position=e,this._formatReturnValue("elementStart",i,t,e,1)}_formatReturnValue(e,t,i,n,s){return t instanceof gl&&(t.offsetInText+t.data.length==t.textNode.data.length&&("forward"!=this.direction||this.boundaries&&this.boundaries.end.isEqual(this.position)?i=Pl._createAfter(t.textNode):(n=Pl._createAfter(t.textNode),this._position=n)),0===t.offsetInText&&("backward"!=this.direction||this.boundaries&&this.boundaries.start.isEqual(this.position)?i=Pl._createBefore(t.textNode):(n=Pl._createBefore(t.textNode),this._position=n))),{done:!1,value:{type:e,item:t,previousPosition:i,nextPosition:n,length:s}}}},Pl=class e extends hl{parent;offset;constructor(e,t){super(),this.parent=e,this.offset=t;}get nodeAfter(){return this.parent.is("$text")?null:this.parent.getChild(this.offset)||null}get nodeBefore(){return this.parent.is("$text")?null:this.parent.getChild(this.offset-1)||null}get isAtStart(){return 0===this.offset}get isAtEnd(){const e=this.parent.is("$text")?this.parent.data.length:this.parent.childCount;return this.offset===e}get root(){return this.parent.root}get editableElement(){let e=this.parent;for(;!(e instanceof El);){if(!e.parent)return null;e=e.parent;}return e}getShiftedBy(t){const i=e._createAt(this),n=i.offset+t;return i.offset=n<0?0:n,i}getLastMatchingPosition(e,t={}){t.startPosition=this;const i=new Il(t);return i.skip(e),i.position}getAncestors(){return this.parent.is("documentFragment")?[this.parent]:this.parent.getAncestors({includeSelf:!0})}getCommonAncestor(e){const t=this.getAncestors(),i=e.getAncestors();let n=0;for(;t[n]==i[n]&&t[n];)n++;return 0===n?null:t[n-1]}isEqual(e){return this.parent==e.parent&&this.offset==e.offset}isBefore(e){return "before"==this.compareWith(e)}isAfter(e){return "after"==this.compareWith(e)}compareWith(e){if(this.root!==e.root)return "different";if(this.isEqual(e))return "same";const t=this.parent.is("node")?this.parent.getPath():[],i=e.parent.is("node")?e.parent.getPath():[];t.push(this.offset),i.push(e.offset);const n=pr(t,i);switch(n){case"prefix":return "before";case"extension":return "after";default:return t[n]<i[n]?"before":"after"}}getWalker(e={}){return e.startPosition=this,new Il(e)}clone(){return new e(this.parent,this.offset)}static _createAt(t,i){if(t instanceof e)return new this(t.parent,t.offset);{const n=t;if("end"==i)i=n.is("$text")?n.data.length:n.childCount;else {if("before"==i)return this._createBefore(n);if("after"==i)return this._createAfter(n);if(0!==i&&!i)throw new E("view-createpositionat-offset-required",n)}return new e(n,i)}}static _createAfter(t){if(t.is("$textProxy"))return new e(t.textNode,t.offsetInText+t.data.length);if(!t.parent)throw new E("view-position-after-root",t,{root:t});return new e(t.parent,t.index+1)}static _createBefore(t){if(t.is("$textProxy"))return new e(t.textNode,t.offsetInText);if(!t.parent)throw new E("view-position-before-root",t,{root:t});return new e(t.parent,t.index)}};Pl.prototype.is=function(e){return "position"===e||"view:position"===e};let Vl=class e extends hl{start;end;constructor(e,t=null){super(),this.start=e.clone(),this.end=t?t.clone():e.clone();}*[Symbol.iterator](){yield*new Il({boundaries:this,ignoreElementEnd:!0});}get isCollapsed(){return this.start.isEqual(this.end)}get isFlat(){return this.start.parent===this.end.parent}get root(){return this.start.root}getEnlarged(){let t=this.start.getLastMatchingPosition(Rl,{direction:"backward"}),i=this.end.getLastMatchingPosition(Rl);return t.parent.is("$text")&&t.isAtStart&&(t=Pl._createBefore(t.parent)),i.parent.is("$text")&&i.isAtEnd&&(i=Pl._createAfter(i.parent)),new e(t,i)}getTrimmed(){let t=this.start.getLastMatchingPosition(Rl);if(t.isAfter(this.end)||t.isEqual(this.end))return new e(t,t);let i=this.end.getLastMatchingPosition(Rl,{direction:"backward"});const n=t.nodeAfter,s=i.nodeBefore;return n&&n.is("$text")&&(t=new Pl(n,0)),s&&s.is("$text")&&(i=new Pl(s,s.data.length)),new e(t,i)}isEqual(e){return this==e||this.start.isEqual(e.start)&&this.end.isEqual(e.end)}containsPosition(e){return e.isAfter(this.start)&&e.isBefore(this.end)}containsRange(e,t=!1){e.isCollapsed&&(t=!1);const i=this.containsPosition(e.start)||t&&this.start.isEqual(e.start),n=this.containsPosition(e.end)||t&&this.end.isEqual(e.end);return i&&n}getDifference(t){const i=[];return this.isIntersecting(t)?(this.containsPosition(t.start)&&i.push(new e(this.start,t.start)),this.containsPosition(t.end)&&i.push(new e(t.end,this.end))):i.push(this.clone()),i}getIntersection(t){if(this.isIntersecting(t)){let i=this.start,n=this.end;return this.containsPosition(t.start)&&(i=t.start),this.containsPosition(t.end)&&(n=t.end),new e(i,n)}return null}getWalker(e={}){return e.boundaries=this,new Il(e)}getCommonAncestor(){return this.start.getCommonAncestor(this.end)}getContainedElement(){if(this.isCollapsed)return null;let e=this.start.nodeAfter,t=this.end.nodeBefore;return this.start.parent.is("$text")&&this.start.isAtEnd&&this.start.parent.nextSibling&&(e=this.start.parent.nextSibling),this.end.parent.is("$text")&&this.end.isAtStart&&this.end.parent.previousSibling&&(t=this.end.parent.previousSibling),e&&e.is("element")&&e===t?e:null}clone(){return new e(this.start,this.end)}*getItems(e={}){e.boundaries=this,e.ignoreElementEnd=!0;const t=new Il(e);for(const e of t)yield e.item;}*getPositions(e={}){e.boundaries=this;const t=new Il(e);yield t.position;for(const e of t)yield e.nextPosition;}isIntersecting(e){return this.start.isBefore(e.end)&&this.end.isAfter(e.start)}static _createFromParentsAndOffsets(e,t,i,n){return new this(new Pl(e,t),new Pl(i,n))}static _createFromPositionAndShift(e,t){const i=e,n=e.getShiftedBy(t);return t>0?new this(i,n):new this(n,i)}static _createIn(e){return this._createFromParentsAndOffsets(e,0,e,e.childCount)}static _createOn(e){const t=e.is("$textProxy")?e.offsetSize:1;return this._createFromPositionAndShift(Pl._createBefore(e),t)}};function Rl(e){return !(!e.item.is("attributeElement")&&!e.item.is("uiElement"))}Vl.prototype.is=function(e){return "range"===e||"view:range"===e};let Bl=class e extends(F(hl)){_ranges;_lastRangeBackward;_isFake;_fakeSelectionLabel;constructor(...e){super(),this._ranges=[],this._lastRangeBackward=!1,this._isFake=!1,this._fakeSelectionLabel="",e.length&&this.setTo(...e);}get isFake(){return this._isFake}get fakeSelectionLabel(){return this._fakeSelectionLabel}get anchor(){if(!this._ranges.length)return null;const e=this._ranges[this._ranges.length-1];return (this._lastRangeBackward?e.end:e.start).clone()}get focus(){if(!this._ranges.length)return null;const e=this._ranges[this._ranges.length-1];return (this._lastRangeBackward?e.start:e.end).clone()}get isCollapsed(){return 1===this.rangeCount&&this._ranges[0].isCollapsed}get rangeCount(){return this._ranges.length}get isBackward(){return !this.isCollapsed&&this._lastRangeBackward}get editableElement(){return this.anchor?this.anchor.editableElement:null}*getRanges(){for(const e of this._ranges)yield e.clone();}getFirstRange(){let e=null;for(const t of this._ranges)e&&!t.start.isBefore(e.start)||(e=t);return e?e.clone():null}getLastRange(){let e=null;for(const t of this._ranges)e&&!t.end.isAfter(e.end)||(e=t);return e?e.clone():null}getFirstPosition(){const e=this.getFirstRange();return e?e.start.clone():null}getLastPosition(){const e=this.getLastRange();return e?e.end.clone():null}isEqual(e){if(this.isFake!=e.isFake)return !1;if(this.isFake&&this.fakeSelectionLabel!=e.fakeSelectionLabel)return !1;if(this.rangeCount!=e.rangeCount)return !1;if(0===this.rangeCount)return !0;if(!this.anchor.isEqual(e.anchor)||!this.focus.isEqual(e.focus))return !1;for(const t of this._ranges){let i=!1;for(const n of e._ranges)if(t.isEqual(n)){i=!0;break}if(!i)return !1}return !0}isSimilar(e){if(this.isBackward!=e.isBackward)return !1;const t=fr(this.getRanges());if(t!=fr(e.getRanges()))return !1;if(0==t)return !0;for(let t of this.getRanges()){t=t.getTrimmed();let i=!1;for(let n of e.getRanges())if(n=n.getTrimmed(),t.start.isEqual(n.start)&&t.end.isEqual(n.end)){i=!0;break}if(!i)return !1}return !0}getSelectedElement(){return 1!==this.rangeCount?null:this.getFirstRange().getContainedElement()}setTo(...t){let[i,n,s]=t;if("object"==typeof n&&(s=n,n=void 0),null===i)this._setRanges([]),this._setFakeOptions(s);else if(i instanceof e||i instanceof Ol)this._setRanges(i.getRanges(),i.isBackward),this._setFakeOptions({fake:i.isFake,label:i.fakeSelectionLabel});else if(i instanceof Vl)this._setRanges([i],s&&s.backward),this._setFakeOptions(s);else if(i instanceof Pl)this._setRanges([new Vl(i)]),this._setFakeOptions(s);else if(i instanceof ul){const e=!!s&&!!s.backward;let t;if(void 0===n)throw new E("view-selection-setto-required-second-parameter",this);t="in"==n?Vl._createIn(i):"on"==n?Vl._createOn(i):new Vl(Pl._createAt(i,n)),this._setRanges([t],e),this._setFakeOptions(s);}else {if(!br(i))throw new E("view-selection-setto-not-selectable",this);this._setRanges(i,s&&s.backward),this._setFakeOptions(s);}this.fire("change");}setFocus(e,t){if(null===this.anchor)throw new E("view-selection-setfocus-no-ranges",this);const i=Pl._createAt(e,t);if("same"==i.compareWith(this.focus))return;const n=this.anchor;this._ranges.pop(),"before"==i.compareWith(n)?this._addRange(new Vl(i,n),!0):this._addRange(new Vl(n,i)),this.fire("change");}_setRanges(e,t=!1){e=Array.from(e),this._ranges=[];for(const t of e)this._addRange(t);this._lastRangeBackward=!!t;}_setFakeOptions(e={}){this._isFake=!!e.fake,this._fakeSelectionLabel=e.fake&&e.label||"";}_addRange(e,t=!1){if(!(e instanceof Vl))throw new E("view-selection-add-range-not-range",this);this._pushRange(e),this._lastRangeBackward=!!t;}_pushRange(e){for(const t of this._ranges)if(e.isIntersecting(t))throw new E("view-selection-range-intersects",this,{addedRange:e,intersectingRange:t});this._ranges.push(new Vl(e.start,e.end));}};Bl.prototype.is=function(e){return "selection"===e||"view:selection"===e};let Ol=class extends(F(hl)){_selection;constructor(...e){super(),this._selection=new Bl,this._selection.delegate("change").to(this),e.length&&this._selection.setTo(...e);}get isFake(){return this._selection.isFake}get fakeSelectionLabel(){return this._selection.fakeSelectionLabel}get anchor(){return this._selection.anchor}get focus(){return this._selection.focus}get isCollapsed(){return this._selection.isCollapsed}get rangeCount(){return this._selection.rangeCount}get isBackward(){return this._selection.isBackward}get editableElement(){return this._selection.editableElement}get _ranges(){return this._selection._ranges}*getRanges(){yield*this._selection.getRanges();}getFirstRange(){return this._selection.getFirstRange()}getLastRange(){return this._selection.getLastRange()}getFirstPosition(){return this._selection.getFirstPosition()}getLastPosition(){return this._selection.getLastPosition()}getSelectedElement(){return this._selection.getSelectedElement()}isEqual(e){return this._selection.isEqual(e)}isSimilar(e){return this._selection.isSimilar(e)}_setTo(...e){this._selection.setTo(...e);}_setFocus(e,t){this._selection.setFocus(e,t);}};Ol.prototype.is=function(e){return "selection"===e||"documentSelection"==e||"view:selection"==e||"view:documentSelection"==e};class Ml extends v{startRange;_eventPhase;_currentTarget;constructor(e,t,i){super(e,t),this.startRange=i,this._eventPhase="none",this._currentTarget=null;}get eventPhase(){return this._eventPhase}get currentTarget(){return this._currentTarget}}const Ll=Symbol("bubbling contexts");function Fl(e){return class extends e{fire(e,...t){try{const i=e instanceof v?e:new v(this,e),n=Hl(this);if(!n.size)return;if(Nl(i,"capturing",this),Dl(n,"$capture",i,...t))return i.return;const s=i.startRange||this.selection.getFirstRange(),o=s?s.getContainedElement():null,r=!!o&&Boolean(zl(n,o));let a=o||function(e){if(!e)return null;const t=e.start.parent,i=e.end.parent,n=t.getPath(),s=i.getPath();return n.length>s.length?t:i}(s);if(Nl(i,"atTarget",a),!r){if(Dl(n,"$text",i,...t))return i.return;Nl(i,"bubbling",a);}for(;a;){if(a.is("rootElement")){if(Dl(n,"$root",i,...t))return i.return}else if(a.is("element")&&Dl(n,a.name,i,...t))return i.return;if(Dl(n,a,i,...t))return i.return;a=a.parent,Nl(i,"bubbling",a);}return Nl(i,"bubbling",this),Dl(n,"$document",i,...t),i.return}catch(e){E.rethrowUnexpectedError(e,this);}}_addEventListener(e,t,i){const n=Aa(i.context||"$document"),s=Hl(this);for(const o of n){let n=s.get(o);n||(n=new(F()),s.set(o,n)),this.listenTo(n,e,t,i);}}_removeEventListener(e,t){const i=Hl(this);for(const n of i.values())this.stopListening(n,e,t);}}}{const e=Fl(Object);["fire","_addEventListener","_removeEventListener"].forEach((t=>{Fl[t]=e.prototype[t];}));}function Nl(e,t,i){e instanceof Ml&&(e._eventPhase=t,e._currentTarget=i);}function Dl(e,t,i,...n){const s="string"==typeof t?e.get(t):zl(e,t);return !!s&&(s.fire(i,...n),i.stop.called)}function zl(e,t){for(const[i,n]of e)if("function"==typeof i&&i(t))return n;return null}function Hl(e){return e[Ll]||(e[Ll]=new Map),e[Ll]}let $l=class extends(Fl(ar())){selection;roots;stylesProcessor;_postFixers=new Set;constructor(e){super(),this.selection=new Ol,this.roots=new Sa({idProperty:"rootName"}),this.stylesProcessor=e,this.set("isReadOnly",!1),this.set("isFocused",!1),this.set("isSelecting",!1),this.set("isComposing",!1);}getRoot(e="main"){return this.roots.get(e)}registerPostFixer(e){this._postFixers.add(e);}destroy(){this.roots.forEach((e=>e.destroy())),this.stopListening();}_callPostFixers(e){let t=!1;do{for(const i of this._postFixers)if(t=i(e),t)break}while(t)}};class Ul extends kl{static DEFAULT_PRIORITY=10;_priority=10;_id=null;_clonesGroup=null;constructor(e,t,i,n){super(e,t,i,n),this.getFillerOffset=Wl;}get priority(){return this._priority}get id(){return this._id}getElementsWithSameId(){if(null===this.id)throw new E("attribute-element-get-elements-with-same-id-no-id",this);return new Set(this._clonesGroup)}isSimilar(e){return null!==this.id||null!==e.id?this.id===e.id:super.isSimilar(e)&&this.priority==e.priority}_clone(e=!1){const t=super._clone(e);return t._priority=this._priority,t._id=this._id,t}}function Wl(){if(jl(this))return null;let e=this.parent;for(;e&&e.is("attributeElement");){if(jl(e)>1)return null;e=e.parent;}return !e||jl(e)>1?null:this.childCount}function jl(e){return Array.from(e.getChildren()).filter((e=>!e.is("uiElement"))).length}Ul.prototype.is=function(e,t){return t?t===this.name&&("attributeElement"===e||"view:attributeElement"===e||"element"===e||"view:element"===e):"attributeElement"===e||"view:attributeElement"===e||"element"===e||"view:element"===e||"node"===e||"view:node"===e};class ql extends kl{constructor(e,t,i,n){super(e,t,i,n),this.getFillerOffset=Gl;}_insertChild(e,t){if(t&&(t instanceof ul||Array.from(t).length>0))throw new E("view-emptyelement-cannot-add",[this,t]);return 0}}function Gl(){return null}ql.prototype.is=function(e,t){return t?t===this.name&&("emptyElement"===e||"view:emptyElement"===e||"element"===e||"view:element"===e):"emptyElement"===e||"view:emptyElement"===e||"element"===e||"view:element"===e||"node"===e||"view:node"===e};class Kl extends kl{constructor(e,t,i,n){super(e,t,i,n),this.getFillerOffset=Jl;}_insertChild(e,t){if(t&&(t instanceof ul||Array.from(t).length>0))throw new E("view-uielement-cannot-add",[this,t]);return 0}render(e,t){return this.toDomElement(e)}toDomElement(e){const t=e.createElement(this.name);for(const e of this.getAttributeKeys())t.setAttribute(e,this.getAttribute(e));return t}}function Zl(e){e.document.on("arrowKey",((t,i)=>function(e,t,i){if(t.keyCode==ga.arrowright){const e=t.domTarget.ownerDocument.defaultView.getSelection(),n=1==e.rangeCount&&e.getRangeAt(0).collapsed;if(n||t.shiftKey){const t=e.focusNode,s=e.focusOffset,o=i.domPositionToView(t,s);if(null===o)return;let r=!1;const a=o.getLastMatchingPosition((e=>(e.item.is("uiElement")&&(r=!0),!(!e.item.is("uiElement")&&!e.item.is("attributeElement")))));if(r){const t=i.viewPositionToDom(a);n?e.collapse(t.parent,t.offset):e.extend(t.parent,t.offset);}}}}(0,i,e.domConverter)),{priority:"low"});}function Jl(){return null}Kl.prototype.is=function(e,t){return t?t===this.name&&("uiElement"===e||"view:uiElement"===e||"element"===e||"view:element"===e):"uiElement"===e||"view:uiElement"===e||"element"===e||"view:element"===e||"node"===e||"view:node"===e};class Ql extends kl{constructor(e,t,i,n){super(e,t,i,n),this.getFillerOffset=Yl;}_insertChild(e,t){if(t&&(t instanceof ul||Array.from(t).length>0))throw new E("view-rawelement-cannot-add",[this,t]);return 0}render(e,t){}}function Yl(){return null}Ql.prototype.is=function(e,t){return t?t===this.name&&("rawElement"===e||"view:rawElement"===e||"element"===e||"view:element"===e):"rawElement"===e||"view:rawElement"===e||e===this.name||e==="view:"+this.name||"element"===e||"view:element"===e||"node"===e||"view:node"===e};let Xl=class extends(F(hl)){document;_children=[];_customProperties=new Map;constructor(e,t){super(),this.document=e,t&&this._insertChild(0,t);}[Symbol.iterator](){return this._children[Symbol.iterator]()}get childCount(){return this._children.length}get isEmpty(){return 0===this.childCount}get root(){return this}get parent(){return null}get name(){}get getFillerOffset(){}getCustomProperty(e){return this._customProperties.get(e)}*getCustomProperties(){yield*this._customProperties.entries();}_appendChild(e){return this._insertChild(this.childCount,e)}getChild(e){return this._children[e]}getChildIndex(e){return this._children.indexOf(e)}getChildren(){return this._children[Symbol.iterator]()}_insertChild(e,t){this._fireChange("children",this);let i=0;const n=function(e,t){if("string"==typeof t)return [new ml(e,t)];br(t)||(t=[t]);return Array.from(t).map((t=>"string"==typeof t?new ml(e,t):t instanceof gl?new ml(e,t.data):t))}(this.document,t);for(const t of n)null!==t.parent&&t._remove(),t.parent=this,this._children.splice(e,0,t),e++,i++;return i}_removeChildren(e,t=1){this._fireChange("children",this);for(let i=e;i<e+t;i++)this._children[i].parent=null;return this._children.splice(e,t)}_fireChange(e,t){this.fire("change:"+e,t);}_setCustomProperty(e,t){this._customProperties.set(e,t);}_removeCustomProperty(e){return this._customProperties.delete(e)}};Xl.prototype.is=function(e){return "documentFragment"===e||"view:documentFragment"===e};class ec{document;_cloneGroups=new Map;_slotFactory=null;constructor(e){this.document=e;}setSelection(...e){this.document.selection._setTo(...e);}setSelectionFocus(e,t){this.document.selection._setFocus(e,t);}createDocumentFragment(e){return new Xl(this.document,e)}createText(e){return new ml(this.document,e)}createAttributeElement(e,t,i={}){const n=new Ul(this.document,e,t);return "number"==typeof i.priority&&(n._priority=i.priority),i.id&&(n._id=i.id),i.renderUnsafeAttributes&&n._unsafeAttributesToRender.push(...i.renderUnsafeAttributes),n}createContainerElement(e,t,i={},n={}){let s=null;fi(i)?n=i:s=i;const o=new xl(this.document,e,t,s);return n.renderUnsafeAttributes&&o._unsafeAttributesToRender.push(...n.renderUnsafeAttributes),o}createEditableElement(e,t,i={}){const n=new El(this.document,e,t);return i.renderUnsafeAttributes&&n._unsafeAttributesToRender.push(...i.renderUnsafeAttributes),n}createEmptyElement(e,t,i={}){const n=new ql(this.document,e,t);return i.renderUnsafeAttributes&&n._unsafeAttributesToRender.push(...i.renderUnsafeAttributes),n}createUIElement(e,t,i){const n=new Kl(this.document,e,t);return i&&(n.render=i),n}createRawElement(e,t,i,n={}){const s=new Ql(this.document,e,t);return i&&(s.render=i),n.renderUnsafeAttributes&&s._unsafeAttributesToRender.push(...n.renderUnsafeAttributes),s}setAttribute(e,t,i){i._setAttribute(e,t);}removeAttribute(e,t){t._removeAttribute(e);}addClass(e,t){t._addClass(e);}removeClass(e,t){t._removeClass(e);}setStyle(e,t,i){fi(e)&&void 0===i?t._setStyle(e):i._setStyle(e,t);}removeStyle(e,t){t._removeStyle(e);}setCustomProperty(e,t,i){i._setCustomProperty(e,t);}removeCustomProperty(e,t){return t._removeCustomProperty(e)}breakAttributes(e){return e instanceof Pl?this._breakAttributes(e):this._breakAttributesRange(e)}breakContainer(e){const t=e.parent;if(!t.is("containerElement"))throw new E("view-writer-break-non-container-element",this.document);if(!t.parent)throw new E("view-writer-break-root",this.document);if(e.isAtStart)return Pl._createBefore(t);if(!e.isAtEnd){const i=t._clone(!1);this.insert(Pl._createAfter(t),i);const n=new Vl(e,Pl._createAt(t,"end")),s=new Pl(i,0);this.move(n,s);}return Pl._createAfter(t)}mergeAttributes(e){const t=e.offset,i=e.parent;if(i.is("$text"))return e;if(i.is("attributeElement")&&0===i.childCount){const e=i.parent,t=i.index;return i._remove(),this._removeFromClonedElementsGroup(i),this.mergeAttributes(new Pl(e,t))}const n=i.getChild(t-1),s=i.getChild(t);if(!n||!s)return e;if(n.is("$text")&&s.is("$text"))return oc(n,s);if(n.is("attributeElement")&&s.is("attributeElement")&&n.isSimilar(s)){const e=n.childCount;return n._appendChild(s.getChildren()),s._remove(),this._removeFromClonedElementsGroup(s),this.mergeAttributes(new Pl(n,e))}return e}mergeContainers(e){const t=e.nodeBefore,i=e.nodeAfter;if(!(t&&i&&t.is("containerElement")&&i.is("containerElement")))throw new E("view-writer-merge-containers-invalid-position",this.document);const n=t.getChild(t.childCount-1),s=n instanceof ml?Pl._createAt(n,"end"):Pl._createAt(t,"end");return this.move(Vl._createIn(i),Pl._createAt(t,"end")),this.remove(Vl._createOn(i)),s}insert(e,t){ac(t=br(t)?[...t]:[t],this.document);const i=t.reduce(((e,t)=>{const i=e[e.length-1],n=!t.is("uiElement");return i&&i.breakAttributes==n?i.nodes.push(t):e.push({breakAttributes:n,nodes:[t]}),e}),[]);let n=null,s=e;for(const{nodes:e,breakAttributes:t}of i){const i=this._insertNodes(s,e,t);n||(n=i.start),s=i.end;}return n?new Vl(n,s):new Vl(e)}remove(e){const t=e instanceof Vl?e:Vl._createOn(e);if(cc(t,this.document),t.isCollapsed)return new Xl(this.document);const{start:i,end:n}=this._breakAttributesRange(t,!0),s=i.parent,o=n.offset-i.offset,r=s._removeChildren(i.offset,o);for(const e of r)this._removeFromClonedElementsGroup(e);const a=this.mergeAttributes(i);return t.start=a,t.end=a.clone(),new Xl(this.document,r)}clear(e,t){cc(e,this.document);const i=e.getWalker({direction:"backward",ignoreElementEnd:!0});for(const n of i){const i=n.item;let s;if(i.is("element")&&t.isSimilar(i))s=Vl._createOn(i);else if(!n.nextPosition.isAfter(e.start)&&i.is("$textProxy")){const e=i.getAncestors().find((e=>e.is("element")&&t.isSimilar(e)));e&&(s=Vl._createIn(e));}s&&(s.end.isAfter(e.end)&&(s.end=e.end),s.start.isBefore(e.start)&&(s.start=e.start),this.remove(s));}}move(e,t){let i;if(t.isAfter(e.end)){const n=(t=this._breakAttributes(t,!0)).parent,s=n.childCount;e=this._breakAttributesRange(e,!0),i=this.remove(e),t.offset+=n.childCount-s;}else i=this.remove(e);return this.insert(t,i)}wrap(e,t){if(!(t instanceof Ul))throw new E("view-writer-wrap-invalid-attribute",this.document);if(cc(e,this.document),e.isCollapsed){let i=e.start;i.parent.is("element")&&!function(e){return Array.from(e.getChildren()).some((e=>!e.is("uiElement")))}(i.parent)&&(i=i.getLastMatchingPosition((e=>e.item.is("uiElement")))),i=this._wrapPosition(i,t);const n=this.document.selection;return n.isCollapsed&&n.getFirstPosition().isEqual(e.start)&&this.setSelection(i),new Vl(i)}return this._wrapRange(e,t)}unwrap(e,t){if(!(t instanceof Ul))throw new E("view-writer-unwrap-invalid-attribute",this.document);if(cc(e,this.document),e.isCollapsed)return e;const{start:i,end:n}=this._breakAttributesRange(e,!0),s=i.parent,o=this._unwrapChildren(s,i.offset,n.offset,t),r=this.mergeAttributes(o.start);r.isEqual(o.start)||o.end.offset--;const a=this.mergeAttributes(o.end);return new Vl(r,a)}rename(e,t){const i=new xl(this.document,e,t.getAttributes());return this.insert(Pl._createAfter(t),i),this.move(Vl._createIn(t),Pl._createAt(i,0)),this.remove(Vl._createOn(t)),i}clearClonedElementsGroup(e){this._cloneGroups.delete(e);}createPositionAt(e,t){return Pl._createAt(e,t)}createPositionAfter(e){return Pl._createAfter(e)}createPositionBefore(e){return Pl._createBefore(e)}createRange(e,t){return new Vl(e,t)}createRangeOn(e){return Vl._createOn(e)}createRangeIn(e){return Vl._createIn(e)}createSelection(...e){return new Bl(...e)}createSlot(e="children"){if(!this._slotFactory)throw new E("view-writer-invalid-create-slot-context",this.document);return this._slotFactory(this,e)}_registerSlotFactory(e){this._slotFactory=e;}_clearSlotFactory(){this._slotFactory=null;}_insertNodes(e,t,i){let n,s;if(n=i?tc(e):e.parent.is("$text")?e.parent.parent:e.parent,!n)throw new E("view-writer-invalid-position-container",this.document);s=i?this._breakAttributes(e,!0):e.parent.is("$text")?sc(e):e;const o=n._insertChild(s.offset,t);for(const e of t)this._addToClonedElementsGroup(e);const r=s.getShiftedBy(o),a=this.mergeAttributes(s);a.isEqual(s)||r.offset--;const l=this.mergeAttributes(r);return new Vl(a,l)}_wrapChildren(e,t,i,n){let s=t;const o=[];for(;s<i;){const t=e.getChild(s),i=t.is("$text"),r=t.is("attributeElement");if(r&&this._wrapAttributeElement(n,t))o.push(new Pl(e,s));else if(i||!r||ic(n,t)){const i=n._clone();t._remove(),i._appendChild(t),e._insertChild(s,i),this._addToClonedElementsGroup(i),o.push(new Pl(e,s));}else this._wrapChildren(t,0,t.childCount,n);s++;}let r=0;for(const e of o){if(e.offset-=r,e.offset==t)continue;this.mergeAttributes(e).isEqual(e)||(r++,i--);}return Vl._createFromParentsAndOffsets(e,t,e,i)}_unwrapChildren(e,t,i,n){let s=t;const o=[];for(;s<i;){const t=e.getChild(s);if(t.is("attributeElement"))if(t.isSimilar(n)){const n=t.getChildren(),r=t.childCount;t._remove(),e._insertChild(s,n),this._removeFromClonedElementsGroup(t),o.push(new Pl(e,s),new Pl(e,s+r)),s+=r,i+=r-1;}else this._unwrapAttributeElement(n,t)?(o.push(new Pl(e,s),new Pl(e,s+1)),s++):(this._unwrapChildren(t,0,t.childCount,n),s++);else s++;}let r=0;for(const e of o){if(e.offset-=r,e.offset==t||e.offset==i)continue;this.mergeAttributes(e).isEqual(e)||(r++,i--);}return Vl._createFromParentsAndOffsets(e,t,e,i)}_wrapRange(e,t){const{start:i,end:n}=this._breakAttributesRange(e,!0),s=i.parent,o=this._wrapChildren(s,i.offset,n.offset,t),r=this.mergeAttributes(o.start);r.isEqual(o.start)||o.end.offset--;const a=this.mergeAttributes(o.end);return new Vl(r,a)}_wrapPosition(e,t){if(t.isSimilar(e.parent))return nc(e.clone());e.parent.is("$text")&&(e=sc(e));const i=this.createAttributeElement("_wrapPosition-fake-element");i._priority=Number.POSITIVE_INFINITY,i.isSimilar=()=>!1,e.parent._insertChild(e.offset,i);const n=new Vl(e,e.getShiftedBy(1));this.wrap(n,t);const s=new Pl(i.parent,i.index);i._remove();const o=s.nodeBefore,r=s.nodeAfter;return o instanceof ml&&r instanceof ml?oc(o,r):nc(s)}_wrapAttributeElement(e,t){if(!dc(e,t))return !1;if(e.name!==t.name||e.priority!==t.priority)return !1;for(const i of e.getAttributeKeys())if("class"!==i&&"style"!==i&&t.hasAttribute(i)&&t.getAttribute(i)!==e.getAttribute(i))return !1;for(const i of e.getStyleNames())if(t.hasStyle(i)&&t.getStyle(i)!==e.getStyle(i))return !1;for(const i of e.getAttributeKeys())"class"!==i&&"style"!==i&&(t.hasAttribute(i)||this.setAttribute(i,e.getAttribute(i),t));for(const i of e.getStyleNames())t.hasStyle(i)||this.setStyle(i,e.getStyle(i),t);for(const i of e.getClassNames())t.hasClass(i)||this.addClass(i,t);return !0}_unwrapAttributeElement(e,t){if(!dc(e,t))return !1;if(e.name!==t.name||e.priority!==t.priority)return !1;for(const i of e.getAttributeKeys())if("class"!==i&&"style"!==i&&(!t.hasAttribute(i)||t.getAttribute(i)!==e.getAttribute(i)))return !1;if(!t.hasClass(...e.getClassNames()))return !1;for(const i of e.getStyleNames())if(!t.hasStyle(i)||t.getStyle(i)!==e.getStyle(i))return !1;for(const i of e.getAttributeKeys())"class"!==i&&"style"!==i&&this.removeAttribute(i,t);return this.removeClass(Array.from(e.getClassNames()),t),this.removeStyle(Array.from(e.getStyleNames()),t),!0}_breakAttributesRange(e,t=!1){const i=e.start,n=e.end;if(cc(e,this.document),e.isCollapsed){const i=this._breakAttributes(e.start,t);return new Vl(i,i)}const s=this._breakAttributes(n,t),o=s.parent.childCount,r=this._breakAttributes(i,t);return s.offset+=s.parent.childCount-o,new Vl(r,s)}_breakAttributes(e,t=!1){const i=e.offset,n=e.parent;if(e.parent.is("emptyElement"))throw new E("view-writer-cannot-break-empty-element",this.document);if(e.parent.is("uiElement"))throw new E("view-writer-cannot-break-ui-element",this.document);if(e.parent.is("rawElement"))throw new E("view-writer-cannot-break-raw-element",this.document);if(!t&&n.is("$text")&&lc(n.parent))return e.clone();if(lc(n))return e.clone();if(n.is("$text"))return this._breakAttributes(sc(e),t);if(i==n.childCount){const e=new Pl(n.parent,n.index+1);return this._breakAttributes(e,t)}if(0===i){const e=new Pl(n.parent,n.index);return this._breakAttributes(e,t)}{const e=n.index+1,s=n._clone();n.parent._insertChild(e,s),this._addToClonedElementsGroup(s);const o=n.childCount-i,r=n._removeChildren(i,o);s._appendChild(r);const a=new Pl(n.parent,e);return this._breakAttributes(a,t)}}_addToClonedElementsGroup(e){if(!e.root.is("rootElement"))return;if(e.is("element"))for(const t of e.getChildren())this._addToClonedElementsGroup(t);const t=e.id;if(!t)return;let i=this._cloneGroups.get(t);i||(i=new Set,this._cloneGroups.set(t,i)),i.add(e),e._clonesGroup=i;}_removeFromClonedElementsGroup(e){if(e.is("element"))for(const t of e.getChildren())this._removeFromClonedElementsGroup(t);const t=e.id;if(!t)return;const i=this._cloneGroups.get(t);i&&i.delete(e);}}function tc(e){let t=e.parent;for(;!lc(t);){if(!t)return;t=t.parent;}return t}function ic(e,t){return e.priority<t.priority||!(e.priority>t.priority)&&e.getIdentity()<t.getIdentity()}function nc(e){const t=e.nodeBefore;if(t&&t.is("$text"))return new Pl(t,t.data.length);const i=e.nodeAfter;return i&&i.is("$text")?new Pl(i,0):e}function sc(e){if(e.offset==e.parent.data.length)return new Pl(e.parent.parent,e.parent.index+1);if(0===e.offset)return new Pl(e.parent.parent,e.parent.index);const t=e.parent.data.slice(e.offset);return e.parent._data=e.parent.data.slice(0,e.offset),e.parent.parent._insertChild(e.parent.index+1,new ml(e.root.document,t)),new Pl(e.parent.parent,e.parent.index+1)}function oc(e,t){const i=e.data.length;return e._data+=t.data,t._remove(),new Pl(e,i)}const rc=[ml,Ul,xl,ql,Ql,Kl];function ac(e,t){for(const i of e){if(!rc.some((e=>i instanceof e)))throw new E("view-writer-insert-invalid-node-type",t);i.is("$text")||ac(i.getChildren(),t);}}function lc(e){return e&&(e.is("containerElement")||e.is("documentFragment"))}function cc(e,t){const i=tc(e.start),n=tc(e.end);if(!i||!n||i!==n)throw new E("view-writer-invalid-range-container",t)}function dc(e,t){return null===e.id&&null===t.id}const hc=e=>e.createTextNode(" "),uc=e=>{const t=e.createElement("span");return t.dataset.ckeFiller="true",t.innerText=" ",t},mc=e=>{const t=e.createElement("br");return t.dataset.ckeFiller="true",t},gc=7,fc="⁠".repeat(gc);function pc(e){return "string"==typeof e?e.substr(0,gc)===fc:Br(e)&&e.data.substr(0,gc)===fc}function bc(e){return e.data.length==gc&&pc(e)}function wc(e){const t="string"==typeof e?e:e.data;return pc(e)?t.slice(gc):t}function _c(e,t){if(t.keyCode==ga.arrowleft){const e=t.domTarget.ownerDocument.defaultView.getSelection();if(1==e.rangeCount&&e.getRangeAt(0).collapsed){const t=e.getRangeAt(0).startContainer,i=e.getRangeAt(0).startOffset;pc(t)&&i<=gc&&e.collapse(t,0);}}}let vc=class extends(ar()){domDocuments=new Set;domConverter;markedAttributes=new Set;markedChildren=new Set;markedTexts=new Set;selection;_inlineFiller=null;_fakeSelectionContainer=null;constructor(e,t){super(),this.domConverter=e,this.selection=t,this.set("isFocused",!1),this.set("isSelecting",!1),this.set("isComposing",!1),o.isBlink&&!o.isAndroid&&this.on("change:isSelecting",(()=>{this.isSelecting||this.render();}));}markToSync(e,t){if("text"===e)this.domConverter.mapViewToDom(t.parent)&&this.markedTexts.add(t);else {if(!this.domConverter.mapViewToDom(t))return;if("attributes"===e)this.markedAttributes.add(t);else {if("children"!==e)throw new E("view-renderer-unknown-type",this);this.markedChildren.add(t);}}}render(){if(this.isComposing&&!o.isAndroid)return;let e=null;const t=!(o.isBlink&&!o.isAndroid)||!this.isSelecting;for(const e of this.markedChildren)this._updateChildrenMappings(e);t?(this._inlineFiller&&!this._isSelectionInInlineFiller()&&this._removeInlineFiller(),this._inlineFiller?e=this._getInlineFillerPosition():this._needsInlineFillerAtSelection()&&(e=this.selection.getFirstPosition(),this.markedChildren.add(e.parent))):this._inlineFiller&&this._inlineFiller.parentNode&&(e=this.domConverter.domPositionToView(this._inlineFiller),e&&e.parent.is("$text")&&(e=Pl._createBefore(e.parent)));for(const e of this.markedAttributes)this._updateAttrs(e);for(const t of this.markedChildren)this._updateChildren(t,{inlineFillerPosition:e});for(const t of this.markedTexts)!this.markedChildren.has(t.parent)&&this.domConverter.mapViewToDom(t.parent)&&this._updateText(t,{inlineFillerPosition:e});if(t)if(e){const t=this.domConverter.viewPositionToDom(e),i=t.parent.ownerDocument;pc(t.parent)?this._inlineFiller=t.parent:this._inlineFiller=yc(i,t.parent,t.offset);}else this._inlineFiller=null;this._updateFocus(),this._updateSelection(),this.domConverter._clearTemporaryCustomProperties(),this.markedTexts.clear(),this.markedAttributes.clear(),this.markedChildren.clear();}_updateChildrenMappings(e){const t=this.domConverter.mapViewToDom(e);if(!t)return;const i=Array.from(t.childNodes),n=Array.from(this.domConverter.viewChildrenToDom(e,{withChildren:!1})),s=this._diffNodeLists(i,n),o=this._findUpdateActions(s,i,n,kc);if(-1!==o.indexOf("update")){const t={equal:0,insert:0,delete:0};for(const s of o)if("update"===s){const s=t.equal+t.insert,o=t.equal+t.delete,r=e.getChild(s);!r||r.is("uiElement")||r.is("rawElement")||this._updateElementMappings(r,i[o]),Xr(n[s]),t.equal++;}else t[s]++;}}_updateElementMappings(e,t){this.domConverter.unbindDomElement(t),this.domConverter.bindElements(t,e),this.markedChildren.add(e),this.markedAttributes.add(e);}_getInlineFillerPosition(){const e=this.selection.getFirstPosition();return e.parent.is("$text")?Pl._createBefore(e.parent):e}_isSelectionInInlineFiller(){if(1!=this.selection.rangeCount||!this.selection.isCollapsed)return !1;const e=this.selection.getFirstPosition(),t=this.domConverter.viewPositionToDom(e);return !!(t&&Br(t.parent)&&pc(t.parent))}_removeInlineFiller(){const e=this._inlineFiller;if(!pc(e))throw new E("view-renderer-filler-was-lost",this);bc(e)?e.remove():e.data=e.data.substr(gc),this._inlineFiller=null;}_needsInlineFillerAtSelection(){if(1!=this.selection.rangeCount||!this.selection.isCollapsed)return !1;const e=this.selection.getFirstPosition(),t=e.parent,i=e.offset;if(!this.domConverter.mapViewToDom(t.root))return !1;if(!t.is("element"))return !1;if(!function(e){if("false"==e.getAttribute("contenteditable"))return !1;const t=e.findAncestor((e=>e.hasAttribute("contenteditable")));return !t||"true"==t.getAttribute("contenteditable")}(t))return !1;const n=e.nodeBefore,s=e.nodeAfter;return !(n instanceof ml||s instanceof ml)&&(!!(i!==t.getFillerOffset()||n&&n.is("element","br"))&&(!o.isAndroid||!n&&!s))}_updateText(e,t){const i=this.domConverter.findCorrespondingDomText(e);let n=this.domConverter.viewToDom(e).data;const s=t.inlineFillerPosition;s&&s.parent==e.parent&&s.offset==e.index&&(n=fc+n),this._updateTextNode(i,n);}_updateAttrs(e){const t=this.domConverter.mapViewToDom(e);if(!t)return;const i=Array.from(t.attributes).map((e=>e.name)),n=e.getAttributeKeys();for(const i of n)this.domConverter.setDomElementAttribute(t,i,e.getAttribute(i),e);for(const n of i)e.hasAttribute(n)||this.domConverter.removeDomElementAttribute(t,n);}_updateChildren(e,t){const i=this.domConverter.mapViewToDom(e);if(!i)return;if(o.isAndroid){let e=null;for(const t of Array.from(i.childNodes)){if(e&&Br(e)&&Br(t)){i.normalize();break}e=t;}}const n=t.inlineFillerPosition,s=i.childNodes,r=Array.from(this.domConverter.viewChildrenToDom(e,{bind:!0}));n&&n.parent===e&&yc(i.ownerDocument,r,n.offset);const a=this._diffNodeLists(s,r),l=this._findUpdateActions(a,s,r,Cc);let c=0;const d=new Set;for(const e of l)"delete"===e?(d.add(s[c]),Xr(s[c])):"equal"!==e&&"update"!==e||c++;c=0;for(const e of l)"insert"===e?(qr(i,c,r[c]),c++):"update"===e?(this._updateTextNode(s[c],r[c].data),c++):"equal"===e&&(this._markDescendantTextToSync(this.domConverter.domToView(r[c])),c++);for(const e of d)e.parentNode||this.domConverter.unbindDomElement(e);}_diffNodeLists(e,t){return e=function(e,t){const i=Array.from(e);if(0==i.length||!t)return i;const n=i[i.length-1];n==t&&i.pop();return i}(e,this._fakeSelectionContainer),b(e,t,xc.bind(null,this.domConverter))}_findUpdateActions(e,t,i,n){if(-1===e.indexOf("insert")||-1===e.indexOf("delete"))return e;let s=[],o=[],r=[];const a={equal:0,insert:0,delete:0};for(const l of e)"insert"===l?r.push(i[a.equal+a.insert]):"delete"===l?o.push(t[a.equal+a.delete]):(s=s.concat(b(o,r,n).map((e=>"equal"===e?"update":e))),s.push("equal"),o=[],r=[]),a[l]++;return s.concat(b(o,r,n).map((e=>"equal"===e?"update":e)))}_updateTextNode(e,t){const i=e.data;i!=t&&(o.isAndroid&&this.isComposing&&i.replace(/\u00A0/g," ")==t.replace(/\u00A0/g," ")||this._updateTextNodeInternal(e,t));}_updateTextNodeInternal(e,t){const i=g(e.data,t);for(const t of i)"insert"===t.type?e.insertData(t.index,t.values.join("")):e.deleteData(t.index,t.howMany);}_markDescendantTextToSync(e){if(e)if(e.is("$text"))this.markedTexts.add(e);else if(e.is("element"))for(const t of e.getChildren())this._markDescendantTextToSync(t);}_updateSelection(){if(o.isBlink&&!o.isAndroid&&this.isSelecting&&!this.markedChildren.size)return;if(0===this.selection.rangeCount)return this._removeDomSelection(),void this._removeFakeSelection();const e=this.domConverter.mapViewToDom(this.selection.editableElement);this.isFocused&&e&&(this.selection.isFake?this._updateFakeSelection(e):this._fakeSelectionContainer&&this._fakeSelectionContainer.isConnected?(this._removeFakeSelection(),this._updateDomSelection(e)):this.isComposing&&o.isAndroid||this._updateDomSelection(e));}_updateFakeSelection(e){const t=e.ownerDocument;this._fakeSelectionContainer||(this._fakeSelectionContainer=function(e){const t=e.createElement("div");return t.className="ck-fake-selection-container",Object.assign(t.style,{position:"fixed",top:0,left:"-9999px",width:"42px"}),t.textContent=" ",t}(t));const i=this._fakeSelectionContainer;if(this.domConverter.bindFakeSelection(i,this.selection),!this._fakeSelectionNeedsUpdate(e))return;i.parentElement&&i.parentElement==e||e.appendChild(i),i.textContent=this.selection.fakeSelectionLabel||" ";const n=t.getSelection(),s=t.createRange();n.removeAllRanges(),s.selectNodeContents(i),n.addRange(s);}_updateDomSelection(e){const t=e.ownerDocument.defaultView.getSelection();if(!this._domSelectionNeedsUpdate(t))return;const i=this.domConverter.viewPositionToDom(this.selection.anchor),n=this.domConverter.viewPositionToDom(this.selection.focus);t.setBaseAndExtent(i.parent,i.offset,n.parent,n.offset),o.isGecko&&function(e,t){let i=e.parent,n=e.offset;Br(i)&&bc(i)&&(n=jr(i)+1,i=i.parentNode);if(i.nodeType!=Node.ELEMENT_NODE||n!=i.childNodes.length-1)return;const s=i.childNodes[n];s&&"BR"==s.tagName&&t.addRange(t.getRangeAt(0));}(n,t);}_domSelectionNeedsUpdate(e){if(!this.domConverter.isDomSelectionCorrect(e))return !0;const t=e&&this.domConverter.domSelectionToView(e);return (!t||!this.selection.isEqual(t))&&!(!this.selection.isCollapsed&&this.selection.isSimilar(t))}_fakeSelectionNeedsUpdate(e){const t=this._fakeSelectionContainer,i=e.ownerDocument.getSelection();return !t||t.parentElement!==e||(i.anchorNode!==t&&!t.contains(i.anchorNode)||t.textContent!==this.selection.fakeSelectionLabel)}_removeDomSelection(){for(const e of this.domDocuments){const t=e.getSelection();if(t.rangeCount){const i=e.activeElement,n=this.domConverter.mapDomToView(i);i&&n&&t.removeAllRanges();}}}_removeFakeSelection(){const e=this._fakeSelectionContainer;e&&e.remove();}_updateFocus(){if(this.isFocused){const e=this.selection.editableElement;e&&this.domConverter.focus(e);}}};function yc(e,t,i){const n=t instanceof Array?t:t.childNodes,s=n[i];if(Br(s))return s.data=fc+s.data,s;{const s=e.createTextNode(fc);return Array.isArray(t)?n.splice(i,0,s):qr(t,i,s),s}}function kc(e,t){return kr(e)&&kr(t)&&!Br(e)&&!Br(t)&&!Gr(e)&&!Gr(t)&&e.tagName.toLowerCase()===t.tagName.toLowerCase()}function Cc(e,t){return kr(e)&&kr(t)&&Br(e)&&Br(t)}function xc(e,t,i){return t===i||(Br(t)&&Br(i)?t.data===i.data:!(!e.isBlockFiller(t)||!e.isBlockFiller(i)))}const Ac=mc(i.document),Ec=hc(i.document),Tc=uc(i.document),Sc="data-ck-unsafe-attribute-",Ic="data-ck-unsafe-element";class Pc{document;renderingMode;blockFillerMode;preElements;blockElements;inlineObjectElements;unsafeElements;_domDocument;_domToViewMapping=new WeakMap;_viewToDomMapping=new WeakMap;_fakeSelectionMapping=new WeakMap;_rawContentElementMatcher=new fl;_inlineObjectElementMatcher=new fl;_elementsWithTemporaryCustomProperties=new Set;constructor(e,{blockFillerMode:t,renderingMode:n="editing"}={}){this.document=e,this.renderingMode=n,this.blockFillerMode=t||("editing"===n?"br":"nbsp"),this.preElements=["pre"],this.blockElements=["address","article","aside","blockquote","caption","center","dd","details","dir","div","dl","dt","fieldset","figcaption","figure","footer","form","h1","h2","h3","h4","h5","h6","header","hgroup","legend","li","main","menu","nav","ol","p","pre","section","summary","table","tbody","td","tfoot","th","thead","tr","ul"],this.inlineObjectElements=["object","iframe","input","button","textarea","select","option","video","embed","audio","img","canvas"],this.unsafeElements=["script","style"],this._domDocument="editing"===this.renderingMode?i.document:i.document.implementation.createHTMLDocument("");}bindFakeSelection(e,t){this._fakeSelectionMapping.set(e,new Bl(t));}fakeSelectionToView(e){return this._fakeSelectionMapping.get(e)}bindElements(e,t){this._domToViewMapping.set(e,t),this._viewToDomMapping.set(t,e);}unbindDomElement(e){const t=this._domToViewMapping.get(e);if(t){this._domToViewMapping.delete(e),this._viewToDomMapping.delete(t);for(const t of Array.from(e.children))this.unbindDomElement(t);}}bindDocumentFragments(e,t){this._domToViewMapping.set(e,t),this._viewToDomMapping.set(t,e);}shouldRenderAttribute(e,t,i){return "data"===this.renderingMode||!(e=e.toLowerCase()).startsWith("on")&&(("srcdoc"!==e||!t.match(/\bon\S+\s*=|javascript:|<\s*\/*script/i))&&("img"===i&&("src"===e||"srcset"===e)||("source"===i&&"srcset"===e||!t.match(/^\s*(javascript:|data:(image\/svg|text\/x?html))/i))))}setContentOf(e,t){if("data"===this.renderingMode)return void(e.innerHTML=t);const i=(new DOMParser).parseFromString(t,"text/html"),n=i.createDocumentFragment(),s=i.body.childNodes;for(;s.length>0;)n.appendChild(s[0]);const o=i.createTreeWalker(n,NodeFilter.SHOW_ELEMENT),r=[];let a;for(;a=o.nextNode();)r.push(a);for(const e of r){for(const t of e.getAttributeNames())this.setDomElementAttribute(e,t,e.getAttribute(t));const t=e.tagName.toLowerCase();this._shouldRenameElement(t)&&(Bc(t),e.replaceWith(this._createReplacementDomElement(t,e)));}for(;e.firstChild;)e.firstChild.remove();e.append(n);}viewToDom(e,t={}){if(e.is("$text")){const t=this._processDataFromViewText(e);return this._domDocument.createTextNode(t)}{const i=e;if(this.mapViewToDom(i)){if(!i.getCustomProperty("editingPipeline:doNotReuseOnce"))return this.mapViewToDom(i);this._elementsWithTemporaryCustomProperties.add(i);}let n;if(i.is("documentFragment"))n=this._domDocument.createDocumentFragment(),t.bind&&this.bindDocumentFragments(n,i);else {if(i.is("uiElement"))return n="$comment"===i.name?this._domDocument.createComment(i.getCustomProperty("$rawContent")):i.render(this._domDocument,this),t.bind&&this.bindElements(n,i),n;this._shouldRenameElement(i.name)?(Bc(i.name),n=this._createReplacementDomElement(i.name)):n=i.hasAttribute("xmlns")?this._domDocument.createElementNS(i.getAttribute("xmlns"),i.name):this._domDocument.createElement(i.name),i.is("rawElement")&&i.render(n,this),t.bind&&this.bindElements(n,i);for(const e of i.getAttributeKeys())this.setDomElementAttribute(n,e,i.getAttribute(e),i);}if(!1!==t.withChildren)for(const e of this.viewChildrenToDom(i,t))n instanceof HTMLTemplateElement?n.content.appendChild(e):n.appendChild(e);return n}}setDomElementAttribute(e,t,i,n){const s=this.shouldRenderAttribute(t,i,e.tagName.toLowerCase())||n&&n.shouldRenderUnsafeAttribute(t);s||T("domconverter-unsafe-attribute-detected",{domElement:e,key:t,value:i}),Kr(t)?(e.hasAttribute(t)&&!s?e.removeAttribute(t):e.hasAttribute(Sc+t)&&s&&e.removeAttribute(Sc+t),e.setAttribute(s?t:Sc+t,i)):T("domconverter-invalid-attribute-detected",{domElement:e,key:t,value:i});}removeDomElementAttribute(e,t){t!=Ic&&(e.removeAttribute(t),e.removeAttribute(Sc+t));}*viewChildrenToDom(e,t={}){const i=e.getFillerOffset&&e.getFillerOffset();let n=0;for(const s of e.getChildren()){i===n&&(yield this._getBlockFiller());const e=s.is("element")&&!!s.getCustomProperty("dataPipeline:transparentRendering")&&!Ia(s.getAttributes());if(e&&"data"==this.renderingMode)if(s.is("rawElement")){const e=this._domDocument.createElement(s.name);s.render(e,this),yield*[...e.childNodes];}else yield*this.viewChildrenToDom(s,t);else e&&T("domconverter-transparent-rendering-unsupported-in-editing-pipeline",{viewElement:s}),yield this.viewToDom(s,t);n++;}i===n&&(yield this._getBlockFiller());}viewRangeToDom(e){const t=this.viewPositionToDom(e.start),i=this.viewPositionToDom(e.end),n=this._domDocument.createRange();return n.setStart(t.parent,t.offset),n.setEnd(i.parent,i.offset),n}viewPositionToDom(e){const t=e.parent;if(t.is("$text")){const i=this.findCorrespondingDomText(t);if(!i)return null;let n=e.offset;return pc(i)&&(n+=gc),{parent:i,offset:n}}{let i,n,s;if(0===e.offset){if(i=this.mapViewToDom(t),!i)return null;s=i.childNodes[0];}else {const t=e.nodeBefore;if(n=t.is("$text")?this.findCorrespondingDomText(t):this.mapViewToDom(t),!n)return null;i=n.parentNode,s=n.nextSibling;}if(Br(s)&&pc(s))return {parent:s,offset:gc};return {parent:i,offset:n?jr(n)+1:0}}}domToView(e,t={}){const i=[],n=this._domToView(e,t,i),s=n.next().value;return s?(n.next(),this._processDomInlineNodes(null,i,t),s.is("$text")&&0==s.data.length?null:s):null}*domChildrenToView(e,t={},i=[]){let n=[];n=e instanceof HTMLTemplateElement?[...e.content.childNodes]:[...e.childNodes];for(let s=0;s<n.length;s++){const o=n[s],r=this._domToView(o,t,i),a=r.next().value;null!==a&&(this._isBlockViewElement(a)&&this._processDomInlineNodes(e,i,t),yield a,r.next());}this._processDomInlineNodes(e,i,t);}domSelectionToView(e){if(function(e){if(!o.isGecko)return !1;if(!e.rangeCount)return !1;const t=e.getRangeAt(0).startContainer;try{Object.prototype.toString.call(t);}catch(e){return !0}return !1}(e))return new Bl([]);if(1===e.rangeCount){let t=e.getRangeAt(0).startContainer;Br(t)&&(t=t.parentNode);const i=this.fakeSelectionToView(t);if(i)return i}const t=this.isDomSelectionBackward(e),i=[];for(let t=0;t<e.rangeCount;t++){const n=e.getRangeAt(t),s=this.domRangeToView(n);s&&i.push(s);}return new Bl(i,{backward:t})}domRangeToView(e){const t=this.domPositionToView(e.startContainer,e.startOffset),i=this.domPositionToView(e.endContainer,e.endOffset);return t&&i?new Vl(t,i):null}domPositionToView(e,t=0){if(this.isBlockFiller(e))return this.domPositionToView(e.parentNode,jr(e));const i=this.mapDomToView(e);if(i&&(i.is("uiElement")||i.is("rawElement")))return Pl._createBefore(i);if(Br(e)){if(bc(e))return this.domPositionToView(e.parentNode,jr(e));const i=this.findCorrespondingViewText(e);let n=t;return i?(pc(e)&&(n-=gc,n=n<0?0:n),new Pl(i,n)):null}if(0===t){const t=this.mapDomToView(e);if(t)return new Pl(t,0)}else {const i=e.childNodes[t-1];if(Br(i)&&bc(i)||i&&this.isBlockFiller(i))return this.domPositionToView(i.parentNode,jr(i));const n=Br(i)?this.findCorrespondingViewText(i):this.mapDomToView(i);if(n&&n.parent)return new Pl(n.parent,n.index+1)}return null}mapDomToView(e){return this.getHostViewElement(e)||this._domToViewMapping.get(e)}findCorrespondingViewText(e){if(bc(e))return null;const t=this.getHostViewElement(e);if(t)return t;const i=e.previousSibling;if(i){if(!this.isElement(i))return null;const e=this.mapDomToView(i);if(e){const t=e.nextSibling;return t instanceof ml?t:null}}else {const t=this.mapDomToView(e.parentNode);if(t){const e=t.getChild(0);return e instanceof ml?e:null}}return null}mapViewToDom(e){return this._viewToDomMapping.get(e)}findCorrespondingDomText(e){const t=e.previousSibling;return t&&this.mapViewToDom(t)?this.mapViewToDom(t).nextSibling:!t&&e.parent&&this.mapViewToDom(e.parent)?this.mapViewToDom(e.parent).childNodes[0]:null}focus(e){const t=this.mapViewToDom(e);if(t&&t.ownerDocument.activeElement!==t){const{scrollX:e,scrollY:n}=i.window,s=[];Vc(t,(e=>{const{scrollLeft:t,scrollTop:i}=e;s.push([t,i]);})),t.focus(),Vc(t,(e=>{const[t,i]=s.shift();e.scrollLeft=t,e.scrollTop=i;})),i.window.scrollTo(e,n);}}_clearDomSelection(){const e=this.mapViewToDom(this.document.selection.editableElement);if(!e)return;const t=e.ownerDocument.defaultView.getSelection(),i=this.domSelectionToView(t);i&&i.rangeCount>0&&t.removeAllRanges();}isElement(e){return e&&e.nodeType==Node.ELEMENT_NODE}isDocumentFragment(e){return e&&e.nodeType==Node.DOCUMENT_FRAGMENT_NODE}isBlockFiller(e){return "br"==this.blockFillerMode?e.isEqualNode(Ac):!("BR"!==e.tagName||!Rc(e,this.blockElements)||1!==e.parentNode.childNodes.length)||(e.isEqualNode(Tc)||function(e,t){const i=e.isEqualNode(Ec);return i&&Rc(e,t)&&1===e.parentNode.childNodes.length}(e,this.blockElements))}isDomSelectionBackward(e){if(e.isCollapsed)return !1;const t=this._domDocument.createRange();try{t.setStart(e.anchorNode,e.anchorOffset),t.setEnd(e.focusNode,e.focusOffset);}catch(e){return !1}const i=t.collapsed;return t.detach(),i}getHostViewElement(e){const t=Ir(e);for(t.pop();t.length;){const e=t.pop(),i=this._domToViewMapping.get(e);if(i&&(i.is("uiElement")||i.is("rawElement")))return i}return null}isDomSelectionCorrect(e){return this._isDomSelectionPositionCorrect(e.anchorNode,e.anchorOffset)&&this._isDomSelectionPositionCorrect(e.focusNode,e.focusOffset)}registerRawContentMatcher(e){this._rawContentElementMatcher.add(e);}registerInlineObjectMatcher(e){this._inlineObjectElementMatcher.add(e);}_clearTemporaryCustomProperties(){for(const e of this._elementsWithTemporaryCustomProperties)e._removeCustomProperty("editingPipeline:doNotReuseOnce");this._elementsWithTemporaryCustomProperties.clear();}_getBlockFiller(){switch(this.blockFillerMode){case"nbsp":return hc(this._domDocument);case"markedNbsp":return uc(this._domDocument);case"br":return mc(this._domDocument)}}_isDomSelectionPositionCorrect(e,t){if(Br(e)&&pc(e)&&t<gc)return !1;if(this.isElement(e)&&pc(e.childNodes[t]))return !1;const i=this.mapDomToView(e);return !i||!i.is("uiElement")&&!i.is("rawElement")}*_domToView(e,t,i){if(this.isBlockFiller(e))return null;const n=this.getHostViewElement(e);if(n)return n;if(Gr(e)&&t.skipComments)return null;if(Br(e)){if(bc(e))return null;{const t=e.data;if(""===t)return null;const n=new ml(this.document,t);return i.push(n),n}}{let n=this.mapDomToView(e);if(n)return this._isInlineObjectElement(n)&&i.push(n),n;if(this.isDocumentFragment(e))n=new Xl(this.document),t.bind&&this.bindDocumentFragments(e,n);else {n=this._createViewElement(e,t),t.bind&&this.bindElements(e,n);const s=e.attributes;if(s)for(let e=s.length,t=0;t<e;t++)n._setAttribute(s[t].name,s[t].value);if(this._isViewElementWithRawContent(n,t))return n._setCustomProperty("$rawContent",e.innerHTML),this._isBlockViewElement(n)||i.push(n),n;if(Gr(e))return n._setCustomProperty("$rawContent",e.data),n}yield n;const s=[];if(!1!==t.withChildren)for(const i of this.domChildrenToView(e,t,s))n._appendChild(i);if(this._isInlineObjectElement(n))i.push(n);else for(const e of s)i.push(e);}}_processDomInlineNodes(e,t,i){if(!t.length)return;if(e&&!this.isDocumentFragment(e)&&!this._isBlockDomElement(e))return;let n=!1;for(let e=0;e<t.length;e++){const s=t[e];if(!s.is("$text")){n=!1;continue}let o,r=!1;if(this._isPreFormatted(s))o=wc(s.data);else {o=s.data.replace(/[ \n\t\r]{1,}/g," "),r=/[^\S\u00A0]/.test(o.charAt(o.length-1));const a=e>0?t[e-1]:null,l=e+1<t.length?t[e+1]:null,c=!a||a.is("element")&&"br"==a.name||n,d=!l&&!pc(s.data);!1!==i.withChildren&&(c&&(o=o.replace(/^ /,"")),d&&(o=o.replace(/ $/,""))),o=wc(o),o=o.replace(/ \u00A0/g,"  ");const h=l&&l.is("element")&&"br"!=l.name,u=l&&l.is("$text")&&" "==l.data.charAt(0);(/[ \u00A0]\u00A0$/.test(o)||!l||h||u)&&(o=o.replace(/\u00A0$/," ")),(c||a&&a.is("element")&&"br"!=a.name)&&(o=o.replace(/^\u00A0/," "));}0==o.length&&s.parent?(s._remove(),t.splice(e,1),e--):(s._data=o,n=r);}t.length=0;}_processDataFromViewText(e){let t=e.data;if(this._isPreFormatted(e))return t;if(" "==t.charAt(0)){const i=this._getTouchingInlineViewNode(e,!1);!(i&&i.is("$textProxy")&&this._nodeEndsWithSpace(i))&&i||(t=" "+t.substr(1));}if(" "==t.charAt(t.length-1)){const i=this._getTouchingInlineViewNode(e,!0),n=i&&i.is("$textProxy")&&" "==i.data.charAt(0);" "!=t.charAt(t.length-2)&&i&&!n||(t=t.substr(0,t.length-1)+" ");}return t.replace(/ {2}/g,"  ")}_nodeEndsWithSpace(e){if(this._isPreFormatted(e))return !1;const t=this._processDataFromViewText(e);return " "==t.charAt(t.length-1)}_isPreFormatted(e){if(function(e,t){return e.getAncestors().some((e=>e.is("element")&&t.includes(e.name)))}(e,this.preElements))return !0;for(const t of e.getAncestors({parentFirst:!0}))if(t.is("element")&&t.hasStyle("white-space")&&"inherit"!==t.getStyle("white-space"))return ["pre","pre-wrap","break-spaces"].includes(t.getStyle("white-space"));return !1}_getTouchingInlineViewNode(e,t){const i=new Il({startPosition:t?Pl._createAfter(e):Pl._createBefore(e),direction:t?"forward":"backward"});for(const{item:e}of i){if(e.is("$textProxy"))return e;if(!e.is("element")||!e.getCustomProperty("dataPipeline:transparentRendering")){if(e.is("element","br"))return null;if(this._isInlineObjectElement(e))return e;if(e.is("containerElement"))return null}}return null}_isBlockDomElement(e){return this.isElement(e)&&this.blockElements.includes(e.tagName.toLowerCase())}_isBlockViewElement(e){return e.is("element")&&this.blockElements.includes(e.name)}_isInlineObjectElement(e){return !!e.is("element")&&("br"==e.name||this.inlineObjectElements.includes(e.name)||!!this._inlineObjectElementMatcher.match(e))}_createViewElement(e,t){if(Gr(e))return new Kl(this.document,"$comment");const i=t.keepOriginalCase?e.tagName:e.tagName.toLowerCase();return new kl(this.document,i)}_isViewElementWithRawContent(e,t){return !1!==t.withChildren&&e.is("element")&&!!this._rawContentElementMatcher.match(e)}_shouldRenameElement(e){const t=e.toLowerCase();return "editing"===this.renderingMode&&this.unsafeElements.includes(t)}_createReplacementDomElement(e,t){const i=this._domDocument.createElement("span");if(i.setAttribute(Ic,e),t){for(;t.firstChild;)i.appendChild(t.firstChild);for(const e of t.getAttributeNames())i.setAttribute(e,t.getAttribute(e));}return i}}function Vc(e,t){let i=e;for(;i;)t(i),i=i.parentElement;}function Rc(e,t){const i=e.parentNode;return !!i&&!!i.tagName&&t.includes(i.tagName.toLowerCase())}function Bc(e){"script"===e&&T("domconverter-unsafe-script-element-detected"),"style"===e&&T("domconverter-unsafe-style-element-detected");}class Oc extends(Ar()){view;document;_isEnabled=!1;constructor(e){super(),this.view=e,this.document=e.document;}get isEnabled(){return this._isEnabled}enable(){this._isEnabled=!0;}disable(){this._isEnabled=!1;}destroy(){this.disable(),this.stopListening();}checkShouldIgnoreEventFromTarget(e){return e&&3===e.nodeType&&(e=e.parentNode),!(!e||1!==e.nodeType)&&e.matches("[data-cke-ignore-events], [data-cke-ignore-events] *")}}class Mc{view;document;domEvent;domTarget;constructor(e,t,i){this.view=e,this.document=e.document,this.domEvent=t,this.domTarget=t.target,Lt(this,i);}get target(){return this.view.domConverter.mapDomToView(this.domTarget)}preventDefault(){this.domEvent.preventDefault();}stopPropagation(){this.domEvent.stopPropagation();}}class Lc extends Oc{useCapture=!1;observe(e){("string"==typeof this.domEventType?[this.domEventType]:this.domEventType).forEach((t=>{this.listenTo(e,t,((e,t)=>{this.isEnabled&&!this.checkShouldIgnoreEventFromTarget(t.target)&&this.onDomEvent(t);}),{useCapture:this.useCapture});}));}stopObserving(e){this.stopListening(e);}fire(e,t,i){this.isEnabled&&this.document.fire(e,new Mc(this.view,t,i));}}class Fc extends Lc{domEventType=["keydown","keyup"];onDomEvent(e){const t={keyCode:e.keyCode,altKey:e.altKey,ctrlKey:e.ctrlKey,shiftKey:e.shiftKey,metaKey:e.metaKey,get keystroke(){return pa(this)}};this.fire(e.type,e,t);}}class Nc extends Oc{_fireSelectionChangeDoneDebounced;constructor(e){super(e),this._fireSelectionChangeDoneDebounced=Vo((e=>{this.document.fire("selectionChangeDone",e);}),200);}observe(){const e=this.document;e.on("arrowKey",((t,i)=>{e.selection.isFake&&this.isEnabled&&i.preventDefault();}),{context:"$capture"}),e.on("arrowKey",((t,i)=>{e.selection.isFake&&this.isEnabled&&this._handleSelectionMove(i.keyCode);}),{priority:"lowest"});}stopObserving(){}destroy(){super.destroy(),this._fireSelectionChangeDoneDebounced.cancel();}_handleSelectionMove(e){const t=this.document.selection,i=new Bl(t.getRanges(),{backward:t.isBackward,fake:!1});e!=ga.arrowleft&&e!=ga.arrowup||i.setTo(i.getFirstPosition()),e!=ga.arrowright&&e!=ga.arrowdown||i.setTo(i.getLastPosition());const n={oldSelection:t,newSelection:i,domSelection:null};this.document.fire("selectionChange",n),this._fireSelectionChangeDoneDebounced(n);}}let Dc=class extends Oc{domConverter;_config;_domElements;_mutationObserver;constructor(e){super(e),this._config={childList:!0,characterData:!0,subtree:!0},this.domConverter=e.domConverter,this._domElements=new Set,this._mutationObserver=new window.MutationObserver(this._onMutations.bind(this));}flush(){this._onMutations(this._mutationObserver.takeRecords());}observe(e){this._domElements.add(e),this.isEnabled&&this._mutationObserver.observe(e,this._config);}stopObserving(e){if(this._domElements.delete(e),this.isEnabled){this._mutationObserver.disconnect();for(const e of this._domElements)this._mutationObserver.observe(e,this._config);}}enable(){super.enable();for(const e of this._domElements)this._mutationObserver.observe(e,this._config);}disable(){super.disable(),this._mutationObserver.disconnect();}destroy(){super.destroy(),this._mutationObserver.disconnect();}_onMutations(e){if(0===e.length)return;const t=this.domConverter,i=new Set,n=new Set;for(const i of e){const e=t.mapDomToView(i.target);e&&(e.is("uiElement")||e.is("rawElement")||"childList"!==i.type||this._isBogusBrMutation(i)||n.add(e));}for(const s of e){const e=t.mapDomToView(s.target);if((!e||!e.is("uiElement")&&!e.is("rawElement"))&&"characterData"===s.type){const e=t.findCorrespondingViewText(s.target);e&&!n.has(e.parent)?i.add(e):!e&&pc(s.target)&&n.add(t.mapDomToView(s.target.parentNode));}}const s=[];for(const e of i)s.push({type:"text",node:e});for(const e of n){const i=t.mapViewToDom(e),n=Array.from(e.getChildren()),c=Array.from(t.domChildrenToView(i,{withChildren:!1}));o=n,r=c,l=void 0,(void 0===(l=(a="function"==typeof(a=zc)?a:void 0)?a(o,r):void 0)?ho(o,r,void 0,a):l)||s.push({type:"children",node:e});}var o,r,a,l;s.length&&this.document.fire("mutations",{mutations:s});}_isBogusBrMutation(e){let t=null;return null===e.nextSibling&&0===e.removedNodes.length&&1==e.addedNodes.length&&(t=this.domConverter.domToView(e.addedNodes[0],{withChildren:!1})),t&&t.is("element","br")}};function zc(e,t){if(!Array.isArray(e))return e===t||!(!e.is("$text")||!t.is("$text"))&&e.data===t.data}class Hc extends Lc{_renderTimeoutId=null;_isFocusChanging=!1;domEventType=["focus","blur"];constructor(e){super(e),this.useCapture=!0;const t=this.document;t.on("focus",(()=>this._handleFocus())),t.on("blur",((e,t)=>this._handleBlur(t))),t.on("beforeinput",(()=>{t.isFocused||this._handleFocus();}),{priority:"highest"});}flush(){this._isFocusChanging&&(this._isFocusChanging=!1,this.document.isFocused=!0);}onDomEvent(e){this.fire(e.type,e);}destroy(){this._clearTimeout(),super.destroy();}_handleFocus(){this._clearTimeout(),this._isFocusChanging=!0,this._renderTimeoutId=setTimeout((()=>{this._renderTimeoutId=null,this.flush(),this.view.change((()=>{}));}),50);}_handleBlur(e){const t=this.document.selection.editableElement;null!==t&&t!==e.target||(this.document.isFocused=!1,this._isFocusChanging=!1,this.view.change((()=>{})));}_clearTimeout(){this._renderTimeoutId&&(clearTimeout(this._renderTimeoutId),this._renderTimeoutId=null);}}class $c extends Oc{mutationObserver;focusObserver;selection;domConverter;_documents;_fireSelectionChangeDoneDebounced;_clearInfiniteLoopInterval;_documentIsSelectingInactivityTimeoutDebounced;_loopbackCounter;constructor(e){super(e),this.mutationObserver=e.getObserver(Dc),this.focusObserver=e.getObserver(Hc),this.selection=this.document.selection,this.domConverter=e.domConverter,this._documents=new WeakSet,this._fireSelectionChangeDoneDebounced=Vo((e=>{this.document.fire("selectionChangeDone",e);}),200),this._clearInfiniteLoopInterval=setInterval((()=>this._clearInfiniteLoop()),1e3),this._documentIsSelectingInactivityTimeoutDebounced=Vo((()=>this.document.isSelecting=!1),5e3),this._loopbackCounter=0;}observe(e){const t=e.ownerDocument,i=()=>{this.document.isSelecting&&(this._handleSelectionChange(t),this.document.isSelecting=!1,this._documentIsSelectingInactivityTimeoutDebounced.cancel());};this.listenTo(e,"selectstart",(()=>{this.document.isSelecting=!0,this._documentIsSelectingInactivityTimeoutDebounced();}),{priority:"highest"}),this.listenTo(e,"keydown",i,{priority:"highest",useCapture:!0}),this.listenTo(e,"keyup",i,{priority:"highest",useCapture:!0}),this._documents.has(t)||(this.listenTo(t,"mouseup",i,{priority:"highest",useCapture:!0}),this.listenTo(t,"selectionchange",((e,i)=>{this.document.isComposing&&!o.isAndroid||(this._handleSelectionChange(t),this._documentIsSelectingInactivityTimeoutDebounced());})),this.listenTo(this.view.document,"compositionstart",(()=>{this._handleSelectionChange(t);}),{priority:"lowest"}),this._documents.add(t));}stopObserving(e){this.stopListening(e);}destroy(){super.destroy(),clearInterval(this._clearInfiniteLoopInterval),this._fireSelectionChangeDoneDebounced.cancel(),this._documentIsSelectingInactivityTimeoutDebounced.cancel();}_reportInfiniteLoop(){}_handleSelectionChange(e){if(!this.isEnabled)return;const t=e.defaultView.getSelection();if(this.checkShouldIgnoreEventFromTarget(t.anchorNode))return;this.mutationObserver.flush();const i=this.domConverter.domSelectionToView(t);if(0!=i.rangeCount){if(this.view.hasDomSelection=!0,this.focusObserver.flush(),!this.selection.isEqual(i)||!this.domConverter.isDomSelectionCorrect(t))if(++this._loopbackCounter>60)this._reportInfiniteLoop();else if(this.selection.isSimilar(i))this.view.forceRender();else {const e={oldSelection:this.selection,newSelection:i,domSelection:t};this.document.fire("selectionChange",e),this._fireSelectionChangeDoneDebounced(e);}}else this.view.hasDomSelection=!1;}_clearInfiniteLoop(){this._loopbackCounter=0;}}class Uc extends Lc{domEventType=["compositionstart","compositionupdate","compositionend"];constructor(e){super(e);const t=this.document;t.on("compositionstart",(()=>{t.isComposing=!0;}),{priority:"low"}),t.on("compositionend",(()=>{t.isComposing=!1;}),{priority:"low"});}onDomEvent(e){this.fire(e.type,e,{data:e.data});}}class Wc{_files;_native;constructor(e,t={}){this._files=t.cacheFiles?jc(e):null,this._native=e;}get files(){return this._files||(this._files=jc(this._native)),this._files}get types(){return this._native.types}getData(e){return this._native.getData(e)}setData(e,t){this._native.setData(e,t);}set effectAllowed(e){this._native.effectAllowed=e;}get effectAllowed(){return this._native.effectAllowed}set dropEffect(e){this._native.dropEffect=e;}get dropEffect(){return this._native.dropEffect}setDragImage(e,t,i){this._native.setDragImage(e,t,i);}get isCanceled(){return "none"==this._native.dropEffect||!!this._native.mozUserCancelled}}function jc(e){const t=Array.from(e.files||[]),i=Array.from(e.items||[]);return t.length?t:i.filter((e=>"file"===e.kind)).map((e=>e.getAsFile()))}class qc extends Lc{domEventType="beforeinput";onDomEvent(e){const t=e.getTargetRanges(),i=this.view,n=i.document;let s=null,r=null,a=[];if(e.dataTransfer&&(s=new Wc(e.dataTransfer)),null!==e.data?r=e.data:s&&(r=s.getData("text/plain")),n.selection.isFake)a=Array.from(n.selection.getRanges());else if(t.length)a=t.map((e=>{const t=i.domConverter.domPositionToView(e.startContainer,e.startOffset),n=i.domConverter.domPositionToView(e.endContainer,e.endOffset);return t?i.createRange(t,n):n?i.createRange(n):void 0})).filter((e=>!!e));else if(o.isAndroid){const t=e.target.ownerDocument.defaultView.getSelection();a=Array.from(i.domConverter.domSelectionToView(t).getRanges());}if(o.isAndroid&&"insertCompositionText"==e.inputType&&r&&r.endsWith("\n"))this.fire(e.type,e,{inputType:"insertParagraph",targetRanges:[i.createRange(a[0].end)]});else if("insertText"==e.inputType&&r&&r.includes("\n")){const t=r.split(/\n{1,2}/g);let i=a;for(let o=0;o<t.length;o++){const r=t[o];""!=r&&(this.fire(e.type,e,{data:r,dataTransfer:s,targetRanges:i,inputType:e.inputType,isComposing:e.isComposing}),i=[n.selection.getFirstRange()]),o+1<t.length&&(this.fire(e.type,e,{inputType:"insertParagraph",targetRanges:i}),i=[n.selection.getFirstRange()]);}}else this.fire(e.type,e,{data:r,dataTransfer:s,targetRanges:a,inputType:e.inputType,isComposing:e.isComposing});}}class Gc extends Oc{constructor(e){super(e),this.document.on("keydown",((e,t)=>{if(this.isEnabled&&_a(t.keyCode)){const i=new Ml(this.document,"arrowKey",this.document.selection.getFirstRange());this.document.fire(i,t),i.stop.called&&e.stop();}}));}observe(){}stopObserving(){}}class Kc extends Oc{constructor(e){super(e);const t=this.document;t.on("keydown",((e,i)=>{if(!this.isEnabled||i.keyCode!=ga.tab||i.ctrlKey)return;const n=new Ml(t,"tab",t.selection.getFirstRange());t.fire(n,i),n.stop.called&&e.stop();}));}observe(){}stopObserving(){}}let Zc=class extends(ar()){document;domConverter;domRoots=new Map;_renderer;_initialDomRootAttributes=new WeakMap;_observers=new Map;_writer;_ongoingChange=!1;_postFixersInProgress=!1;_renderingDisabled=!1;_hasChangedSinceTheLastRendering=!1;constructor(e){super(),this.document=new $l(e),this.domConverter=new Pc(this.document),this.set("isRenderingInProgress",!1),this.set("hasDomSelection",!1),this._renderer=new vc(this.domConverter,this.document.selection),this._renderer.bind("isFocused","isSelecting","isComposing").to(this.document,"isFocused","isSelecting","isComposing"),this._writer=new ec(this.document),this.addObserver(Dc),this.addObserver(Hc),this.addObserver($c),this.addObserver(Fc),this.addObserver(Nc),this.addObserver(Uc),this.addObserver(Gc),this.addObserver(qc),this.addObserver(Kc),this.document.on("arrowKey",_c,{priority:"low"}),Zl(this),this.on("render",(()=>{this._render(),this.document.fire("layoutChanged"),this._hasChangedSinceTheLastRendering=!1;})),this.listenTo(this.document.selection,"change",(()=>{this._hasChangedSinceTheLastRendering=!0;})),this.listenTo(this.document,"change:isFocused",(()=>{this._hasChangedSinceTheLastRendering=!0;})),o.isiOS&&this.listenTo(this.document,"blur",((e,t)=>{this.domConverter.mapDomToView(t.domEvent.relatedTarget)||this.domConverter._clearDomSelection();})),this.listenTo(this.document,"mutations",((e,{mutations:t})=>{t.forEach((e=>this._renderer.markToSync(e.type,e.node)));}),{priority:"low"}),this.listenTo(this.document,"mutations",(()=>{this.forceRender();}),{priority:"lowest"});}attachDomRoot(e,t="main"){const i=this.document.getRoot(t);i._name=e.tagName.toLowerCase();const n={};for(const{name:t,value:s}of Array.from(e.attributes))n[t]=s,"class"===t?this._writer.addClass(s.split(" "),i):i.hasAttribute(t)||this._writer.setAttribute(t,s,i);this._initialDomRootAttributes.set(e,n);const s=()=>{this._writer.setAttribute("contenteditable",(!i.isReadOnly).toString(),i),i.isReadOnly?this._writer.addClass("ck-read-only",i):this._writer.removeClass("ck-read-only",i);};s(),this.domRoots.set(t,e),this.domConverter.bindElements(e,i),this._renderer.markToSync("children",i),this._renderer.markToSync("attributes",i),this._renderer.domDocuments.add(e.ownerDocument),i.on("change:children",((e,t)=>this._renderer.markToSync("children",t))),i.on("change:attributes",((e,t)=>this._renderer.markToSync("attributes",t))),i.on("change:text",((e,t)=>this._renderer.markToSync("text",t))),i.on("change:isReadOnly",(()=>this.change(s))),i.on("change",(()=>{this._hasChangedSinceTheLastRendering=!0;}));for(const i of this._observers.values())i.observe(e,t);}detachDomRoot(e){const t=this.domRoots.get(e);Array.from(t.attributes).forEach((({name:e})=>t.removeAttribute(e)));const i=this._initialDomRootAttributes.get(t);for(const e in i)t.setAttribute(e,i[e]);this.domRoots.delete(e),this.domConverter.unbindDomElement(t);for(const e of this._observers.values())e.stopObserving(t);}getDomRoot(e="main"){return this.domRoots.get(e)}addObserver(e){let t=this._observers.get(e);if(t)return t;t=new e(this),this._observers.set(e,t);for(const[e,i]of this.domRoots)t.observe(i,e);return t.enable(),t}getObserver(e){return this._observers.get(e)}disableObservers(){for(const e of this._observers.values())e.disable();}enableObservers(){for(const e of this._observers.values())e.enable();}scrollToTheSelection({alignToTop:e,forceScroll:t,viewportOffset:i=20,ancestorOffset:n=20}={}){const s=this.document.selection.getFirstRange();if(!s)return;const o=Is({alignToTop:e,forceScroll:t,viewportOffset:i,ancestorOffset:n});"number"==typeof i&&(i={top:i,bottom:i,left:i,right:i});const r={target:this.domConverter.viewRangeToDom(s),viewportOffset:i,ancestorOffset:n,alignToTop:e,forceScroll:t};this.fire("scrollToTheSelection",r,o),ea(r);}focus(){if(!this.document.isFocused){const e=this.document.selection.editableElement;e&&(this.domConverter.focus(e),this.forceRender());}}change(e){if(this.isRenderingInProgress||this._postFixersInProgress)throw new E("cannot-change-view-tree",this);try{if(this._ongoingChange)return e(this._writer);this._ongoingChange=!0;const t=e(this._writer);return this._ongoingChange=!1,!this._renderingDisabled&&this._hasChangedSinceTheLastRendering&&(this._postFixersInProgress=!0,this.document._callPostFixers(this._writer),this._postFixersInProgress=!1,this.fire("render")),t}catch(e){E.rethrowUnexpectedError(e,this);}}forceRender(){this._hasChangedSinceTheLastRendering=!0,this.getObserver(Hc).flush(),this.change((()=>{}));}destroy(){for(const e of this._observers.values())e.destroy();this.document.destroy(),this.stopListening();}createPositionAt(e,t){return Pl._createAt(e,t)}createPositionAfter(e){return Pl._createAfter(e)}createPositionBefore(e){return Pl._createBefore(e)}createRange(e,t){return new Vl(e,t)}createRangeOn(e){return Vl._createOn(e)}createRangeIn(e){return Vl._createIn(e)}createSelection(...e){return new Bl(...e)}_disableRendering(e){this._renderingDisabled=e,0==e&&this.change((()=>{}));}_render(){this.isRenderingInProgress=!0,this.disableObservers(),this._renderer.render(),this.enableObservers(),this.isRenderingInProgress=!1;}};class Jc{is(){throw new Error("is() method is abstract")}}let Qc=class extends Jc{parent=null;_attrs;constructor(e){super(),this._attrs=Ra(e);}get document(){return null}get index(){let e;if(!this.parent)return null;if(null===(e=this.parent.getChildIndex(this)))throw new E("model-node-not-found-in-parent",this);return e}get startOffset(){let e;if(!this.parent)return null;if(null===(e=this.parent.getChildStartOffset(this)))throw new E("model-node-not-found-in-parent",this);return e}get offsetSize(){return 1}get endOffset(){return this.parent?this.startOffset+this.offsetSize:null}get nextSibling(){const e=this.index;return null!==e&&this.parent.getChild(e+1)||null}get previousSibling(){const e=this.index;return null!==e&&this.parent.getChild(e-1)||null}get root(){let e=this;for(;e.parent;)e=e.parent;return e}isAttached(){return null!==this.parent&&this.root.isAttached()}getPath(){const e=[];let t=this;for(;t.parent;)e.unshift(t.startOffset),t=t.parent;return e}getAncestors(e={}){const t=[];let i=e.includeSelf?this:this.parent;for(;i;)t[e.parentFirst?"push":"unshift"](i),i=i.parent;return t}getCommonAncestor(e,t={}){const i=this.getAncestors(t),n=e.getAncestors(t);let s=0;for(;i[s]==n[s]&&i[s];)s++;return 0===s?null:i[s-1]}isBefore(e){if(this==e)return !1;if(this.root!==e.root)return !1;const t=this.getPath(),i=e.getPath(),n=pr(t,i);switch(n){case"prefix":return !0;case"extension":return !1;default:return t[n]<i[n]}}isAfter(e){return this!=e&&(this.root===e.root&&!this.isBefore(e))}hasAttribute(e){return this._attrs.has(e)}getAttribute(e){return this._attrs.get(e)}getAttributes(){return this._attrs.entries()}getAttributeKeys(){return this._attrs.keys()}toJSON(){const e={};return this._attrs.size&&(e.attributes=Array.from(this._attrs).reduce(((e,t)=>(e[t[0]]=t[1],e)),{})),e}_clone(e){return new this.constructor(this._attrs)}_remove(){this.parent._removeChildren(this.index);}_setAttribute(e,t){this._attrs.set(e,t);}_setAttributesTo(e){this._attrs=Ra(e);}_removeAttribute(e){return this._attrs.delete(e)}_clearAttributes(){this._attrs.clear();}};Qc.prototype.is=function(e){return "node"===e||"model:node"===e};class Yc{_nodes=[];constructor(e){e&&this._insertNodes(0,e);}[Symbol.iterator](){return this._nodes[Symbol.iterator]()}get length(){return this._nodes.length}get maxOffset(){return this._nodes.reduce(((e,t)=>e+t.offsetSize),0)}getNode(e){return this._nodes[e]||null}getNodeIndex(e){const t=this._nodes.indexOf(e);return -1==t?null:t}getNodeStartOffset(e){const t=this.getNodeIndex(e);return null===t?null:this._nodes.slice(0,t).reduce(((e,t)=>e+t.offsetSize),0)}indexToOffset(e){if(e==this._nodes.length)return this.maxOffset;const t=this._nodes[e];if(!t)throw new E("model-nodelist-index-out-of-bounds",this);return this.getNodeStartOffset(t)}offsetToIndex(e){let t=0;for(const i of this._nodes){if(e>=t&&e<t+i.offsetSize)return this.getNodeIndex(i);t+=i.offsetSize;}if(t!=e)throw new E("model-nodelist-offset-out-of-bounds",this,{offset:e,nodeList:this});return this.length}_insertNodes(e,t){for(const e of t)if(!(e instanceof Qc))throw new E("model-nodelist-insertnodes-not-node",this);this._nodes=La(this._nodes,Array.from(t),e,0);}_removeNodes(e,t=1){return this._nodes.splice(e,t)}toJSON(){return this._nodes.map((e=>e.toJSON()))}}class Xc extends Qc{_data;constructor(e,t){super(t),this._data=e||"";}get offsetSize(){return this.data.length}get data(){return this._data}toJSON(){const e=super.toJSON();return e.data=this.data,e}_clone(){return new Xc(this.data,this.getAttributes())}static fromJSON(e){return new Xc(e.data,e.attributes)}}Xc.prototype.is=function(e){return "$text"===e||"model:$text"===e||"text"===e||"model:text"===e||"node"===e||"model:node"===e};class ed extends Jc{textNode;data;offsetInText;constructor(e,t,i){if(super(),this.textNode=e,t<0||t>e.offsetSize)throw new E("model-textproxy-wrong-offsetintext",this);if(i<0||t+i>e.offsetSize)throw new E("model-textproxy-wrong-length",this);this.data=e.data.substring(t,t+i),this.offsetInText=t;}get startOffset(){return null!==this.textNode.startOffset?this.textNode.startOffset+this.offsetInText:null}get offsetSize(){return this.data.length}get endOffset(){return null!==this.startOffset?this.startOffset+this.offsetSize:null}get isPartial(){return this.offsetSize!==this.textNode.offsetSize}get parent(){return this.textNode.parent}get root(){return this.textNode.root}getPath(){const e=this.textNode.getPath();return e.length>0&&(e[e.length-1]+=this.offsetInText),e}getAncestors(e={}){const t=[];let i=e.includeSelf?this:this.parent;for(;i;)t[e.parentFirst?"push":"unshift"](i),i=i.parent;return t}hasAttribute(e){return this.textNode.hasAttribute(e)}getAttribute(e){return this.textNode.getAttribute(e)}getAttributes(){return this.textNode.getAttributes()}getAttributeKeys(){return this.textNode.getAttributeKeys()}}ed.prototype.is=function(e){return "$textProxy"===e||"model:$textProxy"===e||"textProxy"===e||"model:textProxy"===e};class td extends Qc{name;_children=new Yc;constructor(e,t,i){super(t),this.name=e,i&&this._insertChild(0,i);}get childCount(){return this._children.length}get maxOffset(){return this._children.maxOffset}get isEmpty(){return 0===this.childCount}getChild(e){return this._children.getNode(e)}getChildren(){return this._children[Symbol.iterator]()}getChildIndex(e){return this._children.getNodeIndex(e)}getChildStartOffset(e){return this._children.getNodeStartOffset(e)}offsetToIndex(e){return this._children.offsetToIndex(e)}getNodeByPath(e){let t=this;for(const i of e)t=t.getChild(t.offsetToIndex(i));return t}findAncestor(e,t={}){let i=t.includeSelf?this:this.parent;for(;i;){if(i.name===e)return i;i=i.parent;}return null}toJSON(){const e=super.toJSON();if(e.name=this.name,this._children.length>0){e.children=[];for(const t of this._children)e.children.push(t.toJSON());}return e}_clone(e=!1){const t=e?Array.from(this._children).map((e=>e._clone(!0))):void 0;return new td(this.name,this.getAttributes(),t)}_appendChild(e){this._insertChild(this.childCount,e);}_insertChild(e,t){const i=function(e){if("string"==typeof e)return [new Xc(e)];br(e)||(e=[e]);return Array.from(e).map((e=>"string"==typeof e?new Xc(e):e instanceof ed?new Xc(e.data,e.getAttributes()):e))}(t);for(const e of i)null!==e.parent&&e._remove(),e.parent=this;this._children._insertNodes(e,i);}_removeChildren(e,t=1){const i=this._children._removeNodes(e,t);for(const e of i)e.parent=null;return i}static fromJSON(e){let t;if(e.children){t=[];for(const i of e.children)i.name?t.push(td.fromJSON(i)):t.push(Xc.fromJSON(i));}return new td(e.name,e.attributes,t)}}td.prototype.is=function(e,t){return t?t===this.name&&("element"===e||"model:element"===e):"element"===e||"model:element"===e||"node"===e||"model:node"===e};class id{direction;boundaries;singleCharacters;shallow;ignoreElementEnd;_position;_boundaryStartParent;_boundaryEndParent;_visitedParent;constructor(e){if(!e||!e.boundaries&&!e.startPosition)throw new E("model-tree-walker-no-start-position",null);const t=e.direction||"forward";if("forward"!=t&&"backward"!=t)throw new E("model-tree-walker-unknown-direction",e,{direction:t});this.direction=t,this.boundaries=e.boundaries||null,e.startPosition?this._position=e.startPosition.clone():this._position=sd._createAt(this.boundaries["backward"==this.direction?"end":"start"]),this.position.stickiness="toNone",this.singleCharacters=!!e.singleCharacters,this.shallow=!!e.shallow,this.ignoreElementEnd=!!e.ignoreElementEnd,this._boundaryStartParent=this.boundaries?this.boundaries.start.parent:null,this._boundaryEndParent=this.boundaries?this.boundaries.end.parent:null,this._visitedParent=this.position.parent;}[Symbol.iterator](){return this}get position(){return this._position}skip(e){let t,i,n,s;do{n=this.position,s=this._visitedParent,({done:t,value:i}=this.next());}while(!t&&e(i));t||(this._position=n,this._visitedParent=s);}next(){return "forward"==this.direction?this._next():this._previous()}_next(){const e=this.position,t=this.position.clone(),i=this._visitedParent;if(null===i.parent&&t.offset===i.maxOffset)return {done:!0,value:void 0};if(i===this._boundaryEndParent&&t.offset==this.boundaries.end.offset)return {done:!0,value:void 0};const n=od(t,i),s=n||rd(t,i,n);if(s instanceof td){if(this.shallow){if(this.boundaries&&this.boundaries.end.isBefore(t))return {done:!0,value:void 0};t.offset++;}else t.path.push(0),this._visitedParent=s;return this._position=t,nd("elementStart",s,e,t,1)}if(s instanceof Xc){let n;if(this.singleCharacters)n=1;else {let e=s.endOffset;this._boundaryEndParent==i&&this.boundaries.end.offset<e&&(e=this.boundaries.end.offset),n=e-t.offset;}const o=t.offset-s.startOffset,r=new ed(s,o,n);return t.offset+=n,this._position=t,nd("text",r,e,t,n)}return t.path.pop(),t.offset++,this._position=t,this._visitedParent=i.parent,this.ignoreElementEnd?this._next():nd("elementEnd",i,e,t)}_previous(){const e=this.position,t=this.position.clone(),i=this._visitedParent;if(null===i.parent&&0===t.offset)return {done:!0,value:void 0};if(i==this._boundaryStartParent&&t.offset==this.boundaries.start.offset)return {done:!0,value:void 0};const n=t.parent,s=od(t,n),o=s||ad(t,n,s);if(o instanceof td)return t.offset--,this.shallow?(this._position=t,nd("elementStart",o,e,t,1)):(t.path.push(o.maxOffset),this._position=t,this._visitedParent=o,this.ignoreElementEnd?this._previous():nd("elementEnd",o,e,t));if(o instanceof Xc){let n;if(this.singleCharacters)n=1;else {let e=o.startOffset;this._boundaryStartParent==i&&this.boundaries.start.offset>e&&(e=this.boundaries.start.offset),n=t.offset-e;}const s=t.offset-o.startOffset,r=new ed(o,s-n,n);return t.offset-=n,this._position=t,nd("text",r,e,t,n)}return t.path.pop(),this._position=t,this._visitedParent=i.parent,nd("elementStart",i,e,t,1)}}function nd(e,t,i,n,s){return {done:!1,value:{type:e,item:t,previousPosition:i,nextPosition:n,length:s}}}class sd extends Jc{root;path;stickiness;constructor(e,t,i="toNone"){if(super(),!e.is("element")&&!e.is("documentFragment"))throw new E("model-position-root-invalid",e);if(!(t instanceof Array)||0===t.length)throw new E("model-position-path-incorrect-format",e,{path:t});e.is("rootElement")?t=t.slice():(t=[...e.getPath(),...t],e=e.root),this.root=e,this.path=t,this.stickiness=i;}get offset(){return this.path[this.path.length-1]}set offset(e){this.path[this.path.length-1]=e;}get parent(){let e=this.root;for(let t=0;t<this.path.length-1;t++)if(e=e.getChild(e.offsetToIndex(this.path[t])),!e)throw new E("model-position-path-incorrect",this,{position:this});if(e.is("$text"))throw new E("model-position-path-incorrect",this,{position:this});return e}get index(){return this.parent.offsetToIndex(this.offset)}get textNode(){return od(this,this.parent)}get nodeAfter(){const e=this.parent;return rd(this,e,od(this,e))}get nodeBefore(){const e=this.parent;return ad(this,e,od(this,e))}get isAtStart(){return 0===this.offset}get isAtEnd(){return this.offset==this.parent.maxOffset}compareWith(e){if(this.root!=e.root)return "different";const t=pr(this.path,e.path);switch(t){case"same":return "same";case"prefix":return "before";case"extension":return "after";default:return this.path[t]<e.path[t]?"before":"after"}}getLastMatchingPosition(e,t={}){t.startPosition=this;const i=new id(t);return i.skip(e),i.position}getParentPath(){return this.path.slice(0,-1)}getAncestors(){const e=this.parent;return e.is("documentFragment")?[e]:e.getAncestors({includeSelf:!0})}findAncestor(e){const t=this.parent;return t.is("element")?t.findAncestor(e,{includeSelf:!0}):null}getCommonPath(e){if(this.root!=e.root)return [];const t=pr(this.path,e.path),i="string"==typeof t?Math.min(this.path.length,e.path.length):t;return this.path.slice(0,i)}getCommonAncestor(e){const t=this.getAncestors(),i=e.getAncestors();let n=0;for(;t[n]==i[n]&&t[n];)n++;return 0===n?null:t[n-1]}getShiftedBy(e){const t=this.clone(),i=t.offset+e;return t.offset=i<0?0:i,t}isAfter(e){return "after"==this.compareWith(e)}isBefore(e){return "before"==this.compareWith(e)}isEqual(e){return "same"==this.compareWith(e)}isTouching(e){if(this.root!==e.root)return !1;const t=Math.min(this.path.length,e.path.length);for(let i=0;i<t;i++){const t=this.path[i]-e.path[i];if(t<-1||t>1)return !1;if(1===t)return ld(e,this,i);if(-1===t)return ld(this,e,i)}return this.path.length===e.path.length||(this.path.length>e.path.length?cd(this.path,t):cd(e.path,t))}hasSameParentAs(e){if(this.root!==e.root)return !1;return "same"==pr(this.getParentPath(),e.getParentPath())}getTransformedByOperation(e){let t;switch(e.type){case"insert":t=this._getTransformedByInsertOperation(e);break;case"move":case"remove":case"reinsert":t=this._getTransformedByMoveOperation(e);break;case"split":t=this._getTransformedBySplitOperation(e);break;case"merge":t=this._getTransformedByMergeOperation(e);break;default:t=sd._createAt(this);}return t}_getTransformedByInsertOperation(e){return this._getTransformedByInsertion(e.position,e.howMany)}_getTransformedByMoveOperation(e){return this._getTransformedByMove(e.sourcePosition,e.targetPosition,e.howMany)}_getTransformedBySplitOperation(e){const t=e.movedRange;return t.containsPosition(this)||t.start.isEqual(this)&&"toNext"==this.stickiness?this._getCombined(e.splitPosition,e.moveTargetPosition):e.graveyardPosition?this._getTransformedByMove(e.graveyardPosition,e.insertionPosition,1):this._getTransformedByInsertion(e.insertionPosition,1)}_getTransformedByMergeOperation(e){const t=e.movedRange;let i;return t.containsPosition(this)||t.start.isEqual(this)?(i=this._getCombined(e.sourcePosition,e.targetPosition),e.sourcePosition.isBefore(e.targetPosition)&&(i=i._getTransformedByDeletion(e.deletionPosition,1))):i=this.isEqual(e.deletionPosition)?sd._createAt(e.deletionPosition):this._getTransformedByMove(e.deletionPosition,e.graveyardPosition,1),i}_getTransformedByDeletion(e,t){const i=sd._createAt(this);if(this.root!=e.root)return i;if("same"==pr(e.getParentPath(),this.getParentPath())){if(e.offset<this.offset){if(e.offset+t>this.offset)return null;i.offset-=t;}}else if("prefix"==pr(e.getParentPath(),this.getParentPath())){const n=e.path.length-1;if(e.offset<=this.path[n]){if(e.offset+t>this.path[n])return null;i.path[n]-=t;}}return i}_getTransformedByInsertion(e,t){const i=sd._createAt(this);if(this.root!=e.root)return i;if("same"==pr(e.getParentPath(),this.getParentPath()))(e.offset<this.offset||e.offset==this.offset&&"toPrevious"!=this.stickiness)&&(i.offset+=t);else if("prefix"==pr(e.getParentPath(),this.getParentPath())){const n=e.path.length-1;e.offset<=this.path[n]&&(i.path[n]+=t);}return i}_getTransformedByMove(e,t,i){if(t=t._getTransformedByDeletion(e,i),e.isEqual(t))return sd._createAt(this);const n=this._getTransformedByDeletion(e,i);return null===n||e.isEqual(this)&&"toNext"==this.stickiness||e.getShiftedBy(i).isEqual(this)&&"toPrevious"==this.stickiness?this._getCombined(e,t):n._getTransformedByInsertion(t,i)}_getCombined(e,t){const i=e.path.length-1,n=sd._createAt(t);return n.stickiness=this.stickiness,n.offset=n.offset+this.path[i]-e.offset,n.path=[...n.path,...this.path.slice(i+1)],n}toJSON(){return {root:this.root.toJSON(),path:Array.from(this.path),stickiness:this.stickiness}}clone(){return new this.constructor(this.root,this.path,this.stickiness)}static _createAt(e,t,i="toNone"){if(e instanceof sd)return new sd(e.root,e.path,e.stickiness);{const n=e;if("end"==t)t=n.maxOffset;else {if("before"==t)return this._createBefore(n,i);if("after"==t)return this._createAfter(n,i);if(0!==t&&!t)throw new E("model-createpositionat-offset-required",[this,e])}if(!n.is("element")&&!n.is("documentFragment"))throw new E("model-position-parent-incorrect",[this,e]);const s=n.getPath();return s.push(t),new this(n.root,s,i)}}static _createAfter(e,t){if(!e.parent)throw new E("model-position-after-root",[this,e],{root:e});return this._createAt(e.parent,e.endOffset,t)}static _createBefore(e,t){if(!e.parent)throw new E("model-position-before-root",e,{root:e});return this._createAt(e.parent,e.startOffset,t)}static fromJSON(e,t){if("$graveyard"===e.root){const i=new sd(t.graveyard,e.path);return i.stickiness=e.stickiness,i}if(!t.getRoot(e.root))throw new E("model-position-fromjson-no-root",t,{rootName:e.root});return new sd(t.getRoot(e.root),e.path,e.stickiness)}}function od(e,t){const i=t.getChild(t.offsetToIndex(e.offset));return i&&i.is("$text")&&i.startOffset<e.offset?i:null}function rd(e,t,i){return null!==i?null:t.getChild(t.offsetToIndex(e.offset))}function ad(e,t,i){return null!==i?null:t.getChild(t.offsetToIndex(e.offset)-1)}function ld(e,t,i){return i+1!==e.path.length&&(!!cd(t.path,i+1)&&!!function(e,t){let i=e.parent,n=e.path.length-1,s=0;for(;n>=t;){if(e.path[n]+s!==i.maxOffset)return !1;s=1,n--,i=i.parent;}return !0}(e,i+1))}function cd(e,t){for(;t<e.length;){if(0!==e[t])return !1;t++;}return !0}sd.prototype.is=function(e){return "position"===e||"model:position"===e};class dd extends Jc{start;end;constructor(e,t){super(),this.start=sd._createAt(e),this.end=t?sd._createAt(t):sd._createAt(e),this.start.stickiness=this.isCollapsed?"toNone":"toNext",this.end.stickiness=this.isCollapsed?"toNone":"toPrevious";}*[Symbol.iterator](){yield*new id({boundaries:this,ignoreElementEnd:!0});}get isCollapsed(){return this.start.isEqual(this.end)}get isFlat(){return "same"==pr(this.start.getParentPath(),this.end.getParentPath())}get root(){return this.start.root}containsPosition(e){return e.isAfter(this.start)&&e.isBefore(this.end)}containsRange(e,t=!1){e.isCollapsed&&(t=!1);const i=this.containsPosition(e.start)||t&&this.start.isEqual(e.start),n=this.containsPosition(e.end)||t&&this.end.isEqual(e.end);return i&&n}containsItem(e){const t=sd._createBefore(e);return this.containsPosition(t)||this.start.isEqual(t)}isEqual(e){return this.start.isEqual(e.start)&&this.end.isEqual(e.end)}isIntersecting(e){return this.start.isBefore(e.end)&&this.end.isAfter(e.start)}getDifference(e){const t=[];return this.isIntersecting(e)?(this.containsPosition(e.start)&&t.push(new dd(this.start,e.start)),this.containsPosition(e.end)&&t.push(new dd(e.end,this.end))):t.push(new dd(this.start,this.end)),t}getIntersection(e){if(this.isIntersecting(e)){let t=this.start,i=this.end;return this.containsPosition(e.start)&&(t=e.start),this.containsPosition(e.end)&&(i=e.end),new dd(t,i)}return null}getJoined(e,t=!1){let i=this.isIntersecting(e);if(i||(i=this.start.isBefore(e.start)?t?this.end.isTouching(e.start):this.end.isEqual(e.start):t?e.end.isTouching(this.start):e.end.isEqual(this.start)),!i)return null;let n=this.start,s=this.end;return e.start.isBefore(n)&&(n=e.start),e.end.isAfter(s)&&(s=e.end),new dd(n,s)}getMinimalFlatRanges(){const e=[],t=this.start.getCommonPath(this.end).length,i=sd._createAt(this.start);let n=i.parent;for(;i.path.length>t+1;){const t=n.maxOffset-i.offset;0!==t&&e.push(new dd(i,i.getShiftedBy(t))),i.path=i.path.slice(0,-1),i.offset++,n=n.parent;}for(;i.path.length<=this.end.path.length;){const t=this.end.path[i.path.length-1],n=t-i.offset;0!==n&&e.push(new dd(i,i.getShiftedBy(n))),i.offset=t,i.path.push(0);}return e}getWalker(e={}){return e.boundaries=this,new id(e)}*getItems(e={}){e.boundaries=this,e.ignoreElementEnd=!0;const t=new id(e);for(const e of t)yield e.item;}*getPositions(e={}){e.boundaries=this;const t=new id(e);yield t.position;for(const e of t)yield e.nextPosition;}getTransformedByOperation(e){switch(e.type){case"insert":return this._getTransformedByInsertOperation(e);case"move":case"remove":case"reinsert":return this._getTransformedByMoveOperation(e);case"split":return [this._getTransformedBySplitOperation(e)];case"merge":return [this._getTransformedByMergeOperation(e)]}return [new dd(this.start,this.end)]}getTransformedByOperations(e){const t=[new dd(this.start,this.end)];for(const i of e)for(let e=0;e<t.length;e++){const n=t[e].getTransformedByOperation(i);t.splice(e,1,...n),e+=n.length-1;}for(let e=0;e<t.length;e++){const i=t[e];for(let n=e+1;n<t.length;n++){const e=t[n];(i.containsRange(e)||e.containsRange(i)||i.isEqual(e))&&t.splice(n,1);}}return t}getCommonAncestor(){return this.start.getCommonAncestor(this.end)}getContainedElement(){if(this.isCollapsed)return null;const e=this.start.nodeAfter,t=this.end.nodeBefore;return e&&e.is("element")&&e===t?e:null}toJSON(){return {start:this.start.toJSON(),end:this.end.toJSON()}}clone(){return new this.constructor(this.start,this.end)}_getTransformedByInsertOperation(e,t=!1){return this._getTransformedByInsertion(e.position,e.howMany,t)}_getTransformedByMoveOperation(e,t=!1){const i=e.sourcePosition,n=e.howMany,s=e.targetPosition;return this._getTransformedByMove(i,s,n,t)}_getTransformedBySplitOperation(e){const t=this.start._getTransformedBySplitOperation(e);let i=this.end._getTransformedBySplitOperation(e);return this.end.isEqual(e.insertionPosition)&&(i=this.end.getShiftedBy(1)),t.root!=i.root&&(i=this.end.getShiftedBy(-1)),new dd(t,i)}_getTransformedByMergeOperation(e){if(this.start.isEqual(e.targetPosition)&&this.end.isEqual(e.deletionPosition))return new dd(this.start);let t=this.start._getTransformedByMergeOperation(e),i=this.end._getTransformedByMergeOperation(e);return t.root!=i.root&&(i=this.end.getShiftedBy(-1)),t.isAfter(i)?(e.sourcePosition.isBefore(e.targetPosition)?(t=sd._createAt(i),t.offset=0):(e.deletionPosition.isEqual(t)||(i=e.deletionPosition),t=e.targetPosition),new dd(t,i)):new dd(t,i)}_getTransformedByInsertion(e,t,i=!1){if(i&&this.containsPosition(e))return [new dd(this.start,e),new dd(e.getShiftedBy(t),this.end._getTransformedByInsertion(e,t))];{const i=new dd(this.start,this.end);return i.start=i.start._getTransformedByInsertion(e,t),i.end=i.end._getTransformedByInsertion(e,t),[i]}}_getTransformedByMove(e,t,i,n=!1){if(this.isCollapsed){const n=this.start._getTransformedByMove(e,t,i);return [new dd(n)]}const s=dd._createFromPositionAndShift(e,i),o=t._getTransformedByDeletion(e,i);if(this.containsPosition(t)&&!n&&(s.containsPosition(this.start)||s.containsPosition(this.end))){const n=this.start._getTransformedByMove(e,t,i),s=this.end._getTransformedByMove(e,t,i);return [new dd(n,s)]}let r;const a=this.getDifference(s);let l=null;const c=this.getIntersection(s);if(1==a.length?l=new dd(a[0].start._getTransformedByDeletion(e,i),a[0].end._getTransformedByDeletion(e,i)):2==a.length&&(l=new dd(this.start,this.end._getTransformedByDeletion(e,i))),r=l?l._getTransformedByInsertion(o,i,null!==c||n):[],c){const e=new dd(c.start._getCombined(s.start,o),c.end._getCombined(s.start,o));2==r.length?r.splice(1,0,e):r.push(e);}return r}_getTransformedByDeletion(e,t){let i=this.start._getTransformedByDeletion(e,t),n=this.end._getTransformedByDeletion(e,t);return null==i&&null==n?null:(null==i&&(i=e),null==n&&(n=e),new dd(i,n))}static _createFromPositionAndShift(e,t){const i=e,n=e.getShiftedBy(t);return t>0?new this(i,n):new this(n,i)}static _createIn(e){return new this(sd._createAt(e,0),sd._createAt(e,e.maxOffset))}static _createOn(e){return this._createFromPositionAndShift(sd._createBefore(e),e.offsetSize)}static _createFromRanges(e){if(0===e.length)throw new E("range-create-from-ranges-empty-array",null);if(1==e.length)return e[0].clone();const t=e[0];e.sort(((e,t)=>e.start.isAfter(t.start)?1:-1));const i=e.indexOf(t),n=new this(t.start,t.end);if(i>0)for(let t=i-1;e[t].end.isEqual(n.start);t++)n.start=sd._createAt(e[t].start);for(let t=i+1;t<e.length&&e[t].start.isEqual(n.end);t++)n.end=sd._createAt(e[t].end);return n}static fromJSON(e,t){return new this(sd.fromJSON(e.start,t),sd.fromJSON(e.end,t))}}dd.prototype.is=function(e){return "range"===e||"model:range"===e};class hd extends(F()){_modelToViewMapping=new WeakMap;_viewToModelMapping=new WeakMap;_viewToModelLengthCallbacks=new Map;_markerNameToElements=new Map;_elementToMarkerNames=new Map;_deferredBindingRemovals=new Map;_unboundMarkerNames=new Set;constructor(){super(),this.on("modelToViewPosition",((e,t)=>{if(t.viewPosition)return;const i=this._modelToViewMapping.get(t.modelPosition.parent);if(!i)throw new E("mapping-model-position-view-parent-not-found",this,{modelPosition:t.modelPosition});t.viewPosition=this.findPositionIn(i,t.modelPosition.offset);}),{priority:"low"}),this.on("viewToModelPosition",((e,t)=>{if(t.modelPosition)return;const i=this.findMappedViewAncestor(t.viewPosition),n=this._viewToModelMapping.get(i),s=this._toModelOffset(t.viewPosition.parent,t.viewPosition.offset,i);t.modelPosition=sd._createAt(n,s);}),{priority:"low"});}bindElements(e,t){this._modelToViewMapping.set(e,t),this._viewToModelMapping.set(t,e);}unbindViewElement(e,t={}){const i=this.toModelElement(e);if(this._elementToMarkerNames.has(e))for(const t of this._elementToMarkerNames.get(e))this._unboundMarkerNames.add(t);t.defer?this._deferredBindingRemovals.set(e,e.root):(this._viewToModelMapping.delete(e),this._modelToViewMapping.get(i)==e&&this._modelToViewMapping.delete(i));}unbindModelElement(e){const t=this.toViewElement(e);this._modelToViewMapping.delete(e),this._viewToModelMapping.get(t)==e&&this._viewToModelMapping.delete(t);}bindElementToMarker(e,t){const i=this._markerNameToElements.get(t)||new Set;i.add(e);const n=this._elementToMarkerNames.get(e)||new Set;n.add(t),this._markerNameToElements.set(t,i),this._elementToMarkerNames.set(e,n);}unbindElementFromMarkerName(e,t){const i=this._markerNameToElements.get(t);i&&(i.delete(e),0==i.size&&this._markerNameToElements.delete(t));const n=this._elementToMarkerNames.get(e);n&&(n.delete(t),0==n.size&&this._elementToMarkerNames.delete(e));}flushUnboundMarkerNames(){const e=Array.from(this._unboundMarkerNames);return this._unboundMarkerNames.clear(),e}flushDeferredBindings(){for(const[e,t]of this._deferredBindingRemovals)e.root==t&&this.unbindViewElement(e);this._deferredBindingRemovals=new Map;}clearBindings(){this._modelToViewMapping=new WeakMap,this._viewToModelMapping=new WeakMap,this._markerNameToElements=new Map,this._elementToMarkerNames=new Map,this._unboundMarkerNames=new Set,this._deferredBindingRemovals=new Map;}toModelElement(e){return this._viewToModelMapping.get(e)}toViewElement(e){return this._modelToViewMapping.get(e)}toModelRange(e){return new dd(this.toModelPosition(e.start),this.toModelPosition(e.end))}toViewRange(e){return new Vl(this.toViewPosition(e.start),this.toViewPosition(e.end))}toModelPosition(e){const t={viewPosition:e,mapper:this};return this.fire("viewToModelPosition",t),t.modelPosition}toViewPosition(e,t={}){const i={modelPosition:e,mapper:this,isPhantom:t.isPhantom};return this.fire("modelToViewPosition",i),i.viewPosition}markerNameToElements(e){const t=this._markerNameToElements.get(e);if(!t)return null;const i=new Set;for(const e of t)if(e.is("attributeElement"))for(const t of e.getElementsWithSameId())i.add(t);else i.add(e);return i}registerViewToModelLength(e,t){this._viewToModelLengthCallbacks.set(e,t);}findMappedViewAncestor(e){let t=e.parent;for(;!this._viewToModelMapping.has(t);)t=t.parent;return t}_toModelOffset(e,t,i){if(i!=e){return this._toModelOffset(e.parent,e.index,i)+this._toModelOffset(e,t,e)}if(e.is("$text"))return t;let n=0;for(let i=0;i<t;i++)n+=this.getModelLength(e.getChild(i));return n}getModelLength(e){if(this._viewToModelLengthCallbacks.get(e.name)){return this._viewToModelLengthCallbacks.get(e.name)(e)}if(this._viewToModelMapping.has(e))return 1;if(e.is("$text"))return e.data.length;if(e.is("uiElement"))return 0;{let t=0;for(const i of e.getChildren())t+=this.getModelLength(i);return t}}findPositionIn(e,t){let i,n=0,s=0,o=0;if(e.is("$text"))return new Pl(e,t);for(;s<t;)i=e.getChild(o),n=this.getModelLength(i),s+=n,o++;return s==t?this._moveViewPositionToTextNode(new Pl(e,o)):this.findPositionIn(i,t-(s-n))}_moveViewPositionToTextNode(e){const t=e.nodeBefore,i=e.nodeAfter;return t instanceof ml?new Pl(t,t.data.length):i instanceof ml?new Pl(i,0):e}}class ud{_consumable=new Map;_textProxyRegistry=new Map;add(e,t){t=md(t),e instanceof ed&&(e=this._getSymbolForTextProxy(e)),this._consumable.has(e)||this._consumable.set(e,new Map),this._consumable.get(e).set(t,!0);}consume(e,t){return t=md(t),e instanceof ed&&(e=this._getSymbolForTextProxy(e)),!!this.test(e,t)&&(this._consumable.get(e).set(t,!1),!0)}test(e,t){t=md(t),e instanceof ed&&(e=this._getSymbolForTextProxy(e));const i=this._consumable.get(e);if(void 0===i)return null;const n=i.get(t);return void 0===n?null:n}revert(e,t){t=md(t),e instanceof ed&&(e=this._getSymbolForTextProxy(e));const i=this.test(e,t);return !1===i?(this._consumable.get(e).set(t,!0),!0):!0!==i&&null}verifyAllConsumed(e){const t=[];for(const[i,n]of this._consumable)for(const[s,o]of n){const n=s.split(":")[0];o&&e==n&&t.push({event:s,item:i.name||i.description});}if(t.length)throw new E("conversion-model-consumable-not-consumed",null,{items:t})}_getSymbolForTextProxy(e){let t=null;const i=this._textProxyRegistry.get(e.startOffset);if(i){const n=i.get(e.endOffset);n&&(t=n.get(e.parent));}return t||(t=this._addSymbolForTextProxy(e)),t}_addSymbolForTextProxy(e){const t=e.startOffset,i=e.endOffset,n=e.parent,s=Symbol("$textProxy:"+e.data);let o,r;return o=this._textProxyRegistry.get(t),o||(o=new Map,this._textProxyRegistry.set(t,o)),r=o.get(i),r||(r=new Map,o.set(i,r)),r.set(n,s),s}}function md(e){const t=e.split(":");return "insert"==t[0]?t[0]:"addMarker"==t[0]||"removeMarker"==t[0]?e:t.length>1?t[0]+":"+t[1]:t[0]}class gd extends(F()){_conversionApi;_firedEventsMap;constructor(e){super(),this._conversionApi={dispatcher:this,...e},this._firedEventsMap=new WeakMap;}convertChanges(e,t,i){const n=this._createConversionApi(i,e.getRefreshedItems());for(const t of e.getMarkersToRemove())this._convertMarkerRemove(t.name,t.range,n);const s=this._reduceChanges(e.getChanges());for(const e of s)"insert"===e.type?this._convertInsert(dd._createFromPositionAndShift(e.position,e.length),n):"reinsert"===e.type?this._convertReinsert(dd._createFromPositionAndShift(e.position,e.length),n):"remove"===e.type?this._convertRemove(e.position,e.length,e.name,n):this._convertAttribute(e.range,e.attributeKey,e.attributeOldValue,e.attributeNewValue,n);n.mapper.flushDeferredBindings();for(const e of n.mapper.flushUnboundMarkerNames()){const i=t.get(e).getRange();this._convertMarkerRemove(e,i,n),this._convertMarkerAdd(e,i,n);}for(const t of e.getMarkersToAdd())this._convertMarkerAdd(t.name,t.range,n);n.consumable.verifyAllConsumed("insert");}convert(e,t,i,n={}){const s=this._createConversionApi(i,void 0,n);this._convertInsert(e,s);for(const[e,i]of t)this._convertMarkerAdd(e,i,s);s.consumable.verifyAllConsumed("insert");}convertSelection(e,t,i){const n=this._createConversionApi(i);this.fire("cleanSelection",{selection:e},n);const s=e.getFirstPosition().root;if(!n.mapper.toViewElement(s))return;const o=Array.from(t.getMarkersAtPosition(e.getFirstPosition()));if(this._addConsumablesForSelection(n.consumable,e,o),this.fire("selection",{selection:e},n),e.isCollapsed){for(const t of o)if(n.consumable.test(e,"addMarker:"+t.name)){const i=t.getRange();if(!fd(e.getFirstPosition(),t,n.mapper))continue;const s={item:e,markerName:t.name,markerRange:i};this.fire(`addMarker:${t.name}`,s,n);}for(const t of e.getAttributeKeys())if(n.consumable.test(e,"attribute:"+t)){const i={item:e,range:e.getFirstRange(),attributeKey:t,attributeOldValue:null,attributeNewValue:e.getAttribute(t)};this.fire(`attribute:${t}:$text`,i,n);}}}_convertInsert(e,t,i={}){i.doNotAddConsumables||this._addConsumablesForInsert(t.consumable,e);for(const i of Array.from(e.getWalker({shallow:!0})).map(pd))this._testAndFire("insert",i,t);}_convertRemove(e,t,i,n){this.fire(`remove:${i}`,{position:e,length:t},n);}_convertAttribute(e,t,i,n,s){this._addConsumablesForRange(s.consumable,e,`attribute:${t}`);for(const o of e){const e={item:o.item,range:dd._createFromPositionAndShift(o.previousPosition,o.length),attributeKey:t,attributeOldValue:i,attributeNewValue:n};this._testAndFire(`attribute:${t}`,e,s);}}_convertReinsert(e,t){const i=Array.from(e.getWalker({shallow:!0}));this._addConsumablesForInsert(t.consumable,i);for(const e of i.map(pd))this._testAndFire("insert",{...e,reconversion:!0},t);}_convertMarkerAdd(e,t,i){if("$graveyard"==t.root.rootName)return;const n=`addMarker:${e}`;if(i.consumable.add(t,n),this.fire(n,{markerName:e,markerRange:t},i),i.consumable.consume(t,n)){this._addConsumablesForRange(i.consumable,t,n);for(const s of t.getItems()){if(!i.consumable.test(s,n))continue;const o={item:s,range:dd._createOn(s),markerName:e,markerRange:t};this.fire(n,o,i);}}}_convertMarkerRemove(e,t,i){"$graveyard"!=t.root.rootName&&this.fire(`removeMarker:${e}`,{markerName:e,markerRange:t},i);}_reduceChanges(e){const t={changes:e};return this.fire("reduceChanges",t),t.changes}_addConsumablesForInsert(e,t){for(const i of t){const t=i.item;if(null===e.test(t,"insert")){e.add(t,"insert");for(const i of t.getAttributeKeys())e.add(t,"attribute:"+i);}}return e}_addConsumablesForRange(e,t,i){for(const n of t.getItems())e.add(n,i);return e}_addConsumablesForSelection(e,t,i){e.add(t,"selection");for(const n of i)e.add(t,"addMarker:"+n.name);for(const i of t.getAttributeKeys())e.add(t,"attribute:"+i);return e}_testAndFire(e,t,i){const n=function(e,t){const i=t.item.is("element")?t.item.name:"$text";return `${e}:${i}`}(e,t),s=t.item.is("$textProxy")?i.consumable._getSymbolForTextProxy(t.item):t.item,o=this._firedEventsMap.get(i),r=o.get(s);if(r){if(r.has(n))return;r.add(n);}else o.set(s,new Set([n]));this.fire(n,t,i);}_testAndFireAddAttributes(e,t){const i={item:e,range:dd._createOn(e)};for(const e of i.item.getAttributeKeys())i.attributeKey=e,i.attributeOldValue=null,i.attributeNewValue=i.item.getAttribute(e),this._testAndFire(`attribute:${e}`,i,t);}_createConversionApi(e,t=new Set,i={}){const n={...this._conversionApi,consumable:new ud,writer:e,options:i,convertItem:e=>this._convertInsert(dd._createOn(e),n),convertChildren:e=>this._convertInsert(dd._createIn(e),n,{doNotAddConsumables:!0}),convertAttributes:e=>this._testAndFireAddAttributes(e,n),canReuseView:e=>!t.has(n.mapper.toModelElement(e))};return this._firedEventsMap.set(n,new Map),n}}function fd(e,t,i){const n=t.getRange(),s=Array.from(e.getAncestors());s.shift(),s.reverse();return !s.some((e=>{if(n.containsItem(e)){return !!i.toViewElement(e).getCustomProperty("addHighlight")}}))}function pd(e){return {item:e.item,range:dd._createFromPositionAndShift(e.previousPosition,e.length)}}class bd extends(F(Jc)){_lastRangeBackward=!1;_attrs=new Map;_ranges=[];constructor(...e){super(),e.length&&this.setTo(...e);}get anchor(){if(this._ranges.length>0){const e=this._ranges[this._ranges.length-1];return this._lastRangeBackward?e.end:e.start}return null}get focus(){if(this._ranges.length>0){const e=this._ranges[this._ranges.length-1];return this._lastRangeBackward?e.start:e.end}return null}get isCollapsed(){return 1===this._ranges.length&&this._ranges[0].isCollapsed}get rangeCount(){return this._ranges.length}get isBackward(){return !this.isCollapsed&&this._lastRangeBackward}isEqual(e){if(this.rangeCount!=e.rangeCount)return !1;if(0===this.rangeCount)return !0;if(!this.anchor.isEqual(e.anchor)||!this.focus.isEqual(e.focus))return !1;for(const t of this._ranges){let i=!1;for(const n of e._ranges)if(t.isEqual(n)){i=!0;break}if(!i)return !1}return !0}*getRanges(){for(const e of this._ranges)yield new dd(e.start,e.end);}getFirstRange(){let e=null;for(const t of this._ranges)e&&!t.start.isBefore(e.start)||(e=t);return e?new dd(e.start,e.end):null}getLastRange(){let e=null;for(const t of this._ranges)e&&!t.end.isAfter(e.end)||(e=t);return e?new dd(e.start,e.end):null}getFirstPosition(){const e=this.getFirstRange();return e?e.start.clone():null}getLastPosition(){const e=this.getLastRange();return e?e.end.clone():null}setTo(...e){let[t,i,n]=e;if("object"==typeof i&&(n=i,i=void 0),null===t)this._setRanges([]);else if(t instanceof bd)this._setRanges(t.getRanges(),t.isBackward);else if(t&&"function"==typeof t.getRanges)this._setRanges(t.getRanges(),t.isBackward);else if(t instanceof dd)this._setRanges([t],!!n&&!!n.backward);else if(t instanceof sd)this._setRanges([new dd(t)]);else if(t instanceof Qc){const e=!!n&&!!n.backward;let s;if("in"==i)s=dd._createIn(t);else if("on"==i)s=dd._createOn(t);else {if(void 0===i)throw new E("model-selection-setto-required-second-parameter",[this,t]);s=new dd(sd._createAt(t,i));}this._setRanges([s],e);}else {if(!br(t))throw new E("model-selection-setto-not-selectable",[this,t]);this._setRanges(t,n&&!!n.backward);}}_setRanges(e,t=!1){const i=Array.from(e),n=i.some((t=>{if(!(t instanceof dd))throw new E("model-selection-set-ranges-not-range",[this,e]);return this._ranges.every((e=>!e.isEqual(t)))}));(i.length!==this._ranges.length||n)&&(this._replaceAllRanges(i),this._lastRangeBackward=!!t,this.fire("change:range",{directChange:!0}));}setFocus(e,t){if(null===this.anchor)throw new E("model-selection-setfocus-no-ranges",[this,e]);const i=sd._createAt(e,t);if("same"==i.compareWith(this.focus))return;const n=this.anchor;this._ranges.length&&this._popRange(),"before"==i.compareWith(n)?(this._pushRange(new dd(i,n)),this._lastRangeBackward=!0):(this._pushRange(new dd(n,i)),this._lastRangeBackward=!1),this.fire("change:range",{directChange:!0});}getAttribute(e){return this._attrs.get(e)}getAttributes(){return this._attrs.entries()}getAttributeKeys(){return this._attrs.keys()}hasAttribute(e){return this._attrs.has(e)}removeAttribute(e){this.hasAttribute(e)&&(this._attrs.delete(e),this.fire("change:attribute",{attributeKeys:[e],directChange:!0}));}setAttribute(e,t){this.getAttribute(e)!==t&&(this._attrs.set(e,t),this.fire("change:attribute",{attributeKeys:[e],directChange:!0}));}getSelectedElement(){return 1!==this.rangeCount?null:this.getFirstRange().getContainedElement()}*getSelectedBlocks(){const e=new WeakSet;for(const t of this.getRanges()){const i=vd(t.start,e);kd(i,t)&&(yield i);for(const i of t.getWalker()){const n=i.item;"elementEnd"==i.type&&_d(n,e,t)&&(yield n);}const n=vd(t.end,e);Cd(n,t)&&(yield n);}}containsEntireContent(e=this.anchor.root){const t=sd._createAt(e,0),i=sd._createAt(e,"end");return t.isTouching(this.getFirstPosition())&&i.isTouching(this.getLastPosition())}_pushRange(e){this._checkRange(e),this._ranges.push(new dd(e.start,e.end));}_checkRange(e){for(let t=0;t<this._ranges.length;t++)if(e.isIntersecting(this._ranges[t]))throw new E("model-selection-range-intersects",[this,e],{addedRange:e,intersectingRange:this._ranges[t]})}_replaceAllRanges(e){this._removeAllRanges();for(const t of e)this._pushRange(t);}_removeAllRanges(){for(;this._ranges.length>0;)this._popRange();}_popRange(){this._ranges.pop();}}function wd(e,t){return !t.has(e)&&(t.add(e),e.root.document.model.schema.isBlock(e)&&!!e.parent)}function _d(e,t,i){return wd(e,t)&&yd(e,i)}function vd(e,t){const i=e.parent.root.document.model.schema,n=e.parent.getAncestors({parentFirst:!0,includeSelf:!0});let s=!1;const o=n.find((e=>!s&&(s=i.isLimit(e),!s&&wd(e,t))));return n.forEach((e=>t.add(e))),o}function yd(e,t){const i=function(e){const t=e.root.document.model.schema;let i=e.parent;for(;i;){if(t.isBlock(i))return i;i=i.parent;}}(e);if(!i)return !0;return !t.containsRange(dd._createOn(i),!0)}function kd(e,t){return !!e&&(!(!t.isCollapsed&&!e.isEmpty)||!t.start.isTouching(sd._createAt(e,e.maxOffset))&&yd(e,t))}function Cd(e,t){return !!e&&(!(!t.isCollapsed&&!e.isEmpty)||!t.end.isTouching(sd._createAt(e,0))&&yd(e,t))}bd.prototype.is=function(e){return "selection"===e||"model:selection"===e};class xd extends(F(dd)){constructor(e,t){super(e,t),Ad.call(this);}detach(){this.stopListening();}toRange(){return new dd(this.start,this.end)}static fromRange(e){return new xd(e.start,e.end)}}function Ad(){this.listenTo(this.root.document.model,"applyOperation",((e,t)=>{const i=t[0];i.isDocumentOperation&&Ed.call(this,i);}),{priority:"low"});}function Ed(e){const t=this.getTransformedByOperation(e),i=dd._createFromRanges(t),n=!i.isEqual(this),s=function(e,t){switch(t.type){case"insert":return e.containsPosition(t.position);case"move":case"remove":case"reinsert":case"merge":return e.containsPosition(t.sourcePosition)||e.start.isEqual(t.sourcePosition)||e.containsPosition(t.targetPosition);case"split":return e.containsPosition(t.splitPosition)||e.containsPosition(t.insertionPosition)}return !1}(this,e);let o=null;if(n){"$graveyard"==i.root.rootName&&(o="remove"==e.type?e.sourcePosition:e.deletionPosition);const t=this.toRange();this.start=i.start,this.end=i.end,this.fire("change:range",t,{deletionPosition:o});}else s&&this.fire("change:content",this.toRange(),{deletionPosition:o});}xd.prototype.is=function(e){return "liveRange"===e||"model:liveRange"===e||"range"==e||"model:range"===e};const Td="selection:";class Sd extends(F(Jc)){_selection;constructor(e){super(),this._selection=new Id(e),this._selection.delegate("change:range").to(this),this._selection.delegate("change:attribute").to(this),this._selection.delegate("change:marker").to(this);}get isCollapsed(){return this._selection.isCollapsed}get anchor(){return this._selection.anchor}get focus(){return this._selection.focus}get rangeCount(){return this._selection.rangeCount}get hasOwnRange(){return this._selection.hasOwnRange}get isBackward(){return this._selection.isBackward}get isGravityOverridden(){return this._selection.isGravityOverridden}get markers(){return this._selection.markers}get _ranges(){return this._selection._ranges}getRanges(){return this._selection.getRanges()}getFirstPosition(){return this._selection.getFirstPosition()}getLastPosition(){return this._selection.getLastPosition()}getFirstRange(){return this._selection.getFirstRange()}getLastRange(){return this._selection.getLastRange()}getSelectedBlocks(){return this._selection.getSelectedBlocks()}getSelectedElement(){return this._selection.getSelectedElement()}containsEntireContent(e){return this._selection.containsEntireContent(e)}destroy(){this._selection.destroy();}getAttributeKeys(){return this._selection.getAttributeKeys()}getAttributes(){return this._selection.getAttributes()}getAttribute(e){return this._selection.getAttribute(e)}hasAttribute(e){return this._selection.hasAttribute(e)}refresh(){this._selection.updateMarkers(),this._selection._updateAttributes(!1);}observeMarkers(e){this._selection.observeMarkers(e);}_setFocus(e,t){this._selection.setFocus(e,t);}_setTo(...e){this._selection.setTo(...e);}_setAttribute(e,t){this._selection.setAttribute(e,t);}_removeAttribute(e){this._selection.removeAttribute(e);}_getStoredAttributes(){return this._selection.getStoredAttributes()}_overrideGravity(){return this._selection.overrideGravity()}_restoreGravity(e){this._selection.restoreGravity(e);}static _getStoreAttributeKey(e){return Td+e}static _isStoreAttributeKey(e){return e.startsWith(Td)}}Sd.prototype.is=function(e){return "selection"===e||"model:selection"==e||"documentSelection"==e||"model:documentSelection"==e};class Id extends bd{markers=new Sa({idProperty:"name"});_model;_document;_attributePriority=new Map;_selectionRestorePosition=null;_hasChangedRange=!1;_overriddenGravityRegister=new Set;_observedMarkers=new Set;constructor(e){super(),this._model=e.model,this._document=e,this.listenTo(this._model,"applyOperation",((e,t)=>{const i=t[0];i.isDocumentOperation&&"marker"!=i.type&&"rename"!=i.type&&"noop"!=i.type&&(0==this._ranges.length&&this._selectionRestorePosition&&this._fixGraveyardSelection(this._selectionRestorePosition),this._selectionRestorePosition=null,this._hasChangedRange&&(this._hasChangedRange=!1,this.fire("change:range",{directChange:!1})));}),{priority:"lowest"}),this.on("change:range",(()=>{this._validateSelectionRanges(this.getRanges());})),this.listenTo(this._model.markers,"update",((e,t,i,n)=>{this._updateMarker(t,n);})),this.listenTo(this._document,"change",((e,t)=>{!function(e,t){const i=e.document.differ;for(const n of i.getChanges()){if("insert"!=n.type)continue;const i=n.position.parent;n.length===i.maxOffset&&e.enqueueChange(t,(e=>{const t=Array.from(i.getAttributeKeys()).filter((e=>e.startsWith(Td)));for(const n of t)e.removeAttribute(n,i);}));}}(this._model,t);}));}get isCollapsed(){return 0===this._ranges.length?this._document._getDefaultRange().isCollapsed:super.isCollapsed}get anchor(){return super.anchor||this._document._getDefaultRange().start}get focus(){return super.focus||this._document._getDefaultRange().end}get rangeCount(){return this._ranges.length?this._ranges.length:1}get hasOwnRange(){return this._ranges.length>0}get isGravityOverridden(){return !!this._overriddenGravityRegister.size}destroy(){for(let e=0;e<this._ranges.length;e++)this._ranges[e].detach();this.stopListening();}*getRanges(){this._ranges.length?yield*super.getRanges():yield this._document._getDefaultRange();}getFirstRange(){return super.getFirstRange()||this._document._getDefaultRange()}getLastRange(){return super.getLastRange()||this._document._getDefaultRange()}setTo(...e){super.setTo(...e),this._updateAttributes(!0),this.updateMarkers();}setFocus(e,t){super.setFocus(e,t),this._updateAttributes(!0),this.updateMarkers();}setAttribute(e,t){if(this._setAttribute(e,t)){const t=[e];this.fire("change:attribute",{attributeKeys:t,directChange:!0});}}removeAttribute(e){if(this._removeAttribute(e)){const t=[e];this.fire("change:attribute",{attributeKeys:t,directChange:!0});}}overrideGravity(){const e=k();return this._overriddenGravityRegister.add(e),1===this._overriddenGravityRegister.size&&this._updateAttributes(!0),e}restoreGravity(e){if(!this._overriddenGravityRegister.has(e))throw new E("document-selection-gravity-wrong-restore",this,{uid:e});this._overriddenGravityRegister.delete(e),this.isGravityOverridden||this._updateAttributes(!0);}observeMarkers(e){this._observedMarkers.add(e),this.updateMarkers();}_replaceAllRanges(e){this._validateSelectionRanges(e),super._replaceAllRanges(e);}_popRange(){this._ranges.pop().detach();}_pushRange(e){const t=this._prepareRange(e);t&&this._ranges.push(t);}_validateSelectionRanges(e){for(const t of e)if(!this._document._validateSelectionRange(t))throw new E("document-selection-wrong-position",this,{range:t})}_prepareRange(e){if(this._checkRange(e),e.root==this._document.graveyard)return;const t=xd.fromRange(e);return t.on("change:range",((e,i,n)=>{if(this._hasChangedRange=!0,t.root==this._document.graveyard){this._selectionRestorePosition=n.deletionPosition;const e=this._ranges.indexOf(t);this._ranges.splice(e,1),t.detach();}})),t}updateMarkers(){if(!this._observedMarkers.size)return;const e=[];let t=!1;for(const t of this._model.markers){const i=t.name.split(":",1)[0];if(!this._observedMarkers.has(i))continue;const n=t.getRange();for(const i of this.getRanges())n.containsRange(i,!i.isCollapsed)&&e.push(t);}const i=Array.from(this.markers);for(const i of e)this.markers.has(i)||(this.markers.add(i),t=!0);for(const i of Array.from(this.markers))e.includes(i)||(this.markers.remove(i),t=!0);t&&this.fire("change:marker",{oldMarkers:i,directChange:!1});}_updateMarker(e,t){const i=e.name.split(":",1)[0];if(!this._observedMarkers.has(i))return;let n=!1;const s=Array.from(this.markers),o=this.markers.has(e);if(t){let i=!1;for(const e of this.getRanges())if(t.containsRange(e,!e.isCollapsed)){i=!0;break}i&&!o?(this.markers.add(e),n=!0):!i&&o&&(this.markers.remove(e),n=!0);}else o&&(this.markers.remove(e),n=!0);n&&this.fire("change:marker",{oldMarkers:s,directChange:!1});}_updateAttributes(e){const t=Ra(this._getSurroundingAttributes()),i=Ra(this.getAttributes());if(e)this._attributePriority=new Map,this._attrs=new Map;else for(const[e,t]of this._attributePriority)"low"==t&&(this._attrs.delete(e),this._attributePriority.delete(e));this._setAttributesTo(t);const n=[];for(const[e,t]of this.getAttributes())i.has(e)&&i.get(e)===t||n.push(e);for(const[e]of i)this.hasAttribute(e)||n.push(e);n.length>0&&this.fire("change:attribute",{attributeKeys:n,directChange:!1});}_setAttribute(e,t,i=!0){const n=i?"normal":"low";if("low"==n&&"normal"==this._attributePriority.get(e))return !1;return super.getAttribute(e)!==t&&(this._attrs.set(e,t),this._attributePriority.set(e,n),!0)}_removeAttribute(e,t=!0){const i=t?"normal":"low";return ("low"!=i||"normal"!=this._attributePriority.get(e))&&(this._attributePriority.set(e,i),!!super.hasAttribute(e)&&(this._attrs.delete(e),!0))}_setAttributesTo(e){const t=new Set;for(const[t,i]of this.getAttributes())e.get(t)!==i&&this._removeAttribute(t,!1);for(const[i,n]of e){this._setAttribute(i,n,!1)&&t.add(i);}return t}*getStoredAttributes(){const e=this.getFirstPosition().parent;if(this.isCollapsed&&e.isEmpty)for(const t of e.getAttributeKeys())if(t.startsWith(Td)){const i=t.substr(10);yield [i,e.getAttribute(t)];}}_getSurroundingAttributes(){const e=this.getFirstPosition(),t=this._model.schema;if("$graveyard"==e.root.rootName)return null;let i=null;if(this.isCollapsed){const n=e.textNode?e.textNode:e.nodeBefore,s=e.textNode?e.textNode:e.nodeAfter;if(this.isGravityOverridden||(i=Pd(n,t)),i||(i=Pd(s,t)),!this.isGravityOverridden&&!i){let e=n;for(;e&&!i;)e=e.previousSibling,i=Pd(e,t);}if(!i){let e=s;for(;e&&!i;)e=e.nextSibling,i=Pd(e,t);}i||(i=this.getStoredAttributes());}else {const e=this.getFirstRange();for(const n of e){if(n.item.is("element")&&t.isObject(n.item)){i=Pd(n.item,t);break}if("text"==n.type){i=n.item.getAttributes();break}}}return i}_fixGraveyardSelection(e){const t=this._model.schema.getNearestSelectionRange(e);t&&this._pushRange(t);}}function Pd(e,t){if(!e)return null;if(e instanceof ed||e instanceof Xc)return e.getAttributes();if(!t.isInline(e))return null;if(!t.isObject(e))return [];const i=[];for(const[n,s]of e.getAttributes())t.checkAttribute("$text",n)&&!1!==t.getAttributeProperties(n).copyFromObject&&i.push([n,s]);return i}class Vd{_dispatchers;constructor(e){this._dispatchers=e;}add(e){for(const t of this._dispatchers)e(t);return this}}class Rd extends Vd{elementToElement(e){return this.add(function(e){const t=Nd(e.model),i=Dd(e.view,"container");t.attributes.length&&(t.children=!0);return n=>{n.on(`insert:${t.name}`,Md(i,Wd(t)),{priority:e.converterPriority||"normal"}),(t.children||t.attributes.length)&&n.on("reduceChanges",Ud(t),{priority:"low"});}}(e))}elementToStructure(e){return this.add(function(e){const t=Nd(e.model),i=Dd(e.view,"container");return t.children=!0,n=>{if(n._conversionApi.schema.checkChild(t.name,"$text"))throw new E("conversion-element-to-structure-disallowed-text",n,{elementName:t.name});var s,o;n.on(`insert:${t.name}`,(s=i,o=Wd(t),(e,t,i)=>{if(!o(t.item,i.consumable,{preflight:!0}))return;const n=new Map;i.writer._registerSlotFactory(function(e,t,i){return (n,s)=>{const o=n.createContainerElement("$slot");let r=null;if("children"===s)r=Array.from(e.getChildren());else {if("function"!=typeof s)throw new E("conversion-slot-mode-unknown",i.dispatcher,{modeOrFilter:s});r=Array.from(e.getChildren()).filter((e=>s(e)));}return t.set(o,r),o}}(t.item,n,i));const r=s(t.item,i,t);if(i.writer._clearSlotFactory(),!r)return;!function(e,t,i){const n=Array.from(t.values()).flat(),s=new Set(n);if(s.size!=n.length)throw new E("conversion-slot-filter-overlap",i.dispatcher,{element:e});if(s.size!=e.childCount)throw new E("conversion-slot-filter-incomplete",i.dispatcher,{element:e})}(t.item,n,i),o(t.item,i.consumable);const a=i.mapper.toViewPosition(t.range.start);i.mapper.bindElements(t.item,r),i.writer.insert(a,r),i.convertAttributes(t.item),function(e,t,i,n){i.mapper.on("modelToViewPosition",r,{priority:"highest"});let s=null,o=null;for([s,o]of t)jd(e,o,i,n),i.writer.move(i.writer.createRangeIn(s),i.writer.createPositionBefore(s)),i.writer.remove(s);function r(e,t){const i=t.modelPosition.nodeAfter,n=o.indexOf(i);n<0||(t.viewPosition=t.mapper.findPositionIn(s,n));}i.mapper.off("modelToViewPosition",r);}(r,n,i,{reconversion:t.reconversion});}),{priority:e.converterPriority||"normal"}),n.on("reduceChanges",Ud(t),{priority:"low"});}}(e))}attributeToElement(e){return this.add(function(e){e=Is(e);let t=e.model;"string"==typeof t&&(t={key:t});let i=`attribute:${t.key}`;t.name&&(i+=":"+t.name);if(t.values)for(const i of t.values)e.view[i]=Dd(e.view[i],"attribute");else e.view=Dd(e.view,"attribute");const n=zd(e);return t=>{t.on(i,Od(n),{priority:e.converterPriority||"normal"});}}(e))}attributeToAttribute(e){return this.add(function(e){e=Is(e);let t=e.model;"string"==typeof t&&(t={key:t});let i=`attribute:${t.key}`;t.name&&(i+=":"+t.name);if(t.values)for(const i of t.values)e.view[i]=Hd(e.view[i]);else e.view=Hd(e.view);const n=zd(e);return t=>{var s;t.on(i,(s=n,(e,t,i)=>{if(!i.consumable.test(t.item,e.name))return;const n=s(t.attributeOldValue,i,t),o=s(t.attributeNewValue,i,t);if(!n&&!o)return;i.consumable.consume(t.item,e.name);const r=i.mapper.toViewElement(t.item),a=i.writer;if(!r)throw new E("conversion-attribute-to-attribute-on-text",i.dispatcher,t);if(null!==t.attributeOldValue&&n)if("class"==n.key){const e="string"==typeof n.value?n.value.split(/\s+/):n.value;for(const t of e)a.removeClass(t,r);}else if("style"==n.key)if("string"==typeof n.value){const e=new wl(a.document.stylesProcessor);e.setTo(n.value);for(const[t]of e.getStylesEntries())a.removeStyle(t,r);}else {const e=Object.keys(n.value);for(const t of e)a.removeStyle(t,r);}else a.removeAttribute(n.key,r);if(null!==t.attributeNewValue&&o)if("class"==o.key){const e="string"==typeof o.value?o.value.split(/\s+/):o.value;for(const t of e)a.addClass(t,r);}else if("style"==o.key)if("string"==typeof o.value){const e=new wl(a.document.stylesProcessor);e.setTo(o.value);for(const[t,i]of e.getStylesEntries())a.setStyle(t,i,r);}else {const e=Object.keys(o.value);for(const t of e)a.setStyle(t,o.value[t],r);}else a.setAttribute(o.key,o.value,r);}),{priority:e.converterPriority||"normal"});}}(e))}markerToElement(e){return this.add(function(e){const t=Dd(e.view,"ui");return i=>{i.on(`addMarker:${e.model}`,Ld(t),{priority:e.converterPriority||"normal"}),i.on(`removeMarker:${e.model}`,((e,t,i)=>{const n=i.mapper.markerNameToElements(t.markerName);if(n){for(const e of n)i.mapper.unbindElementFromMarkerName(e,t.markerName),i.writer.clear(i.writer.createRangeOn(e),e);i.writer.clearClonedElementsGroup(t.markerName),e.stop();}}),{priority:e.converterPriority||"normal"});}}(e))}markerToHighlight(e){return this.add(function(e){return t=>{var i;t.on(`addMarker:${e.model}`,(i=e.view,(e,t,n)=>{if(!t.item)return;if(!(t.item instanceof bd||t.item instanceof Sd||t.item.is("$textProxy")))return;const s=$d(i,t,n);if(!s)return;if(!n.consumable.consume(t.item,e.name))return;const o=n.writer,r=Bd(o,s),a=o.document.selection;if(t.item instanceof bd||t.item instanceof Sd)o.wrap(a.getFirstRange(),r);else {const e=n.mapper.toViewRange(t.range),i=o.wrap(e,r);for(const e of i.getItems())if(e.is("attributeElement")&&e.isSimilar(r)){n.mapper.bindElementToMarker(e,t.markerName);break}}}),{priority:e.converterPriority||"normal"}),t.on(`addMarker:${e.model}`,function(e){return (t,i,n)=>{if(!i.item)return;if(!(i.item instanceof td))return;const s=$d(e,i,n);if(!s)return;if(!n.consumable.test(i.item,t.name))return;const o=n.mapper.toViewElement(i.item);if(o&&o.getCustomProperty("addHighlight")){n.consumable.consume(i.item,t.name);for(const e of dd._createIn(i.item))n.consumable.consume(e.item,t.name);o.getCustomProperty("addHighlight")(o,s,n.writer),n.mapper.bindElementToMarker(o,i.markerName);}}}(e.view),{priority:e.converterPriority||"normal"}),t.on(`removeMarker:${e.model}`,function(e){return (t,i,n)=>{if(i.markerRange.isCollapsed)return;const s=$d(e,i,n);if(!s)return;const o=Bd(n.writer,s),r=n.mapper.markerNameToElements(i.markerName);if(r){for(const e of r)if(n.mapper.unbindElementFromMarkerName(e,i.markerName),e.is("attributeElement"))n.writer.unwrap(n.writer.createRangeOn(e),o);else {e.getCustomProperty("removeHighlight")(e,s.id,n.writer);}n.writer.clearClonedElementsGroup(i.markerName),t.stop();}}}(e.view),{priority:e.converterPriority||"normal"});}}(e))}markerToData(e){return this.add(function(e){e=Is(e);const t=e.model;let i=e.view;i||(i=i=>({group:t,name:i.substr(e.model.length+1)}));return n=>{var s;n.on(`addMarker:${t}`,(s=i,(e,t,i)=>{const n=s(t.markerName,i);if(!n)return;const o=t.markerRange;i.consumable.consume(o,e.name)&&(Fd(o,!1,i,t,n),Fd(o,!0,i,t,n),e.stop());}),{priority:e.converterPriority||"normal"}),n.on(`removeMarker:${t}`,function(e){return (t,i,n)=>{const s=e(i.markerName,n);if(!s)return;const o=n.mapper.markerNameToElements(i.markerName);if(o){for(const e of o)n.mapper.unbindElementFromMarkerName(e,i.markerName),e.is("containerElement")?(r(`data-${s.group}-start-before`,e),r(`data-${s.group}-start-after`,e),r(`data-${s.group}-end-before`,e),r(`data-${s.group}-end-after`,e)):n.writer.clear(n.writer.createRangeOn(e),e);n.writer.clearClonedElementsGroup(i.markerName),t.stop();}function r(e,t){if(t.hasAttribute(e)){const i=new Set(t.getAttribute(e).split(","));i.delete(s.name),0==i.size?n.writer.removeAttribute(e,t):n.writer.setAttribute(e,Array.from(i).join(","),t);}}}}(i),{priority:e.converterPriority||"normal"});}}(e))}}function Bd(e,t){const i=e.createAttributeElement("span",t.attributes);return t.classes&&i._addClass(t.classes),"number"==typeof t.priority&&(i._priority=t.priority),i._id=t.id,i}function Od(e){return (t,i,n)=>{if(!n.consumable.test(i.item,t.name))return;const s=e(i.attributeOldValue,n,i),o=e(i.attributeNewValue,n,i);if(!s&&!o)return;n.consumable.consume(i.item,t.name);const r=n.writer,a=r.document.selection;if(i.item instanceof bd||i.item instanceof Sd)r.wrap(a.getFirstRange(),o);else {let e=n.mapper.toViewRange(i.range);null!==i.attributeOldValue&&s&&(e=r.unwrap(e,s)),null!==i.attributeNewValue&&o&&r.wrap(e,o);}}}function Md(e,t=Gd){return (i,n,s)=>{if(!t(n.item,s.consumable,{preflight:!0}))return;const o=e(n.item,s,n);if(!o)return;t(n.item,s.consumable);const r=s.mapper.toViewPosition(n.range.start);s.mapper.bindElements(n.item,o),s.writer.insert(r,o),s.convertAttributes(n.item),jd(o,n.item.getChildren(),s,{reconversion:n.reconversion});}}function Ld(e){return (t,i,n)=>{i.isOpening=!0;const s=e(i,n);i.isOpening=!1;const o=e(i,n);if(!s||!o)return;const r=i.markerRange;if(r.isCollapsed&&!n.consumable.consume(r,t.name))return;for(const e of r)if(!n.consumable.consume(e.item,t.name))return;const a=n.mapper,l=n.writer;l.insert(a.toViewPosition(r.start),s),n.mapper.bindElementToMarker(s,i.markerName),r.isCollapsed||(l.insert(a.toViewPosition(r.end),o),n.mapper.bindElementToMarker(o,i.markerName)),t.stop();}}function Fd(e,t,i,n,s){const o=t?e.start:e.end,r=o.nodeAfter&&o.nodeAfter.is("element")?o.nodeAfter:null,a=o.nodeBefore&&o.nodeBefore.is("element")?o.nodeBefore:null;if(r||a){let e,o;t&&r||!t&&!a?(e=r,o=!0):(e=a,o=!1);const l=i.mapper.toViewElement(e);if(l)return void function(e,t,i,n,s,o){const r=`data-${o.group}-${t?"start":"end"}-${i?"before":"after"}`,a=e.hasAttribute(r)?e.getAttribute(r).split(","):[];a.unshift(o.name),n.writer.setAttribute(r,a.join(","),e),n.mapper.bindElementToMarker(e,s.markerName);}(l,t,o,i,n,s)}!function(e,t,i,n,s){const o=`${s.group}-${t?"start":"end"}`,r=s.name?{name:s.name}:null,a=i.writer.createUIElement(o,r);i.writer.insert(e,a),i.mapper.bindElementToMarker(a,n.markerName);}(i.mapper.toViewPosition(o),t,i,n,s);}function Nd(e){return "string"==typeof e&&(e={name:e}),{name:e.name,attributes:e.attributes?Aa(e.attributes):[],children:!!e.children}}function Dd(e,t){return "function"==typeof e?e:(i,n)=>function(e,t,i){"string"==typeof e&&(e={name:e});let n;const s=t.writer,o=Object.assign({},e.attributes);if("container"==i)n=s.createContainerElement(e.name,o);else if("attribute"==i){const t={priority:e.priority||Ul.DEFAULT_PRIORITY};n=s.createAttributeElement(e.name,o,t);}else n=s.createUIElement(e.name,o);if(e.styles){const t=Object.keys(e.styles);for(const i of t)s.setStyle(i,e.styles[i],n);}if(e.classes){const t=e.classes;if("string"==typeof t)s.addClass(t,n);else for(const e of t)s.addClass(e,n);}return n}(e,n,t)}function zd(e){return e.model.values?(t,i,n)=>{const s=e.view[t];return s?s(t,i,n):null}:e.view}function Hd(e){return "string"==typeof e?t=>({key:e,value:t}):"object"==typeof e?e.value?()=>e:t=>({key:e.key,value:t}):e}function $d(e,t,i){const n="function"==typeof e?e(t,i):e;return n?(n.priority||(n.priority=10),n.id||(n.id=t.markerName),n):null}function Ud(e){const t=function(e){return (t,i)=>{if(!t.is("element",e.name))return !1;if("attribute"==i.type){if(e.attributes.includes(i.attributeKey))return !0}else if(e.children)return !0;return !1}}(e);return (e,i)=>{const n=[];i.reconvertedElements||(i.reconvertedElements=new Set);for(const e of i.changes){const s="attribute"==e.type?e.range.start.nodeAfter:e.position.parent;if(s&&t(s,e)){if(!i.reconvertedElements.has(s)){i.reconvertedElements.add(s);const e=sd._createBefore(s);let t=n.length;for(let i=n.length-1;i>=0;i--){const s=n[i],o=("attribute"==s.type?s.range.start:s.position).compareWith(e);if("before"==o||"remove"==s.type&&"same"==o)break;t=i;}n.splice(t,0,{type:"remove",name:s.name,position:e,length:1},{type:"reinsert",name:s.name,position:e,length:1});}}else n.push(e);}i.changes=n;}}function Wd(e){return (t,i,n={})=>{const s=["insert"];for(const i of e.attributes)t.hasAttribute(i)&&s.push(`attribute:${i}`);return !!s.every((e=>i.test(t,e)))&&(n.preflight||s.forEach((e=>i.consume(t,e))),!0)}}function jd(e,t,i,n){for(const s of t)qd(e.root,s,i,n)||i.convertItem(s);}function qd(e,t,i,n){const{writer:s,mapper:o}=i;if(!n.reconversion)return !1;const r=o.toViewElement(t);return !(!r||r.root==e)&&(!!i.canReuseView(r)&&(s.move(s.createRangeOn(r),o.toViewPosition(sd._createBefore(t))),!0))}function Gd(e,t,{preflight:i}={}){return i?t.test(e,"insert"):t.consume(e,"insert")}function Kd(e){const{schema:t,document:i}=e.model;for(const n of i.getRoots())if(n.isEmpty&&!t.checkChild(n,"$text")&&t.checkChild(n,"paragraph"))return e.insertElement("paragraph",n),!0;return !1}function Zd(e,t,i){const n=i.createContext(e);return !!i.checkChild(n,"paragraph")&&!!i.checkChild(n.push("paragraph"),t)}function Jd(e,t){const i=t.createElement("paragraph");return t.insert(i,e),t.createPositionAt(i,0)}class Qd extends Vd{elementToElement(e){return this.add(Yd(e))}elementToAttribute(e){return this.add(function(e){e=Is(e),th(e);const t=ih(e,!1),i=Xd(e.view),n=i?`element:${i}`:"element";return i=>{i.on(n,t,{priority:e.converterPriority||"low"});}}(e))}attributeToAttribute(e){return this.add(function(e){e=Is(e);let t=null;("string"==typeof e.view||e.view.key)&&(t=function(e){"string"==typeof e.view&&(e.view={key:e.view});const t=e.view.key,i=void 0===e.view.value?/[\s\S]*/:e.view.value;let n;if("class"==t||"style"==t){const e="class"==t?"classes":"styles";n={[e]:i};}else n={attributes:{[t]:i}};e.view.name&&(n.name=e.view.name);return e.view=n,t}(e));th(e,t);const i=ih(e,!0);return t=>{t.on("element",i,{priority:e.converterPriority||"low"});}}(e))}elementToMarker(e){return this.add(function(e){const t=function(e){return (t,i)=>{const n="string"==typeof e?e:e(t,i);return i.writer.createElement("$marker",{"data-name":n})}}(e.model);return Yd({...e,model:t})}(e))}dataToMarker(e){return this.add(function(e){e=Is(e),e.model||(e.model=t=>t?e.view+":"+t:e.view);const t={view:e.view,model:e.model},i=eh(nh(t,"start")),n=eh(nh(t,"end"));return s=>{s.on(`element:${e.view}-start`,i,{priority:e.converterPriority||"normal"}),s.on(`element:${e.view}-end`,n,{priority:e.converterPriority||"normal"});const o=C.low,r=C.highest,a=C.get(e.converterPriority)/r;s.on("element",function(e){return (t,i,n)=>{const s=`data-${e.view}`;function o(t,s){for(const o of s){const s=e.model(o,n),r=n.writer.createElement("$marker",{"data-name":s});n.writer.insert(r,t),i.modelCursor.isEqual(t)?i.modelCursor=i.modelCursor.getShiftedBy(1):i.modelCursor=i.modelCursor._getTransformedByInsertion(t,1),i.modelRange=i.modelRange._getTransformedByInsertion(t,1)[0];}}(n.consumable.test(i.viewItem,{attributes:s+"-end-after"})||n.consumable.test(i.viewItem,{attributes:s+"-start-after"})||n.consumable.test(i.viewItem,{attributes:s+"-end-before"})||n.consumable.test(i.viewItem,{attributes:s+"-start-before"}))&&(i.modelRange||Object.assign(i,n.convertChildren(i.viewItem,i.modelCursor)),n.consumable.consume(i.viewItem,{attributes:s+"-end-after"})&&o(i.modelRange.end,i.viewItem.getAttribute(s+"-end-after").split(",")),n.consumable.consume(i.viewItem,{attributes:s+"-start-after"})&&o(i.modelRange.end,i.viewItem.getAttribute(s+"-start-after").split(",")),n.consumable.consume(i.viewItem,{attributes:s+"-end-before"})&&o(i.modelRange.start,i.viewItem.getAttribute(s+"-end-before").split(",")),n.consumable.consume(i.viewItem,{attributes:s+"-start-before"})&&o(i.modelRange.start,i.viewItem.getAttribute(s+"-start-before").split(",")));}}(t),{priority:o+a});}}(e))}}function Yd(e){const t=eh(e=Is(e)),i=Xd(e.view),n=i?`element:${i}`:"element";return i=>{i.on(n,t,{priority:e.converterPriority||"normal"});}}function Xd(e){return "string"==typeof e?e:"object"==typeof e&&"string"==typeof e.name?e.name:null}function eh(e){const t=new fl(e.view);return (i,n,s)=>{const o=t.match(n.viewItem);if(!o)return;const r=o.match;if(r.name=!0,!s.consumable.test(n.viewItem,r))return;const a=function(e,t,i){return e instanceof Function?e(t,i):i.writer.createElement(e)}(e.model,n.viewItem,s);a&&s.safeInsert(a,n.modelCursor)&&(s.consumable.consume(n.viewItem,r),s.convertChildren(n.viewItem,a),s.updateConversionResult(a,n));}}function th(e,t=null){const i=null===t||(e=>e.getAttribute(t)),n="object"!=typeof e.model?e.model:e.model.key,s="object"!=typeof e.model||void 0===e.model.value?i:e.model.value;e.model={key:n,value:s};}function ih(e,t){const i=new fl(e.view);return (n,s,o)=>{if(!s.modelRange&&t)return;const r=i.match(s.viewItem);if(!r)return;if(!function(e,t){const i="function"==typeof e?e(t):e;if("object"==typeof i&&!Xd(i))return !1;return !i.classes&&!i.attributes&&!i.styles}(e.view,s.viewItem)?delete r.match.name:r.match.name=!0,!o.consumable.test(s.viewItem,r.match))return;const a=e.model.key,l="function"==typeof e.model.value?e.model.value(s.viewItem,o):e.model.value;if(null===l)return;s.modelRange||Object.assign(s,o.convertChildren(s.viewItem,s.modelCursor));const c=function(e,t,i,n){let s=!1;for(const o of Array.from(e.getItems({shallow:i})))n.schema.checkAttribute(o,t.key)&&(s=!0,o.hasAttribute(t.key)||n.writer.setAttribute(t.key,t.value,o));return s}(s.modelRange,{key:a,value:l},t,o);c&&(o.consumable.test(s.viewItem,{name:!0})&&(r.match.name=!0),o.consumable.consume(s.viewItem,r.match));}}function nh(e,t){return {view:`${e.view}-${t}`,model:(t,i)=>{const n=t.getAttribute("name"),s=e.model(n,i);return i.writer.createElement("$marker",{"data-name":s})}}}function sh(e){e.document.registerPostFixer((t=>function(e,t){const i=t.document.selection,n=t.schema,s=[];let o=!1;for(const e of i.getRanges()){const t=oh(e,n);t&&!t.isEqual(e)?(s.push(t),o=!0):s.push(e);}o&&e.setSelection(function(e){const t=[...e],i=new Set;let n=1;for(;n<t.length;){const e=t[n],s=t.slice(0,n);for(const[o,r]of s.entries())if(!i.has(o))if(e.isEqual(r))i.add(o);else if(e.isIntersecting(r)){i.add(o),i.add(n);const s=e.getJoined(r);t.push(s);}n++;}return t.filter(((e,t)=>!i.has(t)))}(s),{backward:i.isBackward});return !1}(t,e)));}function oh(e,t){return e.isCollapsed?function(e,t){const i=e.start,n=t.getNearestSelectionRange(i);if(!n){const e=i.getAncestors().reverse().find((e=>t.isObject(e)));return e?dd._createOn(e):null}if(!n.isCollapsed)return n;const s=n.start;if(i.isEqual(s))return null;return new dd(s)}(e,t):function(e,t){const{start:i,end:n}=e,s=t.checkChild(i,"$text"),o=t.checkChild(n,"$text"),r=t.getLimitElement(i),a=t.getLimitElement(n);if(r===a){if(s&&o)return null;if(function(e,t,i){const n=e.nodeAfter&&!i.isLimit(e.nodeAfter)||i.checkChild(e,"$text"),s=t.nodeBefore&&!i.isLimit(t.nodeBefore)||i.checkChild(t,"$text");return n||s}(i,n,t)){const e=i.nodeAfter&&t.isSelectable(i.nodeAfter)?null:t.getNearestSelectionRange(i,"forward"),s=n.nodeBefore&&t.isSelectable(n.nodeBefore)?null:t.getNearestSelectionRange(n,"backward"),o=e?e.start:i,r=s?s.end:n;return new dd(o,r)}}const l=r&&!r.is("rootElement"),c=a&&!a.is("rootElement");if(l||c){const e=i.nodeAfter&&n.nodeBefore&&i.nodeAfter.parent===n.nodeBefore.parent,s=l&&(!e||!ah(i.nodeAfter,t)),o=c&&(!e||!ah(n.nodeBefore,t));let d=i,h=n;return s&&(d=sd._createBefore(rh(r,t))),o&&(h=sd._createAfter(rh(a,t))),new dd(d,h)}return null}(e,t)}function rh(e,t){let i=e,n=i;for(;t.isLimit(n)&&n.parent;)i=n,n=n.parent;return i}function ah(e,t){return e&&t.isSelectable(e)}class lh extends(ar()){model;view;mapper;downcastDispatcher;constructor(e,t){super(),this.model=e,this.view=new Zc(t),this.mapper=new hd,this.downcastDispatcher=new gd({mapper:this.mapper,schema:e.schema});const i=this.model.document,n=i.selection,s=this.model.markers;var r,a,l;this.listenTo(this.model,"_beforeChanges",(()=>{this.view._disableRendering(!0);}),{priority:"highest"}),this.listenTo(this.model,"_afterChanges",(()=>{this.view._disableRendering(!1);}),{priority:"lowest"}),this.listenTo(i,"change",(()=>{this.view.change((e=>{this.downcastDispatcher.convertChanges(i.differ,s,e),this.downcastDispatcher.convertSelection(n,s,e);}));}),{priority:"low"}),this.listenTo(this.view.document,"selectionChange",function(e,t){return (i,n)=>{const s=n.newSelection,o=[];for(const e of s.getRanges())o.push(t.toModelRange(e));const r=e.createSelection(o,{backward:s.isBackward});r.isEqual(e.document.selection)||e.change((e=>{e.setSelection(r);}));}}(this.model,this.mapper)),this.listenTo(this.view.document,"beforeinput",(r=this.mapper,a=this.model.schema,l=this.view,(e,t)=>{if(!l.document.isComposing||o.isAndroid)for(let e=0;e<t.targetRanges.length;e++){const i=t.targetRanges[e],n=r.toModelRange(i),s=oh(n,a);s&&!s.isEqual(n)&&(t.targetRanges[e]=r.toViewRange(s));}}),{priority:"high"}),this.downcastDispatcher.on("insert:$text",((e,t,i)=>{if(!i.consumable.consume(t.item,e.name))return;const n=i.writer,s=i.mapper.toViewPosition(t.range.start),o=n.createText(t.item.data);n.insert(s,o);}),{priority:"lowest"}),this.downcastDispatcher.on("insert",((e,t,i)=>{i.convertAttributes(t.item),t.reconversion||!t.item.is("element")||t.item.isEmpty||i.convertChildren(t.item);}),{priority:"lowest"}),this.downcastDispatcher.on("remove",((e,t,i)=>{const n=i.mapper.toViewPosition(t.position),s=t.position.getShiftedBy(t.length),o=i.mapper.toViewPosition(s,{isPhantom:!0}),r=i.writer.createRange(n,o),a=i.writer.remove(r.getTrimmed());for(const e of i.writer.createRangeIn(a).getItems())i.mapper.unbindViewElement(e,{defer:!0});}),{priority:"low"}),this.downcastDispatcher.on("cleanSelection",((e,t,i)=>{const n=i.writer,s=n.document.selection;for(const e of s.getRanges())e.isCollapsed&&e.end.parent.isAttached()&&i.writer.mergeAttributes(e.start);n.setSelection(null);})),this.downcastDispatcher.on("selection",((e,t,i)=>{const n=t.selection;if(n.isCollapsed)return;if(!i.consumable.consume(n,"selection"))return;const s=[];for(const e of n.getRanges())s.push(i.mapper.toViewRange(e));i.writer.setSelection(s,{backward:n.isBackward});}),{priority:"low"}),this.downcastDispatcher.on("selection",((e,t,i)=>{const n=t.selection;if(!n.isCollapsed)return;if(!i.consumable.consume(n,"selection"))return;const s=i.writer,o=n.getFirstPosition(),r=i.mapper.toViewPosition(o),a=s.breakAttributes(r);s.setSelection(a);}),{priority:"low"}),this.view.document.roots.bindTo(this.model.document.roots).using((e=>{if("$graveyard"==e.rootName)return null;const t=new Sl(this.view.document,e.name);return t.rootName=e.rootName,this.mapper.bindElements(e,t),t}));}destroy(){this.view.destroy(),this.stopListening();}reconvertMarker(e){const t="string"==typeof e?e:e.name,i=this.model.markers.get(t);if(!i)throw new E("editingcontroller-reconvertmarker-marker-not-exist",this,{markerName:t});this.model.change((()=>{this.model.markers._refresh(i);}));}reconvertItem(e){this.model.change((()=>{this.model.document.differ._refreshItem(e);}));}}class ch{_consumables=new Map;add(e,t){let i;e.is("$text")||e.is("documentFragment")?this._consumables.set(e,!0):(this._consumables.has(e)?i=this._consumables.get(e):(i=new hh(e),this._consumables.set(e,i)),i.add(t));}test(e,t){const i=this._consumables.get(e);return void 0===i?null:e.is("$text")||e.is("documentFragment")?i:i.test(t)}consume(e,t){return !!this.test(e,t)&&(e.is("$text")||e.is("documentFragment")?this._consumables.set(e,!1):this._consumables.get(e).consume(t),!0)}revert(e,t){const i=this._consumables.get(e);void 0!==i&&(e.is("$text")||e.is("documentFragment")?this._consumables.set(e,!0):i.revert(t));}static consumablesFromElement(e){const t={element:e,name:!0,attributes:[],classes:[],styles:[]},i=e.getAttributeKeys();for(const e of i)"style"!=e&&"class"!=e&&t.attributes.push(e);const n=e.getClassNames();for(const e of n)t.classes.push(e);const s=e.getStyleNames();for(const e of s)t.styles.push(e);return t}static createFrom(e,t){if(t||(t=new ch),e.is("$text"))return t.add(e),t;e.is("element")&&t.add(e,ch.consumablesFromElement(e)),e.is("documentFragment")&&t.add(e);for(const i of e.getChildren())t=ch.createFrom(i,t);return t}}const dh=["attributes","classes","styles"];class hh{element;_canConsumeName;_consumables;constructor(e){this.element=e,this._canConsumeName=null,this._consumables={attributes:new Map,styles:new Map,classes:new Map};}add(e){e.name&&(this._canConsumeName=!0);for(const t of dh)t in e&&this._add(t,e[t]);}test(e){if(e.name&&!this._canConsumeName)return this._canConsumeName;for(const t of dh)if(t in e){const i=this._test(t,e[t]);if(!0!==i)return i}return !0}consume(e){e.name&&(this._canConsumeName=!1);for(const t of dh)t in e&&this._consume(t,e[t]);}revert(e){e.name&&(this._canConsumeName=!0);for(const t of dh)t in e&&this._revert(t,e[t]);}_add(e,t){const i=Aa(t),n=this._consumables[e];for(const t of i){if("attributes"===e&&("class"===t||"style"===t))throw new E("viewconsumable-invalid-attribute",this);if(n.set(t,!0),"styles"===e)for(const e of this.element.document.stylesProcessor.getRelatedStyles(t))n.set(e,!0);}}_test(e,t){const i=Aa(t),n=this._consumables[e];for(const t of i)if("attributes"!==e||"class"!==t&&"style"!==t){const e=n.get(t);if(void 0===e)return null;if(!e)return !1}else {const e="class"==t?"classes":"styles",i=this._test(e,[...this._consumables[e].keys()]);if(!0!==i)return i}return !0}_consume(e,t){const i=Aa(t),n=this._consumables[e];for(const t of i)if("attributes"!==e||"class"!==t&&"style"!==t){if(n.set(t,!1),"styles"==e)for(const e of this.element.document.stylesProcessor.getRelatedStyles(t))n.set(e,!1);}else {const e="class"==t?"classes":"styles";this._consume(e,[...this._consumables[e].keys()]);}}_revert(e,t){const i=Aa(t),n=this._consumables[e];for(const t of i)if("attributes"!==e||"class"!==t&&"style"!==t){!1===n.get(t)&&n.set(t,!0);}else {const e="class"==t?"classes":"styles";this._revert(e,[...this._consumables[e].keys()]);}}}class uh extends(ar()){_sourceDefinitions={};_attributeProperties={};_customChildChecks=new Map;_customAttributeChecks=new Map;_genericCheckSymbol=Symbol("$generic");_compiledDefinitions;constructor(){super(),this.decorate("checkChild"),this.decorate("checkAttribute"),this.on("checkAttribute",((e,t)=>{t[0]=new mh(t[0]);}),{priority:"highest"}),this.on("checkChild",((e,t)=>{t[0]=new mh(t[0]),t[1]=this.getDefinition(t[1]);}),{priority:"highest"});}register(e,t){if(this._sourceDefinitions[e])throw new E("schema-cannot-register-item-twice",this,{itemName:e});this._sourceDefinitions[e]=[Object.assign({},t)],this._clearCache();}extend(e,t){if(!this._sourceDefinitions[e])throw new E("schema-cannot-extend-missing-item",this,{itemName:e});this._sourceDefinitions[e].push(Object.assign({},t)),this._clearCache();}getDefinitions(){return this._compiledDefinitions||this._compile(),this._compiledDefinitions}getDefinition(e){let t;return t="string"==typeof e?e:"is"in e&&(e.is("$text")||e.is("$textProxy"))?"$text":e.name,this.getDefinitions()[t]}isRegistered(e){return !!this.getDefinition(e)}isBlock(e){const t=this.getDefinition(e);return !(!t||!t.isBlock)}isLimit(e){const t=this.getDefinition(e);return !!t&&!(!t.isLimit&&!t.isObject)}isObject(e){const t=this.getDefinition(e);return !!t&&!!(t.isObject||t.isLimit&&t.isSelectable&&t.isContent)}isInline(e){const t=this.getDefinition(e);return !(!t||!t.isInline)}isSelectable(e){const t=this.getDefinition(e);return !!t&&!(!t.isSelectable&&!t.isObject)}isContent(e){const t=this.getDefinition(e);return !!t&&!(!t.isContent&&!t.isObject)}checkChild(e,t){return !!t&&this._checkContextMatch(e,t)}checkAttribute(e,t){const i=this.getDefinition(e.last);if(!i)return !1;const n=this._evaluateAttributeChecks(e,t);return void 0!==n?n:i.allowAttributes.includes(t)}checkMerge(e,t){if(e instanceof sd){const t=e.nodeBefore,i=e.nodeAfter;if(!(t instanceof td))throw new E("schema-check-merge-no-element-before",this);if(!(i instanceof td))throw new E("schema-check-merge-no-element-after",this);return this.checkMerge(t,i)}if(this.isLimit(e)||this.isLimit(t))return !1;for(const i of t.getChildren())if(!this.checkChild(e,i))return !1;return !0}addChildCheck(e,t){const i=void 0!==t?t:this._genericCheckSymbol,n=this._customChildChecks.get(i)||[];n.push(e),this._customChildChecks.set(i,n);}addAttributeCheck(e,t){const i=void 0!==t?t:this._genericCheckSymbol,n=this._customAttributeChecks.get(i)||[];n.push(e),this._customAttributeChecks.set(i,n);}setAttributeProperties(e,t){this._attributeProperties[e]=Object.assign(this.getAttributeProperties(e),t);}getAttributeProperties(e){return this._attributeProperties[e]||{}}getLimitElement(e){let t;if(e instanceof sd)t=e.parent;else {t=(e instanceof dd?[e]:Array.from(e.getRanges())).reduce(((e,t)=>{const i=t.getCommonAncestor();return e?e.getCommonAncestor(i,{includeSelf:!0}):i}),null);}for(;!this.isLimit(t)&&t.parent;)t=t.parent;return t}checkAttributeInSelection(e,t){if(e.isCollapsed){const i=[...e.getFirstPosition().getAncestors(),new Xc("",e.getAttributes())];return this.checkAttribute(i,t)}{const i=e.getRanges();for(const e of i)for(const i of e)if(this.checkAttribute(i.item,t))return !0}return !1}*getValidRanges(e,t){e=function*(e){for(const t of e)yield*t.getMinimalFlatRanges();}(e);for(const i of e)yield*this._getValidRangesForRange(i,t);}getNearestSelectionRange(e,t="both"){if("$graveyard"==e.root.rootName)return null;if(this.checkChild(e,"$text"))return new dd(e);let i,n;const s=e.getAncestors().reverse().find((e=>this.isLimit(e)))||e.root;"both"!=t&&"backward"!=t||(i=new id({boundaries:dd._createIn(s),startPosition:e,direction:"backward"})),"both"!=t&&"forward"!=t||(n=new id({boundaries:dd._createIn(s),startPosition:e}));for(const e of function*(e,t){let i=!1;for(;!i;){if(i=!0,e){const t=e.next();t.done||(i=!1,yield {walker:e,value:t.value});}if(t){const e=t.next();e.done||(i=!1,yield {walker:t,value:e.value});}}}(i,n)){const t=e.walker==i?"elementEnd":"elementStart",n=e.value;if(n.type==t&&this.isObject(n.item))return dd._createOn(n.item);if(this.checkChild(n.nextPosition,"$text"))return new dd(n.nextPosition)}return null}findAllowedParent(e,t){let i=e.parent;for(;i;){if(this.checkChild(i,t))return i;if(this.isLimit(i))return null;i=i.parent;}return null}setAllowedAttributes(e,t,i){const n=i.model;for(const[s,o]of Object.entries(t))n.schema.checkAttribute(e,s)&&i.setAttribute(s,o,e);}removeDisallowedAttributes(e,t){for(const i of e)if(i.is("$text"))Eh(this,i,t);else {const e=dd._createIn(i).getPositions();for(const i of e){Eh(this,i.nodeBefore||i.parent,t);}}}getAttributesWithProperty(e,t,i){const n={};for(const[s,o]of e.getAttributes()){const e=this.getAttributeProperties(s);void 0!==e[t]&&(void 0!==i&&i!==e[t]||(n[s]=o));}return n}createContext(e){return new mh(e)}_clearCache(){this._compiledDefinitions=null;}_compile(){const e={},t=this._sourceDefinitions,i=Object.keys(t);for(const n of i)e[n]=gh(t[n],n);const n=Object.values(e);for(const t of n)fh(e,t),ph(e,t),bh(e,t),wh(e,t);for(const t of n)_h(e,t);for(const t of n)vh(e,t);for(const t of n)yh(e,t);for(const t of n)kh(e,t);for(const t of n)Ch(e,t);this._compiledDefinitions=function(e){const t={};for(const i of Object.values(e))t[i.name]={name:i.name,isBlock:!!i.isBlock,isContent:!!i.isContent,isInline:!!i.isInline,isLimit:!!i.isLimit,isObject:!!i.isObject,isSelectable:!!i.isSelectable,allowIn:Array.from(i.allowIn).filter((t=>!!e[t])),allowChildren:Array.from(i.allowChildren).filter((t=>!!e[t])),allowAttributes:Array.from(i.allowAttributes)};return t}(e);}_checkContextMatch(e,t){const i=e.last;let n=this._evaluateChildChecks(e,t);if(n=void 0!==n?n:t.allowIn.includes(i.name),!n)return !1;const s=this.getDefinition(i),o=e.trimLast();return !!s&&(0==o.length||this._checkContextMatch(o,s))}_evaluateChildChecks(e,t){const i=this._customChildChecks.get(this._genericCheckSymbol)||[],n=this._customChildChecks.get(t.name)||[];for(const s of [...i,...n]){const i=s(e,t);if(void 0!==i)return i}}_evaluateAttributeChecks(e,t){const i=this._customAttributeChecks.get(this._genericCheckSymbol)||[],n=this._customAttributeChecks.get(t)||[];for(const s of [...i,...n]){const i=s(e,t);if(void 0!==i)return i}}*_getValidRangesForRange(e,t){let i=e.start,n=e.start;for(const s of e.getItems({shallow:!0}))s.is("element")&&(yield*this._getValidRangesForRange(dd._createIn(s),t)),this.checkAttribute(s,t)||(i.isEqual(n)||(yield new dd(i,n)),i=sd._createAfter(s)),n=sd._createAfter(s);i.isEqual(n)||(yield new dd(i,n));}findOptimalInsertionRange(e,t){const i=e.getSelectedElement();if(i&&this.isObject(i)&&!this.isInline(i))return "before"==t||"after"==t?new dd(sd._createAt(i,t)):dd._createOn(i);const n=Ia(e.getSelectedBlocks());if(!n)return new dd(e.focus);if(n.isEmpty)return new dd(sd._createAt(n,0));const s=sd._createAfter(n);return e.focus.isTouching(s)?new dd(s):new dd(sd._createBefore(n))}}class mh{_items;constructor(e){if(e instanceof mh)return e;let t;t="string"==typeof e?[e]:Array.isArray(e)?e:e.getAncestors({includeSelf:!0}),this._items=t.map(Ah);}get length(){return this._items.length}get last(){return this._items[this._items.length-1]}[Symbol.iterator](){return this._items[Symbol.iterator]()}push(e){const t=new mh([e]);return t._items=[...this._items,...t._items],t}trimLast(){const e=new mh([]);return e._items=this._items.slice(0,-1),e}getItem(e){return this._items[e]}*getNames(){yield*this._items.map((e=>e.name));}endsWith(e){return Array.from(this.getNames()).join(" ").endsWith(e)}startsWith(e){return Array.from(this.getNames()).join(" ").startsWith(e)}}function gh(e,t){const i={name:t,allowIn:new Set,allowChildren:new Set,disallowIn:new Set,disallowChildren:new Set,allowContentOf:new Set,allowWhere:new Set,allowAttributes:new Set,disallowAttributes:new Set,allowAttributesOf:new Set,inheritTypesFrom:new Set};return function(e,t){for(const i of e){const e=Object.keys(i).filter((e=>e.startsWith("is")));for(const n of e)t[n]=!!i[n];}}(e,i),xh(e,i,"allowIn"),xh(e,i,"allowChildren"),xh(e,i,"disallowIn"),xh(e,i,"disallowChildren"),xh(e,i,"allowContentOf"),xh(e,i,"allowWhere"),xh(e,i,"allowAttributes"),xh(e,i,"disallowAttributes"),xh(e,i,"allowAttributesOf"),xh(e,i,"inheritTypesFrom"),function(e,t){for(const i of e){const e=i.inheritAllFrom;e&&(t.allowContentOf.add(e),t.allowWhere.add(e),t.allowAttributesOf.add(e),t.inheritTypesFrom.add(e));}}(e,i),i}function fh(e,t){for(const i of t.allowIn){const n=e[i];n?n.allowChildren.add(t.name):t.allowIn.delete(i);}}function ph(e,t){for(const i of t.allowChildren){const n=e[i];n?n.allowIn.add(t.name):t.allowChildren.delete(i);}}function bh(e,t){for(const i of t.disallowIn){const n=e[i];n?n.disallowChildren.add(t.name):t.disallowIn.delete(i);}}function wh(e,t){for(const i of t.disallowChildren){const n=e[i];n?n.disallowIn.add(t.name):t.disallowChildren.delete(i);}}function _h(e,t){for(const e of t.disallowChildren)t.allowChildren.delete(e);for(const e of t.disallowIn)t.allowIn.delete(e);for(const e of t.disallowAttributes)t.allowAttributes.delete(e);}function vh(e,t){for(const i of t.allowContentOf){const n=e[i];n&&(n.disallowChildren.forEach((i=>{t.allowChildren.has(i)||(t.disallowChildren.add(i),e[i].disallowIn.add(t.name));})),n.allowChildren.forEach((i=>{t.disallowChildren.has(i)||(t.allowChildren.add(i),e[i].allowIn.add(t.name));})));}}function yh(e,t){for(const i of t.allowWhere){const n=e[i];n&&(n.disallowIn.forEach((i=>{t.allowIn.has(i)||(t.disallowIn.add(i),e[i].disallowChildren.add(t.name));})),n.allowIn.forEach((i=>{t.disallowIn.has(i)||(t.allowIn.add(i),e[i].allowChildren.add(t.name));})));}}function kh(e,t){for(const i of t.allowAttributesOf){const n=e[i];if(!n)return;n.allowAttributes.forEach((e=>{t.disallowAttributes.has(e)||t.allowAttributes.add(e);}));}}function Ch(e,t){for(const i of t.inheritTypesFrom){const n=e[i];if(n){const e=Object.keys(n).filter((e=>e.startsWith("is")));for(const i of e)i in t||(t[i]=n[i]);}}}function xh(e,t,i){for(const n of e){let e=n[i];"string"==typeof e&&(e=[e]),Array.isArray(e)&&e.forEach((e=>t[i].add(e)));}}function Ah(e){return "string"==typeof e||e.is("documentFragment")?{name:"string"==typeof e?e:"$documentFragment",*getAttributeKeys(){},getAttribute(){}}:{name:e.is("element")?e.name:"$text",*getAttributeKeys(){yield*e.getAttributeKeys();},getAttribute:t=>e.getAttribute(t)}}function Eh(e,t,i){for(const n of t.getAttributeKeys())e.checkAttribute(t,n)||i.removeAttribute(n,t);}class Th extends(F()){conversionApi;_splitParts=new Map;_cursorParents=new Map;_modelCursor=null;_emptyElementsToKeep=new Set;constructor(e){super(),this.conversionApi={...e,consumable:null,writer:null,store:null,convertItem:(e,t)=>this._convertItem(e,t),convertChildren:(e,t)=>this._convertChildren(e,t),safeInsert:(e,t)=>this._safeInsert(e,t),updateConversionResult:(e,t)=>this._updateConversionResult(e,t),splitToAllowedParent:(e,t)=>this._splitToAllowedParent(e,t),getSplitParts:e=>this._getSplitParts(e),keepEmptyElement:e=>this._keepEmptyElement(e)};}convert(e,t,i=["$root"]){this.fire("viewCleanup",e),this._modelCursor=function(e,t){let i;for(const n of new mh(e)){const e={};for(const t of n.getAttributeKeys())e[t]=n.getAttribute(t);const s=t.createElement(n.name,e);i&&t.insert(s,i),i=sd._createAt(s,0);}return i}(i,t),this.conversionApi.writer=t,this.conversionApi.consumable=ch.createFrom(e),this.conversionApi.store={};const{modelRange:n}=this._convertItem(e,this._modelCursor),s=t.createDocumentFragment();if(n){this._removeEmptyElements();for(const e of Array.from(this._modelCursor.parent.getChildren()))t.append(e,s);s.markers=function(e,t){const i=new Set,n=new Map,s=dd._createIn(e).getItems();for(const e of s)e.is("element","$marker")&&i.add(e);for(const e of i){const i=e.getAttribute("data-name"),s=t.createPositionBefore(e);n.has(i)?n.get(i).end=s.clone():n.set(i,new dd(s.clone())),t.remove(e);}return n}(s,t);}return this._modelCursor=null,this._splitParts.clear(),this._cursorParents.clear(),this._emptyElementsToKeep.clear(),this.conversionApi.writer=null,this.conversionApi.store=null,s}_convertItem(e,t){const i={viewItem:e,modelCursor:t,modelRange:null};if(e.is("element")?this.fire(`element:${e.name}`,i,this.conversionApi):e.is("$text")?this.fire("text",i,this.conversionApi):this.fire("documentFragment",i,this.conversionApi),i.modelRange&&!(i.modelRange instanceof dd))throw new E("view-conversion-dispatcher-incorrect-result",this);return {modelRange:i.modelRange,modelCursor:i.modelCursor}}_convertChildren(e,t){let i=t.is("position")?t:sd._createAt(t,0);const n=new dd(i);for(const t of Array.from(e.getChildren())){const e=this._convertItem(t,i);e.modelRange instanceof dd&&(n.end=e.modelRange.end,i=e.modelCursor);}return {modelRange:n,modelCursor:i}}_safeInsert(e,t){const i=this._splitToAllowedParent(e,t);return !!i&&(this.conversionApi.writer.insert(e,i.position),!0)}_updateConversionResult(e,t){const i=this._getSplitParts(e),n=this.conversionApi.writer;t.modelRange||(t.modelRange=n.createRange(n.createPositionBefore(e),n.createPositionAfter(i[i.length-1])));const s=this._cursorParents.get(e);t.modelCursor=s?n.createPositionAt(s,0):t.modelRange.end;}_splitToAllowedParent(e,t){const{schema:i,writer:n}=this.conversionApi;let s=i.findAllowedParent(t,e);if(s){if(s===t.parent)return {position:t};this._modelCursor.parent.getAncestors().includes(s)&&(s=null);}if(!s)return Zd(t,e,i)?{position:Jd(t,n)}:null;const o=this.conversionApi.writer.split(t,s),r=[];for(const e of o.range.getWalker())if("elementEnd"==e.type)r.push(e.item);else {const t=r.pop(),i=e.item;this._registerSplitPair(t,i);}const a=o.range.end.parent;return this._cursorParents.set(e,a),{position:o.position,cursorParent:a}}_registerSplitPair(e,t){this._splitParts.has(e)||this._splitParts.set(e,[e]);const i=this._splitParts.get(e);this._splitParts.set(t,i),i.push(t);}_getSplitParts(e){let t;return t=this._splitParts.has(e)?this._splitParts.get(e):[e],t}_keepEmptyElement(e){this._emptyElementsToKeep.add(e);}_removeEmptyElements(){let e=!1;for(const t of this._splitParts.keys())t.isEmpty&&!this._emptyElementsToKeep.has(t)&&(this.conversionApi.writer.remove(t),this._splitParts.delete(t),e=!0);e&&this._removeEmptyElements();}}class Sh{getHtml(e){const t=i.document.implementation.createHTMLDocument("").createElement("div");return t.appendChild(e),t.innerHTML}}class Ih{domParser;domConverter;htmlWriter;skipComments=!0;constructor(e){this.domParser=new DOMParser,this.domConverter=new Pc(e,{renderingMode:"data"}),this.htmlWriter=new Sh;}toData(e){const t=this.domConverter.viewToDom(e);return this.htmlWriter.getHtml(t)}toView(e){const t=this._toDom(e);return this.domConverter.domToView(t,{skipComments:this.skipComments})}registerRawContentMatcher(e){this.domConverter.registerRawContentMatcher(e);}useFillerType(e){this.domConverter.blockFillerMode="marked"==e?"markedNbsp":"nbsp";}_toDom(e){e.match(/<(?:html|body|head|meta)(?:\s[^>]*)?>/i)||(e=`<body>${e}</body>`);const t=this.domParser.parseFromString(e,"text/html"),i=t.createDocumentFragment(),n=t.body.childNodes;for(;n.length>0;)i.appendChild(n[0]);return i}}class Ph extends(F()){model;mapper;downcastDispatcher;upcastDispatcher;viewDocument;stylesProcessor;htmlProcessor;processor;_viewWriter;constructor(e,t){super(),this.model=e,this.mapper=new hd,this.downcastDispatcher=new gd({mapper:this.mapper,schema:e.schema}),this.downcastDispatcher.on("insert:$text",((e,t,i)=>{if(!i.consumable.consume(t.item,e.name))return;const n=i.writer,s=i.mapper.toViewPosition(t.range.start),o=n.createText(t.item.data);n.insert(s,o);}),{priority:"lowest"}),this.downcastDispatcher.on("insert",((e,t,i)=>{i.convertAttributes(t.item),t.reconversion||!t.item.is("element")||t.item.isEmpty||i.convertChildren(t.item);}),{priority:"lowest"}),this.upcastDispatcher=new Th({schema:e.schema}),this.viewDocument=new $l(t),this.stylesProcessor=t,this.htmlProcessor=new Ih(this.viewDocument),this.processor=this.htmlProcessor,this._viewWriter=new ec(this.viewDocument),this.upcastDispatcher.on("text",((e,t,{schema:i,consumable:n,writer:s})=>{let o=t.modelCursor;if(!n.test(t.viewItem))return;if(!i.checkChild(o,"$text")){if(!Zd(o,"$text",i))return;if(0==t.viewItem.data.trim().length)return;o=Jd(o,s);}n.consume(t.viewItem);const r=s.createText(t.viewItem.data);s.insert(r,o),t.modelRange=s.createRange(o,o.getShiftedBy(r.offsetSize)),t.modelCursor=t.modelRange.end;}),{priority:"lowest"}),this.upcastDispatcher.on("element",((e,t,i)=>{if(!t.modelRange&&i.consumable.consume(t.viewItem,{name:!0})){const{modelRange:e,modelCursor:n}=i.convertChildren(t.viewItem,t.modelCursor);t.modelRange=e,t.modelCursor=n;}}),{priority:"lowest"}),this.upcastDispatcher.on("documentFragment",((e,t,i)=>{if(!t.modelRange&&i.consumable.consume(t.viewItem,{name:!0})){const{modelRange:e,modelCursor:n}=i.convertChildren(t.viewItem,t.modelCursor);t.modelRange=e,t.modelCursor=n;}}),{priority:"lowest"}),ar().prototype.decorate.call(this,"init"),ar().prototype.decorate.call(this,"set"),ar().prototype.decorate.call(this,"get"),ar().prototype.decorate.call(this,"toView"),ar().prototype.decorate.call(this,"toModel"),this.on("init",(()=>{this.fire("ready");}),{priority:"lowest"}),this.on("ready",(()=>{this.model.enqueueChange({isUndoable:!1},Kd);}),{priority:"lowest"});}get(e={}){const{rootName:t="main",trim:i="empty"}=e;if(!this._checkIfRootsExists([t]))throw new E("datacontroller-get-non-existent-root",this);const n=this.model.document.getRoot(t);return n.isAttached()||T("datacontroller-get-detached-root",this),"empty"!==i||this.model.hasContent(n,{ignoreWhitespaces:!0})?this.stringify(n,e):""}stringify(e,t={}){const i=this.toView(e,t);return this.processor.toData(i)}toView(e,t={}){const i=this.viewDocument,n=this._viewWriter;this.mapper.clearBindings();const s=dd._createIn(e),o=new Xl(i);this.mapper.bindElements(e,o);const r=e.is("documentFragment")?e.markers:function(e){const t=[],i=e.root.document;if(!i)return new Map;const n=dd._createIn(e);for(const e of i.model.markers){const i=e.getRange(),s=i.isCollapsed,o=i.start.isEqual(n.start)||i.end.isEqual(n.end);if(s&&o)t.push([e.name,i]);else {const s=n.getIntersection(i);s&&t.push([e.name,s]);}}return t.sort((([e,t],[i,n])=>{if("after"!==t.end.compareWith(n.start))return 1;if("before"!==t.start.compareWith(n.end))return -1;switch(t.start.compareWith(n.start)){case"before":return 1;case"after":return -1;default:switch(t.end.compareWith(n.end)){case"before":return 1;case"after":return -1;default:return i.localeCompare(e)}}})),new Map(t)}(e);return this.downcastDispatcher.convert(s,r,n,t),o}init(e){if(this.model.document.version)throw new E("datacontroller-init-document-not-empty",this);let t={};if("string"==typeof e?t.main=e:t=e,!this._checkIfRootsExists(Object.keys(t)))throw new E("datacontroller-init-non-existent-root",this);return this.model.enqueueChange({isUndoable:!1},(e=>{for(const i of Object.keys(t)){const n=this.model.document.getRoot(i);e.insert(this.parse(t[i],n),n,0);}})),Promise.resolve()}set(e,t={}){let i={};if("string"==typeof e?i.main=e:i=e,!this._checkIfRootsExists(Object.keys(i)))throw new E("datacontroller-set-non-existent-root",this);this.model.enqueueChange(t.batchType||{},(e=>{e.setSelection(null),e.removeSelectionAttribute(this.model.document.selection.getAttributeKeys());for(const t of Object.keys(i)){const n=this.model.document.getRoot(t);e.remove(e.createRangeIn(n)),e.insert(this.parse(i[t],n),n,0);}}));}parse(e,t="$root"){const i=this.processor.toView(e);return this.toModel(i,t)}toModel(e,t="$root"){return this.model.change((i=>this.upcastDispatcher.convert(e,i,t)))}addStyleProcessorRules(e){e(this.stylesProcessor);}registerRawContentMatcher(e){this.processor&&this.processor!==this.htmlProcessor&&this.processor.registerRawContentMatcher(e),this.htmlProcessor.registerRawContentMatcher(e);}destroy(){this.stopListening();}_checkIfRootsExists(e){for(const t of e)if(!this.model.document.getRoot(t))return !1;return !0}}class Vh{_helpers=new Map;_downcast;_upcast;constructor(e,t){this._downcast=Aa(e),this._createConversionHelpers({name:"downcast",dispatchers:this._downcast,isDowncast:!0}),this._upcast=Aa(t),this._createConversionHelpers({name:"upcast",dispatchers:this._upcast,isDowncast:!1});}addAlias(e,t){const i=this._downcast.includes(t);if(!this._upcast.includes(t)&&!i)throw new E("conversion-add-alias-dispatcher-not-registered",this);this._createConversionHelpers({name:e,dispatchers:[t],isDowncast:i});}for(e){if(!this._helpers.has(e))throw new E("conversion-for-unknown-group",this);return this._helpers.get(e)}elementToElement(e){this.for("downcast").elementToElement(e);for(const{model:t,view:i}of Rh(e))this.for("upcast").elementToElement({model:t,view:i,converterPriority:e.converterPriority});}attributeToElement(e){this.for("downcast").attributeToElement(e);for(const{model:t,view:i}of Rh(e))this.for("upcast").elementToAttribute({view:i,model:t,converterPriority:e.converterPriority});}attributeToAttribute(e){this.for("downcast").attributeToAttribute(e);for(const{model:t,view:i}of Rh(e))this.for("upcast").attributeToAttribute({view:i,model:t});}_createConversionHelpers({name:e,dispatchers:t,isDowncast:i}){if(this._helpers.has(e))throw new E("conversion-group-exists",this);const n=i?new Rd(t):new Qd(t);this._helpers.set(e,n);}}function*Rh(e){if(e.model.values)for(const t of e.model.values){const i={key:e.model.key,value:t},n=e.view[t],s=e.upcastAlso?e.upcastAlso[t]:void 0;yield*Bh(i,n,s);}else yield*Bh(e.model,e.view,e.upcastAlso);}function*Bh(e,t,i){if(yield {model:e,view:t},i)for(const t of Aa(i))yield {model:e,view:t};}class Mh{baseVersion;isDocumentOperation;batch;constructor(e){this.baseVersion=e,this.isDocumentOperation=null!==this.baseVersion,this.batch=null;}_validate(){}toJSON(){const e=Object.assign({},this);return e.__className=this.constructor.className,delete e.batch,delete e.isDocumentOperation,e}static get className(){return "Operation"}static fromJSON(e,t){return new this(e.baseVersion)}}function Lh(e,t){const i=Dh(t),n=i.reduce(((e,t)=>e+t.offsetSize),0),s=e.parent;Hh(e);const o=e.index;return s._insertChild(o,i),zh(s,o+i.length),zh(s,o),new dd(e,e.getShiftedBy(n))}function Fh(e){if(!e.isFlat)throw new E("operation-utils-remove-range-not-flat",this);const t=e.start.parent;Hh(e.start),Hh(e.end);const i=t._removeChildren(e.start.index,e.end.index-e.start.index);return zh(t,e.start.index),i}function Nh(e,t){if(!e.isFlat)throw new E("operation-utils-move-range-not-flat",this);const i=Fh(e);return Lh(t=t._getTransformedByDeletion(e.start,e.end.offset-e.start.offset),i)}function Dh(e){const t=[];!function e(i){if("string"==typeof i)t.push(new Xc(i));else if(i instanceof ed)t.push(new Xc(i.data,i.getAttributes()));else if(i instanceof Qc)t.push(i);else if(br(i))for(const t of i)e(t);}(e);for(let e=1;e<t.length;e++){const i=t[e],n=t[e-1];i instanceof Xc&&n instanceof Xc&&$h(i,n)&&(t.splice(e-1,2,new Xc(n.data+i.data,n.getAttributes())),e--);}return t}function zh(e,t){const i=e.getChild(t-1),n=e.getChild(t);if(i&&n&&i.is("$text")&&n.is("$text")&&$h(i,n)){const s=new Xc(i.data+n.data,i.getAttributes());e._removeChildren(t-1,2),e._insertChild(t-1,s);}}function Hh(e){const t=e.textNode,i=e.parent;if(t){const n=e.offset-t.startOffset,s=t.index;i._removeChildren(s,1);const o=new Xc(t.data.substr(0,n),t.getAttributes()),r=new Xc(t.data.substr(n),t.getAttributes());i._insertChild(s,[o,r]);}}function $h(e,t){const i=e.getAttributes(),n=t.getAttributes();for(const e of i){if(e[1]!==t.getAttribute(e[0]))return !1;n.next();}return n.next().done}class Uh extends Mh{sourcePosition;howMany;targetPosition;constructor(e,t,i,n){super(n),this.sourcePosition=e.clone(),this.sourcePosition.stickiness="toNext",this.howMany=t,this.targetPosition=i.clone(),this.targetPosition.stickiness="toNone";}get type(){return "$graveyard"==this.targetPosition.root.rootName?"remove":"$graveyard"==this.sourcePosition.root.rootName?"reinsert":"move"}get affectedSelectable(){return [dd._createFromPositionAndShift(this.sourcePosition,this.howMany),dd._createFromPositionAndShift(this.targetPosition,0)]}clone(){return new Uh(this.sourcePosition,this.howMany,this.targetPosition,this.baseVersion)}getMovedRangeStart(){return this.targetPosition._getTransformedByDeletion(this.sourcePosition,this.howMany)}getReversed(){const e=this.sourcePosition._getTransformedByInsertion(this.targetPosition,this.howMany);return new Uh(this.getMovedRangeStart(),this.howMany,e,this.baseVersion+1)}_validate(){const e=this.sourcePosition.parent,t=this.targetPosition.parent,i=this.sourcePosition.offset,n=this.targetPosition.offset;if(i+this.howMany>e.maxOffset)throw new E("move-operation-nodes-do-not-exist",this);if(e===t&&i<n&&n<i+this.howMany)throw new E("move-operation-range-into-itself",this);if(this.sourcePosition.root==this.targetPosition.root&&"prefix"==pr(this.sourcePosition.getParentPath(),this.targetPosition.getParentPath())){const e=this.sourcePosition.path.length-1;if(this.targetPosition.path[e]>=i&&this.targetPosition.path[e]<i+this.howMany)throw new E("move-operation-node-into-itself",this)}}_execute(){Nh(dd._createFromPositionAndShift(this.sourcePosition,this.howMany),this.targetPosition);}toJSON(){const e=super.toJSON();return e.sourcePosition=this.sourcePosition.toJSON(),e.targetPosition=this.targetPosition.toJSON(),e}static get className(){return "MoveOperation"}static fromJSON(e,t){const i=sd.fromJSON(e.sourcePosition,t),n=sd.fromJSON(e.targetPosition,t);return new this(i,e.howMany,n,e.baseVersion)}}class Wh extends Mh{position;nodes;shouldReceiveAttributes;constructor(e,t,i){super(i),this.position=e.clone(),this.position.stickiness="toNone",this.nodes=new Yc(Dh(t)),this.shouldReceiveAttributes=!1;}get type(){return "insert"}get howMany(){return this.nodes.maxOffset}get affectedSelectable(){return this.position.clone()}clone(){const e=new Yc([...this.nodes].map((e=>e._clone(!0)))),t=new Wh(this.position,e,this.baseVersion);return t.shouldReceiveAttributes=this.shouldReceiveAttributes,t}getReversed(){const e=this.position.root.document.graveyard,t=new sd(e,[0]);return new Uh(this.position,this.nodes.maxOffset,t,this.baseVersion+1)}_validate(){const e=this.position.parent;if(!e||e.maxOffset<this.position.offset)throw new E("insert-operation-position-invalid",this)}_execute(){const e=this.nodes;this.nodes=new Yc([...e].map((e=>e._clone(!0)))),Lh(this.position,e);}toJSON(){const e=super.toJSON();return e.position=this.position.toJSON(),e.nodes=this.nodes.toJSON(),e}static get className(){return "InsertOperation"}static fromJSON(e,t){const i=[];for(const t of e.nodes)t.name?i.push(td.fromJSON(t)):i.push(Xc.fromJSON(t));const n=new Wh(sd.fromJSON(e.position,t),i,e.baseVersion);return n.shouldReceiveAttributes=e.shouldReceiveAttributes,n}}class jh extends Mh{splitPosition;howMany;insertionPosition;graveyardPosition;constructor(e,t,i,n,s){super(s),this.splitPosition=e.clone(),this.splitPosition.stickiness="toNext",this.howMany=t,this.insertionPosition=i,this.graveyardPosition=n?n.clone():null,this.graveyardPosition&&(this.graveyardPosition.stickiness="toNext");}get type(){return "split"}get moveTargetPosition(){const e=this.insertionPosition.path.slice();return e.push(0),new sd(this.insertionPosition.root,e)}get movedRange(){const e=this.splitPosition.getShiftedBy(Number.POSITIVE_INFINITY);return new dd(this.splitPosition,e)}get affectedSelectable(){const e=[dd._createFromPositionAndShift(this.splitPosition,0),dd._createFromPositionAndShift(this.insertionPosition,0)];return this.graveyardPosition&&e.push(dd._createFromPositionAndShift(this.graveyardPosition,0)),e}clone(){return new jh(this.splitPosition,this.howMany,this.insertionPosition,this.graveyardPosition,this.baseVersion)}getReversed(){const e=this.splitPosition.root.document.graveyard,t=new sd(e,[0]);return new qh(this.moveTargetPosition,this.howMany,this.splitPosition,t,this.baseVersion+1)}_validate(){const e=this.splitPosition.parent,t=this.splitPosition.offset;if(!e||e.maxOffset<t)throw new E("split-operation-position-invalid",this);if(!e.parent)throw new E("split-operation-split-in-root",this);if(this.howMany!=e.maxOffset-this.splitPosition.offset)throw new E("split-operation-how-many-invalid",this);if(this.graveyardPosition&&!this.graveyardPosition.nodeAfter)throw new E("split-operation-graveyard-position-invalid",this)}_execute(){const e=this.splitPosition.parent;if(this.graveyardPosition)Nh(dd._createFromPositionAndShift(this.graveyardPosition,1),this.insertionPosition);else {const t=e._clone();Lh(this.insertionPosition,t);}Nh(new dd(sd._createAt(e,this.splitPosition.offset),sd._createAt(e,e.maxOffset)),this.moveTargetPosition);}toJSON(){const e=super.toJSON();return e.splitPosition=this.splitPosition.toJSON(),e.insertionPosition=this.insertionPosition.toJSON(),this.graveyardPosition&&(e.graveyardPosition=this.graveyardPosition.toJSON()),e}static get className(){return "SplitOperation"}static getInsertionPosition(e){const t=e.path.slice(0,-1);return t[t.length-1]++,new sd(e.root,t,"toPrevious")}static fromJSON(e,t){const i=sd.fromJSON(e.splitPosition,t),n=sd.fromJSON(e.insertionPosition,t),s=e.graveyardPosition?sd.fromJSON(e.graveyardPosition,t):null;return new this(i,e.howMany,n,s,e.baseVersion)}}class qh extends Mh{sourcePosition;howMany;targetPosition;graveyardPosition;constructor(e,t,i,n,s){super(s),this.sourcePosition=e.clone(),this.sourcePosition.stickiness="toPrevious",this.howMany=t,this.targetPosition=i.clone(),this.targetPosition.stickiness="toNext",this.graveyardPosition=n.clone();}get type(){return "merge"}get deletionPosition(){return new sd(this.sourcePosition.root,this.sourcePosition.path.slice(0,-1))}get movedRange(){const e=this.sourcePosition.getShiftedBy(Number.POSITIVE_INFINITY);return new dd(this.sourcePosition,e)}get affectedSelectable(){const e=this.sourcePosition.parent;return [dd._createOn(e),dd._createFromPositionAndShift(this.targetPosition,0),dd._createFromPositionAndShift(this.graveyardPosition,0)]}clone(){return new qh(this.sourcePosition,this.howMany,this.targetPosition,this.graveyardPosition,this.baseVersion)}getReversed(){const e=this.targetPosition._getTransformedByMergeOperation(this),t=this.sourcePosition.path.slice(0,-1),i=new sd(this.sourcePosition.root,t)._getTransformedByMergeOperation(this);return new jh(e,this.howMany,i,this.graveyardPosition,this.baseVersion+1)}_validate(){const e=this.sourcePosition.parent,t=this.targetPosition.parent;if(!e.parent)throw new E("merge-operation-source-position-invalid",this);if(!t.parent)throw new E("merge-operation-target-position-invalid",this);if(this.howMany!=e.maxOffset)throw new E("merge-operation-how-many-invalid",this)}_execute(){const e=this.sourcePosition.parent;Nh(dd._createIn(e),this.targetPosition),Nh(dd._createOn(e),this.graveyardPosition);}toJSON(){const e=super.toJSON();return e.sourcePosition=e.sourcePosition.toJSON(),e.targetPosition=e.targetPosition.toJSON(),e.graveyardPosition=e.graveyardPosition.toJSON(),e}static get className(){return "MergeOperation"}static fromJSON(e,t){const i=sd.fromJSON(e.sourcePosition,t),n=sd.fromJSON(e.targetPosition,t),s=sd.fromJSON(e.graveyardPosition,t);return new this(i,e.howMany,n,s,e.baseVersion)}}class Gh extends Mh{name;oldRange;newRange;affectsData;_markers;constructor(e,t,i,n,s,o){super(o),this.name=e,this.oldRange=t?t.clone():null,this.newRange=i?i.clone():null,this.affectsData=s,this._markers=n;}get type(){return "marker"}get affectedSelectable(){const e=[];return this.oldRange&&e.push(this.oldRange.clone()),this.newRange&&(this.oldRange?e.push(...this.newRange.getDifference(this.oldRange)):e.push(this.newRange.clone())),e}clone(){return new Gh(this.name,this.oldRange,this.newRange,this._markers,this.affectsData,this.baseVersion)}getReversed(){return new Gh(this.name,this.newRange,this.oldRange,this._markers,this.affectsData,this.baseVersion+1)}_execute(){this.newRange?this._markers._set(this.name,this.newRange,!0,this.affectsData):this._markers._remove(this.name);}toJSON(){const e=super.toJSON();return this.oldRange&&(e.oldRange=this.oldRange.toJSON()),this.newRange&&(e.newRange=this.newRange.toJSON()),delete e._markers,e}static get className(){return "MarkerOperation"}static fromJSON(e,t){return new Gh(e.name,e.oldRange?dd.fromJSON(e.oldRange,t):null,e.newRange?dd.fromJSON(e.newRange,t):null,t.model.markers,e.affectsData,e.baseVersion)}}class Kh extends Mh{range;key;oldValue;newValue;constructor(e,t,i,n,s){super(s),this.range=e.clone(),this.key=t,this.oldValue=void 0===i?null:i,this.newValue=void 0===n?null:n;}get type(){return null===this.oldValue?"addAttribute":null===this.newValue?"removeAttribute":"changeAttribute"}get affectedSelectable(){return this.range.clone()}clone(){return new Kh(this.range,this.key,this.oldValue,this.newValue,this.baseVersion)}getReversed(){return new Kh(this.range,this.key,this.newValue,this.oldValue,this.baseVersion+1)}toJSON(){const e=super.toJSON();return e.range=this.range.toJSON(),e}_validate(){if(!this.range.isFlat)throw new E("attribute-operation-range-not-flat",this);for(const e of this.range.getItems({shallow:!0})){if(null!==this.oldValue&&!Ko(e.getAttribute(this.key),this.oldValue))throw new E("attribute-operation-wrong-old-value",this,{item:e,key:this.key,value:this.oldValue});if(null===this.oldValue&&null!==this.newValue&&e.hasAttribute(this.key))throw new E("attribute-operation-attribute-exists",this,{node:e,key:this.key})}}_execute(){Ko(this.oldValue,this.newValue)||function(e,t,i){Hh(e.start),Hh(e.end);for(const n of e.getItems({shallow:!0})){const e=n.is("$textProxy")?n.textNode:n;null!==i?e._setAttribute(t,i):e._removeAttribute(t),zh(e.parent,e.index);}zh(e.end.parent,e.end.index);}(this.range,this.key,this.newValue);}static get className(){return "AttributeOperation"}static fromJSON(e,t){return new Kh(dd.fromJSON(e.range,t),e.key,e.oldValue,e.newValue,e.baseVersion)}}class Zh extends Mh{get type(){return "noop"}get affectedSelectable(){return null}clone(){return new Zh(this.baseVersion)}getReversed(){return new Zh(this.baseVersion+1)}_execute(){}static get className(){return "NoOperation"}}class Jh extends Mh{position;oldName;newName;constructor(e,t,i,n){super(n),this.position=e,this.position.stickiness="toNext",this.oldName=t,this.newName=i;}get type(){return "rename"}get affectedSelectable(){return this.position.nodeAfter}clone(){return new Jh(this.position.clone(),this.oldName,this.newName,this.baseVersion)}getReversed(){return new Jh(this.position.clone(),this.newName,this.oldName,this.baseVersion+1)}_validate(){const e=this.position.nodeAfter;if(!(e instanceof td))throw new E("rename-operation-wrong-position",this);if(e.name!==this.oldName)throw new E("rename-operation-wrong-name",this)}_execute(){this.position.nodeAfter.name=this.newName;}toJSON(){const e=super.toJSON();return e.position=this.position.toJSON(),e}static get className(){return "RenameOperation"}static fromJSON(e,t){return new Jh(sd.fromJSON(e.position,t),e.oldName,e.newName,e.baseVersion)}}class Qh extends Mh{root;key;oldValue;newValue;constructor(e,t,i,n,s){super(s),this.root=e,this.key=t,this.oldValue=void 0===i?null:i,this.newValue=void 0===n?null:n;}get type(){return null===this.oldValue?"addRootAttribute":null===this.newValue?"removeRootAttribute":"changeRootAttribute"}get affectedSelectable(){return this.root}clone(){return new Qh(this.root,this.key,this.oldValue,this.newValue,this.baseVersion)}getReversed(){return new Qh(this.root,this.key,this.newValue,this.oldValue,this.baseVersion+1)}_validate(){if(this.root!=this.root.root||this.root.is("documentFragment"))throw new E("rootattribute-operation-not-a-root",this,{root:this.root,key:this.key});if(null!==this.oldValue&&this.root.getAttribute(this.key)!==this.oldValue)throw new E("rootattribute-operation-wrong-old-value",this,{root:this.root,key:this.key});if(null===this.oldValue&&null!==this.newValue&&this.root.hasAttribute(this.key))throw new E("rootattribute-operation-attribute-exists",this,{root:this.root,key:this.key})}_execute(){null!==this.newValue?this.root._setAttribute(this.key,this.newValue):this.root._removeAttribute(this.key);}toJSON(){const e=super.toJSON();return e.root=this.root.toJSON(),e}static get className(){return "RootAttributeOperation"}static fromJSON(e,t){if(!t.getRoot(e.root))throw new E("rootattribute-operation-fromjson-no-root",this,{rootName:e.root});return new Qh(t.getRoot(e.root),e.key,e.oldValue,e.newValue,e.baseVersion)}}class Yh extends Mh{rootName;elementName;isAdd;_document;constructor(e,t,i,n,s){if(super(s),this.rootName=e,this.elementName=t,this.isAdd=i,this._document=n,!this._document.getRoot(this.rootName)){this._document.createRoot(this.elementName,this.rootName)._isAttached=!1;}}get type(){return this.isAdd?"addRoot":"detachRoot"}get affectedSelectable(){return this._document.getRoot(this.rootName)}clone(){return new Yh(this.rootName,this.elementName,this.isAdd,this._document,this.baseVersion)}getReversed(){return new Yh(this.rootName,this.elementName,!this.isAdd,this._document,this.baseVersion+1)}_execute(){this._document.getRoot(this.rootName)._isAttached=this.isAdd;}toJSON(){const e=super.toJSON();return delete e._document,e}static get className(){return "RootOperation"}static fromJSON(e,t){return new Yh(e.rootName,e.elementName,e.isAdd,t,e.baseVersion)}}const Xh={};Xh[Kh.className]=Kh,Xh[Wh.className]=Wh,Xh[Gh.className]=Gh,Xh[Uh.className]=Uh,Xh[Zh.className]=Zh,Xh[Mh.className]=Mh,Xh[Jh.className]=Jh,Xh[Qh.className]=Qh,Xh[Yh.className]=Yh,Xh[jh.className]=jh,Xh[qh.className]=qh;class eu{static fromJSON(e,t){return Xh[e.__className].fromJSON(e,t)}}const tu=new Map;function iu(e,t,i){let n=tu.get(e);n||(n=new Map,tu.set(e,n)),n.set(t,i);}function nu(e){return [e]}function su(e,t,i={}){const n=function(e,t){const i=tu.get(e);return i&&i.has(t)?i.get(t):nu}(e.constructor,t.constructor);try{return n(e=e.clone(),t,i)}catch(e){throw e}}function ou(e,t,i){e=e.slice(),t=t.slice();const n=new ru(i.document,i.useRelations,i.forceWeakRemove);n.setOriginalOperations(e),n.setOriginalOperations(t);const s=n.originalOperations;if(0==e.length||0==t.length)return {operationsA:e,operationsB:t,originalOperations:s};const o=new WeakMap;for(const t of e)o.set(t,0);const r={nextBaseVersionA:e[e.length-1].baseVersion+1,nextBaseVersionB:t[t.length-1].baseVersion+1,originalOperationsACount:e.length,originalOperationsBCount:t.length};let a=0;for(;a<e.length;){const i=e[a],s=o.get(i);if(s==t.length){a++;continue}const r=t[s],l=su(i,r,n.getContext(i,r,!0)),c=su(r,i,n.getContext(r,i,!1));n.updateRelation(i,r),n.setOriginalOperations(l,i),n.setOriginalOperations(c,r);for(const e of l)o.set(e,s+c.length);e.splice(a,1,...l),t.splice(s,1,...c);}return au(e,r.nextBaseVersionB),au(t,r.nextBaseVersionA),{operationsA:e,operationsB:t,originalOperations:s}}class ru{originalOperations;_history;_useRelations;_forceWeakRemove;_relations;constructor(e,t,i=!1){this.originalOperations=new Map,this._history=e.history,this._useRelations=t,this._forceWeakRemove=!!i,this._relations=new Map;}setOriginalOperations(e,t=null){const i=t?this.originalOperations.get(t):null;for(const t of e)this.originalOperations.set(t,i||t);}updateRelation(e,t){if(e instanceof Uh)t instanceof qh?e.targetPosition.isEqual(t.sourcePosition)||t.movedRange.containsPosition(e.targetPosition)?this._setRelation(e,t,"insertAtSource"):e.targetPosition.isEqual(t.deletionPosition)?this._setRelation(e,t,"insertBetween"):e.targetPosition.isAfter(t.sourcePosition)&&this._setRelation(e,t,"moveTargetAfter"):t instanceof Uh&&(e.targetPosition.isEqual(t.sourcePosition)||e.targetPosition.isBefore(t.sourcePosition)?this._setRelation(e,t,"insertBefore"):this._setRelation(e,t,"insertAfter"));else if(e instanceof jh){if(t instanceof qh)e.splitPosition.isBefore(t.sourcePosition)&&this._setRelation(e,t,"splitBefore");else if(t instanceof Uh)if(e.splitPosition.isEqual(t.sourcePosition)||e.splitPosition.isBefore(t.sourcePosition))this._setRelation(e,t,"splitBefore");else {const i=dd._createFromPositionAndShift(t.sourcePosition,t.howMany);if(e.splitPosition.hasSameParentAs(t.sourcePosition)&&i.containsPosition(e.splitPosition)){const n=i.end.offset-e.splitPosition.offset,s=e.splitPosition.offset-i.start.offset;this._setRelation(e,t,{howMany:n,offset:s});}}}else if(e instanceof qh)t instanceof qh?(e.targetPosition.isEqual(t.sourcePosition)||this._setRelation(e,t,"mergeTargetNotMoved"),e.sourcePosition.isEqual(t.targetPosition)&&this._setRelation(e,t,"mergeSourceNotMoved"),e.sourcePosition.isEqual(t.sourcePosition)&&this._setRelation(e,t,"mergeSameElement")):t instanceof jh?e.sourcePosition.isEqual(t.splitPosition)&&this._setRelation(e,t,"splitAtSource"):t instanceof Uh&&t.howMany>0&&(e.sourcePosition.isEqual(t.sourcePosition.getShiftedBy(t.howMany))&&this._setRelation(e,t,"mergeSourceAffected"),e.targetPosition.isEqual(t.sourcePosition)&&this._setRelation(e,t,"mergeTargetWasBefore"));else if(e instanceof Gh){const i=e.newRange;if(!i)return;if(t instanceof Uh){const n=dd._createFromPositionAndShift(t.sourcePosition,t.howMany),s=n.containsPosition(i.start)||n.start.isEqual(i.start),o=n.containsPosition(i.end)||n.end.isEqual(i.end);!s&&!o||n.containsRange(i)||this._setRelation(e,t,{side:s?"left":"right",path:s?i.start.path.slice():i.end.path.slice()});}else if(t instanceof qh){const n=i.start.isEqual(t.targetPosition),s=i.start.isEqual(t.deletionPosition),o=i.end.isEqual(t.deletionPosition),r=i.end.isEqual(t.sourcePosition);(n||s||o||r)&&this._setRelation(e,t,{wasInLeftElement:n,wasStartBeforeMergedElement:s,wasEndBeforeMergedElement:o,wasInRightElement:r});}}}getContext(e,t,i){return {aIsStrong:i,aWasUndone:this._wasUndone(e),bWasUndone:this._wasUndone(t),abRelation:this._useRelations?this._getRelation(e,t):null,baRelation:this._useRelations?this._getRelation(t,e):null,forceWeakRemove:this._forceWeakRemove}}_wasUndone(e){const t=this.originalOperations.get(e);return t.wasUndone||this._history.isUndoneOperation(t)}_getRelation(e,t){const i=this.originalOperations.get(t),n=this._history.getUndoneOperation(i);if(!n)return null;const s=this.originalOperations.get(e),o=this._relations.get(s);return o&&o.get(n)||null}_setRelation(e,t,i){const n=this.originalOperations.get(e),s=this.originalOperations.get(t);let o=this._relations.get(n);o||(o=new Map,this._relations.set(n,o)),o.set(s,i);}}function au(e,t){for(const i of e)i.baseVersion=t++;}function cu(e,t,i){const n=e.nodes.getNode(0).getAttribute(t);if(n==i)return null;const s=new dd(e.position,e.position.getShiftedBy(e.howMany));return new Kh(s,t,n,i,0)}function du(e,t){return null===e.targetPosition._getTransformedByDeletion(t.sourcePosition,t.howMany)}function hu(e,t){const i=[];for(let n=0;n<e.length;n++){const s=e[n],o=new Uh(s.start,s.end.offset-s.start.offset,t,0);i.push(o);for(let t=n+1;t<e.length;t++)e[t]=e[t]._getTransformedByMove(o.sourcePosition,o.targetPosition,o.howMany)[0];t=t._getTransformedByMove(o.sourcePosition,o.targetPosition,o.howMany);}return i}iu(Kh,Kh,((e,t,i)=>{if(e.key===t.key&&e.range.start.hasSameParentAs(t.range.start)){const n=e.range.getDifference(t.range).map((t=>new Kh(t,e.key,e.oldValue,e.newValue,0))),s=e.range.getIntersection(t.range);return s&&i.aIsStrong&&n.push(new Kh(s,t.key,t.newValue,e.newValue,0)),0==n.length?[new Zh(0)]:n}return [e]})),iu(Kh,Wh,((e,t)=>{if(e.range.start.hasSameParentAs(t.position)&&e.range.containsPosition(t.position)){const i=e.range._getTransformedByInsertion(t.position,t.howMany,!t.shouldReceiveAttributes).map((t=>new Kh(t,e.key,e.oldValue,e.newValue,e.baseVersion)));if(t.shouldReceiveAttributes){const n=cu(t,e.key,e.oldValue);n&&i.unshift(n);}return i}return e.range=e.range._getTransformedByInsertion(t.position,t.howMany,!1)[0],[e]})),iu(Kh,qh,((e,t)=>{const i=[];e.range.start.hasSameParentAs(t.deletionPosition)&&(e.range.containsPosition(t.deletionPosition)||e.range.start.isEqual(t.deletionPosition))&&i.push(dd._createFromPositionAndShift(t.graveyardPosition,1));const n=e.range._getTransformedByMergeOperation(t);return n.isCollapsed||i.push(n),i.map((t=>new Kh(t,e.key,e.oldValue,e.newValue,e.baseVersion)))})),iu(Kh,Uh,((e,t)=>{const i=function(e,t){const i=dd._createFromPositionAndShift(t.sourcePosition,t.howMany);let n=null,s=[];i.containsRange(e,!0)?n=e:e.start.hasSameParentAs(i.start)?(s=e.getDifference(i),n=e.getIntersection(i)):s=[e];const o=[];for(let e of s){e=e._getTransformedByDeletion(t.sourcePosition,t.howMany);const i=t.getMovedRangeStart(),n=e.start.hasSameParentAs(i),s=e._getTransformedByInsertion(i,t.howMany,n);o.push(...s);}n&&o.push(n._getTransformedByMove(t.sourcePosition,t.targetPosition,t.howMany,!1)[0]);return o}(e.range,t);return i.map((t=>new Kh(t,e.key,e.oldValue,e.newValue,e.baseVersion)))})),iu(Kh,jh,((e,t)=>{if(e.range.end.isEqual(t.insertionPosition))return t.graveyardPosition||e.range.end.offset++,[e];if(e.range.start.hasSameParentAs(t.splitPosition)&&e.range.containsPosition(t.splitPosition)){const i=e.clone();return i.range=new dd(t.moveTargetPosition.clone(),e.range.end._getCombined(t.splitPosition,t.moveTargetPosition)),e.range.end=t.splitPosition.clone(),e.range.end.stickiness="toPrevious",[e,i]}return e.range=e.range._getTransformedBySplitOperation(t),[e]})),iu(Wh,Kh,((e,t)=>{const i=[e];if(e.shouldReceiveAttributes&&e.position.hasSameParentAs(t.range.start)&&t.range.containsPosition(e.position)){const n=cu(e,t.key,t.newValue);n&&i.push(n);}return i})),iu(Wh,Wh,((e,t,i)=>(e.position.isEqual(t.position)&&i.aIsStrong||(e.position=e.position._getTransformedByInsertOperation(t)),[e]))),iu(Wh,Uh,((e,t)=>(e.position=e.position._getTransformedByMoveOperation(t),[e]))),iu(Wh,jh,((e,t)=>(e.position=e.position._getTransformedBySplitOperation(t),[e]))),iu(Wh,qh,((e,t)=>(e.position=e.position._getTransformedByMergeOperation(t),[e]))),iu(Gh,Wh,((e,t)=>(e.oldRange&&(e.oldRange=e.oldRange._getTransformedByInsertOperation(t)[0]),e.newRange&&(e.newRange=e.newRange._getTransformedByInsertOperation(t)[0]),[e]))),iu(Gh,Gh,((e,t,i)=>{if(e.name==t.name){if(!i.aIsStrong)return [new Zh(0)];e.oldRange=t.newRange?t.newRange.clone():null;}return [e]})),iu(Gh,qh,((e,t)=>(e.oldRange&&(e.oldRange=e.oldRange._getTransformedByMergeOperation(t)),e.newRange&&(e.newRange=e.newRange._getTransformedByMergeOperation(t)),[e]))),iu(Gh,Uh,((e,t,i)=>{if(e.oldRange&&(e.oldRange=dd._createFromRanges(e.oldRange._getTransformedByMoveOperation(t))),e.newRange){if(i.abRelation){const n=dd._createFromRanges(e.newRange._getTransformedByMoveOperation(t));if("left"==i.abRelation.side&&t.targetPosition.isEqual(e.newRange.start))return e.newRange.end=n.end,e.newRange.start.path=i.abRelation.path,[e];if("right"==i.abRelation.side&&t.targetPosition.isEqual(e.newRange.end))return e.newRange.start=n.start,e.newRange.end.path=i.abRelation.path,[e]}e.newRange=dd._createFromRanges(e.newRange._getTransformedByMoveOperation(t));}return [e]})),iu(Gh,jh,((e,t,i)=>{if(e.oldRange&&(e.oldRange=e.oldRange._getTransformedBySplitOperation(t)),e.newRange){if(i.abRelation){const n=e.newRange._getTransformedBySplitOperation(t);return e.newRange.start.isEqual(t.splitPosition)&&i.abRelation.wasStartBeforeMergedElement?e.newRange.start=sd._createAt(t.insertionPosition):e.newRange.start.isEqual(t.splitPosition)&&!i.abRelation.wasInLeftElement&&(e.newRange.start=sd._createAt(t.moveTargetPosition)),e.newRange.end.isEqual(t.splitPosition)&&i.abRelation.wasInRightElement?e.newRange.end=sd._createAt(t.moveTargetPosition):e.newRange.end.isEqual(t.splitPosition)&&i.abRelation.wasEndBeforeMergedElement?e.newRange.end=sd._createAt(t.insertionPosition):e.newRange.end=n.end,[e]}e.newRange=e.newRange._getTransformedBySplitOperation(t);}return [e]})),iu(qh,Wh,((e,t)=>(e.sourcePosition.hasSameParentAs(t.position)&&(e.howMany+=t.howMany),e.sourcePosition=e.sourcePosition._getTransformedByInsertOperation(t),e.targetPosition=e.targetPosition._getTransformedByInsertOperation(t),[e]))),iu(qh,qh,((e,t,i)=>{if(e.sourcePosition.isEqual(t.sourcePosition)&&e.targetPosition.isEqual(t.targetPosition)){if(i.bWasUndone){const i=t.graveyardPosition.path.slice();return i.push(0),e.sourcePosition=new sd(t.graveyardPosition.root,i),e.howMany=0,[e]}return [new Zh(0)]}if(e.sourcePosition.isEqual(t.sourcePosition)&&!e.targetPosition.isEqual(t.targetPosition)&&!i.bWasUndone&&"splitAtSource"!=i.abRelation){const n="$graveyard"==e.targetPosition.root.rootName,s="$graveyard"==t.targetPosition.root.rootName;if(s&&!n||!(n&&!s)&&i.aIsStrong){const i=t.targetPosition._getTransformedByMergeOperation(t),n=e.targetPosition._getTransformedByMergeOperation(t);return [new Uh(i,e.howMany,n,0)]}return [new Zh(0)]}return e.sourcePosition.hasSameParentAs(t.targetPosition)&&(e.howMany+=t.howMany),e.sourcePosition=e.sourcePosition._getTransformedByMergeOperation(t),e.targetPosition=e.targetPosition._getTransformedByMergeOperation(t),e.graveyardPosition.isEqual(t.graveyardPosition)&&i.aIsStrong||(e.graveyardPosition=e.graveyardPosition._getTransformedByMergeOperation(t)),[e]})),iu(qh,Uh,((e,t,i)=>{const n=dd._createFromPositionAndShift(t.sourcePosition,t.howMany);return "remove"==t.type&&!i.bWasUndone&&!i.forceWeakRemove&&e.deletionPosition.hasSameParentAs(t.sourcePosition)&&n.containsPosition(e.sourcePosition)?[new Zh(0)]:(t.sourcePosition.getShiftedBy(t.howMany).isEqual(e.sourcePosition)?e.sourcePosition.stickiness="toNone":t.targetPosition.isEqual(e.sourcePosition)&&"mergeSourceAffected"==i.abRelation?e.sourcePosition.stickiness="toNext":t.sourcePosition.isEqual(e.targetPosition)?(e.targetPosition.stickiness="toNone",e.howMany-=t.howMany):t.targetPosition.isEqual(e.targetPosition)&&"mergeTargetWasBefore"==i.abRelation?(e.targetPosition.stickiness="toPrevious",e.howMany+=t.howMany):(e.sourcePosition.hasSameParentAs(t.targetPosition)&&(e.howMany+=t.howMany),e.sourcePosition.hasSameParentAs(t.sourcePosition)&&(e.howMany-=t.howMany)),e.sourcePosition=e.sourcePosition._getTransformedByMoveOperation(t),e.targetPosition=e.targetPosition._getTransformedByMoveOperation(t),e.sourcePosition.stickiness="toPrevious",e.targetPosition.stickiness="toNext",e.graveyardPosition.isEqual(t.targetPosition)||(e.graveyardPosition=e.graveyardPosition._getTransformedByMoveOperation(t)),[e])})),iu(qh,jh,((e,t,i)=>{if(t.graveyardPosition&&(e.graveyardPosition=e.graveyardPosition._getTransformedByDeletion(t.graveyardPosition,1),e.deletionPosition.isEqual(t.graveyardPosition)&&(e.howMany=t.howMany)),e.targetPosition.isEqual(t.splitPosition)){const n=0!=t.howMany,s=t.graveyardPosition&&e.deletionPosition.isEqual(t.graveyardPosition);if(n||s||"mergeTargetNotMoved"==i.abRelation)return e.sourcePosition=e.sourcePosition._getTransformedBySplitOperation(t),[e]}if(e.sourcePosition.isEqual(t.splitPosition)){if("mergeSourceNotMoved"==i.abRelation)return e.howMany=0,e.targetPosition=e.targetPosition._getTransformedBySplitOperation(t),[e];if("mergeSameElement"==i.abRelation||e.sourcePosition.offset>0)return e.sourcePosition=t.moveTargetPosition.clone(),e.targetPosition=e.targetPosition._getTransformedBySplitOperation(t),[e]}return e.sourcePosition.hasSameParentAs(t.splitPosition)&&(e.howMany=t.splitPosition.offset),e.sourcePosition=e.sourcePosition._getTransformedBySplitOperation(t),e.targetPosition=e.targetPosition._getTransformedBySplitOperation(t),[e]})),iu(Uh,Wh,((e,t)=>{const i=dd._createFromPositionAndShift(e.sourcePosition,e.howMany)._getTransformedByInsertOperation(t,!1)[0];return e.sourcePosition=i.start,e.howMany=i.end.offset-i.start.offset,e.targetPosition.isEqual(t.position)||(e.targetPosition=e.targetPosition._getTransformedByInsertOperation(t)),[e]})),iu(Uh,Uh,((e,t,i)=>{const n=dd._createFromPositionAndShift(e.sourcePosition,e.howMany),s=dd._createFromPositionAndShift(t.sourcePosition,t.howMany);let o,r=i.aIsStrong,a=!i.aIsStrong;if("insertBefore"==i.abRelation||"insertAfter"==i.baRelation?a=!0:"insertAfter"!=i.abRelation&&"insertBefore"!=i.baRelation||(a=!1),o=e.targetPosition.isEqual(t.targetPosition)&&a?e.targetPosition._getTransformedByDeletion(t.sourcePosition,t.howMany):e.targetPosition._getTransformedByMove(t.sourcePosition,t.targetPosition,t.howMany),du(e,t)&&du(t,e))return [t.getReversed()];if(n.containsPosition(t.targetPosition)&&n.containsRange(s,!0))return n.start=n.start._getTransformedByMove(t.sourcePosition,t.targetPosition,t.howMany),n.end=n.end._getTransformedByMove(t.sourcePosition,t.targetPosition,t.howMany),hu([n],o);if(s.containsPosition(e.targetPosition)&&s.containsRange(n,!0))return n.start=n.start._getCombined(t.sourcePosition,t.getMovedRangeStart()),n.end=n.end._getCombined(t.sourcePosition,t.getMovedRangeStart()),hu([n],o);const l=pr(e.sourcePosition.getParentPath(),t.sourcePosition.getParentPath());if("prefix"==l||"extension"==l)return n.start=n.start._getTransformedByMove(t.sourcePosition,t.targetPosition,t.howMany),n.end=n.end._getTransformedByMove(t.sourcePosition,t.targetPosition,t.howMany),hu([n],o);"remove"!=e.type||"remove"==t.type||i.aWasUndone||i.forceWeakRemove?"remove"==e.type||"remove"!=t.type||i.bWasUndone||i.forceWeakRemove||(r=!1):r=!0;const c=[],d=n.getDifference(s);for(const e of d){e.start=e.start._getTransformedByDeletion(t.sourcePosition,t.howMany),e.end=e.end._getTransformedByDeletion(t.sourcePosition,t.howMany);const i="same"==pr(e.start.getParentPath(),t.getMovedRangeStart().getParentPath()),n=e._getTransformedByInsertion(t.getMovedRangeStart(),t.howMany,i);c.push(...n);}const h=n.getIntersection(s);return null!==h&&r&&(h.start=h.start._getCombined(t.sourcePosition,t.getMovedRangeStart()),h.end=h.end._getCombined(t.sourcePosition,t.getMovedRangeStart()),0===c.length?c.push(h):1==c.length?s.start.isBefore(n.start)||s.start.isEqual(n.start)?c.unshift(h):c.push(h):c.splice(1,0,h)),0===c.length?[new Zh(e.baseVersion)]:hu(c,o)})),iu(Uh,jh,((e,t,i)=>{let n=e.targetPosition.clone();e.targetPosition.isEqual(t.insertionPosition)&&t.graveyardPosition&&"moveTargetAfter"!=i.abRelation||(n=e.targetPosition._getTransformedBySplitOperation(t));const s=dd._createFromPositionAndShift(e.sourcePosition,e.howMany);if(s.end.isEqual(t.insertionPosition))return t.graveyardPosition||e.howMany++,e.targetPosition=n,[e];if(s.start.hasSameParentAs(t.splitPosition)&&s.containsPosition(t.splitPosition)){let e=new dd(t.splitPosition,s.end);e=e._getTransformedBySplitOperation(t);return hu([new dd(s.start,t.splitPosition),e],n)}e.targetPosition.isEqual(t.splitPosition)&&"insertAtSource"==i.abRelation&&(n=t.moveTargetPosition),e.targetPosition.isEqual(t.insertionPosition)&&"insertBetween"==i.abRelation&&(n=e.targetPosition);const o=[s._getTransformedBySplitOperation(t)];if(t.graveyardPosition){const n=s.start.isEqual(t.graveyardPosition)||s.containsPosition(t.graveyardPosition);e.howMany>1&&n&&!i.aWasUndone&&o.push(dd._createFromPositionAndShift(t.insertionPosition,1));}return hu(o,n)})),iu(Uh,qh,((e,t,i)=>{const n=dd._createFromPositionAndShift(e.sourcePosition,e.howMany);if(t.deletionPosition.hasSameParentAs(e.sourcePosition)&&n.containsPosition(t.sourcePosition))if("remove"!=e.type||i.forceWeakRemove){if(1==e.howMany)return i.bWasUndone?(e.sourcePosition=t.graveyardPosition.clone(),e.targetPosition=e.targetPosition._getTransformedByMergeOperation(t),[e]):[new Zh(0)]}else if(!i.aWasUndone){const i=[];let n=t.graveyardPosition.clone(),s=t.targetPosition._getTransformedByMergeOperation(t);e.howMany>1&&(i.push(new Uh(e.sourcePosition,e.howMany-1,e.targetPosition,0)),n=n._getTransformedByMove(e.sourcePosition,e.targetPosition,e.howMany-1),s=s._getTransformedByMove(e.sourcePosition,e.targetPosition,e.howMany-1));const o=t.deletionPosition._getCombined(e.sourcePosition,e.targetPosition),r=new Uh(n,1,o,0),a=r.getMovedRangeStart().path.slice();a.push(0);const l=new sd(r.targetPosition.root,a);s=s._getTransformedByMove(n,o,1);const c=new Uh(s,t.howMany,l,0);return i.push(r),i.push(c),i}const s=dd._createFromPositionAndShift(e.sourcePosition,e.howMany)._getTransformedByMergeOperation(t);return e.sourcePosition=s.start,e.howMany=s.end.offset-s.start.offset,e.targetPosition=e.targetPosition._getTransformedByMergeOperation(t),[e]})),iu(Jh,Wh,((e,t)=>(e.position=e.position._getTransformedByInsertOperation(t),[e]))),iu(Jh,qh,((e,t)=>e.position.isEqual(t.deletionPosition)?(e.position=t.graveyardPosition.clone(),e.position.stickiness="toNext",[e]):(e.position=e.position._getTransformedByMergeOperation(t),[e]))),iu(Jh,Uh,((e,t)=>(e.position=e.position._getTransformedByMoveOperation(t),[e]))),iu(Jh,Jh,((e,t,i)=>{if(e.position.isEqual(t.position)){if(!i.aIsStrong)return [new Zh(0)];e.oldName=t.newName;}return [e]})),iu(Jh,jh,((e,t)=>{if("same"==pr(e.position.path,t.splitPosition.getParentPath())&&!t.graveyardPosition){const t=new Jh(e.position.getShiftedBy(1),e.oldName,e.newName,0);return [e,t]}return e.position=e.position._getTransformedBySplitOperation(t),[e]})),iu(Qh,Qh,((e,t,i)=>{if(e.root===t.root&&e.key===t.key){if(!i.aIsStrong||e.newValue===t.newValue)return [new Zh(0)];e.oldValue=t.newValue;}return [e]})),iu(Yh,Yh,((e,t)=>e.rootName===t.rootName&&e.isAdd===t.isAdd?[new Zh(0)]:[e])),iu(jh,Wh,((e,t)=>(e.splitPosition.hasSameParentAs(t.position)&&e.splitPosition.offset<t.position.offset&&(e.howMany+=t.howMany),e.splitPosition=e.splitPosition._getTransformedByInsertOperation(t),e.insertionPosition=e.insertionPosition._getTransformedByInsertOperation(t),[e]))),iu(jh,qh,((e,t,i)=>{if(!e.graveyardPosition&&!i.bWasUndone&&e.splitPosition.hasSameParentAs(t.sourcePosition)){const i=t.graveyardPosition.path.slice();i.push(0);const n=new sd(t.graveyardPosition.root,i),s=jh.getInsertionPosition(new sd(t.graveyardPosition.root,i)),o=new jh(n,0,s,null,0);return e.splitPosition=e.splitPosition._getTransformedByMergeOperation(t),e.insertionPosition=jh.getInsertionPosition(e.splitPosition),e.graveyardPosition=o.insertionPosition.clone(),e.graveyardPosition.stickiness="toNext",[o,e]}return e.splitPosition.hasSameParentAs(t.deletionPosition)&&!e.splitPosition.isAfter(t.deletionPosition)&&e.howMany--,e.splitPosition.hasSameParentAs(t.targetPosition)&&(e.howMany+=t.howMany),e.splitPosition=e.splitPosition._getTransformedByMergeOperation(t),e.insertionPosition=jh.getInsertionPosition(e.splitPosition),e.graveyardPosition&&(e.graveyardPosition=e.graveyardPosition._getTransformedByMergeOperation(t)),[e]})),iu(jh,Uh,((e,t,i)=>{const n=dd._createFromPositionAndShift(t.sourcePosition,t.howMany);if(e.graveyardPosition){const s=n.start.isEqual(e.graveyardPosition)||n.containsPosition(e.graveyardPosition);if(!i.bWasUndone&&s){const i=e.splitPosition._getTransformedByMoveOperation(t),n=e.graveyardPosition._getTransformedByMoveOperation(t),s=n.path.slice();s.push(0);const o=new sd(n.root,s);return [new Uh(i,e.howMany,o,0)]}e.graveyardPosition=e.graveyardPosition._getTransformedByMoveOperation(t);}const s=e.splitPosition.isEqual(t.targetPosition);if(s&&("insertAtSource"==i.baRelation||"splitBefore"==i.abRelation))return e.howMany+=t.howMany,e.splitPosition=e.splitPosition._getTransformedByDeletion(t.sourcePosition,t.howMany),e.insertionPosition=jh.getInsertionPosition(e.splitPosition),[e];if(s&&i.abRelation&&i.abRelation.howMany){const{howMany:t,offset:n}=i.abRelation;return e.howMany+=t,e.splitPosition=e.splitPosition.getShiftedBy(n),[e]}if(e.splitPosition.hasSameParentAs(t.sourcePosition)&&n.containsPosition(e.splitPosition)){const i=t.howMany-(e.splitPosition.offset-t.sourcePosition.offset);return e.howMany-=i,e.splitPosition.hasSameParentAs(t.targetPosition)&&e.splitPosition.offset<t.targetPosition.offset&&(e.howMany+=t.howMany),e.splitPosition=t.sourcePosition.clone(),e.insertionPosition=jh.getInsertionPosition(e.splitPosition),[e]}return t.sourcePosition.isEqual(t.targetPosition)||(e.splitPosition.hasSameParentAs(t.sourcePosition)&&e.splitPosition.offset<=t.sourcePosition.offset&&(e.howMany-=t.howMany),e.splitPosition.hasSameParentAs(t.targetPosition)&&e.splitPosition.offset<t.targetPosition.offset&&(e.howMany+=t.howMany)),e.splitPosition.stickiness="toNone",e.splitPosition=e.splitPosition._getTransformedByMoveOperation(t),e.splitPosition.stickiness="toNext",e.graveyardPosition?e.insertionPosition=e.insertionPosition._getTransformedByMoveOperation(t):e.insertionPosition=jh.getInsertionPosition(e.splitPosition),[e]})),iu(jh,jh,((e,t,i)=>{if(e.splitPosition.isEqual(t.splitPosition)){if(!e.graveyardPosition&&!t.graveyardPosition)return [new Zh(0)];if(e.graveyardPosition&&t.graveyardPosition&&e.graveyardPosition.isEqual(t.graveyardPosition))return [new Zh(0)];if("splitBefore"==i.abRelation)return e.howMany=0,e.graveyardPosition=e.graveyardPosition._getTransformedBySplitOperation(t),[e]}if(e.graveyardPosition&&t.graveyardPosition&&e.graveyardPosition.isEqual(t.graveyardPosition)){const n="$graveyard"==e.splitPosition.root.rootName,s="$graveyard"==t.splitPosition.root.rootName;if(s&&!n||!(n&&!s)&&i.aIsStrong){const i=[];return t.howMany&&i.push(new Uh(t.moveTargetPosition,t.howMany,t.splitPosition,0)),e.howMany&&i.push(new Uh(e.splitPosition,e.howMany,e.moveTargetPosition,0)),i}return [new Zh(0)]}if(e.graveyardPosition&&(e.graveyardPosition=e.graveyardPosition._getTransformedBySplitOperation(t)),e.splitPosition.isEqual(t.insertionPosition)&&"splitBefore"==i.abRelation)return e.howMany++,[e];if(t.splitPosition.isEqual(e.insertionPosition)&&"splitBefore"==i.baRelation){const i=t.insertionPosition.path.slice();i.push(0);const n=new sd(t.insertionPosition.root,i);return [e,new Uh(e.insertionPosition,1,n,0)]}return e.splitPosition.hasSameParentAs(t.splitPosition)&&e.splitPosition.offset<t.splitPosition.offset&&(e.howMany-=t.howMany),e.splitPosition=e.splitPosition._getTransformedBySplitOperation(t),e.insertionPosition=jh.getInsertionPosition(e.splitPosition),[e]}));class uu extends(F(sd)){constructor(e,t,i="toNone"){if(super(e,t,i),!this.root.is("rootElement"))throw new E("model-liveposition-root-not-rootelement",e);mu.call(this);}detach(){this.stopListening();}toPosition(){return new sd(this.root,this.path.slice(),this.stickiness)}static fromPosition(e,t){return new this(e.root,e.path.slice(),t||e.stickiness)}}function mu(){this.listenTo(this.root.document.model,"applyOperation",((e,t)=>{const i=t[0];i.isDocumentOperation&&gu.call(this,i);}),{priority:"low"});}function gu(e){const t=this.getTransformedByOperation(e);if(!this.isEqual(t)){const e=this.toPosition();this.path=t.path,this.root=t.root,this.fire("change",e);}}uu.prototype.is=function(e){return "livePosition"===e||"model:livePosition"===e||"position"==e||"model:position"===e};class fu{operations;isUndoable;isLocal;isUndo;isTyping;constructor(e={}){"string"==typeof e&&(e="transparent"===e?{isUndoable:!1}:{},T("batch-constructor-deprecated-string-type"));const{isUndoable:t=!0,isLocal:i=!0,isUndo:n=!1,isTyping:s=!1}=e;this.operations=[],this.isUndoable=t,this.isLocal=i,this.isUndo=n,this.isTyping=s;}get type(){return T("batch-type-deprecated"),"default"}get baseVersion(){for(const e of this.operations)if(null!==e.baseVersion)return e.baseVersion;return null}addOperation(e){return e.batch=this,this.operations.push(e),e}}class pu{static _statesPriority=[void 0,"refresh","rename","move"];_markerCollection;_changesInElement=new Map;_elementsSnapshots=new Map;_elementChildrenSnapshots=new Map;_elementState=new Map;_changedMarkers=new Map;_changedRoots=new Map;_changeCount=0;_cachedChanges=null;_cachedChangesWithGraveyard=null;_refreshedItems=new Set;constructor(e){this._markerCollection=e;}get isEmpty(){return 0==this._changesInElement.size&&0==this._changedMarkers.size&&0==this._changedRoots.size}bufferOperation(e){const t=e;switch(t.type){case"insert":if(this._isInInsertedElement(t.position.parent))return;this._markInsert(t.position.parent,t.position.offset,t.nodes.maxOffset);break;case"addAttribute":case"removeAttribute":case"changeAttribute":for(const e of t.range.getItems({shallow:!0}))this._isInInsertedElement(e.parent)||this._markAttribute(e);break;case"remove":case"move":case"reinsert":{if(t.sourcePosition.isEqual(t.targetPosition)||t.sourcePosition.getShiftedBy(t.howMany).isEqual(t.targetPosition))return;const e=this._isInInsertedElement(t.sourcePosition.parent),i=this._isInInsertedElement(t.targetPosition.parent);e||this._markRemove(t.sourcePosition.parent,t.sourcePosition.offset,t.howMany),i||this._markInsert(t.targetPosition.parent,t.getMovedRangeStart().offset,t.howMany);const n=dd._createFromPositionAndShift(t.sourcePosition,t.howMany);for(const e of n.getItems({shallow:!0}))this._setElementState(e,"move");break}case"rename":{if(this._isInInsertedElement(t.position.parent))return;this._markRemove(t.position.parent,t.position.offset,1),this._markInsert(t.position.parent,t.position.offset,1);const e=dd._createFromPositionAndShift(t.position,1);for(const t of this._markerCollection.getMarkersIntersectingRange(e)){const e=t.getData();this.bufferMarkerChange(t.name,e,e);}this._setElementState(t.position.nodeAfter,"rename");break}case"split":{const e=t.splitPosition.parent;if(!this._isInInsertedElement(e)){this._markRemove(e,t.splitPosition.offset,t.howMany);const i=dd._createFromPositionAndShift(t.splitPosition,t.howMany);for(const e of i.getItems({shallow:!0}))this._setElementState(e,"move");}this._isInInsertedElement(t.insertionPosition.parent)||this._markInsert(t.insertionPosition.parent,t.insertionPosition.offset,1),t.graveyardPosition&&(this._markRemove(t.graveyardPosition.parent,t.graveyardPosition.offset,1),this._setElementState(t.graveyardPosition.nodeAfter,"move"));break}case"merge":{const e=t.sourcePosition.parent;this._isInInsertedElement(e.parent)||this._markRemove(e.parent,e.startOffset,1);const i=t.graveyardPosition.parent;this._markInsert(i,t.graveyardPosition.offset,1),this._setElementState(e,"move");const n=t.targetPosition.parent;if(!this._isInInsertedElement(n)){this._markInsert(n,t.targetPosition.offset,e.maxOffset);const i=dd._createFromPositionAndShift(t.sourcePosition,t.howMany);for(const e of i.getItems({shallow:!0}))this._setElementState(e,"move");}break}case"detachRoot":case"addRoot":{const e=t.affectedSelectable;if(!e._isLoaded)return;if(e.isAttached()==t.isAdd)return;this._bufferRootStateChange(t.rootName,t.isAdd);break}case"addRootAttribute":case"removeRootAttribute":case"changeRootAttribute":{if(!t.root._isLoaded)return;const e=t.root.rootName;this._bufferRootAttributeChange(e,t.key,t.oldValue,t.newValue);break}}this._cachedChanges=null;}bufferMarkerChange(e,t,i){t.range&&t.range.root.is("rootElement")&&!t.range.root._isLoaded&&(t.range=null),i.range&&i.range.root.is("rootElement")&&!i.range.root._isLoaded&&(i.range=null);let n=this._changedMarkers.get(e);n?n.newMarkerData=i:(n={newMarkerData:i,oldMarkerData:t},this._changedMarkers.set(e,n)),null==n.oldMarkerData.range&&null==i.range&&this._changedMarkers.delete(e);}getMarkersToRemove(){const e=[];for(const[t,i]of this._changedMarkers)null!=i.oldMarkerData.range&&e.push({name:t,range:i.oldMarkerData.range});return e}getMarkersToAdd(){const e=[];for(const[t,i]of this._changedMarkers)null!=i.newMarkerData.range&&e.push({name:t,range:i.newMarkerData.range});return e}getChangedMarkers(){return Array.from(this._changedMarkers).map((([e,t])=>({name:e,data:{oldRange:t.oldMarkerData.range,newRange:t.newMarkerData.range}})))}hasDataChanges(){if(this.getChanges().length)return !0;if(this._changedRoots.size>0)return !0;for(const{newMarkerData:e,oldMarkerData:t}of this._changedMarkers.values()){if(e.affectsData!==t.affectsData)return !0;if(e.affectsData){const i=e.range&&!t.range,n=!e.range&&t.range,s=e.range&&t.range&&!e.range.isEqual(t.range);if(i||n||s)return !0}}return !1}getChanges(e={}){if(this._cachedChanges)return e.includeChangesInGraveyard?this._cachedChangesWithGraveyard.slice():this._cachedChanges.slice();let t=[];for(const e of this._changesInElement.keys()){const i=this._changesInElement.get(e).sort(((e,t)=>e.offset===t.offset?e.type!=t.type?"remove"==e.type?-1:1:0:e.offset<t.offset?-1:1)),n=this._elementChildrenSnapshots.get(e),s=wu(e.getChildren()),o=_u(n.length,i);let r=0,a=0;for(const i of o)if("i"===i){const i=this._getDiffActionForNode(s[r].node,"insert"),n=this._elementsSnapshots.get(s[r].node),o=this._getInsertDiff(e,r,i,s[r],n);t.push(o),r++;}else if("r"===i){const i=this._getDiffActionForNode(n[a].node,"remove"),s=this._getRemoveDiff(e,r,i,n[a]);t.push(s),a++;}else if("a"===i){const i=n[a].attributes,o=s[r].attributes;let l;if("$text"==s[r].name)l=new dd(sd._createAt(e,r),sd._createAt(e,r+1));else {const t=e.offsetToIndex(r);l=new dd(sd._createAt(e,r),sd._createAt(e.getChild(t),0));}const c=this._getAttributesDiff(l,i,o);t.push(...c),r++,a++;}else r++,a++;}t.sort(((e,t)=>e.position.root!=t.position.root?e.position.root.rootName<t.position.root.rootName?-1:1:e.position.isEqual(t.position)?e.changeCount-t.changeCount:e.position.isBefore(t.position)?-1:1));for(let e=1,i=0;e<t.length;e++){const n=t[i],s=t[e],o="remove"==n.type&&"remove"==s.type&&"$text"==n.name&&"$text"==s.name&&n.position.isEqual(s.position),r="insert"==n.type&&"insert"==s.type&&"$text"==n.name&&"$text"==s.name&&n.position.parent==s.position.parent&&n.position.offset+n.length==s.position.offset,a="attribute"==n.type&&"attribute"==s.type&&n.position.parent==s.position.parent&&n.range.isFlat&&s.range.isFlat&&n.position.offset+n.length==s.position.offset&&n.attributeKey==s.attributeKey&&n.attributeOldValue==s.attributeOldValue&&n.attributeNewValue==s.attributeNewValue;o||r||a?(n.length++,a&&(n.range.end=n.range.end.getShiftedBy(1)),t[e]=null):i=e;}t=t.filter((e=>e));for(const e of t)delete e.changeCount,"attribute"==e.type&&(delete e.position,delete e.length);return this._changeCount=0,this._cachedChangesWithGraveyard=t,this._cachedChanges=t.filter(vu),e.includeChangesInGraveyard?this._cachedChangesWithGraveyard.slice():this._cachedChanges.slice()}getChangedRoots(){return Array.from(this._changedRoots.values()).map((e=>{const t={...e};return void 0!==t.state&&delete t.attributes,t}))}getRefreshedItems(){return new Set(this._refreshedItems)}reset(){this._changesInElement.clear(),this._elementChildrenSnapshots.clear(),this._elementsSnapshots.clear(),this._elementState.clear(),this._changedMarkers.clear(),this._changedRoots.clear(),this._refreshedItems.clear(),this._cachedChanges=null;}_refreshItem(e){if(this._isInInsertedElement(e.parent))return;this._markRemove(e.parent,e.startOffset,e.offsetSize),this._markInsert(e.parent,e.startOffset,e.offsetSize),this._refreshedItems.add(e),this._setElementState(e,"refresh");const t=dd._createOn(e);for(const e of this._markerCollection.getMarkersIntersectingRange(t)){const t=e.getData();this.bufferMarkerChange(e.name,t,t);}this._cachedChanges=null;}_bufferRootLoad(e){if(e.isAttached()){this._bufferRootStateChange(e.rootName,!0),this._markInsert(e,0,e.maxOffset);for(const t of e.getAttributeKeys())this._bufferRootAttributeChange(e.rootName,t,null,e.getAttribute(t));for(const t of this._markerCollection)if(t.getRange().root==e){const e=t.getData();this.bufferMarkerChange(t.name,{...e,range:null},e);}}}_bufferRootStateChange(e,t){if(!this._changedRoots.has(e))return void this._changedRoots.set(e,{name:e,state:t?"attached":"detached"});const i=this._changedRoots.get(e);void 0!==i.state?(delete i.state,void 0===i.attributes&&this._changedRoots.delete(e)):i.state=t?"attached":"detached";}_bufferRootAttributeChange(e,t,i,n){const s=this._changedRoots.get(e)||{name:e},o=s.attributes||{};if(o[t]){const e=o[t];n===e.oldValue?delete o[t]:e.newValue=n;}else o[t]={oldValue:i,newValue:n};0===Object.entries(o).length?(delete s.attributes,void 0===s.state&&this._changedRoots.delete(e)):(s.attributes=o,this._changedRoots.set(e,s));}_markInsert(e,t,i){if(e.root.is("rootElement")&&!e.root._isLoaded)return;const n={type:"insert",offset:t,howMany:i,count:this._changeCount++};this._markChange(e,n);}_markRemove(e,t,i){if(e.root.is("rootElement")&&!e.root._isLoaded)return;const n={type:"remove",offset:t,howMany:i,count:this._changeCount++};this._markChange(e,n),this._removeAllNestedChanges(e,t,i);}_markAttribute(e){if(e.root.is("rootElement")&&!e.root._isLoaded)return;const t={type:"attribute",offset:e.startOffset,howMany:e.offsetSize,count:this._changeCount++};this._markChange(e.parent,t);}_markChange(e,t){this._makeSnapshots(e);const i=this._getChangesForElement(e);this._handleChange(t,i),i.push(t);for(let e=0;e<i.length;e++)i[e].howMany<1&&(i.splice(e,1),e--);}_setElementState(e,t){if(!e.is("element"))return;const i=pu._statesPriority.indexOf(this._elementState.get(e));pu._statesPriority.indexOf(t)>i&&this._elementState.set(e,t);}_getDiffActionForNode(e,t){if(!e.is("element"))return t;if(!this._elementsSnapshots.has(e))return t;const i=this._elementState.get(e);return i&&"move"!=i?i:t}_getChangesForElement(e){let t;return this._changesInElement.has(e)?t=this._changesInElement.get(e):(t=[],this._changesInElement.set(e,t)),t}_makeSnapshots(e){if(this._elementChildrenSnapshots.has(e))return;const t=wu(e.getChildren());this._elementChildrenSnapshots.set(e,t);for(const e of t)this._elementsSnapshots.set(e.node,e);}_handleChange(e,t){e.nodesToHandle=e.howMany;for(const i of t){const n=e.offset+e.howMany,s=i.offset+i.howMany;if("insert"==e.type&&("insert"==i.type&&(e.offset<=i.offset?i.offset+=e.howMany:e.offset<s&&(i.howMany+=e.nodesToHandle,e.nodesToHandle=0)),"remove"==i.type&&e.offset<i.offset&&(i.offset+=e.howMany),"attribute"==i.type))if(e.offset<=i.offset)i.offset+=e.howMany;else if(e.offset<s){const s=i.howMany;i.howMany=e.offset-i.offset,t.unshift({type:"attribute",offset:n,howMany:s-i.howMany,count:this._changeCount++});}if("remove"==e.type){if("insert"==i.type)if(n<=i.offset)i.offset-=e.howMany;else if(n<=s)if(e.offset<i.offset){const t=n-i.offset;i.offset=e.offset,i.howMany-=t,e.nodesToHandle-=t;}else i.howMany-=e.nodesToHandle,e.nodesToHandle=0;else if(e.offset<=i.offset)e.nodesToHandle-=i.howMany,i.howMany=0;else if(e.offset<s){const t=s-e.offset;i.howMany-=t,e.nodesToHandle-=t;}if("remove"==i.type&&(n<=i.offset?i.offset-=e.howMany:e.offset<i.offset&&(e.nodesToHandle+=i.howMany,i.howMany=0)),"attribute"==i.type)if(n<=i.offset)i.offset-=e.howMany;else if(e.offset<i.offset){const t=n-i.offset;i.offset=e.offset,i.howMany-=t;}else if(e.offset<s)if(n<=s){const n=i.howMany;i.howMany=e.offset-i.offset;const s=n-i.howMany-e.nodesToHandle;t.unshift({type:"attribute",offset:e.offset,howMany:s,count:this._changeCount++});}else i.howMany-=s-e.offset;}if("attribute"==e.type){if("insert"==i.type)if(e.offset<i.offset&&n>i.offset){if(n>s){const e={type:"attribute",offset:s,howMany:n-s,count:this._changeCount++};this._handleChange(e,t),t.push(e);}e.nodesToHandle=i.offset-e.offset,e.howMany=e.nodesToHandle;}else e.offset>=i.offset&&e.offset<s&&(n>s?(e.nodesToHandle=n-s,e.offset=s):e.nodesToHandle=0);if("remove"==i.type&&e.offset<i.offset&&n>i.offset){const s={type:"attribute",offset:i.offset,howMany:n-i.offset,count:this._changeCount++};this._handleChange(s,t),t.push(s),e.nodesToHandle=i.offset-e.offset,e.howMany=e.nodesToHandle;}"attribute"==i.type&&(e.offset>=i.offset&&n<=s?(e.nodesToHandle=0,e.howMany=0,e.offset=0):e.offset<=i.offset&&n>=s&&(i.howMany=0));}}e.howMany=e.nodesToHandle,delete e.nodesToHandle;}_getInsertDiff(e,t,i,n,s){const o={type:"insert",position:sd._createAt(e,t),name:n.name,attributes:new Map(n.attributes),length:1,changeCount:this._changeCount++,action:i};return "insert"!=i&&s&&(o.before={name:s.name,attributes:new Map(s.attributes)}),o}_getRemoveDiff(e,t,i,n){return {type:"remove",action:i,position:sd._createAt(e,t),name:n.name,attributes:new Map(n.attributes),length:1,changeCount:this._changeCount++}}_getAttributesDiff(e,t,i){const n=[];i=new Map(i);for(const[s,o]of t){const t=i.has(s)?i.get(s):null;t!==o&&n.push({type:"attribute",position:e.start,range:e.clone(),length:1,attributeKey:s,attributeOldValue:o,attributeNewValue:t,changeCount:this._changeCount++}),i.delete(s);}for(const[t,s]of i)n.push({type:"attribute",position:e.start,range:e.clone(),length:1,attributeKey:t,attributeOldValue:null,attributeNewValue:s,changeCount:this._changeCount++});return n}_isInInsertedElement(e){const t=e.parent;if(!t)return !1;const i=this._changesInElement.get(t),n=e.startOffset;if(i)for(const e of i)if("insert"==e.type&&n>=e.offset&&n<e.offset+e.howMany)return !0;return this._isInInsertedElement(t)}_removeAllNestedChanges(e,t,i){const n=new dd(sd._createAt(e,t),sd._createAt(e,t+i));for(const e of n.getItems({shallow:!0}))e.is("element")&&(this._changesInElement.delete(e),this._removeAllNestedChanges(e,0,e.maxOffset));}}function bu(e){return {node:e,name:e.is("$text")?"$text":e.name,attributes:new Map(e.getAttributes())}}function wu(e){const t=[];for(const i of e)if(i.is("$text"))for(let e=0;e<i.data.length;++e)t.push(bu(i));else t.push(bu(i));return t}function _u(e,t){const i=[];let n=0,s=0;for(const e of t){if(e.offset>n){for(let t=0;t<e.offset-n;t++)i.push("e");s+=e.offset-n;}if("insert"==e.type){for(let t=0;t<e.howMany;t++)i.push("i");n=e.offset+e.howMany;}else if("remove"==e.type){for(let t=0;t<e.howMany;t++)i.push("r");n=e.offset,s+=e.howMany;}else {if(e.howMany>1500)for(let t=0;t<e.howMany;t++)i.push("a");else i.push(..."a".repeat(e.howMany).split(""));n=e.offset+e.howMany,s+=e.howMany;}}if(s<e)for(let t=0;t<e-s-n;t++)i.push("e");return i}function vu(e){const t="position"in e&&"$graveyard"==e.position.root.rootName,i="range"in e&&"$graveyard"==e.range.root.rootName;return !t&&!i}class yu{_operations=[];_undoPairs=new Map;_undoneOperations=new Set;_baseVersionToOperationIndex=new Map;_version=0;_gaps=new Map;get version(){return this._version}set version(e){this._operations.length&&e>this._version+1&&this._gaps.set(this._version,e),this._version=e;}get lastOperation(){return this._operations[this._operations.length-1]}addOperation(e){if(e.baseVersion!==this.version)throw new E("model-document-history-addoperation-incorrect-version",this,{operation:e,historyVersion:this.version});this._operations.push(e),this._version++,this._baseVersionToOperationIndex.set(e.baseVersion,this._operations.length-1);}getOperations(e,t=this.version){if(!this._operations.length)return [];const i=this._operations[0];void 0===e&&(e=i.baseVersion);let n=t-1;for(const[t,i]of this._gaps)e>t&&e<i&&(e=i),n>t&&n<i&&(n=t-1);if(n<i.baseVersion||e>this.lastOperation.baseVersion)return [];let s=this._baseVersionToOperationIndex.get(e);void 0===s&&(s=0);let o=this._baseVersionToOperationIndex.get(n);return void 0===o&&(o=this._operations.length-1),this._operations.slice(s,o+1)}getOperation(e){const t=this._baseVersionToOperationIndex.get(e);if(void 0!==t)return this._operations[t]}setOperationAsUndone(e,t){this._undoPairs.set(t,e),this._undoneOperations.add(e);}isUndoingOperation(e){return this._undoPairs.has(e)}isUndoneOperation(e){return this._undoneOperations.has(e)}getUndoneOperation(e){return this._undoPairs.get(e)}reset(){this._version=0,this._undoPairs=new Map,this._operations=[],this._undoneOperations=new Set,this._gaps=new Map,this._baseVersionToOperationIndex=new Map;}}class ku extends td{rootName;_document;_isAttached=!0;_isLoaded=!0;constructor(e,t,i="main"){super(t),this._document=e,this.rootName=i;}get document(){return this._document}isAttached(){return this._isAttached}toJSON(){return this.rootName}}ku.prototype.is=function(e,t){return t?t===this.name&&("rootElement"===e||"model:rootElement"===e||"element"===e||"model:element"===e):"rootElement"===e||"model:rootElement"===e||"element"===e||"model:element"===e||"node"===e||"model:node"===e};const Cu="$graveyard";class xu extends(F()){model;history;selection;roots;differ;isReadOnly;_postFixers;_hasSelectionChangedFromTheLastChangeBlock;constructor(e){super(),this.model=e,this.history=new yu,this.selection=new Sd(this),this.roots=new Sa({idProperty:"rootName"}),this.differ=new pu(e.markers),this.isReadOnly=!1,this._postFixers=new Set,this._hasSelectionChangedFromTheLastChangeBlock=!1,this.createRoot("$root",Cu),this.listenTo(e,"applyOperation",((e,t)=>{const i=t[0];i.isDocumentOperation&&this.differ.bufferOperation(i);}),{priority:"high"}),this.listenTo(e,"applyOperation",((e,t)=>{const i=t[0];i.isDocumentOperation&&this.history.addOperation(i);}),{priority:"low"}),this.listenTo(this.selection,"change",(()=>{this._hasSelectionChangedFromTheLastChangeBlock=!0;})),this.listenTo(e.markers,"update",((e,t,i,n,s)=>{const o={...t.getData(),range:n};this.differ.bufferMarkerChange(t.name,s,o),null===i&&t.on("change",((e,i)=>{const n=t.getData();this.differ.bufferMarkerChange(t.name,{...n,range:i},n);}));})),this.registerPostFixer((e=>{let t=!1;for(const i of this.roots)i.isAttached()||i.isEmpty||(e.remove(e.createRangeIn(i)),t=!0);for(const i of this.model.markers)i.getRange().root.isAttached()||(e.removeMarker(i),t=!0);return t}));}get version(){return this.history.version}set version(e){this.history.version=e;}get graveyard(){return this.getRoot(Cu)}createRoot(e="$root",t="main"){if(this.roots.get(t))throw new E("model-document-createroot-name-exists",this,{name:t});const i=new ku(this,e,t);return this.roots.add(i),i}destroy(){this.selection.destroy(),this.stopListening();}getRoot(e="main"){return this.roots.get(e)}getRootNames(e=!1){return this.getRoots(e).map((e=>e.rootName))}getRoots(e=!1){return this.roots.filter((t=>t!=this.graveyard&&(e||t.isAttached())&&t._isLoaded))}registerPostFixer(e){this._postFixers.add(e);}toJSON(){const e=Es(this);return e.selection="[engine.model.DocumentSelection]",e.model="[engine.model.Model]",e}_handleChangeBlock(e){this._hasDocumentChangedFromTheLastChangeBlock()&&(this._callPostFixers(e),this.selection.refresh(),this.differ.hasDataChanges()?this.fire("change:data",e.batch):this.fire("change",e.batch),this.selection.refresh(),this.differ.reset()),this._hasSelectionChangedFromTheLastChangeBlock=!1;}_hasDocumentChangedFromTheLastChangeBlock(){return !this.differ.isEmpty||this._hasSelectionChangedFromTheLastChangeBlock}_getDefaultRoot(){const e=this.getRoots();return e.length?e[0]:this.graveyard}_getDefaultRange(){const e=this._getDefaultRoot(),t=this.model,i=t.schema,n=t.createPositionFromPath(e,[0]);return i.getNearestSelectionRange(n)||t.createRange(n)}_validateSelectionRange(e){return Au(e.start)&&Au(e.end)}_callPostFixers(e){let t=!1;do{for(const i of this._postFixers)if(this.selection.refresh(),t=i(e),t)break}while(t)}}function Au(e){const t=e.textNode;if(t){const i=t.data,n=e.offset-t.startOffset;return !$a(i,n)&&!Ua(i,n)}return !0}class Eu extends(F()){_markers=new Map;[Symbol.iterator](){return this._markers.values()}has(e){const t=e instanceof Tu?e.name:e;return this._markers.has(t)}get(e){return this._markers.get(e)||null}_set(e,t,i=!1,n=!1){const s=e instanceof Tu?e.name:e;if(s.includes(","))throw new E("markercollection-incorrect-marker-name",this);const o=this._markers.get(s);if(o){const e=o.getData(),r=o.getRange();let a=!1;return r.isEqual(t)||(o._attachLiveRange(xd.fromRange(t)),a=!0),i!=o.managedUsingOperations&&(o._managedUsingOperations=i,a=!0),"boolean"==typeof n&&n!=o.affectsData&&(o._affectsData=n,a=!0),a&&this.fire(`update:${s}`,o,r,t,e),o}const r=xd.fromRange(t),a=new Tu(s,r,i,n);return this._markers.set(s,a),this.fire(`update:${s}`,a,null,t,{...a.getData(),range:null}),a}_remove(e){const t=e instanceof Tu?e.name:e,i=this._markers.get(t);return !!i&&(this._markers.delete(t),this.fire(`update:${t}`,i,i.getRange(),null,i.getData()),this._destroyMarker(i),!0)}_refresh(e){const t=e instanceof Tu?e.name:e,i=this._markers.get(t);if(!i)throw new E("markercollection-refresh-marker-not-exists",this);const n=i.getRange();this.fire(`update:${t}`,i,n,n,i.getData());}*getMarkersAtPosition(e){for(const t of this)t.getRange().containsPosition(e)&&(yield t);}*getMarkersIntersectingRange(e){for(const t of this)null!==t.getRange().getIntersection(e)&&(yield t);}destroy(){for(const e of this._markers.values())this._destroyMarker(e);this._markers=null,this.stopListening();}*getMarkersGroup(e){for(const t of this._markers.values())t.name.startsWith(e+":")&&(yield t);}_destroyMarker(e){e.stopListening(),e._detachLiveRange();}}class Tu extends(F(Jc)){name;_managedUsingOperations;_affectsData;_liveRange;constructor(e,t,i,n){super(),this.name=e,this._liveRange=this._attachLiveRange(t),this._managedUsingOperations=i,this._affectsData=n;}get managedUsingOperations(){if(!this._liveRange)throw new E("marker-destroyed",this);return this._managedUsingOperations}get affectsData(){if(!this._liveRange)throw new E("marker-destroyed",this);return this._affectsData}getData(){return {range:this.getRange(),affectsData:this.affectsData,managedUsingOperations:this.managedUsingOperations}}getStart(){if(!this._liveRange)throw new E("marker-destroyed",this);return this._liveRange.start.clone()}getEnd(){if(!this._liveRange)throw new E("marker-destroyed",this);return this._liveRange.end.clone()}getRange(){if(!this._liveRange)throw new E("marker-destroyed",this);return this._liveRange.toRange()}_attachLiveRange(e){return this._liveRange&&this._detachLiveRange(),e.delegate("change:range").to(this),e.delegate("change:content").to(this),this._liveRange=e,e}_detachLiveRange(){this._liveRange.stopDelegating("change:range",this),this._liveRange.stopDelegating("change:content",this),this._liveRange.detach(),this._liveRange=null;}}Tu.prototype.is=function(e){return "marker"===e||"model:marker"===e};class Su extends Mh{sourcePosition;howMany;constructor(e,t){super(null),this.sourcePosition=e.clone(),this.howMany=t;}get type(){return "detach"}get affectedSelectable(){return null}toJSON(){const e=super.toJSON();return e.sourcePosition=this.sourcePosition.toJSON(),e}_validate(){if(this.sourcePosition.root.document)throw new E("detach-operation-on-document-node",this)}_execute(){Fh(dd._createFromPositionAndShift(this.sourcePosition,this.howMany));}static get className(){return "DetachOperation"}}class Iu extends Jc{markers=new Map;_children=new Yc;constructor(e){super(),e&&this._insertChild(0,e);}[Symbol.iterator](){return this.getChildren()}get childCount(){return this._children.length}get maxOffset(){return this._children.maxOffset}get isEmpty(){return 0===this.childCount}get nextSibling(){return null}get previousSibling(){return null}get root(){return this}get parent(){return null}get document(){return null}isAttached(){return !1}getAncestors(){return []}getChild(e){return this._children.getNode(e)}getChildren(){return this._children[Symbol.iterator]()}getChildIndex(e){return this._children.getNodeIndex(e)}getChildStartOffset(e){return this._children.getNodeStartOffset(e)}getPath(){return []}getNodeByPath(e){let t=this;for(const i of e)t=t.getChild(t.offsetToIndex(i));return t}offsetToIndex(e){return this._children.offsetToIndex(e)}toJSON(){const e=[];for(const t of this._children)e.push(t.toJSON());return e}static fromJSON(e){const t=[];for(const i of e)i.name?t.push(td.fromJSON(i)):t.push(Xc.fromJSON(i));return new Iu(t)}_appendChild(e){this._insertChild(this.childCount,e);}_insertChild(e,t){const i=function(e){if("string"==typeof e)return [new Xc(e)];br(e)||(e=[e]);return Array.from(e).map((e=>"string"==typeof e?new Xc(e):e instanceof ed?new Xc(e.data,e.getAttributes()):e))}(t);for(const e of i)null!==e.parent&&e._remove(),e.parent=this;this._children._insertNodes(e,i);}_removeChildren(e,t=1){const i=this._children._removeNodes(e,t);for(const e of i)e.parent=null;return i}}Iu.prototype.is=function(e){return "documentFragment"===e||"model:documentFragment"===e};class Pu{model;batch;constructor(e,t){this.model=e,this.batch=t;}createText(e,t){return new Xc(e,t)}createElement(e,t){return new td(e,t)}createDocumentFragment(){return new Iu}cloneElement(e,t=!0){return e._clone(t)}insert(e,t,i=0){if(this._assertWriterUsedCorrectly(),e instanceof Xc&&""==e.data)return;const n=sd._createAt(t,i);if(e.parent){if(Mu(e.root,n.root))return void this.move(dd._createOn(e),n);if(e.root.document)throw new E("model-writer-insert-forbidden-move",this);this.remove(e);}const s=n.root.document?n.root.document.version:null,o=new Wh(n,e,s);if(e instanceof Xc&&(o.shouldReceiveAttributes=!0),this.batch.addOperation(o),this.model.applyOperation(o),e instanceof Iu)for(const[t,i]of e.markers){const e=sd._createAt(i.root,0),s={range:new dd(i.start._getCombined(e,n),i.end._getCombined(e,n)),usingOperation:!0,affectsData:!0};this.model.markers.has(t)?this.updateMarker(t,s):this.addMarker(t,s);}}insertText(e,t,i,n){t instanceof Iu||t instanceof td||t instanceof sd?this.insert(this.createText(e),t,i):this.insert(this.createText(e,t),i,n);}insertElement(e,t,i,n){t instanceof Iu||t instanceof td||t instanceof sd?this.insert(this.createElement(e),t,i):this.insert(this.createElement(e,t),i,n);}append(e,t){this.insert(e,t,"end");}appendText(e,t,i){t instanceof Iu||t instanceof td?this.insert(this.createText(e),t,"end"):this.insert(this.createText(e,t),i,"end");}appendElement(e,t,i){t instanceof Iu||t instanceof td?this.insert(this.createElement(e),t,"end"):this.insert(this.createElement(e,t),i,"end");}setAttribute(e,t,i){if(this._assertWriterUsedCorrectly(),i instanceof dd){const n=i.getMinimalFlatRanges();for(const i of n)Vu(this,e,t,i);}else Ru(this,e,t,i);}setAttributes(e,t){for(const[i,n]of Ra(e))this.setAttribute(i,n,t);}removeAttribute(e,t){if(this._assertWriterUsedCorrectly(),t instanceof dd){const i=t.getMinimalFlatRanges();for(const t of i)Vu(this,e,null,t);}else Ru(this,e,null,t);}clearAttributes(e){this._assertWriterUsedCorrectly();const t=e=>{for(const t of e.getAttributeKeys())this.removeAttribute(t,e);};if(e instanceof dd)for(const i of e.getItems())t(i);else t(e);}move(e,t,i){if(this._assertWriterUsedCorrectly(),!(e instanceof dd))throw new E("writer-move-invalid-range",this);if(!e.isFlat)throw new E("writer-move-range-not-flat",this);const n=sd._createAt(t,i);if(n.isEqual(e.start))return;if(this._addOperationForAffectedMarkers("move",e),!Mu(e.root,n.root))throw new E("writer-move-different-document",this);const s=e.root.document?e.root.document.version:null,o=new Uh(e.start,e.end.offset-e.start.offset,n,s);this.batch.addOperation(o),this.model.applyOperation(o);}remove(e){this._assertWriterUsedCorrectly();const t=(e instanceof dd?e:dd._createOn(e)).getMinimalFlatRanges().reverse();for(const e of t)this._addOperationForAffectedMarkers("move",e),Ou(e.start,e.end.offset-e.start.offset,this.batch,this.model);}merge(e){this._assertWriterUsedCorrectly();const t=e.nodeBefore,i=e.nodeAfter;if(this._addOperationForAffectedMarkers("merge",e),!(t instanceof td))throw new E("writer-merge-no-element-before",this);if(!(i instanceof td))throw new E("writer-merge-no-element-after",this);e.root.document?this._merge(e):this._mergeDetached(e);}createPositionFromPath(e,t,i){return this.model.createPositionFromPath(e,t,i)}createPositionAt(e,t){return this.model.createPositionAt(e,t)}createPositionAfter(e){return this.model.createPositionAfter(e)}createPositionBefore(e){return this.model.createPositionBefore(e)}createRange(e,t){return this.model.createRange(e,t)}createRangeIn(e){return this.model.createRangeIn(e)}createRangeOn(e){return this.model.createRangeOn(e)}createSelection(...e){return this.model.createSelection(...e)}_mergeDetached(e){const t=e.nodeBefore,i=e.nodeAfter;this.move(dd._createIn(i),sd._createAt(t,"end")),this.remove(i);}_merge(e){const t=sd._createAt(e.nodeBefore,"end"),i=sd._createAt(e.nodeAfter,0),n=e.root.document.graveyard,s=new sd(n,[0]),o=e.root.document.version,r=new qh(i,e.nodeAfter.maxOffset,t,s,o);this.batch.addOperation(r),this.model.applyOperation(r);}rename(e,t){if(this._assertWriterUsedCorrectly(),!(e instanceof td))throw new E("writer-rename-not-element-instance",this);const i=e.root.document?e.root.document.version:null,n=new Jh(sd._createBefore(e),e.name,t,i);this.batch.addOperation(n),this.model.applyOperation(n);}split(e,t){this._assertWriterUsedCorrectly();let i,n,s=e.parent;if(!s.parent)throw new E("writer-split-element-no-parent",this);if(t||(t=s.parent),!e.parent.getAncestors({includeSelf:!0}).includes(t))throw new E("writer-split-invalid-limit-element",this);do{const t=s.root.document?s.root.document.version:null,o=s.maxOffset-e.offset,r=jh.getInsertionPosition(e),a=new jh(e,o,r,null,t);this.batch.addOperation(a),this.model.applyOperation(a),i||n||(i=s,n=e.parent.nextSibling),s=(e=this.createPositionAfter(e.parent)).parent;}while(s!==t);return {position:e,range:new dd(sd._createAt(i,"end"),sd._createAt(n,0))}}wrap(e,t){if(this._assertWriterUsedCorrectly(),!e.isFlat)throw new E("writer-wrap-range-not-flat",this);const i=t instanceof td?t:new td(t);if(i.childCount>0)throw new E("writer-wrap-element-not-empty",this);if(null!==i.parent)throw new E("writer-wrap-element-attached",this);this.insert(i,e.start);const n=new dd(e.start.getShiftedBy(1),e.end.getShiftedBy(1));this.move(n,sd._createAt(i,0));}unwrap(e){if(this._assertWriterUsedCorrectly(),null===e.parent)throw new E("writer-unwrap-element-no-parent",this);this.move(dd._createIn(e),this.createPositionAfter(e)),this.remove(e);}addMarker(e,t){if(this._assertWriterUsedCorrectly(),!t||"boolean"!=typeof t.usingOperation)throw new E("writer-addmarker-no-usingoperation",this);const i=t.usingOperation,n=t.range,s=void 0!==t.affectsData&&t.affectsData;if(this.model.markers.has(e))throw new E("writer-addmarker-marker-exists",this);if(!n)throw new E("writer-addmarker-no-range",this);return i?(Bu(this,e,null,n,s),this.model.markers.get(e)):this.model.markers._set(e,n,i,s)}updateMarker(e,t){this._assertWriterUsedCorrectly();const i="string"==typeof e?e:e.name,n=this.model.markers.get(i);if(!n)throw new E("writer-updatemarker-marker-not-exists",this);if(!t)return T("writer-updatemarker-reconvert-using-editingcontroller",{markerName:i}),void this.model.markers._refresh(n);const s="boolean"==typeof t.usingOperation,o="boolean"==typeof t.affectsData,r=o?t.affectsData:n.affectsData;if(!s&&!t.range&&!o)throw new E("writer-updatemarker-wrong-options",this);const a=n.getRange(),l=t.range?t.range:a;s&&t.usingOperation!==n.managedUsingOperations?t.usingOperation?Bu(this,i,null,l,r):(Bu(this,i,a,null,r),this.model.markers._set(i,l,void 0,r)):n.managedUsingOperations?Bu(this,i,a,l,r):this.model.markers._set(i,l,void 0,r);}removeMarker(e){this._assertWriterUsedCorrectly();const t="string"==typeof e?e:e.name;if(!this.model.markers.has(t))throw new E("writer-removemarker-no-marker",this);const i=this.model.markers.get(t);if(!i.managedUsingOperations)return void this.model.markers._remove(t);Bu(this,t,i.getRange(),null,i.affectsData);}addRoot(e,t="$root"){this._assertWriterUsedCorrectly();const i=this.model.document.getRoot(e);if(i&&i.isAttached())throw new E("writer-addroot-root-exists",this);const n=this.model.document,s=new Yh(e,t,!0,n,n.version);return this.batch.addOperation(s),this.model.applyOperation(s),this.model.document.getRoot(e)}detachRoot(e){this._assertWriterUsedCorrectly();const t="string"==typeof e?this.model.document.getRoot(e):e;if(!t||!t.isAttached())throw new E("writer-detachroot-no-root",this);for(const e of this.model.markers)e.getRange().root===t&&this.removeMarker(e);for(const e of t.getAttributeKeys())this.removeAttribute(e,t);this.remove(this.createRangeIn(t));const i=this.model.document,n=new Yh(t.rootName,t.name,!1,i,i.version);this.batch.addOperation(n),this.model.applyOperation(n);}setSelection(...e){this._assertWriterUsedCorrectly(),this.model.document.selection._setTo(...e);}setSelectionFocus(e,t){this._assertWriterUsedCorrectly(),this.model.document.selection._setFocus(e,t);}setSelectionAttribute(e,t){if(this._assertWriterUsedCorrectly(),"string"==typeof e)this._setSelectionAttribute(e,t);else for(const[t,i]of Ra(e))this._setSelectionAttribute(t,i);}removeSelectionAttribute(e){if(this._assertWriterUsedCorrectly(),"string"==typeof e)this._removeSelectionAttribute(e);else for(const t of e)this._removeSelectionAttribute(t);}overrideSelectionGravity(){return this.model.document.selection._overrideGravity()}restoreSelectionGravity(e){this.model.document.selection._restoreGravity(e);}_setSelectionAttribute(e,t){const i=this.model.document.selection;if(i.isCollapsed&&i.anchor.parent.isEmpty){const n=Sd._getStoreAttributeKey(e);this.setAttribute(n,t,i.anchor.parent);}i._setAttribute(e,t);}_removeSelectionAttribute(e){const t=this.model.document.selection;if(t.isCollapsed&&t.anchor.parent.isEmpty){const i=Sd._getStoreAttributeKey(e);this.removeAttribute(i,t.anchor.parent);}t._removeAttribute(e);}_assertWriterUsedCorrectly(){if(this.model._currentWriter!==this)throw new E("writer-incorrect-use",this)}_addOperationForAffectedMarkers(e,t){for(const i of this.model.markers){if(!i.managedUsingOperations)continue;const n=i.getRange();let s=!1;if("move"===e){const e=t;s=e.containsPosition(n.start)||e.start.isEqual(n.start)||e.containsPosition(n.end)||e.end.isEqual(n.end);}else {const e=t,i=e.nodeBefore,o=e.nodeAfter,r=n.start.parent==i&&n.start.isAtEnd,a=n.end.parent==o&&0==n.end.offset,l=n.end.nodeAfter==o,c=n.start.nodeAfter==o;s=r||a||l||c;}s&&this.updateMarker(i.name,{range:n});}}}function Vu(e,t,i,n){const s=e.model,o=s.document;let r,a,l,c=n.start;for(const e of n.getWalker({shallow:!0}))l=e.item.getAttribute(t),r&&a!=l&&(a!=i&&d(),c=r),r=e.nextPosition,a=l;function d(){const n=new dd(c,r),l=n.root.document?o.version:null,d=new Kh(n,t,a,i,l);e.batch.addOperation(d),s.applyOperation(d);}r instanceof sd&&r!=c&&a!=i&&d();}function Ru(e,t,i,n){const s=e.model,o=s.document,r=n.getAttribute(t);let a,l;if(r!=i){if(n.root===n){const e=n.document?o.version:null;l=new Qh(n,t,r,i,e);}else {a=new dd(sd._createBefore(n),e.createPositionAfter(n));const s=a.root.document?o.version:null;l=new Kh(a,t,r,i,s);}e.batch.addOperation(l),s.applyOperation(l);}}function Bu(e,t,i,n,s){const o=e.model,r=o.document,a=new Gh(t,i,n,o.markers,!!s,r.version);e.batch.addOperation(a),o.applyOperation(a);}function Ou(e,t,i,n){let s;if(e.root.document){const i=n.document,o=new sd(i.graveyard,[0]);s=new Uh(e,t,o,i.version);}else s=new Su(e,t);i.addOperation(s),n.applyOperation(s);}function Mu(e,t){return e===t||e instanceof ku&&t instanceof ku}function Lu(e,t,i={}){if(t.isCollapsed)return;const n=t.getFirstRange();if("$graveyard"==n.root.rootName)return;const s=e.schema;e.change((e=>{if(!i.doNotResetEntireContent&&function(e,t){const i=e.getLimitElement(t);if(!t.containsEntireContent(i))return !1;const n=t.getFirstRange();if(n.start.parent==n.end.parent)return !1;return e.checkChild(i,"paragraph")}(s,t))return void function(e,t){const i=e.model.schema.getLimitElement(t);e.remove(e.createRangeIn(i)),zu(e,e.createPositionAt(i,0),t);}(e,t);const o={};if(!i.doNotAutoparagraph){const e=t.getSelectedElement();e&&Object.assign(o,s.getAttributesWithProperty(e,"copyOnReplace",!0));}const[r,a]=function(e){const t=e.root.document.model,i=e.start;let n=e.end;if(t.hasContent(e,{ignoreMarkers:!0})){const i=function(e){const t=e.parent,i=t.root.document.model.schema,n=t.getAncestors({parentFirst:!0,includeSelf:!0});for(const e of n){if(i.isLimit(e))return null;if(i.isBlock(e))return e}}(n);if(i&&n.isTouching(t.createPositionAt(i,0))){const i=t.createSelection(e);t.modifySelection(i,{direction:"backward"});const s=i.getLastPosition(),o=t.createRange(s,n);t.hasContent(o,{ignoreMarkers:!0})||(n=s);}}return [uu.fromPosition(i,"toPrevious"),uu.fromPosition(n,"toNext")]}(n);r.isTouching(a)||e.remove(e.createRange(r,a)),i.leaveUnmerged||(!function(e,t,i){const n=e.model;if(!Du(e.model.schema,t,i))return;const[s,o]=function(e,t){const i=e.getAncestors(),n=t.getAncestors();let s=0;for(;i[s]&&i[s]==n[s];)s++;return [i[s],n[s]]}(t,i);if(!s||!o)return;!n.hasContent(s,{ignoreMarkers:!0})&&n.hasContent(o,{ignoreMarkers:!0})?Nu(e,t,i,s.parent):Fu(e,t,i,s.parent);}(e,r,a),s.removeDisallowedAttributes(r.parent.getChildren(),e)),Hu(e,t,r),!i.doNotAutoparagraph&&function(e,t){const i=e.checkChild(t,"$text"),n=e.checkChild(t,"paragraph");return !i&&n}(s,r)&&zu(e,r,t,o),r.detach(),a.detach();}));}function Fu(e,t,i,n){const s=t.parent,o=i.parent;if(s!=n&&o!=n){for(t=e.createPositionAfter(s),(i=e.createPositionBefore(o)).isEqual(t)||e.insert(o,t),e.merge(t);i.parent.isEmpty;){const t=i.parent;i=e.createPositionBefore(t),e.remove(t);}Du(e.model.schema,t,i)&&Fu(e,t,i,n);}}function Nu(e,t,i,n){const s=t.parent,o=i.parent;if(s!=n&&o!=n){for(t=e.createPositionAfter(s),(i=e.createPositionBefore(o)).isEqual(t)||e.insert(s,i);t.parent.isEmpty;){const i=t.parent;t=e.createPositionBefore(i),e.remove(i);}i=e.createPositionBefore(o),function(e,t){const i=t.nodeBefore,n=t.nodeAfter;i.name!=n.name&&e.rename(i,n.name);e.clearAttributes(i),e.setAttributes(Object.fromEntries(n.getAttributes()),i),e.merge(t);}(e,i),Du(e.model.schema,t,i)&&Nu(e,t,i,n);}}function Du(e,t,i){const n=t.parent,s=i.parent;return n!=s&&(!e.isLimit(n)&&!e.isLimit(s)&&function(e,t,i){const n=new dd(e,t);for(const e of n.getWalker())if(i.isLimit(e.item))return !1;return !0}(t,i,e))}function zu(e,t,i,n={}){const s=e.createElement("paragraph");e.model.schema.setAllowedAttributes(s,n,e),e.insert(s,t),Hu(e,i,e.createPositionAt(s,0));}function Hu(e,t,i){t instanceof Sd?e.setSelection(i):t.setTo(i);}function $u(e,t){const i=[];Array.from(e.getItems({direction:"backward"})).map((e=>t.createRangeOn(e))).filter((t=>(t.start.isAfter(e.start)||t.start.isEqual(e.start))&&(t.end.isBefore(e.end)||t.end.isEqual(e.end)))).forEach((e=>{i.push(e.start.parent),t.remove(e);})),i.forEach((e=>{let i=e;for(;i.parent&&i.isEmpty;){const e=t.createRangeOn(i);i=i.parent,t.remove(e);}}));}class Uu{model;writer;position;canMergeWith;schema;_documentFragment;_documentFragmentPosition;_firstNode=null;_lastNode=null;_lastAutoParagraph=null;_filterAttributesOf=[];_affectedStart=null;_affectedEnd=null;_nodeToSelect=null;constructor(e,t,i){this.model=e,this.writer=t,this.position=i,this.canMergeWith=new Set([this.position.parent]),this.schema=e.schema,this._documentFragment=t.createDocumentFragment(),this._documentFragmentPosition=t.createPositionAt(this._documentFragment,0);}handleNodes(e){for(const t of Array.from(e))this._handleNode(t);this._insertPartialFragment(),this._lastAutoParagraph&&this._updateLastNodeFromAutoParagraph(this._lastAutoParagraph),this._mergeOnRight(),this.schema.removeDisallowedAttributes(this._filterAttributesOf,this.writer),this._filterAttributesOf=[];}_updateLastNodeFromAutoParagraph(e){const t=this.writer.createPositionAfter(this._lastNode),i=this.writer.createPositionAfter(e);if(i.isAfter(t)){if(this._lastNode=e,this.position.parent!=e||!this.position.isAtEnd)throw new E("insertcontent-invalid-insertion-position",this);this.position=i,this._setAffectedBoundaries(this.position);}}getSelectionRange(){return this._nodeToSelect?dd._createOn(this._nodeToSelect):this.model.schema.getNearestSelectionRange(this.position)}getAffectedRange(){return this._affectedStart?new dd(this._affectedStart,this._affectedEnd):null}destroy(){this._affectedStart&&this._affectedStart.detach(),this._affectedEnd&&this._affectedEnd.detach();}_handleNode(e){this._checkAndSplitToAllowedPosition(e)?(this._appendToFragment(e),this._firstNode||(this._firstNode=e),this._lastNode=e):this.schema.isObject(e)||this._handleDisallowedNode(e);}_insertPartialFragment(){if(this._documentFragment.isEmpty)return;const e=uu.fromPosition(this.position,"toNext");this._setAffectedBoundaries(this.position),this._documentFragment.getChild(0)==this._firstNode&&(this.writer.insert(this._firstNode,this.position),this._mergeOnLeft(),this.position=e.toPosition()),this._documentFragment.isEmpty||this.writer.insert(this._documentFragment,this.position),this._documentFragmentPosition=this.writer.createPositionAt(this._documentFragment,0),this.position=e.toPosition(),e.detach();}_handleDisallowedNode(e){e.is("element")&&this.handleNodes(e.getChildren());}_appendToFragment(e){if(!this.schema.checkChild(this.position,e))throw new E("insertcontent-wrong-position",this,{node:e,position:this.position});this.writer.insert(e,this._documentFragmentPosition),this._documentFragmentPosition=this._documentFragmentPosition.getShiftedBy(e.offsetSize),this.schema.isObject(e)&&!this.schema.checkChild(this.position,"$text")?this._nodeToSelect=e:this._nodeToSelect=null,this._filterAttributesOf.push(e);}_setAffectedBoundaries(e){this._affectedStart||(this._affectedStart=uu.fromPosition(e,"toPrevious")),this._affectedEnd&&!this._affectedEnd.isBefore(e)||(this._affectedEnd&&this._affectedEnd.detach(),this._affectedEnd=uu.fromPosition(e,"toNext"));}_mergeOnLeft(){const e=this._firstNode;if(!(e instanceof td))return;if(!this._canMergeLeft(e))return;const t=uu._createBefore(e);t.stickiness="toNext";const i=uu.fromPosition(this.position,"toNext");this._affectedStart.isEqual(t)&&(this._affectedStart.detach(),this._affectedStart=uu._createAt(t.nodeBefore,"end","toPrevious")),this._firstNode===this._lastNode&&(this._firstNode=t.nodeBefore,this._lastNode=t.nodeBefore),this.writer.merge(t),t.isEqual(this._affectedEnd)&&this._firstNode===this._lastNode&&(this._affectedEnd.detach(),this._affectedEnd=uu._createAt(t.nodeBefore,"end","toNext")),this.position=i.toPosition(),i.detach(),this._filterAttributesOf.push(this.position.parent),t.detach();}_mergeOnRight(){const e=this._lastNode;if(!(e instanceof td))return;if(!this._canMergeRight(e))return;const t=uu._createAfter(e);if(t.stickiness="toNext",!this.position.isEqual(t))throw new E("insertcontent-invalid-insertion-position",this);this.position=sd._createAt(t.nodeBefore,"end");const i=uu.fromPosition(this.position,"toPrevious");this._affectedEnd.isEqual(t)&&(this._affectedEnd.detach(),this._affectedEnd=uu._createAt(t.nodeBefore,"end","toNext")),this._firstNode===this._lastNode&&(this._firstNode=t.nodeBefore,this._lastNode=t.nodeBefore),this.writer.merge(t),t.getShiftedBy(-1).isEqual(this._affectedStart)&&this._firstNode===this._lastNode&&(this._affectedStart.detach(),this._affectedStart=uu._createAt(t.nodeBefore,0,"toPrevious")),this.position=i.toPosition(),i.detach(),this._filterAttributesOf.push(this.position.parent),t.detach();}_canMergeLeft(e){const t=e.previousSibling;return t instanceof td&&this.canMergeWith.has(t)&&this.model.schema.checkMerge(t,e)}_canMergeRight(e){const t=e.nextSibling;return t instanceof td&&this.canMergeWith.has(t)&&this.model.schema.checkMerge(e,t)}_insertAutoParagraph(){this._insertPartialFragment();const e=this.writer.createElement("paragraph");this.writer.insert(e,this.position),this._setAffectedBoundaries(this.position),this._lastAutoParagraph=e,this.position=this.writer.createPositionAt(e,0);}_checkAndSplitToAllowedPosition(e){const t=this._getAllowedIn(this.position.parent,e);if(!t)return !1;for(t!=this.position.parent&&this._insertPartialFragment();t!=this.position.parent;)if(this.position.isAtStart){const e=this.position.parent;this.position=this.writer.createPositionBefore(e),e.isEmpty&&e.parent===t&&this.writer.remove(e);}else if(this.position.isAtEnd)this.position=this.writer.createPositionAfter(this.position.parent);else {const e=this.writer.createPositionAfter(this.position.parent);this._setAffectedBoundaries(this.position),this.writer.split(this.position),this.position=e,this.canMergeWith.add(this.position.nodeAfter);}return this.schema.checkChild(this.position.parent,e)||this._insertAutoParagraph(),!0}_getAllowedIn(e,t){return this.schema.checkChild(e,t)||this.schema.checkChild(e,"paragraph")&&this.schema.checkChild("paragraph",t)?e:this.schema.isLimit(e)?null:this._getAllowedIn(e.parent,t)}}function Wu(e,t,i,n={}){if(!e.schema.isObject(t))throw new E("insertobject-element-not-an-object",e,{object:t});const s=i||e.document.selection;let o=s;n.findOptimalPosition&&e.schema.isBlock(t)&&(o=e.createSelection(e.schema.findOptimalInsertionRange(s,n.findOptimalPosition)));const r=Ia(s.getSelectedBlocks()),a={};return r&&Object.assign(a,e.schema.getAttributesWithProperty(r,"copyOnReplace",!0)),e.change((i=>{o.isCollapsed||e.deleteContent(o,{doNotAutoparagraph:!0});let s=t;const r=o.anchor.parent;!e.schema.checkChild(r,t)&&e.schema.checkChild(r,"paragraph")&&e.schema.checkChild("paragraph",t)&&(s=i.createElement("paragraph"),i.insert(t,s)),e.schema.setAllowedAttributes(s,a,i);const l=e.insertContent(s,o);return l.isCollapsed||n.setSelection&&function(e,t,i,n){const s=e.model;if("on"==i)return void e.setSelection(t,"on");if("after"!=i)throw new E("insertobject-invalid-place-parameter-value",s);let o=t.nextSibling;if(s.schema.isInline(t))return void e.setSelection(t,"after");const r=o&&s.schema.checkChild(o,"$text");!r&&s.schema.checkChild(t.parent,"paragraph")&&(o=e.createElement("paragraph"),s.schema.setAllowedAttributes(o,n,e),s.insertContent(o,e.createPositionAfter(t)));o&&e.setSelection(o,0);}(i,t,n.setSelection,a),l}))}const ju=' ,.?!:;"-()';function qu(e,t){const{isForward:i,walker:n,unit:s,schema:o,treatEmojiAsSingleUnit:r}=e,{type:a,item:l,nextPosition:c}=t;if("text"==a)return "word"===e.unit?function(e,t){let i=e.position.textNode;i||(i=t?e.position.nodeAfter:e.position.nodeBefore);for(;i&&i.is("$text");){const n=e.position.offset-i.startOffset;if(Zu(i,n,t))i=t?e.position.nodeAfter:e.position.nodeBefore;else {if(Ku(i.data,n,t))break;e.next();}}return e.position}(n,i):function(e,t,i){const n=e.position.textNode;if(n){const s=n.data;let o=e.position.offset-n.startOffset;for(;$a(s,o)||"character"==t&&Ua(s,o)||i&&ja(s,o);)e.next(),o=e.position.offset-n.startOffset;}return e.position}(n,s,r);if(a==(i?"elementStart":"elementEnd")){if(o.isSelectable(l))return sd._createAt(l,i?"after":"before");if(o.checkChild(c,"$text"))return c}else {if(o.isLimit(l))return void n.skip((()=>!0));if(o.checkChild(c,"$text"))return c}}function Gu(e,t){const i=e.root,n=sd._createAt(i,t?"end":0);return t?new dd(e,n):new dd(n,e)}function Ku(e,t,i){const n=t+(i?0:-1);return ju.includes(e.charAt(n))}function Zu(e,t,i){return t===(i?e.offsetSize:0)}let Ju=class extends(ar()){markers;document;schema;_pendingChanges;_currentWriter;constructor(){super(),this.markers=new Eu,this.document=new xu(this),this.schema=new uh,this._pendingChanges=[],this._currentWriter=null,["deleteContent","modifySelection","getSelectedContent","applyOperation"].forEach((e=>this.decorate(e))),this.on("applyOperation",((e,t)=>{t[0]._validate();}),{priority:"highest"}),this.schema.register("$root",{isLimit:!0}),this.schema.register("$container",{allowIn:["$root","$container"]}),this.schema.register("$block",{allowIn:["$root","$container"],isBlock:!0}),this.schema.register("$blockObject",{allowWhere:"$block",isBlock:!0,isObject:!0}),this.schema.register("$inlineObject",{allowWhere:"$text",allowAttributesOf:"$text",isInline:!0,isObject:!0}),this.schema.register("$text",{allowIn:"$block",isInline:!0,isContent:!0}),this.schema.register("$clipboardHolder",{allowContentOf:"$root",allowChildren:"$text",isLimit:!0}),this.schema.register("$documentFragment",{allowContentOf:"$root",allowChildren:"$text",isLimit:!0}),this.schema.register("$marker"),this.schema.addChildCheck((()=>!0),"$marker"),sh(this),this.document.registerPostFixer(Kd),this.on("insertContent",((e,[t,i])=>{e.return=function(e,t,i){return e.change((n=>{const s=i||e.document.selection;s.isCollapsed||e.deleteContent(s,{doNotAutoparagraph:!0});const o=new Uu(e,n,s.anchor),r=[];let a;if(t.is("documentFragment")){if(t.markers.size){const e=[];for(const[i,n]of t.markers){const{start:t,end:s}=n,o=t.isEqual(s);e.push({position:t,name:i,isCollapsed:o},{position:s,name:i,isCollapsed:o});}e.sort((({position:e},{position:t})=>e.isBefore(t)?1:-1));for(const{position:i,name:s,isCollapsed:o}of e){let e=null,a=null;const l=i.parent===t&&i.isAtStart,c=i.parent===t&&i.isAtEnd;l||c?o&&(a=l?"start":"end"):(e=n.createElement("$marker"),n.insert(e,i)),r.push({name:s,element:e,collapsed:a});}}a=t.getChildren();}else a=[t];o.handleNodes(a);let l=o.getSelectionRange();if(t.is("documentFragment")&&r.length){const e=l?xd.fromRange(l):null,t={};for(let e=r.length-1;e>=0;e--){const{name:i,element:s,collapsed:a}=r[e],l=!t[i];if(l&&(t[i]=[]),s){const e=n.createPositionAt(s,"before");t[i].push(e),n.remove(s);}else {const e=o.getAffectedRange();if(!e){a&&t[i].push(o.position);continue}a?t[i].push(e[a]):t[i].push(l?e.start:e.end);}}for(const[e,[i,s]]of Object.entries(t))i&&s&&i.root===s.root&&i.root.document&&!n.model.markers.has(e)&&n.addMarker(e,{usingOperation:!0,affectsData:!0,range:new dd(i,s)});e&&(l=e.toRange(),e.detach());}l&&(s instanceof Sd?n.setSelection(l):s.setTo(l));const c=o.getAffectedRange()||e.createRange(s.anchor);return o.destroy(),c}))}(this,t,i);})),this.on("insertObject",((e,[t,i,n])=>{e.return=Wu(this,t,i,n);})),this.on("canEditAt",(e=>{const t=!this.document.isReadOnly;e.return=t,t||e.stop();}));}change(e){try{return 0===this._pendingChanges.length?(this._pendingChanges.push({batch:new fu,callback:e}),this._runPendingChanges()[0]):e(this._currentWriter)}catch(e){E.rethrowUnexpectedError(e,this);}}enqueueChange(e,t){try{e?"function"==typeof e?(t=e,e=new fu):e instanceof fu||(e=new fu(e)):e=new fu,this._pendingChanges.push({batch:e,callback:t}),1==this._pendingChanges.length&&this._runPendingChanges();}catch(e){E.rethrowUnexpectedError(e,this);}}applyOperation(e){e._execute();}insertContent(e,t,i,...n){const s=Qu(t,i);return this.fire("insertContent",[e,s,i,...n])}insertObject(e,t,i,n,...s){const o=Qu(t,i);return this.fire("insertObject",[e,o,n,n,...s])}deleteContent(e,t){Lu(this,e,t);}modifySelection(e,t){!function(e,t,i={}){const n=e.schema,s="backward"!=i.direction,o=i.unit?i.unit:"character",r=!!i.treatEmojiAsSingleUnit,a=t.focus,l=new id({boundaries:Gu(a,s),singleCharacters:!0,direction:s?"forward":"backward"}),c={walker:l,schema:n,isForward:s,unit:o,treatEmojiAsSingleUnit:r};let d;for(;d=l.next();){if(d.done)return;const i=qu(c,d.value);if(i)return void(t instanceof Sd?e.change((e=>{e.setSelectionFocus(i);})):t.setFocus(i))}}(this,e,t);}getSelectedContent(e){return function(e,t){return e.change((e=>{const i=e.createDocumentFragment(),n=t.getFirstRange();if(!n||n.isCollapsed)return i;const s=n.start.root,o=n.start.getCommonPath(n.end),r=s.getNodeByPath(o);let a;a=n.start.parent==n.end.parent?n:e.createRange(e.createPositionAt(r,n.start.path[o.length]),e.createPositionAt(r,n.end.path[o.length]+1));const l=a.end.offset-a.start.offset;for(const t of a.getItems({shallow:!0}))t.is("$textProxy")?e.appendText(t.data,t.getAttributes(),i):e.append(e.cloneElement(t,!0),i);if(a!=n){const t=n._getTransformedByMove(a.start,e.createPositionAt(i,0),l)[0],s=e.createRange(e.createPositionAt(i,0),t.start);$u(e.createRange(t.end,e.createPositionAt(i,"end")),e),$u(s,e);}return i}))}(this,e)}hasContent(e,t={}){const i=e instanceof dd?e:dd._createIn(e);if(i.isCollapsed)return !1;const{ignoreWhitespaces:n=!1,ignoreMarkers:s=!1}=t;if(!s)for(const e of this.markers.getMarkersIntersectingRange(i))if(e.affectsData)return !0;for(const e of i.getItems())if(this.schema.isContent(e)){if(!e.is("$textProxy"))return !0;if(!n)return !0;if(-1!==e.data.search(/\S/))return !0}return !1}canEditAt(e){const t=Qu(e);return this.fire("canEditAt",[t])}createPositionFromPath(e,t,i){return new sd(e,t,i)}createPositionAt(e,t){return sd._createAt(e,t)}createPositionAfter(e){return sd._createAfter(e)}createPositionBefore(e){return sd._createBefore(e)}createRange(e,t){return new dd(e,t)}createRangeIn(e){return dd._createIn(e)}createRangeOn(e){return dd._createOn(e)}createSelection(...e){return new bd(...e)}createBatch(e){return new fu(e)}createOperationFromJSON(e){return eu.fromJSON(e,this.document)}destroy(){this.document.destroy(),this.stopListening();}_runPendingChanges(){const e=[];this.fire("_beforeChanges");try{for(;this._pendingChanges.length;){const t=this._pendingChanges[0].batch;this._currentWriter=new Pu(this,t);const i=this._pendingChanges[0].callback(this._currentWriter);e.push(i),this.document._handleChangeBlock(this._currentWriter),this._pendingChanges.shift(),this._currentWriter=null;}}finally{this._pendingChanges.length=0,this._currentWriter=null,this.fire("_afterChanges");}return e}};function Qu(e,t){if(e)return e instanceof bd||e instanceof Sd?e:e instanceof Qc?t||0===t?new bd(e,t):e.is("rootElement")?new bd(e,"in"):new bd(e,"on"):new bd(e)}class Yu extends Lc{domEventType="click";onDomEvent(e){this.fire(e.type,e);}}class Xu extends Lc{domEventType=["mousedown","mouseup","mouseover","mouseout"];onDomEvent(e){this.fire(e.type,e);}}class em{document;constructor(e){this.document=e;}createDocumentFragment(e){return new Xl(this.document,e)}createElement(e,t,i){return new kl(this.document,e,t,i)}createText(e){return new ml(this.document,e)}clone(e,t=!1){return e._clone(t)}appendChild(e,t){return t._appendChild(e)}insertChild(e,t,i){return i._insertChild(e,t)}removeChildren(e,t,i){return i._removeChildren(e,t)}remove(e){const t=e.parent;return t?this.removeChildren(t.getChildIndex(e),1,t):[]}replace(e,t){const i=e.parent;if(i){const n=i.getChildIndex(e);return this.removeChildren(n,1,i),this.insertChild(n,t,i),!0}return !1}unwrapElement(e){const t=e.parent;if(t){const i=t.getChildIndex(e);this.remove(e),this.insertChild(i,e.getChildren(),t);}}rename(e,t){const i=new kl(this.document,e,t.getAttributes(),t.getChildren());return this.replace(t,i)?i:null}setAttribute(e,t,i){i._setAttribute(e,t);}removeAttribute(e,t){t._removeAttribute(e);}addClass(e,t){t._addClass(e);}removeClass(e,t){t._removeClass(e);}setStyle(e,t,i){fi(e)&&void 0===i?t._setStyle(e):i._setStyle(e,t);}removeStyle(e,t){t._removeStyle(e);}setCustomProperty(e,t,i){i._setCustomProperty(e,t);}removeCustomProperty(e,t){return t._removeCustomProperty(e)}createPositionAt(e,t){return Pl._createAt(e,t)}createPositionAfter(e){return Pl._createAfter(e)}createPositionBefore(e){return Pl._createBefore(e)}createRange(e,t){return new Vl(e,t)}createRangeOn(e){return Vl._createOn(e)}createRangeIn(e){return Vl._createIn(e)}createSelection(...e){return new Bl(...e)}}class lg{crashes=[];state="initializing";_crashNumberLimit;_now=Date.now;_minimumNonErrorTimePeriod;_boundErrorHandler;_listeners;constructor(e){if(this.crashes=[],this._crashNumberLimit="number"==typeof e.crashNumberLimit?e.crashNumberLimit:3,this._minimumNonErrorTimePeriod="number"==typeof e.minimumNonErrorTimePeriod?e.minimumNonErrorTimePeriod:5e3,this._boundErrorHandler=e=>{const t="error"in e?e.error:e.reason;t instanceof Error&&this._handleError(t,e);},this._listeners={},!this._restart)throw new Error("The Watchdog class was split into the abstract `Watchdog` class and the `EditorWatchdog` class. Please, use `EditorWatchdog` if you have used the `Watchdog` class previously.")}destroy(){this._stopErrorHandling(),this._listeners={};}on(e,t){this._listeners[e]||(this._listeners[e]=[]),this._listeners[e].push(t);}off(e,t){this._listeners[e]=this._listeners[e].filter((e=>e!==t));}_fire(e,...t){const i=this._listeners[e]||[];for(const e of i)e.apply(this,[null,...t]);}_startErrorHandling(){window.addEventListener("error",this._boundErrorHandler),window.addEventListener("unhandledrejection",this._boundErrorHandler);}_stopErrorHandling(){window.removeEventListener("error",this._boundErrorHandler),window.removeEventListener("unhandledrejection",this._boundErrorHandler);}_handleError(e,t){if(this._shouldReactToError(e)){this.crashes.push({message:e.message,stack:e.stack,filename:t instanceof ErrorEvent?t.filename:void 0,lineno:t instanceof ErrorEvent?t.lineno:void 0,colno:t instanceof ErrorEvent?t.colno:void 0,date:this._now()});const i=this._shouldRestart();this.state="crashed",this._fire("stateChange"),this._fire("error",{error:e,causesRestart:i}),i?this._restart():(this.state="crashedPermanently",this._fire("stateChange"));}}_shouldReactToError(e){return e.is&&e.is("CKEditorError")&&void 0!==e.context&&null!==e.context&&"ready"===this.state&&this._isErrorComingFromThisItem(e)}_shouldRestart(){if(this.crashes.length<=this._crashNumberLimit)return !0;return (this.crashes[this.crashes.length-1].date-this.crashes[this.crashes.length-1-this._crashNumberLimit].date)/this._crashNumberLimit>this._minimumNonErrorTimePeriod}}function cg(e,t=new Set){const i=[e],n=new Set;let s=0;for(;i.length>s;){const e=i[s++];if(!n.has(e)&&dg(e)&&!t.has(e))if(n.add(e),Symbol.iterator in e)try{for(const t of e)i.push(t);}catch(e){}else for(const t in e)"defaultValue"!==t&&i.push(e[t]);}return n}function dg(e){const t=Object.prototype.toString.call(e),i=typeof e;return !("number"===i||"boolean"===i||"string"===i||"symbol"===i||"function"===i||"[object Date]"===t||"[object RegExp]"===t||"[object Module]"===t||null==e||e._watchdogExcluded||e instanceof EventTarget||e instanceof Event)}function hg(e,t,i=new Set){if(e===t&&("object"==typeof(n=e)&&null!==n))return !0;var n;const s=cg(e,i),o=cg(t,i);for(const e of s)if(o.has(e))return !0;return !1}class ug extends lg{_editor=null;_lifecyclePromise=null;_throttledSave;_data;_lastDocumentVersion;_elementOrData;_initUsingData=!0;_editables={};_config;_excludedProps;constructor(e,t={}){super(t),this._throttledSave=er(this._save.bind(this),"number"==typeof t.saveInterval?t.saveInterval:5e3),e&&(this._creator=(t,i)=>e.create(t,i)),this._destructor=e=>e.destroy();}get editor(){return this._editor}get _item(){return this._editor}setCreator(e){this._creator=e;}setDestructor(e){this._destructor=e;}_restart(){return Promise.resolve().then((()=>(this.state="initializing",this._fire("stateChange"),this._destroy()))).catch((e=>{console.error("An error happened during the editor destroying.",e);})).then((()=>{const e={},t=[],i=this._config.rootsAttributes||{},n={};for(const[s,o]of Object.entries(this._data.roots))o.isLoaded?(e[s]="",n[s]=i[s]||{}):t.push(s);const s={...this._config,extraPlugins:this._config.extraPlugins||[],lazyRoots:t,rootsAttributes:n,_watchdogInitialData:this._data};return delete s.initialData,s.extraPlugins.push(mg),this._initUsingData?this.create(e,s,s.context):Go(this._elementOrData)?this.create(this._elementOrData,s,s.context):this.create(this._editables,s,s.context)})).then((()=>{this._fire("restart");}))}create(e=this._elementOrData,t=this._config,i){return this._lifecyclePromise=Promise.resolve(this._lifecyclePromise).then((()=>(super._startErrorHandling(),this._elementOrData=e,this._initUsingData="string"==typeof e||Object.keys(e).length>0&&"string"==typeof Object.values(e)[0],this._config=this._cloneEditorConfiguration(t)||{},this._config.context=i,this._creator(e,this._config)))).then((e=>{this._editor=e,e.model.document.on("change:data",this._throttledSave),this._lastDocumentVersion=e.model.document.version,this._data=this._getData(),this._initUsingData||(this._editables=this._getEditables()),this.state="ready",this._fire("stateChange");})).finally((()=>{this._lifecyclePromise=null;})),this._lifecyclePromise}destroy(){return this._lifecyclePromise=Promise.resolve(this._lifecyclePromise).then((()=>(this.state="destroyed",this._fire("stateChange"),super.destroy(),this._destroy()))).finally((()=>{this._lifecyclePromise=null;})),this._lifecyclePromise}_destroy(){return Promise.resolve().then((()=>{this._stopErrorHandling(),this._throttledSave.cancel();const e=this._editor;return this._editor=null,e.model.document.off("change:data",this._throttledSave),this._destructor(e)}))}_save(){const e=this._editor.model.document.version;try{this._data=this._getData(),this._initUsingData||(this._editables=this._getEditables()),this._lastDocumentVersion=e;}catch(e){console.error(e,"An error happened during restoring editor data. Editor will be restored from the previously saved data.");}}_setExcludedProperties(e){this._excludedProps=e;}_getData(){const e=this._editor,t=e.model.document.roots.filter((e=>e.isAttached()&&"$graveyard"!=e.rootName)),{plugins:i}=e,n=i.has("CommentsRepository")&&i.get("CommentsRepository"),s=i.has("TrackChanges")&&i.get("TrackChanges"),o={roots:{},markers:{},commentThreads:JSON.stringify([]),suggestions:JSON.stringify([])};t.forEach((e=>{o.roots[e.rootName]={content:JSON.stringify(Array.from(e.getChildren())),attributes:JSON.stringify(Array.from(e.getAttributes())),isLoaded:e._isLoaded};}));for(const t of e.model.markers)t._affectsData&&(o.markers[t.name]={rangeJSON:t.getRange().toJSON(),usingOperation:t._managedUsingOperations,affectsData:t._affectsData});return n&&(o.commentThreads=JSON.stringify(n.getCommentThreads({toJSON:!0,skipNotAttached:!0}))),s&&(o.suggestions=JSON.stringify(s.getSuggestions({toJSON:!0,skipNotAttached:!0}))),o}_getEditables(){const e={};for(const t of this.editor.model.document.getRootNames()){const i=this.editor.ui.getEditableElement(t);i&&(e[t]=i);}return e}_isErrorComingFromThisItem(e){return hg(this._editor,e.context,this._excludedProps)}_cloneEditorConfiguration(e){return Rs(e,((e,t)=>Go(e)||"context"===t?e:void 0))}}class mg{editor;_data;constructor(e){this.editor=e,this._data=e.config.get("_watchdogInitialData");}init(){this.editor.data.on("init",(e=>{e.stop(),this.editor.model.enqueueChange({isUndoable:!1},(e=>{this._restoreCollaborationData(),this._restoreEditorData(e);})),this.editor.data.fire("ready");}),{priority:999});}_createNode(e,t){if("name"in t){const i=e.createElement(t.name,t.attributes);if(t.children)for(const n of t.children)i._appendChild(this._createNode(e,n));return i}return e.createText(t.data,t.attributes)}_restoreEditorData(e){const t=this.editor;Object.entries(this._data.roots).forEach((([i,{content:n,attributes:s}])=>{const o=JSON.parse(n),r=JSON.parse(s),a=t.model.document.getRoot(i);for(const[t,i]of r)e.setAttribute(t,i,a);for(const t of o){const i=this._createNode(e,t);e.insert(i,a,"end");}})),Object.entries(this._data.markers).forEach((([i,n])=>{const{document:s}=t.model,{rangeJSON:{start:o,end:r},...a}=n,l=s.getRoot(o.root),c=e.createPositionFromPath(l,o.path,o.stickiness),d=e.createPositionFromPath(l,r.path,r.stickiness),h=e.createRange(c,d);e.addMarker(i,{range:h,...a});}));}_restoreCollaborationData(){const e=JSON.parse(this._data.commentThreads),t=JSON.parse(this._data.suggestions);e.forEach((e=>{const t=this.editor.config.get("collaboration.channelId"),i=this.editor.plugins.get("CommentsRepository");if(i.hasCommentThread(e.threadId)){i.getCommentThread(e.threadId).remove();}i.addCommentThread({channelId:t,...e});})),t.forEach((e=>{const t=this.editor.plugins.get("TrackChangesEditing");if(t.hasSuggestion(e.id)){t.getSuggestion(e.id).attributes=e.attributes;}else t.addSuggestionData(e);}));}}const gg=Symbol("MainQueueId");class fg extends lg{_watchdogs=new Map;_watchdogConfig;_context=null;_contextProps=new Set;_actionQueues=new pg;_contextConfig;_item;constructor(e,t={}){super(t),this._watchdogConfig=t,this._creator=t=>e.create(t),this._destructor=e=>e.destroy(),this._actionQueues.onEmpty((()=>{"initializing"===this.state&&(this.state="ready",this._fire("stateChange"));}));}setCreator(e){this._creator=e;}setDestructor(e){this._destructor=e;}get context(){return this._context}create(e={}){return this._actionQueues.enqueue(gg,(()=>(this._contextConfig=e,this._create())))}getItem(e){return this._getWatchdog(e)._item}getItemState(e){return this._getWatchdog(e).state}add(e){const t=bg(e);return Promise.all(t.map((e=>this._actionQueues.enqueue(e.id,(()=>{if("destroyed"===this.state)throw new Error("Cannot add items to destroyed watchdog.");if(!this._context)throw new Error("Context was not created yet. You should call the `ContextWatchdog#create()` method first.");let t;if(this._watchdogs.has(e.id))throw new Error(`Item with the given id is already added: '${e.id}'.`);if("editor"===e.type)return t=new ug(null,this._watchdogConfig),t.setCreator(e.creator),t._setExcludedProperties(this._contextProps),e.destructor&&t.setDestructor(e.destructor),this._watchdogs.set(e.id,t),t.on("error",((i,{error:n,causesRestart:s})=>{this._fire("itemError",{itemId:e.id,error:n}),s&&this._actionQueues.enqueue(e.id,(()=>new Promise((i=>{const n=()=>{t.off("restart",n),this._fire("itemRestart",{itemId:e.id}),i();};t.on("restart",n);}))));})),t.create(e.sourceElementOrData,e.config,this._context);throw new Error(`Not supported item type: '${e.type}'.`)})))))}remove(e){const t=bg(e);return Promise.all(t.map((e=>this._actionQueues.enqueue(e,(()=>{const t=this._getWatchdog(e);return this._watchdogs.delete(e),t.destroy()})))))}destroy(){return this._actionQueues.enqueue(gg,(()=>(this.state="destroyed",this._fire("stateChange"),super.destroy(),this._destroy())))}_restart(){return this._actionQueues.enqueue(gg,(()=>(this.state="initializing",this._fire("stateChange"),this._destroy().catch((e=>{console.error("An error happened during destroying the context or items.",e);})).then((()=>this._create())).then((()=>this._fire("restart"))))))}_create(){return Promise.resolve().then((()=>(this._startErrorHandling(),this._creator(this._contextConfig)))).then((e=>(this._context=e,this._contextProps=cg(this._context),Promise.all(Array.from(this._watchdogs.values()).map((e=>(e._setExcludedProperties(this._contextProps),e.create(void 0,void 0,this._context))))))))}_destroy(){return Promise.resolve().then((()=>{this._stopErrorHandling();const e=this._context;return this._context=null,this._contextProps=new Set,Promise.all(Array.from(this._watchdogs.values()).map((e=>e.destroy()))).then((()=>this._destructor(e)))}))}_getWatchdog(e){const t=this._watchdogs.get(e);if(!t)throw new Error(`Item with the given id was not registered: ${e}.`);return t}_isErrorComingFromThisItem(e){for(const t of this._watchdogs.values())if(t._isErrorComingFromThisItem(e))return !1;return hg(this._context,e.context)}}class pg{_onEmptyCallbacks=[];_queues=new Map;_activeActions=0;onEmpty(e){this._onEmptyCallbacks.push(e);}enqueue(e,t){const i=e===gg;this._activeActions++,this._queues.get(e)||this._queues.set(e,Promise.resolve());const n=(i?Promise.all(this._queues.values()):Promise.all([this._queues.get(gg),this._queues.get(e)])).then(t),s=n.catch((()=>{}));return this._queues.set(e,s),n.finally((()=>{this._activeActions--,this._queues.get(e)===s&&0===this._activeActions&&this._onEmptyCallbacks.forEach((e=>e()));}))}}function bg(e){return Array.isArray(e)?e:[e]}class wg{_commands;constructor(){this._commands=new Map;}add(e,t){this._commands.set(e,t);}get(e){return this._commands.get(e)}execute(e,...t){const i=this.get(e);if(!i)throw new E("commandcollection-command-not-found",this,{commandName:e});return i.execute(...t)}*names(){yield*this._commands.keys();}*commands(){yield*this._commands.values();}[Symbol.iterator](){return this._commands[Symbol.iterator]()}destroy(){for(const e of this.commands())e.destroy();}}class _g extends Va{editor;constructor(e){super(),this.editor=e;}set(e,t,i={}){if("string"==typeof t){const e=t;t=(t,i)=>{this.editor.execute(e),i();};}super.set(e,t,i);}}const vg="contentEditing",yg="common";class kg{keystrokeInfos=new Map;_editor;constructor(e){this._editor=e;const t=e.config.get("menuBar.isVisible"),i=e.locale.t;this.addKeystrokeInfoCategory({id:vg,label:i("Content editing keystrokes"),description:i("These keyboard shortcuts allow for quick access to content editing features.")});const n=[{label:i("Close contextual balloons, dropdowns, and dialogs"),keystroke:"Esc"},{label:i("Open the accessibility help dialog"),keystroke:"Alt+0"},{label:i("Move focus between form fields (inputs, buttons, etc.)"),keystroke:[["Tab"],["Shift+Tab"]]},{label:i("Move focus to the toolbar, navigate between toolbars"),keystroke:"Alt+F10",mayRequireFn:!0},{label:i("Navigate through the toolbar or menu bar"),keystroke:[["arrowup"],["arrowright"],["arrowdown"],["arrowleft"]]},{label:i("Execute the currently focused button. Executing buttons that interact with the editor content moves the focus back to the content."),keystroke:[["Enter"],["Space"]]}];t&&n.push({label:i("Move focus to the menu bar, navigate between menu bars"),keystroke:"Alt+F9",mayRequireFn:!0}),this.addKeystrokeInfoCategory({id:"navigation",label:i("User interface and content navigation keystrokes"),description:i("Use the following keystrokes for more efficient navigation in the CKEditor 5 user interface."),groups:[{id:"common",keystrokes:n}]});}addKeystrokeInfoCategory({id:e,label:t,description:i,groups:n}){this.keystrokeInfos.set(e,{id:e,label:t,description:i,groups:new Map}),this.addKeystrokeInfoGroup({categoryId:e,id:yg}),n&&n.forEach((t=>{this.addKeystrokeInfoGroup({categoryId:e,...t});}));}addKeystrokeInfoGroup({categoryId:e=vg,id:t,label:i,keystrokes:n}){const s=this.keystrokeInfos.get(e);if(!s)throw new E("accessibility-unknown-keystroke-info-category",this._editor,{groupId:t,categoryId:e});s.groups.set(t,{id:t,label:i,keystrokes:n||[]});}addKeystrokeInfos({categoryId:e=vg,groupId:t=yg,keystrokes:i}){if(!this.keystrokeInfos.has(e))throw new E("accessibility-unknown-keystroke-info-category",this._editor,{categoryId:e,keystrokes:i});const n=this.keystrokeInfos.get(e);if(!n.groups.has(t))throw new E("accessibility-unknown-keystroke-info-group",this._editor,{groupId:t,categoryId:e,keystrokes:i});n.groups.get(t).keystrokes.push(...i);}}class Cg extends(ar()){accessibility;commands;config;conversion;data;editing;locale;model;plugins;keystrokes;t;static defaultConfig;static builtinPlugins;_context;_readOnlyLocks;constructor(e={}){if(super(),"sanitizeHtml"in e)throw new E("editor-config-sanitizehtml-not-supported");const t=this.constructor,{translations:i,...n}=t.defaultConfig||{},{translations:s=i,...o}=e,r=e.language||n.language;this._context=e.context||new Xa({language:r,translations:s}),this._context._addEditor(this,!e.context);const a=Array.from(t.builtinPlugins||[]);this.config=new _r(o,n),this.config.define("plugins",a),this.config.define(this._context._getEditorConfig()),this.plugins=new Ya(this,a,this._context.plugins),this.locale=this._context.locale,this.t=this.locale.t,this._readOnlyLocks=new Set,this.commands=new wg,this.set("state","initializing"),this.once("ready",(()=>this.state="ready"),{priority:"high"}),this.once("destroy",(()=>this.state="destroyed"),{priority:"high"}),this.model=new Ju,this.on("change:isReadOnly",(()=>{this.model.document.isReadOnly=this.isReadOnly;}));const l=new _l;this.data=new Ph(this.model,l),this.editing=new lh(this.model,l),this.editing.view.document.bind("isReadOnly").to(this),this.conversion=new Vh([this.editing.downcastDispatcher,this.data.downcastDispatcher],this.data.upcastDispatcher),this.conversion.addAlias("dataDowncast",this.data.downcastDispatcher),this.conversion.addAlias("editingDowncast",this.editing.downcastDispatcher),this.keystrokes=new _g(this),this.keystrokes.listenTo(this.editing.view.document),this.accessibility=new kg(this);}get isReadOnly(){return this._readOnlyLocks.size>0}set isReadOnly(e){throw new E("editor-isreadonly-has-no-setter")}enableReadOnlyMode(e){if("string"!=typeof e&&"symbol"!=typeof e)throw new E("editor-read-only-lock-id-invalid",null,{lockId:e});this._readOnlyLocks.has(e)||(this._readOnlyLocks.add(e),1===this._readOnlyLocks.size&&this.fire("change:isReadOnly","isReadOnly",!0,!1));}disableReadOnlyMode(e){if("string"!=typeof e&&"symbol"!=typeof e)throw new E("editor-read-only-lock-id-invalid",null,{lockId:e});this._readOnlyLocks.has(e)&&(this._readOnlyLocks.delete(e),0===this._readOnlyLocks.size&&this.fire("change:isReadOnly","isReadOnly",!1,!0));}setData(e){this.data.set(e);}getData(e){return this.data.get(e)}initPlugins(){const e=this.config,t=e.get("plugins"),i=e.get("removePlugins")||[],n=e.get("extraPlugins")||[],s=e.get("substitutePlugins")||[];return this.plugins.init(t.concat(n),i,s)}destroy(){let e=Promise.resolve();return "initializing"==this.state&&(e=new Promise((e=>this.once("ready",e)))),e.then((()=>{this.fire("destroy"),this.stopListening(),this.commands.destroy();})).then((()=>this.plugins.destroy())).then((()=>{this.model.destroy(),this.data.destroy(),this.editing.destroy(),this.keystrokes.destroy();})).then((()=>this._context._removeEditor(this)))}execute(e,...t){try{return this.commands.execute(e,...t)}catch(e){E.rethrowUnexpectedError(e,this);}}focus(){this.editing.view.focus();}static create(...e){throw new Error("This is an abstract method.")}static Context=Xa;static EditorWatchdog=ug;static ContextWatchdog=fg}function xg(e){if(!Se(e.updateSourceElement))throw new E("attachtoform-missing-elementapi-interface",e);const t=e.sourceElement;if(function(e){return !!e&&"textarea"===e.tagName.toLowerCase()}(t)&&t.form){let i;const n=t.form,s=()=>e.updateSourceElement();Se(n.submit)&&(i=n.submit,n.submit=()=>{s(),i.apply(n);}),n.addEventListener("submit",s),e.on("destroy",(()=>{n.removeEventListener("submit",s),i&&(n.submit=i);}));}}function Eg(e){return class extends e{sourceElement;updateSourceElement(e){if(!this.sourceElement)throw new E("editor-missing-sourceelement",this);const t=this.config.get("updateSourceElementOnDestroy"),i=this.sourceElement instanceof HTMLTextAreaElement;if(!t&&!i)return void Ur(this.sourceElement,"");const n="string"==typeof e?e:this.data.get();Ur(this.sourceElement,n);}}}Eg.updateSourceElement=Eg(Object).prototype.updateSourceElement;class Sg extends el{_actions;static get pluginName(){return "PendingActions"}init(){this.set("hasAny",!1),this._actions=new Sa({idProperty:"_id"}),this._actions.delegate("add","remove").to(this);}add(e){if("string"!=typeof e)throw new E("pendingactions-add-invalid-message",this);const t=new(ar());return t.set("message",e),this._actions.add(t),this.hasAny=!0,t}remove(e){this._actions.remove(e),this.hasAny=!!this._actions.length;}get first(){return this._actions.get(0)}[Symbol.iterator](){return this._actions[Symbol.iterator]()}}const Ig={bold:'<svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10.187 17H5.773c-.637 0-1.092-.138-1.364-.415-.273-.277-.409-.718-.409-1.323V4.738c0-.617.14-1.062.419-1.332.279-.27.73-.406 1.354-.406h4.68c.69 0 1.288.041 1.793.124.506.083.96.242 1.36.478.341.197.644.447.906.75a3.262 3.262 0 0 1 .808 2.162c0 1.401-.722 2.426-2.167 3.075C15.05 10.175 16 11.315 16 13.01a3.756 3.756 0 0 1-2.296 3.504 6.1 6.1 0 0 1-1.517.377c-.571.073-1.238.11-2 .11zm-.217-6.217H7v4.087h3.069c1.977 0 2.965-.69 2.965-2.072 0-.707-.256-1.22-.768-1.537-.512-.319-1.277-.478-2.296-.478zM7 5.13v3.619h2.606c.729 0 1.292-.067 1.69-.2a1.6 1.6 0 0 0 .91-.765c.165-.267.247-.566.247-.897 0-.707-.26-1.176-.778-1.409-.519-.232-1.31-.348-2.375-.348H7z"/></svg>',cancel:'<svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="m11.591 10.177 4.243 4.242a1 1 0 0 1-1.415 1.415l-4.242-4.243-4.243 4.243a1 1 0 0 1-1.414-1.415l4.243-4.242L4.52 5.934A1 1 0 0 1 5.934 4.52l4.243 4.243 4.242-4.243a1 1 0 1 1 1.415 1.414l-4.243 4.243z"/></svg>',caption:'<svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M2 16h9a1 1 0 0 1 0 2H2a1 1 0 0 1 0-2z"/><path d="M17 1a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V3a2 2 0 0 1 2-2h14zm0 1.5H3a.5.5 0 0 0-.492.41L2.5 3v9a.5.5 0 0 0 .41.492L3 12.5h14a.5.5 0 0 0 .492-.41L17.5 12V3a.5.5 0 0 0-.41-.492L17 2.5z" fill-opacity=".6"/></svg>',check:'<svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M6.972 16.615a.997.997 0 0 1-.744-.292l-4.596-4.596a1 1 0 1 1 1.414-1.414l3.926 3.926 9.937-9.937a1 1 0 0 1 1.414 1.415L7.717 16.323a.997.997 0 0 1-.745.292z"/></svg>',cog:'<svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="m11.333 2 .19 2.263a5.899 5.899 0 0 1 1.458.604L14.714 3.4 16.6 5.286l-1.467 1.733c.263.452.468.942.605 1.46L18 8.666v2.666l-2.263.19a5.899 5.899 0 0 1-.604 1.458l1.467 1.733-1.886 1.886-1.733-1.467a5.899 5.899 0 0 1-1.46.605L11.334 18H8.667l-.19-2.263a5.899 5.899 0 0 1-1.458-.604L5.286 16.6 3.4 14.714l1.467-1.733a5.899 5.899 0 0 1-.604-1.458L2 11.333V8.667l2.262-.189a5.899 5.899 0 0 1 .605-1.459L3.4 5.286 5.286 3.4l1.733 1.467a5.899 5.899 0 0 1 1.46-.605L8.666 2h2.666zM10 6.267a3.733 3.733 0 1 0 0 7.466 3.733 3.733 0 0 0 0-7.466z"/></svg>',colorPalette:'<svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10.209 18.717A8.5 8.5 0 1 1 18.686 9.6h-.008l.002.12a3 3 0 0 1-2.866 2.997h-.268l-.046-.002v.002h-4.791a2 2 0 1 0 0 4 1 1 0 1 1-.128 1.992 8.665 8.665 0 0 1-.372.008Zm-3.918-7.01a1.25 1.25 0 1 0-2.415-.648 1.25 1.25 0 0 0 2.415.647ZM5.723 8.18a1.25 1.25 0 1 0 .647-2.414 1.25 1.25 0 0 0-.647 2.414ZM9.76 6.155a1.25 1.25 0 1 0 .647-2.415 1.25 1.25 0 0 0-.647 2.415Zm4.028 1.759a1.25 1.25 0 1 0 .647-2.415 1.25 1.25 0 0 0-.647 2.415Z"/></svg>',eraser:'<svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="m8.636 9.531-2.758 3.94a.5.5 0 0 0 .122.696l3.224 2.284h1.314l2.636-3.736L8.636 9.53zm.288 8.451L5.14 15.396a2 2 0 0 1-.491-2.786l6.673-9.53a2 2 0 0 1 2.785-.49l3.742 2.62a2 2 0 0 1 .491 2.785l-7.269 10.053-2.147-.066z"/><path d="M4 18h5.523v-1H4zm-2 0h1v-1H2z"/></svg>',history:'<svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M11 1a9 9 0 1 1-8.027 13.075l1.128-1.129A7.502 7.502 0 0 0 18.5 10a7.5 7.5 0 1 0-14.962.759l-.745-.746-.76.76A9 9 0 0 1 11 1z"/><path d="M.475 8.17a.75.75 0 0 1 .978.047l.075.082 1.284 1.643 1.681-1.284a.75.75 0 0 1 .978.057l.073.083a.75.75 0 0 1-.057.978l-.083.073-2.27 1.737a.75.75 0 0 1-.973-.052l-.074-.082-1.741-2.23a.75.75 0 0 1 .13-1.052z"/><path d="M11.5 5v4.999l3.196 3.196-1.06 1.06L10.1 10.72l-.1-.113V5z"/></svg>',image:'<svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M6.66 9.118a.693.693 0 0 1 .956.032l3.65 3.411 2.422-2.238a.695.695 0 0 1 .945 0L17.5 13.6V2.5h-15v11.1l4.16-4.482ZM17.8 1c.652 0 1.2.47 1.2 1.1v14.362c0 .64-.532 1.038-1.184 1.038H2.184C1.532 17.5 1 17.103 1 16.462V2.1C1 1.47 1.537 1 2.2 1h15.6Zm-5.655 6a2.128 2.128 0 0 1 .157-2.364A2.133 2.133 0 1 1 12.145 7Z"/></svg>',imageUpload:'<svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M1.201 1C.538 1 0 1.47 0 2.1v14.363c0 .64.534 1.037 1.186 1.037h9.494a2.97 2.97 0 0 1-.414-.287 2.998 2.998 0 0 1-1.055-2.03 3.003 3.003 0 0 1 .693-2.185l.383-.455-.02.018-3.65-3.41a.695.695 0 0 0-.957-.034L1.5 13.6V2.5h15v5.535a2.97 2.97 0 0 1 1.412.932l.088.105V2.1c0-.63-.547-1.1-1.2-1.1H1.202Zm11.713 2.803a2.146 2.146 0 0 0-2.049 1.992 2.14 2.14 0 0 0 1.28 2.096 2.13 2.13 0 0 0 2.644-3.11 2.134 2.134 0 0 0-1.875-.978Z"/><path d="M15.522 19.1a.79.79 0 0 0 .79-.79v-5.373l2.059 2.455a.79.79 0 1 0 1.211-1.015l-3.352-3.995a.79.79 0 0 0-.995-.179.784.784 0 0 0-.299.221l-3.35 3.99a.79.79 0 1 0 1.21 1.017l1.936-2.306v5.185c0 .436.353.79.79.79Z"/><path d="M15.522 19.1a.79.79 0 0 0 .79-.79v-5.373l2.059 2.455a.79.79 0 1 0 1.211-1.015l-3.352-3.995a.79.79 0 0 0-.995-.179.784.784 0 0 0-.299.221l-3.35 3.99a.79.79 0 1 0 1.21 1.017l1.936-2.306v5.185c0 .436.353.79.79.79Z"/></svg>',imageAssetManager:'<svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M1.201 1c-.662 0-1.2.47-1.2 1.1v14.248c0 .64.533 1.152 1.185 1.152h6.623v-7.236L6.617 9.15a.694.694 0 0 0-.957-.033L1.602 13.55V2.553l14.798.003V9.7H18V2.1c0-.63-.547-1.1-1.2-1.1H1.202Zm11.723 2.805a2.094 2.094 0 0 0-1.621.832 2.127 2.127 0 0 0 1.136 3.357 2.13 2.13 0 0 0 2.611-1.506 2.133 2.133 0 0 0-.76-2.244 2.13 2.13 0 0 0-1.366-.44Z"/><path clip-rule="evenodd" d="M19.898 12.369v6.187a.844.844 0 0 1-.844.844h-8.719a.844.844 0 0 1-.843-.844v-7.312a.844.844 0 0 1 .843-.844h2.531a.843.843 0 0 1 .597.248l.838.852h4.75c.223 0 .441.114.6.272a.844.844 0 0 1 .247.597Zm-1.52.654-4.377.02-1.1-1.143H11v6h7.4l-.023-4.877Z"/></svg>',imageUrl:'<svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M1.201 1C.538 1 0 1.47 0 2.1v14.363c0 .64.534 1.037 1.186 1.037h7.029a5.401 5.401 0 0 1 .615-4.338l.762-1.232-2.975-2.78a.696.696 0 0 0-.957-.033L1.5 13.6V2.5h15v6.023c.449.131.887.32 1.307.573l.058.033c.046.028.09.057.135.086V2.1c0-.63-.547-1.1-1.2-1.1H1.202Zm11.713 2.803a2.15 2.15 0 0 0-1.611.834 2.118 2.118 0 0 0-.438 1.158 2.14 2.14 0 0 0 1.277 2.096 2.132 2.132 0 0 0 2.645-3.11 2.13 2.13 0 0 0-1.873-.978Z"/><path d="M16.63 10.294a3.003 3.003 0 0 0-4.142.887l-.117.177a.647.647 0 0 0-.096.492.664.664 0 0 0 .278.418.7.7 0 0 0 .944-.234 1.741 1.741 0 0 1 2.478-.463 1.869 1.869 0 0 1 .476 2.55.637.637 0 0 0-.071.5.646.646 0 0 0 .309.396.627.627 0 0 0 .869-.19l.027-.041a3.226 3.226 0 0 0-.956-4.492Zm-6.061 3.78-.044.066a3.228 3.228 0 0 0 .82 4.403 3.005 3.005 0 0 0 4.275-.798l.13-.197a.626.626 0 0 0 .092-.475.638.638 0 0 0-.268-.402.713.713 0 0 0-.99.26l-.018.029a1.741 1.741 0 0 1-2.477.461 1.87 1.87 0 0 1-.475-2.55l.029-.047a.647.647 0 0 0 .086-.485.66.66 0 0 0-.275-.408l-.04-.027a.609.609 0 0 0-.845.17Z"/><path d="M15.312 13.925c.24-.36.154-.838-.19-1.067-.346-.23-.82-.124-1.059.236l-1.268 1.907c-.239.36-.153.838.192 1.067.345.23.818.123 1.057-.236l1.268-1.907Z"/></svg>',lowVision:'<svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M5.085 6.22 2.943 4.078a.75.75 0 1 1 1.06-1.06l2.592 2.59A11.094 11.094 0 0 1 10 5.068c4.738 0 8.578 3.101 8.578 5.083 0 1.197-1.401 2.803-3.555 3.887l1.714 1.713a.75.75 0 0 1-.09 1.138.488.488 0 0 1-.15.084.75.75 0 0 1-.821-.16L6.17 7.304c-.258.11-.51.233-.757.365l6.239 6.24-.006.005.78.78c-.388.094-.78.166-1.174.215l-1.11-1.11h.011L4.55 8.197a7.2 7.2 0 0 0-.665.514l-.112.098 4.897 4.897-.005.006 1.276 1.276a10.164 10.164 0 0 1-1.477-.117l-.479-.479-.009.009-4.863-4.863-.022.031a2.563 2.563 0 0 0-.124.2c-.043.077-.08.158-.108.241a.534.534 0 0 0-.028.133.29.29 0 0 0 .008.072.927.927 0 0 0 .082.226c.067.133.145.26.234.379l3.242 3.365.025.01.59.623c-3.265-.918-5.59-3.155-5.59-4.668 0-1.194 1.448-2.838 3.663-3.93zm7.07.531a4.632 4.632 0 0 1 1.108 5.992l.345.344.046-.018a9.313 9.313 0 0 0 2-1.112c.256-.187.5-.392.727-.613.137-.134.27-.277.392-.431.072-.091.141-.185.203-.286.057-.093.107-.19.148-.292a.72.72 0 0 0 .036-.12.29.29 0 0 0 .008-.072.492.492 0 0 0-.028-.133.999.999 0 0 0-.036-.096 2.165 2.165 0 0 0-.071-.145 2.917 2.917 0 0 0-.125-.2 3.592 3.592 0 0 0-.263-.335 5.444 5.444 0 0 0-.53-.523 7.955 7.955 0 0 0-1.054-.768 9.766 9.766 0 0 0-1.879-.891c-.337-.118-.68-.219-1.027-.301zm-2.85.21-.069.002a.508.508 0 0 0-.254.097.496.496 0 0 0-.104.679.498.498 0 0 0 .326.199l.045.005c.091.003.181.003.272.012a2.45 2.45 0 0 1 2.017 1.513c.024.061.043.125.069.185a.494.494 0 0 0 .45.287h.008a.496.496 0 0 0 .35-.158.482.482 0 0 0 .13-.335.638.638 0 0 0-.048-.219 3.379 3.379 0 0 0-.36-.723 3.438 3.438 0 0 0-2.791-1.543l-.028-.001h-.013z"/></svg>',textAlternative:'<svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M3.035 1C2.446 1 2 1.54 2 2.098V10.5h1.5v-8h13v8H18V2.098C18 1.539 17.48 1 16.9 1H3.035Zm10.453 2.61a1.885 1.885 0 0 0-1.442.736 1.89 1.89 0 0 0 1.011 2.976 1.903 1.903 0 0 0 2.253-1.114 1.887 1.887 0 0 0-1.822-2.598ZM7.463 8.163a.611.611 0 0 0-.432.154L5.071 10.5h5.119L7.88 8.348a.628.628 0 0 0-.417-.185Zm6.236 1.059a.62.62 0 0 0-.42.164L12.07 10.5h2.969l-.92-1.113a.618.618 0 0 0-.42-.165ZM.91 11.5a.91.91 0 0 0-.91.912v6.877c0 .505.405.91.91.91h18.178a.91.91 0 0 0 .912-.91v-6.877a.908.908 0 0 0-.912-.912H.91ZM3.668 13h1.947l2.135 5.7H5.898l-.28-.946H3.601l-.278.945H1.516L3.668 13Zm4.947 0h1.801v4.3h2.7v1.4h-4.5V13h-.001Zm4.5 0h5.4v1.4h-1.798v4.3h-1.701v-4.3h-1.9V13h-.001Zm-8.517 1.457-.614 2.059h1.262l-.648-2.059Z"/></svg>',loupe:'<svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M12.68 13.74h-.001l4.209 4.208a1 1 0 1 0 1.414-1.414l-4.267-4.268a6 6 0 1 0-1.355 1.474ZM13 9a4 4 0 1 1-8 0 4 4 0 0 1 8 0Z"/></svg>',previousArrow:'<svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M11.463 5.187a.888.888 0 1 1 1.254 1.255L9.16 10l3.557 3.557a.888.888 0 1 1-1.254 1.255L7.26 10.61a.888.888 0 0 1 .16-1.382l4.043-4.042z"/></svg>',nextArrow:'<svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M8.537 14.813a.888.888 0 1 1-1.254-1.255L10.84 10 7.283 6.442a.888.888 0 1 1 1.254-1.255L12.74 9.39a.888.888 0 0 1-.16 1.382l-4.043 4.042z"/></svg>',importExport:'<svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M19 4.5 14 0H3v12.673l.868-1.041c.185-.222.4-.402.632-.54V1.5h8v5h5v7.626a2.24 2.24 0 0 1 1.5.822V4.5ZM14 5V2l3.3 3H14Zm-3.692 12.5c.062.105.133.206.213.303L11.52 19H8v-.876a2.243 2.243 0 0 0 1.82-.624h.488Zm7.518-.657a.75.75 0 0 0-1.152-.96L15.5 17.29V12H14v5.29l-1.174-1.408a.75.75 0 0 0-1.152.96l2.346 2.816a.95.95 0 0 0 1.46 0l2.346-2.815Zm-15.056-.38a.75.75 0 0 1-.096-1.056l2.346-2.815a.95.95 0 0 1 1.46 0l2.346 2.815a.75.75 0 1 1-1.152.96L6.5 14.96V20H5v-5.04l-1.174 1.408a.75.75 0 0 1-1.056.096Z"/></svg>',paragraph:'<svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10.5 5.5H7v5h3.5a2.5 2.5 0 1 0 0-5zM5 3h6.5v.025a5 5 0 0 1 0 9.95V13H7v4a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1z"/></svg>',plus:'<svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10 2a1 1 0 0 0-1 1v6H3a1 1 0 1 0 0 2h6v6a1 1 0 1 0 2 0v-6h6a1 1 0 1 0 0-2h-6V3a1 1 0 0 0-1-1Z"/></svg>',text:'<svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M9.816 11.5 7.038 4.785 4.261 11.5h5.555Zm.62 1.5H3.641l-1.666 4.028H.312l5.789-14h1.875l5.789 14h-1.663L10.436 13Z"/><path d="m12.09 17-.534-1.292.848-1.971.545 1.319L12.113 17h-.023Zm1.142-5.187.545 1.319L15.5 9.13l1.858 4.316h-3.45l.398.965h3.467L18.887 17H20l-3.873-9h-1.254l-1.641 3.813Z"/></svg>',alignBottom:'<svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="m9.239 13.938-2.88-1.663a.75.75 0 0 1 .75-1.3L9 12.067V4.75a.75.75 0 1 1 1.5 0v7.318l1.89-1.093a.75.75 0 0 1 .75 1.3l-2.879 1.663a.752.752 0 0 1-.511.187.752.752 0 0 1-.511-.187zM4.25 17a.75.75 0 1 1 0-1.5h10.5a.75.75 0 0 1 0 1.5H4.25z"/></svg>',alignMiddle:'<svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M9.75 11.875a.752.752 0 0 1 .508.184l2.883 1.666a.75.75 0 0 1-.659 1.344l-.091-.044-1.892-1.093.001 4.318a.75.75 0 1 1-1.5 0v-4.317l-1.89 1.092a.75.75 0 0 1-.75-1.3l2.879-1.663a.752.752 0 0 1 .51-.187zM15.25 9a.75.75 0 1 1 0 1.5H4.75a.75.75 0 1 1 0-1.5h10.5zM9.75.375a.75.75 0 0 1 .75.75v4.318l1.89-1.093.092-.045a.75.75 0 0 1 .659 1.344l-2.883 1.667a.752.752 0 0 1-.508.184.752.752 0 0 1-.511-.187L6.359 5.65a.75.75 0 0 1 .75-1.299L9 5.442V1.125a.75.75 0 0 1 .75-.75z"/></svg>',alignTop:'<svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="m10.261 7.062 2.88 1.663a.75.75 0 0 1-.75 1.3L10.5 8.933v7.317a.75.75 0 1 1-1.5 0V8.932l-1.89 1.093a.75.75 0 0 1-.75-1.3l2.879-1.663a.752.752 0 0 1 .511-.187.752.752 0 0 1 .511.187zM15.25 4a.75.75 0 1 1 0 1.5H4.75a.75.75 0 0 1 0-1.5h10.5z"/></svg>',alignLeft:'<svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M2 3.75c0 .414.336.75.75.75h14.5a.75.75 0 1 0 0-1.5H2.75a.75.75 0 0 0-.75.75zm0 8c0 .414.336.75.75.75h14.5a.75.75 0 1 0 0-1.5H2.75a.75.75 0 0 0-.75.75zm0 4c0 .414.336.75.75.75h9.929a.75.75 0 1 0 0-1.5H2.75a.75.75 0 0 0-.75.75zm0-8c0 .414.336.75.75.75h9.929a.75.75 0 1 0 0-1.5H2.75a.75.75 0 0 0-.75.75z"/></svg>',alignCenter:'<svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M2 3.75c0 .414.336.75.75.75h14.5a.75.75 0 1 0 0-1.5H2.75a.75.75 0 0 0-.75.75zm0 8c0 .414.336.75.75.75h14.5a.75.75 0 1 0 0-1.5H2.75a.75.75 0 0 0-.75.75zm2.286 4c0 .414.336.75.75.75h9.928a.75.75 0 1 0 0-1.5H5.036a.75.75 0 0 0-.75.75zm0-8c0 .414.336.75.75.75h9.928a.75.75 0 1 0 0-1.5H5.036a.75.75 0 0 0-.75.75z"/></svg>',alignRight:'<svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M18 3.75a.75.75 0 0 1-.75.75H2.75a.75.75 0 1 1 0-1.5h14.5a.75.75 0 0 1 .75.75zm0 8a.75.75 0 0 1-.75.75H2.75a.75.75 0 1 1 0-1.5h14.5a.75.75 0 0 1 .75.75zm0 4a.75.75 0 0 1-.75.75H7.321a.75.75 0 1 1 0-1.5h9.929a.75.75 0 0 1 .75.75zm0-8a.75.75 0 0 1-.75.75H7.321a.75.75 0 1 1 0-1.5h9.929a.75.75 0 0 1 .75.75z"/></svg>',alignJustify:'<svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M2 3.75c0 .414.336.75.75.75h14.5a.75.75 0 1 0 0-1.5H2.75a.75.75 0 0 0-.75.75zm0 8c0 .414.336.75.75.75h14.5a.75.75 0 1 0 0-1.5H2.75a.75.75 0 0 0-.75.75zm0 4c0 .414.336.75.75.75h9.929a.75.75 0 1 0 0-1.5H2.75a.75.75 0 0 0-.75.75zm0-8c0 .414.336.75.75.75h14.5a.75.75 0 1 0 0-1.5H2.75a.75.75 0 0 0-.75.75z"/></svg>',objectLeft:'<svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path opacity=".5" d="M2 3h16v1.5H2zm11.5 9H18v1.5h-4.5zm0-3H18v1.5h-4.5zm0-3H18v1.5h-4.5zM2 15h16v1.5H2z"/><path d="M12.003 7v5.5a1 1 0 0 1-1 1H2.996a1 1 0 0 1-1-1V7a1 1 0 0 1 1-1h8.007a1 1 0 0 1 1 1zm-1.506.5H3.5V12h6.997V7.5z"/></svg>',objectCenter:'<svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path opacity=".5" d="M2 3h16v1.5H2zm0 12h16v1.5H2z"/><path d="M15.003 7v5.5a1 1 0 0 1-1 1H5.996a1 1 0 0 1-1-1V7a1 1 0 0 1 1-1h8.007a1 1 0 0 1 1 1zm-1.506.5H6.5V12h6.997V7.5z"/></svg>',objectRight:'<svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path opacity=".5" d="M2 3h16v1.5H2zm0 12h16v1.5H2zm0-9h5v1.5H2zm0 3h5v1.5H2zm0 3h5v1.5H2z"/><path d="M18.003 7v5.5a1 1 0 0 1-1 1H8.996a1 1 0 0 1-1-1V7a1 1 0 0 1 1-1h8.007a1 1 0 0 1 1 1zm-1.506.5H9.5V12h6.997V7.5z"/></svg>',objectFullWidth:'<svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path opacity=".5" d="M2 3h16v1.5H2zm0 12h16v1.5H2z"/><path d="M18 7v5.5a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V7a1 1 0 0 1 1-1h14a1 1 0 0 1 1 1zm-1.505.5H3.504V12h12.991V7.5z"/></svg>',objectInline:'<svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path opacity=".5" d="M2 3h16v1.5H2zm11.5 9H18v1.5h-4.5zM2 15h16v1.5H2z"/><path d="M12.003 7v5.5a1 1 0 0 1-1 1H2.996a1 1 0 0 1-1-1V7a1 1 0 0 1 1-1h8.007a1 1 0 0 1 1 1zm-1.506.5H3.5V12h6.997V7.5z"/></svg>',objectBlockLeft:'<svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path opacity=".5" d="M2 3h16v1.5H2zm0 12h16v1.5H2z"/><path d="M12.003 7v5.5a1 1 0 0 1-1 1H2.996a1 1 0 0 1-1-1V7a1 1 0 0 1 1-1h8.007a1 1 0 0 1 1 1zm-1.506.5H3.5V12h6.997V7.5z"/></svg>',objectBlockRight:'<svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path opacity=".5" d="M2 3h16v1.5H2zm0 12h16v1.5H2z"/><path d="M18.003 7v5.5a1 1 0 0 1-1 1H8.996a1 1 0 0 1-1-1V7a1 1 0 0 1 1-1h8.007a1 1 0 0 1 1 1zm-1.506.5H9.5V12h6.997V7.5z"/></svg>',objectSizeCustom:'<svg xmlns="http://www.w3.org/2000/svg" xmlns:v="https://vecta.io/nano" viewBox="0 0 20 20"><path d="M.95 1.43a.95.95 0 0 0-.95.95v3.1a.95.95 0 0 0 .95.95h.75v6.3H.95a.95.95 0 0 0-.95.95v3.1a.95.95 0 0 0 .95.95h3.1a.95.95 0 0 0 .95-.95v-.65h1.932l1.539-1.5H5v-.95a.95.95 0 0 0-.95-.95H3.2v-6.3h.85A.95.95 0 0 0 5 5.48v-.55h10v.55a.95.95 0 0 0 .95.95h3.1a.95.95 0 0 0 .95-.95v-3.1a.95.95 0 0 0-.95-.95h-3.1a.95.95 0 0 0-.95.95v1.05H5V2.38a.95.95 0 0 0-.95-.95H.95zm.55 3.5v-2h2v2h-2zm0 9.3v2h2v-2h-2zm15-11.3v2h2v-2h-2z"/><path d="M8.139 20.004v-2.388l7.045-7.048 2.391 2.391-7.046 7.046h-2.39zm11.421-9.101a.64.64 0 0 1-.138.206l-1.165 1.168-2.391-2.391 1.167-1.163a.63.63 0 0 1 .206-.138.635.635 0 0 1 .243-.049.63.63 0 0 1 .449.187l1.491 1.488c.059.059.108.129.138.206s.049.16.049.243a.6.6 0 0 1-.049.243z"/></svg>',objectSizeFull:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M2.5 17v1h-1v-1h1zm2 0v1h-1v-1h1zm2 0v1h-1v-1h1zm2 0v1h-1v-1h1zm2 0v1h-1v-1h1zm2 0v1h-1v-1h1zm2 0v1h-1v-1h1zm2 0v1h-1v-1h1zm2 0v1h-1v-1h1zM1 15.5v1H0v-1h1zm19 0v1h-1v-1h1zm-19-2v1H0v-1h1zm19 0v1h-1v-1h1zm-19-2v1H0v-1h1zm19 0v1h-1v-1h1zm-19-2v1H0v-1h1zm19 0v1h-1v-1h1zm-19-2v1H0v-1h1zm19 0v1h-1v-1h1zm-19-2v1H0v-1h1zm19 0v1h-1v-1h1zm0-2v1h-1v-1h1zm-19 0v1H0v-1h1zM14.5 2v1h-1V2h1zm2 0v1h-1V2h1zm2 0v1h-1V2h1zm-8 0v1h-1V2h1zm-2 0v1h-1V2h1zm-2 0v1h-1V2h1zm-2 0v1h-1V2h1zm8 0v1h-1V2h1zm-10 0v1h-1V2h1z"/><path d="M18.095 2H1.905C.853 2 0 2.895 0 4v12c0 1.105.853 2 1.905 2h16.19C19.147 18 20 17.105 20 16V4c0-1.105-.853-2-1.905-2zm0 1.5c.263 0 .476.224.476.5v12c0 .276-.213.5-.476.5H1.905a.489.489 0 0 1-.476-.5V4c0-.276.213-.5.476-.5h16.19z"/></svg>',objectSizeLarge:'<svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M2.5 16.5v1h-1v-1h1Zm2 0v1h-1v-1h1Zm2 0v1h-1v-1h1Zm2 0v1h-1v-1h1Zm2 0v1h-1v-1h1Zm2 0v1h-1v-1h1Zm2 0v1h-1v-1h1Zm2 0v1h-1v-1h1Zm2 0v1h-1v-1h1ZM1 15v1H0v-1h1Zm19 0v1h-1v-1h1ZM1 13v1H0v-1h1Zm19 0v1h-1v-1h1ZM1 11v1H0v-1h1Zm19 0v1h-1v-1h1ZM1 9v1H0V9h1Zm19 0v1h-1V9h1ZM1 7v1H0V7h1Zm19 0v1h-1V7h1ZM1 5v1H0V5h1Zm19 0v1h-1V5h1Zm0-2v1h-1V3h1ZM1 3v1H0V3h1Zm13.5-1.5v1h-1v-1h1Zm2 0v1h-1v-1h1Zm2 0v1h-1v-1h1Zm-8 0v1h-1v-1h1Zm-2 0v1h-1v-1h1Zm-2 0v1h-1v-1h1Zm-2 0v1h-1v-1h1Zm8 0v1h-1v-1h1Zm-10 0v1h-1v-1h1Z"/><path d="M13 5.5H2a2 2 0 0 0-2 2v8a2 2 0 0 0 2 2h11a2 2 0 0 0 2-2v-8a2 2 0 0 0-2-2ZM13 7a.5.5 0 0 1 .5.5v8a.5.5 0 0 1-.5.5H2a.5.5 0 0 1-.5-.5v-8A.5.5 0 0 1 2 7h11Z"/></svg>',objectSizeSmall:'<svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M2.5 16.5v1h-1v-1h1Zm2 0v1h-1v-1h1Zm2 0v1h-1v-1h1Zm2 0v1h-1v-1h1Zm2 0v1h-1v-1h1Zm2 0v1h-1v-1h1Zm2 0v1h-1v-1h1Zm2 0v1h-1v-1h1Zm2 0v1h-1v-1h1ZM1 15v1H0v-1h1Zm19 0v1h-1v-1h1ZM1 13v1H0v-1h1Zm19 0v1h-1v-1h1ZM1 11v1H0v-1h1Zm19 0v1h-1v-1h1ZM1 9v1H0V9h1Zm19 0v1h-1V9h1ZM1 7v1H0V7h1Zm19 0v1h-1V7h1ZM1 5v1H0V5h1Zm19 0v1h-1V5h1Zm0-2v1h-1V3h1ZM1 3v1H0V3h1Zm13.5-1.5v1h-1v-1h1Zm2 0v1h-1v-1h1Zm2 0v1h-1v-1h1Zm-8 0v1h-1v-1h1Zm-2 0v1h-1v-1h1Zm-2 0v1h-1v-1h1Zm-2 0v1h-1v-1h1Zm8 0v1h-1v-1h1Zm-10 0v1h-1v-1h1Z"/><path d="M7 9.5H2a2 2 0 0 0-2 2v4a2 2 0 0 0 2 2h5a2 2 0 0 0 2-2v-4a2 2 0 0 0-2-2ZM7 11a.5.5 0 0 1 .5.5v4a.5.5 0 0 1-.5.5H2a.5.5 0 0 1-.5-.5v-4A.5.5 0 0 1 2 11h5Z"/></svg>',objectSizeMedium:'<svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M2.5 16.5v1h-1v-1h1Zm2 0v1h-1v-1h1Zm2 0v1h-1v-1h1Zm2 0v1h-1v-1h1Zm2 0v1h-1v-1h1Zm2 0v1h-1v-1h1Zm2 0v1h-1v-1h1Zm2 0v1h-1v-1h1Zm2 0v1h-1v-1h1ZM1 15v1H0v-1h1Zm19 0v1h-1v-1h1ZM1 13v1H0v-1h1Zm19 0v1h-1v-1h1ZM1 11v1H0v-1h1Zm19 0v1h-1v-1h1ZM1 9v1H0V9h1Zm19 0v1h-1V9h1ZM1 7v1H0V7h1Zm19 0v1h-1V7h1ZM1 5v1H0V5h1Zm19 0v1h-1V5h1Zm0-2v1h-1V3h1ZM1 3v1H0V3h1Zm13.5-1.5v1h-1v-1h1Zm2 0v1h-1v-1h1Zm2 0v1h-1v-1h1Zm-8 0v1h-1v-1h1Zm-2 0v1h-1v-1h1Zm-2 0v1h-1v-1h1Zm-2 0v1h-1v-1h1Zm8 0v1h-1v-1h1Zm-10 0v1h-1v-1h1Z"/><path d="M10 7.5H2a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2v-6a2 2 0 0 0-2-2ZM10 9a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-.5.5H2a.5.5 0 0 1-.5-.5v-6A.5.5 0 0 1 2 9h8Z"/></svg>',pencil:'<svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="m7.3 17.37-.061.088a1.518 1.518 0 0 1-.934.535l-4.178.663-.806-4.153a1.495 1.495 0 0 1 .187-1.058l.056-.086L8.77 2.639c.958-1.351 2.803-1.076 4.296-.03 1.497 1.047 2.387 2.693 1.433 4.055L7.3 17.37zM9.14 4.728l-5.545 8.346 3.277 2.294 5.544-8.346L9.14 4.728zM6.07 16.512l-3.276-2.295.53 2.73 2.746-.435zM9.994 3.506 13.271 5.8c.316-.452-.16-1.333-1.065-1.966-.905-.634-1.895-.78-2.212-.328zM8 18.5 9.375 17H19v1.5H8z"/></svg>',pilcrow:'<svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M6.999 2H15a1 1 0 0 1 0 2h-1.004v13a1 1 0 1 1-2 0V4H8.999v13a1 1 0 1 1-2 0v-7A4 4 0 0 1 3 6a4 4 0 0 1 3.999-4z"/></svg>',quote:'<svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M3 10.423a6.5 6.5 0 0 1 6.056-6.408l.038.67C6.448 5.423 5.354 7.663 5.22 10H9c.552 0 .5.432.5.986v4.511c0 .554-.448.503-1 .503h-5c-.552 0-.5-.449-.5-1.003v-4.574zm8 0a6.5 6.5 0 0 1 6.056-6.408l.038.67c-2.646.739-3.74 2.979-3.873 5.315H17c.552 0 .5.432.5.986v4.511c0 .554-.448.503-1 .503h-5c-.552 0-.5-.449-.5-1.003v-4.574z"/></svg>',threeVerticalDots:'<svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><circle cx="9.5" cy="4.5" r="1.5"/><circle cx="9.5" cy="10.5" r="1.5"/><circle cx="9.5" cy="16.5" r="1.5"/></svg>',dragIndicator:'<svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M5 3.25a1.5 1.5 0 1 0 3 0 1.5 1.5 0 1 0-3 0"/><path d="M12 3.25a1.5 1.5 0 1 0 3 0 1.5 1.5 0 1 0-3 0"/><path d="M5 10a1.5 1.5 0 1 0 3 0 1.5 1.5 0 1 0-3 0"/><path d="M12 10a1.5 1.5 0 1 0 3 0 1.5 1.5 0 1 0-3 0"/><path d="M5 16.75a1.5 1.5 0 1 0 3 0 1.5 1.5 0 1 0-3 0"/><path d="M12 16.75a1.5 1.5 0 1 0 3 0 1.5 1.5 0 1 0-3 0"/></svg>',redo:'<svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="m14.958 9.367-2.189 1.837a.75.75 0 0 0 .965 1.149l3.788-3.18a.747.747 0 0 0 .21-.284.75.75 0 0 0-.17-.945L13.77 4.762a.75.75 0 1 0-.964 1.15l2.331 1.955H6.22A.75.75 0 0 0 6 7.9a4 4 0 1 0 1.477 7.718l-.344-1.489A2.5 2.5 0 1 1 6.039 9.4l-.008-.032h8.927z"/></svg>',undo:'<svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="m5.042 9.367 2.189 1.837a.75.75 0 0 1-.965 1.149l-3.788-3.18a.747.747 0 0 1-.21-.284.75.75 0 0 1 .17-.945L6.23 4.762a.75.75 0 1 1 .964 1.15L4.863 7.866h8.917A.75.75 0 0 1 14 7.9a4 4 0 1 1-1.477 7.718l.344-1.489a2.5 2.5 0 1 0 1.094-4.73l.008-.032H5.042z"/></svg>',bulletedList:'<svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M7 5.75c0 .414.336.75.75.75h9.5a.75.75 0 1 0 0-1.5h-9.5a.75.75 0 0 0-.75.75zm-6 0C1 4.784 1.777 4 2.75 4c.966 0 1.75.777 1.75 1.75 0 .966-.777 1.75-1.75 1.75C1.784 7.5 1 6.723 1 5.75zm6 9c0 .414.336.75.75.75h9.5a.75.75 0 1 0 0-1.5h-9.5a.75.75 0 0 0-.75.75zm-6 0c0-.966.777-1.75 1.75-1.75.966 0 1.75.777 1.75 1.75 0 .966-.777 1.75-1.75 1.75-.966 0-1.75-.777-1.75-1.75z"/></svg>',numberedList:'<svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M7 5.75c0 .414.336.75.75.75h9.5a.75.75 0 1 0 0-1.5h-9.5a.75.75 0 0 0-.75.75zM3.5 3v5H2V3.7H1v-1h2.5V3zM.343 17.857l2.59-3.257H2.92a.6.6 0 1 0-1.04 0H.302a2 2 0 1 1 3.995 0h-.001c-.048.405-.16.734-.333.988-.175.254-.59.692-1.244 1.312H4.3v1h-4l.043-.043zM7 14.75a.75.75 0 0 1 .75-.75h9.5a.75.75 0 1 1 0 1.5h-9.5a.75.75 0 0 1-.75-.75z"/></svg>',todoList:'<svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="m2.315 14.705 2.224-2.24a.689.689 0 0 1 .963 0 .664.664 0 0 1 0 .949L2.865 16.07a.682.682 0 0 1-.112.089.647.647 0 0 1-.852-.051L.688 14.886a.635.635 0 0 1 0-.903.647.647 0 0 1 .91 0l.717.722zm5.185.045a.75.75 0 0 1 .75-.75h9.5a.75.75 0 1 1 0 1.5h-9.5a.75.75 0 0 1-.75-.75zM2.329 5.745l2.21-2.226a.689.689 0 0 1 .963 0 .664.664 0 0 1 0 .95L2.865 7.125a.685.685 0 0 1-.496.196.644.644 0 0 1-.468-.187L.688 5.912a.635.635 0 0 1 0-.903.647.647 0 0 1 .91 0l.73.736zM7.5 5.75A.75.75 0 0 1 8.25 5h9.5a.75.75 0 1 1 0 1.5h-9.5a.75.75 0 0 1-.75-.75z"/></svg>',codeBlock:'<svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M12.87 12.61a.75.75 0 0 1-.089.976l-.085.07-3.154 2.254 3.412 2.414a.75.75 0 0 1 .237.95l-.057.095a.75.75 0 0 1-.95.237l-.096-.058-4.272-3.022-.003-1.223 4.01-2.867a.75.75 0 0 1 1.047.174zm2.795-.231.095.057 4.011 2.867-.003 1.223-4.272 3.022-.095.058a.75.75 0 0 1-.88-.151l-.07-.086-.058-.095a.75.75 0 0 1 .15-.88l.087-.07 3.412-2.414-3.154-2.253-.085-.071a.75.75 0 0 1 .862-1.207zM16 0a2 2 0 0 1 2 2v9.354l-.663-.492-.837-.001V2a.5.5 0 0 0-.5-.5H2a.5.5 0 0 0-.5.5v15a.5.5 0 0 0 .5.5h3.118L7.156 19H2a2 2 0 0 1-2-2V2a2 2 0 0 1 2-2h14zM5.009 15l.003 1H3v-1h2.009zm2.188-2-1.471 1H5v-1h2.197zM10 11v.095L8.668 12H7v-1h3zm4-2v1H7V9h7zm0-2v1H7V7h7zm-4-2v1H5V5h5zM6 3v1H3V3h3z"/></svg>',browseFiles:'<svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M11.627 16.5zm5.873-.196zm0-7.001V8h-13v8.5h4.341c.191.54.457 1.044.785 1.5H2a1.5 1.5 0 0 1-1.5-1.5v-13A1.5 1.5 0 0 1 2 2h4.5a1.5 1.5 0 0 1 1.06.44L9.122 4H16a1.5 1.5 0 0 1 1.5 1.5v1A1.5 1.5 0 0 1 19 8v2.531a6.027 6.027 0 0 0-1.5-1.228zM16 6.5v-1H8.5l-2-2H2v13h1V8a1.5 1.5 0 0 1 1.5-1.5H16z"/><path d="M14.5 19.5a5 5 0 1 1 0-10 5 5 0 0 1 0 10zM15 14v-2h-1v2h-2v1h2v2h1v-2h2v-1h-2z"/></svg>',heading1:'<svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M19 9v10h-2v-8h-2V9h4zM4 8.5h5V4a1 1 0 0 1 1-1h.5a1 1 0 0 1 1 1v11.5a1 1 0 0 1-1 1H10a1 1 0 0 1-1-1V11H4v4.5a1 1 0 0 1-1 1h-.5a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1H3a1 1 0 0 1 1 1v4.5z"/></svg>',heading2:'<svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M3 8.5h5V4a1 1 0 0 1 1-1h.5a1 1 0 0 1 1 1v11.5a1 1 0 0 1-1 1H9a1 1 0 0 1-1-1V11H3v4.5a1 1 0 0 1-1 1h-.5a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1H2a1 1 0 0 1 1 1v4.5zm16.076 8.343V18.5h-6.252c.067-.626.27-1.22.61-1.78.338-.561 1.006-1.305 2.005-2.232.804-.749 1.297-1.257 1.479-1.523.245-.368.368-.732.368-1.092 0-.398-.107-.703-.32-.917-.214-.214-.51-.32-.886-.32-.372 0-.669.111-.889.336-.22.224-.347.596-.38 1.117l-1.778-.178c.106-.982.438-1.686.997-2.114.558-.427 1.257-.64 2.095-.64.918 0 1.64.247 2.164.742.525.495.787 1.11.787 1.847 0 .419-.075.818-.225 1.197-.15.378-.388.775-.714 1.19-.216.275-.605.67-1.168 1.187-.563.516-.92.859-1.07 1.028a3.11 3.11 0 0 0-.365.495h3.542z"/></svg>',heading3:'<svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M3 8.5h5V4a1 1 0 0 1 1-1h.5a1 1 0 0 1 1 1v11.5a1 1 0 0 1-1 1H9a1 1 0 0 1-1-1V11H3v4.5a1 1 0 0 1-1 1h-.5a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1H2a1 1 0 0 1 1 1v4.5zm9.989 7.53 1.726-.209c.055.44.203.777.445 1.01.24.232.533.349.876.349.368 0 .678-.14.93-.42.251-.279.377-.655.377-1.13 0-.448-.12-.803-.362-1.066a1.153 1.153 0 0 0-.882-.393c-.228 0-.501.044-.819.133l.197-1.453c.482.012.85-.092 1.105-.315.253-.222.38-.517.38-.885 0-.313-.093-.563-.279-.75-.186-.185-.434-.278-.743-.278a1.07 1.07 0 0 0-.78.317c-.216.212-.347.52-.394.927l-1.644-.28c.114-.562.287-1.012.517-1.348.231-.337.553-.601.965-.794a3.24 3.24 0 0 1 1.387-.289c.876 0 1.579.28 2.108.838.436.457.653.973.653 1.549 0 .817-.446 1.468-1.339 1.955.533.114.96.37 1.28.768.319.398.478.878.478 1.441 0 .817-.298 1.513-.895 2.088-.596.576-1.339.864-2.228.864-.842 0-1.54-.243-2.094-.727-.555-.485-.876-1.118-.965-1.901z"/></svg>',heading4:'<svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M3.5 8.5h5V4a1 1 0 0 1 1-1h.5a1 1 0 0 1 1 1v11.5a1 1 0 0 1-1 1h-.5a1 1 0 0 1-1-1V11h-5v4.5a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1h.5a1 1 0 0 1 1 1v4.5zm13.55 10v-1.873h-3.81v-1.561l4.037-5.91h1.498v5.904h1.156v1.567h-1.156V18.5H17.05zm0-3.44v-3.18l-2.14 3.18h2.14z"/></svg>',heading5:'<svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M3.5 8.5h5V4a1 1 0 0 1 1-1h.5a1 1 0 0 1 1 1v11.5a1 1 0 0 1-1 1h-.5a1 1 0 0 1-1-1V11h-5v4.5a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1h.5a1 1 0 0 1 1 1v4.5zm9.578 7.607 1.777-.184c.05.402.201.72.45.955a1.223 1.223 0 0 0 1.81-.101c.258-.303.387-.759.387-1.368 0-.572-.128-1-.384-1.286-.256-.285-.59-.428-1-.428-.512 0-.971.226-1.377.679l-1.448-.21.915-4.843h4.716v1.67H15.56l-.28 1.58a2.697 2.697 0 0 1 1.219-.298 2.68 2.68 0 0 1 2.012.863c.55.576.825 1.323.825 2.241a3.36 3.36 0 0 1-.666 2.05c-.605.821-1.445 1.232-2.52 1.232-.86 0-1.56-.23-2.101-.692-.542-.461-.866-1.081-.971-1.86z"/></svg>',heading6:'<svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M3.5 8.5h5V4a1 1 0 0 1 1-1h.5a1 1 0 0 1 1 1v11.5a1 1 0 0 1-1 1h-.5a1 1 0 0 1-1-1V11h-5v4.5a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1h.5a1 1 0 0 1 1 1v4.5zm15.595 2.973-1.726.19c-.043-.355-.153-.617-.33-.787-.178-.169-.409-.253-.692-.253-.377 0-.695.169-.956.507-.26.339-.424 1.043-.492 2.114.445-.525.997-.787 1.657-.787.745 0 1.383.284 1.914.85.531.568.797 1.3.797 2.197 0 .952-.28 1.716-.838 2.291-.559.576-1.276.864-2.152.864-.94 0-1.712-.365-2.317-1.095-.605-.73-.908-1.927-.908-3.59 0-1.705.316-2.935.946-3.688.63-.753 1.45-1.13 2.457-1.13.706 0 1.291.198 1.755.594.463.395.758.97.885 1.723zm-4.043 3.891c0 .58.133 1.028.4 1.343.266.315.57.473.914.473.33 0 .605-.13.825-.388.22-.258.33-.68.33-1.27 0-.604-.118-1.047-.355-1.329a1.115 1.115 0 0 0-.89-.422c-.342 0-.632.134-.869.403s-.355.666-.355 1.19z"/></svg>',horizontalLine:'<svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M2 9h16v2H2z"/></svg>',html:'<svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M17 0a2 2 0 0 1 2 2v7a1 1 0 0 1 1 1v5a1 1 0 0 1-.883.993l-.118.006L19 17a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2l-.001-1.001-.116-.006A1 1 0 0 1 0 15v-5a1 1 0 0 1 .999-1L1 2a2 2 0 0 1 2-2h14zm.499 15.999h-15L2.5 17a.5.5 0 0 0 .5.5h14a.5.5 0 0 0 .5-.5l-.001-1.001zm-3.478-6.013-.014.014H14v.007l-1.525 1.525-1.46-1.46-.015.013V10h-1v5h1v-3.53l1.428 1.43.048.043.131-.129L14 11.421V15h1v-5h-.965l-.014-.014zM2 10H1v5h1v-2h2v2h1v-5H4v2H2v-2zm7 0H6v1h1v4h1v-4h1v-1zm8 0h-1v5h3v-1h-2v-4zm0-8.5H3a.5.5 0 0 0-.5.5l-.001 6.999h15L17.5 2a.5.5 0 0 0-.5-.5zM10 7v1H4V7h6zm3-2v1H4V5h9zm-3-2v1H4V3h6z"/></svg>',indent:'<svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M2 3.75c0 .414.336.75.75.75h14.5a.75.75 0 1 0 0-1.5H2.75a.75.75 0 0 0-.75.75zm5 6c0 .414.336.75.75.75h9.5a.75.75 0 1 0 0-1.5h-9.5a.75.75 0 0 0-.75.75zM2.75 16.5h14.5a.75.75 0 1 0 0-1.5H2.75a.75.75 0 1 0 0 1.5zM1.632 6.95 5.02 9.358a.4.4 0 0 1-.013.661l-3.39 2.207A.4.4 0 0 1 1 11.892V7.275a.4.4 0 0 1 .632-.326z"/></svg>',outdent:'<svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M2 3.75c0 .414.336.75.75.75h14.5a.75.75 0 1 0 0-1.5H2.75a.75.75 0 0 0-.75.75zm5 6c0 .414.336.75.75.75h9.5a.75.75 0 1 0 0-1.5h-9.5a.75.75 0 0 0-.75.75zM2.75 16.5h14.5a.75.75 0 1 0 0-1.5H2.75a.75.75 0 1 0 0 1.5zm1.618-9.55L.98 9.358a.4.4 0 0 0 .013.661l3.39 2.207A.4.4 0 0 0 5 11.892V7.275a.4.4 0 0 0-.632-.326z"/></svg>',table:'<svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M3 5.5v3h4v-3H3Zm0 4v3h4v-3H3Zm0 4v3h4v-3H3Zm5 3h4v-3H8v3Zm5 0h4v-3h-4v3Zm4-4v-3h-4v3h4Zm0-4v-3h-4v3h4Zm1.5 8A1.5 1.5 0 0 1 17 18H3a1.5 1.5 0 0 1-1.5-1.5V3c.222-.863 1.068-1.5 2-1.5h13c.932 0 1.778.637 2 1.5v13.5Zm-6.5-4v-3H8v3h4Zm0-4v-3H8v3h4Z"/></svg>'};class Pg extends(ar()){total;_reader;_data;constructor(){super();const e=new window.FileReader;this._reader=e,this._data=void 0,this.set("loaded",0),e.onprogress=e=>{this.loaded=e.loaded;};}get error(){return this._reader.error}get data(){return this._data}read(e){const t=this._reader;return this.total=e.size,new Promise(((i,n)=>{t.onload=()=>{const e=t.result;this._data=e,i(e);},t.onerror=()=>{n("error");},t.onabort=()=>{n("aborted");},this._reader.readAsDataURL(e);}))}abort(){this._reader.abort();}}class Vg extends Ga{loaders=new Sa;_loadersMap=new Map;_pendingAction=null;static get pluginName(){return "FileRepository"}static get requires(){return [Sg]}init(){this.loaders.on("change",(()=>this._updatePendingAction())),this.set("uploaded",0),this.set("uploadTotal",null),this.bind("uploadedPercent").to(this,"uploaded",this,"uploadTotal",((e,t)=>t?e/t*100:0));}getLoader(e){return this._loadersMap.get(e)||null}createLoader(e){if(!this.createUploadAdapter)return T("filerepository-no-upload-adapter"),null;const t=new Rg(Promise.resolve(e),this.createUploadAdapter);return this.loaders.add(t),this._loadersMap.set(e,t),e instanceof Promise&&t.file.then((e=>{this._loadersMap.set(e,t);})).catch((()=>{})),t.on("change:uploaded",(()=>{let e=0;for(const t of this.loaders)e+=t.uploaded;this.uploaded=e;})),t.on("change:uploadTotal",(()=>{let e=0;for(const t of this.loaders)t.uploadTotal&&(e+=t.uploadTotal);this.uploadTotal=e;})),t}destroyLoader(e){const t=e instanceof Rg?e:this.getLoader(e);t._destroy(),this.loaders.remove(t),this._loadersMap.forEach(((e,i)=>{e===t&&this._loadersMap.delete(i);}));}_updatePendingAction(){const e=this.editor.plugins.get(Sg);if(this.loaders.length){if(!this._pendingAction){const t=this.editor.t,i=e=>`${t("Upload in progress")} ${parseInt(e)}%.`;this._pendingAction=e.add(i(this.uploadedPercent)),this._pendingAction.bind("message").to(this,"uploadedPercent",i);}}else e.remove(this._pendingAction),this._pendingAction=null;}}class Rg extends(ar()){id;_filePromiseWrapper;_adapter;_reader;constructor(e,t){super(),this.id=k(),this._filePromiseWrapper=this._createFilePromiseWrapper(e),this._adapter=t(this),this._reader=new Pg,this.set("status","idle"),this.set("uploaded",0),this.set("uploadTotal",null),this.bind("uploadedPercent").to(this,"uploaded",this,"uploadTotal",((e,t)=>t?e/t*100:0)),this.set("uploadResponse",null);}get file(){return this._filePromiseWrapper?this._filePromiseWrapper.promise.then((e=>this._filePromiseWrapper?e:null)):Promise.resolve(null)}get data(){return this._reader.data}read(){if("idle"!=this.status)throw new E("filerepository-read-wrong-status",this);return this.status="reading",this.file.then((e=>this._reader.read(e))).then((e=>{if("reading"!==this.status)throw this.status;return this.status="idle",e})).catch((e=>{if("aborted"===e)throw this.status="aborted","aborted";throw this.status="error",this._reader.error?this._reader.error:e}))}upload(){if("idle"!=this.status)throw new E("filerepository-upload-wrong-status",this);return this.status="uploading",this.file.then((()=>this._adapter.upload())).then((e=>(this.uploadResponse=e,this.status="idle",e))).catch((e=>{if("aborted"===this.status)throw "aborted";throw this.status="error",e}))}abort(){const e=this.status;this.status="aborted",this._filePromiseWrapper.isFulfilled?"reading"==e?this._reader.abort():"uploading"==e&&this._adapter.abort&&this._adapter.abort():(this._filePromiseWrapper.promise.catch((()=>{})),this._filePromiseWrapper.rejecter("aborted")),this._destroy();}_destroy(){this._filePromiseWrapper=void 0,this._reader=void 0,this._adapter=void 0,this.uploadResponse=void 0;}_createFilePromiseWrapper(e){const t={};return t.promise=new Promise(((i,n)=>{t.rejecter=n,t.isFulfilled=!1,e.then((e=>{t.isFulfilled=!0,i(e);})).catch((e=>{t.isFulfilled=!0,n(e);}));})),t}}class Zg extends Sa{_parentElement;constructor(e=[]){super(e,{idProperty:"viewUid"}),this.on("add",((e,t,i)=>{this._renderViewIntoCollectionParent(t,i);})),this.on("remove",((e,t)=>{t.element&&this._parentElement&&t.element.remove();})),this._parentElement=null;}destroy(){this.map((e=>e.destroy()));}setParent(e){this._parentElement=e;for(const e of this)this._renderViewIntoCollectionParent(e);}delegate(...e){if(!e.length||!e.every((e=>"string"==typeof e)))throw new E("ui-viewcollection-delegate-wrong-events",this);return {to:t=>{for(const i of this)for(const n of e)i.delegate(n).to(t);this.on("add",((i,n)=>{for(const i of e)n.delegate(i).to(t);})),this.on("remove",((i,n)=>{for(const i of e)n.stopDelegating(i,t);}));}}}_renderViewIntoCollectionParent(e,t){e.isRendered||e.render(),e.element&&this._parentElement&&this._parentElement.insertBefore(e.element,this._parentElement.children[t]);}remove(e){return super.remove(e)}}class Jg extends(F()){ns;tag;text;attributes;children;eventListeners;_isRendered;_revertData;constructor(e){super(),Object.assign(this,af(rf(e))),this._isRendered=!1,this._revertData=null;}render(){const e=this._renderNode({intoFragment:!0});return this._isRendered=!0,e}apply(e){return this._revertData={children:[],bindings:[],attributes:{}},this._renderNode({node:e,intoFragment:!1,isApplying:!0,revertData:this._revertData}),e}revert(e){if(!this._revertData)throw new E("ui-template-revert-not-applied",[this,e]);this._revertTemplateFromNode(e,this._revertData);}*getViews(){yield*function*e(t){if(t.children)for(const i of t.children)mf(i)?yield i:gf(i)&&(yield*e(i));}(this);}static bind(e,t){return {to:(i,n)=>new Yg({eventNameOrFunction:i,attribute:i,observable:e,emitter:t,callback:n}),if:(i,n,s)=>new Xg({observable:e,emitter:t,attribute:i,valueIfTrue:n,callback:s})}}static extend(e,t){if(e._isRendered)throw new E("template-extend-render",[this,e]);hf(e,af(rf(t)));}_renderNode(e){let t;if(t=e.node?this.tag&&this.text:this.tag?this.text:!this.text,t)throw new E("ui-template-wrong-syntax",this);return this.text?this._renderText(e):this._renderElement(e)}_renderElement(e){let t=e.node;return t||(t=e.node=document.createElementNS(this.ns||"http://www.w3.org/1999/xhtml",this.tag)),this._renderAttributes(e),this._renderElementChildren(e),this._setUpListeners(e),t}_renderText(e){let t=e.node;return t?e.revertData.text=t.textContent:t=e.node=document.createTextNode(""),ef(this.text)?this._bindToObservable({schema:this.text,updater:nf(t),data:e}):t.textContent=this.text.join(""),t}_renderAttributes(e){if(!this.attributes)return;const t=e.node,i=e.revertData;for(const n in this.attributes){const s=t.getAttribute(n),o=this.attributes[n];i&&(i.attributes[n]=s);const r=pf(o)?o[0].ns:null;if(ef(o)){const a=pf(o)?o[0].value:o;i&&bf(n)&&a.unshift(s),this._bindToObservable({schema:a,updater:sf(t,n,r),data:e});}else if("style"==n&&"string"!=typeof o[0])this._renderStyleAttribute(o[0],e);else {i&&s&&bf(n)&&o.unshift(s);const e=o.map((e=>e&&e.value||e)).reduce(((e,t)=>e.concat(t)),[]).reduce(cf,"");uf(e)||t.setAttributeNS(r,n,e);}}}_renderStyleAttribute(e,t){const i=t.node;for(const n in e){const s=e[n];ef(s)?this._bindToObservable({schema:[s],updater:of(i,n),data:t}):i.style[n]=s;}}_renderElementChildren(e){const t=e.node,i=e.intoFragment?document.createDocumentFragment():t,n=e.isApplying;let s=0;for(const o of this.children)if(ff(o)){if(!n){o.setParent(t);for(const e of o)i.appendChild(e.element);}}else if(mf(o))n||(o.isRendered||o.render(),i.appendChild(o.element));else if(kr(o))i.appendChild(o);else if(n){const t={children:[],bindings:[],attributes:{}};e.revertData.children.push(t),o._renderNode({intoFragment:!1,node:i.childNodes[s++],isApplying:!0,revertData:t});}else i.appendChild(o.render());e.intoFragment&&t.appendChild(i);}_setUpListeners(e){if(this.eventListeners)for(const t in this.eventListeners){const i=this.eventListeners[t].map((i=>{const[n,s]=t.split("@");return i.activateDomEventListener(n,s,e)}));e.revertData&&e.revertData.bindings.push(i);}}_bindToObservable({schema:e,updater:t,data:i}){const n=i.revertData;tf(e,t,i);const s=e.filter((e=>!uf(e))).filter((e=>e.observable)).map((n=>n.activateAttributeListener(e,t,i)));n&&n.bindings.push(s);}_revertTemplateFromNode(e,t){for(const e of t.bindings)for(const t of e)t();if(t.text)return void(e.textContent=t.text);const i=e;for(const e in t.attributes){const n=t.attributes[e];null===n?i.removeAttribute(e):i.setAttribute(e,n);}for(let e=0;e<t.children.length;++e)this._revertTemplateFromNode(i.childNodes[e],t.children[e]);}}class Qg{attribute;observable;emitter;callback;constructor(e){this.attribute=e.attribute,this.observable=e.observable,this.emitter=e.emitter,this.callback=e.callback;}getValue(e){const t=this.observable[this.attribute];return this.callback?this.callback(t,e):t}activateAttributeListener(e,t,i){const n=()=>tf(e,t,i);return this.emitter.listenTo(this.observable,`change:${this.attribute}`,n),()=>{this.emitter.stopListening(this.observable,`change:${this.attribute}`,n);}}}class Yg extends Qg{eventNameOrFunction;constructor(e){super(e),this.eventNameOrFunction=e.eventNameOrFunction;}activateDomEventListener(e,t,i){const n=(e,i)=>{t&&!i.target.matches(t)||("function"==typeof this.eventNameOrFunction?this.eventNameOrFunction(i):this.observable.fire(this.eventNameOrFunction,i));};return this.emitter.listenTo(i.node,e,n),()=>{this.emitter.stopListening(i.node,e,n);}}}class Xg extends Qg{valueIfTrue;constructor(e){super(e),this.valueIfTrue=e.valueIfTrue;}getValue(e){return !uf(super.getValue(e))&&(this.valueIfTrue||!0)}}function ef(e){return !!e&&(e.value&&(e=e.value),Array.isArray(e)?e.some(ef):e instanceof Qg)}function tf(e,t,{node:i}){const n=function(e,t){return e.map((e=>e instanceof Qg?e.getValue(t):e))}(e,i);let s;s=1==e.length&&e[0]instanceof Xg?n[0]:n.reduce(cf,""),uf(s)?t.remove():t.set(s);}function nf(e){return {set(t){e.textContent=t;},remove(){e.textContent="";}}}function sf(e,t,i){return {set(n){e.setAttributeNS(i,t,n);},remove(){e.removeAttributeNS(i,t);}}}function of(e,t){return {set(i){e.style[t]=i;},remove(){e.style[t]=null;}}}function rf(e){return Rs(e,(e=>{if(e&&(e instanceof Qg||gf(e)||mf(e)||ff(e)))return e}))}function af(e){if("string"==typeof e?e=function(e){return {text:[e]}}(e):e.text&&function(e){e.text=Aa(e.text);}(e),e.on&&(e.eventListeners=function(e){for(const t in e)lf(e,t);return e}(e.on),delete e.on),!e.text){e.attributes&&function(e){for(const t in e)e[t].value&&(e[t].value=Aa(e[t].value)),lf(e,t);}(e.attributes);const t=[];if(e.children)if(ff(e.children))t.push(e.children);else for(const i of e.children)gf(i)||mf(i)||kr(i)?t.push(i):t.push(new Jg(i));e.children=t;}return e}function lf(e,t){e[t]=Aa(e[t]);}function cf(e,t){return uf(t)?e:uf(e)?t:`${e} ${t}`}function df(e,t){for(const i in t)e[i]?e[i].push(...t[i]):e[i]=t[i];}function hf(e,t){if(t.attributes&&(e.attributes||(e.attributes={}),df(e.attributes,t.attributes)),t.eventListeners&&(e.eventListeners||(e.eventListeners={}),df(e.eventListeners,t.eventListeners)),t.text&&e.text.push(...t.text),t.children&&t.children.length){if(e.children.length!=t.children.length)throw new E("ui-template-extend-children-mismatch",e);let i=0;for(const n of t.children)hf(e.children[i++],n);}}function uf(e){return !e&&0!==e}function mf(e){return e instanceof wf}function gf(e){return e instanceof Jg}function ff(e){return e instanceof Zg}function pf(e){return pe(e[0])&&e[0].ns}function bf(e){return "class"==e||"style"==e}class wf extends(Ar(ar())){element;isRendered;locale;t;template;_viewCollections;_unboundChildren;_bindTemplate;constructor(e){super(),this.element=null,this.isRendered=!1,this.locale=e,this.t=e&&e.t,this._viewCollections=new Sa,this._unboundChildren=this.createCollection(),this._viewCollections.on("add",((t,i)=>{i.locale=e,i.t=e&&e.t;})),this.decorate("render");}get bindTemplate(){return this._bindTemplate?this._bindTemplate:this._bindTemplate=Jg.bind(this,this)}createCollection(e){const t=new Zg(e);return this._viewCollections.add(t),t}registerChild(e){br(e)||(e=[e]);for(const t of e)this._unboundChildren.add(t);}deregisterChild(e){br(e)||(e=[e]);for(const t of e)this._unboundChildren.remove(t);}setTemplate(e){this.template=new Jg(e);}extendTemplate(e){Jg.extend(this.template,e);}render(){if(this.isRendered)throw new E("ui-view-render-already-rendered",this);this.template&&(this.element=this.template.render(),this.registerChild(this.template.getViews())),this.isRendered=!0;}destroy(){this.stopListening(),this._viewCollections.map((e=>e.destroy())),this.template&&this.template._revertData&&this.template.revert(this.element);}}function _f({emitter:e,activator:t,callback:i,contextElements:n,listenerOptions:s}){e.listenTo(document,"mousedown",((e,s)=>{if(!t())return;const o="function"==typeof s.composedPath?s.composedPath():[],r="function"==typeof n?n():n;for(const e of r)if(e.contains(s.target)||o.includes(e))return;i();}),s);}function yf(e){return class extends e{disableCssTransitions(){this._isCssTransitionsDisabled=!0;}enableCssTransitions(){this._isCssTransitionsDisabled=!1;}constructor(...e){super(...e),this.set("_isCssTransitionsDisabled",!1),this.initializeCssTransitionDisablerMixin();}initializeCssTransitionDisablerMixin(){this.extendTemplate({attributes:{class:[this.bindTemplate.if("_isCssTransitionsDisabled","ck-transitions-disabled")]}});}}}function kf({view:e}){e.listenTo(e.element,"submit",((t,i)=>{i.preventDefault(),e.fire("submit");}),{useCapture:!0});}function Cf({keystrokeHandler:e,focusTracker:t,gridItems:i,numberOfColumns:n,uiLanguageDirection:s}){const o="number"==typeof n?()=>n:n;function r(e){return n=>{const s=i.find((e=>e.element===t.focusedElement)),o=i.getIndex(s),r=e(o,i);i.get(r).focus(),n.stopPropagation(),n.preventDefault();}}function a(e,t){return e===t-1?0:e+1}function l(e,t){return 0===e?t-1:e-1}e.set("arrowright",r(((e,t)=>"rtl"===s?l(e,t.length):a(e,t.length)))),e.set("arrowleft",r(((e,t)=>"rtl"===s?a(e,t.length):l(e,t.length)))),e.set("arrowup",r(((e,t)=>{let i=e-o();return i<0&&(i=e+o()*Math.floor(t.length/o()),i>t.length-1&&(i-=o())),i}))),e.set("arrowdown",r(((e,t)=>{let i=e+o();return i>t.length-1&&(i=e%o()),i})));}class xf extends wf{static presentationalAttributeNames=["alignment-baseline","baseline-shift","clip-path","clip-rule","color","color-interpolation","color-interpolation-filters","color-rendering","cursor","direction","display","dominant-baseline","fill","fill-opacity","fill-rule","filter","flood-color","flood-opacity","font-family","font-size","font-size-adjust","font-stretch","font-style","font-variant","font-weight","image-rendering","letter-spacing","lighting-color","marker-end","marker-mid","marker-start","mask","opacity","overflow","paint-order","pointer-events","shape-rendering","stop-color","stop-opacity","stroke","stroke-dasharray","stroke-dashoffset","stroke-linecap","stroke-linejoin","stroke-miterlimit","stroke-opacity","stroke-width","text-anchor","text-decoration","text-overflow","text-rendering","transform","unicode-bidi","vector-effect","visibility","white-space","word-spacing","writing-mode"];constructor(){super();const e=this.bindTemplate;this.set("content",""),this.set("viewBox","0 0 20 20"),this.set("fillColor",""),this.set("isColorInherited",!0),this.set("isVisible",!0),this.setTemplate({tag:"svg",ns:"http://www.w3.org/2000/svg",attributes:{class:["ck","ck-icon",e.if("isVisible","ck-hidden",(e=>!e)),"ck-reset_all-excluded",e.if("isColorInherited","ck-icon_inherit-color")],viewBox:e.to("viewBox")}});}render(){super.render(),this._updateXMLContent(),this._colorFillPaths(),this.on("change:content",(()=>{this._updateXMLContent(),this._colorFillPaths();})),this.on("change:fillColor",(()=>{this._colorFillPaths();}));}_updateXMLContent(){if(this.content){const e=(new DOMParser).parseFromString(this.content.trim(),"image/svg+xml").querySelector("svg"),t=e.getAttribute("viewBox");t&&(this.viewBox=t);for(const{name:t,value:i}of Array.from(e.attributes))xf.presentationalAttributeNames.includes(t)&&this.element.setAttribute(t,i);for(;this.element.firstChild;)this.element.removeChild(this.element.firstChild);for(;e.childNodes.length>0;)this.element.appendChild(e.childNodes[0]);}}_colorFillPaths(){this.fillColor&&this.element.querySelectorAll(".ck-icon__fill").forEach((e=>{e.style.fill=this.fillColor;}));}}class Af extends wf{constructor(){super(),this.set({style:void 0,text:void 0,id:void 0});const e=this.bindTemplate;this.setTemplate({tag:"span",attributes:{class:["ck","ck-button__label"],style:e.to("style"),id:e.to("id")},children:[{text:e.to("text")}]});}}class Ef extends wf{children;labelView;iconView;keystrokeView;_focusDelayed=null;constructor(e,t=new Af){super(e);const i=this.bindTemplate,n=k();this.set("_ariaPressed",!1),this.set("_ariaChecked",!1),this.set("ariaLabel",void 0),this.set("ariaLabelledBy",`ck-editor__aria-label_${n}`),this.set("class",void 0),this.set("labelStyle",void 0),this.set("icon",void 0),this.set("isEnabled",!0),this.set("isOn",!1),this.set("isVisible",!0),this.set("isToggleable",!1),this.set("keystroke",void 0),this.set("label",void 0),this.set("role",void 0),this.set("tabindex",-1),this.set("tooltip",!1),this.set("tooltipPosition","s"),this.set("type","button"),this.set("withText",!1),this.set("withKeystroke",!1),this.children=this.createCollection(),this.labelView=this._setupLabelView(t),this.iconView=new xf,this.iconView.extendTemplate({attributes:{class:"ck-button__icon"}}),this.keystrokeView=this._createKeystrokeView(),this.bind("_tooltipString").to(this,"tooltip",this,"label",this,"keystroke",this._getTooltipString.bind(this));const s={tag:"button",attributes:{class:["ck","ck-button",i.to("class"),i.if("isEnabled","ck-disabled",(e=>!e)),i.if("isVisible","ck-hidden",(e=>!e)),i.to("isOn",(e=>e?"ck-on":"ck-off")),i.if("withText","ck-button_with-text"),i.if("withKeystroke","ck-button_with-keystroke")],role:i.to("role"),type:i.to("type",(e=>e||"button")),tabindex:i.to("tabindex"),"aria-checked":i.to("_ariaChecked"),"aria-pressed":i.to("_ariaPressed"),"aria-label":i.to("ariaLabel"),"aria-labelledby":i.to("ariaLabelledBy"),"aria-disabled":i.if("isEnabled",!0,(e=>!e)),"data-cke-tooltip-text":i.to("_tooltipString"),"data-cke-tooltip-position":i.to("tooltipPosition")},children:this.children,on:{click:i.to((e=>{this.isEnabled?this.fire("execute"):e.preventDefault();}))}};this.bind("_ariaPressed").to(this,"isOn",this,"isToggleable",this,"role",((e,t,i)=>!(!t||Tf(i))&&String(!!e))),this.bind("_ariaChecked").to(this,"isOn",this,"isToggleable",this,"role",((e,t,i)=>!(!t||!Tf(i))&&String(!!e))),o.isSafari&&(this._focusDelayed||(this._focusDelayed=Fa((()=>this.focus()),0)),s.on.mousedown=i.to((()=>{this._focusDelayed();})),s.on.mouseup=i.to((()=>{this._focusDelayed.cancel();}))),this.setTemplate(s);}render(){super.render(),this.icon&&(this.iconView.bind("content").to(this,"icon"),this.children.add(this.iconView)),this.children.add(this.labelView),this.withKeystroke&&this.keystroke&&this.children.add(this.keystrokeView);}focus(){this.element.focus();}destroy(){this._focusDelayed&&this._focusDelayed.cancel(),super.destroy();}_setupLabelView(e){return e.bind("text","style","id").to(this,"label","labelStyle","ariaLabelledBy"),e}_createKeystrokeView(){const e=new wf;return e.setTemplate({tag:"span",attributes:{class:["ck","ck-button__keystroke"]},children:[{text:this.bindTemplate.to("keystroke",(e=>wa(e)))}]}),e}_getTooltipString(e,t,i){return e?"string"==typeof e?e:(i&&(i=wa(i)),e instanceof Function?e(t,i):`${t}${i?` (${i})`:""}`):""}}function Tf(e){switch(e){case"radio":case"checkbox":case"option":case"switch":case"menuitemcheckbox":case"menuitemradio":return !0;default:return !1}}class Sf extends wf{children;iconView;constructor(e,t={}){super(e);const i=this.bindTemplate;this.set("label",t.label||""),this.set("class",t.class||null),this.children=this.createCollection(),this.setTemplate({tag:"div",attributes:{class:["ck","ck-form__header",i.to("class")]},children:this.children}),t.icon&&(this.iconView=new xf,this.iconView.content=t.icon,this.children.add(this.iconView));const n=new wf(e);n.setTemplate({tag:"h2",attributes:{class:["ck","ck-form__header__label"],role:"presentation"},children:[{text:i.to("label")}]}),this.children.add(n);}}class If extends(F()){focusables;focusTracker;keystrokeHandler;actions;constructor(e){if(super(),this.focusables=e.focusables,this.focusTracker=e.focusTracker,this.keystrokeHandler=e.keystrokeHandler,this.actions=e.actions,e.actions&&e.keystrokeHandler)for(const t in e.actions){let i=e.actions[t];"string"==typeof i&&(i=[i]);for(const n of i)e.keystrokeHandler.set(n,((e,i)=>{this[t](),i();}),e.keystrokeHandlerOptions);}this.on("forwardCycle",(()=>this.focusFirst()),{priority:"low"}),this.on("backwardCycle",(()=>this.focusLast()),{priority:"low"});}get first(){return this.focusables.find(Pf)||null}get last(){return this.focusables.filter(Pf).slice(-1)[0]||null}get next(){return this._getDomFocusableItem(1)}get previous(){return this._getDomFocusableItem(-1)}get current(){let e=null;return null===this.focusTracker.focusedElement?null:(this.focusables.find(((t,i)=>{const n=t.element===this.focusTracker.focusedElement;return n&&(e=i),n})),e)}focusFirst(){this._focus(this.first,1);}focusLast(){this._focus(this.last,-1);}focusNext(){const e=this.next;e&&this.focusables.getIndex(e)===this.current||e===this.first?this.fire("forwardCycle"):this._focus(e,1);}focusPrevious(){const e=this.previous;e&&this.focusables.getIndex(e)===this.current||e===this.last?this.fire("backwardCycle"):this._focus(e,-1);}chain(e){const t=()=>null===this.current?null:this.focusables.get(this.current);this.listenTo(e,"forwardCycle",(e=>{const i=t();this.focusNext(),i!==t()&&e.stop();}),{priority:"low"}),this.listenTo(e,"backwardCycle",(e=>{const i=t();this.focusPrevious(),i!==t()&&e.stop();}),{priority:"low"});}unchain(e){this.stopListening(e);}_focus(e,t){e&&this.focusTracker.focusedElement!==e.element&&e.focus(t);}_getDomFocusableItem(e){const t=this.focusables.length;if(!t)return null;const i=this.current;if(null===i)return this[1===e?"first":"last"];let n=this.focusables.get(i),s=(i+t+e)%t;do{const i=this.focusables.get(s);if(Pf(i)){n=i;break}s=(s+t+e)%t;}while(s!==i);return n}}function Pf(e){return Vf(e)&&Zr(e.element)}function Vf(e){return !(!("focus"in e)||"function"!=typeof e.focus)}function Rf(e){return Vf(e)&&"focusCycler"in e&&e.focusCycler instanceof If}function Bf(e){return class extends e{_onDragBound=this._onDrag.bind(this);_onDragEndBound=this._onDragEnd.bind(this);_lastDraggingCoordinates={x:0,y:0};constructor(...e){super(...e),this.on("render",(()=>{this._attachListeners();})),this.set("isDragging",!1);}_attachListeners(){this.listenTo(this.element,"mousedown",this._onDragStart.bind(this)),this.listenTo(this.element,"touchstart",this._onDragStart.bind(this));}_attachDragListeners(){this.listenTo(i.document,"mouseup",this._onDragEndBound),this.listenTo(i.document,"touchend",this._onDragEndBound),this.listenTo(i.document,"mousemove",this._onDragBound),this.listenTo(i.document,"touchmove",this._onDragBound);}_detachDragListeners(){this.stopListening(i.document,"mouseup",this._onDragEndBound),this.stopListening(i.document,"touchend",this._onDragEndBound),this.stopListening(i.document,"mousemove",this._onDragBound),this.stopListening(i.document,"touchmove",this._onDragBound);}_onDragStart(e,t){if(!this._isHandleElementPressed(t))return;this._attachDragListeners();let i=0,n=0;t instanceof MouseEvent?(i=t.clientX,n=t.clientY):(i=t.touches[0].clientX,n=t.touches[0].clientY),this._lastDraggingCoordinates={x:i,y:n},this.isDragging=!0;}_onDrag(e,t){if(!this.isDragging)return void this._detachDragListeners();let i=0,n=0;t instanceof MouseEvent?(i=t.clientX,n=t.clientY):(i=t.touches[0].clientX,n=t.touches[0].clientY),t.preventDefault(),this.fire("drag",{deltaX:Math.round(i-this._lastDraggingCoordinates.x),deltaY:Math.round(n-this._lastDraggingCoordinates.y)}),this._lastDraggingCoordinates={x:i,y:n};}_onDragEnd(){this._detachDragListeners(),this.isDragging=!1;}_isHandleElementPressed(e){return !!this.dragHandleElement&&(this.dragHandleElement===e.target||e.target instanceof HTMLElement&&this.dragHandleElement.contains(e.target))}}}class Of extends wf{children;keystrokes;focusCycler;_focusTracker;_focusables;constructor(e){super(e),this.children=this.createCollection(),this.keystrokes=new Va,this._focusTracker=new Pa,this._focusables=new Zg,this.focusCycler=new If({focusables:this._focusables,focusTracker:this._focusTracker,keystrokeHandler:this.keystrokes,actions:{focusPrevious:"shift + tab",focusNext:"tab"}}),this.setTemplate({tag:"div",attributes:{class:["ck","ck-dialog__actions"]},children:this.children});}render(){super.render(),this.keystrokes.listenTo(this.element);}setButtons(e){for(const t of e){const e=new Ef(this.locale);let i;for(i in e.on("execute",(()=>t.onExecute())),t.onCreate&&t.onCreate(e),t)"onExecute"!=i&&"onCreate"!=i&&e.set(i,t[i]);this.children.add(e);}this._updateFocusCyclableItems();}focus(e){-1===e?this.focusCycler.focusLast():this.focusCycler.focusFirst();}_updateFocusCyclableItems(){Array.from(this.children).forEach((e=>{this._focusables.add(e),this._focusTracker.add(e.element);}));}}class Mf extends wf{children;constructor(e){super(e),this.children=this.createCollection(),this.setTemplate({tag:"div",attributes:{class:["ck","ck-dialog__content"]},children:this.children});}reset(){for(;this.children.length;)this.children.remove(0);}}const Lf={SCREEN_CENTER:"screen-center",EDITOR_CENTER:"editor-center",EDITOR_TOP_SIDE:"editor-top-side",EDITOR_TOP_CENTER:"editor-top-center",EDITOR_BOTTOM_CENTER:"editor-bottom-center",EDITOR_ABOVE_CENTER:"editor-above-center",EDITOR_BELOW_CENTER:"editor-below-center"},Ff=Wr("px");class Nf extends(Bf(wf)){parts;headerView;closeButtonView;actionsView;static defaultOffset=15;contentView;keystrokes;focusTracker;wasMoved=!1;_getCurrentDomRoot;_getViewportOffset;_focusables;_focusCycler;constructor(e,{getCurrentDomRoot:t,getViewportOffset:i}){super(e);const n=this.bindTemplate,s=e.t;this.set("className",""),this.set("ariaLabel",s("Editor dialog")),this.set("isModal",!1),this.set("position",Lf.SCREEN_CENTER),this.set("_isVisible",!1),this.set("_isTransparent",!1),this.set("_top",0),this.set("_left",0),this._getCurrentDomRoot=t,this._getViewportOffset=i,this.decorate("moveTo"),this.parts=this.createCollection(),this.keystrokes=new Va,this.focusTracker=new Pa,this._focusables=new Zg,this._focusCycler=new If({focusables:this._focusables,focusTracker:this.focusTracker,keystrokeHandler:this.keystrokes,actions:{focusPrevious:"shift + tab",focusNext:"tab"}}),this.setTemplate({tag:"div",attributes:{class:["ck","ck-dialog-overlay",n.if("isModal","ck-dialog-overlay__transparent",(e=>!e)),n.if("_isVisible","ck-hidden",(e=>!e))],tabindex:"-1"},children:[{tag:"div",attributes:{tabindex:"-1",class:["ck","ck-dialog",n.to("className")],role:"dialog","aria-label":n.to("ariaLabel"),style:{top:n.to("_top",(e=>Ff(e))),left:n.to("_left",(e=>Ff(e))),visibility:n.if("_isTransparent","hidden")}},children:this.parts}]});}render(){super.render(),this.keystrokes.set("Esc",((e,t)=>{this.fire("close",{source:"escKeyPress"}),t();})),this.on("drag",((e,{deltaX:t,deltaY:i})=>{this.wasMoved=!0,this.moveBy(t,i);})),this.listenTo(i.window,"resize",(()=>{this._isVisible&&!this.wasMoved&&this.updatePosition();})),this.listenTo(i.document,"scroll",(()=>{this._isVisible&&!this.wasMoved&&this.updatePosition();})),this.on("change:_isVisible",((e,t,i)=>{i&&(this._isTransparent=!0,setTimeout((()=>{this.updatePosition(),this._isTransparent=!1,this.focus();}),10));})),this.keystrokes.listenTo(this.element);}get dragHandleElement(){return this.headerView?this.headerView.element:null}setupParts({icon:e,title:t,hasCloseButton:i=!0,content:n,actionButtons:s}){t&&(this.headerView=new Sf(this.locale,{icon:e}),i&&(this.closeButtonView=this._createCloseButton(),this.headerView.children.add(this.closeButtonView)),this.headerView.label=t,this.ariaLabel=t,this.parts.add(this.headerView,0)),n&&(n instanceof wf&&(n=[n]),this.contentView=new Mf(this.locale),this.contentView.children.addMany(n),this.parts.add(this.contentView)),s&&(this.actionsView=new Of(this.locale),this.actionsView.setButtons(s),this.parts.add(this.actionsView)),this._updateFocusCyclableItems();}focus(){this._focusCycler.focusFirst();}moveTo(e,t){const i=this._getViewportRect(),n=this._getDialogRect();e+n.width>i.right&&(e=i.right-n.width),e<i.left&&(e=i.left),t<i.top&&(t=i.top),this._moveTo(e,t);}_moveTo(e,t){this._left=e,this._top=t;}moveBy(e,t){this.moveTo(this._left+e,this._top+t);}_moveOffScreen(){this._moveTo(-9999,-9999);}updatePosition(){if(!this.element||!this.element.parentNode)return;const e=this._getViewportRect();let t,i=this.position;this._getCurrentDomRoot()?t=this._getVisibleDomRootRect(e):i=Lf.SCREEN_CENTER;const n=Nf.defaultOffset,s=this._getDialogRect();switch(i){case Lf.EDITOR_TOP_SIDE:if(t){const e="ltr"===this.locale.contentLanguageDirection?t.right-s.width-n:t.left+n;this.moveTo(e,t.top+n);}else this._moveOffScreen();break;case Lf.EDITOR_CENTER:t?this.moveTo(Math.round(t.left+t.width/2-s.width/2),Math.round(t.top+t.height/2-s.height/2)):this._moveOffScreen();break;case Lf.SCREEN_CENTER:this.moveTo(Math.round((e.width-s.width)/2),Math.round((e.height-s.height)/2));break;case Lf.EDITOR_TOP_CENTER:t?this.moveTo(Math.round(t.left+t.width/2-s.width/2),t.top+n):this._moveOffScreen();break;case Lf.EDITOR_BOTTOM_CENTER:t?this.moveTo(Math.round(t.left+t.width/2-s.width/2),t.bottom-s.height-n):this._moveOffScreen();break;case Lf.EDITOR_ABOVE_CENTER:t?this.moveTo(Math.round(t.left+t.width/2-s.width/2),t.top-s.height-n):this._moveOffScreen();break;case Lf.EDITOR_BELOW_CENTER:t?this.moveTo(Math.round(t.left+t.width/2-s.width/2),t.bottom+n):this._moveOffScreen();}}_getVisibleDomRootRect(e){let t=new Fr(this._getCurrentDomRoot()).getVisible();return t?(t=e.getIntersection(t),t||null):null}_getDialogRect(){return new Fr(this.element.firstElementChild)}_getViewportRect(){return function(e){e=Object.assign({top:0,bottom:0,left:0,right:0},e);const t=new Fr(i.window);return t.top+=e.top,t.height-=e.top,t.bottom-=e.bottom,t.height-=e.bottom,t.left+=e.left,t.right-=e.right,t.width-=e.left+e.right,t}(this._getViewportOffset())}_updateFocusCyclableItems(){const e=[];if(this.contentView)for(const t of this.contentView.children)Vf(t)&&e.push(t);this.actionsView&&e.push(this.actionsView),this.closeButtonView&&e.push(this.closeButtonView),e.forEach((e=>{this._focusables.add(e),this.focusTracker.add(e.element),Rf(e)&&this._focusCycler.chain(e.focusCycler);}));}_createCloseButton(){const e=new Ef(this.locale),t=this.locale.t;return e.set({label:t("Close"),tooltip:!0,icon:Ig.cancel}),e.on("execute",(()=>this.fire("close",{source:"closeButton"}))),e}}class Df extends Ga{view;static _visibleDialogPlugin;_onHide;static get pluginName(){return "Dialog"}constructor(e){super(e);const t=e.t;this._initShowHideListeners(),this._initFocusToggler(),this._initMultiRootIntegration(),this.set({id:null,isOpen:!1}),e.accessibility.addKeystrokeInfos({categoryId:"navigation",keystrokes:[{label:t("Move focus in and out of an active dialog window"),keystroke:"Ctrl+F6",mayRequireFn:!0}]});}_initShowHideListeners(){this.on("show",((e,t)=>{this._show(t);})),this.on("show",((e,t)=>{t.onShow&&t.onShow(this);}),{priority:"low"}),this.on("hide",(()=>{Df._visibleDialogPlugin&&Df._visibleDialogPlugin._hide();})),this.on("hide",(()=>{this._onHide&&(this._onHide(this),this._onHide=void 0);}),{priority:"low"});}_initFocusToggler(){const e=this.editor;e.keystrokes.set("Ctrl+F6",((t,i)=>{this.isOpen&&!this.view.isModal&&(this.view.focusTracker.isFocused?e.editing.view.focus():this.view.focus(),i());}));}_initMultiRootIntegration(){const e=this.editor.model;e.document.on("change:data",(()=>{if(!this.view)return;const t=e.document.differ.getChangedRoots();for(const e of t)e.state&&this.view.updatePosition();}));}show(e){this.hide(),this.fire(`show:${e.id}`,e);}_show({id:e,icon:t,title:i,hasCloseButton:n=!0,content:s,actionButtons:o,className:r,isModal:a,position:l,onHide:c}){const d=this.editor;this.view=new Nf(d.locale,{getCurrentDomRoot:()=>d.editing.view.getDomRoot(d.model.document.selection.anchor.root.rootName),getViewportOffset:()=>d.ui.viewportOffset});const h=this.view;h.on("close",(()=>{this.hide();})),d.ui.view.body.add(h),d.keystrokes.listenTo(h.element),l||(l=a?Lf.SCREEN_CENTER:Lf.EDITOR_CENTER),h.set({position:l,_isVisible:!0,className:r,isModal:a}),h.setupParts({icon:t,title:i,hasCloseButton:n,content:s,actionButtons:o}),this.id=e,c&&(this._onHide=c),this.isOpen=!0,Df._visibleDialogPlugin=this;}hide(){Df._visibleDialogPlugin&&Df._visibleDialogPlugin.fire(`hide:${Df._visibleDialogPlugin.id}`);}_hide(){if(!this.view)return;const e=this.editor,t=this.view;t.contentView&&t.contentView.reset(),e.ui.view.body.remove(t),e.ui.focusTracker.remove(t.element),e.keystrokes.stopListening(t.element),t.destroy(),e.editing.view.focus(),this.id=null,this.isOpen=!1,Df._visibleDialogPlugin=null;}}class zf extends Ef{_checkIconHolderView=new Hf;constructor(e,t=new Af){super(e,t),this.set({hasCheckSpace:!1,_hasCheck:this.isToggleable});const i=this.bindTemplate;this.extendTemplate({attributes:{class:["ck-list-item-button",i.if("isToggleable","ck-list-item-button_toggleable")]}}),this.bind("_hasCheck").to(this,"hasCheckSpace",this,"isToggleable",((e,t)=>e||t));}render(){super.render(),this._hasCheck&&this.children.add(this._checkIconHolderView,0),this._watchCheckIconHolderMount();}_watchCheckIconHolderMount(){this._checkIconHolderView.bind("isOn").to(this,"isOn",(e=>this.isToggleable&&e)),this.on("change:_hasCheck",((e,t,i)=>{const{children:n,_checkIconHolderView:s}=this;i?n.add(s,0):n.remove(s);}));}}class Hf extends wf{children;_checkIconView=this._createCheckIconView();constructor(){super();const e=this.bindTemplate;this.children=this.createCollection(),this.set("isOn",!1),this.setTemplate({tag:"span",children:this.children,attributes:{class:["ck","ck-list-item-button__check-holder",e.to("isOn",(e=>e?"ck-on":"ck-off"))]}});}render(){super.render(),this.isOn&&this.children.add(this._checkIconView,0),this._watchCheckIconMount();}_watchCheckIconMount(){this.on("change:isOn",((e,t,i)=>{const{children:n,_checkIconView:s}=this;i&&!n.has(s)?n.add(s):!i&&n.has(s)&&n.remove(s);}));}_createCheckIconView(){const e=new xf;return e.content=Ig.check,e.extendTemplate({attributes:{class:"ck-list-item-button__check-icon"}}),e}}class $f extends zf{constructor(e){super(e),this.set({withText:!0,withKeystroke:!0,tooltip:!1,role:"menuitem"}),this.extendTemplate({attributes:{class:["ck-menu-bar__menu__item__button"]}});}}class Uf extends wf{id;constructor(e){super(e),this.set("text",void 0),this.set("for",void 0),this.id=`ck-editor__label_${k()}`;const t=this.bindTemplate;this.setTemplate({tag:"label",attributes:{class:["ck","ck-label"],id:this.id,for:t.to("for")},children:[{text:t.to("text")}]});}}class Wf extends wf{constructor(e,t){super(e);const i=e.t,n=new Uf;n.text=i("Help Contents. To close this dialog press ESC."),this.setTemplate({tag:"div",attributes:{class:["ck","ck-accessibility-help-dialog__content"],"aria-labelledby":n.id,role:"document",tabindex:-1},children:[wr(document,"p",{},i("Below, you can find a list of keyboard shortcuts that can be used in the editor.")),...this._createCategories(Array.from(t.values())),n]});}focus(){this.element.focus();}_createCategories(e){return e.map((e=>{const t=[wr(document,"h3",{},e.label),...Array.from(e.groups.values()).map((e=>this._createGroup(e))).flat()];return e.description&&t.splice(1,0,wr(document,"p",{},e.description)),wr(document,"section",{},t)}))}_createGroup(e){const t=e.keystrokes.sort(((e,t)=>e.label.localeCompare(t.label))).map((e=>this._createGroupRow(e))).flat(),i=[wr(document,"dl",{},t)];return e.label&&i.unshift(wr(document,"h4",{},e.label)),i}_createGroupRow(e){const t=this.locale.t,i=wr(document,"dt"),n=wr(document,"dd"),s=function(e){if("string"==typeof e)return [[e]];if("string"==typeof e[0])return [e];return e}(e.keystroke),r=[];for(const e of s)r.push(e.map(jf).join(""));return i.innerHTML=e.label,n.innerHTML=r.join(", ")+(e.mayRequireFn&&o.isMac?` ${t("(may require <kbd>Fn</kbd>)")}`:""),[i,n]}}function jf(e){return wa(e).split("+").map((e=>`<kbd>${e}</kbd>`)).join("+")}var qf='<svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10 6.628a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3Z"/><path d="M8.5 9.125a.3.3 0 0 0-.253-.296L5.11 8.327a.75.75 0 1 1 .388-1.449l4.04.716c.267.072.624.08.893.009l4.066-.724a.75.75 0 1 1 .388 1.45l-3.132.5a.3.3 0 0 0-.253.296v1.357a.3.3 0 0 0 .018.102l1.615 4.438a.75.75 0 0 1-1.41.513l-1.35-3.71a.3.3 0 0 0-.281-.197h-.209a.3.3 0 0 0-.282.198l-1.35 3.711a.75.75 0 0 1-1.41-.513l1.64-4.509a.3.3 0 0 0 .019-.103V9.125Z"/><path clip-rule="evenodd" d="M10 18.5a8.5 8.5 0 1 1 0-17 8.5 8.5 0 0 1 0 17Zm0 1.5c5.523 0 10-4.477 10-10S15.523 0 10 0 0 4.477 0 10s4.477 10 10 10Z"/></svg>';class Gf extends Ga{contentView=null;static get requires(){return [Df]}static get pluginName(){return "AccessibilityHelp"}init(){const e=this.editor,t=e.locale.t;e.ui.componentFactory.add("accessibilityHelp",(()=>{const e=this._createButton(Ef);return e.set({tooltip:!0,withText:!1,label:t("Accessibility help")}),e})),e.ui.componentFactory.add("menuBar:accessibilityHelp",(()=>{const e=this._createButton($f);return e.label=t("Accessibility"),e})),e.keystrokes.set("Alt+0",((e,t)=>{this._toggleDialog(),t();})),this._setupRootLabels();}_createButton(e){const t=this.editor,i=t.plugins.get("Dialog"),n=new e(t.locale);return n.set({keystroke:"Alt+0",icon:qf,isToggleable:!0}),n.on("execute",(()=>this._toggleDialog())),n.bind("isOn").to(i,"id",(e=>"accessibilityHelp"===e)),n}_setupRootLabels(){const e=this.editor,t=e.editing.view,i=e.t;function n(e,t){const n=[t.getAttribute("aria-label"),i("Press %0 for help.",[wa("Alt+0")])].filter((e=>e)).join(". ");e.setAttribute("aria-label",n,t);}e.ui.on("ready",(()=>{t.change((e=>{for(const i of t.document.roots)n(e,i);})),e.on("addRoot",((i,s)=>{const o=e.editing.view.document.getRoot(s.rootName);t.change((e=>n(e,o)));}),{priority:"low"});}));}_toggleDialog(){const e=this.editor,t=e.plugins.get("Dialog"),i=e.locale.t;this.contentView||(this.contentView=new Wf(e.locale,e.accessibility.keystrokeInfos)),"accessibilityHelp"===t.id?t.hide():t.show({id:"accessibilityHelp",className:"ck-accessibility-help-dialog",title:i("Accessibility help"),icon:qf,hasCloseButton:!0,content:this.contentView});}}class Kf extends Zg{locale;_bodyCollectionContainer;constructor(e,t=[]){super(t),this.locale=e;}get bodyCollectionContainer(){return this._bodyCollectionContainer}attachToDom(){this._bodyCollectionContainer=new Jg({tag:"div",attributes:{class:["ck","ck-reset_all","ck-body","ck-rounded-corners"],dir:this.locale.uiLanguageDirection,role:"application"},children:this}).render();let e=document.querySelector(".ck-body-wrapper");e||(e=wr(document,"div",{class:"ck-body-wrapper"}),document.body.appendChild(e)),e.appendChild(this._bodyCollectionContainer);}detachFromDom(){super.destroy(),this._bodyCollectionContainer&&this._bodyCollectionContainer.remove();const e=document.querySelector(".ck-body-wrapper");e&&0==e.childElementCount&&e.remove();}}class Zf extends Ef{toggleSwitchView;constructor(e){super(e),this.isToggleable=!0,this.toggleSwitchView=this._createToggleView(),this.extendTemplate({attributes:{class:"ck-switchbutton"}});}render(){super.render(),this.children.add(this.toggleSwitchView);}_createToggleView(){const e=new wf;return e.setTemplate({tag:"span",attributes:{class:["ck","ck-button__toggle"]},children:[{tag:"span",attributes:{class:["ck","ck-button__toggle__inner"]}}]}),e}}class Jf extends(Yf(Ef)){}class Qf extends(Yf(zf)){}function Yf(e){return class extends e{buttonView;_fileInputView;constructor(...e){super(...e),this.buttonView=this,this._fileInputView=new Xf(this.locale),this._fileInputView.bind("acceptedType").to(this),this._fileInputView.bind("allowMultipleFiles").to(this),this._fileInputView.delegate("done").to(this),this.on("execute",(()=>{this._fileInputView.open();})),this.extendTemplate({attributes:{class:"ck-file-dialog-button"}});}render(){super.render(),this.children.add(this._fileInputView);}}}class Xf extends wf{constructor(e){super(e),this.set("acceptedType",void 0),this.set("allowMultipleFiles",!1);const t=this.bindTemplate;this.setTemplate({tag:"input",attributes:{class:["ck-hidden"],type:"file",tabindex:"-1",accept:t.to("acceptedType"),multiple:t.to("allowMultipleFiles")},on:{change:t.to((()=>{this.element&&this.element.files&&this.element.files.length&&this.fire("done",this.element.files),this.element.value="";}))}});}open(){this.element.click();}}var ep='<svg viewBox="0 0 10 10" xmlns="http://www.w3.org/2000/svg"><path d="M.941 4.523a.75.75 0 1 1 1.06-1.06l3.006 3.005 3.005-3.005a.75.75 0 1 1 1.06 1.06l-3.549 3.55a.75.75 0 0 1-1.168-.136L.941 4.523z"/></svg>';class tp extends wf{buttonView;children;constructor(e,t){super(e);const i=this.bindTemplate;this.set("isCollapsed",!1),this.set("label",""),this.buttonView=this._createButtonView(),this.children=this.createCollection(),this.set("_collapsibleAriaLabelUid",void 0),t&&this.children.addMany(t),this.setTemplate({tag:"div",attributes:{class:["ck","ck-collapsible",i.if("isCollapsed","ck-collapsible_collapsed")]},children:[this.buttonView,{tag:"div",attributes:{class:["ck","ck-collapsible__children"],role:"region",hidden:i.if("isCollapsed","hidden"),"aria-labelledby":i.to("_collapsibleAriaLabelUid")},children:this.children}]});}render(){super.render(),this._collapsibleAriaLabelUid=this.buttonView.labelView.element.id;}focus(){this.buttonView.focus();}_createButtonView(){const e=new Ef(this.locale),t=e.bindTemplate;return e.set({withText:!0,icon:ep}),e.extendTemplate({attributes:{"aria-expanded":t.to("isOn",(e=>String(e)))}}),e.bind("label").to(this),e.bind("isOn").to(this,"isCollapsed",(e=>!e)),e.on("execute",(()=>{this.isCollapsed=!this.isCollapsed;})),e}}var ap={aliceblue:[240,248,255],antiquewhite:[250,235,215],aqua:[0,255,255],aquamarine:[127,255,212],azure:[240,255,255],beige:[245,245,220],bisque:[255,228,196],black:[0,0,0],blanchedalmond:[255,235,205],blue:[0,0,255],blueviolet:[138,43,226],brown:[165,42,42],burlywood:[222,184,135],cadetblue:[95,158,160],chartreuse:[127,255,0],chocolate:[210,105,30],coral:[255,127,80],cornflowerblue:[100,149,237],cornsilk:[255,248,220],crimson:[220,20,60],cyan:[0,255,255],darkblue:[0,0,139],darkcyan:[0,139,139],darkgoldenrod:[184,134,11],darkgray:[169,169,169],darkgreen:[0,100,0],darkgrey:[169,169,169],darkkhaki:[189,183,107],darkmagenta:[139,0,139],darkolivegreen:[85,107,47],darkorange:[255,140,0],darkorchid:[153,50,204],darkred:[139,0,0],darksalmon:[233,150,122],darkseagreen:[143,188,143],darkslateblue:[72,61,139],darkslategray:[47,79,79],darkslategrey:[47,79,79],darkturquoise:[0,206,209],darkviolet:[148,0,211],deeppink:[255,20,147],deepskyblue:[0,191,255],dimgray:[105,105,105],dimgrey:[105,105,105],dodgerblue:[30,144,255],firebrick:[178,34,34],floralwhite:[255,250,240],forestgreen:[34,139,34],fuchsia:[255,0,255],gainsboro:[220,220,220],ghostwhite:[248,248,255],gold:[255,215,0],goldenrod:[218,165,32],gray:[128,128,128],green:[0,128,0],greenyellow:[173,255,47],grey:[128,128,128],honeydew:[240,255,240],hotpink:[255,105,180],indianred:[205,92,92],indigo:[75,0,130],ivory:[255,255,240],khaki:[240,230,140],lavender:[230,230,250],lavenderblush:[255,240,245],lawngreen:[124,252,0],lemonchiffon:[255,250,205],lightblue:[173,216,230],lightcoral:[240,128,128],lightcyan:[224,255,255],lightgoldenrodyellow:[250,250,210],lightgray:[211,211,211],lightgreen:[144,238,144],lightgrey:[211,211,211],lightpink:[255,182,193],lightsalmon:[255,160,122],lightseagreen:[32,178,170],lightskyblue:[135,206,250],lightslategray:[119,136,153],lightslategrey:[119,136,153],lightsteelblue:[176,196,222],lightyellow:[255,255,224],lime:[0,255,0],limegreen:[50,205,50],linen:[250,240,230],magenta:[255,0,255],maroon:[128,0,0],mediumaquamarine:[102,205,170],mediumblue:[0,0,205],mediumorchid:[186,85,211],mediumpurple:[147,112,219],mediumseagreen:[60,179,113],mediumslateblue:[123,104,238],mediumspringgreen:[0,250,154],mediumturquoise:[72,209,204],mediumvioletred:[199,21,133],midnightblue:[25,25,112],mintcream:[245,255,250],mistyrose:[255,228,225],moccasin:[255,228,181],navajowhite:[255,222,173],navy:[0,0,128],oldlace:[253,245,230],olive:[128,128,0],olivedrab:[107,142,35],orange:[255,165,0],orangered:[255,69,0],orchid:[218,112,214],palegoldenrod:[238,232,170],palegreen:[152,251,152],paleturquoise:[175,238,238],palevioletred:[219,112,147],papayawhip:[255,239,213],peachpuff:[255,218,185],peru:[205,133,63],pink:[255,192,203],plum:[221,160,221],powderblue:[176,224,230],purple:[128,0,128],rebeccapurple:[102,51,153],red:[255,0,0],rosybrown:[188,143,143],royalblue:[65,105,225],saddlebrown:[139,69,19],salmon:[250,128,114],sandybrown:[244,164,96],seagreen:[46,139,87],seashell:[255,245,238],sienna:[160,82,45],silver:[192,192,192],skyblue:[135,206,235],slateblue:[106,90,205],slategray:[112,128,144],slategrey:[112,128,144],snow:[255,250,250],springgreen:[0,255,127],steelblue:[70,130,180],tan:[210,180,140],teal:[0,128,128],thistle:[216,191,216],tomato:[255,99,71],turquoise:[64,224,208],violet:[238,130,238],wheat:[245,222,179],white:[255,255,255],whitesmoke:[245,245,245],yellow:[255,255,0],yellowgreen:[154,205,50]};const dp=ap,hp={};for(const e of Object.keys(dp))hp[dp[e]]=e;const up={rgb:{channels:3,labels:"rgb"},hsl:{channels:3,labels:"hsl"},hsv:{channels:3,labels:"hsv"},hwb:{channels:3,labels:"hwb"},cmyk:{channels:4,labels:"cmyk"},xyz:{channels:3,labels:"xyz"},lab:{channels:3,labels:"lab"},lch:{channels:3,labels:"lch"},hex:{channels:1,labels:["hex"]},keyword:{channels:1,labels:["keyword"]},ansi16:{channels:1,labels:["ansi16"]},ansi256:{channels:1,labels:["ansi256"]},hcg:{channels:3,labels:["h","c","g"]},apple:{channels:3,labels:["r16","g16","b16"]},gray:{channels:1,labels:["gray"]}};var mp=up;for(const e of Object.keys(up)){if(!("channels"in up[e]))throw new Error("missing channels property: "+e);if(!("labels"in up[e]))throw new Error("missing channel labels property: "+e);if(up[e].labels.length!==up[e].channels)throw new Error("channel and label counts mismatch: "+e);const{channels:t,labels:i}=up[e];delete up[e].channels,delete up[e].labels,Object.defineProperty(up[e],"channels",{value:t}),Object.defineProperty(up[e],"labels",{value:i});}function gp(e,t){return (e[0]-t[0])**2+(e[1]-t[1])**2+(e[2]-t[2])**2}up.rgb.hsl=function(e){const t=e[0]/255,i=e[1]/255,n=e[2]/255,s=Math.min(t,i,n),o=Math.max(t,i,n),r=o-s;let a,l;o===s?a=0:t===o?a=(i-n)/r:i===o?a=2+(n-t)/r:n===o&&(a=4+(t-i)/r),a=Math.min(60*a,360),a<0&&(a+=360);const c=(s+o)/2;return l=o===s?0:c<=.5?r/(o+s):r/(2-o-s),[a,100*l,100*c]},up.rgb.hsv=function(e){let t,i,n,s,o;const r=e[0]/255,a=e[1]/255,l=e[2]/255,c=Math.max(r,a,l),d=c-Math.min(r,a,l),h=function(e){return (c-e)/6/d+.5};return 0===d?(s=0,o=0):(o=d/c,t=h(r),i=h(a),n=h(l),r===c?s=n-i:a===c?s=1/3+t-n:l===c&&(s=2/3+i-t),s<0?s+=1:s>1&&(s-=1)),[360*s,100*o,100*c]},up.rgb.hwb=function(e){const t=e[0],i=e[1];let n=e[2];const s=up.rgb.hsl(e)[0],o=1/255*Math.min(t,Math.min(i,n));return n=1-1/255*Math.max(t,Math.max(i,n)),[s,100*o,100*n]},up.rgb.cmyk=function(e){const t=e[0]/255,i=e[1]/255,n=e[2]/255,s=Math.min(1-t,1-i,1-n);return [100*((1-t-s)/(1-s)||0),100*((1-i-s)/(1-s)||0),100*((1-n-s)/(1-s)||0),100*s]},up.rgb.keyword=function(e){const t=hp[e];if(t)return t;let i,n=1/0;for(const t of Object.keys(dp)){const s=gp(e,dp[t]);s<n&&(n=s,i=t);}return i},up.keyword.rgb=function(e){return dp[e]},up.rgb.xyz=function(e){let t=e[0]/255,i=e[1]/255,n=e[2]/255;t=t>.04045?((t+.055)/1.055)**2.4:t/12.92,i=i>.04045?((i+.055)/1.055)**2.4:i/12.92,n=n>.04045?((n+.055)/1.055)**2.4:n/12.92;return [100*(.4124*t+.3576*i+.1805*n),100*(.2126*t+.7152*i+.0722*n),100*(.0193*t+.1192*i+.9505*n)]},up.rgb.lab=function(e){const t=up.rgb.xyz(e);let i=t[0],n=t[1],s=t[2];i/=95.047,n/=100,s/=108.883,i=i>.008856?i**(1/3):7.787*i+16/116,n=n>.008856?n**(1/3):7.787*n+16/116,s=s>.008856?s**(1/3):7.787*s+16/116;return [116*n-16,500*(i-n),200*(n-s)]},up.hsl.rgb=function(e){const t=e[0]/360,i=e[1]/100,n=e[2]/100;let s,o,r;if(0===i)return r=255*n,[r,r,r];s=n<.5?n*(1+i):n+i-n*i;const a=2*n-s,l=[0,0,0];for(let e=0;e<3;e++)o=t+1/3*-(e-1),o<0&&o++,o>1&&o--,r=6*o<1?a+6*(s-a)*o:2*o<1?s:3*o<2?a+(s-a)*(2/3-o)*6:a,l[e]=255*r;return l},up.hsl.hsv=function(e){const t=e[0];let i=e[1]/100,n=e[2]/100,s=i;const o=Math.max(n,.01);n*=2,i*=n<=1?n:2-n,s*=o<=1?o:2-o;return [t,100*(0===n?2*s/(o+s):2*i/(n+i)),100*((n+i)/2)]},up.hsv.rgb=function(e){const t=e[0]/60,i=e[1]/100;let n=e[2]/100;const s=Math.floor(t)%6,o=t-Math.floor(t),r=255*n*(1-i),a=255*n*(1-i*o),l=255*n*(1-i*(1-o));switch(n*=255,s){case 0:return [n,l,r];case 1:return [a,n,r];case 2:return [r,n,l];case 3:return [r,a,n];case 4:return [l,r,n];case 5:return [n,r,a]}},up.hsv.hsl=function(e){const t=e[0],i=e[1]/100,n=e[2]/100,s=Math.max(n,.01);let o,r;r=(2-i)*n;const a=(2-i)*s;return o=i*s,o/=a<=1?a:2-a,o=o||0,r/=2,[t,100*o,100*r]},up.hwb.rgb=function(e){const t=e[0]/360;let i=e[1]/100,n=e[2]/100;const s=i+n;let o;s>1&&(i/=s,n/=s);const r=Math.floor(6*t),a=1-n;o=6*t-r,1&r&&(o=1-o);const l=i+o*(a-i);let c,d,h;switch(r){default:case 6:case 0:c=a,d=l,h=i;break;case 1:c=l,d=a,h=i;break;case 2:c=i,d=a,h=l;break;case 3:c=i,d=l,h=a;break;case 4:c=l,d=i,h=a;break;case 5:c=a,d=i,h=l;}return [255*c,255*d,255*h]},up.cmyk.rgb=function(e){const t=e[0]/100,i=e[1]/100,n=e[2]/100,s=e[3]/100;return [255*(1-Math.min(1,t*(1-s)+s)),255*(1-Math.min(1,i*(1-s)+s)),255*(1-Math.min(1,n*(1-s)+s))]},up.xyz.rgb=function(e){const t=e[0]/100,i=e[1]/100,n=e[2]/100;let s,o,r;return s=3.2406*t+-1.5372*i+-.4986*n,o=-.9689*t+1.8758*i+.0415*n,r=.0557*t+-.204*i+1.057*n,s=s>.0031308?1.055*s**(1/2.4)-.055:12.92*s,o=o>.0031308?1.055*o**(1/2.4)-.055:12.92*o,r=r>.0031308?1.055*r**(1/2.4)-.055:12.92*r,s=Math.min(Math.max(0,s),1),o=Math.min(Math.max(0,o),1),r=Math.min(Math.max(0,r),1),[255*s,255*o,255*r]},up.xyz.lab=function(e){let t=e[0],i=e[1],n=e[2];t/=95.047,i/=100,n/=108.883,t=t>.008856?t**(1/3):7.787*t+16/116,i=i>.008856?i**(1/3):7.787*i+16/116,n=n>.008856?n**(1/3):7.787*n+16/116;return [116*i-16,500*(t-i),200*(i-n)]},up.lab.xyz=function(e){let t,i,n;i=(e[0]+16)/116,t=e[1]/500+i,n=i-e[2]/200;const s=i**3,o=t**3,r=n**3;return i=s>.008856?s:(i-16/116)/7.787,t=o>.008856?o:(t-16/116)/7.787,n=r>.008856?r:(n-16/116)/7.787,t*=95.047,i*=100,n*=108.883,[t,i,n]},up.lab.lch=function(e){const t=e[0],i=e[1],n=e[2];let s;s=360*Math.atan2(n,i)/2/Math.PI,s<0&&(s+=360);return [t,Math.sqrt(i*i+n*n),s]},up.lch.lab=function(e){const t=e[0],i=e[1],n=e[2]/360*2*Math.PI;return [t,i*Math.cos(n),i*Math.sin(n)]},up.rgb.ansi16=function(e,t=null){const[i,n,s]=e;let o=null===t?up.rgb.hsv(e)[2]:t;if(o=Math.round(o/50),0===o)return 30;let r=30+(Math.round(s/255)<<2|Math.round(n/255)<<1|Math.round(i/255));return 2===o&&(r+=60),r},up.hsv.ansi16=function(e){return up.rgb.ansi16(up.hsv.rgb(e),e[2])},up.rgb.ansi256=function(e){const t=e[0],i=e[1],n=e[2];if(t===i&&i===n)return t<8?16:t>248?231:Math.round((t-8)/247*24)+232;return 16+36*Math.round(t/255*5)+6*Math.round(i/255*5)+Math.round(n/255*5)},up.ansi16.rgb=function(e){let t=e%10;if(0===t||7===t)return e>50&&(t+=3.5),t=t/10.5*255,[t,t,t];const i=.5*(1+~~(e>50));return [(1&t)*i*255,(t>>1&1)*i*255,(t>>2&1)*i*255]},up.ansi256.rgb=function(e){if(e>=232){const t=10*(e-232)+8;return [t,t,t]}let t;e-=16;return [Math.floor(e/36)/5*255,Math.floor((t=e%36)/6)/5*255,t%6/5*255]},up.rgb.hex=function(e){const t=(((255&Math.round(e[0]))<<16)+((255&Math.round(e[1]))<<8)+(255&Math.round(e[2]))).toString(16).toUpperCase();return "000000".substring(t.length)+t},up.hex.rgb=function(e){const t=e.toString(16).match(/[a-f0-9]{6}|[a-f0-9]{3}/i);if(!t)return [0,0,0];let i=t[0];3===t[0].length&&(i=i.split("").map((e=>e+e)).join(""));const n=parseInt(i,16);return [n>>16&255,n>>8&255,255&n]},up.rgb.hcg=function(e){const t=e[0]/255,i=e[1]/255,n=e[2]/255,s=Math.max(Math.max(t,i),n),o=Math.min(Math.min(t,i),n),r=s-o;let a,l;return a=r<1?o/(1-r):0,l=r<=0?0:s===t?(i-n)/r%6:s===i?2+(n-t)/r:4+(t-i)/r,l/=6,l%=1,[360*l,100*r,100*a]},up.hsl.hcg=function(e){const t=e[1]/100,i=e[2]/100,n=i<.5?2*t*i:2*t*(1-i);let s=0;return n<1&&(s=(i-.5*n)/(1-n)),[e[0],100*n,100*s]},up.hsv.hcg=function(e){const t=e[1]/100,i=e[2]/100,n=t*i;let s=0;return n<1&&(s=(i-n)/(1-n)),[e[0],100*n,100*s]},up.hcg.rgb=function(e){const t=e[0]/360,i=e[1]/100,n=e[2]/100;if(0===i)return [255*n,255*n,255*n];const s=[0,0,0],o=t%1*6,r=o%1,a=1-r;let l=0;switch(Math.floor(o)){case 0:s[0]=1,s[1]=r,s[2]=0;break;case 1:s[0]=a,s[1]=1,s[2]=0;break;case 2:s[0]=0,s[1]=1,s[2]=r;break;case 3:s[0]=0,s[1]=a,s[2]=1;break;case 4:s[0]=r,s[1]=0,s[2]=1;break;default:s[0]=1,s[1]=0,s[2]=a;}return l=(1-i)*n,[255*(i*s[0]+l),255*(i*s[1]+l),255*(i*s[2]+l)]},up.hcg.hsv=function(e){const t=e[1]/100,i=t+e[2]/100*(1-t);let n=0;return i>0&&(n=t/i),[e[0],100*n,100*i]},up.hcg.hsl=function(e){const t=e[1]/100,i=e[2]/100*(1-t)+.5*t;let n=0;return i>0&&i<.5?n=t/(2*i):i>=.5&&i<1&&(n=t/(2*(1-i))),[e[0],100*n,100*i]},up.hcg.hwb=function(e){const t=e[1]/100,i=t+e[2]/100*(1-t);return [e[0],100*(i-t),100*(1-i)]},up.hwb.hcg=function(e){const t=e[1]/100,i=1-e[2]/100,n=i-t;let s=0;return n<1&&(s=(i-n)/(1-n)),[e[0],100*n,100*s]},up.apple.rgb=function(e){return [e[0]/65535*255,e[1]/65535*255,e[2]/65535*255]},up.rgb.apple=function(e){return [e[0]/255*65535,e[1]/255*65535,e[2]/255*65535]},up.gray.rgb=function(e){return [e[0]/100*255,e[0]/100*255,e[0]/100*255]},up.gray.hsl=function(e){return [0,0,e[0]]},up.gray.hsv=up.gray.hsl,up.gray.hwb=function(e){return [0,100,e[0]]},up.gray.cmyk=function(e){return [0,0,0,e[0]]},up.gray.lab=function(e){return [e[0],0,0]},up.gray.hex=function(e){const t=255&Math.round(e[0]/100*255),i=((t<<16)+(t<<8)+t).toString(16).toUpperCase();return "000000".substring(i.length)+i},up.rgb.gray=function(e){return [(e[0]+e[1]+e[2])/3/255*100]};const fp=mp;function pp(e){const t=function(){const e={},t=Object.keys(fp);for(let i=t.length,n=0;n<i;n++)e[t[n]]={distance:-1,parent:null};return e}(),i=[e];for(t[e].distance=0;i.length;){const e=i.pop(),n=Object.keys(fp[e]);for(let s=n.length,o=0;o<s;o++){const s=n[o],r=t[s];-1===r.distance&&(r.distance=t[e].distance+1,r.parent=e,i.unshift(s));}}return t}function bp(e,t){return function(i){return t(e(i))}}function wp(e,t){const i=[t[e].parent,e];let n=fp[t[e].parent][e],s=t[e].parent;for(;t[s].parent;)i.unshift(t[s].parent),n=bp(fp[t[s].parent][s],n),s=t[s].parent;return n.conversion=i,n}const _p=mp,vp=function(e){const t=pp(e),i={},n=Object.keys(t);for(let e=n.length,s=0;s<e;s++){const e=n[s];null!==t[e].parent&&(i[e]=wp(e,t));}return i},yp={};Object.keys(_p).forEach((e=>{yp[e]={},Object.defineProperty(yp[e],"channels",{value:_p[e].channels}),Object.defineProperty(yp[e],"labels",{value:_p[e].labels});const t=vp(e);Object.keys(t).forEach((i=>{const n=t[i];yp[e][i]=function(e){const t=function(...t){const i=t[0];if(null==i)return i;i.length>1&&(t=i);const n=e(t);if("object"==typeof n)for(let e=n.length,t=0;t<e;t++)n[t]=Math.round(n[t]);return n};return "conversion"in e&&(t.conversion=e.conversion),t}(n),yp[e][i].raw=function(e){const t=function(...t){const i=t[0];return null==i?i:(i.length>1&&(t=i),e(t))};return "conversion"in e&&(t.conversion=e.conversion),t}(n);}));}));e({__proto__:null,default:yp},[yp]);class Ap extends wf{fieldView;labelView;statusView;fieldWrapperChildren;constructor(e,t){super(e);const i=`ck-labeled-field-view-${k()}`,n=`ck-labeled-field-view-status-${k()}`;this.fieldView=t(this,i,n),this.set("label",void 0),this.set("isEnabled",!0),this.set("isEmpty",!0),this.set("isFocused",!1),this.set("errorText",null),this.set("infoText",null),this.set("class",void 0),this.set("placeholder",void 0),this.labelView=this._createLabelView(i),this.statusView=this._createStatusView(n),this.fieldWrapperChildren=this.createCollection([this.fieldView,this.labelView]),this.bind("_statusText").to(this,"errorText",this,"infoText",((e,t)=>e||t));const s=this.bindTemplate;this.setTemplate({tag:"div",attributes:{class:["ck","ck-labeled-field-view",s.to("class"),s.if("isEnabled","ck-disabled",(e=>!e)),s.if("isEmpty","ck-labeled-field-view_empty"),s.if("isFocused","ck-labeled-field-view_focused"),s.if("placeholder","ck-labeled-field-view_placeholder"),s.if("errorText","ck-error")]},children:[{tag:"div",attributes:{class:["ck","ck-labeled-field-view__input-wrapper"]},children:this.fieldWrapperChildren},this.statusView]});}_createLabelView(e){const t=new Uf(this.locale);return t.for=e,t.bind("text").to(this,"label"),t}_createStatusView(e){const t=new wf(this.locale),i=this.bindTemplate;return t.setTemplate({tag:"div",attributes:{class:["ck","ck-labeled-field-view__status",i.if("errorText","ck-labeled-field-view__status_error"),i.if("_statusText","ck-hidden",(e=>!e))],id:e,role:i.if("errorText","alert")},children:[{text:i.to("_statusText")}]}),t}focus(e){this.fieldView.focus(e);}}class Ep extends wf{focusTracker;constructor(e){super(e),this.set("value",void 0),this.set("id",void 0),this.set("placeholder",void 0),this.set("tabIndex",void 0),this.set("isReadOnly",!1),this.set("hasError",!1),this.set("ariaDescribedById",void 0),this.set("ariaLabel",void 0),this.focusTracker=new Pa,this.bind("isFocused").to(this.focusTracker),this.set("isEmpty",!0);const t=this.bindTemplate;this.setTemplate({tag:"input",attributes:{class:["ck","ck-input",t.if("isFocused","ck-input_focused"),t.if("isEmpty","ck-input-text_empty"),t.if("hasError","ck-error")],id:t.to("id"),placeholder:t.to("placeholder"),tabindex:t.to("tabIndex"),readonly:t.to("isReadOnly"),"aria-invalid":t.if("hasError",!0),"aria-describedby":t.to("ariaDescribedById"),"aria-label":t.to("ariaLabel")},on:{input:t.to(((...e)=>{this.fire("input",...e),this._updateIsEmpty();})),change:t.to(this._updateIsEmpty.bind(this))}});}render(){super.render(),this.focusTracker.add(this.element),this._setDomElementValue(this.value),this._updateIsEmpty(),this.on("change:value",((e,t,i)=>{this._setDomElementValue(i),this._updateIsEmpty();}));}destroy(){super.destroy(),this.focusTracker.destroy();}select(){this.element.select();}focus(){this.element.focus();}reset(){this.value=this.element.value="",this._updateIsEmpty();}_updateIsEmpty(){this.isEmpty=!this.element.value;}_setDomElementValue(e){this.element.value=e||0===e?e:"";}}class Tp extends Ep{constructor(e){super(e),this.set("inputMode","text");const t=this.bindTemplate;this.extendTemplate({attributes:{inputmode:t.to("inputMode")}});}}class Sp extends Tp{constructor(e){super(e),this.extendTemplate({attributes:{type:"text",class:["ck-input-text"]}});}}class Ip extends Tp{constructor(e,{min:t,max:i,step:n}={}){super(e);const s=this.bindTemplate;this.set("min",t),this.set("max",i),this.set("step",n),this.extendTemplate({attributes:{type:"number",class:["ck-input-number"],min:s.to("min"),max:s.to("max"),step:s.to("step")}});}}class Rp extends wf{children;constructor(e){super(e);const t=this.bindTemplate;this.set("isVisible",!1),this.set("position","se"),this.children=this.createCollection(),this.setTemplate({tag:"div",attributes:{class:["ck","ck-reset","ck-dropdown__panel",t.to("position",(e=>`ck-dropdown__panel_${e}`)),t.if("isVisible","ck-dropdown__panel-visible")],tabindex:"-1"},children:this.children,on:{selectstart:t.to((e=>{"input"!==e.target.tagName.toLocaleLowerCase()&&e.preventDefault();}))}});}focus(){if(this.children.length){const e=this.children.first;"function"==typeof e.focus?e.focus():T("ui-dropdown-panel-focus-child-missing-focus",{childView:this.children.first,dropdownPanel:this});}}focusLast(){if(this.children.length){const e=this.children.last;"function"==typeof e.focusLast?e.focusLast():e.focus();}}}class Bp extends wf{buttonView;panelView;focusTracker;keystrokes;listView;toolbarView;menuView;constructor(e,t,i){super(e);const n=this.bindTemplate;this.buttonView=t,this.panelView=i,this.set("isOpen",!1),this.set("isEnabled",!0),this.set("class",void 0),this.set("id",void 0),this.set("panelPosition","auto"),this.panelView.bind("isVisible").to(this,"isOpen"),this.keystrokes=new Va,this.focusTracker=new Pa,this.setTemplate({tag:"div",attributes:{class:["ck","ck-dropdown",n.to("class"),n.if("isEnabled","ck-disabled",(e=>!e))],id:n.to("id"),"aria-describedby":n.to("ariaDescribedById")},children:[t,i]}),t.extendTemplate({attributes:{class:["ck-dropdown__button"],"data-cke-tooltip-disabled":n.to("isOpen")}});}render(){super.render(),this.focusTracker.add(this.buttonView.element),this.focusTracker.add(this.panelView.element),this.listenTo(this.buttonView,"open",(()=>{this.isOpen=!this.isOpen;})),this.on("change:isOpen",((e,t,i)=>{if(i)if("auto"===this.panelPosition){const e=Bp._getOptimalPosition({element:this.panelView.element,target:this.buttonView.element,fitInViewport:!0,positions:this._panelPositions});this.panelView.position=e?e.name:this._panelPositions[0].name;}else this.panelView.position=this.panelPosition;})),this.keystrokes.listenTo(this.element);const e=(e,t)=>{this.isOpen&&(this.isOpen=!1,t());};this.keystrokes.set("arrowdown",((e,t)=>{this.buttonView.isEnabled&&!this.isOpen&&(this.isOpen=!0,t());})),this.keystrokes.set("arrowright",((e,t)=>{this.isOpen&&t();})),this.keystrokes.set("arrowleft",e),this.keystrokes.set("esc",e);}focus(){this.buttonView.focus();}get _panelPositions(){const{south:e,north:t,southEast:i,southWest:n,northEast:s,northWest:o,southMiddleEast:r,southMiddleWest:a,northMiddleEast:l,northMiddleWest:c}=Bp.defaultPanelPositions;return "rtl"!==this.locale.uiLanguageDirection?[i,n,r,a,e,s,o,l,c,t]:[n,i,a,r,e,o,s,c,l,t]}static defaultPanelPositions={south:(e,t)=>({top:e.bottom,left:e.left-(t.width-e.width)/2,name:"s"}),southEast:e=>({top:e.bottom,left:e.left,name:"se"}),southWest:(e,t)=>({top:e.bottom,left:e.left-t.width+e.width,name:"sw"}),southMiddleEast:(e,t)=>({top:e.bottom,left:e.left-(t.width-e.width)/4,name:"sme"}),southMiddleWest:(e,t)=>({top:e.bottom,left:e.left-3*(t.width-e.width)/4,name:"smw"}),north:(e,t)=>({top:e.top-t.height,left:e.left-(t.width-e.width)/2,name:"n"}),northEast:(e,t)=>({top:e.top-t.height,left:e.left,name:"ne"}),northWest:(e,t)=>({top:e.top-t.height,left:e.left-t.width+e.width,name:"nw"}),northMiddleEast:(e,t)=>({top:e.top-t.height,left:e.left-(t.width-e.width)/4,name:"nme"}),northMiddleWest:(e,t)=>({top:e.top-t.height,left:e.left-3*(t.width-e.width)/4,name:"nmw"})};static _getOptimalPosition=Jr}class Op extends Ef{arrowView;constructor(e){super(e),this.arrowView=this._createArrowView(),this.extendTemplate({attributes:{"aria-haspopup":!0,"aria-expanded":this.bindTemplate.to("isOn",(e=>String(e)))}}),this.delegate("execute").to(this,"open");}render(){super.render(),this.children.add(this.arrowView);}_createArrowView(){const e=new xf;return e.content=ep,e.extendTemplate({attributes:{class:"ck-dropdown__arrow"}}),e}}class Fp extends wf{children;constructor(e){super(e);const t=this.bindTemplate;this.set("isVisible",!0),this.children=this.createCollection(),this.setTemplate({tag:"li",attributes:{class:["ck","ck-list__item",t.if("isVisible","ck-hidden",(e=>!e))],role:"presentation"},children:this.children});}focus(){this.children.first&&this.children.first.focus();}}class Np extends wf{constructor(e){super(e),this.setTemplate({tag:"li",attributes:{class:["ck","ck-list__separator"]}});}}class Dp extends wf{labelView;items;children;constructor(e,t=new Uf){super(e);const i=this.bindTemplate,n=new zp(e);this.set({label:"",isVisible:!0}),this.labelView=t,this.labelView.bind("text").to(this,"label"),this.children=this.createCollection(),this.children.addMany([this.labelView,n]),n.set({role:"group",ariaLabelledBy:t.id}),n.focusTracker.destroy(),n.keystrokes.destroy(),this.items=n.items,this.setTemplate({tag:"li",attributes:{role:"presentation",class:["ck","ck-list__group",i.if("isVisible","ck-hidden",(e=>!e))]},children:this.children});}focus(){if(this.items){const e=this.items.find((e=>!(e instanceof Np)));e&&e.focus();}}}class zp extends wf{focusables;items;focusTracker;keystrokes;_focusCycler;_listItemGroupToChangeListeners=new WeakMap;constructor(e){super(e);const t=this.bindTemplate;this.focusables=new Zg,this.items=this.createCollection(),this.focusTracker=new Pa,this.keystrokes=new Va,this._focusCycler=new If({focusables:this.focusables,focusTracker:this.focusTracker,keystrokeHandler:this.keystrokes,actions:{focusPrevious:"arrowup",focusNext:"arrowdown"}}),this.set("ariaLabel",void 0),this.set("ariaLabelledBy",void 0),this.set("role",void 0),this.setTemplate({tag:"ul",attributes:{class:["ck","ck-reset","ck-list"],role:t.to("role"),"aria-label":t.to("ariaLabel"),"aria-labelledby":t.to("ariaLabelledBy")},children:this.items});}render(){super.render();for(const e of this.items)e instanceof Dp?this._registerFocusableItemsGroup(e):e instanceof Fp&&this._registerFocusableListItem(e);this.items.on("change",((e,t)=>{for(const e of t.removed)e instanceof Dp?this._deregisterFocusableItemsGroup(e):e instanceof Fp&&this._deregisterFocusableListItem(e);for(const e of Array.from(t.added).reverse())e instanceof Dp?this._registerFocusableItemsGroup(e,t.index):this._registerFocusableListItem(e,t.index);})),this.keystrokes.listenTo(this.element);}destroy(){super.destroy(),this.focusTracker.destroy(),this.keystrokes.destroy();}focus(){this._focusCycler.focusFirst();}focusFirst(){this._focusCycler.focusFirst();}focusLast(){this._focusCycler.focusLast();}_registerFocusableListItem(e,t){this.focusTracker.add(e.element),this.focusables.add(e,t);}_deregisterFocusableListItem(e){this.focusTracker.remove(e.element),this.focusables.remove(e);}_getOnGroupItemsChangeCallback(e){return (t,i)=>{for(const e of i.removed)this._deregisterFocusableListItem(e);for(const t of Array.from(i.added).reverse())this._registerFocusableListItem(t,this.items.getIndex(e)+i.index);}}_registerFocusableItemsGroup(e,t){Array.from(e.items).forEach(((e,i)=>{const n=void 0!==t?t+i:void 0;this._registerFocusableListItem(e,n);}));const i=this._getOnGroupItemsChangeCallback(e);this._listItemGroupToChangeListeners.set(e,i),e.items.on("change",i);}_deregisterFocusableItemsGroup(e){for(const t of e.items)this._deregisterFocusableListItem(t);e.items.off("change",this._listItemGroupToChangeListeners.get(e)),this._listItemGroupToChangeListeners.delete(e);}}const qp=Wr("px"),Gp={top:-99999,left:-99999,name:"arrowless",config:{withArrow:!1}};class Kp extends wf{content;_pinWhenIsVisibleCallback;_resizeObserver;constructor(e){super(e);const t=this.bindTemplate;this.set("top",0),this.set("left",0),this.set("position","arrow_nw"),this.set("isVisible",!1),this.set("withArrow",!0),this.set("class",void 0),this._pinWhenIsVisibleCallback=null,this._resizeObserver=null,this.content=this.createCollection(),this.setTemplate({tag:"div",attributes:{class:["ck","ck-balloon-panel",t.to("position",(e=>`ck-balloon-panel_${e}`)),t.if("isVisible","ck-balloon-panel_visible"),t.if("withArrow","ck-balloon-panel_with-arrow"),t.to("class")],style:{top:t.to("top",qp),left:t.to("left",qp)}},children:this.content});}destroy(){this.hide(),super.destroy();}show(){this.isVisible=!0;}hide(){this.isVisible=!1;}attachTo(e){const t=Zp(e.target);if(t&&!Zr(t))return !1;this.show();const n=Kp.defaultPositions,s=Object.assign({},{element:this.element,positions:[n.southArrowNorth,n.southArrowNorthMiddleWest,n.southArrowNorthMiddleEast,n.southArrowNorthWest,n.southArrowNorthEast,n.northArrowSouth,n.northArrowSouthMiddleWest,n.northArrowSouthMiddleEast,n.northArrowSouthWest,n.northArrowSouthEast,n.viewportStickyNorth],limiter:i.document.body,fitInViewport:!0},e),o=Kp._getOptimalPosition(s)||Gp,r=parseInt(o.left),a=parseInt(o.top),l=o.name,c=o.config||{},{withArrow:d=!0}=c;return this.top=a,this.left=r,this.position=l,this.withArrow=d,!0}pin(e){this.unpin(),this._startPinning(e)&&(this._pinWhenIsVisibleCallback=()=>{this.isVisible?this._startPinning(e):this._stopPinning();},this.listenTo(this,"change:isVisible",this._pinWhenIsVisibleCallback));}unpin(){this._pinWhenIsVisibleCallback&&(this._stopPinning(),this.stopListening(this,"change:isVisible",this._pinWhenIsVisibleCallback),this._pinWhenIsVisibleCallback=null,this.hide());}_startPinning(e){if(!this.attachTo(e))return !1;let t=Zp(e.target);const n=e.limiter?Zp(e.limiter):i.document.body;if(this.listenTo(i.document,"scroll",((i,s)=>{const o=s.target,r=t&&o.contains(t),a=n&&o.contains(n);!r&&!a&&t&&n||this.attachTo(e);}),{useCapture:!0}),this.listenTo(i.window,"resize",(()=>{this.attachTo(e);})),!this._resizeObserver&&(t&&Br(t)&&(t=t.parentElement),t)){const e=()=>{Zr(t)||this.unpin();};this._resizeObserver=new $r(t,e);}return !0}_stopPinning(){this.stopListening(i.document,"scroll"),this.stopListening(i.window,"resize"),this._resizeObserver&&(this._resizeObserver.destroy(),this._resizeObserver=null);}static generatePositions(e={}){const{sideOffset:t=Kp.arrowSideOffset,heightOffset:i=Kp.arrowHeightOffset,stickyVerticalOffset:n=Kp.stickyVerticalOffset,config:s}=e;return {northWestArrowSouthWest:(e,i)=>({top:o(e,i),left:e.left-t,name:"arrow_sw",...s&&{config:s}}),northWestArrowSouthMiddleWest:(e,i)=>({top:o(e,i),left:e.left-.25*i.width-t,name:"arrow_smw",...s&&{config:s}}),northWestArrowSouth:(e,t)=>({top:o(e,t),left:e.left-t.width/2,name:"arrow_s",...s&&{config:s}}),northWestArrowSouthMiddleEast:(e,i)=>({top:o(e,i),left:e.left-.75*i.width+t,name:"arrow_sme",...s&&{config:s}}),northWestArrowSouthEast:(e,i)=>({top:o(e,i),left:e.left-i.width+t,name:"arrow_se",...s&&{config:s}}),northArrowSouthWest:(e,i)=>({top:o(e,i),left:e.left+e.width/2-t,name:"arrow_sw",...s&&{config:s}}),northArrowSouthMiddleWest:(e,i)=>({top:o(e,i),left:e.left+e.width/2-.25*i.width-t,name:"arrow_smw",...s&&{config:s}}),northArrowSouth:(e,t)=>({top:o(e,t),left:e.left+e.width/2-t.width/2,name:"arrow_s",...s&&{config:s}}),northArrowSouthMiddleEast:(e,i)=>({top:o(e,i),left:e.left+e.width/2-.75*i.width+t,name:"arrow_sme",...s&&{config:s}}),northArrowSouthEast:(e,i)=>({top:o(e,i),left:e.left+e.width/2-i.width+t,name:"arrow_se",...s&&{config:s}}),northEastArrowSouthWest:(e,i)=>({top:o(e,i),left:e.right-t,name:"arrow_sw",...s&&{config:s}}),northEastArrowSouthMiddleWest:(e,i)=>({top:o(e,i),left:e.right-.25*i.width-t,name:"arrow_smw",...s&&{config:s}}),northEastArrowSouth:(e,t)=>({top:o(e,t),left:e.right-t.width/2,name:"arrow_s",...s&&{config:s}}),northEastArrowSouthMiddleEast:(e,i)=>({top:o(e,i),left:e.right-.75*i.width+t,name:"arrow_sme",...s&&{config:s}}),northEastArrowSouthEast:(e,i)=>({top:o(e,i),left:e.right-i.width+t,name:"arrow_se",...s&&{config:s}}),southWestArrowNorthWest:e=>({top:r(e),left:e.left-t,name:"arrow_nw",...s&&{config:s}}),southWestArrowNorthMiddleWest:(e,i)=>({top:r(e),left:e.left-.25*i.width-t,name:"arrow_nmw",...s&&{config:s}}),southWestArrowNorth:(e,t)=>({top:r(e),left:e.left-t.width/2,name:"arrow_n",...s&&{config:s}}),southWestArrowNorthMiddleEast:(e,i)=>({top:r(e),left:e.left-.75*i.width+t,name:"arrow_nme",...s&&{config:s}}),southWestArrowNorthEast:(e,i)=>({top:r(e),left:e.left-i.width+t,name:"arrow_ne",...s&&{config:s}}),southArrowNorthWest:e=>({top:r(e),left:e.left+e.width/2-t,name:"arrow_nw",...s&&{config:s}}),southArrowNorthMiddleWest:(e,i)=>({top:r(e),left:e.left+e.width/2-.25*i.width-t,name:"arrow_nmw",...s&&{config:s}}),southArrowNorth:(e,t)=>({top:r(e),left:e.left+e.width/2-t.width/2,name:"arrow_n",...s&&{config:s}}),southArrowNorthMiddleEast:(e,i)=>({top:r(e),left:e.left+e.width/2-.75*i.width+t,name:"arrow_nme",...s&&{config:s}}),southArrowNorthEast:(e,i)=>({top:r(e),left:e.left+e.width/2-i.width+t,name:"arrow_ne",...s&&{config:s}}),southEastArrowNorthWest:e=>({top:r(e),left:e.right-t,name:"arrow_nw",...s&&{config:s}}),southEastArrowNorthMiddleWest:(e,i)=>({top:r(e),left:e.right-.25*i.width-t,name:"arrow_nmw",...s&&{config:s}}),southEastArrowNorth:(e,t)=>({top:r(e),left:e.right-t.width/2,name:"arrow_n",...s&&{config:s}}),southEastArrowNorthMiddleEast:(e,i)=>({top:r(e),left:e.right-.75*i.width+t,name:"arrow_nme",...s&&{config:s}}),southEastArrowNorthEast:(e,i)=>({top:r(e),left:e.right-i.width+t,name:"arrow_ne",...s&&{config:s}}),westArrowEast:(e,t)=>({top:e.top+e.height/2-t.height/2,left:e.left-t.width-i,name:"arrow_e",...s&&{config:s}}),eastArrowWest:(e,t)=>({top:e.top+e.height/2-t.height/2,left:e.right+i,name:"arrow_w",...s&&{config:s}}),viewportStickyNorth:(e,t,i,o)=>{const r=o||i;return e.getIntersection(r)?r.height-e.height>n?null:{top:r.top+n,left:e.left+e.width/2-t.width/2,name:"arrowless",config:{withArrow:!1,...s}}:null}};function o(e,t){return e.top-t.height-i}function r(e){return e.bottom+i}}static arrowSideOffset=25;static arrowHeightOffset=10;static stickyVerticalOffset=20;static _getOptimalPosition=Jr;static defaultPositions=Kp.generatePositions()}function Zp(e){return Go(e)?e:Or(e)?e.commonAncestorContainer:"function"==typeof e?Zp(e()):null}class Xp extends wf{constructor(e){super(e),this.setTemplate({tag:"span",attributes:{class:["ck","ck-toolbar__separator"]}});}}class eb extends wf{constructor(e){super(e),this.setTemplate({tag:"span",attributes:{class:["ck","ck-toolbar__line-break"]}});}}function tb(e){if(Array.isArray(e))return {items:e,removeItems:[]};const t={items:[],removeItems:[]};return e?{...t,...e}:t}const ib=(()=>({alignLeft:Ig.alignLeft,bold:Ig.bold,importExport:Ig.importExport,paragraph:Ig.paragraph,plus:Ig.plus,text:Ig.text,threeVerticalDots:Ig.threeVerticalDots,pilcrow:Ig.pilcrow,dragIndicator:Ig.dragIndicator}))();class nb extends wf{options;items;focusTracker;keystrokes;itemsView;children;focusables;_focusCycler;_behavior;constructor(e,t){super(e);const i=this.bindTemplate,n=this.t;this.options=t||{},this.set("ariaLabel",n("Editor toolbar")),this.set("maxWidth","auto"),this.items=this.createCollection(),this.focusTracker=new Pa,this.keystrokes=new Va,this.set("class",void 0),this.set("isCompact",!1),this.itemsView=new sb(e),this.children=this.createCollection(),this.children.add(this.itemsView),this.focusables=this.createCollection();const s="rtl"===e.uiLanguageDirection;this._focusCycler=new If({focusables:this.focusables,focusTracker:this.focusTracker,keystrokeHandler:this.keystrokes,actions:{focusPrevious:[s?"arrowright":"arrowleft","arrowup"],focusNext:[s?"arrowleft":"arrowright","arrowdown"]}});const o=["ck","ck-toolbar",i.to("class"),i.if("isCompact","ck-toolbar_compact")];var r;this.options.shouldGroupWhenFull&&this.options.isFloating&&o.push("ck-toolbar_floating"),this.setTemplate({tag:"div",attributes:{class:o,role:"toolbar","aria-label":i.to("ariaLabel"),style:{maxWidth:i.to("maxWidth")},tabindex:-1},children:this.children,on:{mousedown:(r=this,r.bindTemplate.to((e=>{e.target===r.element&&e.preventDefault();})))}}),this._behavior=this.options.shouldGroupWhenFull?new rb(this):new ob(this);}render(){super.render(),this.focusTracker.add(this.element);for(const e of this.items)this.focusTracker.add(e.element);this.items.on("add",((e,t)=>{this.focusTracker.add(t.element);})),this.items.on("remove",((e,t)=>{this.focusTracker.remove(t.element);})),this.keystrokes.listenTo(this.element),this._behavior.render(this);}destroy(){return this._behavior.destroy(),this.focusTracker.destroy(),this.keystrokes.destroy(),super.destroy()}focus(){this._focusCycler.focusFirst();}focusLast(){this._focusCycler.focusLast();}fillFromConfig(e,t,i){this.items.addMany(this._buildItemsFromConfig(e,t,i));}_buildItemsFromConfig(e,t,i){const n=tb(e),s=i||n.removeItems;return this._cleanItemsConfiguration(n.items,t,s).map((e=>pe(e)?this._createNestedToolbarDropdown(e,t,s):"|"===e?new Xp:"-"===e?new eb:t.create(e))).filter((e=>!!e))}_cleanItemsConfiguration(e,t,i){const n=e.filter(((e,n,s)=>"|"===e||-1===i.indexOf(e)&&("-"===e?!this.options.shouldGroupWhenFull||(T("toolbarview-line-break-ignored-when-grouping-items",s),!1):!(!pe(e)&&!t.has(e))||(T("toolbarview-item-unavailable",{item:e}),!1))));return this._cleanSeparatorsAndLineBreaks(n)}_cleanSeparatorsAndLineBreaks(e){const t=e=>"-"!==e&&"|"!==e,i=e.length,n=e.findIndex(t);if(-1===n)return [];const s=i-e.slice().reverse().findIndex(t);return e.slice(n,s).filter(((e,i,n)=>{if(t(e))return !0;return !(i>0&&n[i-1]===e)}))}_createNestedToolbarDropdown(e,t,i){let{label:n,icon:s,items:o,tooltip:r=!0,withText:a=!1}=e;if(o=this._cleanItemsConfiguration(o,t,i),!o.length)return null;const l=lb(this.locale);return n||T("toolbarview-nested-toolbar-dropdown-missing-label",e),l.class="ck-toolbar__nested-toolbar-dropdown",l.buttonView.set({label:n,tooltip:r,withText:!!a}),!1!==s?l.buttonView.icon=ib[s]||s||Ig.threeVerticalDots:l.buttonView.withText=!0,hb(l,(()=>l.toolbarView._buildItemsFromConfig(o,t,i))),l}}class sb extends wf{children;constructor(e){super(e),this.children=this.createCollection(),this.setTemplate({tag:"div",attributes:{class:["ck","ck-toolbar__items"]},children:this.children});}}class ob{constructor(e){const t=e.bindTemplate;e.set("isVertical",!1),e.itemsView.children.bindTo(e.items).using((e=>e)),e.focusables.bindTo(e.items).using((e=>Vf(e)?e:null)),e.extendTemplate({attributes:{class:[t.if("isVertical","ck-toolbar_vertical")]}});}render(){}destroy(){}}class rb{view;viewChildren;viewFocusables;viewItemsView;viewFocusTracker;viewLocale;ungroupedItems;groupedItems;groupedItemsDropdown;resizeObserver=null;cachedPadding=null;shouldUpdateGroupingOnNextResize=!1;viewElement;constructor(e){this.view=e,this.viewChildren=e.children,this.viewFocusables=e.focusables,this.viewItemsView=e.itemsView,this.viewFocusTracker=e.focusTracker,this.viewLocale=e.locale,this.ungroupedItems=e.createCollection(),this.groupedItems=e.createCollection(),this.groupedItemsDropdown=this._createGroupedItemsDropdown(),e.itemsView.children.bindTo(this.ungroupedItems).using((e=>e)),this.ungroupedItems.on("change",this._updateFocusCyclableItems.bind(this)),e.children.on("change",this._updateFocusCyclableItems.bind(this)),e.items.on("change",((e,t)=>{const i=t.index,n=Array.from(t.added);for(const e of t.removed)i>=this.ungroupedItems.length?this.groupedItems.remove(e):this.ungroupedItems.remove(e);for(let e=i;e<i+n.length;e++){const t=n[e-i];e>this.ungroupedItems.length?this.groupedItems.add(t,e-this.ungroupedItems.length):this.ungroupedItems.add(t,e);}this._updateGrouping();})),e.extendTemplate({attributes:{class:["ck-toolbar_grouping"]}});}render(e){this.viewElement=e.element,this._enableGroupingOnResize(),this._enableGroupingOnMaxWidthChange(e);}destroy(){this.groupedItemsDropdown.destroy(),this.resizeObserver.destroy();}_updateGrouping(){if(!this.viewElement.ownerDocument.body.contains(this.viewElement))return;if(!Zr(this.viewElement))return void(this.shouldUpdateGroupingOnNextResize=!0);const e=this.groupedItems.length;let t;for(;this._areItemsOverflowing;)this._groupLastItem(),t=!0;if(!t&&this.groupedItems.length){for(;this.groupedItems.length&&!this._areItemsOverflowing;)this._ungroupFirstItem();this._areItemsOverflowing&&this._groupLastItem();}this.groupedItems.length!==e&&this.view.fire("groupedItemsUpdate");}get _areItemsOverflowing(){if(!this.ungroupedItems.length)return !1;const e=this.viewElement,t=this.viewLocale.uiLanguageDirection,n=new Fr(e.lastChild),s=new Fr(e);if(!this.cachedPadding){const n=i.window.getComputedStyle(e),s="ltr"===t?"paddingRight":"paddingLeft";this.cachedPadding=Number.parseInt(n[s]);}return "ltr"===t?n.right>s.right-this.cachedPadding:n.left<s.left+this.cachedPadding}_enableGroupingOnResize(){let e;this.resizeObserver=new $r(this.viewElement,(t=>{e&&e===t.contentRect.width&&!this.shouldUpdateGroupingOnNextResize||(this.shouldUpdateGroupingOnNextResize=!1,this._updateGrouping(),e=t.contentRect.width);})),this._updateGrouping();}_enableGroupingOnMaxWidthChange(e){e.on("change:maxWidth",(()=>{this._updateGrouping();}));}_groupLastItem(){this.groupedItems.length||(this.viewChildren.add(new Xp),this.viewChildren.add(this.groupedItemsDropdown),this.viewFocusTracker.add(this.groupedItemsDropdown.element)),this.groupedItems.add(this.ungroupedItems.remove(this.ungroupedItems.last),0);}_ungroupFirstItem(){this.ungroupedItems.add(this.groupedItems.remove(this.groupedItems.first)),this.groupedItems.length||(this.viewChildren.remove(this.groupedItemsDropdown),this.viewChildren.remove(this.viewChildren.last),this.viewFocusTracker.remove(this.groupedItemsDropdown.element));}_createGroupedItemsDropdown(){const e=this.viewLocale,t=e.t,i=lb(e);return i.class="ck-toolbar__grouped-dropdown",i.panelPosition="ltr"===e.uiLanguageDirection?"sw":"se",hb(i,this.groupedItems),i.buttonView.set({label:t("Show more items"),tooltip:!0,tooltipPosition:"rtl"===e.uiLanguageDirection?"se":"sw",icon:Ig.threeVerticalDots}),i}_updateFocusCyclableItems(){this.viewFocusables.clear(),this.ungroupedItems.map((e=>{Vf(e)&&this.viewFocusables.add(e);})),this.groupedItems.length&&this.viewFocusables.add(this.groupedItemsDropdown);}}class ab extends wf{children;actionView;arrowView;keystrokes;focusTracker;constructor(e,t){super(e);const i=this.bindTemplate;this.set("class",void 0),this.set("labelStyle",void 0),this.set("icon",void 0),this.set("isEnabled",!0),this.set("isOn",!1),this.set("isToggleable",!1),this.set("isVisible",!0),this.set("keystroke",void 0),this.set("withKeystroke",!1),this.set("label",void 0),this.set("tabindex",-1),this.set("tooltip",!1),this.set("tooltipPosition","s"),this.set("type","button"),this.set("withText",!1),this.children=this.createCollection(),this.actionView=this._createActionView(t),this.arrowView=this._createArrowView(),this.keystrokes=new Va,this.focusTracker=new Pa,this.setTemplate({tag:"div",attributes:{class:["ck","ck-splitbutton",i.to("class"),i.if("isVisible","ck-hidden",(e=>!e)),this.arrowView.bindTemplate.if("isOn","ck-splitbutton_open")]},children:this.children});}render(){super.render(),this.children.add(this.actionView),this.children.add(this.arrowView),this.focusTracker.add(this.actionView.element),this.focusTracker.add(this.arrowView.element),this.keystrokes.listenTo(this.element),this.keystrokes.set("arrowright",((e,t)=>{this.focusTracker.focusedElement===this.actionView.element&&(this.arrowView.focus(),t());})),this.keystrokes.set("arrowleft",((e,t)=>{this.focusTracker.focusedElement===this.arrowView.element&&(this.actionView.focus(),t());}));}destroy(){super.destroy(),this.focusTracker.destroy(),this.keystrokes.destroy();}focus(){this.actionView.focus();}_createActionView(e){const t=e||new Ef;return e||t.bind("icon","isEnabled","isOn","isToggleable","keystroke","label","tabindex","tooltip","tooltipPosition","type","withText").to(this),t.extendTemplate({attributes:{class:"ck-splitbutton__action"}}),t.delegate("execute").to(this),t}_createArrowView(){const e=new Ef,t=e.bindTemplate;return e.icon=ep,e.extendTemplate({attributes:{class:["ck-splitbutton__arrow"],"data-cke-tooltip-disabled":t.to("isOn"),"aria-haspopup":!0,"aria-expanded":t.to("isOn",(e=>String(e)))}}),e.bind("isEnabled").to(this),e.bind("label").to(this),e.bind("tooltip").to(this),e.delegate("execute").to(this,"open"),e}}function lb(e,t=Op){const n="function"==typeof t?new t(e):t,s=new Rp(e),o=new Bp(e,n,s);return n.bind("isEnabled").to(o),n instanceof ab?n.arrowView.bind("isOn").to(o,"isOpen"):n.bind("isOn").to(o,"isOpen"),function(e){((function(e){_f({emitter:e,activator:()=>e.isRendered&&e.isOpen,callback:()=>{e.isOpen=!1;},contextElements:()=>[e.element,...e.focusTracker.elements]});}))(e),function(e){e.on("execute",(t=>{t.source instanceof Zf||(e.isOpen=!1);}));}(e),function(e){e.focusTracker.on("change:isFocused",((t,i,n)=>{!n&&e.isOpen&&(e.isOpen=!1);}));}(e),function(e){e.keystrokes.set("arrowdown",((t,i)=>{e.isOpen&&(e.panelView.focus(),i());})),e.keystrokes.set("arrowup",((t,i)=>{e.isOpen&&(e.panelView.focusLast(),i());}));}(e),function(e){e.on("change:isOpen",((t,n,s)=>{if(s)return;e.focusTracker.elements.some((e=>e.contains(i.document.activeElement)))&&e.buttonView.focus();}));}(e),function(e){e.on("change:isOpen",((t,i,n)=>{n&&e.panelView.focus();}),{priority:"low"});}(e);}(o),o}function hb(e,t,i={}){e.extendTemplate({attributes:{class:["ck-toolbar-dropdown"]}}),e.isOpen?ub(e,t,i):e.once("change:isOpen",(()=>ub(e,t,i)),{priority:"highest"}),i.enableActiveItemFocusOnDropdownOpen&&fb(e,(()=>e.toolbarView.items.find((e=>e.isOn))));}function ub(e,t,i){const n=e.locale,s=n.t,o=e.toolbarView=new nb(n),r="function"==typeof t?t():t;o.ariaLabel=i.ariaLabel||s("Dropdown toolbar"),i.maxWidth&&(o.maxWidth=i.maxWidth),i.class&&(o.class=i.class),i.isCompact&&(o.isCompact=i.isCompact),i.isVertical&&(o.isVertical=!0),r instanceof Zg?o.items.bindTo(r).using((e=>e)):o.items.addMany(r),e.panelView.children.add(o),o.items.delegate("execute").to(e);}function mb(e,t,i={}){e.isOpen?gb(e,t,i):e.once("change:isOpen",(()=>gb(e,t,i)),{priority:"highest"}),fb(e,(()=>e.listView.items.find((e=>e instanceof Fp&&e.children.first.isOn))));}function gb(e,t,i){const n=e.locale,s=e.listView=new zp(n),o="function"==typeof t?t():t;s.ariaLabel=i.ariaLabel,s.role=i.role,pb(e,s.items,o,n),e.panelView.children.add(s),s.items.delegate("execute").to(e);}function fb(e,t){e.on("change:isOpen",(()=>{if(!e.isOpen)return;const i=t();i&&("function"==typeof i.focus?i.focus():T("ui-dropdown-focus-child-on-open-child-missing-focus",{view:i}));}),{priority:C.low-10});}function pb(e,t,i,n){t.on("change",(()=>{const e=[...t].reduce(((e,t)=>(t instanceof Fp&&t.children.first instanceof zf&&e.push(t.children.first),e)),[]),i=e.some((e=>e.isToggleable));e.forEach((e=>{e.hasCheckSpace=i;}));})),t.bindTo(i).using((t=>{if("separator"===t.type)return new Np(n);if("group"===t.type){const i=new Dp(n);return i.set({label:t.label}),pb(e,i.items,t.items,n),i.items.delegate("execute").to(e),i}if("button"===t.type||"switchbutton"===t.type){const e="menuitemcheckbox"===t.model.role||"menuitemradio"===t.model.role,i=new Fp(n);let s;return "button"===t.type?(s=new zf(n),s.set({isToggleable:e})):s=new Zf(n),s.bind(...Object.keys(t.model)).to(t.model),s.delegate("execute").to(i),i.children.add(s),i}return null}));}const bb=(e,t,i)=>{const n=new Sp(e.locale);return n.set({id:t,ariaDescribedById:i}),n.bind("isReadOnly").to(e,"isEnabled",(e=>!e)),n.bind("hasError").to(e,"errorText",(e=>!!e)),n.on("input",(()=>{e.errorText=null;})),e.bind("isEmpty","isFocused","placeholder").to(n),n},wb=(e,t,i)=>{const n=new Ip(e.locale);return n.set({id:t,ariaDescribedById:i,inputMode:"numeric"}),n.bind("isReadOnly").to(e,"isEnabled",(e=>!e)),n.bind("hasError").to(e,"errorText",(e=>!!e)),n.on("input",(()=>{e.errorText=null;})),e.bind("isEmpty","isFocused","placeholder").to(n),n};class ow{editor;_components=new Map;constructor(e){this.editor=e;}*names(){for(const e of this._components.values())yield e.originalName;}add(e,t){this._components.set(rw(e),{callback:t,originalName:e});}create(e){if(!this.has(e))throw new E("componentfactory-item-missing",this,{name:e});return this._components.get(rw(e)).callback(this.editor.locale)}has(e){return this._components.has(rw(e))}}function rw(e){return String(e).toLowerCase()}const aw="ck-tooltip";class lw extends(Ar()){tooltipTextView;balloonPanelView;static defaultBalloonPositions=Kp.generatePositions({heightOffset:5,sideOffset:13});_currentElementWithTooltip=null;_currentTooltipPosition=null;_mutationObserver=null;_pinTooltipDebounced;_unpinTooltipDebounced;_watchdogExcluded;static _editors=new Set;static _instance=null;constructor(e){if(super(),lw._editors.add(e),lw._instance)return lw._instance;lw._instance=this,this.tooltipTextView=new wf(e.locale),this.tooltipTextView.set("text",""),this.tooltipTextView.setTemplate({tag:"span",attributes:{class:["ck","ck-tooltip__text"]},children:[{text:this.tooltipTextView.bindTemplate.to("text")}]}),this.balloonPanelView=new Kp(e.locale),this.balloonPanelView.class=aw,this.balloonPanelView.content.add(this.tooltipTextView),this._mutationObserver=function(e){const t=new MutationObserver((()=>{e();}));return {attach(e){t.observe(e,{attributes:!0,attributeFilter:["data-cke-tooltip-text","data-cke-tooltip-position"]});},detach(){t.disconnect();}}}((()=>{this._updateTooltipPosition();})),this._pinTooltipDebounced=Vo(this._pinTooltip,600),this._unpinTooltipDebounced=Vo(this._unpinTooltip,400),this.listenTo(i.document,"keydown",this._onKeyDown.bind(this),{useCapture:!0}),this.listenTo(i.document,"mouseenter",this._onEnterOrFocus.bind(this),{useCapture:!0}),this.listenTo(i.document,"mouseleave",this._onLeaveOrBlur.bind(this),{useCapture:!0}),this.listenTo(i.document,"focus",this._onEnterOrFocus.bind(this),{useCapture:!0}),this.listenTo(i.document,"blur",this._onLeaveOrBlur.bind(this),{useCapture:!0}),this.listenTo(i.document,"scroll",this._onScroll.bind(this),{useCapture:!0}),this._watchdogExcluded=!0;}destroy(e){const t=e.ui.view&&e.ui.view.body;lw._editors.delete(e),this.stopListening(e.ui),t&&t.has(this.balloonPanelView)&&t.remove(this.balloonPanelView),lw._editors.size||(this._unpinTooltip(),this.balloonPanelView.destroy(),this.stopListening(),lw._instance=null);}static getPositioningFunctions(e){const t=lw.defaultBalloonPositions;return {s:[t.southArrowNorth,t.southArrowNorthEast,t.southArrowNorthWest],n:[t.northArrowSouth],e:[t.eastArrowWest],w:[t.westArrowEast],sw:[t.southArrowNorthEast],se:[t.southArrowNorthWest]}[e]}_onKeyDown(e,t){"Escape"===t.key&&this._currentElementWithTooltip&&(this._unpinTooltip(),t.stopPropagation());}_onEnterOrFocus(e,{target:t}){const i=cw(t);i?i!==this._currentElementWithTooltip&&(this._unpinTooltip(),"focus"!==e.name||i.matches(":hover")?this._pinTooltipDebounced(i,dw(i)):this._pinTooltip(i,dw(i))):"focus"===e.name&&this._unpinTooltip();}_onLeaveOrBlur(e,{target:t,relatedTarget:i}){if("mouseleave"===e.name){if(!Go(t))return;const e=this.balloonPanelView.element,n=e&&(e===i||e.contains(i)),s=!n&&t===e;if(n)return void this._unpinTooltipDebounced.cancel();if(!s&&this._currentElementWithTooltip&&t!==this._currentElementWithTooltip)return;const o=cw(t),r=cw(i);(s||o&&o!==r)&&this._unpinTooltipDebounced();}else {if(this._currentElementWithTooltip&&t!==this._currentElementWithTooltip)return;this._unpinTooltipDebounced();}}_onScroll(e,{target:t}){this._currentElementWithTooltip&&(t.contains(this.balloonPanelView.element)&&t.contains(this._currentElementWithTooltip)||this._unpinTooltip());}_pinTooltip(e,{text:t,position:i,cssClass:n}){this._unpinTooltip();const s=Ia(lw._editors.values()).ui.view.body;s.has(this.balloonPanelView)||s.add(this.balloonPanelView),this.tooltipTextView.text=t,this.balloonPanelView.class=[aw,n].filter((e=>e)).join(" "),this.balloonPanelView.pin({target:e,positions:lw.getPositioningFunctions(i)}),this._mutationObserver.attach(e);for(const e of lw._editors)this.listenTo(e.ui,"update",this._updateTooltipPosition.bind(this),{priority:"low"});this._currentElementWithTooltip=e,this._currentTooltipPosition=i;}_unpinTooltip(){this._unpinTooltipDebounced.cancel(),this._pinTooltipDebounced.cancel(),this.balloonPanelView.unpin();for(const e of lw._editors)this.stopListening(e.ui,"update");this._currentElementWithTooltip=null,this._currentTooltipPosition=null,this.tooltipTextView.text="",this._mutationObserver.detach();}_updateTooltipPosition(){if(!this._currentElementWithTooltip)return;const e=dw(this._currentElementWithTooltip);Zr(this._currentElementWithTooltip)&&e.text?this.balloonPanelView.pin({target:this._currentElementWithTooltip,positions:lw.getPositioningFunctions(e.position)}):this._unpinTooltip();}}function cw(e){return Go(e)?e.closest("[data-cke-tooltip-text]:not([data-cke-tooltip-disabled])"):null}function dw(e){return {text:e.dataset.ckeTooltipText,position:e.dataset.ckeTooltipPosition||"s",cssClass:e.dataset.ckeTooltipClass||""}}const hw=50,uw=350,mw="Powered by";class gw extends(Ar()){editor;_balloonView;_showBalloonThrottled;_lastFocusedEditableElement;constructor(e){super(),this.editor=e,this._balloonView=null,this._lastFocusedEditableElement=null,this._showBalloonThrottled=er(this._showBalloon.bind(this),50,{leading:!0}),e.on("ready",this._handleEditorReady.bind(this));}destroy(){const e=this._balloonView;e&&(e.unpin(),this._balloonView=null),this._showBalloonThrottled.cancel(),this.stopListening();}_handleEditorReady(){const e=this.editor;(!!e.config.get("ui.poweredBy.forceVisible")||"VALID"!==Na(e.config.get("licenseKey")))&&e.ui.view&&(e.ui.focusTracker.on("change:isFocused",((e,t,i)=>{this._updateLastFocusedEditableElement(),i?this._showBalloon():this._hideBalloon();})),e.ui.focusTracker.on("change:focusedElement",((e,t,i)=>{this._updateLastFocusedEditableElement(),i&&this._showBalloon();})),e.ui.on("update",(()=>{this._showBalloonThrottled();})));}_createBalloonView(){const e=this.editor,t=this._balloonView=new Kp,i=bw(e),n=new fw(e.locale,i.label);t.content.add(n),t.set({class:"ck-powered-by-balloon"}),e.ui.view.body.add(t),this._balloonView=t;}_showBalloon(){if(!this._lastFocusedEditableElement)return;const e=function(e,t){const i=bw(e),n="right"===i.side?function(e,t){return pw(e,t,((e,i)=>e.left+e.width-i.width-t.horizontalOffset))}(t,i):function(e,t){return pw(e,t,(e=>e.left+t.horizontalOffset))}(t,i);return {target:t,positions:[n]}}(this.editor,this._lastFocusedEditableElement);e&&(this._balloonView||this._createBalloonView(),this._balloonView.pin(e));}_hideBalloon(){this._balloonView&&this._balloonView.unpin();}_updateLastFocusedEditableElement(){const e=this.editor,t=e.ui.focusTracker.isFocused,i=e.ui.focusTracker.focusedElement;if(!t||!i)return void(this._lastFocusedEditableElement=null);const n=Array.from(e.ui.getEditableElementsNames()).map((t=>e.ui.getEditableElement(t)));n.includes(i)?this._lastFocusedEditableElement=i:this._lastFocusedEditableElement=n[0];}}class fw extends wf{constructor(e,t){super(e);const i=new xf,n=this.bindTemplate;i.set({content:'<svg xmlns="http://www.w3.org/2000/svg" width="53" height="10" viewBox="0 0 53 10"><path fill="#1C2331" d="M31.724 1.492a15.139 15.139 0 0 0 .045 1.16 2.434 2.434 0 0 0-.687-.34 3.68 3.68 0 0 0-1.103-.166 2.332 2.332 0 0 0-1.14.255 1.549 1.549 0 0 0-.686.87c-.15.41-.225.98-.225 1.712 0 .939.148 1.659.444 2.161.297.503.792.754 1.487.754.452.015.9-.094 1.294-.316.296-.174.557-.4.771-.669l.14.852h1.282V.007h-1.623v1.485ZM31 6.496a1.77 1.77 0 0 1-.494.061.964.964 0 0 1-.521-.127.758.758 0 0 1-.296-.466 3.984 3.984 0 0 1-.093-.992 4.208 4.208 0 0 1 .098-1.052.753.753 0 0 1 .307-.477 1.08 1.08 0 0 1 .55-.122c.233-.004.466.026.69.089l.483.144v2.553c-.11.076-.213.143-.307.2a1.73 1.73 0 0 1-.417.189ZM35.68 0l-.702.004c-.322.002-.482.168-.48.497l.004.581c.002.33.164.493.486.49l.702-.004c.322-.002.481-.167.48-.496L36.165.49c-.002-.33-.164-.493-.486-.491ZM36.145 2.313l-1.612.01.034 5.482 1.613-.01-.035-5.482ZM39.623.79 37.989.8 38 2.306l-.946.056.006 1.009.949-.006.024 2.983c.003.476.143.844.419 1.106.275.26.658.39 1.148.387.132 0 .293-.01.483-.03.19-.02.38-.046.57-.08.163-.028.324-.068.482-.119l-.183-1.095-.702.004a.664.664 0 0 1-.456-.123.553.553 0 0 1-.14-.422l-.016-2.621 1.513-.01-.006-1.064-1.514.01-.01-1.503ZM46.226 2.388c-.41-.184-.956-.274-1.636-.27-.673.004-1.215.101-1.627.29-.402.179-.72.505-.888.91-.18.419-.268.979-.264 1.68.004.688.1 1.24.285 1.655.172.404.495.724.9.894.414.18.957.268 1.63.264.68-.004 1.224-.099 1.632-.284.4-.176.714-.501.878-.905.176-.418.263-.971.258-1.658-.004-.702-.097-1.261-.28-1.677a1.696 1.696 0 0 0-.888-.9Zm-.613 3.607a.77.77 0 0 1-.337.501 1.649 1.649 0 0 1-1.317.009.776.776 0 0 1-.343-.497 4.066 4.066 0 0 1-.105-1.02 4.136 4.136 0 0 1 .092-1.03.786.786 0 0 1 .337-.507 1.59 1.59 0 0 1 1.316-.008.79.79 0 0 1 .344.502c.078.337.113.683.105 1.03.012.343-.019.685-.092 1.02ZM52.114 2.07a2.67 2.67 0 0 0-1.128.278c-.39.191-.752.437-1.072.73l-.157-.846-1.273.008.036 5.572 1.623-.01-.024-3.78c.35-.124.646-.22.887-.286.26-.075.53-.114.8-.118l.45-.003.144-1.546-.286.001ZM22.083 7.426l-1.576-2.532a2.137 2.137 0 0 0-.172-.253 1.95 1.95 0 0 0-.304-.29.138.138 0 0 1 .042-.04 1.7 1.7 0 0 0 .328-.374l1.75-2.71c.01-.015.025-.028.024-.048-.01-.01-.021-.007-.031-.007L20.49 1.17a.078.078 0 0 0-.075.045l-.868 1.384c-.23.366-.46.732-.688 1.099a.108.108 0 0 1-.112.06c-.098-.005-.196-.001-.294-.002-.018 0-.038.006-.055-.007.002-.02.002-.039.005-.058a4.6 4.6 0 0 0 .046-.701V1.203c0-.02-.009-.032-.03-.03h-.033L16.93 1.17c-.084 0-.073-.01-.073.076v6.491c-.001.018.006.028.025.027h1.494c.083 0 .072.007.072-.071v-2.19c0-.055-.003-.11-.004-.166a3.366 3.366 0 0 0-.05-.417h.06c.104 0 .209.002.313-.002a.082.082 0 0 1 .084.05c.535.913 1.07 1.824 1.607 2.736a.104.104 0 0 0 .103.062c.554-.003 1.107-.002 1.66-.002l.069-.003-.019-.032-.188-.304ZM27.112 6.555c-.005-.08-.004-.08-.082-.08h-2.414c-.053 0-.106-.003-.159-.011a.279.279 0 0 1-.246-.209.558.558 0 0 1-.022-.15c0-.382 0-.762-.002-1.143 0-.032.007-.049.042-.044h2.504c.029.003.037-.012.034-.038V3.814c0-.089.013-.078-.076-.078h-2.44c-.07 0-.062.003-.062-.06v-.837c0-.047.004-.093.013-.14a.283.283 0 0 1 .241-.246.717.717 0 0 1 .146-.011h2.484c.024.002.035-.009.036-.033l.003-.038.03-.496c.01-.183.024-.365.034-.548.005-.085.003-.087-.082-.094-.218-.018-.437-.038-.655-.05a17.845 17.845 0 0 0-.657-.026 72.994 72.994 0 0 0-1.756-.016 1.7 1.7 0 0 0-.471.064 1.286 1.286 0 0 0-.817.655c-.099.196-.149.413-.145.633v3.875c0 .072.003.144.011.216a1.27 1.27 0 0 0 .711 1.029c.228.113.48.167.734.158.757-.005 1.515.002 2.272-.042.274-.016.548-.034.82-.053.03-.002.043-.008.04-.041-.008-.104-.012-.208-.019-.312a69.964 69.964 0 0 1-.05-.768ZM16.14 7.415l-.127-1.075c-.004-.03-.014-.04-.044-.037a13.125 13.125 0 0 1-.998.073c-.336.01-.672.02-1.008.016-.116-.001-.233-.014-.347-.039a.746.746 0 0 1-.45-.262c-.075-.1-.132-.211-.167-.33a3.324 3.324 0 0 1-.126-.773 9.113 9.113 0 0 1-.015-.749c0-.285.022-.57.065-.852.023-.158.066-.312.127-.46a.728.728 0 0 1 .518-.443 1.64 1.64 0 0 1 .397-.048c.628-.001 1.255.003 1.882.05.022.001.033-.006.036-.026l.003-.031.06-.55c.019-.177.036-.355.057-.532.004-.034-.005-.046-.04-.056a5.595 5.595 0 0 0-1.213-.21 10.783 10.783 0 0 0-.708-.02c-.24-.003-.48.01-.719.041a3.477 3.477 0 0 0-.625.14 1.912 1.912 0 0 0-.807.497c-.185.2-.33.433-.424.688a4.311 4.311 0 0 0-.24 1.096c-.031.286-.045.572-.042.86-.006.43.024.86.091 1.286.04.25.104.497.193.734.098.279.26.53.473.734.214.205.473.358.756.446.344.11.702.17 1.063.177a8.505 8.505 0 0 0 1.578-.083 6.11 6.11 0 0 0 .766-.18c.03-.008.047-.023.037-.057a.157.157 0 0 1-.003-.025Z"/><path fill="#AFE229" d="M6.016 6.69a1.592 1.592 0 0 0-.614.21c-.23.132-.422.32-.56.546-.044.072-.287.539-.287.539l-.836 1.528.009.006c.038.025.08.046.123.063.127.046.26.07.395.073.505.023 1.011-.007 1.517-.003.29.009.58.002.869-.022a.886.886 0 0 0 .395-.116.962.962 0 0 0 .312-.286c.056-.083.114-.163.164-.249.24-.408.48-.816.718-1.226.075-.128.148-.257.222-.386l.112-.192a1.07 1.07 0 0 0 .153-.518l-1.304.023s-1.258-.005-1.388.01Z"/><path fill="#771BFF" d="m2.848 9.044.76-1.39.184-.352c-.124-.067-.245-.14-.367-.21-.346-.204-.706-.384-1.045-.6a.984.984 0 0 1-.244-.207c-.108-.134-.136-.294-.144-.46-.021-.409-.002-.818-.009-1.227-.003-.195 0-.39.003-.585.004-.322.153-.553.427-.713l.833-.488c.22-.13.44-.257.662-.385.05-.029.105-.052.158-.077.272-.128.519-.047.76.085l.044.028c.123.06.242.125.358.196.318.178.635.357.952.537.095.056.187.117.275.184.194.144.254.35.266.578.016.284.007.569.006.853-.001.28.004.558 0 .838.592-.003 1.259 0 1.259 0l.723-.013c-.003-.292-.007-.584-.007-.876 0-.524.015-1.048-.016-1.571-.024-.42-.135-.8-.492-1.067a5.02 5.02 0 0 0-.506-.339A400.52 400.52 0 0 0 5.94.787C5.722.664 5.513.524 5.282.423 5.255.406 5.228.388 5.2.373 4.758.126 4.305-.026 3.807.21c-.097.046-.197.087-.29.14A699.896 699.896 0 0 0 .783 1.948c-.501.294-.773.717-.778 1.31-.004.36-.009.718-.001 1.077.016.754-.017 1.508.024 2.261.016.304.07.6.269.848.127.15.279.28.448.382.622.4 1.283.734 1.92 1.11l.183.109Z"/></svg>\n',isColorInherited:!1}),i.extendTemplate({attributes:{style:{width:"53px",height:"10px"}}}),this.setTemplate({tag:"div",attributes:{class:["ck","ck-powered-by"],"aria-hidden":!0},children:[{tag:"a",attributes:{href:"https://ckeditor.com/?utm_source=ckeditor&utm_medium=referral&utm_campaign=701Dn000000hVgmIAE_powered_by_ckeditor_logo",target:"_blank",tabindex:"-1"},children:[...t?[{tag:"span",attributes:{class:["ck","ck-powered-by__label"]},children:[t]}]:[],i],on:{dragstart:n.to((e=>e.preventDefault()))}}]});}}function pw(e,t,i){return (n,s)=>{const o=new Fr(e);if(o.width<uw||o.height<hw)return null;let r;r="inside"===t.position?o.bottom-s.height:o.bottom-s.height/2,r-=t.verticalOffset;const a=i(o,s),l=n.clone().moveTo(a,r).getIntersection(s.clone().moveTo(a,r)).getVisible();return !l||l.getArea()<s.getArea()?null:{top:r,left:a,name:`position_${t.position}-side_${t.side}`,config:{withArrow:!1}}}}function bw(e){const t=e.config.get("ui.poweredBy"),i=t&&t.position||"border";return {position:i,label:mw,verticalOffset:"inside"===i?5:0,horizontalOffset:5,side:"ltr"===e.locale.contentLanguageDirection?"right":"left",...t}}const ww={POLITE:"polite",ASSERTIVE:"assertive"};class _w{editor;view;constructor(e){this.editor=e,e.once("ready",(()=>{for(const e of Object.values(ww))this.announce("",e);}));}announce(e,t=ww.POLITE){const i=this.editor;if(!i.ui.view)return;this.view||(this.view=new vw(i.locale),i.ui.view.body.add(this.view));const{politeness:n,isUnsafeHTML:s}="string"==typeof t?{politeness:t}:t;let o=this.view.regionViews.find((e=>e.politeness===n));o||(o=new yw(i,n),this.view.regionViews.add(o)),o.announce({announcement:e,isUnsafeHTML:s});}}class vw extends wf{regionViews;constructor(e){super(e),this.regionViews=this.createCollection(),this.setTemplate({tag:"div",attributes:{class:["ck","ck-aria-live-announcer"]},children:this.regionViews});}}class yw extends wf{politeness;_domConverter;_pruneAnnouncementsInterval;constructor(e,t){super(e.locale),this.setTemplate({tag:"div",attributes:{"aria-live":t,"aria-relevant":"additions"},children:[{tag:"ul",attributes:{class:["ck","ck-aria-live-region-list"]}}]}),e.on("destroy",(()=>{null!==this._pruneAnnouncementsInterval&&(clearInterval(this._pruneAnnouncementsInterval),this._pruneAnnouncementsInterval=null);})),this.politeness=t,this._domConverter=e.data.htmlProcessor.domConverter,this._pruneAnnouncementsInterval=setInterval((()=>{this.element&&this._listElement.firstChild&&this._listElement.firstChild.remove();}),5e3);}announce({announcement:e,isUnsafeHTML:t}){if(!e.trim().length)return;const i=document.createElement("li");t?this._domConverter.setContentOf(i,e):i.innerText=e,this._listElement.appendChild(i);}get _listElement(){return this.element.querySelector("ul")}}class kw extends Fp{constructor(e,t){super(e);const i=this.bindTemplate;this.extendTemplate({attributes:{class:["ck-menu-bar__menu__item"]},on:{mouseenter:i.to("mouseenter")}}),this.delegate("mouseenter").to(t);}}const Cw={toggleMenusAndFocusItemsOnHover(e){e.on("menu:mouseenter",(t=>{if(e.isFocusBorderEnabled||e.isOpen){if(e.isOpen)for(const i of e.menus){const e=t.path[0],n=e instanceof kw&&e.children.first===i;i.isOpen=(t.path.includes(i)||n)&&i.isEnabled;}t.source.focus();}}));},focusCycleMenusOnArrows(e){const t="rtl"===e.locale.uiLanguageDirection;function i(t,i){const n=e.children.getIndex(t),s=t.isOpen,o=e.children.length,r=e.children.get((n+o+i)%o);t.isOpen=!1,s&&(r.isOpen=!0),r.buttonView.focus();}e.on("menu:arrowright",(e=>{i(e.source,t?-1:1);})),e.on("menu:arrowleft",(e=>{i(e.source,t?1:-1);}));},closeMenusWhenTheBarCloses(e){e.on("change:isOpen",(()=>{e.isOpen||e.menus.forEach((e=>{e.isOpen=!1;}));}));},closeMenuWhenAnotherOnTheSameLevelOpens(e){e.on("menu:change:isOpen",((t,i,n)=>{n&&e.menus.filter((e=>t.source.parentMenuView===e.parentMenuView&&t.source!==e&&e.isOpen)).forEach((e=>{e.isOpen=!1;}));}));},closeOnClickOutside(e){_f({emitter:e,activator:()=>e.isOpen,callback:()=>e.close(),contextElements:()=>e.children.map((e=>e.element))});},enableFocusHighlightOnInteraction(e){let t=!1;e.on("change:isOpen",((i,n,s)=>{s||(t||(e.isFocusBorderEnabled=!1),t=!1);})),e.listenTo(e.element,"keydown",(()=>{t=!0;}),{useCapture:!0}),e.listenTo(e.element,"keyup",(()=>{t=!1;}),{useCapture:!0}),e.listenTo(e.element,"focus",(()=>{t&&(e.isFocusBorderEnabled=!0);}),{useCapture:!0});}},xw={openAndFocusPanelOnArrowDownKey(e){e.keystrokes.set("arrowdown",((t,i)=>{e.focusTracker.focusedElement===e.buttonView.element&&(e.isOpen||(e.isOpen=!0),e.panelView.focus(),i());}));},openOnArrowRightKey(e){const t="rtl"===e.locale.uiLanguageDirection?"arrowleft":"arrowright";e.keystrokes.set(t,((t,i)=>{e.focusTracker.focusedElement===e.buttonView.element&&e.isEnabled&&(e.isOpen||(e.isOpen=!0),e.panelView.focus(),i());}));},openOnButtonClick(e){e.buttonView.on("execute",(()=>{e.isOpen=!0;}));},toggleOnButtonClick(e){e.buttonView.on("execute",(()=>{e.isOpen=!e.isOpen;}));},openAndFocusOnEnterKeyPress(e){e.keystrokes.set("enter",((t,i)=>{e.focusTracker.focusedElement===e.buttonView.element&&(e.isOpen=!0,e.panelView.focus(),i());}));},closeOnArrowLeftKey(e){const t="rtl"===e.locale.uiLanguageDirection?"arrowright":"arrowleft";e.keystrokes.set(t,((t,i)=>{e.isOpen&&(e.isOpen=!1,e.focus(),i());}));},closeOnEscKey(e){e.keystrokes.set("esc",((t,i)=>{e.isOpen&&(e.isOpen=!1,e.focus(),i());}));},closeOnParentClose(e){e.parentMenuView.on("change:isOpen",((t,i,n)=>{n||t.source!==e.parentMenuView||(e.isOpen=!1);}));}},Aw={southEast:e=>({top:e.bottom,left:e.left,name:"se"}),southWest:(e,t)=>({top:e.bottom,left:e.left-t.width+e.width,name:"sw"}),northEast:(e,t)=>({top:e.top-t.height,left:e.left,name:"ne"}),northWest:(e,t)=>({top:e.top-t.height,left:e.left-t.width+e.width,name:"nw"}),eastSouth:e=>({top:e.top,left:e.right-5,name:"es"}),eastNorth:(e,t)=>({top:e.top-t.height,left:e.right-5,name:"en"}),westSouth:(e,t)=>({top:e.top,left:e.left-t.width+5,name:"ws"}),westNorth:(e,t)=>({top:e.top-t.height,left:e.left-t.width+5,name:"wn"})},Ew=[{menuId:"file",label:"File",groups:[{groupId:"export",items:["menuBar:exportPdf","menuBar:exportWord"]},{groupId:"import",items:["menuBar:importWord"]},{groupId:"revisionHistory",items:["menuBar:revisionHistory"]}]},{menuId:"edit",label:"Edit",groups:[{groupId:"undo",items:["menuBar:undo","menuBar:redo"]},{groupId:"selectAll",items:["menuBar:selectAll"]},{groupId:"findAndReplace",items:["menuBar:findAndReplace"]}]},{menuId:"view",label:"View",groups:[{groupId:"sourceEditing",items:["menuBar:sourceEditing"]},{groupId:"showBlocks",items:["menuBar:showBlocks"]},{groupId:"previewMergeFields",items:["menuBar:previewMergeFields"]},{groupId:"restrictedEditing",items:["menuBar:restrictedEditing"]}]},{menuId:"insert",label:"Insert",groups:[{groupId:"insertMainWidgets",items:["menuBar:insertImage","menuBar:ckbox","menuBar:ckfinder","menuBar:insertTable"]},{groupId:"insertInline",items:["menuBar:link","menuBar:comment","menuBar:insertMergeField"]},{groupId:"insertMinorWidgets",items:["menuBar:mediaEmbed","menuBar:insertTemplate","menuBar:specialCharacters","menuBar:blockQuote","menuBar:codeBlock","menuBar:htmlEmbed"]},{groupId:"insertStructureWidgets",items:["menuBar:horizontalLine","menuBar:pageBreak","menuBar:tableOfContents"]},{groupId:"restrictedEditingException",items:["menuBar:restrictedEditingException"]}]},{menuId:"format",label:"Format",groups:[{groupId:"textAndFont",items:[{menuId:"text",label:"Text",groups:[{groupId:"basicStyles",items:["menuBar:bold","menuBar:italic","menuBar:underline","menuBar:strikethrough","menuBar:superscript","menuBar:subscript","menuBar:code"]},{groupId:"textPartLanguage",items:["menuBar:textPartLanguage"]}]},{menuId:"font",label:"Font",groups:[{groupId:"fontProperties",items:["menuBar:fontSize","menuBar:fontFamily"]},{groupId:"fontColors",items:["menuBar:fontColor","menuBar:fontBackgroundColor"]},{groupId:"highlight",items:["menuBar:highlight"]}]},"menuBar:heading"]},{groupId:"list",items:["menuBar:bulletedList","menuBar:numberedList","menuBar:multiLevelList","menuBar:todoList"]},{groupId:"indent",items:["menuBar:alignment","menuBar:indent","menuBar:outdent"]},{groupId:"caseChange",items:["menuBar:caseChange"]},{groupId:"removeFormat",items:["menuBar:removeFormat"]}]},{menuId:"tools",label:"Tools",groups:[{groupId:"aiTools",items:["menuBar:aiAssistant","menuBar:aiCommands"]},{groupId:"tools",items:["menuBar:trackChanges","menuBar:commentsArchive"]}]},{menuId:"help",label:"Help",groups:[{groupId:"help",items:["menuBar:accessibilityHelp"]}]}];function Tw(e){let t;return t="items"in e&&e.items?{items:e.items,removeItems:[],addItems:[],isVisible:!0,isUsingDefaultConfig:!1,...e}:{items:Is(Ew),addItems:[],removeItems:[],isVisible:!0,isUsingDefaultConfig:!0,...e},t}function Sw({normalizedConfig:e,locale:t,componentFactory:i,extraItems:n}){const s=Is(e);return Iw(e,s,n),function(e,t){const i=t.removeItems,n=[];t.items=t.items.filter((({menuId:e})=>!i.includes(e)||(n.push(e),!1))),Bw(t.items,(e=>{e.groups=e.groups.filter((({groupId:e})=>!i.includes(e)||(n.push(e),!1)));for(const t of e.groups)t.items=t.items.filter((e=>{const t=Fw(e);return !i.includes(t)||(n.push(t),!1)}));}));for(const t of i)n.includes(t)||T("menu-bar-item-could-not-be-removed",{menuBarConfig:e,itemName:t});}(e,s),Iw(e,s,s.addItems),function(e,t,i){Bw(t.items,(n=>{for(const s of n.groups)s.items=s.items.filter((s=>{const o="string"==typeof s&&!i.has(s);return o&&!t.isUsingDefaultConfig&&T("menu-bar-item-unavailable",{menuBarConfig:e,parentMenuConfig:Is(n),componentName:s}),!o}));}));}(e,s,i),Vw(e,s),function(e,t){const i=t.t,n={File:i({string:"File",id:"MENU_BAR_MENU_FILE"}),Edit:i({string:"Edit",id:"MENU_BAR_MENU_EDIT"}),View:i({string:"View",id:"MENU_BAR_MENU_VIEW"}),Insert:i({string:"Insert",id:"MENU_BAR_MENU_INSERT"}),Format:i({string:"Format",id:"MENU_BAR_MENU_FORMAT"}),Tools:i({string:"Tools",id:"MENU_BAR_MENU_TOOLS"}),Help:i({string:"Help",id:"MENU_BAR_MENU_HELP"}),Text:i({string:"Text",id:"MENU_BAR_MENU_TEXT"}),Font:i({string:"Font",id:"MENU_BAR_MENU_FONT"})};Bw(e.items,(e=>{e.label in n&&(e.label=n[e.label]);}));}(s,t),s}function Iw(e,t,i){const n=[];if(0!=i.length){for(const e of i){const i=Mw(e.position),o=Lw(e.position);if("object"==typeof(s=e)&&"menu"in s)if(o){const s=t.items.findIndex((e=>e.menuId===o));if(-1!=s)"before"===i?(t.items.splice(s,0,e.menu),n.push(e)):"after"===i&&(t.items.splice(s+1,0,e.menu),n.push(e));else {Pw(t,e.menu,o,i)&&n.push(e);}}else "start"===i?(t.items.unshift(e.menu),n.push(e)):"end"===i&&(t.items.push(e.menu),n.push(e));else if(Ow(e))Bw(t.items,(t=>{if(t.menuId===o)"start"===i?(t.groups.unshift(e.group),n.push(e)):"end"===i&&(t.groups.push(e.group),n.push(e));else {const s=t.groups.findIndex((e=>e.groupId===o));-1!==s&&("before"===i?(t.groups.splice(s,0,e.group),n.push(e)):"after"===i&&(t.groups.splice(s+1,0,e.group),n.push(e)));}}));else {Pw(t,e.item,o,i)&&n.push(e);}}var s;for(const t of i)n.includes(t)||T("menu-bar-item-could-not-be-added",{menuBarConfig:e,addedItemConfig:t});}}function Pw(e,t,i,n){let s=!1;return Bw(e.items,(e=>{for(const{groupId:o,items:r}of e.groups){if(s)return;if(o===i)"start"===n?(r.unshift(t),s=!0):"end"===n&&(r.push(t),s=!0);else {const e=r.findIndex((e=>Fw(e)===i));-1!==e&&("before"===n?(r.splice(e,0,t),s=!0):"after"===n&&(r.splice(e+1,0,t),s=!0));}}})),s}function Vw(e,t){const i=t.isUsingDefaultConfig;let n=!1;t.items=t.items.filter((t=>!!t.groups.length||(Rw(e,t,i),!1))),t.items.length?(Bw(t.items,(t=>{t.groups=t.groups.filter((e=>!!e.items.length||(n=!0,!1)));for(const s of t.groups)s.items=s.items.filter((t=>!(Nw(t)&&!t.groups.length)||(Rw(e,t,i),n=!0,!1)));})),n&&Vw(e,t)):Rw(e,e,i);}function Rw(e,t,i){i||T("menu-bar-menu-empty",{menuBarConfig:e,emptyMenuConfig:t});}function Bw(e,t){if(Array.isArray(e))for(const t of e)i(t);function i(e){t(e);for(const t of e.groups)for(const e of t.items)Nw(e)&&i(e);}}function Ow(e){return "object"==typeof e&&"group"in e}function Mw(e){return e.startsWith("start")?"start":e.startsWith("end")?"end":e.startsWith("after")?"after":"before"}function Lw(e){const t=e.match(/^[^:]+:(.+)/);return t?t[1]:null}function Fw(e){return "string"==typeof e?e:e.menuId}function Nw(e){return "object"==typeof e&&"menuId"in e}class Dw extends(ar()){editor;componentFactory;focusTracker;tooltipManager;poweredBy;ariaLiveAnnouncer;isReady=!1;_editableElementsMap=new Map;_focusableToolbarDefinitions=[];_extraMenuBarElements=[];_lastFocusedForeignElement=null;constructor(e){super();const t=e.editing.view;this.editor=e,this.componentFactory=new ow(e),this.focusTracker=new Pa,this.tooltipManager=new lw(e),this.poweredBy=new gw(e),this.ariaLiveAnnouncer=new _w(e),this.set("viewportOffset",this._readViewportOffsetFromConfig()),this.once("ready",(()=>{this._bindBodyCollectionWithFocusTracker(),this.isReady=!0;})),this.listenTo(t.document,"layoutChanged",this.update.bind(this)),this.listenTo(t,"scrollToTheSelection",this._handleScrollToTheSelection.bind(this)),this._initFocusTracking();}get element(){return null}update(){this.fire("update");}destroy(){this.stopListening(),this.focusTracker.destroy(),this.tooltipManager.destroy(this.editor),this.poweredBy.destroy();for(const e of this._editableElementsMap.values())e.ckeditorInstance=null,this.editor.keystrokes.stopListening(e);this._editableElementsMap=new Map,this._focusableToolbarDefinitions=[];}setEditableElement(e,t){this._editableElementsMap.set(e,t),t.ckeditorInstance||(t.ckeditorInstance=this.editor),this.focusTracker.add(t);const i=()=>{this.editor.editing.view.getDomRoot(e)||this.editor.keystrokes.listenTo(t);};this.isReady?i():this.once("ready",i);}removeEditableElement(e){const t=this._editableElementsMap.get(e);t&&(this._editableElementsMap.delete(e),this.editor.keystrokes.stopListening(t),this.focusTracker.remove(t),t.ckeditorInstance=null);}getEditableElement(e="main"){return this._editableElementsMap.get(e)}getEditableElementsNames(){return this._editableElementsMap.keys()}addToolbar(e,t={}){e.isRendered?(this.focusTracker.add(e.element),this.editor.keystrokes.listenTo(e.element)):e.once("render",(()=>{this.focusTracker.add(e.element),this.editor.keystrokes.listenTo(e.element);})),this._focusableToolbarDefinitions.push({toolbarView:e,options:t});}extendMenuBar(e){this._extraMenuBarElements.push(e);}get _editableElements(){return console.warn("editor-ui-deprecated-editable-elements: The EditorUI#_editableElements property has been deprecated and will be removed in the near future.",{editorUI:this}),this._editableElementsMap}_initMenuBar(e){const t=e.element;this.focusTracker.add(t),this.editor.keystrokes.listenTo(t);const i=Tw(this.editor.config.get("menuBar")||{});e.fillFromConfig(i,this.componentFactory,this._extraMenuBarElements),this.editor.keystrokes.set("Esc",((e,i)=>{t.contains(this.editor.ui.focusTracker.focusedElement)&&(this._lastFocusedForeignElement?(this._lastFocusedForeignElement.focus(),this._lastFocusedForeignElement=null):this.editor.editing.view.focus(),i());})),this.editor.keystrokes.set("Alt+F9",((i,n)=>{t.contains(this.editor.ui.focusTracker.focusedElement)||(this._saveLastFocusedForeignElement(),e.isFocusBorderEnabled=!0,e.focus(),n());}));}_readViewportOffsetFromConfig(){const e=this.editor,t=e.config.get("ui.viewportOffset");if(t)return t;const i=e.config.get("toolbar.viewportTopOffset");return i?(console.warn("editor-ui-deprecated-viewport-offset-config: The `toolbar.vieportTopOffset` configuration option is deprecated. It will be removed from future CKEditor versions. Use `ui.viewportOffset.top` instead."),{top:i}):{top:0}}_initFocusTracking(){const e=this.editor;let t;e.keystrokes.set("Alt+F10",((e,i)=>{this._saveLastFocusedForeignElement();const n=this._getCurrentFocusedToolbarDefinition();n&&t||(t=this._getFocusableCandidateToolbarDefinitions());for(let e=0;e<t.length;e++){const e=t.shift();if(t.push(e),e!==n&&this._focusFocusableCandidateToolbar(e)){n&&n.options.afterBlur&&n.options.afterBlur();break}}i();})),e.keystrokes.set("Esc",((t,i)=>{const n=this._getCurrentFocusedToolbarDefinition();n&&(this._lastFocusedForeignElement?(this._lastFocusedForeignElement.focus(),this._lastFocusedForeignElement=null):e.editing.view.focus(),n.options.afterBlur&&n.options.afterBlur(),i());}));}_saveLastFocusedForeignElement(){const e=this.focusTracker.focusedElement;Array.from(this._editableElementsMap.values()).includes(e)&&!Array.from(this.editor.editing.view.domRoots.values()).includes(e)&&(this._lastFocusedForeignElement=e);}_getFocusableCandidateToolbarDefinitions(){const e=[];for(const t of this._focusableToolbarDefinitions){const{toolbarView:i,options:n}=t;(Zr(i.element)||n.beforeFocus)&&e.push(t);}return e.sort(((e,t)=>zw(e)-zw(t))),e}_getCurrentFocusedToolbarDefinition(){for(const e of this._focusableToolbarDefinitions)if(e.toolbarView.element&&e.toolbarView.element.contains(this.focusTracker.focusedElement))return e;return null}_focusFocusableCandidateToolbar(e){const{toolbarView:t,options:{beforeFocus:i}}=e;return i&&i(),!!Zr(t.element)&&(t.focus(),!0)}_handleScrollToTheSelection(e,t){const i={top:0,bottom:0,left:0,right:0,...this.viewportOffset};t.viewportOffset.top+=i.top,t.viewportOffset.bottom+=i.bottom,t.viewportOffset.left+=i.left,t.viewportOffset.right+=i.right;}_bindBodyCollectionWithFocusTracker(){const e=this.view.body;for(const t of e)this.focusTracker.add(t.element);e.on("add",((e,t)=>{this.focusTracker.add(t.element);})),e.on("remove",((e,t)=>{this.focusTracker.remove(t.element);}));}}function zw(e){const{toolbarView:t,options:i}=e;let n=10;return Zr(t.element)&&n--,i.isContextual&&n--,n}class Hw extends wf{body;menuBarView;constructor(e){super(e),this.body=new Kf(e);}render(){super.render(),this.body.attachToDom();}destroy(){return this.body.detachFromDom(),super.destroy()}}class $w extends Hw{top;main;_voiceLabelView;constructor(e){super(e),this.top=this.createCollection(),this.main=this.createCollection(),this._voiceLabelView=this._createVoiceLabel(),this.setTemplate({tag:"div",attributes:{class:["ck","ck-reset","ck-editor","ck-rounded-corners"],role:"application",dir:e.uiLanguageDirection,lang:e.uiLanguage,"aria-labelledby":this._voiceLabelView.id},children:[this._voiceLabelView,{tag:"div",attributes:{class:["ck","ck-editor__top","ck-reset_all"],role:"presentation"},children:this.top},{tag:"div",attributes:{class:["ck","ck-editor__main"],role:"presentation"},children:this.main}]});}_createVoiceLabel(){const e=this.t,t=new Uf;return t.text=e("Rich Text Editor"),t.extendTemplate({attributes:{class:"ck-voice-label"}}),t}}class Uw extends wf{name=null;_editingView;_editableElement;_hasExternalElement;constructor(e,t,i){super(e),this.setTemplate({tag:"div",attributes:{class:["ck","ck-content","ck-editor__editable","ck-rounded-corners"],lang:e.contentLanguage,dir:e.contentLanguageDirection}}),this.set("isFocused",!1),this._editableElement=i,this._hasExternalElement=!!this._editableElement,this._editingView=t;}render(){super.render(),this._hasExternalElement?this.template.apply(this.element=this._editableElement):this._editableElement=this.element,this.on("change:isFocused",(()=>this._updateIsFocusedClasses())),this._updateIsFocusedClasses();}destroy(){this._hasExternalElement&&this.template.revert(this._editableElement),super.destroy();}get hasExternalElement(){return this._hasExternalElement}_updateIsFocusedClasses(){const e=this._editingView;function t(t){e.change((i=>{const n=e.document.getRoot(t.name);i.addClass(t.isFocused?"ck-focused":"ck-blurred",n),i.removeClass(t.isFocused?"ck-blurred":"ck-focused",n);}));}e.isRenderingInProgress?function i(n){e.once("change:isRenderingInProgress",((e,s,o)=>{o?i(n):t(n);}));}(this):t(this);}}class Ww extends Uw{_options;constructor(e,t,i,n={}){super(e,t,i),this._options=n,this.extendTemplate({attributes:{role:"textbox",class:"ck-editor__editable_inline"}});}render(){super.render();const e=this._editingView;e.change((t=>{const i=e.document.getRoot(this.name);t.setAttribute("aria-label",this.getEditableAriaLabel(),i);}));}getEditableAriaLabel(){const e=this.locale.t,t=this._options.label,i=this._editableElement,n=this.name;if("string"==typeof t)return t;if("object"==typeof t)return t[n];if("function"==typeof t)return t(this);if(i){const e=i.getAttribute("aria-label");if(e)return e}return e("Rich Text Editor. Editing area: %0",n)}}class Gw extends el{static get pluginName(){return "Notification"}init(){this.on("show:warning",((e,t)=>{window.alert(t.message);}),{priority:"lowest"});}showSuccess(e,t={}){this._showNotification({message:e,type:"success",namespace:t.namespace,title:t.title});}showInfo(e,t={}){this._showNotification({message:e,type:"info",namespace:t.namespace,title:t.title});}showWarning(e,t={}){this._showNotification({message:e,type:"warning",namespace:t.namespace,title:t.title});}_showNotification(e){const t=e.namespace?`show:${e.type}:${e.namespace}`:`show:${e.type}`;this.fire(t,{message:e.message,type:e.type,title:e.title||""});}}class Kw extends(ar()){constructor(e,t){super(),t&&Lt(this,t),e&&this.set(e);}}const Zw=Wr("px");class Jw extends Ga{positionLimiter;visibleStack;_viewToStack=new Map;_idToStack=new Map;_view=null;_rotatorView=null;_fakePanelsView=null;static get pluginName(){return "ContextualBalloon"}constructor(e){super(e),this.positionLimiter=()=>{const e=this.editor.editing.view,t=e.document.selection.editableElement;return t?e.domConverter.mapViewToDom(t.root):null},this.decorate("getPositionOptions"),this.set("visibleView",null),this.set("_numberOfStacks",0),this.set("_singleViewMode",!1);}destroy(){super.destroy(),this._view&&this._view.destroy(),this._rotatorView&&this._rotatorView.destroy(),this._fakePanelsView&&this._fakePanelsView.destroy();}get view(){return this._view||this._createPanelView(),this._view}hasView(e){return Array.from(this._viewToStack.keys()).includes(e)}add(e){if(this._view||this._createPanelView(),this.hasView(e.view))throw new E("contextualballoon-add-view-exist",[this,e]);const t=e.stackId||"main";if(!this._idToStack.has(t))return this._idToStack.set(t,new Map([[e.view,e]])),this._viewToStack.set(e.view,this._idToStack.get(t)),this._numberOfStacks=this._idToStack.size,void(this._visibleStack&&!e.singleViewMode||this.showStack(t));const i=this._idToStack.get(t);e.singleViewMode&&this.showStack(t),i.set(e.view,e),this._viewToStack.set(e.view,i),i===this._visibleStack&&this._showView(e);}remove(e){if(!this.hasView(e))throw new E("contextualballoon-remove-view-not-exist",[this,e]);const t=this._viewToStack.get(e);this._singleViewMode&&this.visibleView===e&&(this._singleViewMode=!1),this.visibleView===e&&(1===t.size?this._idToStack.size>1?this._showNextStack():(this.view.hide(),this.visibleView=null,this._rotatorView.hideView()):this._showView(Array.from(t.values())[t.size-2])),1===t.size?(this._idToStack.delete(this._getStackId(t)),this._numberOfStacks=this._idToStack.size):t.delete(e),this._viewToStack.delete(e);}updatePosition(e){e&&(this._visibleStack.get(this.visibleView).position=e),this.view.pin(this.getPositionOptions()),this._fakePanelsView.updatePosition();}getPositionOptions(){let e=Array.from(this._visibleStack.values()).pop().position;return e&&(e.limiter||(e=Object.assign({},e,{limiter:this.positionLimiter})),e=Object.assign({},e,{viewportOffsetConfig:this.editor.ui.viewportOffset})),e}showStack(e){this.visibleStack=e;const t=this._idToStack.get(e);if(!t)throw new E("contextualballoon-showstack-stack-not-exist",this);this._visibleStack!==t&&this._showView(Array.from(t.values()).pop());}_createPanelView(){this._view=new Kp(this.editor.locale),this.editor.ui.view.body.add(this._view),this._rotatorView=this._createRotatorView(),this._fakePanelsView=this._createFakePanelsView();}get _visibleStack(){return this._viewToStack.get(this.visibleView)}_getStackId(e){return Array.from(this._idToStack.entries()).find((t=>t[1]===e))[0]}_showNextStack(){const e=Array.from(this._idToStack.values());let t=e.indexOf(this._visibleStack)+1;e[t]||(t=0),this.showStack(this._getStackId(e[t]));}_showPrevStack(){const e=Array.from(this._idToStack.values());let t=e.indexOf(this._visibleStack)-1;e[t]||(t=e.length-1),this.showStack(this._getStackId(e[t]));}_createRotatorView(){const e=new Qw(this.editor.locale),t=this.editor.locale.t;return this.view.content.add(e),e.bind("isNavigationVisible").to(this,"_numberOfStacks",this,"_singleViewMode",((e,t)=>!t&&e>1)),e.on("change:isNavigationVisible",(()=>this.updatePosition()),{priority:"low"}),e.bind("counter").to(this,"visibleView",this,"_numberOfStacks",((e,i)=>{if(i<2)return "";const n=Array.from(this._idToStack.values()).indexOf(this._visibleStack)+1;return t("%0 of %1",[n,i])})),e.buttonNextView.on("execute",(()=>{e.focusTracker.isFocused&&this.editor.editing.view.focus(),this._showNextStack();})),e.buttonPrevView.on("execute",(()=>{e.focusTracker.isFocused&&this.editor.editing.view.focus(),this._showPrevStack();})),e}_createFakePanelsView(){const e=new Yw(this.editor.locale,this.view);return e.bind("numberOfPanels").to(this,"_numberOfStacks",this,"_singleViewMode",((e,t)=>!t&&e>=2?Math.min(e-1,2):0)),e.listenTo(this.view,"change:top",(()=>e.updatePosition())),e.listenTo(this.view,"change:left",(()=>e.updatePosition())),this.editor.ui.view.body.add(e),e}_showView({view:e,balloonClassName:t="",withArrow:i=!0,singleViewMode:n=!1}){this.view.class=t,this.view.withArrow=i,this._rotatorView.showView(e),this.visibleView=e,this.view.pin(this.getPositionOptions()),this._fakePanelsView.updatePosition(),n&&(this._singleViewMode=!0);}}class Qw extends wf{focusTracker;buttonPrevView;buttonNextView;content;constructor(e){super(e);const t=e.t,i=this.bindTemplate;this.set("isNavigationVisible",!0),this.focusTracker=new Pa,this.buttonPrevView=this._createButtonView(t("Previous"),Ig.previousArrow),this.buttonNextView=this._createButtonView(t("Next"),Ig.nextArrow),this.content=this.createCollection(),this.setTemplate({tag:"div",attributes:{class:["ck","ck-balloon-rotator"],"z-index":"-1"},children:[{tag:"div",attributes:{class:["ck-balloon-rotator__navigation",i.to("isNavigationVisible",(e=>e?"":"ck-hidden"))]},children:[this.buttonPrevView,{tag:"span",attributes:{class:["ck-balloon-rotator__counter"]},children:[{text:i.to("counter")}]},this.buttonNextView]},{tag:"div",attributes:{class:"ck-balloon-rotator__content"},children:this.content}]});}render(){super.render(),this.focusTracker.add(this.element);}destroy(){super.destroy(),this.focusTracker.destroy();}showView(e){this.hideView(),this.content.add(e);}hideView(){this.content.clear();}_createButtonView(e,t){const i=new Ef(this.locale);return i.set({label:e,icon:t,tooltip:!0}),i}}class Yw extends wf{content;_balloonPanelView;constructor(e,t){super(e);const i=this.bindTemplate;this.set("top",0),this.set("left",0),this.set("height",0),this.set("width",0),this.set("numberOfPanels",0),this.content=this.createCollection(),this._balloonPanelView=t,this.setTemplate({tag:"div",attributes:{class:["ck-fake-panel",i.to("numberOfPanels",(e=>e?"":"ck-hidden"))],style:{top:i.to("top",Zw),left:i.to("left",Zw),width:i.to("width",Zw),height:i.to("height",Zw)}},children:this.content}),this.on("change:numberOfPanels",((e,t,i,n)=>{i>n?this._addPanels(i-n):this._removePanels(n-i),this.updatePosition();}));}_addPanels(e){for(;e--;){const e=new wf;e.setTemplate({tag:"div"}),this.content.add(e),this.registerChild(e);}}_removePanels(e){for(;e--;){const e=this.content.last;this.content.remove(e),this.deregisterChild(e),e.destroy();}}updatePosition(){if(this.numberOfPanels){const{top:e,left:t}=this._balloonPanelView,{width:i,height:n}=new Fr(this._balloonPanelView.element);Object.assign(this,{top:e,left:t,width:i,height:n});}}}const Xw=Wr("px");class e_ extends wf{content;contentPanelElement;_contentPanelPlaceholder;constructor(e){super(e);const t=this.bindTemplate;this.set("isActive",!1),this.set("isSticky",!1),this.set("limiterElement",null),this.set("limiterBottomOffset",50),this.set("viewportTopOffset",0),this.set("_marginLeft",null),this.set("_isStickyToTheBottomOfLimiter",!1),this.set("_stickyTopOffset",null),this.set("_stickyBottomOffset",null),this.content=this.createCollection(),this._contentPanelPlaceholder=new Jg({tag:"div",attributes:{class:["ck","ck-sticky-panel__placeholder"],style:{display:t.to("isSticky",(e=>e?"block":"none")),height:t.to("isSticky",(e=>e?Xw(this._contentPanelRect.height):null))}}}).render(),this.contentPanelElement=new Jg({tag:"div",attributes:{class:["ck","ck-sticky-panel__content",t.if("isSticky","ck-sticky-panel__content_sticky"),t.if("_isStickyToTheBottomOfLimiter","ck-sticky-panel__content_sticky_bottom-limit")],style:{width:t.to("isSticky",(e=>e?Xw(this._contentPanelPlaceholder.getBoundingClientRect().width):null)),top:t.to("_stickyTopOffset",(e=>e?Xw(e):e)),bottom:t.to("_stickyBottomOffset",(e=>e?Xw(e):e)),marginLeft:t.to("_marginLeft")}},children:this.content}).render(),this.setTemplate({tag:"div",attributes:{class:["ck","ck-sticky-panel"]},children:[this._contentPanelPlaceholder,this.contentPanelElement]});}render(){super.render(),this.checkIfShouldBeSticky(),this.listenTo(i.document,"scroll",(()=>{this.checkIfShouldBeSticky();}),{useCapture:!0}),this.listenTo(this,"change:isActive",(()=>{this.checkIfShouldBeSticky();}));}checkIfShouldBeSticky(){if(!this.limiterElement||!this.isActive)return void this._unstick();const e=new Fr(this.limiterElement);let t=e.getVisible();if(t){const e=new Fr(i.window);e.top+=this.viewportTopOffset,e.height-=this.viewportTopOffset,t=t.getIntersection(e);}if(t&&e.top<t.top){const i=t.top;if(i+this._contentPanelRect.height+this.limiterBottomOffset>t.bottom){const i=Math.max(e.bottom-t.bottom,0)+this.limiterBottomOffset;e.bottom-i>e.top+this._contentPanelRect.height?this._stickToBottomOfLimiter(i):this._unstick();}else this._contentPanelRect.height+this.limiterBottomOffset<e.height?this._stickToTopOfAncestors(i):this._unstick();}else this._unstick();}_stickToTopOfAncestors(e){this.isSticky=!0,this._isStickyToTheBottomOfLimiter=!1,this._stickyTopOffset=e,this._stickyBottomOffset=null,this._marginLeft=Xw(-i.window.scrollX);}_stickToBottomOfLimiter(e){this.isSticky=!0,this._isStickyToTheBottomOfLimiter=!0,this._stickyTopOffset=null,this._stickyBottomOffset=e,this._marginLeft=Xw(-i.window.scrollX);}_unstick(){this.isSticky=!1,this._isStickyToTheBottomOfLimiter=!1,this._stickyTopOffset=null,this._stickyBottomOffset=null,this._marginLeft=null;}get _contentPanelRect(){return new Fr(this.contentPanelElement)}}const d_=Wr("px");class h_ extends Ga{toolbarView;focusTracker;_balloonConfig;_resizeObserver=null;_balloon;_fireSelectionChangeDebounced;static get pluginName(){return "BalloonToolbar"}static get requires(){return [Jw]}constructor(e){super(e),this._balloonConfig=tb(e.config.get("balloonToolbar")),this.toolbarView=this._createToolbarView(),this.focusTracker=new Pa,this._trackFocusableEditableElements(),this.focusTracker.add(this.toolbarView.element),e.ui.addToolbar(this.toolbarView,{beforeFocus:()=>this.show(!0),afterBlur:()=>this.hide(),isContextual:!0}),this._balloon=e.plugins.get(Jw),this._fireSelectionChangeDebounced=Vo((()=>this.fire("_selectionChangeDebounced")),200),this.decorate("show");}init(){const e=this.editor,t=e.model.document.selection;this.listenTo(this.focusTracker,"change:isFocused",((e,t,i)=>{const n=this._balloon.visibleView===this.toolbarView;!i&&n?this.hide():i&&this.show();})),this.listenTo(t,"change:range",((e,i)=>{(i.directChange||t.isCollapsed)&&this.hide(),this._fireSelectionChangeDebounced();})),this.listenTo(this,"_selectionChangeDebounced",(()=>{this.editor.editing.view.document.isFocused&&this.show();})),this._balloonConfig.shouldNotGroupWhenFull||this.listenTo(e,"ready",(()=>{const t=e.ui.view.editable.element;this._resizeObserver=new $r(t,(e=>{this.toolbarView.maxWidth=d_(.9*e.contentRect.width);}));})),this.listenTo(this.toolbarView,"groupedItemsUpdate",(()=>{this._updatePosition();})),e.ui.once("ready",(()=>{this.toolbarView.fillFromConfig(this._balloonConfig,this.editor.ui.componentFactory);}));}_createToolbarView(){const e=this.editor.locale.t,t=!this._balloonConfig.shouldNotGroupWhenFull,i=new nb(this.editor.locale,{shouldGroupWhenFull:t,isFloating:!0});return i.ariaLabel=e("Editor contextual toolbar"),i.render(),i}show(e=!1){const t=this.editor,i=t.model.document.selection,n=t.model.schema;this._balloon.hasView(this.toolbarView)||i.isCollapsed&&!e||function(e,t){if(1===e.rangeCount)return !1;return [...e.getRanges()].every((e=>{const i=e.getContainedElement();return i&&t.isSelectable(i)}))}(i,n)||Array.from(this.toolbarView.items).every((e=>void 0!==e.isEnabled&&!e.isEnabled))||(this.listenTo(this.editor.ui,"update",(()=>{this._updatePosition();})),this._balloon.add({view:this.toolbarView,position:this._getBalloonPositionData(),balloonClassName:"ck-toolbar-container"}));}hide(){this._balloon.hasView(this.toolbarView)&&(this.stopListening(this.editor.ui,"update"),this._balloon.remove(this.toolbarView));}_trackFocusableEditableElements(){const{editor:e,focusTracker:t}=this,{editing:i}=e;i.view.addObserver(class extends Oc{observe(e){t.add(e);}stopObserving(e){t.remove(e);}});}_getBalloonPositionData(){const e=this.editor.editing.view,t=e.document,i=t.selection,n=t.selection.isBackward;return {target:()=>{const t=n?i.getFirstRange():i.getLastRange(),s=Fr.getDomRangeRects(e.domConverter.viewRangeToDom(t));return n?s[0]:(s.length>1&&0===s[s.length-1].width&&s.pop(),s[s.length-1])},positions:this._getBalloonPositions(n)}}_updatePosition(){this._balloon.updatePosition(this._getBalloonPositionData());}destroy(){super.destroy(),this.stopListening(),this._fireSelectionChangeDebounced.cancel(),this.toolbarView.destroy(),this.focusTracker.destroy(),this._resizeObserver&&this._resizeObserver.destroy();}_getBalloonPositions(e){const t=o.isSafari&&o.isiOS?Kp.generatePositions({heightOffset:Math.max(Kp.arrowHeightOffset,Math.round(20/i.window.visualViewport.scale))}):Kp.defaultPositions;return e?[t.northWestArrowSouth,t.northWestArrowSouthWest,t.northWestArrowSouthEast,t.northWestArrowSouthMiddleEast,t.northWestArrowSouthMiddleWest,t.southWestArrowNorth,t.southWestArrowNorthWest,t.southWestArrowNorthEast,t.southWestArrowNorthMiddleWest,t.southWestArrowNorthMiddleEast]:[t.southEastArrowNorth,t.southEastArrowNorthEast,t.southEastArrowNorthWest,t.southEastArrowNorthMiddleEast,t.southEastArrowNorthMiddleWest,t.northEastArrowSouth,t.northEastArrowSouthEast,t.northEastArrowSouthWest,t.northEastArrowSouthMiddleEast,t.northEastArrowSouthMiddleWest]}}class p_ extends zf{arrowView;constructor(e){super(e);const t=this.bindTemplate;this.set({withText:!0,role:"menuitem"}),this.arrowView=this._createArrowView(),this.extendTemplate({attributes:{class:["ck-menu-bar__menu__button"],"aria-haspopup":!0,"aria-expanded":this.bindTemplate.to("isOn",(e=>String(e))),"data-cke-tooltip-disabled":t.to("isOn")},on:{mouseenter:t.to("mouseenter")}});}render(){super.render(),this.children.add(this.arrowView);}_createArrowView(){const e=new xf;return e.content=ep,e.extendTemplate({attributes:{class:"ck-menu-bar__menu__button__arrow"}}),e}}class b_ extends wf{children;constructor(e){super(e);const t=this.bindTemplate;this.set("isVisible",!1),this.set("position","se"),this.children=this.createCollection(),this.setTemplate({tag:"div",attributes:{class:["ck","ck-reset","ck-menu-bar__menu__panel",t.to("position",(e=>`ck-menu-bar__menu__panel_position_${e}`)),t.if("isVisible","ck-hidden",(e=>!e))],tabindex:"-1"},children:this.children,on:{selectstart:t.to((e=>{"input"!==e.target.tagName.toLocaleLowerCase()&&e.preventDefault();}))}});}focus(e=1){this.children.length&&(1===e?this.children.first.focus():this.children.last.focus());}}class w_ extends wf{buttonView;panelView;focusTracker;keystrokes;constructor(e){super(e);const t=this.bindTemplate;this.buttonView=new p_(e),this.buttonView.delegate("mouseenter").to(this),this.buttonView.bind("isOn","isEnabled").to(this,"isOpen","isEnabled"),this.panelView=new b_(e),this.panelView.bind("isVisible").to(this,"isOpen"),this.keystrokes=new Va,this.focusTracker=new Pa,this.set("isOpen",!1),this.set("isEnabled",!0),this.set("panelPosition","w"),this.set("class",void 0),this.set("parentMenuView",null),this.setTemplate({tag:"div",attributes:{class:["ck","ck-menu-bar__menu",t.to("class"),t.if("isEnabled","ck-disabled",(e=>!e)),t.if("parentMenuView","ck-menu-bar__menu_top-level",(e=>!e))]},children:[this.buttonView,this.panelView]});}render(){super.render(),this.focusTracker.add(this.buttonView.element),this.focusTracker.add(this.panelView.element),this.keystrokes.listenTo(this.element),xw.closeOnEscKey(this),this._repositionPanelOnOpen();}_attachBehaviors(){this.parentMenuView?(xw.openOnButtonClick(this),xw.openOnArrowRightKey(this),xw.closeOnArrowLeftKey(this),xw.openAndFocusOnEnterKeyPress(this),xw.closeOnParentClose(this)):(this._propagateArrowKeystrokeEvents(),xw.openAndFocusPanelOnArrowDownKey(this),xw.toggleOnButtonClick(this));}_propagateArrowKeystrokeEvents(){this.keystrokes.set("arrowright",((e,t)=>{this.fire("arrowright"),t();})),this.keystrokes.set("arrowleft",((e,t)=>{this.fire("arrowleft"),t();}));}_repositionPanelOnOpen(){this.on("change:isOpen",((e,t,i)=>{if(!i)return;const n=w_._getOptimalPosition({element:this.panelView.element,target:this.buttonView.element,fitInViewport:!0,positions:this._panelPositions});this.panelView.position=n?n.name:this._panelPositions[0].name;}));}focus(){this.buttonView.focus();}get _panelPositions(){const{southEast:e,southWest:t,northEast:i,northWest:n,westSouth:s,eastSouth:o,westNorth:r,eastNorth:a}=Aw;return "ltr"===this.locale.uiLanguageDirection?this.parentMenuView?[o,a,s,r]:[e,t,i,n]:this.parentMenuView?[s,r,o,a]:[t,e,n,i]}static _getOptimalPosition=Jr}class __ extends zp{constructor(e){super(e),this.role="menu",this.items.on("change",this._setItemsCheckSpace.bind(this));}_setItemsCheckSpace(){const e=Array.from(this.items).some((e=>{const t=v_(e);return t&&t.isToggleable}));this.items.forEach((t=>{const i=v_(t);i&&(i.hasCheckSpace=e);}));}}function v_(e){return e instanceof Fp?e.children.map((e=>function(e){return "object"==typeof e&&"buttonView"in e&&e.buttonView instanceof Ef}(e)?e.buttonView:e)).find((e=>e instanceof zf)):null}class y_ extends Qf{constructor(e){super(e),this.set({withText:!0,withKeystroke:!0,tooltip:!1,role:"menuitem"}),this.extendTemplate({attributes:{class:["ck-menu-bar__menu__item__button"]}});}}const k_=["mouseenter","arrowleft","arrowright","change:isOpen"];class C_ extends wf{children;menus=[];constructor(e){super(e);const t=e.t,i=this.bindTemplate;this.set({isOpen:!1,isFocusBorderEnabled:!1}),this._setupIsOpenUpdater(),this.children=this.createCollection(),this.setTemplate({tag:"div",attributes:{class:["ck","ck-menu-bar",i.if("isFocusBorderEnabled","ck-menu-bar_focus-border-enabled")],"aria-label":t("Editor menu bar"),role:"menubar"},children:this.children});}fillFromConfig(e,t,i=[]){const n=Sw({normalizedConfig:e,locale:this.locale,componentFactory:t,extraItems:i}).items.map((e=>this._createMenu({componentFactory:t,menuDefinition:e})));this.children.addMany(n);}render(){super.render(),Cw.toggleMenusAndFocusItemsOnHover(this),Cw.closeMenusWhenTheBarCloses(this),Cw.closeMenuWhenAnotherOnTheSameLevelOpens(this),Cw.focusCycleMenusOnArrows(this),Cw.closeOnClickOutside(this),Cw.enableFocusHighlightOnInteraction(this);}focus(){this.children.first&&this.children.first.focus();}close(){for(const e of this.children)e.isOpen=!1;}registerMenu(e,t=null){t?(e.delegate(...k_).to(t),e.parentMenuView=t):e.delegate(...k_).to(this,(e=>"menu:"+e)),e._attachBehaviors(),this.menus.push(e);}_createMenu({componentFactory:e,menuDefinition:t,parentMenuView:i}){const n=this.locale,s=new w_(n);return this.registerMenu(s,i),s.buttonView.set({label:t.label}),s.once("change:isOpen",(()=>{const i=new __(n);i.ariaLabel=t.label,s.panelView.children.add(i),i.items.addMany(this._createMenuItems({menuDefinition:t,parentMenuView:s,componentFactory:e}));})),s}_createMenuItems({menuDefinition:e,parentMenuView:t,componentFactory:i}){const n=this.locale,s=[];for(const o of e.groups){for(const e of o.items){const o=new kw(n,t);if(pe(e))o.children.add(this._createMenu({componentFactory:i,menuDefinition:e,parentMenuView:t}));else {const n=this._createMenuItemContentFromFactory({componentName:e,componentFactory:i,parentMenuView:t});if(!n)continue;o.children.add(n);}s.push(o);}o!==e.groups[e.groups.length-1]&&s.push(new Np(n));}return s}_createMenuItemContentFromFactory({componentName:e,parentMenuView:t,componentFactory:i}){const n=i.create(e);return n instanceof w_||n instanceof $f||n instanceof y_?(this._registerMenuTree(n,t),n.on("execute",(()=>{this.close();})),n):(T("menu-bar-component-unsupported",{componentName:e,componentView:n}),null)}_registerMenuTree(e,t){if(!(e instanceof w_))return void e.delegate("mouseenter").to(t);this.registerMenu(e,t);const i=e.panelView.children.filter((e=>e instanceof __))[0];if(!i)return void e.delegate("mouseenter").to(t);const n=i.items.filter((e=>e instanceof Fp));for(const t of n)this._registerMenuTree(t.children.get(0),e);}_setupIsOpenUpdater(){let e;this.on("menu:change:isOpen",((t,i,n)=>{clearTimeout(e),n?this.isOpen=!0:e=setTimeout((()=>{this.isOpen=Array.from(this.children).some((e=>e.isOpen));}),0);}));}}class T_{model;limit;_isLocked;_size;_batch=null;_changeCallback;_selectionChangeCallback;constructor(e,t=20){this.model=e,this._size=0,this.limit=t,this._isLocked=!1,this._changeCallback=(e,t)=>{t.isLocal&&t.isUndoable&&t!==this._batch&&this._reset(!0);},this._selectionChangeCallback=()=>{this._reset();},this.model.document.on("change",this._changeCallback),this.model.document.selection.on("change:range",this._selectionChangeCallback),this.model.document.selection.on("change:attribute",this._selectionChangeCallback);}get batch(){return this._batch||(this._batch=this.model.createBatch({isTyping:!0})),this._batch}get size(){return this._size}input(e){this._size+=e,this._size>=this.limit&&this._reset(!0);}get isLocked(){return this._isLocked}lock(){this._isLocked=!0;}unlock(){this._isLocked=!1;}destroy(){this.model.document.off("change",this._changeCallback),this.model.document.selection.off("change:range",this._selectionChangeCallback),this.model.document.selection.off("change:attribute",this._selectionChangeCallback);}_reset(e=!1){this.isLocked&&!e||(this._batch=null,this._size=0);}}class S_ extends Za{_buffer;constructor(e,t){super(e),this._buffer=new T_(e.model,t),this._isEnabledBasedOnSelection=!1;}get buffer(){return this._buffer}destroy(){super.destroy(),this._buffer.destroy();}execute(e={}){const t=this.editor.model,i=t.document,n=e.text||"",s=n.length;let o=i.selection;if(e.selection?o=e.selection:e.range&&(o=t.createSelection(e.range)),!t.canEditAt(o))return;const r=e.resultRange;t.enqueueChange(this._buffer.batch,(e=>{this._buffer.lock();const a=Array.from(i.selection.getAttributes());t.deleteContent(o),n&&t.insertContent(e.createText(n,a),o),r?e.setSelection(r):o.is("documentSelection")||e.setSelection(o),this._buffer.unlock(),this._buffer.input(s);}));}}const I_=["insertText","insertReplacementText"],P_=[...I_,"insertCompositionText"];class V_ extends Oc{focusObserver;constructor(e){super(e),this.focusObserver=e.getObserver(Hc);const t=o.isAndroid?P_:I_,i=e.document;i.on("beforeinput",((n,s)=>{if(!this.isEnabled)return;const{data:o,targetRanges:r,inputType:a,domEvent:l}=s;if(!t.includes(a))return;this.focusObserver.flush();const c=new v(i,"insertText");i.fire(c,new Mc(e,l,{text:o,selection:e.createSelection(r)})),c.stop.called&&n.stop();})),o.isAndroid||i.on("compositionend",((t,{data:n,domEvent:s})=>{this.isEnabled&&n&&i.fire("insertText",new Mc(e,s,{text:n}));}),{priority:"lowest"});}observe(){}stopObserving(){}}class R_ extends Ga{_compositionQueue;static get pluginName(){return "Input"}init(){const e=this.editor,t=e.model,i=e.editing.view,n=e.editing.mapper,s=t.document.selection;this._compositionQueue=new B_(e),i.addObserver(V_);const r=new S_(e,e.config.get("typing.undoStep")||20);e.commands.add("insertText",r),e.commands.add("input",r),this.listenTo(i.document,"insertText",((r,a)=>{i.document.isComposing||a.preventDefault(),o.isAndroid&&i.document.isComposing&&this._compositionQueue.flush("next beforeinput");const{text:l,selection:c}=a;let d;d=c?Array.from(c.getRanges()).map((e=>n.toModelRange(e))):Array.from(s.getRanges());let h=l;if(o.isAndroid){const e=Array.from(d[0].getItems()).reduce(((e,t)=>e+(t.is("$textProxy")?t.data:"")),"");if(e&&(e.length<=h.length?h.startsWith(e)&&(h=h.substring(e.length),d[0].start=d[0].start.getShiftedBy(e.length)):e.startsWith(h)&&(d[0].start=d[0].start.getShiftedBy(h.length),h="")),0==h.length&&d[0].isCollapsed)return}const u={text:h,selection:t.createSelection(d)};o.isAndroid&&i.document.isComposing?this._compositionQueue.push(u):(e.execute("insertText",u),i.scrollToTheSelection());})),o.isAndroid?this.listenTo(i.document,"keydown",((e,n)=>{!s.isCollapsed&&229==n.keyCode&&i.document.isComposing&&O_(t,r);})):this.listenTo(i.document,"compositionstart",(()=>{s.isCollapsed||O_(t,r);})),o.isAndroid?(this.listenTo(i.document,"mutations",((e,{mutations:t})=>{if(i.document.isComposing)for(const{node:e}of t){const t=M_(e,n),i=n.toModelElement(t);if(this._compositionQueue.isComposedElement(i))return void this._compositionQueue.flush("mutations")}})),this.listenTo(i.document,"compositionend",(()=>{this._compositionQueue.flush("composition end");})),this.listenTo(i.document,"compositionend",(()=>{const e=[];for(const t of this._compositionQueue.flushComposedElements()){const i=n.toViewElement(t);i&&e.push({type:"children",node:i});}e.length&&i.document.fire("mutations",{mutations:e});}),{priority:"lowest"})):this.listenTo(i.document,"compositionend",(()=>{i.document.fire("mutations",{mutations:[]});}),{priority:"lowest"});}destroy(){super.destroy(),this._compositionQueue.destroy();}}class B_{editor;flushDebounced=Vo((()=>this.flush("timeout")),50);_queue=[];_compositionElements=new Set;constructor(e){this.editor=e;}destroy(){for(this.flushDebounced.cancel(),this._compositionElements.clear();this._queue.length;)this.shift();}get length(){return this._queue.length}push(e){const t={text:e.text};if(e.selection){t.selectionRanges=[];for(const i of e.selection.getRanges())t.selectionRanges.push(xd.fromRange(i)),this._compositionElements.add(i.start.parent);}this._queue.push(t),this.flushDebounced();}shift(){const e=this._queue.shift(),t={text:e.text};if(e.selectionRanges){const i=e.selectionRanges.map((e=>function(e){const t=e.toRange();if(e.detach(),"$graveyard"==t.root.rootName)return null;return t}(e))).filter((e=>!!e));i.length&&(t.selection=this.editor.model.createSelection(i));}return t}flush(e){const t=this.editor,i=t.model,n=t.editing.view;if(this.flushDebounced.cancel(),!this._queue.length)return;const s=t.commands.get("insertText").buffer;i.enqueueChange(s.batch,(()=>{for(s.lock();this._queue.length;){const e=this.shift();t.execute("insertText",e);}s.unlock();})),n.scrollToTheSelection();}isComposedElement(e){return this._compositionElements.has(e)}flushComposedElements(){const e=Array.from(this._compositionElements);return this._compositionElements.clear(),e}}function O_(e,t){if(!t.isEnabled)return;const i=t.buffer;i.lock(),e.enqueueChange(i.batch,(()=>{e.deleteContent(e.document.selection);})),i.unlock();}function M_(e,t){let i=e.is("$text")?e.parent:e;for(;!t.toModelElement(i);)i=i.parent;return i}class L_ extends Za{direction;_buffer;constructor(e,t){super(e),this.direction=t,this._buffer=new T_(e.model,e.config.get("typing.undoStep")),this._isEnabledBasedOnSelection=!1;}get buffer(){return this._buffer}execute(e={}){const t=this.editor.model,i=t.document;t.enqueueChange(this._buffer.batch,(n=>{this._buffer.lock();const s=n.createSelection(e.selection||i.selection);if(!t.canEditAt(s))return;const o=e.sequence||1,r=s.isCollapsed;if(s.isCollapsed&&t.modifySelection(s,{direction:this.direction,unit:e.unit,treatEmojiAsSingleUnit:!0}),this._shouldEntireContentBeReplacedWithParagraph(o))return void this._replaceEntireContentWithParagraph(n);if(this._shouldReplaceFirstBlockWithParagraph(s,o))return void this.editor.execute("paragraph",{selection:s});if(s.isCollapsed)return;let a=0;s.getFirstRange().getMinimalFlatRanges().forEach((e=>{a+=fr(e.getWalker({singleCharacters:!0,ignoreElementEnd:!0,shallow:!0}));})),t.deleteContent(s,{doNotResetEntireContent:r,direction:this.direction}),this._buffer.input(a),n.setSelection(s),this._buffer.unlock();}));}_shouldEntireContentBeReplacedWithParagraph(e){if(e>1)return !1;const t=this.editor.model,i=t.document.selection,n=t.schema.getLimitElement(i);if(!(i.isCollapsed&&i.containsEntireContent(n)))return !1;if(!t.schema.checkChild(n,"paragraph"))return !1;const s=n.getChild(0);return !s||!s.is("element","paragraph")}_replaceEntireContentWithParagraph(e){const t=this.editor.model,i=t.document.selection,n=t.schema.getLimitElement(i),s=e.createElement("paragraph");e.remove(e.createRangeIn(n)),e.insert(s,n),e.setSelection(s,0);}_shouldReplaceFirstBlockWithParagraph(e,t){const i=this.editor.model;if(t>1||"backward"!=this.direction)return !1;if(!e.isCollapsed)return !1;const n=e.getFirstPosition(),s=i.schema.getLimitElement(n),o=s.getChild(0);return n.parent==o&&(!!e.containsEntireContent(o)&&(!!i.schema.checkChild(s,"paragraph")&&"paragraph"!=o.name))}}const F_="word",N_="selection",D_="backward",z_="forward",H_={deleteContent:{unit:N_,direction:D_},deleteContentBackward:{unit:"codePoint",direction:D_},deleteWordBackward:{unit:F_,direction:D_},deleteHardLineBackward:{unit:N_,direction:D_},deleteSoftLineBackward:{unit:N_,direction:D_},deleteContentForward:{unit:"character",direction:z_},deleteWordForward:{unit:F_,direction:z_},deleteHardLineForward:{unit:N_,direction:z_},deleteSoftLineForward:{unit:N_,direction:z_}};class $_ extends Oc{constructor(e){super(e);const t=e.document;let i=0;t.on("keydown",(()=>{i++;})),t.on("keyup",(()=>{i=0;})),t.on("beforeinput",((n,s)=>{if(!this.isEnabled)return;const{targetRanges:r,domEvent:a,inputType:l}=s,c=H_[l];if(!c)return;const d={direction:c.direction,unit:c.unit,sequence:i};d.unit==N_&&(d.selectionToRemove=e.createSelection(r[0])),"deleteContentBackward"===l&&(o.isAndroid&&(d.sequence=1),function(e){if(1!=e.length||e[0].isCollapsed)return !1;const t=e[0].getWalker({direction:"backward",singleCharacters:!0,ignoreElementEnd:!0});let i=0;for(const{nextPosition:e,item:n}of t){if(e.parent.is("$text")){const t=e.parent.data,n=e.offset;if($a(t,n)||Ua(t,n)||ja(t,n))continue;i++;}else (n.is("containerElement")||n.is("emptyElement"))&&i++;if(i>1)return !0}return !1}(r)&&(d.unit=N_,d.selectionToRemove=e.createSelection(r)));const h=new Ml(t,"delete",r[0]);t.fire(h,new Mc(e,a,d)),h.stop.called&&n.stop();})),o.isBlink&&function(e){const t=e.view,i=t.document;let n=null,s=!1;function o(e){return e==ga.backspace||e==ga.delete}function r(e){return e==ga.backspace?D_:z_}i.on("keydown",((e,{keyCode:t})=>{n=t,s=!1;})),i.on("keyup",((a,{keyCode:l,domEvent:c})=>{const d=i.selection,h=e.isEnabled&&l==n&&o(l)&&!d.isCollapsed&&!s;if(n=null,h){const e=d.getFirstRange(),n=new Ml(i,"delete",e),s={unit:N_,direction:r(l),selectionToRemove:d};i.fire(n,new Mc(t,c,s));}})),i.on("beforeinput",((e,{inputType:t})=>{const i=H_[t];o(n)&&i&&i.direction==r(n)&&(s=!0);}),{priority:"high"}),i.on("beforeinput",((e,{inputType:t,data:i})=>{n==ga.delete&&"insertText"==t&&""==i&&e.stop();}),{priority:"high"});}(this);}observe(){}stopObserving(){}}class U_ extends Ga{_undoOnBackspace;static get pluginName(){return "Delete"}init(){const e=this.editor,t=e.editing.view,i=t.document,n=e.model.document;t.addObserver($_),this._undoOnBackspace=!1;const s=new L_(e,"forward");e.commands.add("deleteForward",s),e.commands.add("forwardDelete",s),e.commands.add("delete",new L_(e,"backward")),this.listenTo(i,"delete",((n,s)=>{i.isComposing||s.preventDefault();const{direction:o,sequence:r,selectionToRemove:a,unit:l}=s,c="forward"===o?"deleteForward":"delete",d={sequence:r};if("selection"==l){const t=Array.from(a.getRanges()).map((t=>e.editing.mapper.toModelRange(t)));d.selection=e.model.createSelection(t);}else d.unit=l;e.execute(c,d),t.scrollToTheSelection();}),{priority:"low"}),this.editor.plugins.has("UndoEditing")&&(this.listenTo(i,"delete",((t,i)=>{this._undoOnBackspace&&"backward"==i.direction&&1==i.sequence&&"codePoint"==i.unit&&(this._undoOnBackspace=!1,e.execute("undo"),i.preventDefault(),t.stop());}),{context:"$capture"}),this.listenTo(n,"change",(()=>{this._undoOnBackspace=!1;})));}requestUndoOnBackspace(){this.editor.plugins.has("UndoEditing")&&(this._undoOnBackspace=!0);}}class W_ extends Ga{static get requires(){return [R_,U_]}static get pluginName(){return "Typing"}}function j_(e,t){let i=e.start;return {text:Array.from(e.getWalker({ignoreElementEnd:!1})).reduce(((e,{item:n})=>n.is("$text")||n.is("$textProxy")?e+n.data:(i=t.createPositionAfter(n),"")),""),range:t.createRange(i,e.end)}}class q_ extends(ar()){model;testCallback;_hasMatch;constructor(e,t){super(),this.model=e,this.testCallback=t,this._hasMatch=!1,this.set("isEnabled",!0),this.on("change:isEnabled",(()=>{this.isEnabled?this._startListening():(this.stopListening(e.document.selection),this.stopListening(e.document));})),this._startListening();}get hasMatch(){return this._hasMatch}_startListening(){const e=this.model.document;this.listenTo(e.selection,"change:range",((t,{directChange:i})=>{i&&(e.selection.isCollapsed?this._evaluateTextBeforeSelection("selection"):this.hasMatch&&(this.fire("unmatched"),this._hasMatch=!1));})),this.listenTo(e,"change:data",((e,t)=>{!t.isUndo&&t.isLocal&&this._evaluateTextBeforeSelection("data",{batch:t});}));}_evaluateTextBeforeSelection(e,t={}){const i=this.model,n=i.document.selection,s=i.createRange(i.createPositionAt(n.focus.parent,0),n.focus),{text:o,range:r}=j_(s,i),a=this.testCallback(o);if(!a&&this.hasMatch&&this.fire("unmatched"),this._hasMatch=!!a,a){const i=Object.assign(t,{text:o,range:r});"object"==typeof a&&Object.assign(i,a),this.fire(`matched:${e}`,i);}}}class G_ extends Ga{attributes;_overrideUid;_isNextGravityRestorationSkipped=!1;static get pluginName(){return "TwoStepCaretMovement"}constructor(e){super(e),this.attributes=new Set,this._overrideUid=null;}init(){const e=this.editor,t=e.model,i=e.editing.view,n=e.locale,s=t.document.selection;this.listenTo(i.document,"arrowKey",((e,t)=>{if(!s.isCollapsed)return;if(t.shiftKey||t.altKey||t.ctrlKey)return;const i=t.keyCode==ga.arrowright,o=t.keyCode==ga.arrowleft;if(!i&&!o)return;const r=n.contentLanguageDirection;let a=!1;a="ltr"===r&&i||"rtl"===r&&o?this._handleForwardMovement(t):this._handleBackwardMovement(t),!0===a&&e.stop();}),{context:"$text",priority:"highest"}),this.listenTo(s,"change:range",((e,t)=>{this._isNextGravityRestorationSkipped?this._isNextGravityRestorationSkipped=!1:this._isGravityOverridden&&(!t.directChange&&X_(s.getFirstPosition(),this.attributes)||this._restoreGravity());})),this._enableClickingAfterNode(),this._enableInsertContentSelectionAttributesFixer(),this._handleDeleteContentAfterNode();}registerAttribute(e){this.attributes.add(e);}_handleForwardMovement(e){const t=this.attributes,i=this.editor.model,n=i.document.selection,s=n.getFirstPosition();return !this._isGravityOverridden&&((!s.isAtStart||!K_(n,t))&&(!!X_(s,t)&&(Q_(e),K_(n,t)&&X_(s,t,!0)?J_(i,t):this._overrideGravity(),!0)))}_handleBackwardMovement(e){const t=this.attributes,i=this.editor.model,n=i.document.selection,s=n.getFirstPosition();return this._isGravityOverridden?(Q_(e),this._restoreGravity(),X_(s,t,!0)?J_(i,t):Z_(i,t,s),!0):s.isAtStart?!!K_(n,t)&&(Q_(e),Z_(i,t,s),!0):!K_(n,t)&&X_(s,t,!0)?(Q_(e),Z_(i,t,s),!0):!!Y_(s,t)&&(s.isAtEnd&&!K_(n,t)&&X_(s,t)?(Q_(e),Z_(i,t,s),!0):(this._isNextGravityRestorationSkipped=!0,this._overrideGravity(),!1))}_enableClickingAfterNode(){const e=this.editor,t=e.model,i=t.document.selection,n=e.editing.view.document;e.editing.view.addObserver(Xu);let s=!1;this.listenTo(n,"mousedown",(()=>{s=!0;})),this.listenTo(n,"selectionChange",(()=>{const e=this.attributes;if(!s)return;if(s=!1,!i.isCollapsed)return;if(!K_(i,e))return;const n=i.getFirstPosition();X_(n,e)&&(n.isAtStart||X_(n,e,!0)?J_(t,e):this._isGravityOverridden||this._overrideGravity());}));}_enableInsertContentSelectionAttributesFixer(){const e=this.editor.model,t=e.document.selection,i=this.attributes;this.listenTo(e,"insertContent",(()=>{const n=t.getFirstPosition();K_(t,i)&&X_(n,i)&&J_(e,i);}),{priority:"low"});}_handleDeleteContentAfterNode(){const e=this.editor,t=e.model,i=t.document.selection,n=e.editing.view;let s=!1,o=!1;this.listenTo(n.document,"delete",((e,t)=>{s="backward"===t.direction;}),{priority:"high"}),this.listenTo(t,"deleteContent",(()=>{if(!s)return;const e=i.getFirstPosition();o=K_(i,this.attributes)&&!Y_(e,this.attributes);}),{priority:"high"}),this.listenTo(t,"deleteContent",(()=>{s&&(s=!1,o||e.model.enqueueChange((()=>{const e=i.getFirstPosition();K_(i,this.attributes)&&X_(e,this.attributes)&&(e.isAtStart||X_(e,this.attributes,!0)?J_(t,this.attributes):this._isGravityOverridden||this._overrideGravity());})));}),{priority:"low"});}get _isGravityOverridden(){return !!this._overrideUid}_overrideGravity(){this._overrideUid=this.editor.model.change((e=>e.overrideSelectionGravity()));}_restoreGravity(){this.editor.model.change((e=>{e.restoreSelectionGravity(this._overrideUid),this._overrideUid=null;}));}}function K_(e,t){for(const i of t)if(e.hasAttribute(i))return !0;return !1}function Z_(e,t,i){const n=i.nodeBefore;e.change((i=>{if(n){const t=[],s=e.schema.isObject(n)&&e.schema.isInline(n);for(const[i,o]of n.getAttributes())!e.schema.checkAttribute("$text",i)||s&&!1===e.schema.getAttributeProperties(i).copyFromObject||t.push([i,o]);i.setSelectionAttribute(t);}else i.removeSelectionAttribute(t);}));}function J_(e,t){e.change((e=>{e.removeSelectionAttribute(t);}));}function Q_(e){e.preventDefault();}function Y_(e,t){return X_(e.getShiftedBy(-1),t)}function X_(e,t,i=!1){const{nodeBefore:n,nodeAfter:s}=e;for(const e of t){const t=n?n.getAttribute(e):void 0,o=s?s.getAttribute(e):void 0;if((!i||void 0!==t&&void 0!==o)&&o!==t)return !0}return !1}function lv(e,t,i,n){return n.createRange(cv(e,t,i,!0,n),cv(e,t,i,!1,n))}function cv(e,t,i,n,s){let o=e.textNode||(n?e.nodeBefore:e.nodeAfter),r=null;for(;o&&o.getAttribute(t)==i;)r=o,o=n?o.previousSibling:o.nextSibling;return r?s.createPositionAt(r,n?"before":"after"):e}function dv(e,t,i,n){const s=e.editing.view,o=new Set;s.document.registerPostFixer((s=>{const r=e.model.document.selection;let a=!1;if(r.hasAttribute(t)){const l=lv(r.getFirstPosition(),t,r.getAttribute(t),e.model),c=e.editing.mapper.toViewRange(l);for(const e of c.getItems())e.is("element",i)&&!e.hasClass(n)&&(s.addClass(n,e),o.add(e),a=!0);}return a})),e.conversion.for("editingDowncast").add((e=>{function t(){s.change((e=>{for(const t of o.values())e.removeClass(n,t),o.delete(t);}));}e.on("insert",t,{priority:"highest"}),e.on("remove",t,{priority:"highest"}),e.on("attribute",t,{priority:"highest"}),e.on("selection",t,{priority:"highest"});}));}function hv(e,t,i,n){let s,o=null;"function"==typeof n?s=n:(o=e.commands.get(n),s=()=>{e.execute(n);}),e.model.document.on("change:data",((r,a)=>{if(o&&!o.isEnabled||!t.isEnabled)return;const l=Ia(e.model.document.selection.getRanges());if(!l.isCollapsed)return;if(a.isUndo||!a.isLocal)return;const c=Array.from(e.model.document.differ.getChanges()),d=c[0];if(1!=c.length||"insert"!==d.type||"$text"!=d.name||1!=d.length)return;const h=d.position.parent;if(h.is("element","codeBlock"))return;if(h.is("element","listItem")&&"function"!=typeof n&&!["numberedList","bulletedList","todoList"].includes(n))return;if(o&&!0===o.value)return;const u=h.getChild(0),m=e.model.createRangeOn(u);if(!m.containsRange(l)&&!l.end.isEqual(m.end))return;const g=i.exec(u.data.substr(0,l.end.offset));g&&e.model.enqueueChange((t=>{const i=t.createPositionAt(h,0),n=t.createPositionAt(h,g[0].length),o=new xd(i,n);if(!1!==s({match:g})){t.remove(o);const i=e.model.document.selection.getFirstRange(),n=t.createRangeIn(h);!h.isEmpty||n.isEqual(i)||n.containsRange(i,!0)||t.remove(h);}o.detach(),e.model.enqueueChange((()=>{e.plugins.get("Delete").requestUndoOnBackspace();}));}));}));}function uv(e,t,i,n){let s,o;i instanceof RegExp?s=i:o=i,o=o||(e=>{let t;const i=[],n=[];for(;null!==(t=s.exec(e))&&!(t&&t.length<4);){let{index:e,1:s,2:o,3:r}=t;const a=s+o+r;e+=t[0].length-a.length;const l=[e,e+s.length],c=[e+s.length+o.length,e+s.length+o.length+r.length];i.push(l),i.push(c),n.push([e+s.length,e+s.length+o.length]);}return {remove:i,format:n}}),e.model.document.on("change:data",((i,s)=>{if(s.isUndo||!s.isLocal||!t.isEnabled)return;const r=e.model,a=r.document.selection;if(!a.isCollapsed)return;const l=Array.from(r.document.differ.getChanges()),c=l[0];if(1!=l.length||"insert"!==c.type||"$text"!=c.name||1!=c.length)return;const d=a.focus,h=d.parent,{text:u,range:m}=function(e,t){let i=e.start;const n=Array.from(e.getItems()).reduce(((e,n)=>!n.is("$text")&&!n.is("$textProxy")||n.getAttribute("code")?(i=t.createPositionAfter(n),""):e+n.data),"");return {text:n,range:t.createRange(i,e.end)}}(r.createRange(r.createPositionAt(h,0),d),r),g=o(u),f=mv(m.start,g.format,r),p=mv(m.start,g.remove,r);f.length&&p.length&&r.enqueueChange((t=>{if(!1!==n(t,f)){for(const e of p.reverse())t.remove(e);r.enqueueChange((()=>{e.plugins.get("Delete").requestUndoOnBackspace();}));}}));}));}function mv(e,t,i){return t.filter((e=>void 0!==e[0]&&void 0!==e[1])).map((t=>i.createRange(e.getShiftedBy(t[0]),e.getShiftedBy(t[1]))))}class gv extends Ga{static get requires(){return [U_]}static get pluginName(){return "Autoformat"}afterInit(){const e=this.editor,t=this.editor.t;this._addListAutoformats(),this._addBasicStylesAutoformats(),this._addHeadingAutoformats(),this._addBlockQuoteAutoformats(),this._addCodeBlockAutoformats(),this._addHorizontalLineAutoformats(),e.accessibility.addKeystrokeInfos({keystrokes:[{label:t("Revert autoformatting action"),keystroke:"Backspace"}]});}_addListAutoformats(){const e=this.editor.commands;e.get("bulletedList")&&hv(this.editor,this,/^[*-]\s$/,"bulletedList"),e.get("numberedList")&&hv(this.editor,this,/^1[.|)]\s$/,"numberedList"),e.get("todoList")&&hv(this.editor,this,/^\[\s?\]\s$/,"todoList"),e.get("checkTodoList")&&hv(this.editor,this,/^\[\s?x\s?\]\s$/,(()=>{this.editor.execute("todoList"),this.editor.execute("checkTodoList");}));}_addBasicStylesAutoformats(){const e=this.editor.commands;if(e.get("bold")){const e=fv(this.editor,"bold");uv(this.editor,this,/(?:^|\s)(\*\*)([^*]+)(\*\*)$/g,e),uv(this.editor,this,/(?:^|\s)(__)([^_]+)(__)$/g,e);}if(e.get("italic")){const e=fv(this.editor,"italic");uv(this.editor,this,/(?:^|\s)(\*)([^*_]+)(\*)$/g,e),uv(this.editor,this,/(?:^|\s)(_)([^_]+)(_)$/g,e);}if(e.get("code")){const e=fv(this.editor,"code");uv(this.editor,this,/(`)([^`]+)(`)$/g,e);}if(e.get("strikethrough")){const e=fv(this.editor,"strikethrough");uv(this.editor,this,/(~~)([^~]+)(~~)$/g,e);}}_addHeadingAutoformats(){const e=this.editor.commands.get("heading");e&&e.modelElements.filter((e=>e.match(/^heading[1-6]$/))).forEach((t=>{const i=t[7],n=new RegExp(`^(#{${i}})\\s$`);hv(this.editor,this,n,(()=>{if(!e.isEnabled||e.value===t)return !1;this.editor.execute("heading",{value:t});}));}));}_addBlockQuoteAutoformats(){this.editor.commands.get("blockQuote")&&hv(this.editor,this,/^>\s$/,"blockQuote");}_addCodeBlockAutoformats(){const e=this.editor,t=e.model.document.selection;e.commands.get("codeBlock")&&hv(e,this,/^```$/,(()=>{if(t.getFirstPosition().parent.is("element","listItem"))return !1;this.editor.execute("codeBlock",{usePreviousLanguageChoice:!0});}));}_addHorizontalLineAutoformats(){this.editor.commands.get("horizontalLine")&&hv(this.editor,this,/^---$/,"horizontalLine");}}function fv(e,t){return (i,n)=>{if(!e.commands.get(t).isEnabled)return !1;const s=e.model.schema.getValidRanges(n,t);for(const e of s)i.setAttribute(t,!0,e);i.removeSelectionAttribute(t);}}class pv extends Ga{adapter;_debouncedSave;_lastDocumentVersion;_savePromise;_domEmitter;_config;_pendingActions;_makeImmediateSave;_action=null;static get pluginName(){return "Autosave"}static get requires(){return [Sg]}constructor(e){super(e);const t=e.config.get("autosave")||{},i=t.waitingTime||1e3;this.set("state","synchronized"),this._debouncedSave=Vo(this._save.bind(this),i),this._lastDocumentVersion=e.model.document.version,this._savePromise=null,this._domEmitter=new(Ar()),this._config=t,this._pendingActions=e.plugins.get(Sg),this._makeImmediateSave=!1;}init(){const e=this.editor,t=e.model.document;this.listenTo(e,"ready",(()=>{this.listenTo(t,"change:data",((e,t)=>{this._saveCallbacks.length&&t.isLocal&&("synchronized"===this.state&&(this.state="waiting",this._setPendingAction()),"waiting"===this.state&&this._debouncedSave());}));})),this.listenTo(e,"destroy",(()=>this._flush()),{priority:"highest"}),this._domEmitter.listenTo(window,"beforeunload",((e,t)=>{this._pendingActions.hasAny&&(t.returnValue=this._pendingActions.first.message);}));}destroy(){this._domEmitter.stopListening(),super.destroy();}save(){return this._debouncedSave.cancel(),this._save()}_flush(){this._debouncedSave.flush();}_save(){return this._savePromise?(this._makeImmediateSave=this.editor.model.document.version>this._lastDocumentVersion,this._savePromise):(this._setPendingAction(),this.state="saving",this._lastDocumentVersion=this.editor.model.document.version,this._savePromise=Promise.resolve().then((()=>Promise.all(this._saveCallbacks.map((e=>e(this.editor)))))).finally((()=>{this._savePromise=null;})).then((()=>{if(this._makeImmediateSave)return this._makeImmediateSave=!1,this._save();this.editor.model.document.version>this._lastDocumentVersion?(this.state="waiting",this._debouncedSave()):(this.state="synchronized",this._pendingActions.remove(this._action),this._action=null);})).catch((e=>{throw this.state="error",this.state="saving",this._debouncedSave(),e})),this._savePromise)}_setPendingAction(){const e=this.editor.t;this._action||(this._action=this._pendingActions.add(e("Saving changes")));}get _saveCallbacks(){const e=[];return this.adapter&&this.adapter.save&&e.push(this.adapter.save),this._config.save&&e.push(this._config.save),e}}class bv extends Za{attributeKey;constructor(e,t){super(e),this.attributeKey=t;}refresh(){const e=this.editor.model,t=e.document;this.value=this._getValueFromFirstAllowedNode(),this.isEnabled=e.schema.checkAttributeInSelection(t.selection,this.attributeKey);}execute(e={}){const t=this.editor.model,i=t.document.selection,n=void 0===e.forceValue?!this.value:e.forceValue;t.change((e=>{if(i.isCollapsed)n?e.setSelectionAttribute(this.attributeKey,!0):e.removeSelectionAttribute(this.attributeKey);else {const s=t.schema.getValidRanges(i.getRanges(),this.attributeKey);for(const t of s)n?e.setAttribute(this.attributeKey,n,t):e.removeAttribute(this.attributeKey,t);}}));}_getValueFromFirstAllowedNode(){const e=this.editor.model,t=e.schema,i=e.document.selection;if(i.isCollapsed)return i.hasAttribute(this.attributeKey);for(const e of i.getRanges())for(const i of e.getItems())if(t.checkAttribute(i,this.attributeKey))return i.hasAttribute(this.attributeKey);return !1}}const wv="bold";class _v extends Ga{static get pluginName(){return "BoldEditing"}init(){const e=this.editor,t=this.editor.t;e.model.schema.extend("$text",{allowAttributes:wv}),e.model.schema.setAttributeProperties(wv,{isFormatting:!0,copyOnEnter:!0}),e.conversion.attributeToElement({model:wv,view:"strong",upcastAlso:["b",e=>{const t=e.getStyle("font-weight");return t&&("bold"==t||Number(t)>=600)?{name:!0,styles:["font-weight"]}:null}]}),e.commands.add(wv,new bv(e,wv)),e.keystrokes.set("CTRL+B",wv),e.accessibility.addKeystrokeInfos({keystrokes:[{label:t("Bold text"),keystroke:"CTRL+B"}]});}}function vv({editor:e,commandName:t,plugin:i,icon:n,label:s,keystroke:o}){return r=>{const a=e.commands.get(t),l=new r(e.locale);return l.set({label:s,icon:n,keystroke:o,isToggleable:!0}),l.bind("isEnabled").to(a,"isEnabled"),l.bind("isOn").to(a,"value"),l instanceof $f?l.set({role:"menuitemcheckbox"}):l.set({tooltip:!0}),i.listenTo(l,"execute",(()=>{e.execute(t),e.editing.view.focus();})),l}}const yv="bold";class kv extends Ga{static get pluginName(){return "BoldUI"}init(){const e=this.editor,t=e.locale.t,i=vv({editor:e,commandName:yv,plugin:this,icon:Ig.bold,label:t("Bold"),keystroke:"CTRL+B"});e.ui.componentFactory.add(yv,(()=>i(Ef))),e.ui.componentFactory.add("menuBar:"+yv,(()=>i($f)));}}class Cv extends Ga{static get requires(){return [_v,kv]}static get pluginName(){return "Bold"}}const xv="code";class Av extends Ga{static get pluginName(){return "CodeEditing"}static get requires(){return [G_]}init(){const e=this.editor,t=this.editor.t;e.model.schema.extend("$text",{allowAttributes:xv}),e.model.schema.setAttributeProperties(xv,{isFormatting:!0,copyOnEnter:!1}),e.conversion.attributeToElement({model:xv,view:"code",upcastAlso:{styles:{"word-wrap":"break-word"}}}),e.commands.add(xv,new bv(e,xv)),e.plugins.get(G_).registerAttribute(xv),dv(e,xv,"code","ck-code_selected"),e.accessibility.addKeystrokeInfos({keystrokes:[{label:t("Move out of an inline code style"),keystroke:[["arrowleft","arrowleft"],["arrowright","arrowright"]]}]});}}const Ev="code";class Tv extends Ga{static get pluginName(){return "CodeUI"}init(){const e=this.editor,t=e.locale.t,i=vv({editor:e,commandName:Ev,plugin:this,icon:'<svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="m12.5 5.7 5.2 3.9v1.3l-5.6 4c-.1.2-.3.2-.5.2-.3-.1-.6-.7-.6-1l.3-.4 4.7-3.5L11.5 7l-.2-.2c-.1-.3-.1-.6 0-.8.2-.2.5-.4.8-.4a.8.8 0 0 1 .4.1zm-5.2 0L2 9.6v1.3l5.6 4c.1.2.3.2.5.2.3-.1.7-.7.6-1 0-.1 0-.3-.2-.4l-5-3.5L8.2 7l.2-.2c.1-.3.1-.6 0-.8-.2-.2-.5-.4-.8-.4a.8.8 0 0 0-.3.1z"/></svg>',label:t("Code")});e.ui.componentFactory.add(Ev,(()=>i(Ef))),e.ui.componentFactory.add("menuBar:"+Ev,(()=>i($f)));}}class Sv extends Ga{static get requires(){return [Av,Tv]}static get pluginName(){return "Code"}}const Iv="italic";class Pv extends Ga{static get pluginName(){return "ItalicEditing"}init(){const e=this.editor,t=this.editor.t;e.model.schema.extend("$text",{allowAttributes:Iv}),e.model.schema.setAttributeProperties(Iv,{isFormatting:!0,copyOnEnter:!0}),e.conversion.attributeToElement({model:Iv,view:"i",upcastAlso:["em",{styles:{"font-style":"italic"}}]}),e.commands.add(Iv,new bv(e,Iv)),e.keystrokes.set("CTRL+I",Iv),e.accessibility.addKeystrokeInfos({keystrokes:[{label:t("Italic text"),keystroke:"CTRL+I"}]});}}const Vv="italic";class Rv extends Ga{static get pluginName(){return "ItalicUI"}init(){const e=this.editor,t=e.locale.t,i=vv({editor:e,commandName:Vv,plugin:this,icon:'<svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="m9.586 14.633.021.004c-.036.335.095.655.393.962.082.083.173.15.274.201h1.474a.6.6 0 1 1 0 1.2H5.304a.6.6 0 0 1 0-1.2h1.15c.474-.07.809-.182 1.005-.334.157-.122.291-.32.404-.597l2.416-9.55a1.053 1.053 0 0 0-.281-.823 1.12 1.12 0 0 0-.442-.296H8.15a.6.6 0 0 1 0-1.2h6.443a.6.6 0 1 1 0 1.2h-1.195c-.376.056-.65.155-.823.296-.215.175-.423.439-.623.79l-2.366 9.347z"/></svg>',keystroke:"CTRL+I",label:t("Italic")});e.ui.componentFactory.add(Vv,(()=>i(Ef))),e.ui.componentFactory.add("menuBar:"+Vv,(()=>i($f)));}}class Bv extends Ga{static get requires(){return [Pv,Rv]}static get pluginName(){return "Italic"}}const Ov="strikethrough";class Mv extends Ga{static get pluginName(){return "StrikethroughEditing"}init(){const e=this.editor,t=this.editor.t;e.model.schema.extend("$text",{allowAttributes:Ov}),e.model.schema.setAttributeProperties(Ov,{isFormatting:!0,copyOnEnter:!0}),e.conversion.attributeToElement({model:Ov,view:"s",upcastAlso:["del","strike",{styles:{"text-decoration":"line-through"}}]}),e.commands.add(Ov,new bv(e,Ov)),e.keystrokes.set("CTRL+SHIFT+X","strikethrough"),e.accessibility.addKeystrokeInfos({keystrokes:[{label:t("Strikethrough text"),keystroke:"CTRL+SHIFT+X"}]});}}const Lv="strikethrough";class Fv extends Ga{static get pluginName(){return "StrikethroughUI"}init(){const e=this.editor,t=e.locale.t,i=vv({editor:e,commandName:Lv,plugin:this,icon:'<svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M7 16.4c-.8-.4-1.5-.9-2.2-1.5a.6.6 0 0 1-.2-.5l.3-.6h1c1 1.2 2.1 1.7 3.7 1.7 1 0 1.8-.3 2.3-.6.6-.4.6-1.2.6-1.3.2-1.2-.9-2.1-.9-2.1h2.1c.3.7.4 1.2.4 1.7v.8l-.6 1.2c-.6.8-1.1 1-1.6 1.2a6 6 0 0 1-2.4.6c-1 0-1.8-.3-2.5-.6zM6.8 9 6 8.3c-.4-.5-.5-.8-.5-1.6 0-.7.1-1.3.5-1.8.4-.6 1-1 1.6-1.3a6.3 6.3 0 0 1 4.7 0 4 4 0 0 1 1.7 1l.3.7c0 .1.2.4-.2.7-.4.2-.9.1-1 0a3 3 0 0 0-1.2-1c-.4-.2-1-.3-2-.4-.7 0-1.4.2-2 .6-.8.6-1 .8-1 1.5 0 .8.5 1 1.2 1.5.6.4 1.1.7 1.9 1H6.8z"/><path d="M3 10.5V9h14v1.5z"/></svg>',keystroke:"CTRL+SHIFT+X",label:t("Strikethrough")});e.ui.componentFactory.add(Lv,(()=>i(Ef))),e.ui.componentFactory.add("menuBar:"+Lv,(()=>i($f)));}}class Nv extends Ga{static get requires(){return [Mv,Fv]}static get pluginName(){return "Strikethrough"}}const Zv="underline";class Jv extends Ga{static get pluginName(){return "UnderlineEditing"}init(){const e=this.editor,t=this.editor.t;e.model.schema.extend("$text",{allowAttributes:Zv}),e.model.schema.setAttributeProperties(Zv,{isFormatting:!0,copyOnEnter:!0}),e.conversion.attributeToElement({model:Zv,view:"u",upcastAlso:{styles:{"text-decoration":"underline"}}}),e.commands.add(Zv,new bv(e,Zv)),e.keystrokes.set("CTRL+U","underline"),e.accessibility.addKeystrokeInfos({keystrokes:[{label:t("Underline text"),keystroke:"CTRL+U"}]});}}const Qv="underline";class Yv extends Ga{static get pluginName(){return "UnderlineUI"}init(){const e=this.editor,t=e.locale.t,i=vv({editor:e,commandName:Qv,plugin:this,icon:'<svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M3 18v-1.5h14V18zm2.2-8V3.6c0-.4.4-.6.8-.6.3 0 .7.2.7.6v6.2c0 2 1.3 2.8 3.2 2.8 1.9 0 3.4-.9 3.4-2.9V3.6c0-.3.4-.5.8-.5.3 0 .7.2.7.5V10c0 2.7-2.2 4-4.9 4-2.6 0-4.7-1.2-4.7-4z"/></svg>',label:t("Underline"),keystroke:"CTRL+U"});e.ui.componentFactory.add(Qv,(()=>i(Ef))),e.ui.componentFactory.add("menuBar:"+Qv,(()=>i($f)));}}class Xv extends Ga{static get requires(){return [Jv,Yv]}static get pluginName(){return "Underline"}}function*ey(e,t){for(const i of t)i&&e.getAttributeProperties(i[0]).copyOnEnter&&(yield i);}class ty extends Za{execute(){this.editor.model.change((e=>{this.enterBlock(e),this.fire("afterExecute",{writer:e});}));}enterBlock(e){const t=this.editor.model,i=t.document.selection,n=t.schema,s=i.isCollapsed,o=i.getFirstRange(),r=o.start.parent,a=o.end.parent;if(n.isLimit(r)||n.isLimit(a))return s||r!=a||t.deleteContent(i),!1;if(s){const t=ey(e.model.schema,i.getAttributes());return iy(e,o.start),e.setSelectionAttribute(t),!0}{const n=!(o.start.isAtStart&&o.end.isAtEnd),s=r==a;if(t.deleteContent(i,{leaveUnmerged:n}),n){if(s)return iy(e,i.focus),!0;e.setSelection(a,0);}}return !1}}function iy(e,t){e.split(t),e.setSelection(t.parent.nextSibling,0);}const ny={insertParagraph:{isSoft:!1},insertLineBreak:{isSoft:!0}};class sy extends Oc{constructor(e){super(e);const t=this.document;let i=!1;t.on("keydown",((e,t)=>{i=t.shiftKey;})),t.on("beforeinput",((n,s)=>{if(!this.isEnabled)return;let r=s.inputType;o.isSafari&&i&&"insertParagraph"==r&&(r="insertLineBreak");const a=s.domEvent,l=ny[r];if(!l)return;const c=new Ml(t,"enter",s.targetRanges[0]);t.fire(c,new Mc(e,a,{isSoft:l.isSoft})),c.stop.called&&n.stop();}));}observe(){}stopObserving(){}}class oy extends Ga{static get pluginName(){return "Enter"}init(){const e=this.editor,t=e.editing.view,i=t.document,n=this.editor.t;t.addObserver(sy),e.commands.add("enter",new ty(e)),this.listenTo(i,"enter",((n,s)=>{i.isComposing||s.preventDefault(),s.isSoft||(e.execute("enter"),t.scrollToTheSelection());}),{priority:"low"}),e.accessibility.addKeystrokeInfos({keystrokes:[{label:n("Insert a hard break (a new paragraph)"),keystroke:"Enter"}]});}}class ry extends Za{execute(){const e=this.editor.model,t=e.document;e.change((i=>{!function(e,t,i){const n=i.isCollapsed,s=i.getFirstRange(),o=s.start.parent,r=s.end.parent,a=o==r;if(n){const n=ey(e.schema,i.getAttributes());ay(e,t,s.end),t.removeSelectionAttribute(i.getAttributeKeys()),t.setSelectionAttribute(n);}else {const n=!(s.start.isAtStart&&s.end.isAtEnd);e.deleteContent(i,{leaveUnmerged:n}),a?ay(e,t,i.focus):n&&t.setSelection(r,0);}}(e,i,t.selection),this.fire("afterExecute",{writer:i});}));}refresh(){const e=this.editor.model,t=e.document;this.isEnabled=function(e,t){if(t.rangeCount>1)return !1;const i=t.anchor;if(!i||!e.checkChild(i,"softBreak"))return !1;const n=t.getFirstRange(),s=n.start.parent,o=n.end.parent;if((ly(s,e)||ly(o,e))&&s!==o)return !1;return !0}(e.schema,t.selection);}}function ay(e,t,i){const n=t.createElement("softBreak");e.insertContent(n,i),t.setSelection(n,"after");}function ly(e,t){return !e.is("rootElement")&&(t.isLimit(e)||ly(e.parent,t))}class cy extends Ga{static get pluginName(){return "ShiftEnter"}init(){const e=this.editor,t=e.model.schema,i=e.conversion,n=e.editing.view,s=n.document,o=this.editor.t;t.register("softBreak",{allowWhere:"$text",isInline:!0}),i.for("upcast").elementToElement({model:"softBreak",view:"br"}),i.for("downcast").elementToElement({model:"softBreak",view:(e,{writer:t})=>t.createEmptyElement("br")}),n.addObserver(sy),e.commands.add("shiftEnter",new ry(e)),this.listenTo(s,"enter",((t,i)=>{s.isComposing||i.preventDefault(),i.isSoft&&(e.execute("shiftEnter"),n.scrollToTheSelection());}),{priority:"low"}),e.accessibility.addKeystrokeInfos({keystrokes:[{label:o("Insert a soft break (a <code>&lt;br&gt;</code> element)"),keystroke:"Shift+Enter"}]});}}class dy extends Za{refresh(){this.value=this._getValue(),this.isEnabled=this._checkEnabled();}execute(e={}){const t=this.editor.model,i=t.schema,n=t.document.selection,s=Array.from(n.getSelectedBlocks()),o=void 0===e.forceValue?!this.value:e.forceValue;t.change((e=>{if(o){const t=s.filter((e=>hy(e)||my(i,e)));this._applyQuote(e,t);}else this._removeQuote(e,s.filter(hy));}));}_getValue(){const e=Ia(this.editor.model.document.selection.getSelectedBlocks());return !(!e||!hy(e))}_checkEnabled(){if(this.value)return !0;const e=this.editor.model.document.selection,t=this.editor.model.schema,i=Ia(e.getSelectedBlocks());return !!i&&my(t,i)}_removeQuote(e,t){uy(e,t).reverse().forEach((t=>{if(t.start.isAtStart&&t.end.isAtEnd)return void e.unwrap(t.start.parent);if(t.start.isAtStart){const i=e.createPositionBefore(t.start.parent);return void e.move(t,i)}t.end.isAtEnd||e.split(t.end);const i=e.createPositionAfter(t.end.parent);e.move(t,i);}));}_applyQuote(e,t){const i=[];uy(e,t).reverse().forEach((t=>{let n=hy(t.start);n||(n=e.createElement("blockQuote"),e.wrap(t,n)),i.push(n);})),i.reverse().reduce(((t,i)=>t.nextSibling==i?(e.merge(e.createPositionAfter(t)),t):i));}}function hy(e){return "blockQuote"==e.parent.name?e.parent:null}function uy(e,t){let i,n=0;const s=[];for(;n<t.length;){const o=t[n],r=t[n+1];i||(i=e.createPositionBefore(o)),r&&o.nextSibling==r||(s.push(e.createRange(i,e.createPositionAfter(o))),i=null),n++;}return s}function my(e,t){const i=e.checkChild(t.parent,"blockQuote"),n=e.checkChild(["$root","blockQuote"],t);return i&&n}class gy extends Ga{static get pluginName(){return "BlockQuoteEditing"}static get requires(){return [oy,U_]}init(){const e=this.editor,t=e.model.schema;e.commands.add("blockQuote",new dy(e)),t.register("blockQuote",{inheritAllFrom:"$container"}),e.conversion.elementToElement({model:"blockQuote",view:"blockquote"}),e.model.document.registerPostFixer((i=>{const n=e.model.document.differ.getChanges();for(const e of n)if("insert"==e.type){const n=e.position.nodeAfter;if(!n)continue;if(n.is("element","blockQuote")&&n.isEmpty)return i.remove(n),!0;if(n.is("element","blockQuote")&&!t.checkChild(e.position,n))return i.unwrap(n),!0;if(n.is("element")){const e=i.createRangeIn(n);for(const n of e.getItems())if(n.is("element","blockQuote")&&!t.checkChild(i.createPositionBefore(n),n))return i.unwrap(n),!0}}else if("remove"==e.type){const t=e.position.parent;if(t.is("element","blockQuote")&&t.isEmpty)return i.remove(t),!0}return !1}));const i=this.editor.editing.view.document,n=e.model.document.selection,s=e.commands.get("blockQuote");this.listenTo(i,"enter",((t,i)=>{if(!n.isCollapsed||!s.value)return;n.getLastPosition().parent.isEmpty&&(e.execute("blockQuote"),e.editing.view.scrollToTheSelection(),i.preventDefault(),t.stop());}),{context:"blockquote"}),this.listenTo(i,"delete",((t,i)=>{if("backward"!=i.direction||!n.isCollapsed||!s.value)return;const o=n.getLastPosition().parent;o.isEmpty&&!o.previousSibling&&(e.execute("blockQuote"),e.editing.view.scrollToTheSelection(),i.preventDefault(),t.stop());}),{context:"blockquote"});}}class fy extends Ga{static get pluginName(){return "BlockQuoteUI"}init(){const e=this.editor;e.ui.componentFactory.add("blockQuote",(()=>{const e=this._createButton(Ef);return e.set({tooltip:!0}),e})),e.ui.componentFactory.add("menuBar:blockQuote",(()=>{const e=this._createButton($f);return e.set({role:"menuitemcheckbox"}),e}));}_createButton(e){const t=this.editor,i=t.locale,n=t.commands.get("blockQuote"),s=new e(t.locale),o=i.t;return s.set({label:o("Block quote"),icon:Ig.quote,isToggleable:!0}),s.bind("isEnabled").to(n,"isEnabled"),s.bind("isOn").to(n,"value"),this.listenTo(s,"execute",(()=>{t.execute("blockQuote"),t.editing.view.focus();})),s}}class py extends Ga{static get requires(){return [gy,fy]}static get pluginName(){return "BlockQuote"}}class tk extends Lc{domEventType=["paste","copy","cut","drop","dragover","dragstart","dragend","dragenter","dragleave"];constructor(e){super(e);const t=this.document;function i(e){return (i,n)=>{n.preventDefault();const s=n.dropRange?[n.dropRange]:null,o=new v(t,e);t.fire(o,{dataTransfer:n.dataTransfer,method:i.name,targetRanges:s,target:n.target,domEvent:n.domEvent}),o.stop.called&&n.stopPropagation();}}this.listenTo(t,"paste",i("clipboardInput"),{priority:"low"}),this.listenTo(t,"drop",i("clipboardInput"),{priority:"low"}),this.listenTo(t,"dragover",i("dragging"),{priority:"low"});}onDomEvent(e){const t="clipboardData"in e?e.clipboardData:e.dataTransfer,i="drop"==e.type||"paste"==e.type,n={dataTransfer:new Wc(t,{cacheFiles:i})};if("drop"==e.type||"dragover"==e.type){const t=Rr(e);n.dropRange=t&&this.view.domConverter.domRangeToView(t);}this.fire(e.type,e,n);}}const ik=["figcaption","li"],nk=["ol","ul"];function sk(e){if(e.is("$text")||e.is("$textProxy"))return e.data;if(e.is("element","img")&&e.hasAttribute("alt"))return e.getAttribute("alt");if(e.is("element","br"))return "\n";let t="",i=null;for(const n of e.getChildren())t+=ok(n,i)+sk(n),i=n;return t}function ok(e,t){return t?e.is("element","li")&&!e.isEmpty&&e.getChild(0).is("containerElement")||nk.includes(e.name)&&nk.includes(t.name)?"\n\n":e.is("containerElement")||t.is("containerElement")?ik.includes(e.name)||ik.includes(t.name)?"\n":e.is("element")&&e.getCustomProperty("dataPipeline:transparentRendering")||t.is("element")&&t.getCustomProperty("dataPipeline:transparentRendering")?"":"\n\n":"":""}class rk extends Ga{_markersToCopy=new Map;static get pluginName(){return "ClipboardMarkersUtils"}_registerMarkerToCopy(e,t){this._markersToCopy.set(e,t);}_copySelectedFragmentWithMarkers(e,t,i=e=>e.model.getSelectedContent(e.model.document.selection)){return this.editor.model.change((n=>{const s=n.model.document.selection;n.setSelection(t);const o=this._insertFakeMarkersIntoSelection(n,n.model.document.selection,e),r=i(n),a=this._removeFakeMarkersInsideElement(n,r);for(const[e,t]of Object.entries(o)){a[e]||=n.createRangeIn(r);for(const e of t)n.remove(e);}r.markers.clear();for(const[e,t]of Object.entries(a))r.markers.set(e,t);return n.setSelection(s),r}))}_pasteMarkersIntoTransformedElement(e,t){const i=this._getPasteMarkersFromRangeMap(e);return this.editor.model.change((e=>{const n=this._insertFakeMarkersElements(e,i),s=t(e),o=this._removeFakeMarkersInsideElement(e,s);for(const t of Object.values(n).flat())e.remove(t);for(const[t,i]of Object.entries(o))e.model.markers.has(t)||e.addMarker(t,{usingOperation:!0,affectsData:!0,range:i});return s}))}_pasteFragmentWithMarkers(e){const t=this._getPasteMarkersFromRangeMap(e.markers);e.markers.clear();for(const i of t)e.markers.set(i.name,i.range);return this.editor.model.insertContent(e)}_forceMarkersCopy(e,t,i={allowedActions:"all",copyPartiallySelected:!0,duplicateOnPaste:!0}){const n=this._markersToCopy.get(e);this._markersToCopy.set(e,i),t(),n?this._markersToCopy.set(e,n):this._markersToCopy.delete(e);}_isMarkerCopyable(e,t){const i=this._getMarkerClipboardConfig(e);if(!i)return !1;if(!t)return !0;const{allowedActions:n}=i;return "all"===n||n.includes(t)}_hasMarkerConfiguration(e){return !!this._getMarkerClipboardConfig(e)}_getMarkerClipboardConfig(e){const[t]=e.split(":");return this._markersToCopy.get(t)||null}_insertFakeMarkersIntoSelection(e,t,i){const n=this._getCopyableMarkersFromSelection(e,t,i);return this._insertFakeMarkersElements(e,n)}_getCopyableMarkersFromSelection(e,t,i){const n=Array.from(t.getRanges()),s=new Set(n.flatMap((t=>Array.from(e.model.markers.getMarkersIntersectingRange(t)))));return Array.from(s).filter((e=>{if(!this._isMarkerCopyable(e.name,i))return !1;const{copyPartiallySelected:t}=this._getMarkerClipboardConfig(e.name);if(!t){const t=e.getRange();return n.some((e=>e.containsRange(t,!0)))}return !0})).map((e=>({name:"dragstart"===i?this._getUniqueMarkerName(e.name):e.name,range:e.getRange()})))}_getPasteMarkersFromRangeMap(e,t=null){const{model:i}=this.editor;return (e instanceof Map?Array.from(e.entries()):Object.entries(e)).flatMap((([e,n])=>{if(!this._hasMarkerConfiguration(e))return [{name:e,range:n}];if(this._isMarkerCopyable(e,t)){const t=this._getMarkerClipboardConfig(e),s=i.markers.has(e)&&"$graveyard"===i.markers.get(e).getRange().root.rootName;return (t.duplicateOnPaste||s)&&(e=this._getUniqueMarkerName(e)),[{name:e,range:n}]}return []}))}_insertFakeMarkersElements(e,t){const i={},n=t.flatMap((e=>{const{start:t,end:i}=e.range;return [{position:t,marker:e,type:"start"},{position:i,marker:e,type:"end"}]})).sort((({position:e},{position:t})=>e.isBefore(t)?1:-1));for(const{position:t,marker:s,type:o}of n){const n=e.createElement("$marker",{"data-name":s.name,"data-type":o});i[s.name]||(i[s.name]=[]),i[s.name].push(n),e.insert(n,t);}return i}_removeFakeMarkersInsideElement(e,t){const i=this._getAllFakeMarkersFromElement(e,t).reduce(((t,i)=>{const n=i.markerElement&&e.createPositionBefore(i.markerElement);let s=t[i.name],o=!1;if(s&&s.start&&s.end){this._getMarkerClipboardConfig(i.name).duplicateOnPaste?t[this._getUniqueMarkerName(i.name)]=t[i.name]:o=!0,s=null;}return o||(t[i.name]={...s,[i.type]:n}),i.markerElement&&e.remove(i.markerElement),t}),{});return n=i,o={},s=ko(s=i=>new dd(i.start||e.createPositionFromPath(t,[0]),i.end||e.createPositionAt(t,"end"))),xo(n,(function(e,t,i){Qe(o,t,s(e,t,i));})),o;var n,s,o;}_getAllFakeMarkersFromElement(e,t){const i=Array.from(e.createRangeIn(t)).flatMap((({item:e})=>{if(!e.is("element","$marker"))return [];const t=e.getAttribute("data-name"),i=e.getAttribute("data-type");return [{markerElement:e,name:t,type:i}]})),n=[],s=[];for(const e of i){if("end"===e.type){i.some((t=>t.name===e.name&&"start"===t.type))||n.push({markerElement:null,name:e.name,type:"start"});}if("start"===e.type){i.some((t=>t.name===e.name&&"end"===t.type))||s.unshift({markerElement:null,name:e.name,type:"end"});}}return [...n,...i,...s]}_getUniqueMarkerName(e){const t=e.split(":"),i=k().substring(1,6);return 3===t.length?`${t.slice(0,2).join(":")}:${i}`:`${t.join(":")}:${i}`}}class ak extends Ga{static get pluginName(){return "ClipboardPipeline"}static get requires(){return [rk]}init(){this.editor.editing.view.addObserver(tk),this._setupPasteDrop(),this._setupCopyCut();}_fireOutputTransformationEvent(e,t,i){const n=this.editor.plugins.get("ClipboardMarkersUtils");this.editor.model.enqueueChange({isUndoable:"cut"===i},(()=>{const s=n._copySelectedFragmentWithMarkers(i,t);this.fire("outputTransformation",{dataTransfer:e,content:s,method:i});}));}_setupPasteDrop(){const e=this.editor,t=e.model,i=e.editing.view,n=i.document,s=this.editor.plugins.get("ClipboardMarkersUtils");this.listenTo(n,"clipboardInput",((t,i)=>{"paste"!=i.method||e.model.canEditAt(e.model.document.selection)||t.stop();}),{priority:"highest"}),this.listenTo(n,"clipboardInput",((e,t)=>{const n=t.dataTransfer;let s;if(t.content)s=t.content;else {let e="";n.getData("text/html")?e=function(e){return e.replace(/<span(?: class="Apple-converted-space"|)>(\s+)<\/span>/g,((e,t)=>1==t.length?" ":t)).replace(/<!--[\s\S]*?-->/g,"")}(n.getData("text/html")):n.getData("text/plain")&&(e=function(e){return ((e=e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\r?\n\r?\n/g,"</p><p>").replace(/\r?\n/g,"<br>").replace(/\t/g,"&nbsp;&nbsp;&nbsp;&nbsp;").replace(/^\s/,"&nbsp;").replace(/\s$/,"&nbsp;").replace(/\s\s/g," &nbsp;")).includes("</p><p>")||e.includes("<br>"))&&(e=`<p>${e}</p>`),e}(n.getData("text/plain"))),s=this.editor.data.htmlProcessor.toView(e);}const o=new v(this,"inputTransformation");this.fire(o,{content:s,dataTransfer:n,targetRanges:t.targetRanges,method:t.method}),o.stop.called&&e.stop(),i.scrollToTheSelection();}),{priority:"low"}),this.listenTo(this,"inputTransformation",((e,i)=>{if(i.content.isEmpty)return;const n=this.editor.data.toModel(i.content,"$clipboardHolder");0!=n.childCount&&(e.stop(),t.change((()=>{this.fire("contentInsertion",{content:n,method:i.method,dataTransfer:i.dataTransfer,targetRanges:i.targetRanges});})));}),{priority:"low"}),this.listenTo(this,"contentInsertion",((e,t)=>{t.resultRange=s._pasteFragmentWithMarkers(t.content);}),{priority:"low"});}_setupCopyCut(){const e=this.editor,t=e.model.document,i=e.editing.view.document,n=(e,i)=>{const n=i.dataTransfer;i.preventDefault(),this._fireOutputTransformationEvent(n,t.selection,e.name);};this.listenTo(i,"copy",n,{priority:"low"}),this.listenTo(i,"cut",((t,i)=>{e.model.canEditAt(e.model.document.selection)?n(t,i):i.preventDefault();}),{priority:"low"}),this.listenTo(this,"outputTransformation",((t,n)=>{const s=e.data.toView(n.content);i.fire("clipboardOutput",{dataTransfer:n.dataTransfer,content:s,method:n.method});}),{priority:"low"}),this.listenTo(i,"clipboardOutput",((i,n)=>{n.content.isEmpty||(n.dataTransfer.setData("text/html",this.editor.data.htmlProcessor.toData(n.content)),n.dataTransfer.setData("text/plain",sk(n.content))),"cut"==n.method&&e.model.deleteContent(t.selection);}),{priority:"low"});}}class lk extends(F()){_stack=[];add(e,t){const i=this._stack,n=i[0];this._insertDescriptor(e);const s=i[0];n===s||ck(n,s)||this.fire("change:top",{oldDescriptor:n,newDescriptor:s,writer:t});}remove(e,t){const i=this._stack,n=i[0];this._removeDescriptor(e);const s=i[0];n===s||ck(n,s)||this.fire("change:top",{oldDescriptor:n,newDescriptor:s,writer:t});}_insertDescriptor(e){const t=this._stack,i=t.findIndex((t=>t.id===e.id));if(ck(e,t[i]))return;i>-1&&t.splice(i,1);let n=0;for(;t[n]&&dk(t[n],e);)n++;t.splice(n,0,e);}_removeDescriptor(e){const t=this._stack,i=t.findIndex((t=>t.id===e));i>-1&&t.splice(i,1);}}function ck(e,t){return e&&t&&e.priority==t.priority&&hk(e.classes)==hk(t.classes)}function dk(e,t){return e.priority>t.priority||!(e.priority<t.priority)&&hk(e.classes)>hk(t.classes)}function hk(e){return Array.isArray(e)?e.sort().join(","):e}var uk='<svg viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg"><path d="M4 0v1H1v3H0V.5A.5.5 0 0 1 .5 0H4zm8 0h3.5a.5.5 0 0 1 .5.5V4h-1V1h-3V0zM4 16H.5a.5.5 0 0 1-.5-.5V12h1v3h3v1zm8 0v-1h3v-3h1v3.5a.5.5 0 0 1-.5.5H12z"/><path fill-opacity=".256" d="M1 1h14v14H1z"/><g class="ck-icon__selected-indicator"><path d="M7 0h2v1H7V0zM0 7h1v2H0V7zm15 0h1v2h-1V7zm-8 8h2v1H7v-1z"/><path fill-opacity=".254" d="M1 1h14v14H1z"/></g></svg>';const mk="ck-widget",gk="ck-widget_selected";function fk(e){return !!e.is("element")&&!!e.getCustomProperty("widget")}function pk(e,t,i={}){if(!e.is("containerElement"))throw new E("widget-to-widget-wrong-element-type",null,{element:e});return t.setAttribute("contenteditable","false",e),t.addClass(mk,e),t.setCustomProperty("widget",!0,e),e.getFillerOffset=Ak,t.setCustomProperty("widgetLabel",[],e),i.label&&vk(e,i.label),i.hasSelectionHandle&&function(e,t){const i=t.createUIElement("div",{class:"ck ck-widget__selection-handle"},(function(e){const t=this.toDomElement(e),i=new xf;return i.set("content",uk),i.render(),t.appendChild(i.element),t}));t.insert(t.createPositionAt(e,0),i),t.addClass(["ck-widget_with-selection-handle"],e);}(e,t),_k(e,t),e}function bk(e,t,i){if(t.classes&&i.addClass(Aa(t.classes),e),t.attributes)for(const n in t.attributes)i.setAttribute(n,t.attributes[n],e);}function wk(e,t,i){if(t.classes&&i.removeClass(Aa(t.classes),e),t.attributes)for(const n in t.attributes)i.removeAttribute(n,e);}function _k(e,t,i=bk,n=wk){const s=new lk;s.on("change:top",((t,s)=>{s.oldDescriptor&&n(e,s.oldDescriptor,s.writer),s.newDescriptor&&i(e,s.newDescriptor,s.writer);}));t.setCustomProperty("addHighlight",((e,t,i)=>s.add(t,i)),e),t.setCustomProperty("removeHighlight",((e,t,i)=>s.remove(t,i)),e);}function vk(e,t){e.getCustomProperty("widgetLabel").push(t);}function yk(e){return e.getCustomProperty("widgetLabel").reduce(((e,t)=>"function"==typeof t?e?e+". "+t():t():e?e+". "+t:t),"")}function kk(e,t,i={}){return t.addClass(["ck-editor__editable","ck-editor__nested-editable"],e),t.setAttribute("role","textbox",e),t.setAttribute("tabindex","-1",e),i.label&&t.setAttribute("aria-label",i.label,e),t.setAttribute("contenteditable",e.isReadOnly?"false":"true",e),e.on("change:isReadOnly",((i,n,s)=>{t.setAttribute("contenteditable",s?"false":"true",e);})),e.on("change:isFocused",((i,n,s)=>{s?t.addClass("ck-editor__nested-editable_focused",e):t.removeClass("ck-editor__nested-editable_focused",e);})),_k(e,t),e}function Ck(e,t){const i=e.getSelectedElement();if(i){const n=Pk(e);if(n)return t.createRange(t.createPositionAt(i,n))}return t.schema.findOptimalInsertionRange(e)}function Ak(){return null}function Ek(e){const t=e=>{const{width:t,paddingLeft:i,paddingRight:n}=e.ownerDocument.defaultView.getComputedStyle(e);return parseFloat(t)-(parseFloat(i)||0)-(parseFloat(n)||0)},i=e.parentElement;if(!i)return 0;let n=t(i);let s=0,o=i;for(;isNaN(n);){if(o=o.parentElement,++s>5)return 0;n=t(o);}return n}function Tk(e,t=new Fr(e)){const i=Ek(e);return i?t.width/i*100:0}const Sk="widget-type-around";function Ik(e,t,i){return !!e&&fk(e)&&!i.isInline(t)}function Pk(e){return e.getAttribute(Sk)}const Vk=["before","after"],Rk=(new DOMParser).parseFromString('<svg viewBox="0 0 10 8" xmlns="http://www.w3.org/2000/svg"><path d="M9.055.263v3.972h-6.77M1 4.216l2-2.038m-2 2 2 2.038"/></svg>',"image/svg+xml").firstChild,Bk="ck-widget__type-around_disabled";class Ok extends Ga{_currentFakeCaretModelElement=null;static get pluginName(){return "WidgetTypeAround"}static get requires(){return [oy,U_]}init(){const e=this.editor,t=e.editing.view;this.on("change:isEnabled",((i,n,s)=>{t.change((e=>{for(const i of t.document.roots)s?e.removeClass(Bk,i):e.addClass(Bk,i);})),s||e.model.change((e=>{e.removeSelectionAttribute(Sk);}));})),this._enableTypeAroundUIInjection(),this._enableInsertingParagraphsOnButtonClick(),this._enableInsertingParagraphsOnEnterKeypress(),this._enableInsertingParagraphsOnTypingKeystroke(),this._enableTypeAroundFakeCaretActivationUsingKeyboardArrows(),this._enableDeleteIntegration(),this._enableInsertContentIntegration(),this._enableInsertObjectIntegration(),this._enableDeleteContentIntegration();}destroy(){super.destroy(),this._currentFakeCaretModelElement=null;}_insertParagraph(e,t){const i=this.editor,n=i.editing.view,s=i.model.schema.getAttributesWithProperty(e,"copyOnReplace",!0);i.execute("insertParagraph",{position:i.model.createPositionAt(e,t),attributes:s}),n.focus(),n.scrollToTheSelection();}_listenToIfEnabled(e,t,i,n){this.listenTo(e,t,((...e)=>{this.isEnabled&&i(...e);}),n);}_insertParagraphAccordingToFakeCaretPosition(){const e=this.editor.model.document.selection,t=Pk(e);if(!t)return !1;const i=e.getSelectedElement();return this._insertParagraph(i,t),!0}_enableTypeAroundUIInjection(){const e=this.editor,t=e.model.schema,i=e.locale.t,n={before:i("Insert paragraph before block"),after:i("Insert paragraph after block")};e.editing.downcastDispatcher.on("insert",((e,s,o)=>{const r=o.mapper.toViewElement(s.item);if(r&&Ik(r,s.item,t)){!function(e,t,i){const n=e.createUIElement("div",{class:"ck ck-reset_all ck-widget__type-around"},(function(e){const i=this.toDomElement(e);return function(e,t){for(const i of Vk){const n=new Jg({tag:"div",attributes:{class:["ck","ck-widget__type-around__button",`ck-widget__type-around__button_${i}`],title:t[i],"aria-hidden":"true"},children:[e.ownerDocument.importNode(Rk,!0)]});e.appendChild(n.render());}}(i,t),function(e){const t=new Jg({tag:"div",attributes:{class:["ck","ck-widget__type-around__fake-caret"]}});e.appendChild(t.render());}(i),i}));e.insert(e.createPositionAt(i,"end"),n);}(o.writer,n,r);r.getCustomProperty("widgetLabel").push((()=>this.isEnabled?i("Press Enter to type after or press Shift + Enter to type before the widget"):""));}}),{priority:"low"});}_enableTypeAroundFakeCaretActivationUsingKeyboardArrows(){const e=this.editor,t=e.model,i=t.document.selection,n=t.schema,s=e.editing.view;function o(e){return `ck-widget_type-around_show-fake-caret_${e}`}this._listenToIfEnabled(s.document,"arrowKey",((e,t)=>{this._handleArrowKeyPress(e,t);}),{context:[fk,"$text"],priority:"high"}),this._listenToIfEnabled(i,"change:range",((t,i)=>{i.directChange&&e.model.change((e=>{e.removeSelectionAttribute(Sk);}));})),this._listenToIfEnabled(t.document,"change:data",(()=>{const t=i.getSelectedElement();if(t){if(Ik(e.editing.mapper.toViewElement(t),t,n))return}e.model.change((e=>{e.removeSelectionAttribute(Sk);}));})),this._listenToIfEnabled(e.editing.downcastDispatcher,"selection",((e,t,i)=>{const s=i.writer;if(this._currentFakeCaretModelElement){const e=i.mapper.toViewElement(this._currentFakeCaretModelElement);e&&(s.removeClass(Vk.map(o),e),this._currentFakeCaretModelElement=null);}const r=t.selection.getSelectedElement();if(!r)return;const a=i.mapper.toViewElement(r);if(!Ik(a,r,n))return;const l=Pk(t.selection);l&&(s.addClass(o(l),a),this._currentFakeCaretModelElement=r);})),this._listenToIfEnabled(e.ui.focusTracker,"change:isFocused",((t,i,n)=>{n||e.model.change((e=>{e.removeSelectionAttribute(Sk);}));}));}_handleArrowKeyPress(e,t){const i=this.editor,n=i.model,s=n.document.selection,o=n.schema,r=i.editing.view,a=ya(t.keyCode,i.locale.contentLanguageDirection),l=r.document.selection.getSelectedElement();let c;Ik(l,i.editing.mapper.toModelElement(l),o)?c=this._handleArrowKeyPressOnSelectedWidget(a):s.isCollapsed?c=this._handleArrowKeyPressWhenSelectionNextToAWidget(a):t.shiftKey||(c=this._handleArrowKeyPressWhenNonCollapsedSelection(a)),c&&(t.preventDefault(),e.stop());}_handleArrowKeyPressOnSelectedWidget(e){const t=this.editor.model,i=Pk(t.document.selection);return t.change((t=>{if(!i)return t.setSelectionAttribute(Sk,e?"after":"before"),!0;if(!(i===(e?"after":"before")))return t.removeSelectionAttribute(Sk),!0;return !1}))}_handleArrowKeyPressWhenSelectionNextToAWidget(e){const t=this.editor,i=t.model,n=i.schema,s=t.plugins.get("Widget"),o=s._getObjectElementNextToSelection(e);return !!Ik(t.editing.mapper.toViewElement(o),o,n)&&(i.change((t=>{s._setSelectionOverElement(o),t.setSelectionAttribute(Sk,e?"before":"after");})),!0)}_handleArrowKeyPressWhenNonCollapsedSelection(e){const t=this.editor,i=t.model,n=i.schema,s=t.editing.mapper,o=i.document.selection,r=e?o.getLastPosition().nodeBefore:o.getFirstPosition().nodeAfter;return !!Ik(s.toViewElement(r),r,n)&&(i.change((t=>{t.setSelection(r,"on"),t.setSelectionAttribute(Sk,e?"after":"before");})),!0)}_enableInsertingParagraphsOnButtonClick(){const e=this.editor,t=e.editing.view;this._listenToIfEnabled(t.document,"mousedown",((i,n)=>{const s=n.domTarget.closest(".ck-widget__type-around__button");if(!s)return;const o=function(e){return e.classList.contains("ck-widget__type-around__button_before")?"before":"after"}(s),r=function(e,t){const i=e.closest(".ck-widget");return t.mapDomToView(i)}(s,t.domConverter),a=e.editing.mapper.toModelElement(r);this._insertParagraph(a,o),n.preventDefault(),i.stop();}));}_enableInsertingParagraphsOnEnterKeypress(){const e=this.editor,t=e.model.document.selection,i=e.editing.view;this._listenToIfEnabled(i.document,"enter",((i,n)=>{if("atTarget"!=i.eventPhase)return;const s=t.getSelectedElement(),o=e.editing.mapper.toViewElement(s),r=e.model.schema;let a;this._insertParagraphAccordingToFakeCaretPosition()?a=!0:Ik(o,s,r)&&(this._insertParagraph(s,n.isSoft?"before":"after"),a=!0),a&&(n.preventDefault(),i.stop());}),{context:fk});}_enableInsertingParagraphsOnTypingKeystroke(){const e=this.editor.editing.view.document;this._listenToIfEnabled(e,"insertText",((t,i)=>{this._insertParagraphAccordingToFakeCaretPosition()&&(i.selection=e.selection);}),{priority:"high"}),o.isAndroid?this._listenToIfEnabled(e,"keydown",((e,t)=>{229==t.keyCode&&this._insertParagraphAccordingToFakeCaretPosition();})):this._listenToIfEnabled(e,"compositionstart",(()=>{this._insertParagraphAccordingToFakeCaretPosition();}),{priority:"high"});}_enableDeleteIntegration(){const e=this.editor,t=e.editing.view,i=e.model,n=i.schema;this._listenToIfEnabled(t.document,"delete",((t,s)=>{if("atTarget"!=t.eventPhase)return;const o=Pk(i.document.selection);if(!o)return;const r=s.direction,a=i.document.selection.getSelectedElement(),l="forward"==r;if("before"===o===l)e.execute("delete",{selection:i.createSelection(a,"on")});else {const t=n.getNearestSelectionRange(i.createPositionAt(a,o),r);if(t)if(t.isCollapsed){const s=i.createSelection(t.start);if(i.modifySelection(s,{direction:r}),s.focus.isEqual(t.start)){const e=function(e,t){let i=t;for(const n of t.getAncestors({parentFirst:!0})){if(n.childCount>1||e.isLimit(n))break;i=n;}return i}(n,t.start.parent);i.deleteContent(i.createSelection(e,"on"),{doNotAutoparagraph:!0});}else i.change((i=>{i.setSelection(t),e.execute(l?"deleteForward":"delete");}));}else i.change((i=>{i.setSelection(t),e.execute(l?"deleteForward":"delete");}));}s.preventDefault(),t.stop();}),{context:fk});}_enableInsertContentIntegration(){const e=this.editor,t=this.editor.model,i=t.document.selection;this._listenToIfEnabled(e.model,"insertContent",((e,[n,s])=>{if(s&&!s.is("documentSelection"))return;const o=Pk(i);return o?(e.stop(),t.change((e=>{const s=i.getSelectedElement(),r=t.createPositionAt(s,o),a=e.createSelection(r),l=t.insertContent(n,a);return e.setSelection(a),l}))):void 0}),{priority:"high"});}_enableInsertObjectIntegration(){const e=this.editor,t=this.editor.model.document.selection;this._listenToIfEnabled(e.model,"insertObject",((e,i)=>{const[,n,s={}]=i;if(n&&!n.is("documentSelection"))return;const o=Pk(t);o&&(s.findOptimalPosition=o,i[3]=s);}),{priority:"high"});}_enableDeleteContentIntegration(){const e=this.editor,t=this.editor.model.document.selection;this._listenToIfEnabled(e.model,"deleteContent",((e,[i])=>{if(i&&!i.is("documentSelection"))return;Pk(t)&&e.stop();}),{priority:"high"});}}function Mk(e){const t=e.model;return (i,n)=>{const s=n.keyCode==ga.arrowup,o=n.keyCode==ga.arrowdown,r=n.shiftKey,a=t.document.selection;if(!s&&!o)return;const l=o;if(r&&function(e,t){return !e.isCollapsed&&e.isBackward==t}(a,l))return;const c=function(e,t,i){const n=e.model;if(i){const e=t.isCollapsed?t.focus:t.getLastPosition(),i=Lk(n,e,"forward");if(!i)return null;const s=n.createRange(e,i),o=Fk(n.schema,s,"backward");return o?n.createRange(e,o):null}{const e=t.isCollapsed?t.focus:t.getFirstPosition(),i=Lk(n,e,"backward");if(!i)return null;const s=n.createRange(i,e),o=Fk(n.schema,s,"forward");return o?n.createRange(o,e):null}}(e,a,l);if(c){if(c.isCollapsed){if(a.isCollapsed)return;if(r)return}(c.isCollapsed||function(e,t,i){const n=e.model,s=e.view.domConverter;if(i){const e=n.createSelection(t.start);n.modifySelection(e),e.focus.isAtEnd||t.start.isEqual(e.focus)||(t=n.createRange(e.focus,t.end));}const o=e.mapper.toViewRange(t),r=s.viewRangeToDom(o),a=Fr.getDomRangeRects(r);let l;for(const e of a)if(void 0!==l){if(Math.round(e.top)>=l)return !1;l=Math.max(l,Math.round(e.bottom));}else l=Math.round(e.bottom);return !0}(e,c,l))&&(t.change((e=>{const i=l?c.end:c.start;if(r){const n=t.createSelection(a.anchor);n.setFocus(i),e.setSelection(n);}else e.setSelection(i);})),i.stop(),n.preventDefault(),n.stopPropagation());}}}function Lk(e,t,i){const n=e.schema,s=e.createRangeIn(t.root),o="forward"==i?"elementStart":"elementEnd";for(const{previousPosition:e,item:r,type:a}of s.getWalker({startPosition:t,direction:i})){if(n.isLimit(r)&&!n.isInline(r))return e;if(a==o&&n.isBlock(r))return null}return null}function Fk(e,t,i){const n="backward"==i?t.end:t.start;if(e.checkChild(n,"$text"))return n;for(const{nextPosition:n}of t.getWalker({direction:i}))if(e.checkChild(n,"$text"))return n;return null}class Nk extends Ga{_previouslySelected=new Set;static get pluginName(){return "Widget"}static get requires(){return [Ok,U_]}init(){const e=this.editor,t=e.editing.view,i=t.document,n=e.t;this.editor.editing.downcastDispatcher.on("selection",((t,i,n)=>{const s=n.writer,o=i.selection;if(o.isCollapsed)return;const r=o.getSelectedElement();if(!r)return;const a=e.editing.mapper.toViewElement(r);fk(a)&&n.consumable.consume(o,"selection")&&s.setSelection(s.createRangeOn(a),{fake:!0,label:yk(a)});})),this.editor.editing.downcastDispatcher.on("selection",((e,t,i)=>{this._clearPreviouslySelectedWidgets(i.writer);const n=i.writer,s=n.document.selection;let o=null;for(const e of s.getRanges())for(const t of e){const e=t.item;fk(e)&&!Dk(e,o)&&(n.addClass(gk,e),this._previouslySelected.add(e),o=e);}}),{priority:"low"}),t.addObserver(Xu),this.listenTo(i,"mousedown",((...e)=>this._onMousedown(...e))),this.listenTo(i,"arrowKey",((...e)=>{this._handleSelectionChangeOnArrowKeyPress(...e);}),{context:[fk,"$text"]}),this.listenTo(i,"arrowKey",((...e)=>{this._preventDefaultOnArrowKeyPress(...e);}),{context:"$root"}),this.listenTo(i,"arrowKey",Mk(this.editor.editing),{context:"$text"}),this.listenTo(i,"delete",((e,t)=>{this._handleDelete("forward"==t.direction)&&(t.preventDefault(),e.stop());}),{context:"$root"}),this.listenTo(i,"tab",((e,t)=>{"atTarget"==e.eventPhase&&(t.shiftKey||this._selectFirstNestedEditable()&&(t.preventDefault(),e.stop()));}),{context:fk,priority:"low"}),this.listenTo(i,"tab",((e,t)=>{t.shiftKey&&this._selectAncestorWidget()&&(t.preventDefault(),e.stop());}),{priority:"low"}),this.listenTo(i,"keydown",((e,t)=>{t.keystroke==ga.esc&&this._selectAncestorWidget()&&(t.preventDefault(),e.stop());}),{priority:"low"}),e.accessibility.addKeystrokeInfoGroup({id:"widget",label:n("Keystrokes that can be used when a widget is selected (for example: image, table, etc.)"),keystrokes:[{label:n("Move focus from an editable area back to the parent widget"),keystroke:"Esc"},{label:n("Insert a new paragraph directly after a widget"),keystroke:"Enter"},{label:n("Insert a new paragraph directly before a widget"),keystroke:"Shift+Enter"},{label:n("Move the caret to allow typing directly before a widget"),keystroke:[["arrowup"],["arrowleft"]]},{label:n("Move the caret to allow typing directly after a widget"),keystroke:[["arrowdown"],["arrowright"]]}]});}_onMousedown(e,t){const i=this.editor,n=i.editing.view,s=n.document;let r=t.target;if(!r)return;if(t.domEvent.detail>=3)return void(this._selectBlockContent(r)&&t.preventDefault());if(!fk(r)){const e=function(e){let t=e;for(;t;){if(t.is("editableElement")||fk(t))return t;t=t.parent;}return null}(r);if(!e)return;if(fk(e))r=e;else {const e=function(e,t){const i=Rr(t.domEvent);let n=null;n=i?e.domConverter.domRangeToView(i):e.createRange(e.createPositionAt(t.target,0));if(!n)return null;const s=n.start;if(!s.parent)return null;let o=s.parent;s.parent.is("editableElement")&&(s.isAtEnd&&s.nodeBefore?o=s.nodeBefore:s.isAtStart&&s.nodeAfter&&(o=s.nodeAfter));if(o.is("$text"))return o.parent;return o}(n,t);if(!e||!fk(e))return;r=e;}}o.isAndroid&&t.preventDefault(),s.isFocused||n.focus();const a=i.editing.mapper.toModelElement(r);this._setSelectionOverElement(a);}_selectBlockContent(e){const t=this.editor,i=t.model,n=t.editing.mapper,s=i.schema,o=n.findMappedViewAncestor(this.editor.editing.view.createPositionAt(e,0)),r=function(e,t){for(const i of e.getAncestors({includeSelf:!0,parentFirst:!0})){if(t.checkChild(i,"$text"))return i;if(t.isLimit(i)&&!t.isObject(i))break}return null}(n.toModelElement(o),i.schema);return !!r&&(i.change((e=>{const t=s.isLimit(r)?null:function(e,t){const i=new id({startPosition:e});for(const{item:e}of i){if(t.isLimit(e)||!e.is("element"))return null;if(t.checkChild(e,"$text"))return e}return null}(e.createPositionAfter(r),s),i=e.createPositionAt(r,0),n=t?e.createPositionAt(t,0):e.createPositionAt(r,"end");e.setSelection(e.createRange(i,n));})),!0)}_handleSelectionChangeOnArrowKeyPress(e,t){const i=t.keyCode,n=this.editor.model,s=n.schema,o=n.document.selection,r=o.getSelectedElement(),a=va(i,this.editor.locale.contentLanguageDirection),l="down"==a||"right"==a,c="up"==a||"down"==a;if(r&&s.isObject(r)){const i=l?o.getLastPosition():o.getFirstPosition(),r=s.getNearestSelectionRange(i,l?"forward":"backward");return void(r&&(n.change((e=>{e.setSelection(r);})),t.preventDefault(),e.stop()))}if(!o.isCollapsed&&!t.shiftKey){const i=o.getFirstPosition(),r=o.getLastPosition(),a=i.nodeAfter,c=r.nodeBefore;return void((a&&s.isObject(a)||c&&s.isObject(c))&&(n.change((e=>{e.setSelection(l?r:i);})),t.preventDefault(),e.stop()))}if(!o.isCollapsed)return;const d=this._getObjectElementNextToSelection(l);if(d&&s.isObject(d)){if(s.isInline(d)&&c)return;this._setSelectionOverElement(d),t.preventDefault(),e.stop();}}_preventDefaultOnArrowKeyPress(e,t){const i=this.editor.model,n=i.schema,s=i.document.selection.getSelectedElement();s&&n.isObject(s)&&(t.preventDefault(),e.stop());}_handleDelete(e){const t=this.editor.model.document.selection;if(!this.editor.model.canEditAt(t))return;if(!t.isCollapsed)return;const i=this._getObjectElementNextToSelection(e);return i?(this.editor.model.change((e=>{let n=t.anchor.parent;for(;n.isEmpty;){const t=n;n=t.parent,e.remove(t);}this._setSelectionOverElement(i);})),!0):void 0}_setSelectionOverElement(e){this.editor.model.change((t=>{t.setSelection(t.createRangeOn(e));}));}_getObjectElementNextToSelection(e){const t=this.editor.model,i=t.schema,n=t.document.selection,s=t.createSelection(n);if(t.modifySelection(s,{direction:e?"forward":"backward"}),s.isEqual(n))return null;const o=e?s.focus.nodeBefore:s.focus.nodeAfter;return o&&i.isObject(o)?o:null}_clearPreviouslySelectedWidgets(e){for(const t of this._previouslySelected)e.removeClass(gk,t);this._previouslySelected.clear();}_selectFirstNestedEditable(){const e=this.editor,t=this.editor.editing.view.document;for(const i of t.selection.getFirstRange().getItems())if(i.is("editableElement")){const t=e.editing.mapper.toModelElement(i);if(!t)continue;const n=e.model.createPositionAt(t,0),s=e.model.schema.getNearestSelectionRange(n,"forward");return e.model.change((e=>{e.setSelection(s);})),!0}return !1}_selectAncestorWidget(){const e=this.editor,t=e.editing.mapper,i=e.editing.view.document.selection.getFirstPosition().parent,n=(i.is("$text")?i.parent:i).findAncestor(fk);if(!n)return !1;const s=t.toModelElement(n);return !!s&&(e.model.change((e=>{e.setSelection(s,"on");})),!0)}}function Dk(e,t){return !!t&&Array.from(e.getAncestors()).includes(t)}class zk extends Ga{_toolbarDefinitions=new Map;_balloon;static get requires(){return [Jw]}static get pluginName(){return "WidgetToolbarRepository"}init(){const e=this.editor;if(e.plugins.has("BalloonToolbar")){const t=e.plugins.get("BalloonToolbar");this.listenTo(t,"show",(t=>{(function(e){const t=e.getSelectedElement();return !(!t||!fk(t))})(e.editing.view.document.selection)&&t.stop();}),{priority:"high"});}this._balloon=this.editor.plugins.get("ContextualBalloon"),this.on("change:isEnabled",(()=>{this._updateToolbarsVisibility();})),this.listenTo(e.ui,"update",(()=>{this._updateToolbarsVisibility();})),this.listenTo(e.ui.focusTracker,"change:isFocused",(()=>{this._updateToolbarsVisibility();}),{priority:"low"});}destroy(){super.destroy();for(const e of this._toolbarDefinitions.values())e.view.destroy();}register(e,{ariaLabel:t,items:i,getRelatedElement:n,balloonClassName:s="ck-toolbar-container"}){if(!i.length)return void T("widget-toolbar-no-items",{toolbarId:e});const o=this.editor,r=o.t,a=new nb(o.locale);if(a.ariaLabel=t||r("Widget toolbar"),this._toolbarDefinitions.has(e))throw new E("widget-toolbar-duplicated",this,{toolbarId:e});const l={view:a,getRelatedElement:n,balloonClassName:s,itemsConfig:i,initialized:!1};o.ui.addToolbar(a,{isContextual:!0,beforeFocus:()=>{const e=n(o.editing.view.document.selection);e&&this._showToolbar(l,e);},afterBlur:()=>{this._hideToolbar(l);}}),this._toolbarDefinitions.set(e,l);}_updateToolbarsVisibility(){let e=0,t=null,i=null;for(const n of this._toolbarDefinitions.values()){const s=n.getRelatedElement(this.editor.editing.view.document.selection);if(this.isEnabled&&s)if(this.editor.ui.focusTracker.isFocused){const o=s.getAncestors().length;o>e&&(e=o,t=s,i=n);}else this._isToolbarVisible(n)&&this._hideToolbar(n);else this._isToolbarInBalloon(n)&&this._hideToolbar(n);}i&&this._showToolbar(i,t);}_hideToolbar(e){this._balloon.remove(e.view),this.stopListening(this._balloon,"change:visibleView");}_showToolbar(e,t){this._isToolbarVisible(e)?Hk(this.editor,t):this._isToolbarInBalloon(e)||(e.initialized||(e.initialized=!0,e.view.fillFromConfig(e.itemsConfig,this.editor.ui.componentFactory)),this._balloon.add({view:e.view,position:$k(this.editor,t),balloonClassName:e.balloonClassName}),this.listenTo(this._balloon,"change:visibleView",(()=>{for(const e of this._toolbarDefinitions.values())if(this._isToolbarVisible(e)){const t=e.getRelatedElement(this.editor.editing.view.document.selection);Hk(this.editor,t);}})));}_isToolbarVisible(e){return this._balloon.visibleView===e.view}_isToolbarInBalloon(e){return this._balloon.hasView(e.view)}}function Hk(e,t){const i=e.plugins.get("ContextualBalloon"),n=$k(e,t);i.updatePosition(n);}function $k(e,t){const i=e.editing.view,n=Kp.defaultPositions;return {target:i.domConverter.mapViewToDom(t),positions:[n.northArrowSouth,n.northArrowSouthWest,n.northArrowSouthEast,n.southArrowNorth,n.southArrowNorthWest,n.southArrowNorthEast,n.viewportStickyNorth]}}class Uk extends(ar()){_referenceCoordinates;_options;_originalWidth;_originalHeight;_originalWidthPercents;_aspectRatio;constructor(e){super(),this.set("activeHandlePosition",null),this.set("proposedWidthPercents",null),this.set("proposedWidth",null),this.set("proposedHeight",null),this.set("proposedHandleHostWidth",null),this.set("proposedHandleHostHeight",null),this._options=e,this._referenceCoordinates=null;}get originalWidth(){return this._originalWidth}get originalHeight(){return this._originalHeight}get originalWidthPercents(){return this._originalWidthPercents}get aspectRatio(){return this._aspectRatio}begin(e,t,i){const n=new Fr(t);this.activeHandlePosition=function(e){const t=["top-left","top-right","bottom-right","bottom-left"];for(const i of t)if(e.classList.contains(Wk(i)))return i}(e),this._referenceCoordinates=function(e,t){const i=new Fr(e),n=t.split("-"),s={x:"right"==n[1]?i.right:i.left,y:"bottom"==n[0]?i.bottom:i.top};return s.x+=e.ownerDocument.defaultView.scrollX,s.y+=e.ownerDocument.defaultView.scrollY,s}(t,function(e){const t=e.split("-"),i={top:"bottom",bottom:"top",left:"right",right:"left"};return `${i[t[0]]}-${i[t[1]]}`}(this.activeHandlePosition)),this._originalWidth=n.width,this._originalHeight=n.height,this._aspectRatio=n.width/n.height;const s=i.style.width;s&&s.match(/^\d+(\.\d*)?%$/)?this._originalWidthPercents=parseFloat(s):this._originalWidthPercents=Tk(i,n);}update(e){this.proposedWidth=e.width,this.proposedHeight=e.height,this.proposedWidthPercents=e.widthPercents,this.proposedHandleHostWidth=e.handleHostWidth,this.proposedHandleHostHeight=e.handleHostHeight;}}function Wk(e){return `ck-widget__resizer__handle-${e}`}class jk extends wf{constructor(){super();const e=this.bindTemplate;this.setTemplate({tag:"div",attributes:{class:["ck","ck-size-view",e.to("_viewPosition",(e=>e?`ck-orientation-${e}`:""))],style:{display:e.if("_isVisible","none",(e=>!e))}},children:[{text:e.to("_label")}]});}_bindToState(e,t){this.bind("_isVisible").to(t,"proposedWidth",t,"proposedHeight",((e,t)=>null!==e&&null!==t)),this.bind("_label").to(t,"proposedHandleHostWidth",t,"proposedHandleHostHeight",t,"proposedWidthPercents",((t,i,n)=>"px"===e.unit?`${t}×${i}`:`${n}%`)),this.bind("_viewPosition").to(t,"activeHandlePosition",t,"proposedHandleHostWidth",t,"proposedHandleHostHeight",((e,t,i)=>t<50||i<50?"above-center":e));}_dismiss(){this.unbind(),this._isVisible=!1;}}class qk extends(ar()){_state;_sizeView;_options;_viewResizerWrapper=null;_initialViewWidth;constructor(e){super(),this._options=e,this.set("isEnabled",!0),this.set("isSelected",!1),this.bind("isVisible").to(this,"isEnabled",this,"isSelected",((e,t)=>e&&t)),this.decorate("begin"),this.decorate("cancel"),this.decorate("commit"),this.decorate("updateSize"),this.on("commit",(e=>{this.state.proposedWidth||this.state.proposedWidthPercents||(this._cleanup(),e.stop());}),{priority:"high"});}get state(){return this._state}show(){this._options.editor.editing.view.change((e=>{e.removeClass("ck-hidden",this._viewResizerWrapper);}));}hide(){this._options.editor.editing.view.change((e=>{e.addClass("ck-hidden",this._viewResizerWrapper);}));}attach(){const e=this,t=this._options.viewElement;this._options.editor.editing.view.change((i=>{const n=i.createUIElement("div",{class:"ck ck-reset_all ck-widget__resizer"},(function(t){const i=this.toDomElement(t);return e._appendHandles(i),e._appendSizeUI(i),i}));i.insert(i.createPositionAt(t,"end"),n),i.addClass("ck-widget_with-resizer",t),this._viewResizerWrapper=n,this.isVisible||this.hide();})),this.on("change:isVisible",(()=>{this.isVisible?(this.show(),this.redraw()):this.hide();}));}begin(e){this._state=new Uk(this._options),this._sizeView._bindToState(this._options,this.state),this._initialViewWidth=this._options.viewElement.getStyle("width"),this.state.begin(e,this._getHandleHost(),this._getResizeHost());}updateSize(e){const t=this._proposeNewSize(e);this._options.editor.editing.view.change((e=>{const i=this._options.unit||"%",n=("%"===i?t.widthPercents:t.width)+i;e.setStyle("width",n,this._options.viewElement);}));const i=this._getHandleHost(),n=new Fr(i),s=Math.round(n.width),o=Math.round(n.height),r=new Fr(i);t.width=Math.round(r.width),t.height=Math.round(r.height),this.redraw(n),this.state.update({...t,handleHostWidth:s,handleHostHeight:o});}commit(){const e=this._options.unit||"%",t=("%"===e?this.state.proposedWidthPercents:this.state.proposedWidth)+e;this._options.editor.editing.view.change((()=>{this._cleanup(),this._options.onCommit(t);}));}cancel(){this._cleanup();}destroy(){this.cancel();}redraw(e){const t=this._domResizerWrapper;if(!((i=t)&&i.ownerDocument&&i.ownerDocument.contains(i)))return;var i;const n=t.parentElement,s=this._getHandleHost(),o=this._viewResizerWrapper,r=[o.getStyle("width"),o.getStyle("height"),o.getStyle("left"),o.getStyle("top")];let a;if(n.isSameNode(s)){const t=e||new Fr(s);a=[t.width+"px",t.height+"px",void 0,void 0];}else a=[s.offsetWidth+"px",s.offsetHeight+"px",s.offsetLeft+"px",s.offsetTop+"px"];"same"!==pr(r,a)&&this._options.editor.editing.view.change((e=>{e.setStyle({width:a[0],height:a[1],left:a[2],top:a[3]},o);}));}containsHandle(e){return this._domResizerWrapper.contains(e)}static isResizeHandle(e){return e.classList.contains("ck-widget__resizer__handle")}_cleanup(){this._sizeView._dismiss();this._options.editor.editing.view.change((e=>{e.setStyle("width",this._initialViewWidth,this._options.viewElement);}));}_proposeNewSize(e){const t=this.state,i={x:(n=e).pageX,y:n.pageY};var n;const s=!this._options.isCentered||this._options.isCentered(this),o={x:t._referenceCoordinates.x-(i.x+t.originalWidth),y:i.y-t.originalHeight-t._referenceCoordinates.y};s&&t.activeHandlePosition.endsWith("-right")&&(o.x=i.x-(t._referenceCoordinates.x+t.originalWidth)),s&&(o.x*=2);let r=Math.abs(t.originalWidth+o.x),a=Math.abs(t.originalHeight+o.y);return "width"==(r/t.aspectRatio>a?"width":"height")?a=r/t.aspectRatio:r=a*t.aspectRatio,{width:Math.round(r),height:Math.round(a),widthPercents:Math.min(Math.round(t.originalWidthPercents/t.originalWidth*r*100)/100,100)}}_getResizeHost(){const e=this._domResizerWrapper.parentElement;return this._options.getResizeHost(e)}_getHandleHost(){const e=this._domResizerWrapper.parentElement;return this._options.getHandleHost(e)}get _domResizerWrapper(){return this._options.editor.editing.view.domConverter.mapViewToDom(this._viewResizerWrapper)}_appendHandles(e){const t=["top-left","top-right","bottom-right","bottom-left"];for(const n of t)e.appendChild(new Jg({tag:"div",attributes:{class:"ck-widget__resizer__handle "+(i=n,`ck-widget__resizer__handle-${i}`)}}).render());var i;}_appendSizeUI(e){this._sizeView=new jk,this._sizeView.render(),e.appendChild(this._sizeView.element);}}class Gk extends Ga{_resizers=new Map;_observer;_redrawSelectedResizerThrottled;static get pluginName(){return "WidgetResize"}init(){const e=this.editor.editing,t=i.window.document;this.set("selectedResizer",null),this.set("_activeResizer",null),e.view.addObserver(Xu),this._observer=new(Ar()),this.listenTo(e.view.document,"mousedown",this._mouseDownListener.bind(this),{priority:"high"}),this._observer.listenTo(t,"mousemove",this._mouseMoveListener.bind(this)),this._observer.listenTo(t,"mouseup",this._mouseUpListener.bind(this)),this._redrawSelectedResizerThrottled=er((()=>this.redrawSelectedResizer()),200),this.editor.ui.on("update",this._redrawSelectedResizerThrottled),this.editor.model.document.on("change",(()=>{for(const[e,t]of this._resizers)e.isAttached()||(this._resizers.delete(e),t.destroy());}),{priority:"lowest"}),this._observer.listenTo(i.window,"resize",this._redrawSelectedResizerThrottled);const n=this.editor.editing.view.document.selection;n.on("change",(()=>{const e=n.getSelectedElement(),t=this.getResizerByViewElement(e)||null;t?this.select(t):this.deselect();}));}redrawSelectedResizer(){this.selectedResizer&&this.selectedResizer.isVisible&&this.selectedResizer.redraw();}destroy(){super.destroy(),this._observer.stopListening();for(const e of this._resizers.values())e.destroy();this._redrawSelectedResizerThrottled.cancel();}select(e){this.deselect(),this.selectedResizer=e,this.selectedResizer.isSelected=!0;}deselect(){this.selectedResizer&&(this.selectedResizer.isSelected=!1),this.selectedResizer=null;}attachTo(e){const t=new qk(e),i=this.editor.plugins;if(t.attach(),i.has("WidgetToolbarRepository")){const e=i.get("WidgetToolbarRepository");t.on("begin",(()=>{e.forceDisabled("resize");}),{priority:"lowest"}),t.on("cancel",(()=>{e.clearForceDisabled("resize");}),{priority:"highest"}),t.on("commit",(()=>{e.clearForceDisabled("resize");}),{priority:"highest"});}this._resizers.set(e.viewElement,t);const n=this.editor.editing.view.document.selection.getSelectedElement();return this.getResizerByViewElement(n)==t&&this.select(t),t}getResizerByViewElement(e){return this._resizers.get(e)}_getResizerByHandle(e){for(const t of this._resizers.values())if(t.containsHandle(e))return t}_mouseDownListener(e,t){const i=t.domTarget;qk.isResizeHandle(i)&&(this._activeResizer=this._getResizerByHandle(i)||null,this._activeResizer&&(this._activeResizer.begin(i),e.stop(),t.preventDefault()));}_mouseMoveListener(e,t){this._activeResizer&&this._activeResizer.updateSize(t);}_mouseUpListener(){this._activeResizer&&(this._activeResizer.commit(),this._activeResizer=null);}}const Kk=Wr("px");class Zk extends wf{constructor(){super();const e=this.bindTemplate;this.set({isVisible:!1,left:null,top:null,width:null}),this.setTemplate({tag:"div",attributes:{class:["ck","ck-clipboard-drop-target-line",e.if("isVisible","ck-hidden",(e=>!e))],style:{left:e.to("left",(e=>Kk(e))),top:e.to("top",(e=>Kk(e))),width:e.to("width",(e=>Kk(e)))}}});}}class Jk extends Ga{removeDropMarkerDelayed=Fa((()=>this.removeDropMarker()),40);_updateDropMarkerThrottled=er((e=>this._updateDropMarker(e)),40);_reconvertMarkerThrottled=er((()=>{this.editor.model.markers.has("drop-target")&&this.editor.editing.reconvertMarker("drop-target");}),0);_dropTargetLineView=new Zk;_domEmitter=new(Ar());_scrollables=new Map;static get pluginName(){return "DragDropTarget"}init(){this._setupDropMarker();}destroy(){this._domEmitter.stopListening();for(const{resizeObserver:e}of this._scrollables.values())e.destroy();return this._updateDropMarkerThrottled.cancel(),this.removeDropMarkerDelayed.cancel(),this._reconvertMarkerThrottled.cancel(),super.destroy()}updateDropMarker(e,t,i,n,s,o){this.removeDropMarkerDelayed.cancel();const r=Qk(this.editor,e,t,i,n,s,o);if(r)return o&&o.containsRange(r)?this.removeDropMarker():void this._updateDropMarkerThrottled(r)}getFinalDropRange(e,t,i,n,s,o){const r=Qk(this.editor,e,t,i,n,s,o);return this.removeDropMarker(),r}removeDropMarker(){const e=this.editor.model;this.removeDropMarkerDelayed.cancel(),this._updateDropMarkerThrottled.cancel(),this._dropTargetLineView.isVisible=!1,e.markers.has("drop-target")&&e.change((e=>{e.removeMarker("drop-target");}));}_setupDropMarker(){const e=this.editor;e.ui.view.body.add(this._dropTargetLineView),e.conversion.for("editingDowncast").markerToHighlight({model:"drop-target",view:{classes:["ck-clipboard-drop-target-range"]}}),e.conversion.for("editingDowncast").markerToElement({model:"drop-target",view:(t,{writer:i})=>{if(e.model.schema.checkChild(t.markerRange.start,"$text"))return this._dropTargetLineView.isVisible=!1,this._createDropTargetPosition(i);t.markerRange.isCollapsed?this._updateDropTargetLine(t.markerRange):this._dropTargetLineView.isVisible=!1;}});}_updateDropMarker(e){const t=this.editor,i=t.model.markers;t.model.change((t=>{i.has("drop-target")?i.get("drop-target").getRange().isEqual(e)||t.updateMarker("drop-target",{range:e}):t.addMarker("drop-target",{range:e,usingOperation:!1,affectsData:!1});}));}_createDropTargetPosition(e){return e.createUIElement("span",{class:"ck ck-clipboard-drop-target-position"},(function(e){const t=this.toDomElement(e);return t.append("⁠",e.createElement("span"),"⁠"),t}))}_updateDropTargetLine(e){const t=this.editor.editing,n=e.start.nodeBefore,s=e.start.nodeAfter,o=e.start.parent,r=n?t.mapper.toViewElement(n):null,a=r?t.view.domConverter.mapViewToDom(r):null,l=s?t.mapper.toViewElement(s):null,c=l?t.view.domConverter.mapViewToDom(l):null,d=t.mapper.toViewElement(o);if(!d)return;const h=t.view.domConverter.mapViewToDom(d),u=this._getScrollableRect(d),{scrollX:m,scrollY:g}=i.window,f=a?new Fr(a):null,p=c?new Fr(c):null,b=new Fr(h).excludeScrollbarsAndBorders(),w=f?f.bottom:b.top,_=p?p.top:b.bottom,v=i.window.getComputedStyle(h),y=w<=_?(w+_)/2:_;if(u.top<y&&y<u.bottom){const e=b.left+parseFloat(v.paddingLeft),t=b.right-parseFloat(v.paddingRight),i=Math.max(e+m,u.left),n=Math.min(t+m,u.right);this._dropTargetLineView.set({isVisible:!0,left:i,top:y+g,width:n-i});}else this._dropTargetLineView.isVisible=!1;}_getScrollableRect(e){const t=e.root.rootName;let n;if(this._scrollables.has(t))n=this._scrollables.get(t).domElement;else {n=function(e){let t=e;do{t=t.parentElement;const e=i.window.getComputedStyle(t).overflowY;if("auto"==e||"scroll"==e)break}while("BODY"!=t.tagName);return t}(this.editor.editing.view.domConverter.mapViewToDom(e)),this._domEmitter.listenTo(n,"scroll",this._reconvertMarkerThrottled,{usePassive:!0});const s=new $r(n,this._reconvertMarkerThrottled);this._scrollables.set(t,{domElement:n,resizeObserver:s});}return new Fr(n).excludeScrollbarsAndBorders()}}function Qk(e,t,i,n,s,o,r){const a=e.model,l=e.editing.mapper;let c=tC(e,t);for(;c;){if(!o)if(a.schema.checkChild(c,"$text")){if(i){const t=i[0].start,o=l.toModelPosition(t);if(!r||Array.from(r.getItems()).every((e=>a.schema.checkChild(o,e)))){if(a.schema.checkChild(o,"$text"))return a.createRange(o);if(t)return Xk(e,tC(e,t.parent),n,s)}}}else if(a.schema.isInline(c))return Xk(e,c,n,s);if(a.schema.isBlock(c))return Xk(e,c,n,s);if(a.schema.checkChild(c,"$block")){const t=Array.from(c.getChildren()).filter((t=>t.is("element")&&!Yk(e,t)));let i=0,o=t.length;if(0==o)return a.createRange(a.createPositionAt(c,"end"));for(;i<o-1;){const r=Math.floor((i+o)/2);"before"==eC(e,t[r],n,s)?o=r:i=r;}return Xk(e,t[i],n,s)}c=c.parent;}return null}function Yk(e,t){const n=e.editing.mapper,s=e.editing.view.domConverter,o=n.toViewElement(t);if(!o)return !0;const r=s.mapViewToDom(o);return "none"!=i.window.getComputedStyle(r).float}function Xk(e,t,i,n){const s=e.model;return s.createRange(s.createPositionAt(t,eC(e,t,i,n)))}function eC(e,t,i,n){const s=e.editing.mapper,o=e.editing.view.domConverter,r=s.toViewElement(t),a=o.mapViewToDom(r),l=new Fr(a);return e.model.schema.isInline(t)?i<(l.left+l.right)/2?"before":"after":n<(l.top+l.bottom)/2?"before":"after"}function tC(e,t){const i=e.editing.mapper,n=e.editing.view,s=i.toModelElement(t);if(s)return s;const o=n.createPositionBefore(t),r=i.findMappedViewAncestor(o);return i.toModelElement(r)}class iC extends Ga{_isBlockDragging=!1;_domEmitter=new(Ar());static get pluginName(){return "DragDropBlockToolbar"}init(){const e=this.editor;if(this.listenTo(e,"change:isReadOnly",((e,t,i)=>{i?(this.forceDisabled("readOnlyMode"),this._isBlockDragging=!1):this.clearForceDisabled("readOnlyMode");})),o.isAndroid&&this.forceDisabled("noAndroidSupport"),e.plugins.has("BlockToolbar")){const t=e.plugins.get("BlockToolbar").buttonView.element;this._domEmitter.listenTo(t,"dragstart",((e,t)=>this._handleBlockDragStart(t))),this._domEmitter.listenTo(i.document,"dragover",((e,t)=>this._handleBlockDragging(t))),this._domEmitter.listenTo(i.document,"drop",((e,t)=>this._handleBlockDragging(t))),this._domEmitter.listenTo(i.document,"dragend",(()=>this._handleBlockDragEnd()),{useCapture:!0}),this.isEnabled&&t.setAttribute("draggable","true"),this.on("change:isEnabled",((e,i,n)=>{t.setAttribute("draggable",n?"true":"false");}));}}destroy(){return this._domEmitter.stopListening(),super.destroy()}_handleBlockDragStart(e){if(!this.isEnabled)return;const t=this.editor.model,i=t.document.selection,n=this.editor.editing.view,s=Array.from(i.getSelectedBlocks()),o=t.createRange(t.createPositionBefore(s[0]),t.createPositionAfter(s[s.length-1]));t.change((e=>e.setSelection(o))),this._isBlockDragging=!0,n.focus(),n.getObserver(tk).onDomEvent(e);}_handleBlockDragging(e){if(!this.isEnabled||!this._isBlockDragging)return;const t=e.clientX+("ltr"==this.editor.locale.contentLanguageDirection?100:-100),i=e.clientY,n=document.elementFromPoint(t,i),s=this.editor.editing.view;n&&n.closest(".ck-editor__editable")&&s.getObserver(tk).onDomEvent({...e,type:e.type,dataTransfer:e.dataTransfer,target:n,clientX:t,clientY:i,preventDefault:()=>e.preventDefault(),stopPropagation:()=>e.stopPropagation()});}_handleBlockDragEnd(){this._isBlockDragging=!1;}}class nC extends Ga{_draggedRange;_draggingUid;_draggableElement;_clearDraggableAttributesDelayed=Fa((()=>this._clearDraggableAttributes()),40);_blockMode=!1;_domEmitter=new(Ar());_previewContainer;static get pluginName(){return "DragDrop"}static get requires(){return [ak,Nk,Jk,iC]}init(){const e=this.editor,t=e.editing.view;this._draggedRange=null,this._draggingUid="",this._draggableElement=null,t.addObserver(tk),t.addObserver(Xu),this._setupDragging(),this._setupContentInsertionIntegration(),this._setupClipboardInputIntegration(),this._setupDraggableAttributeHandling(),this.listenTo(e,"change:isReadOnly",((e,t,i)=>{i?this.forceDisabled("readOnlyMode"):this.clearForceDisabled("readOnlyMode");})),this.on("change:isEnabled",((e,t,i)=>{i||this._finalizeDragging(!1);})),o.isAndroid&&this.forceDisabled("noAndroidSupport");}destroy(){return this._draggedRange&&(this._draggedRange.detach(),this._draggedRange=null),this._previewContainer&&this._previewContainer.remove(),this._domEmitter.stopListening(),this._clearDraggableAttributesDelayed.cancel(),super.destroy()}_setupDragging(){const e=this.editor,t=e.model,n=e.editing.view,s=n.document,r=e.plugins.get(Jk);this.listenTo(s,"dragstart",((e,i)=>{if(i.target&&i.target.is("editableElement"))return void i.preventDefault();if(this._prepareDraggedRange(i.target),!this._draggedRange)return void i.preventDefault();this._draggingUid=k(),i.dataTransfer.effectAllowed=this.isEnabled?"copyMove":"copy",i.dataTransfer.setData("application/ckeditor5-dragging-uid",this._draggingUid);const n=t.createSelection(this._draggedRange.toRange());this.editor.plugins.get("ClipboardPipeline")._fireOutputTransformationEvent(i.dataTransfer,n,"dragstart");const{dataTransfer:s,domTarget:o,domEvent:r}=i,{clientX:a}=r;this._updatePreview({dataTransfer:s,domTarget:o,clientX:a}),i.stopPropagation(),this.isEnabled||(this._draggedRange.detach(),this._draggedRange=null,this._draggingUid="");}),{priority:"low"}),this.listenTo(s,"dragend",((e,t)=>{this._finalizeDragging(!t.dataTransfer.isCanceled&&"move"==t.dataTransfer.dropEffect);}),{priority:"low"}),this._domEmitter.listenTo(i.document,"dragend",(()=>{this._blockMode=!1;}),{useCapture:!0}),this.listenTo(s,"dragenter",(()=>{this.isEnabled&&n.focus();})),this.listenTo(s,"dragleave",(()=>{r.removeDropMarkerDelayed();})),this.listenTo(s,"dragging",((e,t)=>{if(!this.isEnabled)return void(t.dataTransfer.dropEffect="none");const{clientX:i,clientY:n}=t.domEvent;r.updateDropMarker(t.target,t.targetRanges,i,n,this._blockMode,this._draggedRange),this._draggedRange||(t.dataTransfer.dropEffect="copy"),o.isGecko||("copy"==t.dataTransfer.effectAllowed?t.dataTransfer.dropEffect="copy":["all","copyMove"].includes(t.dataTransfer.effectAllowed)&&(t.dataTransfer.dropEffect="move")),e.stop();}),{priority:"low"});}_setupClipboardInputIntegration(){const e=this.editor,t=e.editing.view.document,i=e.plugins.get(Jk);this.listenTo(t,"clipboardInput",((t,n)=>{if("drop"!=n.method)return;const{clientX:s,clientY:o}=n.domEvent,r=i.getFinalDropRange(n.target,n.targetRanges,s,o,this._blockMode,this._draggedRange);if(!r)return this._finalizeDragging(!1),void t.stop();this._draggedRange&&this._draggingUid!=n.dataTransfer.getData("application/ckeditor5-dragging-uid")&&(this._draggedRange.detach(),this._draggedRange=null,this._draggingUid="");if("move"==sC(n.dataTransfer)&&this._draggedRange&&this._draggedRange.containsRange(r,!0))return this._finalizeDragging(!1),void t.stop();n.targetRanges=[e.editing.mapper.toViewRange(r)];}),{priority:"high"});}_setupContentInsertionIntegration(){const e=this.editor.plugins.get(ak);e.on("contentInsertion",((e,t)=>{if(!this.isEnabled||"drop"!==t.method)return;const i=t.targetRanges.map((e=>this.editor.editing.mapper.toModelRange(e)));this.editor.model.change((e=>e.setSelection(i)));}),{priority:"high"}),e.on("contentInsertion",((e,t)=>{if(!this.isEnabled||"drop"!==t.method)return;const i="move"==sC(t.dataTransfer),n=!t.resultRange||!t.resultRange.isCollapsed;this._finalizeDragging(n&&i);}),{priority:"lowest"});}_setupDraggableAttributeHandling(){const e=this.editor,t=e.editing.view,i=t.document;this.listenTo(i,"mousedown",((n,s)=>{if(o.isAndroid||!s)return;this._clearDraggableAttributesDelayed.cancel();let r=oC(s.target);if(o.isBlink&&!e.isReadOnly&&!r&&!i.selection.isCollapsed){const e=i.selection.getSelectedElement();e&&fk(e)||(r=i.selection.editableElement);}r&&(t.change((e=>{e.setAttribute("draggable","true",r);})),this._draggableElement=e.editing.mapper.toModelElement(r));})),this.listenTo(i,"mouseup",(()=>{o.isAndroid||this._clearDraggableAttributesDelayed();}));}_clearDraggableAttributes(){const e=this.editor.editing;e.view.change((t=>{this._draggableElement&&"$graveyard"!=this._draggableElement.root.rootName&&t.removeAttribute("draggable",e.mapper.toViewElement(this._draggableElement)),this._draggableElement=null;}));}_finalizeDragging(e){const t=this.editor,i=t.model;if(t.plugins.get(Jk).removeDropMarker(),this._clearDraggableAttributes(),t.plugins.has("WidgetToolbarRepository")){t.plugins.get("WidgetToolbarRepository").clearForceDisabled("dragDrop");}this._draggingUid="",this._previewContainer&&(this._previewContainer.remove(),this._previewContainer=void 0),this._draggedRange&&(e&&this.isEnabled&&i.change((e=>{const t=i.createSelection(this._draggedRange);i.deleteContent(t,{doNotAutoparagraph:!0});const n=t.getFirstPosition().parent;n.isEmpty&&!i.schema.checkChild(n,"$text")&&i.schema.checkChild(n,"paragraph")&&e.insertElement("paragraph",n,0);})),this._draggedRange.detach(),this._draggedRange=null);}_prepareDraggedRange(e){const t=this.editor,i=t.model,n=i.document.selection,s=e?oC(e):null;if(s){const e=t.editing.mapper.toModelElement(s);if(this._draggedRange=xd.fromRange(i.createRangeOn(e)),this._blockMode=i.schema.isBlock(e),t.plugins.has("WidgetToolbarRepository")){t.plugins.get("WidgetToolbarRepository").forceDisabled("dragDrop");}return}if(n.isCollapsed&&!n.getFirstPosition().parent.isEmpty)return;const o=Array.from(n.getSelectedBlocks()),r=n.getFirstRange();if(0==o.length)return void(this._draggedRange=xd.fromRange(r));const a=rC(i,o);if(o.length>1)this._draggedRange=xd.fromRange(a),this._blockMode=!0;else if(1==o.length){const e=r.start.isTouching(a.start)&&r.end.isTouching(a.end);this._draggedRange=xd.fromRange(e?a:r),this._blockMode=e;}i.change((e=>e.setSelection(this._draggedRange.toRange())));}_updatePreview({dataTransfer:e,domTarget:t,clientX:n}){const s=this.editor.editing.view,r=s.document.selection.editableElement,a=s.domConverter.mapViewToDom(r),l=i.window.getComputedStyle(a);this._previewContainer?this._previewContainer.firstElementChild&&this._previewContainer.removeChild(this._previewContainer.firstElementChild):(this._previewContainer=wr(i.document,"div",{style:"position: fixed; left: -999999px;"}),i.document.body.appendChild(this._previewContainer));const c=new Fr(a);if(a.contains(t))return;const d=parseFloat(l.paddingLeft),h=wr(i.document,"div");h.className="ck ck-content",h.style.width=l.width,h.style.paddingLeft=`${c.left-n+d}px`,o.isiOS&&(h.style.backgroundColor="white"),h.innerHTML=e.getData("text/html"),e.setDragImage(h,0,0),this._previewContainer.appendChild(h);}}function sC(e){return o.isGecko?e.dropEffect:["all","copyMove"].includes(e.effectAllowed)?"move":"copy"}function oC(e){if(e.is("editableElement"))return null;if(e.hasClass("ck-widget__selection-handle"))return e.findAncestor(fk);if(fk(e))return e;const t=e.findAncestor((e=>fk(e)||e.is("editableElement")));return fk(t)?t:null}function rC(e,t){const i=t[0],n=t[t.length-1],s=i.getCommonAncestor(n),o=e.createPositionBefore(i),r=e.createPositionAfter(n);if(s&&s.is("element")&&!e.schema.isLimit(s)){const t=e.createRangeOn(s),i=o.isTouching(t.start),n=r.isTouching(t.end);if(i&&n)return rC(e,[s])}return e.createRange(o,r)}class aC extends Ga{static get pluginName(){return "PastePlainText"}static get requires(){return [ak]}init(){const e=this.editor,t=e.model,i=e.editing.view,n=t.document.selection;i.addObserver(tk),e.plugins.get(ak).on("contentInsertion",((e,i)=>{(function(e,t){let i=t.createRangeIn(e);if(1==e.childCount){const n=e.getChild(0);n.is("element")&&t.schema.isBlock(n)&&!t.schema.isObject(n)&&!t.schema.isLimit(n)&&(i=t.createRangeIn(n));}for(const e of i.getItems()){if(!t.schema.isInline(e))return !1;if(Array.from(e.getAttributeKeys()).find((e=>t.schema.getAttributeProperties(e).isFormatting)))return !1}return !0})(i.content,t)&&t.change((e=>{const s=Array.from(n.getAttributes()).filter((([e])=>t.schema.getAttributeProperties(e).isFormatting));n.isCollapsed||t.deleteContent(n,{doNotAutoparagraph:!0}),s.push(...n.getAttributes());const o=e.createRangeIn(i.content);for(const i of o.getItems())for(const n of s)t.schema.checkAttribute(i,n[0])&&e.setAttribute(n[0],n[1],i);}));}));}}class lC extends Ga{static get pluginName(){return "Clipboard"}static get requires(){return [rk,ak,nC,aC]}init(){const e=this.editor,t=this.editor.t;e.accessibility.addKeystrokeInfos({keystrokes:[{label:t("Copy selected content"),keystroke:"CTRL+C"},{label:t("Paste content"),keystroke:"CTRL+V"},{label:t("Paste content as plain text"),keystroke:"CTRL+SHIFT+V"}]});}}const uC=/^data:(\S*?);base64,/;class mC extends(F()){file;xhr;_token;_apiAddress;constructor(e,t,i){if(super(),!e)throw new E("fileuploader-missing-file",null);if(!t)throw new E("fileuploader-missing-token",null);if(!i)throw new E("fileuploader-missing-api-address",null);this.file=function(e){if("string"!=typeof e)return !1;const t=e.match(uC);return !(!t||!t.length)}(e)?function(e,t=512){try{const i=e.match(uC)[1],n=atob(e.replace(uC,"")),s=[];for(let e=0;e<n.length;e+=t){const i=n.slice(e,e+t),o=new Array(i.length);for(let e=0;e<i.length;e++)o[e]=i.charCodeAt(e);s.push(new Uint8Array(o));}return new Blob(s,{type:i})}catch(e){throw new E("fileuploader-decoding-image-data-error",null)}}(e):e,this._token=t,this._apiAddress=i;}onProgress(e){return this.on("progress",((t,i)=>e(i))),this}onError(e){return this.once("error",((t,i)=>e(i))),this}abort(){this.xhr.abort();}send(){return this._prepareRequest(),this._attachXHRListeners(),this._sendRequest()}_prepareRequest(){const e=new XMLHttpRequest;e.open("POST",this._apiAddress),e.setRequestHeader("Authorization",this._token.value),e.responseType="json",this.xhr=e;}_attachXHRListeners(){const e=this.xhr,t=e=>()=>this.fire("error",e);e.addEventListener("error",t("Network Error")),e.addEventListener("abort",t("Abort")),e.upload&&e.upload.addEventListener("progress",(e=>{e.lengthComputable&&this.fire("progress",{total:e.total,uploaded:e.loaded});})),e.addEventListener("load",(()=>{const t=e.status,i=e.response;if(t<200||t>299)return this.fire("error",i.message||i.error)}));}_sendRequest(){const e=new FormData,t=this.xhr;return e.append("file",this.file),new Promise(((i,n)=>{t.addEventListener("load",(()=>{const e=t.status,s=t.response;return e<200||e>299?s.message?n(new E("fileuploader-uploading-data-failed",this,{message:s.message})):n(s.error):i(s)})),t.addEventListener("error",(()=>n(new Error("Network Error")))),t.addEventListener("abort",(()=>n(new Error("Abort")))),t.send(e);}))}}function bC(e){const t=e.t,i=e.config.get("codeBlock.languages");for(const e of i)"Plain text"===e.label&&(e.label=t("Plain text")),void 0===e.class&&(e.class=`language-${e.language}`);return i}function wC(e,t,i){const n={};for(const s of e)if("class"===t){n[s[t].split(" ").shift()]=s[i];}else n[s[t]]=s[i];return n}function _C(e){return e.data.match(/^(\s*)/)[0]}function vC(e){const t=e.document.selection,i=[];if(t.isCollapsed)return [t.anchor];const n=t.getFirstRange().getWalker({ignoreElementEnd:!0,direction:"backward"});for(const{item:t}of n){let n=t.is("$textProxy")?t.textNode:t;const s=n.parent;if(!s.is("element","codeBlock")||n.is("element","softBreak"))continue;for(;n.previousSibling&&!n.previousSibling.is("element","softBreak");)n=n.previousSibling;const o=n.is("$text")?n.startOffset+_C(n).length:n.startOffset,r=e.createPositionAt(s,o);i.every((e=>!e.isEqual(r)))&&i.push(r);}return i}function yC(e){const t=Ia(e.getSelectedBlocks());return !!t&&t.is("element","codeBlock")}function kC(e,t){return !t.is("rootElement")&&!e.isLimit(t)&&e.checkChild(t.parent,"codeBlock")}function CC(e,t,i,n){const s=wC(t,"language","label"),o=i.getAttribute("language");if(o in s){const t=s[o];return e("enter"===n?"Entering %0 code snippet":"Leaving %0 code snippet",t)}return e("enter"===n?"Entering code snippet":"Leaving code snippet")}function xC(e,t){for(e.textNode&&(e=t.createPositionBefore(e.textNode));e.nodeBefore&&!e.nodeBefore.is("element","softBreak");)e=t.createPositionBefore(e.nodeBefore);const i=e.nodeAfter;return i&&i.is("$text")?i:null}class AC extends Za{_lastLanguage;constructor(e){super(e),this._lastLanguage=null;}refresh(){this.value=this._getValue(),this.isEnabled=this._checkEnabled();}execute(e={}){const t=this.editor,i=t.model,n=i.document.selection,s=bC(t)[0],o=Array.from(n.getSelectedBlocks()),r=null==e.forceValue?!this.value:e.forceValue,a=function(e,t,i){if(e.language)return e.language;if(e.usePreviousLanguageChoice&&t)return t;return i}(e,this._lastLanguage,s.language);i.change((e=>{r?this._applyCodeBlock(e,o,a):this._removeCodeBlock(e,o);}));}_getValue(){const e=Ia(this.editor.model.document.selection.getSelectedBlocks());return !!!(!e||!e.is("element","codeBlock"))&&e.getAttribute("language")}_checkEnabled(){if(this.value)return !0;const e=this.editor.model.document.selection,t=this.editor.model.schema,i=Ia(e.getSelectedBlocks());return !!i&&kC(t,i)}_applyCodeBlock(e,t,i){this._lastLanguage=i;const n=this.editor.model.schema,s=t.filter((e=>kC(n,e)));for(const t of s)e.rename(t,"codeBlock"),e.setAttribute("language",i,t),n.removeDisallowedAttributes([t],e),Array.from(t.getChildren()).filter((e=>!n.checkChild(t,e))).forEach((t=>e.remove(t)));s.reverse().forEach(((t,i)=>{const n=s[i+1];t.previousSibling===n&&(e.appendElement("softBreak",n),e.merge(e.createPositionBefore(t)));}));}_removeCodeBlock(e,t){const i=t.filter((e=>e.is("element","codeBlock")));for(const t of i){const i=e.createRangeOn(t);for(const t of Array.from(i.getItems()).reverse())if(t.is("element","softBreak")&&t.parent.is("element","codeBlock")){const{position:i}=e.split(e.createPositionBefore(t)),n=i.nodeAfter;e.rename(n,"paragraph"),e.removeAttribute("language",n),e.remove(t);}e.rename(t,"paragraph"),e.removeAttribute("language",t);}}}class EC extends Za{_indentSequence;constructor(e){super(e),this._indentSequence=e.config.get("codeBlock.indentSequence");}refresh(){this.isEnabled=this._checkEnabled();}execute(){const e=this.editor.model;e.change((t=>{const i=vC(e);for(const n of i){const i=t.createText(this._indentSequence);e.insertContent(i,n);}}));}_checkEnabled(){return !!this._indentSequence&&yC(this.editor.model.document.selection)}}class TC extends Za{_indentSequence;constructor(e){super(e),this._indentSequence=e.config.get("codeBlock.indentSequence");}refresh(){this.isEnabled=this._checkEnabled();}execute(){const e=this.editor.model;e.change((()=>{const t=vC(e);for(const i of t){const t=SC(e,i,this._indentSequence);t&&e.deleteContent(e.createSelection(t));}}));}_checkEnabled(){if(!this._indentSequence)return !1;const e=this.editor.model;return !!yC(e.document.selection)&&vC(e).some((t=>SC(e,t,this._indentSequence)))}}function SC(e,t,i){const n=xC(t,e);if(!n)return null;const s=_C(n),o=s.lastIndexOf(i);if(o+i.length!==s.length)return null;if(-1===o)return null;const{parent:r,startOffset:a}=n;return e.createRange(e.createPositionAt(r,a+o),e.createPositionAt(r,a+o+i.length))}function IC(e,t,i=!1){const n=wC(t,"language","class"),s=wC(t,"language","label");return (t,o,r)=>{const{writer:a,mapper:l,consumable:c}=r;if(!c.consume(o.item,"insert"))return;const d=o.item.getAttribute("language"),h=l.toViewPosition(e.createPositionBefore(o.item)),u={};i&&(u["data-language"]=s[d],u.spellcheck="false");const m=n[d]?{class:n[d]}:void 0,g=a.createContainerElement("code",m),f=a.createContainerElement("pre",u,g);a.insert(h,f),l.bindElements(o.item,g);}}const PC="paragraph";class VC extends Ga{static get pluginName(){return "CodeBlockEditing"}static get requires(){return [cy]}constructor(e){super(e),e.config.define("codeBlock",{languages:[{language:"plaintext",label:"Plain text"},{language:"c",label:"C"},{language:"cs",label:"C#"},{language:"cpp",label:"C++"},{language:"css",label:"CSS"},{language:"diff",label:"Diff"},{language:"html",label:"HTML"},{language:"java",label:"Java"},{language:"javascript",label:"JavaScript"},{language:"php",label:"PHP"},{language:"python",label:"Python"},{language:"ruby",label:"Ruby"},{language:"typescript",label:"TypeScript"},{language:"xml",label:"XML"}],indentSequence:"\t"});}init(){const e=this.editor,t=e.model.schema,i=e.model,n=e.editing.view,s=bC(e);e.commands.add("codeBlock",new AC(e)),e.commands.add("indentCodeBlock",new EC(e)),e.commands.add("outdentCodeBlock",new TC(e)),this.listenTo(n.document,"tab",((t,i)=>{const n=i.shiftKey?"outdentCodeBlock":"indentCodeBlock";e.commands.get(n).isEnabled&&(e.execute(n),i.stopPropagation(),i.preventDefault(),t.stop());}),{context:"pre"}),t.register("codeBlock",{allowWhere:"$block",allowChildren:"$text",disallowChildren:"$inlineObject",allowAttributes:["language"],allowAttributesOf:"$listItem",isBlock:!0}),t.addAttributeCheck(((e,i)=>{const n=e.getItem(e.length-2);if(t.getAttributeProperties(i).isFormatting&&n&&"codeBlock"==n.name)return !1})),e.editing.downcastDispatcher.on("insert:codeBlock",IC(i,s,!0)),e.data.downcastDispatcher.on("insert:codeBlock",IC(i,s)),e.data.downcastDispatcher.on("insert:softBreak",function(e){return (t,i,n)=>{if("codeBlock"!==i.item.parent.name)return;const{writer:s,mapper:o,consumable:r}=n;if(!r.consume(i.item,"insert"))return;const a=o.toViewPosition(e.createPositionBefore(i.item));s.insert(a,s.createText("\n"));}}(i),{priority:"high"}),e.data.upcastDispatcher.on("element:code",function(e,t){const i=wC(t,"class","language"),n=t[0].language;return (e,t,s)=>{const o=t.viewItem,r=o.parent;if(!r||!r.is("element","pre"))return;if(t.modelCursor.findAncestor("codeBlock"))return;const{consumable:a,writer:l}=s;if(!a.test(o,{name:!0}))return;const c=l.createElement("codeBlock"),d=[...o.getClassNames()];d.length||d.push("");for(const e of d){const t=i[e];if(t){l.setAttribute("language",t,c);break}}c.hasAttribute("language")||l.setAttribute("language",n,c),s.convertChildren(o,c),s.safeInsert(c,t.modelCursor)&&(a.consume(o,{name:!0}),s.updateConversionResult(c,t));}}(0,s)),e.data.upcastDispatcher.on("text",((e,t,{consumable:i,writer:n})=>{let s=t.modelCursor;if(!i.test(t.viewItem))return;if(!s.findAncestor("codeBlock"))return;i.consume(t.viewItem);const o=t.viewItem.data.split("\n").map((e=>n.createText(e))),r=o[o.length-1];for(const e of o)if(n.insert(e,s),s=s.getShiftedBy(e.offsetSize),e!==r){const e=n.createElement("softBreak");n.insert(e,s),s=n.createPositionAfter(e);}t.modelRange=n.createRange(t.modelCursor,s),t.modelCursor=s;})),e.data.upcastDispatcher.on("element:pre",((e,t,{consumable:i})=>{const n=t.viewItem;if(n.findAncestor("pre"))return;const s=Array.from(n.getChildren()),o=s.find((e=>e.is("element","code")));if(o)for(const e of s)e!==o&&e.is("$text")&&i.consume(e,{name:!0});}),{priority:"high"}),this.listenTo(e.editing.view.document,"clipboardInput",((t,n)=>{let s=i.createRange(i.document.selection.anchor);if(n.targetRanges&&(s=e.editing.mapper.toModelRange(n.targetRanges[0])),!s.start.parent.is("element","codeBlock"))return;const o=n.dataTransfer.getData("text/plain"),r=new em(e.editing.view.document);n.content=function(e,t){const i=e.createDocumentFragment(),n=t.split("\n"),s=n.reduce(((t,i,s)=>(t.push(i),s<n.length-1&&t.push(e.createElement("br")),t)),[]);return e.appendChild(s,i),i}(r,o);})),e.plugins.has("ClipboardPipeline")&&e.plugins.get(ak).on("contentInsertion",((i,n)=>{const s=e.model,o=s.document.selection;o.anchor.parent.is("element","codeBlock")&&s.change((e=>{const i=e.createRangeIn(n.content);for(const n of [...i.getItems()])n.is("node")&&!t.checkChild(o.anchor,n)&&e.remove(n);}));})),this.listenTo(i,"getSelectedContent",((e,[n])=>{const s=n.anchor;!n.isCollapsed&&s.parent.is("element","codeBlock")&&s.hasSameParentAs(n.focus)&&i.change((i=>{const o=e.return;if(s.parent.is("element")&&(o.childCount>1||n.containsEntireContent(s.parent))){const t=i.createElement("codeBlock",s.parent.getAttributes());i.append(o,t);const n=i.createDocumentFragment();return i.append(t,n),void(e.return=n)}const r=o.getChild(0);t.checkAttribute(r,"code")&&i.setAttribute("code",!0,r);}));}));}afterInit(){const e=this.editor,t=e.commands,i=t.get("indent"),n=t.get("outdent");i&&i.registerChildCommand(t.get("indentCodeBlock"),{priority:"highest"}),n&&n.registerChildCommand(t.get("outdentCodeBlock")),this.listenTo(e.editing.view.document,"enter",((t,i)=>{e.model.document.selection.getLastPosition().parent.is("element","codeBlock")&&(function(e,t){const i=e.model,n=i.document,s=e.editing.view,o=n.selection.getLastPosition(),r=o.nodeAfter;if(t||!n.selection.isCollapsed||!o.isAtStart)return !1;if(!BC(r))return !1;return e.model.change((t=>{e.execute("enter");const i=n.selection.anchor.parent.previousSibling;t.rename(i,PC),t.setSelection(i,"in"),e.model.schema.removeDisallowedAttributes([i],t),t.remove(r);})),s.scrollToTheSelection(),!0}(e,i.isSoft)||function(e,t){const i=e.model,n=i.document,s=e.editing.view,o=n.selection.getLastPosition(),r=o.nodeBefore;let a;if(t||!n.selection.isCollapsed||!o.isAtEnd||!r||!r.previousSibling)return !1;if(BC(r)&&BC(r.previousSibling))a=i.createRange(i.createPositionBefore(r.previousSibling),i.createPositionAfter(r));else if(RC(r)&&BC(r.previousSibling)&&BC(r.previousSibling.previousSibling))a=i.createRange(i.createPositionBefore(r.previousSibling.previousSibling),i.createPositionAfter(r));else {if(!(RC(r)&&BC(r.previousSibling)&&RC(r.previousSibling.previousSibling)&&r.previousSibling.previousSibling&&BC(r.previousSibling.previousSibling.previousSibling)))return !1;a=i.createRange(i.createPositionBefore(r.previousSibling.previousSibling.previousSibling),i.createPositionAfter(r));}return e.model.change((t=>{t.remove(a),e.execute("enter");const i=n.selection.anchor.parent;t.rename(i,PC),e.model.schema.removeDisallowedAttributes([i],t);})),s.scrollToTheSelection(),!0}(e,i.isSoft)||function(e){const t=e.model,i=t.document;let n;const s=xC(i.selection.getLastPosition(),t);s&&s.is("$text")&&(n=_C(s));e.model.change((t=>{e.execute("shiftEnter"),n&&t.insertText(n,i.selection.anchor);}));}(e),i.preventDefault(),t.stop());}),{context:"pre"}),this._initAriaAnnouncements();}_initAriaAnnouncements(){const{model:e,ui:t,t:i}=this.editor,n=bC(this.editor);let s=null;e.document.selection.on("change:range",(()=>{const o=e.document.selection.focus.parent;t&&s!==o&&o.is("element")&&(s&&s.is("element","codeBlock")&&t.ariaLiveAnnouncer.announce(CC(i,n,s,"leave")),o.is("element","codeBlock")&&t.ariaLiveAnnouncer.announce(CC(i,n,o,"enter")),s=o);}));}}function RC(e){return e&&e.is("$text")&&!e.data.match(/\S/)}function BC(e){return e&&e.is("element","softBreak")}class OC extends Ga{static get pluginName(){return "CodeBlockUI"}init(){const e=this.editor,t=e.t,i=e.ui.componentFactory,n=bC(e),s=this._getLanguageListItemDefinitions(n),o=e.commands.get("codeBlock");i.add("codeBlock",(i=>{const n=lb(i,ab),r=n.buttonView,a=t("Insert code block");return r.set({label:a,tooltip:!0,icon:Ig.codeBlock,isToggleable:!0}),r.bind("isOn").to(o,"value",(e=>!!e)),r.on("execute",(()=>{e.execute("codeBlock",{usePreviousLanguageChoice:!0}),e.editing.view.focus();})),n.on("execute",(t=>{e.execute("codeBlock",{language:t.source._codeBlockLanguage,forceValue:!0}),e.editing.view.focus();})),n.class="ck-code-block-dropdown",n.bind("isEnabled").to(o),mb(n,s,{role:"menu",ariaLabel:a}),n})),i.add("menuBar:codeBlock",(i=>{const n=new w_(i);n.buttonView.set({role:"menuitem",label:t("Code block"),icon:Ig.codeBlock}),n.bind("isEnabled").to(o);const r=new __(i);r.set({ariaLabel:t("Insert code block")});for(const t of s){const s=new kw(i,n),a=new $f(i);a.bind(...Object.keys(t.model)).to(t.model),a.set({isToggleable:!0,role:"menuitemcheckbox"}),a.delegate("execute").to(n),a.on("execute",(()=>{e.execute("codeBlock",{language:t.model._codeBlockLanguage,forceValue:o.value!=t.model._codeBlockLanguage}),e.editing.view.focus();})),s.children.add(a),r.items.add(s);}return n.panelView.children.add(r),n}));}_getLanguageListItemDefinitions(e){const t=this.editor.commands.get("codeBlock"),i=new Sa;for(const n of e){const e={type:"button",model:new Kw({_codeBlockLanguage:n.language,label:n.label,role:"menuitemradio",withText:!0})};e.model.bind("isOn").to(t,"value",(t=>t===e.model._codeBlockLanguage)),i.add(e);}return i}}class MC extends Ga{static get requires(){return [VC,OC]}static get pluginName(){return "CodeBlock"}}class UC extends Dw{view;_toolbarConfig;_elementReplacer;constructor(e,t){super(e),this.view=t,this._toolbarConfig=tb(e.config.get("toolbar")),this._elementReplacer=new mr,this.listenTo(e.editing.view,"scrollToTheSelection",this._handleScrollToTheSelectionWithStickyPanel.bind(this));}get element(){return this.view.element}init(e){const t=this.editor,i=this.view,n=t.editing.view,s=i.editable,o=n.document.getRoot();s.name=o.rootName,i.render();const r=s.element;this.setEditableElement(s.name,r),i.editable.bind("isFocused").to(this.focusTracker),n.attachDomRoot(r),e&&this._elementReplacer.replace(e,this.element),this._initPlaceholder(),this._initToolbar(),i.menuBarView&&this._initMenuBar(i.menuBarView),this._initDialogPluginIntegration(),this._initContextualBalloonIntegration(),this.fire("ready");}destroy(){super.destroy();const e=this.view,t=this.editor.editing.view;this._elementReplacer.restore(),t.detachDomRoot(e.editable.name),e.destroy();}_initToolbar(){const e=this.view;e.stickyPanel.bind("isActive").to(this.focusTracker,"isFocused"),e.stickyPanel.limiterElement=e.element,e.stickyPanel.bind("viewportTopOffset").to(this,"viewportOffset",(({top:e})=>e||0)),e.toolbar.fillFromConfig(this._toolbarConfig,this.componentFactory),this.addToolbar(e.toolbar);}_initPlaceholder(){const e=this.editor,t=e.editing.view,i=t.document.getRoot(),n=e.sourceElement;let s;const o=e.config.get("placeholder");o&&(s="string"==typeof o?o:o[this.view.editable.name]),!s&&n&&"textarea"===n.tagName.toLowerCase()&&(s=n.getAttribute("placeholder")),s&&(i.placeholder=s),nl({view:t,element:i,isDirectHost:!1,keepOnFocus:!0});}_initContextualBalloonIntegration(){if(!this.editor.plugins.has("ContextualBalloon"))return;const{stickyPanel:e}=this.view,t=this.editor.plugins.get("ContextualBalloon");t.on("getPositionOptions",(t=>{const i=t.return;if(!i||!e.isSticky||!e.element)return;const n=new Fr(e.element).height,s="function"==typeof i.target?i.target():i.target,o="function"==typeof i.limiter?i.limiter():i.limiter;if(s&&o&&new Fr(s).height>=new Fr(o).height-n)return;const r={...i.viewportOffsetConfig},a=(r.top||0)+n;t.return={...i,viewportOffsetConfig:{...r,top:a}};}),{priority:"low"});const i=()=>{t.visibleView&&t.updatePosition();};this.listenTo(e,"change:isSticky",i),this.listenTo(this.editor.ui,"change:viewportOffset",i);}_handleScrollToTheSelectionWithStickyPanel(e,t,i){const n=this.view.stickyPanel;if(n.isSticky){const e=new Fr(n.element).height;t.viewportOffset.top+=e;}else {const e=()=>{this.editor.editing.view.scrollToTheSelection(i);};this.listenTo(n,"change:isSticky",e),setTimeout((()=>{this.stopListening(n,"change:isSticky",e);}),20);}}_initDialogPluginIntegration(){if(!this.editor.plugins.has("Dialog"))return;const e=this.view.stickyPanel,t=this.editor.plugins.get("Dialog");t.on("show",(()=>{const i=t.view;i.on("moveTo",((t,n)=>{if(!e.isSticky||i.wasMoved)return;const s=new Fr(e.contentPanelElement);n[1]<s.bottom+Nf.defaultOffset&&(n[1]=s.bottom+Nf.defaultOffset);}),{priority:"high"});}),{priority:"low"});}}class WC extends $w{stickyPanel;toolbar;editable;constructor(e,t,i={}){super(e),this.stickyPanel=new e_(e),this.toolbar=new nb(e,{shouldGroupWhenFull:i.shouldToolbarGroupWhenFull}),i.useMenuBar&&(this.menuBarView=new C_(e)),this.editable=new Ww(e,t,void 0,{label:i.label});}render(){super.render(),this.menuBarView?this.stickyPanel.content.addMany([this.menuBarView,this.toolbar]):this.stickyPanel.content.add(this.toolbar),this.top.add(this.stickyPanel),this.main.add(this.editable);}}class jC extends(Eg(Cg)){ui;constructor(e,t={}){if(!qC(e)&&void 0!==t.initialData)throw new E("editor-create-initial-data",null);super(t),this.config.define("menuBar.isVisible",!1),void 0===this.config.get("initialData")&&this.config.set("initialData",function(e){return qC(e)?Pr(e):e}(e)),qC(e)&&(this.sourceElement=e),this.model.document.createRoot();const i=!this.config.get("toolbar.shouldNotGroupWhenFull"),n=this.config.get("menuBar"),s=new WC(this.locale,this.editing.view,{shouldToolbarGroupWhenFull:i,useMenuBar:n.isVisible,label:this.config.get("label")});this.ui=new UC(this,s),xg(this);}destroy(){return this.sourceElement&&this.updateSourceElement(),this.ui.destroy(),super.destroy()}static create(e,t={}){return new Promise((i=>{const n=new this(e,t);i(n.initPlugins().then((()=>n.ui.init(qC(e)?e:null))).then((()=>n.data.init(n.config.get("initialData")))).then((()=>n.fire("ready"))).then((()=>n)));}))}}function qC(e){return Go(e)}class rx extends Za{constructor(e){super(e),this.affectsData=!1;}execute(){const e=this.editor.model,t=e.document.selection;let i=e.schema.getLimitElement(t);if(t.containsEntireContent(i)||!ax(e.schema,i))do{if(i=i.parent,!i)return}while(!ax(e.schema,i));e.change((e=>{e.setSelection(i,"in");}));}}function ax(e,t){return e.isLimit(t)&&(e.checkChild(t,"$text")||e.checkChild(t,"paragraph"))}const lx=ba("Ctrl+A");class cx extends Ga{static get pluginName(){return "SelectAllEditing"}init(){const e=this.editor,t=e.t,i=e.editing.view.document;e.commands.add("selectAll",new rx(e)),this.listenTo(i,"keydown",((t,i)=>{pa(i)===lx&&(e.execute("selectAll"),i.preventDefault());})),e.accessibility.addKeystrokeInfos({keystrokes:[{label:t("Select all"),keystroke:"CTRL+A"}]});}}class dx extends Ga{static get pluginName(){return "SelectAllUI"}init(){const e=this.editor;e.ui.componentFactory.add("selectAll",(()=>{const e=this._createButton(Ef);return e.set({tooltip:!0}),e})),e.ui.componentFactory.add("menuBar:selectAll",(()=>this._createButton($f)));}_createButton(e){const t=this.editor,i=t.locale,n=t.commands.get("selectAll"),s=new e(t.locale),o=i.t;return s.set({label:o("Select all"),icon:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M.75 15.5a.75.75 0 0 1 .75.75V18l.008.09A.5.5 0 0 0 2 18.5h1.75a.75.75 0 1 1 0 1.5H1.5l-.144-.007a1.5 1.5 0 0 1-1.35-1.349L0 18.5v-2.25a.75.75 0 0 1 .75-.75zm18.5 0a.75.75 0 0 1 .75.75v2.25l-.007.144a1.5 1.5 0 0 1-1.349 1.35L18.5 20h-2.25a.75.75 0 1 1 0-1.5H18a.5.5 0 0 0 .492-.41L18.5 18v-1.75a.75.75 0 0 1 .75-.75zm-10.45 3c.11 0 .2.09.2.2v1.1a.2.2 0 0 1-.2.2H7.2a.2.2 0 0 1-.2-.2v-1.1c0-.11.09-.2.2-.2h1.6zm4 0c.11 0 .2.09.2.2v1.1a.2.2 0 0 1-.2.2h-1.6a.2.2 0 0 1-.2-.2v-1.1c0-.11.09-.2.2-.2h1.6zm.45-5.5a.75.75 0 1 1 0 1.5h-8.5a.75.75 0 1 1 0-1.5h8.5zM1.3 11c.11 0 .2.09.2.2v1.6a.2.2 0 0 1-.2.2H.2a.2.2 0 0 1-.2-.2v-1.6c0-.11.09-.2.2-.2h1.1zm18.5 0c.11 0 .2.09.2.2v1.6a.2.2 0 0 1-.2.2h-1.1a.2.2 0 0 1-.2-.2v-1.6c0-.11.09-.2.2-.2h1.1zm-4.55-2a.75.75 0 1 1 0 1.5H4.75a.75.75 0 1 1 0-1.5h10.5zM1.3 7c.11 0 .2.09.2.2v1.6a.2.2 0 0 1-.2.2H.2a.2.2 0 0 1-.2-.2V7.2c0-.11.09-.2.2-.2h1.1zm18.5 0c.11 0 .2.09.2.2v1.6a.2.2 0 0 1-.2.2h-1.1a.2.2 0 0 1-.2-.2V7.2c0-.11.09-.2.2-.2h1.1zm-4.55-2a.75.75 0 1 1 0 1.5h-2.5a.75.75 0 1 1 0-1.5h2.5zm-5 0a.75.75 0 1 1 0 1.5h-5.5a.75.75 0 0 1 0-1.5h5.5zm-6.5-5a.75.75 0 0 1 0 1.5H2a.5.5 0 0 0-.492.41L1.5 2v1.75a.75.75 0 0 1-1.5 0V1.5l.007-.144A1.5 1.5 0 0 1 1.356.006L1.5 0h2.25zM18.5 0l.144.007a1.5 1.5 0 0 1 1.35 1.349L20 1.5v2.25a.75.75 0 1 1-1.5 0V2l-.008-.09A.5.5 0 0 0 18 1.5h-1.75a.75.75 0 1 1 0-1.5h2.25zM8.8 0c.11 0 .2.09.2.2v1.1a.2.2 0 0 1-.2.2H7.2a.2.2 0 0 1-.2-.2V.2c0-.11.09-.2.2-.2h1.6zm4 0c.11 0 .2.09.2.2v1.1a.2.2 0 0 1-.2.2h-1.6a.2.2 0 0 1-.2-.2V.2c0-.11.09-.2.2-.2h1.6z"/></svg>',keystroke:"Ctrl+A"}),s.bind("isEnabled").to(n,"isEnabled"),this.listenTo(s,"execute",(()=>{t.execute("selectAll"),t.editing.view.focus();})),s}}class hx extends Ga{static get requires(){return [cx,dx]}static get pluginName(){return "SelectAll"}}class ux extends Za{_stack=[];_createdBatches=new WeakSet;constructor(e){super(e),this.refresh(),this._isEnabledBasedOnSelection=!1,this.listenTo(e.data,"set",((e,t)=>{t[1]={...t[1]};const i=t[1];i.batchType||(i.batchType={isUndoable:!1});}),{priority:"high"}),this.listenTo(e.data,"set",((e,t)=>{t[1].batchType.isUndoable||this.clearStack();}));}refresh(){this.isEnabled=this._stack.length>0;}get createdBatches(){return this._createdBatches}addBatch(e){const t=this.editor.model.document.selection,i={ranges:t.hasOwnRange?Array.from(t.getRanges()):[],isBackward:t.isBackward};this._stack.push({batch:e,selection:i}),this.refresh();}clearStack(){this._stack=[],this.refresh();}_restoreSelection(e,t,i){const n=this.editor.model,s=n.document,o=[],r=e.map((e=>e.getTransformedByOperations(i))),a=r.flat();for(const e of r){const t=e.filter((e=>e.root!=s.graveyard)).filter((e=>!gx(e,a)));t.length&&(mx(t),o.push(t[0]));}o.length&&n.change((e=>{e.setSelection(o,{backward:t});}));}_undo(e,t){const i=this.editor.model,n=i.document;this._createdBatches.add(t);const s=e.operations.slice().filter((e=>e.isDocumentOperation));s.reverse();for(const e of s){const s=e.baseVersion+1,o=Array.from(n.history.getOperations(s)),r=ou([e.getReversed()],o,{useRelations:!0,document:this.editor.model.document,padWithNoOps:!1,forceWeakRemove:!0}).operationsA;for(let s of r){const o=s.affectedSelectable;o&&!i.canEditAt(o)&&(s=new Zh(s.baseVersion)),t.addOperation(s),i.applyOperation(s),n.history.setOperationAsUndone(e,s);}}}}function mx(e){e.sort(((e,t)=>e.start.isBefore(t.start)?-1:1));for(let t=1;t<e.length;t++){const i=e[t-1].getJoined(e[t],!0);i&&(t--,e.splice(t,2,i));}}function gx(e,t){return t.some((t=>t!==e&&t.containsRange(e,!0)))}class fx extends ux{execute(e=null){const t=e?this._stack.findIndex((t=>t.batch==e)):this._stack.length-1,i=this._stack.splice(t,1)[0],n=this.editor.model.createBatch({isUndo:!0});this.editor.model.enqueueChange(n,(()=>{this._undo(i.batch,n);const e=this.editor.model.document.history.getOperations(i.batch.baseVersion);this._restoreSelection(i.selection.ranges,i.selection.isBackward,e);})),this.fire("revert",i.batch,n),this.refresh();}}class px extends ux{execute(){const e=this._stack.pop(),t=this.editor.model.createBatch({isUndo:!0});this.editor.model.enqueueChange(t,(()=>{const i=e.batch.operations[e.batch.operations.length-1].baseVersion+1,n=this.editor.model.document.history.getOperations(i);this._restoreSelection(e.selection.ranges,e.selection.isBackward,n),this._undo(e.batch,t);})),this.refresh();}}class bx extends Ga{_undoCommand;_redoCommand;_batchRegistry=new WeakSet;static get pluginName(){return "UndoEditing"}init(){const e=this.editor,t=e.t;this._undoCommand=new fx(e),this._redoCommand=new px(e),e.commands.add("undo",this._undoCommand),e.commands.add("redo",this._redoCommand),this.listenTo(e.model,"applyOperation",((e,t)=>{const i=t[0];if(!i.isDocumentOperation)return;const n=i.batch,s=this._redoCommand.createdBatches.has(n),o=this._undoCommand.createdBatches.has(n);this._batchRegistry.has(n)||(this._batchRegistry.add(n),n.isUndoable&&(s?this._undoCommand.addBatch(n):o||(this._undoCommand.addBatch(n),this._redoCommand.clearStack())));}),{priority:"highest"}),this.listenTo(this._undoCommand,"revert",((e,t,i)=>{this._redoCommand.addBatch(i);})),e.keystrokes.set("CTRL+Z","undo"),e.keystrokes.set("CTRL+Y","redo"),e.keystrokes.set("CTRL+SHIFT+Z","redo"),e.accessibility.addKeystrokeInfos({keystrokes:[{label:t("Undo"),keystroke:"CTRL+Z"},{label:t("Redo"),keystroke:[["CTRL+Y"],["CTRL+SHIFT+Z"]]}]});}}class wx extends Ga{static get pluginName(){return "UndoUI"}init(){const e=this.editor,t=e.locale,i=e.t,n="ltr"==t.uiLanguageDirection?Ig.undo:Ig.redo,s="ltr"==t.uiLanguageDirection?Ig.redo:Ig.undo;this._addButtonsToFactory("undo",i("Undo"),"CTRL+Z",n),this._addButtonsToFactory("redo",i("Redo"),"CTRL+Y",s);}_addButtonsToFactory(e,t,i,n){const s=this.editor;s.ui.componentFactory.add(e,(()=>{const s=this._createButton(Ef,e,t,i,n);return s.set({tooltip:!0}),s})),s.ui.componentFactory.add("menuBar:"+e,(()=>this._createButton($f,e,t,i,n)));}_createButton(e,t,i,n,s){const o=this.editor,r=o.locale,a=o.commands.get(t),l=new e(r);return l.set({label:i,icon:s,keystroke:n}),l.bind("isEnabled").to(a,"isEnabled"),this.listenTo(l,"execute",(()=>{o.execute(t),o.editing.view.focus();})),l}}class _x extends Ga{static get requires(){return [bx,wx]}static get pluginName(){return "Undo"}}class vx extends Ga{static get requires(){return [Gf,lC,oy,hx,cy,W_,_x]}static get pluginName(){return "Essentials"}}class pA extends Za{constructor(e){super(e),this._isEnabledBasedOnSelection=!1;}refresh(){const e=this.editor.model,t=Ia(e.document.selection.getSelectedBlocks());this.value=!!t&&t.is("element","paragraph"),this.isEnabled=!!t&&bA(t,e.schema);}execute(e={}){const t=this.editor.model,i=t.document,n=e.selection||i.selection;t.canEditAt(n)&&t.change((e=>{const i=n.getSelectedBlocks();for(const n of i)!n.is("element","paragraph")&&bA(n,t.schema)&&e.rename(n,"paragraph");}));}}function bA(e,t){return t.checkChild(e.parent,"paragraph")&&!t.isObject(e)}class wA extends Za{constructor(e){super(e),this._isEnabledBasedOnSelection=!1;}execute(e){const t=this.editor.model,i=e.attributes;let n=e.position;t.canEditAt(n)&&t.change((e=>{if(n=this._findPositionToInsertParagraph(n,e),!n)return;const s=e.createElement("paragraph");i&&t.schema.setAllowedAttributes(s,i,e),t.insertContent(s,n),e.setSelection(s,"in");}));}_findPositionToInsertParagraph(e,t){const i=this.editor.model;if(i.schema.checkChild(e,"paragraph"))return e;const n=i.schema.findAllowedParent(e,"paragraph");if(!n)return null;const s=e.parent,o=i.schema.checkChild(s,"$text");return s.isEmpty||o&&e.isAtEnd?i.createPositionAfter(s):!s.isEmpty&&o&&e.isAtStart?i.createPositionBefore(s):t.split(e,n).position}}class _A extends Ga{static get pluginName(){return "Paragraph"}init(){const e=this.editor,t=e.model;e.commands.add("paragraph",new pA(e)),e.commands.add("insertParagraph",new wA(e)),t.schema.register("paragraph",{inheritAllFrom:"$block"}),e.conversion.elementToElement({model:"paragraph",view:"p"}),e.conversion.for("upcast").elementToElement({model:(e,{writer:t})=>_A.paragraphLikeElements.has(e.name)?e.isEmpty?null:t.createElement("paragraph"):null,view:/.+/,converterPriority:"low"});}static paragraphLikeElements=new Set(["blockquote","dd","div","dt","h1","h2","h3","h4","h5","h6","li","p","td","th"])}class yA extends Za{modelElements;constructor(e,t){super(e),this.modelElements=t;}refresh(){const e=Ia(this.editor.model.document.selection.getSelectedBlocks());this.value=!!e&&this.modelElements.includes(e.name)&&e.name,this.isEnabled=!!e&&this.modelElements.some((t=>kA(e,t,this.editor.model.schema)));}execute(e){const t=this.editor.model,i=t.document,n=e.value;t.change((e=>{const s=Array.from(i.selection.getSelectedBlocks()).filter((e=>kA(e,n,t.schema)));for(const t of s)t.is("element",n)||e.rename(t,n);}));}}function kA(e,t,i){return i.checkChild(e.parent,t)&&!i.isObject(e)}const CA="paragraph";class xA extends Ga{static get pluginName(){return "HeadingEditing"}constructor(e){super(e),e.config.define("heading",{options:[{model:"paragraph",title:"Paragraph",class:"ck-heading_paragraph"},{model:"heading1",view:"h2",title:"Heading 1",class:"ck-heading_heading1"},{model:"heading2",view:"h3",title:"Heading 2",class:"ck-heading_heading2"},{model:"heading3",view:"h4",title:"Heading 3",class:"ck-heading_heading3"}]});}static get requires(){return [_A]}init(){const e=this.editor,t=e.config.get("heading.options"),i=[];for(const n of t)"paragraph"!==n.model&&(e.model.schema.register(n.model,{inheritAllFrom:"$block"}),e.conversion.elementToElement(n),i.push(n.model));this._addDefaultH1Conversion(e),e.commands.add("heading",new yA(e,i));}afterInit(){const e=this.editor,t=e.commands.get("enter"),i=e.config.get("heading.options");t&&this.listenTo(t,"afterExecute",((t,n)=>{const s=e.model.document.selection.getFirstPosition().parent;i.some((e=>s.is("element",e.model)))&&!s.is("element",CA)&&0===s.childCount&&n.writer.rename(s,CA);}));}_addDefaultH1Conversion(e){e.conversion.for("upcast").elementToElement({model:"heading1",view:"h1",converterPriority:C.low+1});}}function AA(e){const t=e.t,i={Paragraph:t("Paragraph"),"Heading 1":t("Heading 1"),"Heading 2":t("Heading 2"),"Heading 3":t("Heading 3"),"Heading 4":t("Heading 4"),"Heading 5":t("Heading 5"),"Heading 6":t("Heading 6")};return e.config.get("heading.options").map((e=>{const t=i[e.title];return t&&t!=e.title&&(e.title=t),e}))}class EA extends Ga{static get pluginName(){return "HeadingUI"}init(){const e=this.editor,t=e.t,i=AA(e),n=t("Choose heading"),s=t("Heading");e.ui.componentFactory.add("heading",(t=>{const o={},r=new Sa,a=e.commands.get("heading"),l=e.commands.get("paragraph"),c=[a];for(const e of i){const t={type:"button",model:new Kw({label:e.title,class:e.class,role:"menuitemradio",withText:!0})};"paragraph"===e.model?(t.model.bind("isOn").to(l,"value"),t.model.set("commandName","paragraph"),c.push(l)):(t.model.bind("isOn").to(a,"value",(t=>t===e.model)),t.model.set({commandName:"heading",commandValue:e.model})),r.add(t),o[e.model]=e.title;}const d=lb(t);return mb(d,r,{ariaLabel:s,role:"menu"}),d.buttonView.set({ariaLabel:s,ariaLabelledBy:void 0,isOn:!1,withText:!0,tooltip:s}),d.extendTemplate({attributes:{class:["ck-heading-dropdown"]}}),d.bind("isEnabled").toMany(c,"isEnabled",((...e)=>e.some((e=>e)))),d.buttonView.bind("label").to(a,"value",l,"value",((e,t)=>{const i=t?"paragraph":e;return "boolean"==typeof i?n:o[i]?o[i]:n})),d.buttonView.bind("ariaLabel").to(a,"value",l,"value",((e,t)=>{const i=t?"paragraph":e;return "boolean"==typeof i?s:o[i]?`${o[i]}, ${s}`:s})),this.listenTo(d,"execute",(t=>{const{commandName:i,commandValue:n}=t.source;e.execute(i,n?{value:n}:void 0),e.editing.view.focus();})),d})),e.ui.componentFactory.add("menuBar:heading",(n=>{const s=new w_(n),o=e.commands.get("heading"),r=e.commands.get("paragraph"),a=[o],l=new __(n);s.set({class:"ck-heading-dropdown"}),l.set({ariaLabel:t("Heading"),role:"menu"}),s.buttonView.set({label:t("Heading")}),s.panelView.children.add(l);for(const t of i){const i=new kw(n,s),c=new $f(n);i.children.add(c),l.items.add(i),c.set({isToggleable:!0,label:t.title,role:"menuitemradio",class:t.class}),c.delegate("execute").to(s),c.on("execute",(()=>{const i="paragraph"===t.model?"paragraph":"heading";e.execute(i,{value:t.model}),e.editing.view.focus();})),"paragraph"===t.model?(c.bind("isOn").to(r,"value"),a.push(r)):c.bind("isOn").to(o,"value",(e=>e===t.model));}return s.bind("isEnabled").toMany(a,"isEnabled",((...e)=>e.some((e=>e)))),s}));}}class TA extends Ga{static get requires(){return [xA,EA]}static get pluginName(){return "Heading"}}class WA extends Za{refresh(){const e=this.editor.model,t=e.schema,i=e.document.selection;this.isEnabled=function(e,t,i){const n=function(e,t){const i=Ck(e,t),n=i.start.parent;if(n.isEmpty&&!n.is("element","$root"))return n.parent;return n}(e,i);return t.checkChild(n,"horizontalLine")}(i,t,e);}execute(){const e=this.editor.model;e.change((t=>{const i=t.createElement("horizontalLine");e.insertObject(i,null,null,{setSelection:"after"});}));}}class jA extends Ga{static get pluginName(){return "HorizontalLineEditing"}init(){const e=this.editor,t=e.model.schema,i=e.t,n=e.conversion;t.register("horizontalLine",{inheritAllFrom:"$blockObject"}),n.for("dataDowncast").elementToElement({model:"horizontalLine",view:(e,{writer:t})=>t.createEmptyElement("hr")}),n.for("editingDowncast").elementToStructure({model:"horizontalLine",view:(e,{writer:t})=>{const n=i("Horizontal line"),s=t.createContainerElement("div",null,t.createEmptyElement("hr"));return t.addClass("ck-horizontal-line",s),t.setCustomProperty("hr",!0,s),function(e,t,i){return t.setCustomProperty("horizontalLine",!0,e),pk(e,t,{label:i})}(s,t,n)}}),n.for("upcast").elementToElement({view:"hr",model:"horizontalLine"}),e.commands.add("horizontalLine",new WA(e));}}class qA extends Ga{static get pluginName(){return "HorizontalLineUI"}init(){const e=this.editor;e.ui.componentFactory.add("horizontalLine",(()=>{const e=this._createButton(Ef);return e.set({tooltip:!0}),e})),e.ui.componentFactory.add("menuBar:horizontalLine",(()=>this._createButton($f)));}_createButton(e){const t=this.editor,i=t.locale,n=t.commands.get("horizontalLine"),s=new e(t.locale),o=i.t;return s.set({label:o("Horizontal line"),icon:Ig.horizontalLine}),s.bind("isEnabled").to(n,"isEnabled"),this.listenTo(s,"execute",(()=>{t.execute("horizontalLine"),t.editing.view.focus();})),s}}class GA extends Ga{static get requires(){return [jA,qA,Nk]}static get pluginName(){return "HorizontalLine"}}function DE(e){return e.createContainerElement("figure",{class:"image"},[e.createEmptyElement("img"),e.createSlot("children")])}function zE(e,t){const i=e.plugins.get("ImageUtils"),n=e.plugins.has("ImageInlineEditing")&&e.plugins.has("ImageBlockEditing");return e=>{if(!i.isInlineImageView(e))return null;if(!n)return s(e);return ("block"==e.getStyle("display")||e.findAncestor(i.isBlockImageView)?"imageBlock":"imageInline")!==t?null:s(e)};function s(e){const t={name:!0};return e.hasAttribute("src")&&(t.attributes=["src"]),t}}function HE(e,t){const i=Ia(t.getSelectedBlocks());return !i||e.isObject(i)||i.isEmpty&&"listItem"!=i.name?"imageBlock":"imageInline"}function $E(e){return e&&e.endsWith("px")?parseInt(e):null}function UE(e){const t=$E(e.getStyle("width")),i=$E(e.getStyle("height"));return !(!t||!i)}const WE=/^(image|image-inline)$/;class jE extends Ga{_domEmitter=new(Ar());static get pluginName(){return "ImageUtils"}isImage(e){return this.isInlineImage(e)||this.isBlockImage(e)}isInlineImageView(e){return !!e&&e.is("element","img")}isBlockImageView(e){return !!e&&e.is("element","figure")&&e.hasClass("image")}insertImage(e={},t=null,i=null,n={}){const s=this.editor,o=s.model,r=o.document.selection,a=qE(s,t||r,i);e={...Object.fromEntries(r.getAttributes()),...e};for(const t in e)o.schema.checkAttribute(a,t)||delete e[t];return o.change((i=>{const{setImageSizes:s=!0}=n,r=i.createElement(a,e);return o.insertObject(r,t,null,{setSelection:"on",findOptimalPosition:t||"imageInline"==a?void 0:"auto"}),r.parent?(s&&this.setImageNaturalSizeAttributes(r),r):null}))}setImageNaturalSizeAttributes(e){const t=e.getAttribute("src");t&&(e.getAttribute("width")||e.getAttribute("height")||this.editor.model.change((n=>{const s=new i.window.Image;this._domEmitter.listenTo(s,"load",(()=>{e.getAttribute("width")||e.getAttribute("height")||this.editor.model.enqueueChange(n.batch,(t=>{t.setAttribute("width",s.naturalWidth,e),t.setAttribute("height",s.naturalHeight,e);})),this._domEmitter.stopListening(s,"load");})),s.src=t;})));}getClosestSelectedImageWidget(e){const t=e.getFirstPosition();if(!t)return null;const i=e.getSelectedElement();if(i&&this.isImageWidget(i))return i;let n=t.parent;for(;n;){if(n.is("element")&&this.isImageWidget(n))return n;n=n.parent;}return null}getClosestSelectedImageElement(e){const t=e.getSelectedElement();return this.isImage(t)?t:e.getFirstPosition().findAncestor("imageBlock")}getImageWidgetFromImageView(e){return e.findAncestor({classes:WE})}isImageAllowed(){const e=this.editor.model.document.selection;return function(e,t){const i=qE(e,t,null);if("imageBlock"==i){const i=function(e,t){const i=Ck(e,t),n=i.start.parent;if(n.isEmpty&&!n.is("element","$root"))return n.parent;return n}(t,e.model);if(e.model.schema.checkChild(i,"imageBlock"))return !0}else if(e.model.schema.checkChild(t.focus,"imageInline"))return !0;return !1}(this.editor,e)&&function(e){return [...e.focus.getAncestors()].every((e=>!e.is("element","imageBlock")))}(e)}toImageWidget(e,t,i){t.setCustomProperty("image",!0,e);return pk(e,t,{label:()=>{const t=this.findViewImgElement(e).getAttribute("alt");return t?`${t} ${i}`:i}})}isImageWidget(e){return !!e.getCustomProperty("image")&&fk(e)}isBlockImage(e){return !!e&&e.is("element","imageBlock")}isInlineImage(e){return !!e&&e.is("element","imageInline")}findViewImgElement(e){if(this.isInlineImageView(e))return e;const t=this.editor.editing.view;for(const{item:i}of t.createRangeIn(e))if(this.isInlineImageView(i))return i}destroy(){return this._domEmitter.stopListening(),super.destroy()}}function qE(e,t,i){const n=e.model.schema,s=e.config.get("image.insert.type");return e.plugins.has("ImageBlockEditing")?e.plugins.has("ImageInlineEditing")?i||("inline"===s?"imageInline":"auto"!==s?"imageBlock":t.is("selection")?HE(n,t):n.checkChild(t,"imageInline")?"imageInline":"imageBlock"):"imageBlock":"imageInline"}class ZE extends Za{refresh(){const e=this.editor.plugins.get("ImageUtils").getClosestSelectedImageElement(this.editor.model.document.selection);this.isEnabled=!!e,this.isEnabled&&e.hasAttribute("alt")?this.value=e.getAttribute("alt"):this.value=!1;}execute(e){const t=this.editor,i=t.plugins.get("ImageUtils"),n=t.model,s=i.getClosestSelectedImageElement(n.document.selection);n.change((t=>{t.setAttribute("alt",e.newValue,s);}));}}class JE extends Ga{static get requires(){return [jE]}static get pluginName(){return "ImageTextAlternativeEditing"}init(){this.editor.commands.add("imageTextAlternative",new ZE(this.editor));}}class QE extends wf{focusTracker;keystrokes;labeledInput;saveButtonView;cancelButtonView;_focusables;_focusCycler;constructor(e){super(e);const t=this.locale.t;this.focusTracker=new Pa,this.keystrokes=new Va,this.labeledInput=this._createLabeledInputView(),this.saveButtonView=this._createButton(t("Save"),Ig.check,"ck-button-save"),this.saveButtonView.type="submit",this.cancelButtonView=this._createButton(t("Cancel"),Ig.cancel,"ck-button-cancel","cancel"),this._focusables=new Zg,this._focusCycler=new If({focusables:this._focusables,focusTracker:this.focusTracker,keystrokeHandler:this.keystrokes,actions:{focusPrevious:"shift + tab",focusNext:"tab"}}),this.setTemplate({tag:"form",attributes:{class:["ck","ck-text-alternative-form","ck-responsive-form"],tabindex:"-1"},children:[this.labeledInput,this.saveButtonView,this.cancelButtonView]});}render(){super.render(),this.keystrokes.listenTo(this.element),kf({view:this}),[this.labeledInput,this.saveButtonView,this.cancelButtonView].forEach((e=>{this._focusables.add(e),this.focusTracker.add(e.element);}));}destroy(){super.destroy(),this.focusTracker.destroy(),this.keystrokes.destroy();}_createButton(e,t,i,n){const s=new Ef(this.locale);return s.set({label:e,icon:t,tooltip:!0}),s.extendTemplate({attributes:{class:i}}),n&&s.delegate("execute").to(this,n),s}_createLabeledInputView(){const e=this.locale.t,t=new Ap(this.locale,bb);return t.label=e("Text alternative"),t}}function YE(e){const t=e.editing.view,i=Kp.defaultPositions,n=e.plugins.get("ImageUtils");return {target:t.domConverter.mapViewToDom(n.getClosestSelectedImageWidget(t.document.selection)),positions:[i.northArrowSouth,i.northArrowSouthWest,i.northArrowSouthEast,i.southArrowNorth,i.southArrowNorthWest,i.southArrowNorthEast,i.viewportStickyNorth]}}class XE extends Ga{_balloon;_form;static get requires(){return [Jw]}static get pluginName(){return "ImageTextAlternativeUI"}init(){this._createButton();}destroy(){super.destroy(),this._form&&this._form.destroy();}_createButton(){const e=this.editor,t=e.t;e.ui.componentFactory.add("imageTextAlternative",(i=>{const n=e.commands.get("imageTextAlternative"),s=new Ef(i);return s.set({label:t("Change image text alternative"),icon:Ig.textAlternative,tooltip:!0}),s.bind("isEnabled").to(n,"isEnabled"),s.bind("isOn").to(n,"value",(e=>!!e)),this.listenTo(s,"execute",(()=>{this._showForm();})),s}));}_createForm(){const e=this.editor,t=e.editing.view.document,i=e.plugins.get("ImageUtils");this._balloon=this.editor.plugins.get("ContextualBalloon"),this._form=new(yf(QE))(e.locale),this._form.render(),this.listenTo(this._form,"submit",(()=>{e.execute("imageTextAlternative",{newValue:this._form.labeledInput.fieldView.element.value}),this._hideForm(!0);})),this.listenTo(this._form,"cancel",(()=>{this._hideForm(!0);})),this._form.keystrokes.set("Esc",((e,t)=>{this._hideForm(!0),t();})),this.listenTo(e.ui,"update",(()=>{i.getClosestSelectedImageWidget(t.selection)?this._isVisible&&function(e){const t=e.plugins.get("ContextualBalloon");if(e.plugins.get("ImageUtils").getClosestSelectedImageWidget(e.editing.view.document.selection)){const i=YE(e);t.updatePosition(i);}}(e):this._hideForm(!0);})),_f({emitter:this._form,activator:()=>this._isVisible,contextElements:()=>[this._balloon.view.element],callback:()=>this._hideForm()});}_showForm(){if(this._isVisible)return;this._form||this._createForm();const e=this.editor,t=e.commands.get("imageTextAlternative"),i=this._form.labeledInput;this._form.disableCssTransitions(),this._isInBalloon||this._balloon.add({view:this._form,position:YE(e)}),i.fieldView.value=i.fieldView.element.value=t.value||"",this._form.labeledInput.fieldView.select(),this._form.enableCssTransitions();}_hideForm(e=!1){this._isInBalloon&&(this._form.focusTracker.isFocused&&this._form.saveButtonView.focus(),this._balloon.remove(this._form),e&&this.editor.editing.view.focus());}get _isVisible(){return !!this._balloon&&this._balloon.visibleView===this._form}get _isInBalloon(){return !!this._balloon&&this._balloon.hasView(this._form)}}class eT extends Ga{static get requires(){return [JE,XE]}static get pluginName(){return "ImageTextAlternative"}}function tT(e,t){const i=(t,i,n)=>{if(!n.consumable.consume(i.item,t.name))return;const s=n.writer,o=n.mapper.toViewElement(i.item),r=e.findViewImgElement(o);null===i.attributeNewValue?(s.removeAttribute("srcset",r),s.removeAttribute("sizes",r)):i.attributeNewValue&&(s.setAttribute("srcset",i.attributeNewValue,r),s.setAttribute("sizes","100vw",r));};return e=>{e.on(`attribute:srcset:${t}`,i);}}function iT(e,t,i){const n=(t,i,n)=>{if(!n.consumable.consume(i.item,t.name))return;const s=n.writer,o=n.mapper.toViewElement(i.item),r=e.findViewImgElement(o);s.setAttribute(i.attributeKey,i.attributeNewValue||"",r);};return e=>{e.on(`attribute:${i}:${t}`,n);}}class nT extends Oc{observe(e){this.listenTo(e,"load",((e,t)=>{const i=t.target;this.checkShouldIgnoreEventFromTarget(i)||"IMG"==i.tagName&&this._fireEvents(t);}),{useCapture:!0});}stopObserving(e){this.stopListening(e);}_fireEvents(e){this.isEnabled&&(this.document.fire("layoutChanged"),this.document.fire("imageLoaded",e));}}class sT extends Za{constructor(e){super(e);const t=e.config.get("image.insert.type");e.plugins.has("ImageBlockEditing")||"block"===t&&T("image-block-plugin-required"),e.plugins.has("ImageInlineEditing")||"inline"===t&&T("image-inline-plugin-required");}refresh(){const e=this.editor.plugins.get("ImageUtils");this.isEnabled=e.isImageAllowed();}execute(e){const t=Aa(e.source),i=this.editor.model.document.selection,n=this.editor.plugins.get("ImageUtils"),s=Object.fromEntries(i.getAttributes());t.forEach(((e,t)=>{const o=i.getSelectedElement();if("string"==typeof e&&(e={src:e}),t&&o&&n.isImage(o)){const t=this.editor.model.createPositionAfter(o);n.insertImage({...e,...s},t);}else n.insertImage({...e,...s});}));}}class oT extends Za{constructor(e){super(e),this.decorate("cleanupImage");}refresh(){const e=this.editor.plugins.get("ImageUtils"),t=this.editor.model.document.selection.getSelectedElement();this.isEnabled=e.isImage(t),this.value=this.isEnabled?t.getAttribute("src"):null;}execute(e){const t=this.editor.model.document.selection.getSelectedElement(),i=this.editor.plugins.get("ImageUtils");this.editor.model.change((n=>{n.setAttribute("src",e.source,t),this.cleanupImage(n,t),i.setImageNaturalSizeAttributes(t);}));}cleanupImage(e,t){e.removeAttribute("srcset",t),e.removeAttribute("sizes",t),e.removeAttribute("sources",t),e.removeAttribute("width",t),e.removeAttribute("height",t),e.removeAttribute("alt",t);}}class rT extends Ga{static get requires(){return [jE]}static get pluginName(){return "ImageEditing"}init(){const e=this.editor,t=e.conversion;e.editing.view.addObserver(nT),t.for("upcast").attributeToAttribute({view:{name:"img",key:"alt"},model:"alt"}).attributeToAttribute({view:{name:"img",key:"srcset"},model:"srcset"});const i=new sT(e),n=new oT(e);e.commands.add("insertImage",i),e.commands.add("replaceImageSource",n),e.commands.add("imageInsert",i);}}class aT extends Ga{static get requires(){return [jE]}static get pluginName(){return "ImageSizeAttributes"}afterInit(){this._registerSchema(),this._registerConverters("imageBlock"),this._registerConverters("imageInline");}_registerSchema(){this.editor.plugins.has("ImageBlockEditing")&&this.editor.model.schema.extend("imageBlock",{allowAttributes:["width","height"]}),this.editor.plugins.has("ImageInlineEditing")&&this.editor.model.schema.extend("imageInline",{allowAttributes:["width","height"]});}_registerConverters(e){const t=this.editor,i=t.plugins.get("ImageUtils"),n="imageBlock"===e?"figure":"img";function s(t,n,s,o){t.on(`attribute:${n}:${e}`,((t,n,r)=>{if(!r.consumable.consume(n.item,t.name))return;const a=r.writer,l=r.mapper.toViewElement(n.item),c=i.findViewImgElement(l);if(null!==n.attributeNewValue?a.setAttribute(s,n.attributeNewValue,c):a.removeAttribute(s,c),n.item.hasAttribute("sources"))return;const d=n.item.hasAttribute("resizedWidth");if("imageInline"===e&&!d&&!o)return;const h=n.item.getAttribute("width"),u=n.item.getAttribute("height");h&&u&&a.setStyle("aspect-ratio",`${h}/${u}`,c);}));}t.conversion.for("upcast").attributeToAttribute({view:{name:n,styles:{width:/.+/}},model:{key:"width",value:e=>UE(e)?$E(e.getStyle("width")):null}}).attributeToAttribute({view:{name:n,key:"width"},model:"width"}).attributeToAttribute({view:{name:n,styles:{height:/.+/}},model:{key:"height",value:e=>UE(e)?$E(e.getStyle("height")):null}}).attributeToAttribute({view:{name:n,key:"height"},model:"height"}),t.conversion.for("editingDowncast").add((e=>{s(e,"width","width",!0),s(e,"height","height",!0);})),t.conversion.for("dataDowncast").add((e=>{s(e,"width","width",!1),s(e,"height","height",!1);}));}}class lT extends Za{_modelElementName;constructor(e,t){super(e),this._modelElementName=t;}refresh(){const e=this.editor.plugins.get("ImageUtils"),t=e.getClosestSelectedImageElement(this.editor.model.document.selection);"imageBlock"===this._modelElementName?this.isEnabled=e.isInlineImage(t):this.isEnabled=e.isBlockImage(t);}execute(e={}){const t=this.editor,i=this.editor.model,n=t.plugins.get("ImageUtils"),s=n.getClosestSelectedImageElement(i.document.selection),o=Object.fromEntries(s.getAttributes());return o.src||o.uploadId?i.change((t=>{const{setImageSizes:r=!0}=e,a=Array.from(i.markers).filter((e=>e.getRange().containsItem(s))),l=n.insertImage(o,i.createSelection(s,"on"),this._modelElementName,{setImageSizes:r});if(!l)return null;const c=t.createRangeOn(l);for(const e of a){const i=e.getRange(),n="$graveyard"!=i.root.rootName?i.getJoined(c,!0):c;t.updateMarker(e,{range:n});}return {oldElement:s,newElement:l}})):null}}class cT extends Ga{static get requires(){return [jE]}static get pluginName(){return "ImagePlaceholder"}afterInit(){this._setupSchema(),this._setupConversion(),this._setupLoadListener();}_setupSchema(){const e=this.editor.model.schema;e.isRegistered("imageBlock")&&e.extend("imageBlock",{allowAttributes:["placeholder"]}),e.isRegistered("imageInline")&&e.extend("imageInline",{allowAttributes:["placeholder"]});}_setupConversion(){const e=this.editor,t=e.conversion,i=e.plugins.get("ImageUtils");t.for("editingDowncast").add((e=>{e.on("attribute:placeholder",((e,t,n)=>{if(!n.consumable.test(t.item,e.name))return;if(!t.item.is("element","imageBlock")&&!t.item.is("element","imageInline"))return;n.consumable.consume(t.item,e.name);const s=n.writer,o=n.mapper.toViewElement(t.item),r=i.findViewImgElement(o);t.attributeNewValue?(s.addClass("image_placeholder",r),s.setStyle("background-image",`url(${t.attributeNewValue})`,r),s.setCustomProperty("editingPipeline:doNotReuseOnce",!0,r)):(s.removeClass("image_placeholder",r),s.removeStyle("background-image",r));}));}));}_setupLoadListener(){const e=this.editor,t=e.model,i=e.editing,n=i.view,s=e.plugins.get("ImageUtils");n.addObserver(nT),this.listenTo(n.document,"imageLoaded",((e,o)=>{const r=n.domConverter.mapDomToView(o.target);if(!r)return;const a=s.getImageWidgetFromImageView(r);if(!a)return;const l=i.mapper.toModelElement(a);l&&l.hasAttribute("placeholder")&&t.enqueueChange({isUndoable:!1},(e=>{e.removeAttribute("placeholder",l);}));}));}}class dT extends Ga{static get requires(){return [rT,aT,jE,cT,ak]}static get pluginName(){return "ImageBlockEditing"}init(){const e=this.editor;e.model.schema.register("imageBlock",{inheritAllFrom:"$blockObject",allowAttributes:["alt","src","srcset"]}),this._setupConversion(),e.plugins.has("ImageInlineEditing")&&(e.commands.add("imageTypeBlock",new lT(this.editor,"imageBlock")),this._setupClipboardIntegration());}_setupConversion(){const e=this.editor,t=e.t,i=e.conversion,n=e.plugins.get("ImageUtils");i.for("dataDowncast").elementToStructure({model:"imageBlock",view:(e,{writer:t})=>DE(t)}),i.for("editingDowncast").elementToStructure({model:"imageBlock",view:(e,{writer:i})=>n.toImageWidget(DE(i),i,t("image widget"))}),i.for("downcast").add(iT(n,"imageBlock","src")).add(iT(n,"imageBlock","alt")).add(tT(n,"imageBlock")),i.for("upcast").elementToElement({view:zE(e,"imageBlock"),model:(e,{writer:t})=>t.createElement("imageBlock",e.hasAttribute("src")?{src:e.getAttribute("src")}:void 0)}).add(function(e){const t=(t,i,n)=>{if(!n.consumable.test(i.viewItem,{name:!0,classes:"image"}))return;const s=e.findViewImgElement(i.viewItem);if(!s||!n.consumable.test(s,{name:!0}))return;n.consumable.consume(i.viewItem,{name:!0,classes:"image"});const o=Ia(n.convertItem(s,i.modelCursor).modelRange.getItems());o?(n.convertChildren(i.viewItem,o),n.updateConversionResult(o,i)):n.consumable.revert(i.viewItem,{name:!0,classes:"image"});};return e=>{e.on("element:figure",t);}}(n));}_setupClipboardIntegration(){const e=this.editor,t=e.model,i=e.editing.view,n=e.plugins.get("ImageUtils"),s=e.plugins.get("ClipboardPipeline");this.listenTo(s,"inputTransformation",((s,o)=>{const r=Array.from(o.content.getChildren());let a;if(!r.every(n.isInlineImageView))return;a=o.targetRanges?e.editing.mapper.toModelRange(o.targetRanges[0]):t.document.selection.getFirstRange();const l=t.createSelection(a);if("imageBlock"===HE(t.schema,l)){const e=new em(i.document),t=r.map((t=>e.createElement("figure",{class:"image"},t)));o.content=e.createDocumentFragment(t);}})),this.listenTo(s,"contentInsertion",((e,i)=>{"paste"===i.method&&t.change((e=>{const t=e.createRangeIn(i.content);for(const e of t.getItems())e.is("element","imageBlock")&&n.setImageNaturalSizeAttributes(e);}));}));}}class hT extends wf{focusTracker;keystrokes;_focusables;_focusCycler;children;constructor(e,t=[]){super(e),this.focusTracker=new Pa,this.keystrokes=new Va,this._focusables=new Zg,this.children=this.createCollection(),this._focusCycler=new If({focusables:this._focusables,focusTracker:this.focusTracker,keystrokeHandler:this.keystrokes,actions:{focusPrevious:"shift + tab",focusNext:"tab"}});for(const e of t)this.children.add(e),this._focusables.add(e),e instanceof tp&&this._focusables.addMany(e.children);this.setTemplate({tag:"form",attributes:{class:["ck","ck-image-insert-form"],tabindex:-1},children:this.children});}render(){super.render(),kf({view:this});for(const e of this._focusables)this.focusTracker.add(e.element);this.keystrokes.listenTo(this.element);const e=e=>e.stopPropagation();this.keystrokes.set("arrowright",e),this.keystrokes.set("arrowleft",e),this.keystrokes.set("arrowup",e),this.keystrokes.set("arrowdown",e);}destroy(){super.destroy(),this.focusTracker.destroy(),this.keystrokes.destroy();}focus(){this._focusCycler.focusFirst();}}class uT extends Ga{static get pluginName(){return "ImageInsertUI"}static get requires(){return [jE]}dropdownView;_integrations=new Map;constructor(e){super(e),e.config.define("image.insert.integrations",["upload","assetManager","url"]);}init(){const e=this.editor,t=e.model.document.selection,i=e.plugins.get("ImageUtils");this.set("isImageSelected",!1),this.listenTo(e.model.document,"change",(()=>{this.isImageSelected=i.isImage(t.getSelectedElement());}));const n=e=>this._createToolbarComponent(e);e.ui.componentFactory.add("insertImage",n),e.ui.componentFactory.add("imageInsert",n),e.ui.componentFactory.add("menuBar:insertImage",(e=>this._createMenuBarComponent(e)));}registerIntegration({name:e,observable:t,buttonViewCreator:i,formViewCreator:n,menuBarButtonViewCreator:s,requiresForm:o=!1}){this._integrations.has(e)&&T("image-insert-integration-exists",{name:e}),this._integrations.set(e,{observable:t,buttonViewCreator:i,menuBarButtonViewCreator:s,formViewCreator:n,requiresForm:o});}_createToolbarComponent(e){const t=this.editor,i=e.t,n=this._prepareIntegrations();if(!n.length)return null;let s;const o=n[0];if(1==n.length){if(!o.requiresForm)return o.buttonViewCreator(!0);s=o.buttonViewCreator(!0);}else {const t=o.buttonViewCreator(!1);s=new ab(e,t),s.tooltip=!0,s.bind("label").to(this,"isImageSelected",(e=>i(e?"Replace image":"Insert image")));}const r=this.dropdownView=lb(e,s),a=n.map((({observable:e})=>"function"==typeof e?e():e));return r.bind("isEnabled").toMany(a,"isEnabled",((...e)=>e.some((e=>e)))),r.once("change:isOpen",(()=>{const e=n.map((({formViewCreator:e})=>e(1==n.length))),i=new hT(t.locale,e);r.panelView.children.add(i);})),r}_createMenuBarComponent(e){const t=e.t,i=this._prepareIntegrations();if(!i.length)return null;let n;const s=i[0];if(1==i.length)n=s.menuBarButtonViewCreator(!0);else {n=new w_(e);const s=new __(e);n.panelView.children.add(s),n.buttonView.set({icon:Ig.image,label:t("Image")});for(const t of i){const i=new kw(e,n),o=t.menuBarButtonViewCreator(!1);i.children.add(o),s.items.add(i);}}return n}_prepareIntegrations(){const e=this.editor.config.get("image.insert.integrations"),t=[];if(!e.length)return T("image-insert-integrations-not-specified"),t;for(const i of e)this._integrations.has(i)?t.push(this._integrations.get(i)):["upload","assetManager","url"].includes(i)||T("image-insert-unknown-integration",{item:i});return t.length||T("image-insert-integrations-not-registered"),t}}class mT extends Ga{static get requires(){return [dT,Nk,eT,uT]}static get pluginName(){return "ImageBlock"}}class gT extends Ga{static get requires(){return [rT,aT,jE,cT,ak]}static get pluginName(){return "ImageInlineEditing"}init(){const e=this.editor;e.model.schema.register("imageInline",{inheritAllFrom:"$inlineObject",allowAttributes:["alt","src","srcset"],disallowIn:["caption"]}),this._setupConversion(),e.plugins.has("ImageBlockEditing")&&(e.commands.add("imageTypeInline",new lT(this.editor,"imageInline")),this._setupClipboardIntegration());}_setupConversion(){const e=this.editor,t=e.t,i=e.conversion,n=e.plugins.get("ImageUtils");i.for("dataDowncast").elementToElement({model:"imageInline",view:(e,{writer:t})=>t.createEmptyElement("img")}),i.for("editingDowncast").elementToStructure({model:"imageInline",view:(e,{writer:i})=>n.toImageWidget(function(e){return e.createContainerElement("span",{class:"image-inline"},e.createEmptyElement("img"))}(i),i,t("image widget"))}),i.for("downcast").add(iT(n,"imageInline","src")).add(iT(n,"imageInline","alt")).add(tT(n,"imageInline")),i.for("upcast").elementToElement({view:zE(e,"imageInline"),model:(e,{writer:t})=>t.createElement("imageInline",e.hasAttribute("src")?{src:e.getAttribute("src")}:void 0)});}_setupClipboardIntegration(){const e=this.editor,t=e.model,i=e.editing.view,n=e.plugins.get("ImageUtils"),s=e.plugins.get("ClipboardPipeline");this.listenTo(s,"inputTransformation",((s,o)=>{const r=Array.from(o.content.getChildren());let a;if(!r.every(n.isBlockImageView))return;a=o.targetRanges?e.editing.mapper.toModelRange(o.targetRanges[0]):t.document.selection.getFirstRange();const l=t.createSelection(a);if("imageInline"===HE(t.schema,l)){const e=new em(i.document),t=r.map((t=>1===t.childCount?(Array.from(t.getAttributes()).forEach((i=>e.setAttribute(...i,n.findViewImgElement(t)))),t.getChild(0)):t));o.content=e.createDocumentFragment(t);}})),this.listenTo(s,"contentInsertion",((e,i)=>{"paste"===i.method&&t.change((e=>{const t=e.createRangeIn(i.content);for(const e of t.getItems())e.is("element","imageInline")&&n.setImageNaturalSizeAttributes(e);}));}));}}class fT extends Ga{static get requires(){return [gT,Nk,eT,uT]}static get pluginName(){return "ImageInline"}}class pT extends Ga{static get requires(){return [mT,fT]}static get pluginName(){return "Image"}}class bT extends Ga{static get pluginName(){return "ImageCaptionUtils"}static get requires(){return [jE]}getCaptionFromImageModelElement(e){for(const t of e.getChildren())if(t&&t.is("element","caption"))return t;return null}getCaptionFromModelSelection(e){const t=this.editor.plugins.get("ImageUtils"),i=e.getFirstPosition().findAncestor("caption");return i&&t.isBlockImage(i.parent)?i:null}matchImageCaptionViewElement(e){const t=this.editor.plugins.get("ImageUtils");return "figcaption"==e.name&&t.isBlockImageView(e.parent)?{name:!0}:null}}class wT extends Za{refresh(){const e=this.editor,t=e.plugins.get("ImageCaptionUtils"),i=e.plugins.get("ImageUtils");if(!e.plugins.has(dT))return this.isEnabled=!1,void(this.value=!1);const n=e.model.document.selection,s=n.getSelectedElement();if(!s){const e=t.getCaptionFromModelSelection(n);return this.isEnabled=!!e,void(this.value=!!e)}this.isEnabled=i.isImage(s),this.isEnabled?this.value=!!t.getCaptionFromImageModelElement(s):this.value=!1;}execute(e={}){const{focusCaptionOnShow:t}=e;this.editor.model.change((e=>{this.value?this._hideImageCaption(e):this._showImageCaption(e,t);}));}_showImageCaption(e,t){const i=this.editor.model.document.selection,n=this.editor.plugins.get("ImageCaptionEditing"),s=this.editor.plugins.get("ImageUtils");let o=i.getSelectedElement();const r=n._getSavedCaption(o);s.isInlineImage(o)&&(this.editor.execute("imageTypeBlock"),o=i.getSelectedElement());const a=r||e.createElement("caption");e.append(a,o),t&&e.setSelection(a,"in");}_hideImageCaption(e){const t=this.editor,i=t.model.document.selection,n=t.plugins.get("ImageCaptionEditing"),s=t.plugins.get("ImageCaptionUtils");let o,r=i.getSelectedElement();r?o=s.getCaptionFromImageModelElement(r):(o=s.getCaptionFromModelSelection(i),r=o.parent),n._saveCaption(r,o),e.setSelection(r,"on"),e.remove(o);}}class _T extends Ga{static get requires(){return [jE,bT]}static get pluginName(){return "ImageCaptionEditing"}_savedCaptionsMap;constructor(e){super(e),this._savedCaptionsMap=new WeakMap;}init(){const e=this.editor,t=e.model.schema;t.isRegistered("caption")?t.extend("caption",{allowIn:"imageBlock"}):t.register("caption",{allowIn:"imageBlock",allowContentOf:"$block",isLimit:!0}),e.commands.add("toggleImageCaption",new wT(this.editor)),this._setupConversion(),this._setupImageTypeCommandsIntegration(),this._registerCaptionReconversion();}_setupConversion(){const e=this.editor,t=e.editing.view,i=e.plugins.get("ImageUtils"),n=e.plugins.get("ImageCaptionUtils"),s=e.t;e.conversion.for("upcast").elementToElement({view:e=>n.matchImageCaptionViewElement(e),model:"caption"}),e.conversion.for("dataDowncast").elementToElement({model:"caption",view:(e,{writer:t})=>i.isBlockImage(e.parent)?t.createContainerElement("figcaption"):null}),e.conversion.for("editingDowncast").elementToElement({model:"caption",view:(e,{writer:n})=>{if(!i.isBlockImage(e.parent))return null;const o=n.createEditableElement("figcaption");n.setCustomProperty("imageCaption",!0,o),o.placeholder=s("Enter image caption"),nl({view:t,element:o,keepOnFocus:!0});const r=e.parent.getAttribute("alt");return kk(o,n,{label:r?s("Caption for image: %0",[r]):s("Caption for the image")})}});}_setupImageTypeCommandsIntegration(){const e=this.editor,t=e.plugins.get("ImageUtils"),i=e.plugins.get("ImageCaptionUtils"),n=e.commands.get("imageTypeInline"),s=e.commands.get("imageTypeBlock"),o=e=>{if(!e.return)return;const{oldElement:n,newElement:s}=e.return;if(!n)return;if(t.isBlockImage(n)){const e=i.getCaptionFromImageModelElement(n);if(e)return void this._saveCaption(s,e)}const o=this._getSavedCaption(n);o&&this._saveCaption(s,o);};n&&this.listenTo(n,"execute",o,{priority:"low"}),s&&this.listenTo(s,"execute",o,{priority:"low"});}_getSavedCaption(e){const t=this._savedCaptionsMap.get(e);return t?td.fromJSON(t):null}_saveCaption(e,t){this._savedCaptionsMap.set(e,t.toJSON());}_registerCaptionReconversion(){const e=this.editor,t=e.model,i=e.plugins.get("ImageUtils"),n=e.plugins.get("ImageCaptionUtils");t.document.on("change:data",(()=>{const s=t.document.differ.getChanges();for(const t of s){if("alt"!==t.attributeKey)continue;const s=t.range.start.nodeAfter;if(i.isBlockImage(s)){const t=n.getCaptionFromImageModelElement(s);if(!t)return;e.editing.reconvertItem(t);}}}));}}class vT extends Ga{static get requires(){return [bT]}static get pluginName(){return "ImageCaptionUI"}init(){const e=this.editor,t=e.editing.view,i=e.plugins.get("ImageCaptionUtils"),n=e.t;e.ui.componentFactory.add("toggleImageCaption",(s=>{const o=e.commands.get("toggleImageCaption"),r=new Ef(s);return r.set({icon:Ig.caption,tooltip:!0,isToggleable:!0}),r.bind("isOn","isEnabled").to(o,"value","isEnabled"),r.bind("label").to(o,"value",(e=>n(e?"Toggle caption off":"Toggle caption on"))),this.listenTo(r,"execute",(()=>{e.execute("toggleImageCaption",{focusCaptionOnShow:!0});const n=i.getCaptionFromModelSelection(e.model.document.selection);if(n){const i=e.editing.mapper.toViewElement(n);t.scrollToTheSelection(),t.change((e=>{e.addClass("image__caption_highlighted",i);}));}e.editing.view.focus();})),r}));}}class yT extends Ga{static get requires(){return [_T,vT]}static get pluginName(){return "ImageCaption"}}function kT(e){const t=e.map((e=>e.replace("+","\\+")));return new RegExp(`^image\\/(${t.join("|")})$`)}function CT(e){return new Promise(((t,n)=>{const s=e.getAttribute("src");fetch(s).then((e=>e.blob())).then((e=>{const i=xT(e,s),n=i.replace("image/",""),o=new File([e],`image.${n}`,{type:i});t(o);})).catch((e=>e&&"TypeError"===e.name?function(e){return function(e){return new Promise(((t,n)=>{const s=i.document.createElement("img");s.addEventListener("load",(()=>{const e=i.document.createElement("canvas");e.width=s.width,e.height=s.height;e.getContext("2d").drawImage(s,0,0),e.toBlob((e=>e?t(e):n()));})),s.addEventListener("error",(()=>n())),s.src=e;}))}(e).then((t=>{const i=xT(t,e),n=i.replace("image/","");return new File([t],`image.${n}`,{type:i})}))}(s).then(t).catch(n):n(e)));}))}function xT(e,t){return e.type?e.type:t.match(/data:(image\/\w+);base64/)?t.match(/data:(image\/\w+);base64/)[1].toLowerCase():"image/jpeg"}class AT extends Ga{static get pluginName(){return "ImageUploadUI"}init(){const e=this.editor;e.ui.componentFactory.add("uploadImage",(()=>this._createToolbarButton())),e.ui.componentFactory.add("imageUpload",(()=>this._createToolbarButton())),e.ui.componentFactory.add("menuBar:uploadImage",(()=>this._createMenuBarButton("standalone"))),e.plugins.has("ImageInsertUI")&&e.plugins.get("ImageInsertUI").registerIntegration({name:"upload",observable:()=>e.commands.get("uploadImage"),buttonViewCreator:()=>this._createToolbarButton(),formViewCreator:()=>this._createDropdownButton(),menuBarButtonViewCreator:e=>this._createMenuBarButton(e?"insertOnly":"insertNested")});}_createButton(e){const t=this.editor,i=t.locale,n=t.commands.get("uploadImage"),s=t.config.get("image.upload.types"),o=kT(s),r=new e(t.locale),a=i.t;return r.set({acceptedType:s.map((e=>`image/${e}`)).join(","),allowMultipleFiles:!0,label:a("Upload from computer"),icon:Ig.imageUpload}),r.bind("isEnabled").to(n),r.on("done",((e,i)=>{const n=Array.from(i).filter((e=>o.test(e.type)));n.length&&(t.execute("uploadImage",{file:n}),t.editing.view.focus());})),r}_createToolbarButton(){const e=this.editor.locale.t,t=this.editor.plugins.get("ImageInsertUI"),i=this.editor.commands.get("uploadImage"),n=this._createButton(Jf);return n.tooltip=!0,n.bind("label").to(t,"isImageSelected",i,"isAccessAllowed",((t,i)=>e(i?t?"Replace image from computer":"Upload image from computer":"You have no image upload permissions."))),n}_createDropdownButton(){const e=this.editor.locale.t,t=this.editor.plugins.get("ImageInsertUI"),i=this._createButton(Jf);return i.withText=!0,i.bind("label").to(t,"isImageSelected",(t=>e(t?"Replace from computer":"Upload from computer"))),i.on("execute",(()=>{t.dropdownView.isOpen=!1;})),i}_createMenuBarButton(e){const t=this.editor.locale.t,i=this._createButton(y_);switch(i.withText=!0,e){case"standalone":i.label=t("Image from computer");break;case"insertOnly":i.label=t("Image");break;case"insertNested":i.label=t("From computer");}return i}}class ET extends Ga{static get pluginName(){return "ImageUploadProgress"}placeholder;constructor(e){super(e),this.placeholder="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==";}init(){const e=this.editor;e.plugins.has("ImageBlockEditing")&&e.editing.downcastDispatcher.on("attribute:uploadStatus:imageBlock",this.uploadStatusChange),e.plugins.has("ImageInlineEditing")&&e.editing.downcastDispatcher.on("attribute:uploadStatus:imageInline",this.uploadStatusChange);}uploadStatusChange=(e,t,i)=>{const n=this.editor,s=t.item,o=s.getAttribute("uploadId");if(!i.consumable.consume(t.item,e.name))return;const r=n.plugins.get("ImageUtils"),a=n.plugins.get(Vg),l=o?t.attributeNewValue:null,c=this.placeholder,d=n.editing.mapper.toViewElement(s),h=i.writer;if("reading"==l)return TT(d,h),void ST(r,c,d,h);if("uploading"==l){const e=a.loaders.get(o);return TT(d,h),void(e?(IT(d,h),function(e,t,i,n){const s=function(e){const t=e.createUIElement("div",{class:"ck-progress-bar"});return e.setCustomProperty("progressBar",!0,t),t}(t);t.insert(t.createPositionAt(e,"end"),s),i.on("change:uploadedPercent",((e,t,i)=>{n.change((e=>{e.setStyle("width",i+"%",s);}));}));}(d,h,e,n.editing.view),function(e,t,i,n){if(n.data){const s=e.findViewImgElement(t);i.setAttribute("src",n.data,s);}}(r,d,h,e)):ST(r,c,d,h))}"complete"==l&&a.loaders.get(o)&&function(e,t,i){const n=t.createUIElement("div",{class:"ck-image-upload-complete-icon"});t.insert(t.createPositionAt(e,"end"),n),setTimeout((()=>{i.change((e=>e.remove(e.createRangeOn(n))));}),3e3);}(d,h,n.editing.view),function(e,t){VT(e,t,"progressBar");}(d,h),IT(d,h),function(e,t){t.removeClass("ck-appear",e);}(d,h);}}function TT(e,t){e.hasClass("ck-appear")||t.addClass("ck-appear",e);}function ST(e,t,i,n){i.hasClass("ck-image-upload-placeholder")||n.addClass("ck-image-upload-placeholder",i);const s=e.findViewImgElement(i);s.getAttribute("src")!==t&&n.setAttribute("src",t,s),PT(i,"placeholder")||n.insert(n.createPositionAfter(s),function(e){const t=e.createUIElement("div",{class:"ck-upload-placeholder-loader"});return e.setCustomProperty("placeholder",!0,t),t}(n));}function IT(e,t){e.hasClass("ck-image-upload-placeholder")&&t.removeClass("ck-image-upload-placeholder",e),VT(e,t,"placeholder");}function PT(e,t){for(const i of e.getChildren())if(i.getCustomProperty(t))return i}function VT(e,t,i){const n=PT(e,i);n&&t.remove(t.createRangeOn(n));}class RT extends Za{constructor(e){super(e),this.set("isAccessAllowed",!0);}refresh(){const e=this.editor,t=e.plugins.get("ImageUtils"),i=e.model.document.selection.getSelectedElement();this.isEnabled=t.isImageAllowed()||t.isImage(i);}execute(e){const t=Aa(e.file),i=this.editor.model.document.selection,n=this.editor.plugins.get("ImageUtils"),s=Object.fromEntries(i.getAttributes());t.forEach(((e,t)=>{const o=i.getSelectedElement();if(t&&o&&n.isImage(o)){const t=this.editor.model.createPositionAfter(o);this._uploadImage(e,s,t);}else this._uploadImage(e,s);}));}_uploadImage(e,t,i){const n=this.editor,s=n.plugins.get(Vg).createLoader(e),o=n.plugins.get("ImageUtils");s&&o.insertImage({...t,uploadId:s.id},i);}}class BT extends Ga{static get requires(){return [Vg,Gw,ak,jE]}static get pluginName(){return "ImageUploadEditing"}_uploadImageElements;constructor(e){super(e),e.config.define("image",{upload:{types:["jpeg","png","gif","bmp","webp","tiff"]}}),this._uploadImageElements=new Map;}init(){const e=this.editor,t=e.model.document,i=e.conversion,n=e.plugins.get(Vg),s=e.plugins.get("ImageUtils"),o=e.plugins.get("ClipboardPipeline"),r=kT(e.config.get("image.upload.types")),a=new RT(e);e.commands.add("uploadImage",a),e.commands.add("imageUpload",a),i.for("upcast").attributeToAttribute({view:{name:"img",key:"uploadId"},model:"uploadId"}),this.listenTo(e.editing.view.document,"clipboardInput",((t,i)=>{if(n=i.dataTransfer,Array.from(n.types).includes("text/html")&&""!==n.getData("text/html"))return;var n;const s=Array.from(i.dataTransfer.files).filter((e=>!!e&&r.test(e.type)));if(!s.length)return;t.stop(),e.model.change((t=>{i.targetRanges&&t.setSelection(i.targetRanges.map((t=>e.editing.mapper.toModelRange(t)))),e.execute("uploadImage",{file:s});}));if(!e.commands.get("uploadImage").isAccessAllowed){const t=e.plugins.get("Notification"),i=e.locale.t;t.showWarning(i("You have no image upload permissions."),{namespace:"image"});}})),this.listenTo(o,"inputTransformation",((t,i)=>{const o=Array.from(e.editing.view.createRangeIn(i.content)).map((e=>e.item)).filter((e=>function(e,t){return !(!e.isInlineImageView(t)||!t.getAttribute("src")||!t.getAttribute("src").match(/^data:image\/\w+;base64,/g)&&!t.getAttribute("src").match(/^blob:/g))}(s,e)&&!e.getAttribute("uploadProcessed"))).map((e=>({promise:CT(e),imageElement:e})));if(!o.length)return;const r=new em(e.editing.view.document);for(const e of o){r.setAttribute("uploadProcessed",!0,e.imageElement);const t=n.createLoader(e.promise);t&&(r.setAttribute("src","",e.imageElement),r.setAttribute("uploadId",t.id,e.imageElement));}})),e.editing.view.document.on("dragover",((e,t)=>{t.preventDefault();})),t.on("change",(()=>{const i=t.differ.getChanges({includeChangesInGraveyard:!0}).reverse(),s=new Set;for(const t of i)if("insert"==t.type&&"$text"!=t.name){const i=t.position.nodeAfter,o="$graveyard"==t.position.root.rootName;for(const t of OT(e,i)){const e=t.getAttribute("uploadId");if(!e)continue;const i=n.loaders.get(e);i&&(o?s.has(e)||i.abort():(s.add(e),this._uploadImageElements.set(e,t),"idle"==i.status&&this._readAndUpload(i)));}}})),this.on("uploadComplete",((e,{imageElement:t,data:i})=>{const n=i.urls?i.urls:i;this.editor.model.change((e=>{e.setAttribute("src",n.default,t),this._parseAndSetSrcsetAttributeOnImage(n,t,e),s.setImageNaturalSizeAttributes(t);}));}),{priority:"low"});}afterInit(){const e=this.editor.model.schema;this.editor.plugins.has("ImageBlockEditing")&&e.extend("imageBlock",{allowAttributes:["uploadId","uploadStatus"]}),this.editor.plugins.has("ImageInlineEditing")&&e.extend("imageInline",{allowAttributes:["uploadId","uploadStatus"]});}_readAndUpload(e){const t=this.editor,i=t.model,n=t.locale.t,s=t.plugins.get(Vg),r=t.plugins.get(Gw),a=t.plugins.get("ImageUtils"),l=this._uploadImageElements;return i.enqueueChange({isUndoable:!1},(t=>{t.setAttribute("uploadStatus","reading",l.get(e.id));})),e.read().then((()=>{const s=e.upload(),r=l.get(e.id);if(o.isSafari){const e=t.editing.mapper.toViewElement(r),i=a.findViewImgElement(e);t.editing.view.once("render",(()=>{if(!i.parent)return;const e=t.editing.view.domConverter.mapViewToDom(i.parent);if(!e)return;const n=e.style.display;e.style.display="none",e._ckHack=e.offsetHeight,e.style.display=n;}));}return t.ui&&t.ui.ariaLiveAnnouncer.announce(n("Uploading image")),i.enqueueChange({isUndoable:!1},(e=>{e.setAttribute("uploadStatus","uploading",r);})),s})).then((s=>{i.enqueueChange({isUndoable:!1},(i=>{const o=l.get(e.id);i.setAttribute("uploadStatus","complete",o),t.ui&&t.ui.ariaLiveAnnouncer.announce(n("Image upload complete")),this.fire("uploadComplete",{data:s,imageElement:o});})),c();})).catch((s=>{if(t.ui&&t.ui.ariaLiveAnnouncer.announce(n("Error during image upload")),"error"!==e.status&&"aborted"!==e.status)throw s;"error"==e.status&&s&&r.showWarning(s,{title:n("Upload failed"),namespace:"upload"}),i.enqueueChange({isUndoable:!1},(t=>{t.remove(l.get(e.id));})),c();}));function c(){i.enqueueChange({isUndoable:!1},(t=>{const i=l.get(e.id);t.removeAttribute("uploadId",i),t.removeAttribute("uploadStatus",i),l.delete(e.id);})),s.destroyLoader(e);}}_parseAndSetSrcsetAttributeOnImage(e,t,i){let n=0;const s=Object.keys(e).filter((e=>{const t=parseInt(e,10);if(!isNaN(t))return n=Math.max(n,t),!0})).map((t=>`${e[t]} ${t}w`)).join(", ");if(""!=s){const e={srcset:s};t.hasAttribute("width")||t.hasAttribute("height")||(e.width=n),i.setAttributes(e,t);}}}function OT(e,t){const i=e.plugins.get("ImageUtils");return Array.from(e.model.createRangeOn(t)).filter((e=>i.isImage(e.item))).map((e=>e.item))}class MT extends Ga{static get pluginName(){return "ImageUpload"}static get requires(){return [BT,AT,ET]}}class LT extends wf{urlInputView;keystrokes;constructor(e){super(e),this.set("imageURLInputValue",""),this.set("isImageSelected",!1),this.set("isEnabled",!0),this.keystrokes=new Va,this.urlInputView=this._createUrlInputView(),this.setTemplate({tag:"div",attributes:{class:["ck","ck-image-insert-url"]},children:[this.urlInputView,{tag:"div",attributes:{class:["ck","ck-image-insert-url__action-row"]}}]});}render(){super.render(),this.keystrokes.listenTo(this.element);}destroy(){super.destroy(),this.keystrokes.destroy();}_createUrlInputView(){const e=this.locale,t=e.t,i=new Ap(e,bb);return i.bind("label").to(this,"isImageSelected",(e=>t(e?"Update image URL":"Insert image via URL"))),i.bind("isEnabled").to(this),i.fieldView.inputMode="url",i.fieldView.placeholder="https://example.com/image.png",i.fieldView.bind("value").to(this,"imageURLInputValue",(e=>e||"")),i.fieldView.on("input",(()=>{this.imageURLInputValue=i.fieldView.element.value.trim();})),i}focus(){this.urlInputView.focus();}}class FT extends Ga{_imageInsertUI;_formView;static get pluginName(){return "ImageInsertViaUrlUI"}static get requires(){return [uT,Df]}init(){this.editor.ui.componentFactory.add("insertImageViaUrl",(()=>this._createToolbarButton())),this.editor.ui.componentFactory.add("menuBar:insertImageViaUrl",(()=>this._createMenuBarButton("standalone")));}afterInit(){this._imageInsertUI=this.editor.plugins.get("ImageInsertUI"),this._imageInsertUI.registerIntegration({name:"url",observable:()=>this.editor.commands.get("insertImage"),buttonViewCreator:()=>this._createToolbarButton(),formViewCreator:()=>this._createDropdownButton(),menuBarButtonViewCreator:e=>this._createMenuBarButton(e?"insertOnly":"insertNested")});}_createInsertUrlButton(e){const t=new e(this.editor.locale);return t.icon=Ig.imageUrl,t.on("execute",(()=>{this._showModal();})),t}_createToolbarButton(){const e=this.editor.locale.t,t=this._createInsertUrlButton(Ef);return t.tooltip=!0,t.bind("label").to(this._imageInsertUI,"isImageSelected",(t=>e(t?"Update image URL":"Insert image via URL"))),t}_createDropdownButton(){const e=this.editor.locale.t,t=this._createInsertUrlButton(Ef);return t.withText=!0,t.bind("label").to(this._imageInsertUI,"isImageSelected",(t=>e(t?"Update image URL":"Insert via URL"))),t}_createMenuBarButton(e){const t=this.editor.locale.t,i=this._createInsertUrlButton($f);switch(i.withText=!0,e){case"standalone":i.label=t("Image via URL");break;case"insertOnly":i.label=t("Image");break;case"insertNested":i.label=t("Via URL");}return i}_createInsertUrlView(){const e=this.editor,t=e.locale,i=e.commands.get("replaceImageSource"),n=e.commands.get("insertImage"),s=new LT(t);return s.bind("isImageSelected").to(this._imageInsertUI),s.bind("isEnabled").toMany([n,i],"isEnabled",((...e)=>e.some((e=>e)))),s}_showModal(){const e=this.editor,t=e.locale.t,i=e.plugins.get("Dialog");this._formView||(this._formView=this._createInsertUrlView(),this._formView.on("submit",(()=>this._handleSave())));const n=e.commands.get("replaceImageSource");this._formView.imageURLInputValue=n.value||"",i.show({id:"insertImageViaUrl",title:this._imageInsertUI.isImageSelected?t("Update image URL"):t("Insert image via URL"),isModal:!0,content:this._formView,actionButtons:[{label:t("Cancel"),withText:!0,onExecute:()=>i.hide()},{label:t("Accept"),class:"ck-button-action",withText:!0,onExecute:()=>this._handleSave()}]});}_handleSave(){this.editor.commands.get("replaceImageSource").isEnabled?this.editor.execute("replaceImageSource",{source:this._formView.imageURLInputValue}):this.editor.execute("insertImage",{source:this._formView.imageURLInputValue}),this.editor.plugins.get("Dialog").hide();}}class NT extends Ga{static get pluginName(){return "ImageInsertViaUrl"}static get requires(){return [FT,uT]}}class DT extends Ga{static get pluginName(){return "ImageInsert"}static get requires(){return [MT,NT,uT]}}class zT extends Za{refresh(){const e=this.editor,t=e.plugins.get("ImageUtils").getClosestSelectedImageElement(e.model.document.selection);this.isEnabled=!!t,t&&t.hasAttribute("resizedWidth")?this.value={width:t.getAttribute("resizedWidth"),height:null}:this.value=null;}execute(e){const t=this.editor,i=t.model,n=t.plugins.get("ImageUtils"),s=n.getClosestSelectedImageElement(i.document.selection);this.value={width:e.width,height:null},s&&i.change((t=>{t.setAttribute("resizedWidth",e.width,s),t.removeAttribute("resizedHeight",s),n.setImageNaturalSizeAttributes(s);}));}}class HT extends Ga{static get requires(){return [jE]}static get pluginName(){return "ImageResizeEditing"}constructor(e){super(e),e.config.define("image",{resizeUnit:"%",resizeOptions:[{name:"resizeImage:original",value:null,icon:"original"},{name:"resizeImage:custom",value:"custom",icon:"custom"},{name:"resizeImage:25",value:"25",icon:"small"},{name:"resizeImage:50",value:"50",icon:"medium"},{name:"resizeImage:75",value:"75",icon:"large"}]});}init(){const e=this.editor,t=new zT(e);this._registerConverters("imageBlock"),this._registerConverters("imageInline"),e.commands.add("resizeImage",t),e.commands.add("imageResize",t);}afterInit(){this._registerSchema();}_registerSchema(){this.editor.plugins.has("ImageBlockEditing")&&this.editor.model.schema.extend("imageBlock",{allowAttributes:["resizedWidth","resizedHeight"]}),this.editor.plugins.has("ImageInlineEditing")&&this.editor.model.schema.extend("imageInline",{allowAttributes:["resizedWidth","resizedHeight"]});}_registerConverters(e){const t=this.editor,i=t.plugins.get("ImageUtils");t.conversion.for("downcast").add((t=>t.on(`attribute:resizedWidth:${e}`,((e,t,i)=>{if(!i.consumable.consume(t.item,e.name))return;const n=i.writer,s=i.mapper.toViewElement(t.item);null!==t.attributeNewValue?(n.setStyle("width",t.attributeNewValue,s),n.addClass("image_resized",s)):(n.removeStyle("width",s),n.removeClass("image_resized",s));})))),t.conversion.for("dataDowncast").attributeToAttribute({model:{name:e,key:"resizedHeight"},view:e=>({key:"style",value:{height:e}})}),t.conversion.for("editingDowncast").add((t=>t.on(`attribute:resizedHeight:${e}`,((t,n,s)=>{if(!s.consumable.consume(n.item,t.name))return;const o=s.writer,r=s.mapper.toViewElement(n.item),a="imageInline"===e?i.findViewImgElement(r):r;null!==n.attributeNewValue?o.setStyle("height",n.attributeNewValue,a):o.removeStyle("height",a);})))),t.conversion.for("upcast").attributeToAttribute({view:{name:"imageBlock"===e?"figure":"img",styles:{width:/.+/}},model:{key:"resizedWidth",value:e=>UE(e)?null:e.getStyle("width")}}),t.conversion.for("upcast").attributeToAttribute({view:{name:"imageBlock"===e?"figure":"img",styles:{height:/.+/}},model:{key:"resizedHeight",value:e=>UE(e)?null:e.getStyle("height")}});}}const $T=(()=>({small:Ig.objectSizeSmall,medium:Ig.objectSizeMedium,large:Ig.objectSizeLarge,custom:Ig.objectSizeCustom,original:Ig.objectSizeFull}))();class UT extends Ga{static get requires(){return [HT]}static get pluginName(){return "ImageResizeButtons"}_resizeUnit;constructor(e){super(e),this._resizeUnit=e.config.get("image.resizeUnit");}init(){const e=this.editor,t=e.config.get("image.resizeOptions"),i=e.commands.get("resizeImage");this.bind("isEnabled").to(i);for(const e of t)this._registerImageResizeButton(e);this._registerImageResizeDropdown(t);}_registerImageResizeButton(e){const t=this.editor,{name:i,value:n,icon:s}=e;t.ui.componentFactory.add(i,(i=>{const o=new Ef(i),r=t.commands.get("resizeImage"),a=this._getOptionLabelValue(e,!0);if(!$T[s])throw new E("imageresizebuttons-missing-icon",t,e);if(o.set({label:a,icon:$T[s],tooltip:a,isToggleable:!0}),o.bind("isEnabled").to(this),t.plugins.has("ImageCustomResizeUI")&&WT(e)){const e=t.plugins.get("ImageCustomResizeUI");this.listenTo(o,"execute",(()=>{e._showForm(this._resizeUnit);}));}else {const e=n?n+this._resizeUnit:null;o.bind("isOn").to(r,"value",jT(e)),this.listenTo(o,"execute",(()=>{t.execute("resizeImage",{width:e});}));}return o}));}_registerImageResizeDropdown(e){const t=this.editor,i=t.t,n=e.find((e=>!e.value)),s=s=>{const o=t.commands.get("resizeImage"),r=lb(s,Op),a=r.buttonView,l=i("Resize image");return a.set({tooltip:l,commandValue:n.value,icon:$T.medium,isToggleable:!0,label:this._getOptionLabelValue(n),withText:!0,class:"ck-resize-image-button",ariaLabel:l,ariaLabelledBy:void 0}),a.bind("label").to(o,"value",(e=>e&&e.width?e.width:this._getOptionLabelValue(n))),r.bind("isEnabled").to(this),mb(r,(()=>this._getResizeDropdownListItemDefinitions(e,o)),{ariaLabel:i("Image resize list"),role:"menu"}),this.listenTo(r,"execute",(e=>{"onClick"in e.source?e.source.onClick():(t.execute(e.source.commandName,{width:e.source.commandValue}),t.editing.view.focus());})),r};t.ui.componentFactory.add("resizeImage",s),t.ui.componentFactory.add("imageResize",s);}_getOptionLabelValue(e,t=!1){const i=this.editor.t;return e.label?e.label:t?WT(e)?i("Custom image size"):e.value?i("Resize image to %0",e.value+this._resizeUnit):i("Resize image to the original size"):WT(e)?i("Custom"):e.value?e.value+this._resizeUnit:i("Original")}_getResizeDropdownListItemDefinitions(e,t){const{editor:i}=this,n=new Sa,s=e.map((e=>WT(e)?{...e,valueWithUnits:"custom"}:e.value?{...e,valueWithUnits:`${e.value}${this._resizeUnit}`}:{...e,valueWithUnits:null}));for(const e of s){let a=null;if(i.plugins.has("ImageCustomResizeUI")&&WT(e)){const n=i.plugins.get("ImageCustomResizeUI");a={type:"button",model:new Kw({label:this._getOptionLabelValue(e),role:"menuitemradio",withText:!0,icon:null,onClick:()=>{n._showForm(this._resizeUnit);}})};const l=(r="valueWithUnits",(le(o=s)?ae:Wo)(o,ko(r)));a.model.bind("isOn").to(t,"value",qT(l));}else a={type:"button",model:new Kw({commandName:"resizeImage",commandValue:e.valueWithUnits,label:this._getOptionLabelValue(e),role:"menuitemradio",withText:!0,icon:null})},a.model.bind("isOn").to(t,"value",jT(e.valueWithUnits));a.model.bind("isEnabled").to(t,"isEnabled"),n.add(a);}var o,r;return n}}function WT(e){return "custom"===e.value}function jT(e){return t=>null===e&&t===e||null!==t&&t.width===e}function qT(e){return t=>!e.some((e=>jT(e)(t)))}const GT="image_resized";class KT extends Ga{static get requires(){return [Gk,jE]}static get pluginName(){return "ImageResizeHandles"}init(){const e=this.editor.commands.get("resizeImage");this.bind("isEnabled").to(e),this._setupResizerCreator();}_setupResizerCreator(){const e=this.editor,t=e.editing.view,i=e.plugins.get("ImageUtils");t.addObserver(nT),this.listenTo(t.document,"imageLoaded",((n,s)=>{if(!s.target.matches("figure.image.ck-widget > img,figure.image.ck-widget > picture > img,figure.image.ck-widget > a > img,figure.image.ck-widget > a > picture > img,span.image-inline.ck-widget > img,span.image-inline.ck-widget > picture > img"))return;const o=e.editing.view.domConverter,r=o.domToView(s.target),a=i.getImageWidgetFromImageView(r);let l=this.editor.plugins.get(Gk).getResizerByViewElement(a);if(l)return void l.redraw();const c=e.editing.mapper,d=c.toModelElement(a);l=e.plugins.get(Gk).attachTo({unit:e.config.get("image.resizeUnit"),modelElement:d,viewElement:a,editor:e,getHandleHost:e=>e.querySelector("img"),getResizeHost:()=>o.mapViewToDom(c.toViewElement(d)),isCentered:()=>"alignCenter"==d.getAttribute("imageStyle"),onCommit(i){t.change((e=>{e.removeClass(GT,a);})),e.execute("resizeImage",{width:i});}}),l.on("updateSize",(()=>{a.hasClass(GT)||t.change((e=>{e.addClass(GT,a);}));const e="imageInline"===d.name?r:a;e.getStyle("height")&&t.change((t=>{t.removeStyle("height",e);}));})),l.bind("isEnabled").to(this);}));}}function ZT(e){if(!e)return null;const[,t,i]=e.trim().match(/([.,\d]+)(%|px)$/)||[],n=Number.parseFloat(t);return Number.isNaN(n)?null:{value:n,unit:i}}function JT(e,t,i){return "px"===i?{value:t.value,unit:"px"}:{value:t.value/e*100,unit:"%"}}function QT(e){const{editing:t}=e,i=e.plugins.get("ImageUtils").getClosestSelectedImageElement(e.model.document.selection);if(!i)return null;const n=t.mapper.toViewElement(i);return {model:i,view:n,dom:t.view.domConverter.mapViewToDom(n)}}class YT extends wf{focusTracker;keystrokes;unit;labeledInput;saveButtonView;cancelButtonView;_focusables;_focusCycler;_validators;constructor(e,t,i){super(e);const n=this.locale.t;this.focusTracker=new Pa,this.keystrokes=new Va,this.unit=t,this.labeledInput=this._createLabeledInputView(),this.saveButtonView=this._createButton(n("Save"),Ig.check,"ck-button-save"),this.saveButtonView.type="submit",this.cancelButtonView=this._createButton(n("Cancel"),Ig.cancel,"ck-button-cancel","cancel"),this._focusables=new Zg,this._validators=i,this._focusCycler=new If({focusables:this._focusables,focusTracker:this.focusTracker,keystrokeHandler:this.keystrokes,actions:{focusPrevious:"shift + tab",focusNext:"tab"}}),this.setTemplate({tag:"form",attributes:{class:["ck","ck-image-custom-resize-form","ck-responsive-form"],tabindex:"-1"},children:[this.labeledInput,this.saveButtonView,this.cancelButtonView]});}render(){super.render(),this.keystrokes.listenTo(this.element),kf({view:this}),[this.labeledInput,this.saveButtonView,this.cancelButtonView].forEach((e=>{this._focusables.add(e),this.focusTracker.add(e.element);}));}destroy(){super.destroy(),this.focusTracker.destroy(),this.keystrokes.destroy();}_createButton(e,t,i,n){const s=new Ef(this.locale);return s.set({label:e,icon:t,tooltip:!0}),s.extendTemplate({attributes:{class:i}}),n&&s.delegate("execute").to(this,n),s}_createLabeledInputView(){const e=this.locale.t,t=new Ap(this.locale,wb);return t.label=e("Resize image (in %0)",this.unit),t.fieldView.set({step:.1}),t}isValid(){this.resetFormStatus();for(const e of this._validators){const t=e(this);if(t)return this.labeledInput.errorText=t,!1}return !0}resetFormStatus(){this.labeledInput.errorText=null;}get rawSize(){const{element:e}=this.labeledInput.fieldView;return e?e.value:null}get parsedSize(){const{rawSize:e}=this;if(null===e)return null;const t=Number.parseFloat(e);return Number.isNaN(t)?null:t}get sizeWithUnits(){const{parsedSize:e,unit:t}=this;return null===e?null:`${e}${t}`}}class XT extends Ga{_balloon;_form;static get requires(){return [Jw]}static get pluginName(){return "ImageCustomResizeUI"}destroy(){super.destroy(),this._form&&this._form.destroy();}_createForm(e){const t=this.editor;this._balloon=this.editor.plugins.get("ContextualBalloon"),this._form=new(yf(YT))(t.locale,e,function(e){const t=e.t;return [e=>""===e.rawSize.trim()?t("The value must not be empty."):null===e.parsedSize?t("The value should be a plain number."):void 0]}(t)),this._form.render(),this.listenTo(this._form,"submit",(()=>{this._form.isValid()&&(t.execute("resizeImage",{width:this._form.sizeWithUnits}),this._hideForm(!0));})),this.listenTo(this._form.labeledInput,"change:errorText",(()=>{t.ui.update();})),this.listenTo(this._form,"cancel",(()=>{this._hideForm(!0);})),this._form.keystrokes.set("Esc",((e,t)=>{this._hideForm(!0),t();})),_f({emitter:this._form,activator:()=>this._isVisible,contextElements:()=>[this._balloon.view.element],callback:()=>this._hideForm()});}_showForm(e){if(this._isVisible)return;this._form||this._createForm(e);const t=this.editor,i=this._form.labeledInput;this._form.disableCssTransitions(),this._form.resetFormStatus(),this._isInBalloon||this._balloon.add({view:this._form,position:YE(t)});const n=function(e,t){const i=QT(e);if(!i)return null;const n=ZT(i.model.getAttribute("resizedWidth")||null);return n?n.unit===t?n:JT(Ek(i.dom),{unit:"px",value:new Fr(i.dom).width},t):null}(t,e),s=n?n.value.toFixed(1):"",o=function(e,t){const i=QT(e);if(!i)return null;const n=Ek(i.dom),s=ZT(window.getComputedStyle(i.dom).minWidth)||{value:1,unit:"px"};return {unit:t,lower:Math.max(.1,JT(n,s,t).value),upper:"px"===t?n:100}}(t,e);i.fieldView.value=i.fieldView.element.value=s,o&&Object.assign(i.fieldView,{min:o.lower.toFixed(1),max:Math.ceil(o.upper).toFixed(1)}),this._form.labeledInput.fieldView.select(),this._form.enableCssTransitions();}_hideForm(e=!1){this._isInBalloon&&(this._form.focusTracker.isFocused&&this._form.saveButtonView.focus(),this._balloon.remove(this._form),e&&this.editor.editing.view.focus());}get _isVisible(){return !!this._balloon&&this._balloon.visibleView===this._form}get _isInBalloon(){return !!this._balloon&&this._balloon.hasView(this._form)}}class eS extends Ga{static get requires(){return [HT,KT,XT,UT]}static get pluginName(){return "ImageResize"}}class tS extends Za{_defaultStyles;_styles;constructor(e,t){super(e),this._defaultStyles={imageBlock:!1,imageInline:!1},this._styles=new Map(t.map((e=>{if(e.isDefault)for(const t of e.modelElements)this._defaultStyles[t]=e.name;return [e.name,e]})));}refresh(){const e=this.editor.plugins.get("ImageUtils").getClosestSelectedImageElement(this.editor.model.document.selection);this.isEnabled=!!e,this.isEnabled?e.hasAttribute("imageStyle")?this.value=e.getAttribute("imageStyle"):this.value=this._defaultStyles[e.name]:this.value=!1;}execute(e={}){const t=this.editor,i=t.model,n=t.plugins.get("ImageUtils");i.change((t=>{const s=e.value,{setImageSizes:o=!0}=e;let r=n.getClosestSelectedImageElement(i.document.selection);s&&this.shouldConvertImageType(s,r)&&(this.editor.execute(n.isBlockImage(r)?"imageTypeInline":"imageTypeBlock",{setImageSizes:o}),r=n.getClosestSelectedImageElement(i.document.selection)),!s||this._styles.get(s).isDefault?t.removeAttribute("imageStyle",r):t.setAttribute("imageStyle",s,r),o&&n.setImageNaturalSizeAttributes(r);}));}shouldConvertImageType(e,t){return !this._styles.get(e).modelElements.includes(t.name)}}const iS={get inline(){return {name:"inline",title:"In line",icon:Ig.objectInline,modelElements:["imageInline"],isDefault:!0}},get alignLeft(){return {name:"alignLeft",title:"Left aligned image",icon:Ig.objectLeft,modelElements:["imageBlock","imageInline"],className:"image-style-align-left"}},get alignBlockLeft(){return {name:"alignBlockLeft",title:"Left aligned image",icon:Ig.objectBlockLeft,modelElements:["imageBlock"],className:"image-style-block-align-left"}},get alignCenter(){return {name:"alignCenter",title:"Centered image",icon:Ig.objectCenter,modelElements:["imageBlock"],className:"image-style-align-center"}},get alignRight(){return {name:"alignRight",title:"Right aligned image",icon:Ig.objectRight,modelElements:["imageBlock","imageInline"],className:"image-style-align-right"}},get alignBlockRight(){return {name:"alignBlockRight",title:"Right aligned image",icon:Ig.objectBlockRight,modelElements:["imageBlock"],className:"image-style-block-align-right"}},get block(){return {name:"block",title:"Centered image",icon:Ig.objectCenter,modelElements:["imageBlock"],isDefault:!0}},get side(){return {name:"side",title:"Side image",icon:Ig.objectRight,modelElements:["imageBlock"],className:"image-style-side"}}},nS=(()=>({full:Ig.objectFullWidth,left:Ig.objectBlockLeft,right:Ig.objectBlockRight,center:Ig.objectCenter,inlineLeft:Ig.objectLeft,inlineRight:Ig.objectRight,inline:Ig.objectInline}))(),sS=[{name:"imageStyle:wrapText",title:"Wrap text",defaultItem:"imageStyle:alignLeft",items:["imageStyle:alignLeft","imageStyle:alignRight"]},{name:"imageStyle:breakText",title:"Break text",defaultItem:"imageStyle:block",items:["imageStyle:alignBlockLeft","imageStyle:block","imageStyle:alignBlockRight"]}];function oS(e){T("image-style-configuration-definition-invalid",e);}var rS={normalizeStyles:function(e){return (e.configuredStyles.options||[]).map((e=>function(e){e="string"==typeof e?iS[e]?{...iS[e]}:{name:e}:function(e,t){const i={...t};for(const n in e)Object.prototype.hasOwnProperty.call(t,n)||(i[n]=e[n]);return i}(iS[e.name],e);"string"==typeof e.icon&&(e.icon=nS[e.icon]||e.icon);return e}(e))).filter((t=>function(e,{isBlockPluginLoaded:t,isInlinePluginLoaded:i}){const{modelElements:n,name:s}=e;if(!(n&&n.length&&s))return oS({style:e}),!1;{const s=[t?"imageBlock":null,i?"imageInline":null];if(!n.some((e=>s.includes(e))))return T("image-style-missing-dependency",{style:e,missingPlugins:n.map((e=>"imageBlock"===e?"ImageBlockEditing":"ImageInlineEditing"))}),!1}return !0}(t,e)))},getDefaultStylesConfiguration:function(e,t){return e&&t?{options:["inline","alignLeft","alignRight","alignCenter","alignBlockLeft","alignBlockRight","block","side"]}:e?{options:["block","side"]}:t?{options:["inline","alignLeft","alignRight"]}:{}},getDefaultDropdownDefinitions:function(e){return e.has("ImageBlockEditing")&&e.has("ImageInlineEditing")?[...sS]:[]},warnInvalidStyle:oS,DEFAULT_OPTIONS:iS,DEFAULT_ICONS:nS,DEFAULT_DROPDOWN_DEFINITIONS:sS};function aS(e,t){for(const i of t)if(i.name===e)return i}class lS extends Ga{static get pluginName(){return "ImageStyleEditing"}static get requires(){return [jE]}normalizedStyles;init(){const{normalizeStyles:e,getDefaultStylesConfiguration:t}=rS,i=this.editor,n=i.plugins.has("ImageBlockEditing"),s=i.plugins.has("ImageInlineEditing");i.config.define("image.styles",t(n,s)),this.normalizedStyles=e({configuredStyles:i.config.get("image.styles"),isBlockPluginLoaded:n,isInlinePluginLoaded:s}),this._setupConversion(n,s),this._setupPostFixer(),i.commands.add("imageStyle",new tS(i,this.normalizedStyles));}_setupConversion(e,t){const i=this.editor,n=i.model.schema,s=(o=this.normalizedStyles,(e,t,i)=>{if(!i.consumable.consume(t.item,e.name))return;const n=aS(t.attributeNewValue,o),s=aS(t.attributeOldValue,o),r=i.mapper.toViewElement(t.item),a=i.writer;s&&a.removeClass(s.className,r),n&&a.addClass(n.className,r);});var o;const r=function(e){const t={imageInline:e.filter((e=>!e.isDefault&&e.modelElements.includes("imageInline"))),imageBlock:e.filter((e=>!e.isDefault&&e.modelElements.includes("imageBlock")))};return (e,i,n)=>{if(!i.modelRange)return;const s=i.viewItem,o=Ia(i.modelRange.getItems());if(o&&n.schema.checkAttribute(o,"imageStyle"))for(const e of t[o.name])n.consumable.consume(s,{classes:e.className})&&n.writer.setAttribute("imageStyle",e.name,o);}}(this.normalizedStyles);i.editing.downcastDispatcher.on("attribute:imageStyle",s),i.data.downcastDispatcher.on("attribute:imageStyle",s),e&&(n.extend("imageBlock",{allowAttributes:"imageStyle"}),i.data.upcastDispatcher.on("element:figure",r,{priority:"low"})),t&&(n.extend("imageInline",{allowAttributes:"imageStyle"}),i.data.upcastDispatcher.on("element:img",r,{priority:"low"}));}_setupPostFixer(){const e=this.editor,t=e.model.document,i=e.plugins.get(jE),n=new Map(this.normalizedStyles.map((e=>[e.name,e])));t.registerPostFixer((e=>{let s=!1;for(const o of t.differ.getChanges())if("insert"==o.type||"attribute"==o.type&&"imageStyle"==o.attributeKey){let t="insert"==o.type?o.position.nodeAfter:o.range.start.nodeAfter;if(t&&t.is("element","paragraph")&&t.childCount>0&&(t=t.getChild(0)),!i.isImage(t))continue;const r=t.getAttribute("imageStyle");if(!r)continue;const a=n.get(r);a&&a.modelElements.includes(t.name)||(e.removeAttribute("imageStyle",t),s=!0);}return s}));}}class cS extends Ga{static get requires(){return [lS]}static get pluginName(){return "ImageStyleUI"}get localizedDefaultStylesTitles(){const e=this.editor.t;return {"Wrap text":e("Wrap text"),"Break text":e("Break text"),"In line":e("In line"),"Full size image":e("Full size image"),"Side image":e("Side image"),"Left aligned image":e("Left aligned image"),"Centered image":e("Centered image"),"Right aligned image":e("Right aligned image")}}init(){const e=this.editor.plugins,t=this.editor.config.get("image.toolbar")||[],i=dS(e.get("ImageStyleEditing").normalizedStyles,this.localizedDefaultStylesTitles);for(const e of i)this._createButton(e);const n=dS([...t.filter(pe),...rS.getDefaultDropdownDefinitions(e)],this.localizedDefaultStylesTitles);for(const e of n)this._createDropdown(e,i);}_createDropdown(e,t){const i=this.editor.ui.componentFactory;i.add(e.name,(n=>{let s;const{defaultItem:o,items:r,title:a}=e,l=r.filter((e=>t.find((({name:t})=>hS(t)===e)))).map((e=>{const t=i.create(e);return e===o&&(s=t),t}));r.length!==l.length&&rS.warnInvalidStyle({dropdown:e});const c=lb(n,ab),d=c.buttonView,h=d.arrowView;return hb(c,l,{enableActiveItemFocusOnDropdownOpen:!0}),d.set({label:uS(a,s.label),class:null,tooltip:!0}),h.unbind("label"),h.set({label:a}),d.bind("icon").toMany(l,"isOn",((...e)=>{const t=e.findIndex(Ce);return t<0?s.icon:l[t].icon})),d.bind("label").toMany(l,"isOn",((...e)=>{const t=e.findIndex(Ce);return uS(a,t<0?s.label:l[t].label)})),d.bind("isOn").toMany(l,"isOn",((...e)=>e.some(Ce))),d.bind("class").toMany(l,"isOn",((...e)=>e.some(Ce)?"ck-splitbutton_flatten":void 0)),d.on("execute",(()=>{l.some((({isOn:e})=>e))?c.isOpen=!c.isOpen:s.fire("execute");})),c.bind("isEnabled").toMany(l,"isEnabled",((...e)=>e.some(Ce))),this.listenTo(c,"execute",(()=>{this.editor.editing.view.focus();})),c}));}_createButton(e){const t=e.name;this.editor.ui.componentFactory.add(hS(t),(i=>{const n=this.editor.commands.get("imageStyle"),s=new Ef(i);return s.set({label:e.title,icon:e.icon,tooltip:!0,isToggleable:!0}),s.bind("isEnabled").to(n,"isEnabled"),s.bind("isOn").to(n,"value",(e=>e===t)),s.on("execute",this._executeCommand.bind(this,t)),s}));}_executeCommand(e){this.editor.execute("imageStyle",{value:e}),this.editor.editing.view.focus();}}function dS(e,t){for(const i of e)t[i.title]&&(i.title=t[i.title]);return e}function hS(e){return `imageStyle:${e}`}function uS(e,t){return (e?e+": ":"")+t}class mS extends Ga{static get requires(){return [lS,cS]}static get pluginName(){return "ImageStyle"}}class gS extends Ga{static get requires(){return [zk,jE]}static get pluginName(){return "ImageToolbar"}afterInit(){const e=this.editor,t=e.t,i=e.plugins.get(zk),n=e.plugins.get("ImageUtils");var s;i.register("image",{ariaLabel:t("Image toolbar"),items:(s=e.config.get("image.toolbar")||[],s.map((e=>pe(e)?e.name:e))),getRelatedElement:e=>n.getClosestSelectedImageWidget(e)});}}class IS{_definitions=new Set;get length(){return this._definitions.size}add(e){Array.isArray(e)?e.forEach((e=>this._definitions.add(e))):this._definitions.add(e);}getDispatcher(){return e=>{e.on("attribute:linkHref",((e,t,i)=>{if(!i.consumable.test(t.item,"attribute:linkHref"))return;if(!t.item.is("selection")&&!i.schema.isInline(t.item))return;const n=i.writer,s=n.document.selection;for(const e of this._definitions){const o=n.createAttributeElement("a",e.attributes,{priority:5});e.classes&&n.addClass(e.classes,o);for(const t in e.styles)n.setStyle(t,e.styles[t],o);n.setCustomProperty("link",!0,o),e.callback(t.attributeNewValue)?t.item.is("selection")?n.wrap(s.getFirstRange(),o):n.wrap(i.mapper.toViewRange(t.range),o):n.unwrap(i.mapper.toViewRange(t.range),o);}}),{priority:"high"});}}getDispatcherForLinkedImage(){return e=>{e.on("attribute:linkHref:imageBlock",((e,t,{writer:i,mapper:n})=>{const s=n.toViewElement(t.item),o=Array.from(s.getChildren()).find((e=>e.is("element","a")));for(const e of this._definitions){const n=Ra(e.attributes);if(e.callback(t.attributeNewValue)){for(const[e,t]of n)"class"===e?i.addClass(t,o):i.setAttribute(e,t,o);e.classes&&i.addClass(e.classes,o);for(const t in e.styles)i.setStyle(t,e.styles[t],o);}else {for(const[e,t]of n)"class"===e?i.removeClass(t,o):i.removeAttribute(e,o);e.classes&&i.removeClass(e.classes,o);for(const t in e.styles)i.removeStyle(t,o);}}}));}}}const PS=/[\u0000-\u0020\u00A0\u1680\u180E\u2000-\u2029\u205f\u3000]/g,VS=/^[\S]+@((?![-_])(?:[-\w\u00a1-\uffff]{0,63}[^-_]\.))+(?:[a-z\u00a1-\uffff]{2,})$/i,RS=/^((\w+:(\/{2,})?)|(\W))/i,BS=["https?","ftps?","mailto"],OS="Ctrl+K";function MS(e,{writer:t}){const i=t.createAttributeElement("a",{href:e},{priority:5});return t.setCustomProperty("link",!0,i),i}function LS(e,t=BS){const i=String(e),n=t.join("|");return function(e,t){const i=e.replace(PS,"");return !!i.match(t)}(i,new RegExp(`${"^(?:(?:<protocols>):|[^a-z]|[a-z+.-]+(?:[^a-z+.:-]|$))".replace("<protocols>",n)}`,"i"))?i:"#"}function FS(e,t){return !!e&&t.checkAttribute(e.name,"linkHref")}function NS(e,t){const i=(n=e,VS.test(n)?"mailto:":t);var n;const s=!!i&&!DS(e);return e&&s?i+e:e}function DS(e){return RS.test(e)}function zS(e){window.open(e,"_blank","noopener");}class HS extends Za{manualDecorators=new Sa;automaticDecorators=new IS;restoreManualDecoratorStates(){for(const e of this.manualDecorators)e.value=this._getDecoratorStateFromModel(e.id);}refresh(){const e=this.editor.model,t=e.document.selection,i=t.getSelectedElement()||Ia(t.getSelectedBlocks());FS(i,e.schema)?(this.value=i.getAttribute("linkHref"),this.isEnabled=e.schema.checkAttribute(i,"linkHref")):(this.value=t.getAttribute("linkHref"),this.isEnabled=e.schema.checkAttributeInSelection(t,"linkHref"));for(const e of this.manualDecorators)e.value=this._getDecoratorStateFromModel(e.id);}execute(e,t={}){const i=this.editor.model,n=i.document.selection,s=[],o=[];for(const e in t)t[e]?s.push(e):o.push(e);i.change((t=>{if(n.isCollapsed){const r=n.getFirstPosition();if(n.hasAttribute("linkHref")){const a=$S(n);let l=lv(r,"linkHref",n.getAttribute("linkHref"),i);n.getAttribute("linkHref")===a&&(l=this._updateLinkContent(i,t,l,e)),t.setAttribute("linkHref",e,l),s.forEach((e=>{t.setAttribute(e,!0,l);})),o.forEach((e=>{t.removeAttribute(e,l);})),t.setSelection(t.createPositionAfter(l.end.nodeBefore));}else if(""!==e){const o=Ra(n.getAttributes());o.set("linkHref",e),s.forEach((e=>{o.set(e,!0);}));const{end:a}=i.insertContent(t.createText(e,o),r);t.setSelection(a);}["linkHref",...s,...o].forEach((e=>{t.removeSelectionAttribute(e);}));}else {const r=i.schema.getValidRanges(n.getRanges(),"linkHref"),a=[];for(const e of n.getSelectedBlocks())i.schema.checkAttribute(e,"linkHref")&&a.push(t.createRangeOn(e));const l=a.slice();for(const e of r)this._isRangeToUpdate(e,a)&&l.push(e);for(const r of l){let a=r;if(1===l.length){const s=$S(n);n.getAttribute("linkHref")===s&&(a=this._updateLinkContent(i,t,r,e),t.setSelection(t.createSelection(a)));}t.setAttribute("linkHref",e,a),s.forEach((e=>{t.setAttribute(e,!0,a);})),o.forEach((e=>{t.removeAttribute(e,a);}));}}}));}_getDecoratorStateFromModel(e){const t=this.editor.model,i=t.document.selection,n=i.getSelectedElement();return FS(n,t.schema)?n.getAttribute(e):i.getAttribute(e)}_isRangeToUpdate(e,t){for(const i of t)if(i.containsRange(e))return !1;return !0}_updateLinkContent(e,t,i,n){const s=t.createText(n,{linkHref:n});return e.insertContent(s,i)}}function $S(e){if(e.isCollapsed){const t=e.getFirstPosition();return t.textNode&&t.textNode.data}{const t=Array.from(e.getFirstRange().getItems());if(t.length>1)return null;const i=t[0];return i.is("$text")||i.is("$textProxy")?i.data:null}}class US extends Za{refresh(){const e=this.editor.model,t=e.document.selection,i=t.getSelectedElement();FS(i,e.schema)?this.isEnabled=e.schema.checkAttribute(i,"linkHref"):this.isEnabled=e.schema.checkAttributeInSelection(t,"linkHref");}execute(){const e=this.editor,t=this.editor.model,i=t.document.selection,n=e.commands.get("link");t.change((e=>{const s=i.isCollapsed?[lv(i.getFirstPosition(),"linkHref",i.getAttribute("linkHref"),t)]:t.schema.getValidRanges(i.getRanges(),"linkHref");for(const t of s)if(e.removeAttribute("linkHref",t),n)for(const i of n.manualDecorators)e.removeAttribute(i.id,t);}));}}class WS extends(ar()){id;defaultValue;label;attributes;classes;styles;constructor({id:e,label:t,attributes:i,classes:n,styles:s,defaultValue:o}){super(),this.id=e,this.set("value",void 0),this.defaultValue=o,this.label=t,this.attributes=i,this.classes=n,this.styles=s;}_createPattern(){return {attributes:this.attributes,classes:this.classes,styles:this.styles}}}const jS="automatic",qS=/^(https?:)?\/\//;class GS extends Ga{static get pluginName(){return "LinkEditing"}static get requires(){return [G_,R_,ak]}constructor(e){super(e),e.config.define("link",{allowCreatingEmptyLinks:!1,addTargetToExternalLinks:!1});}init(){const e=this.editor,t=this.editor.config.get("link.allowedProtocols");e.model.schema.extend("$text",{allowAttributes:"linkHref"}),e.conversion.for("dataDowncast").attributeToElement({model:"linkHref",view:MS}),e.conversion.for("editingDowncast").attributeToElement({model:"linkHref",view:(e,i)=>MS(LS(e,t),i)}),e.conversion.for("upcast").elementToAttribute({view:{name:"a",attributes:{href:!0}},model:{key:"linkHref",value:e=>e.getAttribute("href")}}),e.commands.add("link",new HS(e)),e.commands.add("unlink",new US(e));const i=function(e,t){const i={"Open in a new tab":e("Open in a new tab"),Downloadable:e("Downloadable")};return t.forEach((e=>("label"in e&&i[e.label]&&(e.label=i[e.label]),e))),t}(e.t,function(e){const t=[];if(e)for(const[i,n]of Object.entries(e)){const e=Object.assign({},n,{id:`link${Bi(i)}`});t.push(e);}return t}(e.config.get("link.decorators")));this._enableAutomaticDecorators(i.filter((e=>e.mode===jS))),this._enableManualDecorators(i.filter((e=>"manual"===e.mode)));e.plugins.get(G_).registerAttribute("linkHref"),dv(e,"linkHref","a","ck-link_selected"),this._enableLinkOpen(),this._enableSelectionAttributesFixer(),this._enableClipboardIntegration();}_enableAutomaticDecorators(e){const t=this.editor,i=t.commands.get("link").automaticDecorators;t.config.get("link.addTargetToExternalLinks")&&i.add({id:"linkIsExternal",mode:jS,callback:e=>!!e&&qS.test(e),attributes:{target:"_blank",rel:"noopener noreferrer"}}),i.add(e),i.length&&t.conversion.for("downcast").add(i.getDispatcher());}_enableManualDecorators(e){if(!e.length)return;const t=this.editor,i=t.commands.get("link").manualDecorators;e.forEach((e=>{t.model.schema.extend("$text",{allowAttributes:e.id});const n=new WS(e);i.add(n),t.conversion.for("downcast").attributeToElement({model:n.id,view:(e,{writer:t,schema:i},{item:s})=>{if((s.is("selection")||i.isInline(s))&&e){const e=t.createAttributeElement("a",n.attributes,{priority:5});n.classes&&t.addClass(n.classes,e);for(const i in n.styles)t.setStyle(i,n.styles[i],e);return t.setCustomProperty("link",!0,e),e}}}),t.conversion.for("upcast").elementToAttribute({view:{name:"a",...n._createPattern()},model:{key:n.id}});}));}_enableLinkOpen(){const e=this.editor,t=e.editing.view.document;this.listenTo(t,"click",((e,t)=>{if(!(o.isMac?t.domEvent.metaKey:t.domEvent.ctrlKey))return;let i=t.domTarget;if("a"!=i.tagName.toLowerCase()&&(i=i.closest("a")),!i)return;const n=i.getAttribute("href");n&&(e.stop(),t.preventDefault(),zS(n));}),{context:"$capture"}),this.listenTo(t,"keydown",((t,i)=>{const n=e.commands.get("link").value;!!n&&i.keyCode===ga.enter&&i.altKey&&(t.stop(),zS(n));}));}_enableSelectionAttributesFixer(){const e=this.editor.model,t=e.document.selection;this.listenTo(t,"change:attribute",((i,{attributeKeys:n})=>{n.includes("linkHref")&&!t.hasAttribute("linkHref")&&e.change((t=>{var i;!function(e,t){e.removeSelectionAttribute("linkHref");for(const i of t)e.removeSelectionAttribute(i);}(t,(i=e.schema,i.getDefinition("$text").allowAttributes.filter((e=>e.startsWith("link")))));}));}));}_enableClipboardIntegration(){const e=this.editor,t=e.model,i=this.editor.config.get("link.defaultProtocol");i&&this.listenTo(e.plugins.get("ClipboardPipeline"),"contentInsertion",((e,n)=>{t.change((e=>{const t=e.createRangeIn(n.content);for(const n of t.getItems())if(n.hasAttribute("linkHref")){const t=NS(n.getAttribute("linkHref"),i);e.setAttribute("linkHref",t,n);}}));}));}}class KS extends wf{focusTracker=new Pa;keystrokes=new Va;urlInputView;saveButtonView;cancelButtonView;_manualDecoratorSwitches;children;_validators;_focusables=new Zg;_focusCycler;constructor(e,t,i){super(e);const n=e.t;this._validators=i,this.urlInputView=this._createUrlInput(),this.saveButtonView=this._createButton(n("Save"),Ig.check,"ck-button-save"),this.saveButtonView.type="submit",this.cancelButtonView=this._createButton(n("Cancel"),Ig.cancel,"ck-button-cancel","cancel"),this._manualDecoratorSwitches=this._createManualDecoratorSwitches(t),this.children=this._createFormChildren(t.manualDecorators),this._focusCycler=new If({focusables:this._focusables,focusTracker:this.focusTracker,keystrokeHandler:this.keystrokes,actions:{focusPrevious:"shift + tab",focusNext:"tab"}});const s=["ck","ck-link-form","ck-responsive-form"];t.manualDecorators.length&&s.push("ck-link-form_layout-vertical","ck-vertical-form"),this.setTemplate({tag:"form",attributes:{class:s,tabindex:"-1"},children:this.children});}getDecoratorSwitchesState(){return Array.from(this._manualDecoratorSwitches).reduce(((e,t)=>(e[t.name]=t.isOn,e)),{})}render(){super.render(),kf({view:this});[this.urlInputView,...this._manualDecoratorSwitches,this.saveButtonView,this.cancelButtonView].forEach((e=>{this._focusables.add(e),this.focusTracker.add(e.element);})),this.keystrokes.listenTo(this.element);}destroy(){super.destroy(),this.focusTracker.destroy(),this.keystrokes.destroy();}focus(){this._focusCycler.focusFirst();}isValid(){this.resetFormStatus();for(const e of this._validators){const t=e(this);if(t)return this.urlInputView.errorText=t,!1}return !0}resetFormStatus(){this.urlInputView.errorText=null;}_createUrlInput(){const e=this.locale.t,t=new Ap(this.locale,bb);return t.fieldView.inputMode="url",t.label=e("Link URL"),t}_createButton(e,t,i,n){const s=new Ef(this.locale);return s.set({label:e,icon:t,tooltip:!0}),s.extendTemplate({attributes:{class:i}}),n&&s.delegate("execute").to(this,n),s}_createManualDecoratorSwitches(e){const t=this.createCollection();for(const i of e.manualDecorators){const n=new Zf(this.locale);n.set({name:i.id,label:i.label,withText:!0}),n.bind("isOn").toMany([i,e],"value",((e,t)=>void 0===t&&void 0===e?!!i.defaultValue:!!e)),n.on("execute",(()=>{i.set("value",!n.isOn);})),t.add(n);}return t}_createFormChildren(e){const t=this.createCollection();if(t.add(this.urlInputView),e.length){const e=new wf;e.setTemplate({tag:"ul",children:this._manualDecoratorSwitches.map((e=>({tag:"li",children:[e],attributes:{class:["ck","ck-list__item"]}}))),attributes:{class:["ck","ck-reset","ck-list"]}}),t.add(e);}return t.add(this.saveButtonView),t.add(this.cancelButtonView),t}get url(){const{element:e}=this.urlInputView.fieldView;return e?e.value.trim():null}}class ZS extends wf{focusTracker=new Pa;keystrokes=new Va;previewButtonView;unlinkButtonView;editButtonView;_focusables=new Zg;_focusCycler;_linkConfig;constructor(e,t={}){super(e);const i=e.t;this.previewButtonView=this._createPreviewButton(),this.unlinkButtonView=this._createButton(i("Unlink"),'<svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="m11.077 15 .991-1.416a.75.75 0 1 1 1.229.86l-1.148 1.64a.748.748 0 0 1-.217.206 5.251 5.251 0 0 1-8.503-5.955.741.741 0 0 1 .12-.274l1.147-1.639a.75.75 0 1 1 1.228.86L4.933 10.7l.006.003a3.75 3.75 0 0 0 6.132 4.294l.006.004zm5.494-5.335a.748.748 0 0 1-.12.274l-1.147 1.639a.75.75 0 1 1-1.228-.86l.86-1.23a3.75 3.75 0 0 0-6.144-4.301l-.86 1.229a.75.75 0 0 1-1.229-.86l1.148-1.64a.748.748 0 0 1 .217-.206 5.251 5.251 0 0 1 8.503 5.955zm-4.563-2.532a.75.75 0 0 1 .184 1.045l-3.155 4.505a.75.75 0 1 1-1.229-.86l3.155-4.506a.75.75 0 0 1 1.045-.184zm4.919 10.562-1.414 1.414a.75.75 0 1 1-1.06-1.06l1.414-1.415-1.415-1.414a.75.75 0 0 1 1.061-1.06l1.414 1.414 1.414-1.415a.75.75 0 0 1 1.061 1.061l-1.414 1.414 1.414 1.415a.75.75 0 0 1-1.06 1.06l-1.415-1.414z"/></svg>',"unlink"),this.editButtonView=this._createButton(i("Edit link"),Ig.pencil,"edit"),this.set("href",void 0),this._linkConfig=t,this._focusCycler=new If({focusables:this._focusables,focusTracker:this.focusTracker,keystrokeHandler:this.keystrokes,actions:{focusPrevious:"shift + tab",focusNext:"tab"}}),this.setTemplate({tag:"div",attributes:{class:["ck","ck-link-actions","ck-responsive-form"],tabindex:"-1"},children:[this.previewButtonView,this.editButtonView,this.unlinkButtonView]});}render(){super.render();[this.previewButtonView,this.editButtonView,this.unlinkButtonView].forEach((e=>{this._focusables.add(e),this.focusTracker.add(e.element);})),this.keystrokes.listenTo(this.element);}destroy(){super.destroy(),this.focusTracker.destroy(),this.keystrokes.destroy();}focus(){this._focusCycler.focusFirst();}_createButton(e,t,i){const n=new Ef(this.locale);return n.set({label:e,icon:t,tooltip:!0}),n.delegate("execute").to(this,i),n}_createPreviewButton(){const e=new Ef(this.locale),t=this.bindTemplate,i=this.t;return e.set({withText:!0,tooltip:i("Open link in new tab")}),e.extendTemplate({attributes:{class:["ck","ck-link-actions__preview"],href:t.to("href",(e=>e&&LS(e,this._linkConfig.allowedProtocols))),target:"_blank",rel:"noopener noreferrer"}}),e.bind("label").to(this,"href",(e=>e||i("This link has no URL"))),e.bind("isEnabled").to(this,"href",(e=>!!e)),e.template.tag="a",e.template.eventListeners={},e}}var JS='<svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="m11.077 15 .991-1.416a.75.75 0 1 1 1.229.86l-1.148 1.64a.748.748 0 0 1-.217.206 5.251 5.251 0 0 1-8.503-5.955.741.741 0 0 1 .12-.274l1.147-1.639a.75.75 0 1 1 1.228.86L4.933 10.7l.006.003a3.75 3.75 0 0 0 6.132 4.294l.006.004zm5.494-5.335a.748.748 0 0 1-.12.274l-1.147 1.639a.75.75 0 1 1-1.228-.86l.86-1.23a3.75 3.75 0 0 0-6.144-4.301l-.86 1.229a.75.75 0 0 1-1.229-.86l1.148-1.64a.748.748 0 0 1 .217-.206 5.251 5.251 0 0 1 8.503 5.955zm-4.563-2.532a.75.75 0 0 1 .184 1.045l-3.155 4.505a.75.75 0 1 1-1.229-.86l3.155-4.506a.75.75 0 0 1 1.045-.184z"/></svg>';const QS="link-ui";class YS extends Ga{actionsView=null;formView=null;_balloon;static get requires(){return [Jw]}static get pluginName(){return "LinkUI"}init(){const e=this.editor,t=this.editor.t;e.editing.view.addObserver(Yu),this._balloon=e.plugins.get(Jw),this._createToolbarLinkButton(),this._enableBalloonActivators(),e.conversion.for("editingDowncast").markerToHighlight({model:QS,view:{classes:["ck-fake-link-selection"]}}),e.conversion.for("editingDowncast").markerToElement({model:QS,view:(e,{writer:t})=>{if(!e.markerRange.isCollapsed)return null;const i=t.createUIElement("span");return t.addClass(["ck-fake-link-selection","ck-fake-link-selection_collapsed"],i),i}}),e.accessibility.addKeystrokeInfos({keystrokes:[{label:t("Create link"),keystroke:OS},{label:t("Move out of a link"),keystroke:[["arrowleft","arrowleft"],["arrowright","arrowright"]]}]});}destroy(){super.destroy(),this.formView&&this.formView.destroy(),this.actionsView&&this.actionsView.destroy();}_createViews(){this.actionsView=this._createActionsView(),this.formView=this._createFormView(),this._enableUserBalloonInteractions();}_createActionsView(){const e=this.editor,t=new ZS(e.locale,e.config.get("link")),i=e.commands.get("link"),n=e.commands.get("unlink");return t.bind("href").to(i,"value"),t.editButtonView.bind("isEnabled").to(i),t.unlinkButtonView.bind("isEnabled").to(n),this.listenTo(t,"edit",(()=>{this._addFormView();})),this.listenTo(t,"unlink",(()=>{e.execute("unlink"),this._hideUI();})),t.keystrokes.set("Esc",((e,t)=>{this._hideUI(),t();})),t.keystrokes.set(OS,((e,t)=>{this._addFormView(),t();})),t}_createFormView(){const e=this.editor,t=e.commands.get("link"),i=e.config.get("link.defaultProtocol"),n=new(yf(KS))(e.locale,t,function(e){const t=e.t,i=e.config.get("link.allowCreatingEmptyLinks");return [e=>{if(!i&&!e.url.length)return t("Link URL must not be empty.")}]}(e));return n.urlInputView.fieldView.bind("value").to(t,"value"),n.urlInputView.bind("isEnabled").to(t,"isEnabled"),n.saveButtonView.bind("isEnabled").to(t,"isEnabled"),this.listenTo(n,"submit",(()=>{if(n.isValid()){const{value:t}=n.urlInputView.fieldView.element,s=NS(t,i);e.execute("link",s,n.getDecoratorSwitchesState()),this._closeFormView();}})),this.listenTo(n.urlInputView,"change:errorText",(()=>{e.ui.update();})),this.listenTo(n,"cancel",(()=>{this._closeFormView();})),n.keystrokes.set("Esc",((e,t)=>{this._closeFormView(),t();})),n}_createToolbarLinkButton(){const e=this.editor;e.ui.componentFactory.add("link",(()=>{const e=this._createButton(Ef);return e.set({tooltip:!0}),e})),e.ui.componentFactory.add("menuBar:link",(()=>{const e=this._createButton($f);return e.set({role:"menuitemcheckbox"}),e}));}_createButton(e){const t=this.editor,i=t.locale,n=t.commands.get("link"),s=new e(t.locale),o=i.t;return s.set({label:o("Link"),icon:JS,keystroke:OS,isToggleable:!0}),s.bind("isEnabled").to(n,"isEnabled"),s.bind("isOn").to(n,"value",(e=>!!e)),this.listenTo(s,"execute",(()=>this._showUI(!0))),s}_enableBalloonActivators(){const e=this.editor,t=e.editing.view.document;this.listenTo(t,"click",(()=>{this._getSelectedLinkElement()&&this._showUI();})),e.keystrokes.set(OS,((t,i)=>{i(),e.commands.get("link").isEnabled&&this._showUI(!0);}));}_enableUserBalloonInteractions(){this.editor.keystrokes.set("Tab",((e,t)=>{this._areActionsVisible&&!this.actionsView.focusTracker.isFocused&&(this.actionsView.focus(),t());}),{priority:"high"}),this.editor.keystrokes.set("Esc",((e,t)=>{this._isUIVisible&&(this._hideUI(),t());})),_f({emitter:this.formView,activator:()=>this._isUIInPanel,contextElements:()=>[this._balloon.view.element],callback:()=>this._hideUI()});}_addActionsView(){this.actionsView||this._createViews(),this._areActionsInPanel||this._balloon.add({view:this.actionsView,position:this._getBalloonPositionData()});}_addFormView(){if(this.formView||this._createViews(),this._isFormInPanel)return;const e=this.editor.commands.get("link");this.formView.disableCssTransitions(),this.formView.resetFormStatus(),this._balloon.add({view:this.formView,position:this._getBalloonPositionData()}),this.formView.urlInputView.fieldView.value=e.value||"",this._balloon.visibleView===this.formView&&this.formView.urlInputView.fieldView.select(),this.formView.enableCssTransitions();}_closeFormView(){const e=this.editor.commands.get("link");e.restoreManualDecoratorStates(),void 0!==e.value?this._removeFormView():this._hideUI();}_removeFormView(){this._isFormInPanel&&(this.formView.saveButtonView.focus(),this.formView.urlInputView.fieldView.reset(),this._balloon.remove(this.formView),this.editor.editing.view.focus(),this._hideFakeVisualSelection());}_showUI(e=!1){this.formView||this._createViews(),this._getSelectedLinkElement()?(this._areActionsVisible?this._addFormView():this._addActionsView(),e&&this._balloon.showStack("main")):(this._showFakeVisualSelection(),this._addActionsView(),e&&this._balloon.showStack("main"),this._addFormView()),this._startUpdatingUI();}_hideUI(){if(!this._isUIInPanel)return;const e=this.editor;this.stopListening(e.ui,"update"),this.stopListening(this._balloon,"change:visibleView"),e.editing.view.focus(),this._removeFormView(),this._balloon.remove(this.actionsView),this._hideFakeVisualSelection();}_startUpdatingUI(){const e=this.editor,t=e.editing.view.document;let i=this._getSelectedLinkElement(),n=o();const s=()=>{const e=this._getSelectedLinkElement(),t=o();i&&!e||!i&&t!==n?this._hideUI():this._isUIVisible&&this._balloon.updatePosition(this._getBalloonPositionData()),i=e,n=t;};function o(){return t.selection.focus.getAncestors().reverse().find((e=>e.is("element")))}this.listenTo(e.ui,"update",s),this.listenTo(this._balloon,"change:visibleView",s);}get _isFormInPanel(){return !!this.formView&&this._balloon.hasView(this.formView)}get _areActionsInPanel(){return !!this.actionsView&&this._balloon.hasView(this.actionsView)}get _areActionsVisible(){return !!this.actionsView&&this._balloon.visibleView===this.actionsView}get _isUIInPanel(){return this._isFormInPanel||this._areActionsInPanel}get _isUIVisible(){const e=this._balloon.visibleView;return !!this.formView&&e==this.formView||this._areActionsVisible}_getBalloonPositionData(){const e=this.editor.editing.view,t=this.editor.model,i=e.document;let n;if(t.markers.has(QS)){const t=Array.from(this.editor.editing.mapper.markerNameToElements(QS)),i=e.createRange(e.createPositionBefore(t[0]),e.createPositionAfter(t[t.length-1]));n=e.domConverter.viewRangeToDom(i);}else n=()=>{const t=this._getSelectedLinkElement();return t?e.domConverter.mapViewToDom(t):e.domConverter.viewRangeToDom(i.selection.getFirstRange())};return {target:n}}_getSelectedLinkElement(){const e=this.editor.editing.view,t=e.document.selection,i=t.getSelectedElement();if(t.isCollapsed||i&&fk(i))return XS(t.getFirstPosition());{const i=t.getFirstRange().getTrimmed(),n=XS(i.start),s=XS(i.end);return n&&n==s&&e.createRangeIn(n).getTrimmed().isEqual(i)?n:null}}_showFakeVisualSelection(){const e=this.editor.model;e.change((t=>{const i=e.document.selection.getFirstRange();if(e.markers.has(QS))t.updateMarker(QS,{range:i});else if(i.start.isAtEnd){const n=i.start.getLastMatchingPosition((({item:t})=>!e.schema.isContent(t)),{boundaries:i});t.addMarker(QS,{usingOperation:!1,affectsData:!1,range:t.createRange(n,i.end)});}else t.addMarker(QS,{usingOperation:!1,affectsData:!1,range:i});}));}_hideFakeVisualSelection(){const e=this.editor.model;e.markers.has(QS)&&e.change((e=>{e.removeMarker(QS);}));}}function XS(e){return e.getAncestors().find((e=>{return (t=e).is("attributeElement")&&!!t.getCustomProperty("link");var t;}))||null}const eI=new RegExp("(^|\\s)(((?:(?:(?:https?|ftp):)?\\/\\/)(?:\\S+(?::\\S*)?@)?(?:(?:[1-9]\\d?|1\\d\\d|2[01]\\d|22[0-3])(?:\\.(?:1?\\d{1,2}|2[0-4]\\d|25[0-5])){2}(?:\\.(?:[1-9]\\d?|1\\d\\d|2[0-4]\\d|25[0-4]))|(((?!www\\.)|(www\\.))(?![-_])(?:[-_a-z0-9\\u00a1-\\uffff]{1,63}\\.)+(?:[a-z\\u00a1-\\uffff]{2,63})))(?::\\d{2,5})?(?:[/?#]\\S*)?)|((www.|(\\S+@))((?![-_])(?:[-_a-z0-9\\u00a1-\\uffff]{1,63}\\.))+(?:[a-z\\u00a1-\\uffff]{2,63})))$","i");class tI extends Ga{static get requires(){return [U_,GS]}static get pluginName(){return "AutoLink"}init(){const e=this.editor.model.document.selection;e.on("change:range",(()=>{this.isEnabled=!e.anchor.parent.is("element","codeBlock");})),this._enableTypingHandling();}afterInit(){this._enableEnterHandling(),this._enableShiftEnterHandling(),this._enablePasteLinking();}_expandLinkRange(e,t){return t.textNode&&t.textNode.hasAttribute("linkHref")?lv(t,"linkHref",t.textNode.getAttribute("linkHref"),e):null}_selectEntireLinks(e,t){const i=this.editor.model,n=i.document.selection,s=n.getFirstPosition(),o=n.getLastPosition();let r=t.getJoined(this._expandLinkRange(i,s)||t);r&&(r=r.getJoined(this._expandLinkRange(i,o)||t)),r&&(r.start.isBefore(s)||r.end.isAfter(o))&&e.setSelection(r);}_enablePasteLinking(){const e=this.editor,t=e.model,i=t.document.selection,n=e.plugins.get("ClipboardPipeline"),s=e.commands.get("link");n.on("inputTransformation",((e,n)=>{if(!this.isEnabled||!s.isEnabled||i.isCollapsed||"paste"!==n.method)return;if(i.rangeCount>1)return;const o=i.getFirstRange(),r=n.dataTransfer.getData("text/plain");if(!r)return;const a=r.match(eI);a&&a[2]===r&&(t.change((e=>{this._selectEntireLinks(e,o),s.execute(r);})),e.stop());}),{priority:"high"});}_enableTypingHandling(){const e=this.editor,t=new q_(e.model,(e=>{if(!function(e){return e.length>4&&" "===e[e.length-1]&&" "!==e[e.length-2]}(e))return;const t=iI(e.substr(0,e.length-1));return t?{url:t}:void 0}));t.on("matched:data",((t,i)=>{const{batch:n,range:s,url:o}=i;if(!n.isTyping)return;const r=s.end.getShiftedBy(-1),a=r.getShiftedBy(-o.length),l=e.model.createRange(a,r);this._applyAutoLink(o,l);})),t.bind("isEnabled").to(this);}_enableEnterHandling(){const e=this.editor,t=e.model,i=e.commands.get("enter");i&&i.on("execute",(()=>{const e=t.document.selection.getFirstPosition();if(!e.parent.previousSibling)return;const i=t.createRangeIn(e.parent.previousSibling);this._checkAndApplyAutoLinkOnRange(i);}));}_enableShiftEnterHandling(){const e=this.editor,t=e.model,i=e.commands.get("shiftEnter");i&&i.on("execute",(()=>{const e=t.document.selection.getFirstPosition(),i=t.createRange(t.createPositionAt(e.parent,0),e.getShiftedBy(-1));this._checkAndApplyAutoLinkOnRange(i);}));}_checkAndApplyAutoLinkOnRange(e){const t=this.editor.model,{text:i,range:n}=j_(e,t),s=iI(i);if(s){const e=t.createRange(n.end.getShiftedBy(-s.length),n.end);this._applyAutoLink(s,e);}}_applyAutoLink(e,t){const i=this.editor.model,n=NS(e,this.editor.config.get("link.defaultProtocol"));this.isEnabled&&function(e,t){return t.schema.checkAttributeInSelection(t.createSelection(e),"linkHref")}(t,i)&&DS(n)&&!function(e){const t=e.start.nodeAfter;return !!t&&t.hasAttribute("linkHref")}(t)&&this._persistAutoLink(n,t);}_persistAutoLink(e,t){const i=this.editor.model,n=this.editor.plugins.get("Delete");i.enqueueChange((s=>{s.setAttribute("linkHref",e,t),i.enqueueChange((()=>{n.requestUndoOnBackspace();}));}));}}function iI(e){const t=eI.exec(e);return t?t[2]:null}class nI extends Ga{static get requires(){return [GS,YS,tI]}static get pluginName(){return "Link"}}class cI{_startElement;_referenceIndent;_isForward;_includeSelf;_sameAttributes;_sameIndent;_lowerIndent;_higherIndent;constructor(e,t){this._startElement=e,this._referenceIndent=e.getAttribute("listIndent"),this._isForward="forward"==t.direction,this._includeSelf=!!t.includeSelf,this._sameAttributes=Aa(t.sameAttributes||[]),this._sameIndent=!!t.sameIndent,this._lowerIndent=!!t.lowerIndent,this._higherIndent=!!t.higherIndent;}static first(e,t){return Ia(new this(e,t)[Symbol.iterator]())}*[Symbol.iterator](){const e=[];for(const{node:t}of dI(this._getStartNode(),this._isForward?"forward":"backward")){const i=t.getAttribute("listIndent");if(i<this._referenceIndent){if(!this._lowerIndent)break;this._referenceIndent=i;}else if(i>this._referenceIndent){if(!this._higherIndent)continue;if(!this._isForward){e.push(t);continue}}else {if(!this._sameIndent){if(this._higherIndent){e.length&&(yield*e,e.length=0);break}continue}if(this._sameAttributes.some((e=>t.getAttribute(e)!==this._startElement.getAttribute(e))))break}e.length&&(yield*e,e.length=0),yield t;}}_getStartNode(){return this._includeSelf?this._startElement:this._isForward?this._startElement.nextSibling:this._startElement.previousSibling}}function*dI(e,t="forward"){const i="forward"==t,n=[];let s=null;for(;mI(e);){let t=null;if(s){const i=e.getAttribute("listIndent"),o=s.getAttribute("listIndent");i>o?n[o]=s:i<o?(t=n[i],n.length=i):t=s;}yield {node:e,previous:s,previousNodeInList:t},s=e,e=i?e.nextSibling:e.previousSibling;}}class hI{_listHead;constructor(e){this._listHead=e;}[Symbol.iterator](){return dI(this._listHead,"forward")}}class uI{static next(){return k()}}function mI(e){return !!e&&e.is("element")&&e.hasAttribute("listItemId")}function gI(e,t={}){return [...fI(e,{...t,direction:"backward"}),...fI(e,{...t,direction:"forward"})]}function fI(e,t={}){const i="forward"==t.direction,n=Array.from(new cI(e,{...t,includeSelf:i,sameIndent:!0,sameAttributes:"listItemId"}));return i?n:n.reverse()}function pI(e,t){const i=new cI(e,{sameIndent:!0,sameAttributes:"listType",...t}),n=new cI(e,{sameIndent:!0,sameAttributes:"listType",includeSelf:!0,direction:"forward",...t});return [...Array.from(i).reverse(),...n]}function bI(e){return !cI.first(e,{sameIndent:!0,sameAttributes:"listItemId"})}function wI(e){return !cI.first(e,{direction:"forward",sameIndent:!0,sameAttributes:"listItemId"})}function _I(e,t={}){e=Aa(e);const i=!1!==t.withNested,n=new Set;for(const t of e)for(const e of gI(t,{higherIndent:i}))n.add(e);return EI(n)}function vI(e){e=Aa(e);const t=new Set;for(const i of e)for(const e of pI(i))t.add(e);return EI(t)}function yI(e,t){const i=fI(e,{direction:"forward"}),n=uI.next();for(const e of i)t.setAttribute("listItemId",n,e);return i}function kI(e,t,i){const n={};for(const[e,i]of t.getAttributes())e.startsWith("list")&&(n[e]=i);const s=fI(e,{direction:"forward"});for(const e of s)i.setAttributes(n,e);return s}function CI(e,t,{expand:i,indentBy:n=1}={}){e=Aa(e);const s=i?_I(e):e;for(const e of s){const i=e.getAttribute("listIndent")+n;i<0?xI(e,t):t.setAttribute("listIndent",i,e);}return s}function xI(e,t){e=Aa(e);for(const i of e)i.is("element","listItem")&&t.rename(i,"paragraph");for(const i of e)for(const e of i.getAttributeKeys())e.startsWith("list")&&t.removeAttribute(e,i);return e}function AI(e){if(!e.length)return !1;const t=e[0].getAttribute("listItemId");return !!t&&!e.some((e=>e.getAttribute("listItemId")!=t))}function EI(e){return Array.from(e).filter((e=>"$graveyard"!==e.root.rootName)).sort(((e,t)=>e.index-t.index))}function TI(e){const t=e.document.selection.getSelectedElement();return t&&e.schema.isObject(t)&&e.schema.isBlock(t)?t:null}function SI(e,t){return t.checkChild(e.parent,"listItem")&&t.checkChild(e,"$text")&&!t.isObject(e)}function II(e){return "numbered"==e||"customNumbered"==e}function PI(e,t,i){return fI(t,{direction:"forward"}).pop().index>e.index?kI(e,t,i):[]}class VI extends Za{_direction;constructor(e,t){super(e),this._direction=t;}refresh(){this.isEnabled=this._checkEnabled();}execute(){const e=this.editor.model,t=RI(e.document.selection);e.change((e=>{const i=[];AI(t)&&!bI(t[0])?("forward"==this._direction&&i.push(...CI(t,e)),i.push(...yI(t[0],e))):"forward"==this._direction?i.push(...CI(t,e,{expand:!0})):i.push(...function(e,t){const i=_I(e=Aa(e)),n=new Set,s=Math.min(...i.map((e=>e.getAttribute("listIndent")))),o=new Map;for(const e of i)o.set(e,cI.first(e,{lowerIndent:!0}));for(const e of i){if(n.has(e))continue;n.add(e);const i=e.getAttribute("listIndent")-1;if(i<0)xI(e,t);else {if(e.getAttribute("listIndent")==s){const i=PI(e,o.get(e),t);for(const e of i)n.add(e);if(i.length)continue}t.setAttribute("listIndent",i,e);}}return EI(n)}(t,e));for(const t of i){if(!t.hasAttribute("listType"))continue;const i=cI.first(t,{sameIndent:!0});i&&e.setAttribute("listType",i.getAttribute("listType"),t);}this._fireAfterExecute(i);}));}_fireAfterExecute(e){this.fire("afterExecute",EI(new Set(e)));}_checkEnabled(){let e=RI(this.editor.model.document.selection),t=e[0];if(!t)return !1;if("backward"==this._direction)return !0;if(AI(e)&&!bI(e[0]))return !0;e=_I(e),t=e[0];const i=cI.first(t,{sameIndent:!0});return !!i&&i.getAttribute("listType")==t.getAttribute("listType")}}function RI(e){const t=Array.from(e.getSelectedBlocks()),i=t.findIndex((e=>!mI(e)));return -1!=i&&(t.length=i),t}class BI extends Za{type;_listWalkerOptions;constructor(e,t,i={}){super(e),this.type=t,this._listWalkerOptions=i.multiLevel?{higherIndent:!0,lowerIndent:!0,sameAttributes:[]}:void 0;}refresh(){this.value=this._getValue(),this.isEnabled=this._checkEnabled();}execute(e={}){const t=this.editor.model,i=t.document,n=TI(t),s=Array.from(i.selection.getSelectedBlocks()).filter((e=>t.schema.checkAttribute(e,"listType")||SI(e,t.schema))),o=void 0!==e.forceValue?!e.forceValue:this.value;t.change((r=>{if(o){const e=s[s.length-1],t=fI(e,{direction:"forward"}),i=[];t.length>1&&i.push(...yI(t[1],r)),i.push(...xI(s,r)),i.push(...function(e,t){const i=[];let n=Number.POSITIVE_INFINITY;for(const{node:s}of dI(e.nextSibling,"forward")){const e=s.getAttribute("listIndent");if(0==e)break;e<n&&(n=e);const o=e-n;t.setAttribute("listIndent",o,s),i.push(s);}return i}(e,r)),this._fireAfterExecute(i);}else if((n||i.selection.isCollapsed)&&mI(s[0])){const t=pI(n||s[0],this._listWalkerOptions);for(const i of t)r.setAttributes({...e.additionalAttributes,listType:this.type},i);this._fireAfterExecute(t);}else {const i=[];for(const n of s)if(n.hasAttribute("listType"))for(const t of _I(n,{withNested:!1}))t.getAttribute("listType")!=this.type&&(r.setAttributes({...e.additionalAttributes,listType:this.type},t),i.push(t));else !n.is("element","listItem")&&SI(n,t.schema)&&r.rename(n,"listItem"),r.setAttributes({...e.additionalAttributes,listIndent:0,listItemId:uI.next(),listType:this.type},n),i.push(n);this._fireAfterExecute(i);}}));}_fireAfterExecute(e){this.fire("afterExecute",EI(new Set(e)));}_getValue(){const e=this.editor.model.document.selection,t=Array.from(e.getSelectedBlocks());if(!t.length)return !1;for(const e of t)if(e.getAttribute("listType")!=this.type)return !1;return !0}_checkEnabled(){const e=this.editor.model,t=e.schema,i=e.document.selection,n=Array.from(i.getSelectedBlocks());if(!n.length)return !1;if(this.value)return !0;for(const e of n)if(t.checkAttribute(e,"listType")||SI(e,t))return !0;return !1}}class OI extends Za{_direction;constructor(e,t){super(e),this._direction=t;}refresh(){this.isEnabled=this._checkEnabled();}execute({shouldMergeOnBlocksContentLevel:e=!1}={}){const t=this.editor.model,i=t.document.selection,n=[];t.change((s=>{const{firstElement:o,lastElement:r}=this._getMergeSubjectElements(i,e),a=o.getAttribute("listIndent")||0,l=r.getAttribute("listIndent"),c=r.getAttribute("listItemId");if(a!=l){const e=(d=r,Array.from(new cI(d,{direction:"forward",higherIndent:!0})));n.push(...CI([r,...e],s,{indentBy:a-l,expand:a<l}));}var d;if(e){let e=i;i.isCollapsed&&(e=s.createSelection(s.createRange(s.createPositionAt(o,"end"),s.createPositionAt(r,0)))),t.deleteContent(e,{doNotResetEntireContent:i.isCollapsed});const a=e.getLastPosition().parent,l=a.nextSibling;n.push(a),l&&l!==r&&l.getAttribute("listItemId")==c&&n.push(...kI(l,a,s));}else n.push(...kI(r,o,s));this._fireAfterExecute(n);}));}_fireAfterExecute(e){this.fire("afterExecute",EI(new Set(e)));}_checkEnabled(){const e=this.editor.model,t=e.document.selection,i=TI(e);if(t.isCollapsed||i){const e=i||t.getFirstPosition().parent;if(!mI(e))return !1;const n="backward"==this._direction?e.previousSibling:e.nextSibling;if(!n)return !1;if(AI([e,n]))return !1}else {const e=t.getLastPosition(),i=t.getFirstPosition();if(e.parent===i.parent)return !1;if(!mI(e.parent))return !1}return !0}_getMergeSubjectElements(e,t){const i=TI(this.editor.model);let n,s;if(e.isCollapsed||i){const o=i||e.getFirstPosition().parent,r=bI(o);"backward"==this._direction?(s=o,n=r&&!t?cI.first(o,{sameIndent:!0,lowerIndent:!0}):o.previousSibling):(n=o,s=o.nextSibling);}else n=e.getFirstPosition().parent,s=e.getLastPosition().parent;return {firstElement:n,lastElement:s}}}class MI extends Za{_direction;constructor(e,t){super(e),this._direction=t;}refresh(){this.isEnabled=this._checkEnabled();}execute(){this.editor.model.change((e=>{const t=yI(this._getStartBlock(),e);this._fireAfterExecute(t);}));}_fireAfterExecute(e){this.fire("afterExecute",EI(new Set(e)));}_checkEnabled(){const e=this.editor.model.document.selection,t=this._getStartBlock();return e.isCollapsed&&mI(t)&&!bI(t)}_getStartBlock(){const e=this.editor.model.document.selection.getFirstPosition().parent;return "before"==this._direction?e:e.nextSibling}}class LI extends Ga{static get pluginName(){return "ListUtils"}expandListBlocksToCompleteList(e){return vI(e)}isFirstBlockOfListItem(e){return bI(e)}isListItemBlock(e){return mI(e)}expandListBlocksToCompleteItems(e,t={}){return _I(e,t)}isNumberedListType(e){return II(e)}}function FI(e){return e.is("element","ol")||e.is("element","ul")}function NI(e){return e.is("element","li")}function DI(e,t,i,n=$I(i,t)){return e.createAttributeElement(HI(i),null,{priority:2*t/100-100,id:n})}function zI(e,t,i){return e.createAttributeElement("li",null,{priority:(2*t+1)/100-100,id:i})}function HI(e){return "numbered"==e||"customNumbered"==e?"ol":"ul"}function $I(e,t){return `list-${e}-${t}`}function UI(e,t){const i=e.nodeBefore;if(mI(i)){let e=i;for(const{node:i}of dI(e,"backward"))if(e=i,t.has(e))return;t.set(i,e);}else {const i=e.nodeAfter;mI(i)&&t.set(i,i);}}function WI(){return (e,t,i)=>{const{writer:n,schema:s}=i;if(!t.modelRange)return;const o=Array.from(t.modelRange.getItems({shallow:!0})).filter((e=>s.checkAttribute(e,"listItemId")));if(!o.length)return;const r=uI.next(),a=function(e){let t=0,i=e.parent;for(;i;){if(NI(i))t++;else {const e=i.previousSibling;e&&NI(e)&&t++;}i=i.parent;}return t}(t.viewItem);let l=t.viewItem.parent&&t.viewItem.parent.is("element","ol")?"numbered":"bulleted";const c=o[0].getAttribute("listType");c&&(l=c);const d={listItemId:r,listIndent:a,listType:l};for(const e of o)e.hasAttribute("listItemId")||n.setAttributes(d,e);o.length>1&&o[1].getAttribute("listItemId")!=d.listItemId&&i.keepEmptyElement(o[0]);}}function jI(e,t,i,{dataPipeline:n}={}){const s=function(e){return (t,i)=>{const n=[];for(const i of e)t.hasAttribute(i)&&n.push(`attribute:${i}`);return !!n.every((e=>!1!==i.test(t,e)))&&(n.forEach((e=>i.consume(t,e))),!0)}}(e);return (o,r,a)=>{const{writer:l,mapper:c,consumable:d}=a,h=r.item;if(!e.includes(r.attributeKey))return;if(!s(h,d))return;const u=function(e,t,i){const n=i.createRangeOn(e),s=t.toViewRange(n).getTrimmed();return s.end.nodeBefore}(h,c,i);GI(u,l,c),function(e,t){let i=e.parent;for(;i.is("attributeElement")&&["ul","ol","li"].includes(i.name);){const n=i.parent;t.unwrap(t.createRangeOn(e),i),i=n;}}(u,l);const m=function(e,t,i,n,{dataPipeline:s}){let o=n.createRangeOn(t);if(!bI(e))return o;for(const r of i){if("itemMarker"!=r.scope)continue;const i=r.createElement(n,e,{dataPipeline:s});if(!i)continue;if(n.setCustomProperty("listItemMarker",!0,i),r.canInjectMarkerIntoElement&&r.canInjectMarkerIntoElement(e)?n.insert(n.createPositionAt(t,0),i):(n.insert(o.start,i),o=n.createRange(n.createPositionBefore(i),n.createPositionAfter(t))),!r.createWrapperElement||!r.canWrapElement)continue;const a=r.createWrapperElement(n,e,{dataPipeline:s});n.setCustomProperty("listItemWrapper",!0,a),r.canWrapElement(e)?o=n.wrap(o,a):(o=n.wrap(n.createRangeOn(i),a),o=n.createRange(o.start,n.createPositionAfter(t)));}return o}(h,u,t,l,{dataPipeline:n});!function(e,t,i,n){if(!e.hasAttribute("listIndent"))return;const s=e.getAttribute("listIndent");let o=e;for(let e=s;e>=0;e--){const s=zI(n,e,o.getAttribute("listItemId")),r=DI(n,e,o.getAttribute("listType"));for(const e of i)"list"!=e.scope&&"item"!=e.scope||!o.hasAttribute(e.attributeName)||e.setAttributeOnDowncast(n,o.getAttribute(e.attributeName),"list"==e.scope?r:s);if(t=n.wrap(t,s),t=n.wrap(t,r),0==e)break;if(o=cI.first(o,{lowerIndent:!0}),!o)break}}(h,m,t,l);}}function qI(e,{dataPipeline:t}={}){return (i,{writer:n})=>{if(!KI(i,e))return null;if(!t)return n.createContainerElement("span",{class:"ck-list-bogus-paragraph"});const s=n.createContainerElement("p");return n.setCustomProperty("dataPipeline:transparentRendering",!0,s),s}}function GI(e,t,i){for(;e.parent.is("attributeElement")&&e.parent.getCustomProperty("listItemWrapper");)t.unwrap(t.createRangeOn(e),e.parent);const n=[];s(t.createPositionBefore(e).getWalker({direction:"backward"})),s(t.createRangeIn(e).getWalker());for(const e of n)t.remove(e);function s(e){for(const{item:t}of e){if(t.is("element")&&i.toModelElement(t))break;t.is("element")&&t.getCustomProperty("listItemMarker")&&n.push(t);}}}function KI(e,t,i=gI(e)){if(!mI(e))return !1;for(const i of e.getAttributeKeys())if(!i.startsWith("selection:")&&!t.includes(i))return !1;return i.length<2}const ZI=["listType","listIndent","listItemId"];class JI extends Ga{_downcastStrategies=[];static get pluginName(){return "ListEditing"}static get requires(){return [oy,U_,LI,ak]}constructor(e){super(e),e.config.define("list.multiBlock",!0);}init(){const e=this.editor,t=e.model,i=e.config.get("list.multiBlock");if(e.plugins.has("LegacyListEditing"))throw new E("list-feature-conflict",this,{conflictPlugin:"LegacyListEditing"});t.schema.register("$listItem",{allowAttributes:ZI}),i?(t.schema.extend("$container",{allowAttributesOf:"$listItem"}),t.schema.extend("$block",{allowAttributesOf:"$listItem"}),t.schema.extend("$blockObject",{allowAttributesOf:"$listItem"})):t.schema.register("listItem",{inheritAllFrom:"$block",allowAttributesOf:"$listItem"});for(const e of ZI)t.schema.setAttributeProperties(e,{copyOnReplace:!0});e.commands.add("numberedList",new BI(e,"numbered")),e.commands.add("bulletedList",new BI(e,"bulleted")),e.commands.add("customNumberedList",new BI(e,"customNumbered",{multiLevel:!0})),e.commands.add("customBulletedList",new BI(e,"customBulleted",{multiLevel:!0})),e.commands.add("indentList",new VI(e,"forward")),e.commands.add("outdentList",new VI(e,"backward")),e.commands.add("splitListItemBefore",new MI(e,"before")),e.commands.add("splitListItemAfter",new MI(e,"after")),i&&(e.commands.add("mergeListItemBackward",new OI(e,"backward")),e.commands.add("mergeListItemForward",new OI(e,"forward"))),this._setupDeleteIntegration(),this._setupEnterIntegration(),this._setupTabIntegration(),this._setupClipboardIntegration(),this._setupAccessibilityIntegration();}afterInit(){const e=this.editor.commands,t=e.get("indent"),i=e.get("outdent");t&&t.registerChildCommand(e.get("indentList"),{priority:"high"}),i&&i.registerChildCommand(e.get("outdentList"),{priority:"lowest"}),this._setupModelPostFixing(),this._setupConversion();}registerDowncastStrategy(e){this._downcastStrategies.push(e);}getListAttributeNames(){return [...ZI,...this._downcastStrategies.map((e=>e.attributeName))]}_setupDeleteIntegration(){const e=this.editor,t=e.commands.get("mergeListItemBackward"),i=e.commands.get("mergeListItemForward");this.listenTo(e.editing.view.document,"delete",((n,s)=>{const o=e.model.document.selection;TI(e.model)||e.model.change((()=>{const r=o.getFirstPosition();if(o.isCollapsed&&"backward"==s.direction){if(!r.isAtStart)return;const i=r.parent;if(!mI(i))return;if(cI.first(i,{sameAttributes:"listType",sameIndent:!0})||0!==i.getAttribute("listIndent")){if(!t||!t.isEnabled)return;t.execute({shouldMergeOnBlocksContentLevel:QI(e.model,"backward")});}else wI(i)||e.execute("splitListItemAfter"),e.execute("outdentList");s.preventDefault(),n.stop();}else {if(o.isCollapsed&&!o.getLastPosition().isAtEnd)return;if(!i||!i.isEnabled)return;i.execute({shouldMergeOnBlocksContentLevel:QI(e.model,"forward")}),s.preventDefault(),n.stop();}}));}),{context:"li"});}_setupEnterIntegration(){const e=this.editor,t=e.model,i=e.commands,n=i.get("enter");this.listenTo(e.editing.view.document,"enter",((i,n)=>{const s=t.document,o=s.selection.getFirstPosition().parent;if(s.selection.isCollapsed&&mI(o)&&o.isEmpty&&!n.isSoft){const t=bI(o),s=wI(o);t&&s?(e.execute("outdentList"),n.preventDefault(),i.stop()):t&&!s?(e.execute("splitListItemAfter"),n.preventDefault(),i.stop()):s&&(e.execute("splitListItemBefore"),n.preventDefault(),i.stop());}}),{context:"li"}),this.listenTo(n,"afterExecute",(()=>{const t=i.get("splitListItemBefore");if(t.refresh(),!t.isEnabled)return;2===gI(e.model.document.selection.getLastPosition().parent).length&&t.execute();}));}_setupTabIntegration(){const e=this.editor;this.listenTo(e.editing.view.document,"tab",((t,i)=>{const n=i.shiftKey?"outdentList":"indentList";this.editor.commands.get(n).isEnabled&&(e.execute(n),i.stopPropagation(),i.preventDefault(),t.stop());}),{context:"li"});}_setupConversion(){const e=this.editor,t=e.model,i=this.getListAttributeNames(),n=e.config.get("list.multiBlock"),s=n?"paragraph":"listItem";e.conversion.for("upcast").elementToElement({view:"li",model:(e,{writer:t})=>t.createElement(s,{listType:""})}).elementToElement({view:"p",model:(e,{writer:t})=>e.parent&&e.parent.is("element","li")?t.createElement(s,{listType:""}):null,converterPriority:"high"}).add((e=>{e.on("element:li",WI());})),n||e.conversion.for("downcast").elementToElement({model:"listItem",view:"p"}),e.conversion.for("editingDowncast").elementToElement({model:s,view:qI(i),converterPriority:"high"}).add((e=>{var n;e.on("attribute",jI(i,this._downcastStrategies,t)),e.on("remove",(n=t.schema,(e,t,i)=>{const{writer:s,mapper:o}=i,r=e.name.split(":")[1];if(!n.checkAttribute(r,"listItemId"))return;const a=o.toViewPosition(t.position),l=t.position.getShiftedBy(t.length),c=o.toViewPosition(l,{isPhantom:!0}),d=s.createRange(a,c).getTrimmed().end.nodeBefore;d&&GI(d,s,o);}));})),e.conversion.for("dataDowncast").elementToElement({model:s,view:qI(i,{dataPipeline:!0}),converterPriority:"high"}).add((e=>{e.on("attribute",jI(i,this._downcastStrategies,t,{dataPipeline:!0}));}));const o=(r=this._downcastStrategies,a=e.editing.view,(e,t)=>{if(t.modelPosition.offset>0)return;const i=t.modelPosition.parent;if(!mI(i))return;if(!r.some((e=>"itemMarker"==e.scope&&e.canInjectMarkerIntoElement&&e.canInjectMarkerIntoElement(i))))return;const n=t.mapper.toViewElement(i),s=a.createRangeIn(n),o=s.getWalker();let l=s.start;for(const{item:e}of o){if(e.is("element")&&t.mapper.toModelElement(e)||e.is("$textProxy"))break;e.is("element")&&e.getCustomProperty("listItemMarker")&&(l=a.createPositionAfter(e),o.skip((({previousPosition:e})=>!e.isEqual(l))));}t.viewPosition=l;});var r,a;e.editing.mapper.on("modelToViewPosition",o),e.data.mapper.on("modelToViewPosition",o),this.listenTo(t.document,"change:data",function(e,t,i,n){return ()=>{const n=e.document.differ.getChanges(),r=[],a=new Map,l=new Set;for(const e of n)if("insert"==e.type&&"$text"!=e.name)UI(e.position,a),e.attributes.has("listItemId")?l.add(e.position.nodeAfter):UI(e.position.getShiftedBy(e.length),a);else if("remove"==e.type&&e.attributes.has("listItemId"))UI(e.position,a);else if("attribute"==e.type){const t=e.range.start.nodeAfter;i.includes(e.attributeKey)?(UI(e.range.start,a),null===e.attributeNewValue?(UI(e.range.start.getShiftedBy(1),a),o(t)&&r.push(t)):l.add(t)):mI(t)&&o(t)&&r.push(t);}for(const e of a.values())r.push(...s(e,l));for(const e of new Set(r))t.reconvertItem(e);};function s(e,t){const n=[],s=new Set,a=[];for(const{node:l,previous:c}of dI(e,"forward")){if(s.has(l))continue;const e=l.getAttribute("listIndent");c&&e<c.getAttribute("listIndent")&&(a.length=e+1),a[e]=Object.fromEntries(Array.from(l.getAttributes()).filter((([e])=>i.includes(e))));const d=fI(l,{direction:"forward"});for(const e of d)s.add(e),(o(e,d)||r(e,a,t))&&n.push(e);}return n}function o(e,s){const o=t.mapper.toViewElement(e);if(!o)return !1;if(n.fire("checkElement",{modelElement:e,viewElement:o}))return !0;if(!e.is("element","paragraph")&&!e.is("element","listItem"))return !1;const r=KI(e,i,s);return !(!r||!o.is("element","p"))||!(r||!o.is("element","span"))}function r(e,i,s){if(s.has(e))return !1;const o=t.mapper.toViewElement(e);let r=i.length-1;for(let e=o.parent;!e.is("editableElement");e=e.parent){const t=NI(e),s=FI(e);if(!s&&!t)continue;const o="checkAttributes:"+(t?"item":"list");if(n.fire(o,{viewElement:e,modelAttributes:i[r]}))break;if(s&&(r--,r<0))return !1}return !0}}(t,e.editing,i,this),{priority:"high"}),this.on("checkAttributes:item",((e,{viewElement:t,modelAttributes:i})=>{t.id!=i.listItemId&&(e.return=!0,e.stop());})),this.on("checkAttributes:list",((e,{viewElement:t,modelAttributes:i})=>{t.name==HI(i.listType)&&t.id==$I(i.listType,i.listIndent)||(e.return=!0,e.stop());}));}_setupModelPostFixing(){const e=this.editor.model,t=this.getListAttributeNames();e.document.registerPostFixer((i=>function(e,t,i,n){const s=e.document.differ.getChanges(),o=new Map,r=n.editor.config.get("list.multiBlock");let a=!1;for(const n of s){if("insert"==n.type&&"$text"!=n.name){const s=n.position.nodeAfter;if(!e.schema.checkAttribute(s,"listItemId"))for(const e of Array.from(s.getAttributeKeys()))i.includes(e)&&(t.removeAttribute(e,s),a=!0);UI(n.position,o),n.attributes.has("listItemId")||UI(n.position.getShiftedBy(n.length),o);for(const{item:t,previousPosition:i}of e.createRangeIn(s))mI(t)&&UI(i,o);}else "remove"==n.type?UI(n.position,o):"attribute"==n.type&&i.includes(n.attributeKey)&&(UI(n.range.start,o),null===n.attributeNewValue&&UI(n.range.start.getShiftedBy(1),o));if(!r&&"attribute"==n.type&&ZI.includes(n.attributeKey)){const e=n.range.start.nodeAfter;null===n.attributeNewValue&&e&&e.is("element","listItem")?(t.rename(e,"paragraph"),a=!0):null===n.attributeOldValue&&e&&e.is("element")&&"listItem"!=e.name&&(t.rename(e,"listItem"),a=!0);}}const l=new Set;for(const e of o.values())a=n.fire("postFixer",{listNodes:new hI(e),listHead:e,writer:t,seenIds:l})||a;return a}(e,i,t,this))),this.on("postFixer",((e,{listNodes:t,writer:i})=>{e.return=function(e,t){let i=0,n=-1,s=null,o=!1;for(const{node:r}of e){const e=r.getAttribute("listIndent");if(e>i){let a;null===s?(s=e-i,a=i):(s>e&&(s=e),a=e-s),a>n+1&&(a=n+1),t.setAttribute("listIndent",a,r),o=!0,n=a;}else s=null,i=e+1,n=e;}return o}(t,i)||e.return;}),{priority:"high"}),this.on("postFixer",((e,{listNodes:t,writer:i,seenIds:n})=>{e.return=function(e,t,i){const n=new Set;let s=!1;for(const{node:o}of e){if(n.has(o))continue;let e=o.getAttribute("listType"),r=o.getAttribute("listItemId");if(t.has(r)&&(r=uI.next()),t.add(r),o.is("element","listItem"))o.getAttribute("listItemId")!=r&&(i.setAttribute("listItemId",r,o),s=!0);else for(const t of fI(o,{direction:"forward"}))n.add(t),t.getAttribute("listType")!=e&&(r=uI.next(),e=t.getAttribute("listType")),t.getAttribute("listItemId")!=r&&(i.setAttribute("listItemId",r,t),s=!0);}return s}(t,n,i)||e.return;}),{priority:"high"});}_setupClipboardIntegration(){const e=this.editor.model,t=this.editor.plugins.get("ClipboardPipeline");this.listenTo(e,"insertContent",function(e){return (t,[i,n])=>{const s=i.is("documentFragment")?Array.from(i.getChildren()):[i];if(!s.length)return;const o=(n?e.createSelection(n):e.document.selection).getFirstPosition();let r;if(mI(o.parent))r=o.parent;else {if(!mI(o.nodeBefore))return;r=o.nodeBefore;}e.change((e=>{const t=r.getAttribute("listType"),i=r.getAttribute("listIndent"),n=s[0].getAttribute("listIndent")||0,o=Math.max(i-n,0);for(const i of s){const n=mI(i);r.is("element","listItem")&&i.is("element","paragraph")&&e.rename(i,"listItem"),e.setAttributes({listIndent:(n?i.getAttribute("listIndent"):0)+o,listItemId:n?i.getAttribute("listItemId"):uI.next(),listType:t},i);}}));}}(e),{priority:"high"}),this.listenTo(t,"outputTransformation",((t,i)=>{e.change((e=>{const t=Array.from(i.content.getChildren()),n=t[t.length-1];if(t.length>1&&n.is("element")&&n.isEmpty){t.slice(0,-1).every(mI)&&e.remove(n);}if("copy"==i.method||"cut"==i.method){const t=Array.from(i.content.getChildren());AI(t)&&xI(t,e);}}));}));}_setupAccessibilityIntegration(){const e=this.editor,t=e.t;e.accessibility.addKeystrokeInfoGroup({id:"list",label:t("Keystrokes that can be used in a list"),keystrokes:[{label:t("Increase list item indent"),keystroke:"Tab"},{label:t("Decrease list item indent"),keystroke:"Shift+Tab"}]});}}function QI(e,t){const i=e.document.selection;if(!i.isCollapsed)return !TI(e);if("forward"===t)return !0;const n=i.getFirstPosition().parent,s=n.previousSibling;return !e.schema.isObject(s)&&(!!s.isEmpty||AI([n,s]))}function YI(e,t,i,n){e.ui.componentFactory.add(t,(()=>{const s=XI(Ef,e,t,i,n);return s.set({tooltip:!0,isToggleable:!0}),s})),e.ui.componentFactory.add(`menuBar:${t}`,(()=>{const s=XI($f,e,t,i,n);return s.set({role:"menuitemcheckbox",isToggleable:!0}),s}));}function XI(e,t,i,n,s){const o=t.commands.get(i),r=new e(t.locale);return r.set({label:n,icon:s}),r.bind("isOn","isEnabled").to(o,"value","isEnabled"),r.on("execute",(()=>{t.execute(i),t.editing.view.focus();})),r}class eP extends Ga{static get pluginName(){return "ListUI"}init(){const e=this.editor.t;this.editor.ui.componentFactory.has("numberedList")||YI(this.editor,"numberedList",e("Numbered List"),Ig.numberedList),this.editor.ui.componentFactory.has("bulletedList")||YI(this.editor,"bulletedList",e("Bulleted List"),Ig.bulletedList);}}class tP extends Ga{static get requires(){return [JI,eP]}static get pluginName(){return "List"}}class iP extends Za{refresh(){const e=this._getValue();this.value=e,this.isEnabled=null!=e;}execute({startIndex:e=1}={}){const t=this.editor.model,i=t.document;let n=Array.from(i.selection.getSelectedBlocks()).filter((e=>mI(e)&&II(e.getAttribute("listType"))));n=vI(n),t.change((t=>{for(const i of n)t.setAttribute("listStart",e>=0?e:1,i);}));}_getValue(){const e=Ia(this.editor.model.document.selection.getSelectedBlocks());return e&&mI(e)&&II(e.getAttribute("listType"))?e.getAttribute("listStart"):null}}const nP={},sP={},oP={},rP=[{listStyle:"disc",typeAttribute:"disc",listType:"bulleted"},{listStyle:"circle",typeAttribute:"circle",listType:"bulleted"},{listStyle:"square",typeAttribute:"square",listType:"bulleted"},{listStyle:"decimal",typeAttribute:"1",listType:"numbered"},{listStyle:"decimal-leading-zero",typeAttribute:null,listType:"numbered"},{listStyle:"lower-roman",typeAttribute:"i",listType:"numbered"},{listStyle:"upper-roman",typeAttribute:"I",listType:"numbered"},{listStyle:"lower-alpha",typeAttribute:"a",listType:"numbered"},{listStyle:"upper-alpha",typeAttribute:"A",listType:"numbered"},{listStyle:"lower-latin",typeAttribute:"a",listType:"numbered"},{listStyle:"upper-latin",typeAttribute:"A",listType:"numbered"}];for(const{listStyle:e,typeAttribute:t,listType:i}of rP)nP[e]=i,sP[e]=t,t&&(oP[t]=e);function aP(){return rP.map((e=>e.listStyle))}function lP(e){return nP[e]||null}function cP(e){return oP[e]||null}function dP(e){return sP[e]||null}class hP extends Za{defaultType;_supportedTypes;constructor(e,t,i){super(e),this.defaultType=t,this._supportedTypes=i;}refresh(){this.value=this._getValue(),this.isEnabled=this._checkEnabled();}execute(e={}){const t=this.editor.model,i=t.document;t.change((t=>{this._tryToConvertItemsToList(e);let n=Array.from(i.selection.getSelectedBlocks()).filter((e=>e.hasAttribute("listType")));if(n.length){n=vI(n);for(const i of n)t.setAttribute("listStyle",e.type||this.defaultType,i);}}));}isStyleTypeSupported(e){return !this._supportedTypes||this._supportedTypes.includes(e)}_getValue(){const e=Ia(this.editor.model.document.selection.getSelectedBlocks());return mI(e)?e.getAttribute("listStyle"):null}_checkEnabled(){const e=this.editor,t=e.commands.get("numberedList"),i=e.commands.get("bulletedList");return t.isEnabled||i.isEnabled}_tryToConvertItemsToList(e){if(!e.type)return;const t=lP(e.type);if(!t)return;const i=this.editor,n=`${t}List`;i.commands.get(n).value||i.execute(n);}}class uP extends Za{refresh(){const e=this._getValue();this.value=e,this.isEnabled=null!=e;}execute(e={}){const t=this.editor.model,i=t.document;let n=Array.from(i.selection.getSelectedBlocks()).filter((e=>mI(e)&&"numbered"==e.getAttribute("listType")));n=vI(n),t.change((t=>{for(const i of n)t.setAttribute("listReversed",!!e.reversed,i);}));}_getValue(){const e=Ia(this.editor.model.document.selection.getSelectedBlocks());return mI(e)&&"numbered"==e.getAttribute("listType")?e.getAttribute("listReversed"):null}}function mP(e){return (t,i,n)=>{const{writer:s,schema:o,consumable:r}=n;if(!1===r.test(i.viewItem,e.viewConsumables))return;i.modelRange||Object.assign(i,n.convertChildren(i.viewItem,i.modelCursor));let a=!1;for(const t of i.modelRange.getItems({shallow:!0}))o.checkAttribute(t,e.attributeName)&&e.appliesToListItem(t)&&(t.hasAttribute(e.attributeName)||(s.setAttribute(e.attributeName,e.getAttributeOnUpcast(i.viewItem),t),a=!0));a&&r.consume(i.viewItem,e.viewConsumables);}}class gP extends Ga{static get pluginName(){return "ListPropertiesUtils"}getAllSupportedStyleTypes(){return aP()}getListTypeFromListStyleType(e){return lP(e)}getListStyleTypeFromTypeAttribute(e){return cP(e)}getTypeAttributeFromListStyleType(e){return dP(e)}}function fP(e){const{startIndex:t,reversed:i,styles:n}=e;return {styles:pP(n),startIndex:t||!1,reversed:i||!1}}function pP(e){const t={listTypes:["bulleted","numbered"],useAttribute:!1};return !0===e||(e?Array.isArray(e)||"string"==typeof e?t.listTypes=Aa(e):(t.listTypes=e.listTypes?Aa(e.listTypes):t.listTypes,t.useAttribute=!!e.useAttribute):t.listTypes=[]),t}const bP="default";class wP extends Ga{static get requires(){return [JI,gP]}static get pluginName(){return "ListPropertiesEditing"}constructor(e){super(e),e.config.define("list.properties",{styles:!0,startIndex:!1,reversed:!1});}init(){const e=this.editor,t=e.model,i=e.plugins.get(JI),n=function(e){const t=[],i=fP(e);if(e.styles){const e=i.styles.useAttribute;t.push({attributeName:"listStyle",defaultValue:bP,viewConsumables:{styles:"list-style-type"},addCommand(t){let i=aP();e&&(i=i.filter((e=>!!dP(e)))),t.commands.add("listStyle",new hP(t,bP,i));},appliesToListItem:e=>"numbered"==e.getAttribute("listType")||"bulleted"==e.getAttribute("listType"),hasValidAttribute(e){if(!this.appliesToListItem(e))return !e.hasAttribute("listStyle");if(!e.hasAttribute("listStyle"))return !1;const t=e.getAttribute("listStyle");return t==bP||lP(t)==e.getAttribute("listType")},setAttributeOnDowncast(t,i,n){if(i&&i!==bP){if(!e)return void t.setStyle("list-style-type",i,n);{const e=dP(i);if(e)return void t.setAttribute("type",e,n)}}t.removeStyle("list-style-type",n),t.removeAttribute("type",n);},getAttributeOnUpcast(e){const t=e.getStyle("list-style-type");if(t)return t;const i=e.getAttribute("type");return i?cP(i):bP}});}e.reversed&&t.push({attributeName:"listReversed",defaultValue:!1,viewConsumables:{attributes:"reversed"},addCommand(e){e.commands.add("listReversed",new uP(e));},appliesToListItem:e=>"numbered"==e.getAttribute("listType"),hasValidAttribute(e){return this.appliesToListItem(e)==e.hasAttribute("listReversed")},setAttributeOnDowncast(e,t,i){t?e.setAttribute("reversed","reversed",i):e.removeAttribute("reversed",i);},getAttributeOnUpcast:e=>e.hasAttribute("reversed")});e.startIndex&&t.push({attributeName:"listStart",defaultValue:1,viewConsumables:{attributes:"start"},addCommand(e){e.commands.add("listStart",new iP(e));},appliesToListItem:e=>II(e.getAttribute("listType")),hasValidAttribute(e){return this.appliesToListItem(e)==e.hasAttribute("listStart")},setAttributeOnDowncast(e,t,i){0==t||t>1?e.setAttribute("start",t,i):e.removeAttribute("start",i);},getAttributeOnUpcast(e){const t=e.getAttribute("start");return t>=0?t:1}});return t}(e.config.get("list.properties"));for(const s of n)s.addCommand(e),t.schema.extend("$listItem",{allowAttributes:s.attributeName}),i.registerDowncastStrategy({scope:"list",attributeName:s.attributeName,setAttributeOnDowncast(e,t,i){s.setAttributeOnDowncast(e,t,i);}});e.conversion.for("upcast").add((e=>{for(const t of n)e.on("element:ol",mP(t)),e.on("element:ul",mP(t));})),i.on("checkAttributes:list",((e,{viewElement:t,modelAttributes:i})=>{for(const s of n)s.getAttributeOnUpcast(t)!=i[s.attributeName]&&(e.return=!0,e.stop());})),this.listenTo(e.commands.get("indentList"),"afterExecute",((e,i)=>{t.change((e=>{for(const t of i)for(const i of n)i.appliesToListItem(t)&&e.setAttribute(i.attributeName,i.defaultValue,t);}));})),i.on("postFixer",((e,{listNodes:t,writer:i})=>{for(const{node:s}of t)for(const t of n)t.hasValidAttribute(s)||(t.appliesToListItem(s)?i.setAttribute(t.attributeName,t.defaultValue,s):i.removeAttribute(t.attributeName,s),e.return=!0);})),i.on("postFixer",((e,{listNodes:t,writer:i})=>{for(const{node:s,previousNodeInList:o}of t)if(o&&o.getAttribute("listType")==s.getAttribute("listType"))for(const t of n){const{attributeName:n}=t;if(!t.appliesToListItem(s))continue;const r=o.getAttribute(n);s.getAttribute(n)!=r&&(i.setAttribute(n,r,s),e.return=!0);}}));}}class _P extends wf{children;stylesView=null;additionalPropertiesCollapsibleView=null;startIndexFieldView=null;reversedSwitchButtonView=null;focusTracker=new Pa;keystrokes=new Va;focusables=new Zg;focusCycler;constructor(e,{enabledProperties:t,styleButtonViews:i,styleGridAriaLabel:n}){super(e);const s=["ck","ck-list-properties"];this.children=this.createCollection(),this.focusCycler=new If({focusables:this.focusables,focusTracker:this.focusTracker,keystrokeHandler:this.keystrokes,actions:{focusPrevious:"shift + tab",focusNext:"tab"}}),i&&i.length?(this.stylesView=this._createStylesView(i,n),this.children.add(this.stylesView)):s.push("ck-list-properties_without-styles"),(t.startIndex||t.reversed)&&(this._addNumberedListPropertyViews(t),s.push("ck-list-properties_with-numbered-properties")),this.setTemplate({tag:"div",attributes:{class:s},children:this.children});}render(){if(super.render(),this.stylesView){this.focusables.add(this.stylesView),this.focusTracker.add(this.stylesView.element),(this.startIndexFieldView||this.reversedSwitchButtonView)&&(this.focusables.add(this.children.last.buttonView),this.focusTracker.add(this.children.last.buttonView.element));for(const e of this.stylesView.children)this.stylesView.focusTracker.add(e.element);Cf({keystrokeHandler:this.stylesView.keystrokes,focusTracker:this.stylesView.focusTracker,gridItems:this.stylesView.children,numberOfColumns:()=>i.window.getComputedStyle(this.stylesView.element).getPropertyValue("grid-template-columns").split(" ").length,uiLanguageDirection:this.locale&&this.locale.uiLanguageDirection});}if(this.startIndexFieldView){this.focusables.add(this.startIndexFieldView),this.focusTracker.add(this.startIndexFieldView.element);const e=e=>e.stopPropagation();this.keystrokes.set("arrowright",e),this.keystrokes.set("arrowleft",e),this.keystrokes.set("arrowup",e),this.keystrokes.set("arrowdown",e);}this.reversedSwitchButtonView&&(this.focusables.add(this.reversedSwitchButtonView),this.focusTracker.add(this.reversedSwitchButtonView.element)),this.keystrokes.listenTo(this.element);}focus(){this.focusCycler.focusFirst();}focusLast(){this.focusCycler.focusLast();}destroy(){super.destroy(),this.focusTracker.destroy(),this.keystrokes.destroy();}_createStylesView(e,t){const i=new wf(this.locale);return i.children=i.createCollection(),i.children.addMany(e),i.setTemplate({tag:"div",attributes:{"aria-label":t,class:["ck","ck-list-styles-list"]},children:i.children}),i.children.delegate("execute").to(this),i.focus=function(){this.children.first.focus();},i.focusTracker=new Pa,i.keystrokes=new Va,i.render(),i.keystrokes.listenTo(i.element),i}_addNumberedListPropertyViews(e){const t=this.locale.t,i=[];e.startIndex&&(this.startIndexFieldView=this._createStartIndexField(),i.push(this.startIndexFieldView)),e.reversed&&(this.reversedSwitchButtonView=this._createReversedSwitchButton(),i.push(this.reversedSwitchButtonView)),this.stylesView?(this.additionalPropertiesCollapsibleView=new tp(this.locale,i),this.additionalPropertiesCollapsibleView.set({label:t("List properties"),isCollapsed:!0}),this.additionalPropertiesCollapsibleView.buttonView.bind("isEnabled").toMany(i,"isEnabled",((...e)=>e.some((e=>e)))),this.additionalPropertiesCollapsibleView.buttonView.on("change:isEnabled",((e,t,i)=>{i||(this.additionalPropertiesCollapsibleView.isCollapsed=!0);})),this.children.add(this.additionalPropertiesCollapsibleView)):this.children.addMany(i);}_createStartIndexField(){const e=this.locale.t,t=new Ap(this.locale,wb);return t.set({label:e("Start at"),class:"ck-numbered-list-properties__start-index"}),t.fieldView.set({min:0,step:1,value:1,inputMode:"numeric"}),t.fieldView.on("input",(()=>{const i=t.fieldView.element,n=i.valueAsNumber;Number.isNaN(n)?t.errorText=e("Invalid start index value."):i.checkValidity()?this.fire("listStart",{startIndex:n}):t.errorText=e("Start index must be greater than 0.");})),t}_createReversedSwitchButton(){const e=this.locale.t,t=new Zf(this.locale);return t.set({withText:!0,label:e("Reversed order"),class:"ck-numbered-list-properties__reversed-order"}),t.delegate("execute").to(this,"listReversed"),t}}class vP extends Ga{static get pluginName(){return "ListPropertiesUI"}init(){const e=this.editor,t=e.locale.t,i=e.config.get("list.properties"),n=fP(i),s=n.styles.listTypes;if(s.includes("bulleted")){const i=[{label:t("Toggle the disc list style"),tooltip:t("Disc"),type:"disc",icon:'<svg viewBox="0 0 44 44" xmlns="http://www.w3.org/2000/svg"><path d="M35 29a1 1 0 0 1 1 1v1a1 1 0 0 1-1 1H18a1 1 0 0 1-1-1v-1a1 1 0 0 1 1-1h17zm0-9a1 1 0 0 1 1 1v1a1 1 0 0 1-1 1H18a1 1 0 0 1-1-1v-1a1 1 0 0 1 1-1h17zm0-9a1 1 0 0 1 1 1v1a1 1 0 0 1-1 1H18a1 1 0 0 1-1-1v-1a1 1 0 0 1 1-1h17z" fill-opacity=".163"/><path d="M11 27a3 3 0 1 1 0 6 3 3 0 0 1 0-6zm0-9a3 3 0 1 1 0 6 3 3 0 0 1 0-6zm0-9a3 3 0 1 1 0 6 3 3 0 0 1 0-6z"/></svg>'},{label:t("Toggle the circle list style"),tooltip:t("Circle"),type:"circle",icon:'<svg viewBox="0 0 44 44" xmlns="http://www.w3.org/2000/svg"><path d="M35 29a1 1 0 0 1 1 1v1a1 1 0 0 1-1 1H18a1 1 0 0 1-1-1v-1a1 1 0 0 1 1-1h17zm0-9a1 1 0 0 1 1 1v1a1 1 0 0 1-1 1H18a1 1 0 0 1-1-1v-1a1 1 0 0 1 1-1h17zm0-9a1 1 0 0 1 1 1v1a1 1 0 0 1-1 1H18a1 1 0 0 1-1-1v-1a1 1 0 0 1 1-1h17z" fill-opacity=".163"/><path d="M11 27a3 3 0 1 1 0 6 3 3 0 0 1 0-6zm0 1a2 2 0 1 0 0 4 2 2 0 0 0 0-4zm0-10a3 3 0 1 1 0 6 3 3 0 0 1 0-6zm0 1a2 2 0 1 0 0 4 2 2 0 0 0 0-4zm0-10a3 3 0 1 1 0 6 3 3 0 0 1 0-6zm0 1a2 2 0 1 0 0 4 2 2 0 0 0 0-4z"/></svg>'},{label:t("Toggle the square list style"),tooltip:t("Square"),type:"square",icon:'<svg viewBox="0 0 44 44" xmlns="http://www.w3.org/2000/svg"><path d="M35 29a1 1 0 0 1 1 1v1a1 1 0 0 1-1 1H18a1 1 0 0 1-1-1v-1a1 1 0 0 1 1-1h17zm0-9a1 1 0 0 1 1 1v1a1 1 0 0 1-1 1H18a1 1 0 0 1-1-1v-1a1 1 0 0 1 1-1h17zm0-9a1 1 0 0 1 1 1v1a1 1 0 0 1-1 1H18a1 1 0 0 1-1-1v-1a1 1 0 0 1 1-1h17z" fill-opacity=".163"/><path d="M14 27v6H8v-6h6zm0-9v6H8v-6h6zm0-9v6H8V9h6z"/></svg>'}],s=t("Bulleted List"),o=t("Bulleted list styles toolbar"),r="bulletedList";e.ui.componentFactory.add(r,yP({editor:e,normalizedConfig:n,parentCommandName:r,buttonLabel:s,buttonIcon:Ig.bulletedList,styleGridAriaLabel:o,styleDefinitions:i})),e.ui.componentFactory.add(`menuBar:${r}`,CP({editor:e,normalizedConfig:n,parentCommandName:r,buttonLabel:s,styleGridAriaLabel:o,styleDefinitions:i}));}if(s.includes("numbered")||i.startIndex||i.reversed){const i=[{label:t("Toggle the decimal list style"),tooltip:t("Decimal"),type:"decimal",icon:'<svg viewBox="0 0 44 44" xmlns="http://www.w3.org/2000/svg"><path d="M35 29a1 1 0 0 1 1 1v1a1 1 0 0 1-1 1H18a1 1 0 0 1-1-1v-1a1 1 0 0 1 1-1h17zm0-9a1 1 0 0 1 1 1v1a1 1 0 0 1-1 1H18a1 1 0 0 1-1-1v-1a1 1 0 0 1 1-1h17zm0-9a1 1 0 0 1 1 1v1a1 1 0 0 1-1 1H18a1 1 0 0 1-1-1v-1a1 1 0 0 1 1-1h17z" fill-opacity=".163"/><path d="M10.29 15V8.531H9.286c-.14.393-.4.736-.778 1.03-.378.295-.728.495-1.05.6v1.121a4.257 4.257 0 0 0 1.595-.936V15h1.235zm3.343 0v-1.235h-1.235V15h1.235zM11.3 24v-1.147H8.848c.064-.111.148-.226.252-.343.104-.117.351-.354.74-.712.39-.357.66-.631.81-.821.225-.288.39-.562.494-.824.104-.263.156-.539.156-.829 0-.51-.182-.936-.545-1.279-.363-.342-.863-.514-1.499-.514-.58 0-1.063.148-1.45.444-.387.296-.617.784-.69 1.463l1.23.124c.024-.36.112-.619.264-.774.153-.155.358-.233.616-.233.26 0 .465.074.613.222.148.148.222.36.222.635 0 .25-.085.501-.255.756-.126.185-.468.536-1.024 1.055-.692.641-1.155 1.156-1.389 1.544-.234.389-.375.8-.422 1.233H11.3zm2.333 0v-1.235h-1.235V24h1.235zM9.204 34.11c.615 0 1.129-.2 1.542-.598.413-.398.62-.88.62-1.446 0-.39-.11-.722-.332-.997a1.5 1.5 0 0 0-.886-.532c.619-.337.928-.788.928-1.353 0-.399-.151-.756-.453-1.073-.366-.386-.852-.58-1.459-.58a2.25 2.25 0 0 0-.96.2 1.617 1.617 0 0 0-.668.55c-.16.232-.28.544-.358.933l1.138.194c.032-.282.123-.495.272-.642.15-.146.33-.22.54-.22.215 0 .386.065.515.194s.193.302.193.518c0 .255-.087.46-.263.613-.176.154-.43.227-.765.218l-.136 1.006c.22-.061.409-.092.567-.092.24 0 .444.09.61.272.168.182.251.428.251.739 0 .328-.087.589-.261.782a.833.833 0 0 1-.644.29.841.841 0 0 1-.607-.242c-.167-.16-.27-.394-.307-.698l-1.196.145c.062.542.285.98.668 1.316.384.335.868.503 1.45.503zm4.43-.11v-1.235h-1.236V34h1.235z"/></svg>'},{label:t("Toggle the decimal with leading zero list style"),tooltip:t("Decimal with leading zero"),type:"decimal-leading-zero",icon:'<svg viewBox="0 0 44 44" xmlns="http://www.w3.org/2000/svg"><path d="M35 29a1 1 0 0 1 1 1v1a1 1 0 0 1-1 1H18a1 1 0 0 1-1-1v-1a1 1 0 0 1 1-1h17zm0-9a1 1 0 0 1 1 1v1a1 1 0 0 1-1 1H18a1 1 0 0 1-1-1v-1a1 1 0 0 1 1-1h17zm0-9a1 1 0 0 1 1 1v1a1 1 0 0 1-1 1H18a1 1 0 0 1-1-1v-1a1 1 0 0 1 1-1h17z" fill-opacity=".163"/><path d="M5.714 15.11c.624 0 1.11-.22 1.46-.66.421-.533.632-1.408.632-2.627 0-1.222-.21-2.096-.629-2.624-.351-.445-.839-.668-1.463-.668-.624 0-1.11.22-1.459.66-.422.533-.633 1.406-.633 2.619 0 1.236.192 2.095.576 2.577.384.482.89.723 1.516.723zm0-1.024a.614.614 0 0 1-.398-.14c-.115-.094-.211-.283-.287-.565-.077-.283-.115-.802-.115-1.558s.043-1.294.128-1.613c.064-.246.155-.417.272-.512a.617.617 0 0 1 .4-.143.61.61 0 0 1 .398.143c.116.095.211.284.288.567.076.283.114.802.114 1.558s-.043 1.292-.128 1.608c-.064.246-.155.417-.272.512a.617.617 0 0 1-.4.143zm6.078.914V8.531H10.79c-.14.393-.4.736-.778 1.03-.378.295-.728.495-1.05.6v1.121a4.257 4.257 0 0 0 1.595-.936V15h1.235zm3.344 0v-1.235h-1.235V15h1.235zm-9.422 9.11c.624 0 1.11-.22 1.46-.66.421-.533.632-1.408.632-2.627 0-1.222-.21-2.096-.629-2.624-.351-.445-.839-.668-1.463-.668-.624 0-1.11.22-1.459.66-.422.533-.633 1.406-.633 2.619 0 1.236.192 2.095.576 2.577.384.482.89.723 1.516.723zm0-1.024a.614.614 0 0 1-.398-.14c-.115-.094-.211-.283-.287-.565-.077-.283-.115-.802-.115-1.558s.043-1.294.128-1.613c.064-.246.155-.417.272-.512a.617.617 0 0 1 .4-.143.61.61 0 0 1 .398.143c.116.095.211.284.288.567.076.283.114.802.114 1.558s-.043 1.292-.128 1.608c-.064.246-.155.417-.272.512a.617.617 0 0 1-.4.143zm7.088.914v-1.147H10.35c.065-.111.149-.226.253-.343.104-.117.35-.354.74-.712.39-.357.66-.631.81-.821.225-.288.39-.562.493-.824.104-.263.156-.539.156-.829 0-.51-.181-.936-.544-1.279-.364-.342-.863-.514-1.499-.514-.58 0-1.063.148-1.45.444-.387.296-.617.784-.69 1.463l1.23.124c.024-.36.112-.619.264-.774.152-.155.357-.233.615-.233.261 0 .465.074.613.222.148.148.222.36.222.635 0 .25-.085.501-.255.756-.126.185-.467.536-1.024 1.055-.691.641-1.154 1.156-1.388 1.544-.235.389-.375.8-.422 1.233h4.328zm2.334 0v-1.235h-1.235V24h1.235zM5.714 34.11c.624 0 1.11-.22 1.46-.66.421-.533.632-1.408.632-2.627 0-1.222-.21-2.096-.629-2.624-.351-.445-.839-.668-1.463-.668-.624 0-1.11.22-1.459.66-.422.533-.633 1.406-.633 2.619 0 1.236.192 2.095.576 2.577.384.482.89.723 1.516.723zm0-1.024a.614.614 0 0 1-.398-.14c-.115-.094-.211-.283-.287-.565-.077-.283-.115-.802-.115-1.558s.043-1.294.128-1.613c.064-.246.155-.417.272-.512a.617.617 0 0 1 .4-.143.61.61 0 0 1 .398.143c.116.095.211.284.288.567.076.283.114.802.114 1.558s-.043 1.292-.128 1.608c-.064.246-.155.417-.272.512a.617.617 0 0 1-.4.143zm4.992 1.024c.616 0 1.13-.2 1.543-.598.413-.398.62-.88.62-1.446 0-.39-.111-.722-.332-.997a1.5 1.5 0 0 0-.886-.532c.618-.337.927-.788.927-1.353 0-.399-.15-.756-.452-1.073-.366-.386-.853-.58-1.46-.58a2.25 2.25 0 0 0-.96.2 1.617 1.617 0 0 0-.667.55c-.16.232-.28.544-.359.933l1.139.194c.032-.282.123-.495.272-.642.15-.146.33-.22.54-.22.214 0 .386.065.515.194s.193.302.193.518c0 .255-.088.46-.264.613-.175.154-.43.227-.764.218l-.136 1.006c.22-.061.408-.092.566-.092.24 0 .444.09.611.272.167.182.25.428.25.739 0 .328-.086.589-.26.782a.833.833 0 0 1-.644.29.841.841 0 0 1-.607-.242c-.167-.16-.27-.394-.308-.698l-1.195.145c.062.542.284.98.668 1.316.384.335.867.503 1.45.503zm4.43-.11v-1.235h-1.235V34h1.235z"/></svg>'},{label:t("Toggle the lower–roman list style"),tooltip:t("Lower–roman"),type:"lower-roman",icon:'<svg viewBox="0 0 44 44" xmlns="http://www.w3.org/2000/svg"><path d="M35 29a1 1 0 0 1 1 1v1a1 1 0 0 1-1 1H18a1 1 0 0 1-1-1v-1a1 1 0 0 1 1-1h17zm0-9a1 1 0 0 1 1 1v1a1 1 0 0 1-1 1H18a1 1 0 0 1-1-1v-1a1 1 0 0 1 1-1h17zm0-9a1 1 0 0 1 1 1v1a1 1 0 0 1-1 1H18a1 1 0 0 1-1-1v-1a1 1 0 0 1 1-1h17z" fill-opacity=".163"/><path d="M11.88 8.7V7.558h-1.234V8.7h1.234zm0 5.3V9.333h-1.234V14h1.234zm2.5 0v-1.235h-1.234V14h1.235zm-4.75 4.7v-1.142H8.395V18.7H9.63zm0 5.3v-4.667H8.395V24H9.63zm2.5-5.3v-1.142h-1.234V18.7h1.235zm0 5.3v-4.667h-1.234V24h1.235zm2.501 0v-1.235h-1.235V24h1.235zM7.38 28.7v-1.142H6.145V28.7H7.38zm0 5.3v-4.667H6.145V34H7.38zm2.5-5.3v-1.142H8.646V28.7H9.88zm0 5.3v-4.667H8.646V34H9.88zm2.5-5.3v-1.142h-1.234V28.7h1.235zm0 5.3v-4.667h-1.234V34h1.235zm2.501 0v-1.235h-1.235V34h1.235z"/></svg>'},{label:t("Toggle the upper–roman list style"),tooltip:t("Upper-roman"),type:"upper-roman",icon:'<svg viewBox="0 0 44 44" xmlns="http://www.w3.org/2000/svg"><path d="M35 29a1 1 0 0 1 1 1v1a1 1 0 0 1-1 1H18a1 1 0 0 1-1-1v-1a1 1 0 0 1 1-1h17zm0-9a1 1 0 0 1 1 1v1a1 1 0 0 1-1 1H18a1 1 0 0 1-1-1v-1a1 1 0 0 1 1-1h17zm0-9a1 1 0 0 1 1 1v1a1 1 0 0 1-1 1H18a1 1 0 0 1-1-1v-1a1 1 0 0 1 1-1h17z" fill-opacity=".163"/><path d="M11.916 15V8.558h-1.301V15h1.3zm2.465 0v-1.235h-1.235V15h1.235zM9.665 25v-6.442h-1.3V25h1.3zm2.5 0v-6.442h-1.3V25h1.3zm2.466 0v-1.235h-1.235V25h1.235zm-7.216 9v-6.442h-1.3V34h1.3zm2.5 0v-6.442h-1.3V34h1.3zm2.501 0v-6.442h-1.3V34h1.3zm2.465 0v-1.235h-1.235V34h1.235z"/></svg>'},{label:t("Toggle the lower–latin list style"),tooltip:t("Lower-latin"),type:"lower-latin",icon:'<svg viewBox="0 0 44 44" xmlns="http://www.w3.org/2000/svg"><path d="M35 29a1 1 0 0 1 1 1v1a1 1 0 0 1-1 1H18a1 1 0 0 1-1-1v-1a1 1 0 0 1 1-1h17zm0-9a1 1 0 0 1 1 1v1a1 1 0 0 1-1 1H18a1 1 0 0 1-1-1v-1a1 1 0 0 1 1-1h17zm0-9a1 1 0 0 1 1 1v1a1 1 0 0 1-1 1H18a1 1 0 0 1-1-1v-1a1 1 0 0 1 1-1h17z" fill-opacity=".163"/><path d="M9.62 14.105c.272 0 .528-.05.768-.153s.466-.257.677-.462c.009.024.023.072.044.145.047.161.086.283.119.365h1.221a2.649 2.649 0 0 1-.222-.626c-.04-.195-.059-.498-.059-.908l.013-1.441c0-.536-.055-.905-.165-1.105-.11-.201-.3-.367-.569-.497-.27-.13-.68-.195-1.23-.195-.607 0-1.064.108-1.371.325-.308.217-.525.55-.65 1.002l1.12.202c.076-.217.176-.369.299-.455.123-.086.294-.13.514-.13.325 0 .546.05.663.152.118.101.176.27.176.508v.123c-.222.093-.622.194-1.2.303-.427.082-.755.178-.982.288-.227.11-.403.268-.53.474a1.327 1.327 0 0 0-.188.706c0 .398.138.728.415.988.277.261.656.391 1.136.391zm.368-.87a.675.675 0 0 1-.492-.189.606.606 0 0 1-.193-.448c0-.176.08-.32.241-.435.106-.07.33-.142.673-.215a7.19 7.19 0 0 0 .751-.19v.247c0 .296-.016.496-.048.602a.773.773 0 0 1-.295.409 1.07 1.07 0 0 1-.637.22zm4.645.765v-1.235h-1.235V14h1.235zM10.2 25.105c.542 0 1.003-.215 1.382-.646.38-.43.57-1.044.57-1.84 0-.771-.187-1.362-.559-1.774a1.82 1.82 0 0 0-1.41-.617c-.522 0-.973.216-1.354.65v-2.32H7.594V25h1.147v-.686a1.9 1.9 0 0 0 .67.592c.26.133.523.2.79.2zm-.299-.975c-.354 0-.638-.164-.852-.492-.153-.232-.229-.59-.229-1.073 0-.468.098-.818.295-1.048a.93.93 0 0 1 .738-.345c.302 0 .55.118.743.354.193.236.29.62.29 1.154 0 .5-.096.868-.288 1.1-.192.233-.424.35-.697.35zm4.478.87v-1.235h-1.234V25h1.234zm-4.017 9.105c.6 0 1.08-.142 1.437-.426.357-.284.599-.704.725-1.261l-1.213-.207c-.061.326-.167.555-.316.688a.832.832 0 0 1-.576.2.916.916 0 0 1-.75-.343c-.185-.228-.278-.62-.278-1.173 0-.498.091-.853.274-1.066.183-.212.429-.318.736-.318.232 0 .42.061.565.184.145.123.238.306.28.55l1.216-.22c-.146-.501-.387-.874-.722-1.119-.336-.244-.788-.366-1.356-.366-.695 0-1.245.214-1.653.643-.407.43-.61 1.03-.61 1.8 0 .762.202 1.358.608 1.788.406.431.95.646 1.633.646zM14.633 34v-1.235h-1.235V34h1.235z"/></svg>'},{label:t("Toggle the upper–latin list style"),tooltip:t("Upper-latin"),type:"upper-latin",icon:'<svg viewBox="0 0 44 44" xmlns="http://www.w3.org/2000/svg"><path d="M35 29a1 1 0 0 1 1 1v1a1 1 0 0 1-1 1H18a1 1 0 0 1-1-1v-1a1 1 0 0 1 1-1h17zm0-9a1 1 0 0 1 1 1v1a1 1 0 0 1-1 1H18a1 1 0 0 1-1-1v-1a1 1 0 0 1 1-1h17zm0-9a1 1 0 0 1 1 1v1a1 1 0 0 1-1 1H18a1 1 0 0 1-1-1v-1a1 1 0 0 1 1-1h17z" fill-opacity=".163"/><path d="m7.88 15 .532-1.463h2.575L11.549 15h1.415l-2.58-6.442H9.01L6.5 15h1.38zm2.69-2.549H8.811l.87-2.39.887 2.39zM14.88 15v-1.235h-1.234V15h1.234zM9.352 25c.83-.006 1.352-.02 1.569-.044.346-.038.636-.14.872-.305.236-.166.422-.387.558-.664.137-.277.205-.562.205-.855 0-.372-.106-.695-.317-.97-.21-.276-.512-.471-.905-.585a1.51 1.51 0 0 0 .661-.567 1.5 1.5 0 0 0 .244-.83c0-.28-.066-.53-.197-.754a1.654 1.654 0 0 0-.495-.539 1.676 1.676 0 0 0-.672-.266c-.25-.042-.63-.063-1.14-.063H7.158V25h2.193zm.142-3.88H8.46v-1.49h.747c.612 0 .983.007 1.112.022.217.026.38.102.49.226.11.125.165.287.165.486a.68.68 0 0 1-.192.503.86.86 0 0 1-.525.23 11.47 11.47 0 0 1-.944.023h.18zm.17 2.795H8.46v-1.723h1.05c.592 0 .977.03 1.154.092.177.062.313.16.406.295a.84.84 0 0 1 .14.492c0 .228-.06.41-.181.547a.806.806 0 0 1-.473.257c-.126.026-.423.04-.892.04zM14.88 25v-1.235h-1.234V25h1.234zm-5.018 9.11c.691 0 1.262-.17 1.711-.512.45-.341.772-.864.965-1.567l-1.261-.4c-.109.472-.287.818-.536 1.037-.25.22-.547.33-.892.33-.47 0-.85-.173-1.143-.519-.293-.345-.44-.925-.44-1.74 0-.767.15-1.322.447-1.665.297-.343.684-.514 1.162-.514.346 0 .64.096.881.29.242.193.4.457.477.79l1.288-.307c-.147-.516-.367-.911-.66-1.187-.492-.465-1.132-.698-1.92-.698-.902 0-1.63.296-2.184.89-.554.593-.83 1.426-.83 2.498 0 1.014.275 1.813.825 2.397.551.585 1.254.877 2.11.877zM14.88 34v-1.235h-1.234V34h1.234z"/></svg>'}],o=t("Numbered List"),r=t("Numbered list styles toolbar"),a="numberedList";e.ui.componentFactory.add(a,yP({editor:e,normalizedConfig:n,parentCommandName:a,buttonLabel:o,buttonIcon:Ig.numberedList,styleGridAriaLabel:r,styleDefinitions:i})),s.includes("numbered")&&e.ui.componentFactory.add(`menuBar:${a}`,CP({editor:e,normalizedConfig:n,parentCommandName:a,buttonLabel:o,styleGridAriaLabel:r,styleDefinitions:i}));}}}function yP({editor:e,normalizedConfig:t,parentCommandName:i,buttonLabel:n,buttonIcon:s,styleGridAriaLabel:o,styleDefinitions:r}){const a=e.commands.get(i);return l=>{const c=lb(l,ab),d=c.buttonView;return c.bind("isEnabled").to(a),c.class="ck-list-styles-dropdown",d.on("execute",(()=>{e.execute(i),e.editing.view.focus();})),d.set({label:n,icon:s,tooltip:!0,isToggleable:!0}),d.bind("isOn").to(a,"value",(e=>!!e)),c.once("change:isOpen",(()=>{const n=function({editor:e,normalizedConfig:t,dropdownView:i,parentCommandName:n,styleDefinitions:s,styleGridAriaLabel:o}){const r=e.locale,a={...t,..."numberedList"!=n?{startIndex:!1,reversed:!1}:null},l=n.replace("List","");let c=null;if(t.styles.listTypes.includes(l)){const t=e.commands.get("listStyle"),i=kP({editor:e,parentCommandName:n,listStyleCommand:t}),o=xP(t);c=s.filter(o).map(i);}const d=new _P(r,{styleGridAriaLabel:o,enabledProperties:a,styleButtonViews:c});t.styles.listTypes.includes(l)&&fb(i,(()=>d.stylesView.children.find((e=>e.isOn))));if(a.startIndex){const t=e.commands.get("listStart");d.startIndexFieldView.bind("isEnabled").to(t),d.startIndexFieldView.fieldView.bind("value").to(t),d.on("listStart",((t,i)=>e.execute("listStart",i)));}if(a.reversed){const t=e.commands.get("listReversed");d.reversedSwitchButtonView.bind("isEnabled").to(t),d.reversedSwitchButtonView.bind("isOn").to(t,"value",(e=>!!e)),d.on("listReversed",(()=>{const i=t.value;e.execute("listReversed",{reversed:!i});}));}return d.delegate("execute").to(i),d}({editor:e,normalizedConfig:t,dropdownView:c,parentCommandName:i,styleGridAriaLabel:o,styleDefinitions:r});c.panelView.children.add(n);})),c.on("execute",(()=>{e.editing.view.focus();})),c}}function kP({editor:e,listStyleCommand:t,parentCommandName:i}){const n=e.locale,s=e.commands.get(i);return ({label:o,type:r,icon:a,tooltip:l})=>{const c=new Ef(n);return c.set({label:o,icon:a,tooltip:l}),t.on("change:value",(()=>{c.isOn=t.value===r;})),c.on("execute",(()=>{s.value?t.value===r?e.execute(i):t.value!==r&&e.execute("listStyle",{type:r}):e.model.change((()=>{e.execute("listStyle",{type:r});}));})),c}}function CP({editor:e,normalizedConfig:t,parentCommandName:i,buttonLabel:n,styleGridAriaLabel:s,styleDefinitions:o}){return r=>{const a=new w_(r),l=e.commands.get(i),c=e.commands.get("listStyle"),d=xP(c),h=kP({editor:e,parentCommandName:i,listStyleCommand:c}),u=o.filter(d).map(h),m=new _P(r,{styleGridAriaLabel:s,enabledProperties:{...t,startIndex:!1,reversed:!1},styleButtonViews:u});return m.delegate("execute").to(a),a.buttonView.set({label:n,icon:Ig[i]}),a.panelView.children.add(m),a.bind("isEnabled").to(l,"isEnabled"),a.on("execute",(()=>{e.editing.view.focus();})),a}}function xP(e){return "function"==typeof e.isStyleTypeSupported?t=>e.isStyleTypeSupported(t.type):()=>!0}class AP extends Ga{static get requires(){return [wP,vP]}static get pluginName(){return "ListProperties"}}ba("Ctrl+Enter");ba("Ctrl+Enter");function HV(){return {baseUrl:null,breaks:!1,extensions:null,gfm:!0,headerIds:!0,headerPrefix:"",highlight:null,langPrefix:"language-",mangle:!0,pedantic:!1,renderer:null,sanitize:!1,sanitizer:null,silent:!1,smartLists:!1,smartypants:!1,tokenizer:null,walkTokens:null,xhtml:!1}}let $V={baseUrl:null,breaks:!1,extensions:null,gfm:!0,headerIds:!0,headerPrefix:"",highlight:null,langPrefix:"language-",mangle:!0,pedantic:!1,renderer:null,sanitize:!1,sanitizer:null,silent:!1,smartLists:!1,smartypants:!1,tokenizer:null,walkTokens:null,xhtml:!1};const UV=/[&<>"']/,WV=/[&<>"']/g,jV=/[<>"']|&(?!#?\w+;)/,qV=/[<>"']|&(?!#?\w+;)/g,GV={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"},KV=e=>GV[e];function ZV(e,t){if(t){if(UV.test(e))return e.replace(WV,KV)}else if(jV.test(e))return e.replace(qV,KV);return e}const JV=/&(#(?:\d+)|(?:#x[0-9A-Fa-f]+)|(?:\w+));?/gi;function QV(e){return e.replace(JV,((e,t)=>"colon"===(t=t.toLowerCase())?":":"#"===t.charAt(0)?"x"===t.charAt(1)?String.fromCharCode(parseInt(t.substring(2),16)):String.fromCharCode(+t.substring(1)):""))}const YV=/(^|[^\[])\^/g;function XV(e,t){e=e.source||e,t=t||"";const i={replace:(t,n)=>(n=(n=n.source||n).replace(YV,"$1"),e=e.replace(t,n),i),getRegex:()=>new RegExp(e,t)};return i}const eR=/[^\w:]/g,tR=/^$|^[a-z][a-z0-9+.-]*:|^[?#]/i;function iR(e,t,i){if(e){let e;try{e=decodeURIComponent(QV(i)).replace(eR,"").toLowerCase();}catch(e){return null}if(0===e.indexOf("javascript:")||0===e.indexOf("vbscript:")||0===e.indexOf("data:"))return null}t&&!tR.test(i)&&(i=function(e,t){nR[" "+e]||(sR.test(e)?nR[" "+e]=e+"/":nR[" "+e]=dR(e,"/",!0));e=nR[" "+e];const i=-1===e.indexOf(":");return "//"===t.substring(0,2)?i?t:e.replace(oR,"$1")+t:"/"===t.charAt(0)?i?t:e.replace(rR,"$1")+t:e+t}(t,i));try{i=encodeURI(i).replace(/%25/g,"%");}catch(e){return null}return i}const nR={},sR=/^[^:]+:\/*[^/]*$/,oR=/^([^:]+:)[\s\S]*$/,rR=/^([^:]+:\/*[^/]*)[\s\S]*$/;const aR={exec:function(){}};function lR(e){let t,i,n=1;for(;n<arguments.length;n++)for(i in t=arguments[n],t)Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e}function cR(e,t){const i=e.replace(/\|/g,((e,t,i)=>{let n=!1,s=t;for(;--s>=0&&"\\"===i[s];)n=!n;return n?"|":" |"})).split(/ \|/);let n=0;if(i[0].trim()||i.shift(),i.length>0&&!i[i.length-1].trim()&&i.pop(),i.length>t)i.splice(t);else for(;i.length<t;)i.push("");for(;n<i.length;n++)i[n]=i[n].trim().replace(/\\\|/g,"|");return i}function dR(e,t,i){const n=e.length;if(0===n)return "";let s=0;for(;s<n;){const o=e.charAt(n-s-1);if(o!==t||i){if(o===t||!i)break;s++;}else s++;}return e.substr(0,n-s)}function hR(e){e&&e.sanitize&&!e.silent&&console.warn("marked(): sanitize and sanitizer parameters are deprecated since version 0.7.0, should not be used and will be removed in the future. Read more here: https://marked.js.org/#/USING_ADVANCED.md#options");}function uR(e,t){if(t<1)return "";let i="";for(;t>1;)1&t&&(i+=e),t>>=1,e+=e;return i+e}function mR(e,t,i,n){const s=t.href,o=t.title?ZV(t.title):null,r=e[1].replace(/\\([\[\]])/g,"$1");if("!"!==e[0].charAt(0)){n.state.inLink=!0;const e={type:"link",raw:i,href:s,title:o,text:r,tokens:n.inlineTokens(r,[])};return n.state.inLink=!1,e}return {type:"image",raw:i,href:s,title:o,text:ZV(r)}}class gR{constructor(e){this.options=e||$V;}space(e){const t=this.rules.block.newline.exec(e);if(t&&t[0].length>0)return {type:"space",raw:t[0]}}code(e){const t=this.rules.block.code.exec(e);if(t){const e=t[0].replace(/^ {1,4}/gm,"");return {type:"code",raw:t[0],codeBlockStyle:"indented",text:this.options.pedantic?e:dR(e,"\n")}}}fences(e){const t=this.rules.block.fences.exec(e);if(t){const e=t[0],i=function(e,t){const i=e.match(/^(\s+)(?:```)/);if(null===i)return t;const n=i[1];return t.split("\n").map((e=>{const t=e.match(/^\s+/);if(null===t)return e;const[i]=t;return i.length>=n.length?e.slice(n.length):e})).join("\n")}(e,t[3]||"");return {type:"code",raw:e,lang:t[2]?t[2].trim():t[2],text:i}}}heading(e){const t=this.rules.block.heading.exec(e);if(t){let e=t[2].trim();if(/#$/.test(e)){const t=dR(e,"#");this.options.pedantic?e=t.trim():t&&!/ $/.test(t)||(e=t.trim());}const i={type:"heading",raw:t[0],depth:t[1].length,text:e,tokens:[]};return this.lexer.inline(i.text,i.tokens),i}}hr(e){const t=this.rules.block.hr.exec(e);if(t)return {type:"hr",raw:t[0]}}blockquote(e){const t=this.rules.block.blockquote.exec(e);if(t){const e=t[0].replace(/^ *> ?/gm,"");return {type:"blockquote",raw:t[0],tokens:this.lexer.blockTokens(e,[]),text:e}}}list(e){let t=this.rules.block.list.exec(e);if(t){let i,n,s,o,r,a,l,c,d,h,u,m,g=t[1].trim();const f=g.length>1,p={type:"list",raw:"",ordered:f,start:f?+g.slice(0,-1):"",loose:!1,items:[]};g=f?`\\d{1,9}\\${g.slice(-1)}`:`\\${g}`,this.options.pedantic&&(g=f?g:"[*+-]");const b=new RegExp(`^( {0,3}${g})((?: [^\\n]*)?(?:\\n|$))`);for(;e&&(m=!1,t=b.exec(e))&&!this.rules.block.hr.test(e);){if(i=t[0],e=e.substring(i.length),c=t[2].split("\n",1)[0],d=e.split("\n",1)[0],this.options.pedantic?(o=2,u=c.trimLeft()):(o=t[2].search(/[^ ]/),o=o>4?1:o,u=c.slice(o),o+=t[1].length),a=!1,!c&&/^ *$/.test(d)&&(i+=d+"\n",e=e.substring(d.length+1),m=!0),!m){const t=new RegExp(`^ {0,${Math.min(3,o-1)}}(?:[*+-]|\\d{1,9}[.)])`);for(;e&&(h=e.split("\n",1)[0],c=h,this.options.pedantic&&(c=c.replace(/^ {1,4}(?=( {4})*[^ ])/g,"  ")),!t.test(c));){if(c.search(/[^ ]/)>=o||!c.trim())u+="\n"+c.slice(o);else {if(a)break;u+="\n"+c;}a||c.trim()||(a=!0),i+=h+"\n",e=e.substring(h.length+1);}}p.loose||(l?p.loose=!0:/\n *\n *$/.test(i)&&(l=!0)),this.options.gfm&&(n=/^\[[ xX]\] /.exec(u),n&&(s="[ ] "!==n[0],u=u.replace(/^\[[ xX]\] +/,""))),p.items.push({type:"list_item",raw:i,task:!!n,checked:s,loose:!1,text:u}),p.raw+=i;}p.items[p.items.length-1].raw=i.trimRight(),p.items[p.items.length-1].text=u.trimRight(),p.raw=p.raw.trimRight();const w=p.items.length;for(r=0;r<w;r++){this.lexer.state.top=!1,p.items[r].tokens=this.lexer.blockTokens(p.items[r].text,[]);const e=p.items[r].tokens.filter((e=>"space"===e.type)),t=e.every((e=>{const t=e.raw.split("");let i=0;for(const e of t)if("\n"===e&&(i+=1),i>1)return !0;return !1}));!p.loose&&e.length&&t&&(p.loose=!0,p.items[r].loose=!0);}return p}}html(e){const t=this.rules.block.html.exec(e);if(t){const e={type:"html",raw:t[0],pre:!this.options.sanitizer&&("pre"===t[1]||"script"===t[1]||"style"===t[1]),text:t[0]};return this.options.sanitize&&(e.type="paragraph",e.text=this.options.sanitizer?this.options.sanitizer(t[0]):ZV(t[0]),e.tokens=[],this.lexer.inline(e.text,e.tokens)),e}}def(e){const t=this.rules.block.def.exec(e);if(t){t[3]&&(t[3]=t[3].substring(1,t[3].length-1));return {type:"def",tag:t[1].toLowerCase().replace(/\s+/g," "),raw:t[0],href:t[2],title:t[3]}}}table(e){const t=this.rules.block.table.exec(e);if(t){const e={type:"table",header:cR(t[1]).map((e=>({text:e}))),align:t[2].replace(/^ *|\| *$/g,"").split(/ *\| */),rows:t[3]&&t[3].trim()?t[3].replace(/\n[ \t]*$/,"").split("\n"):[]};if(e.header.length===e.align.length){e.raw=t[0];let i,n,s,o,r=e.align.length;for(i=0;i<r;i++)/^ *-+: *$/.test(e.align[i])?e.align[i]="right":/^ *:-+: *$/.test(e.align[i])?e.align[i]="center":/^ *:-+ *$/.test(e.align[i])?e.align[i]="left":e.align[i]=null;for(r=e.rows.length,i=0;i<r;i++)e.rows[i]=cR(e.rows[i],e.header.length).map((e=>({text:e})));for(r=e.header.length,n=0;n<r;n++)e.header[n].tokens=[],this.lexer.inlineTokens(e.header[n].text,e.header[n].tokens);for(r=e.rows.length,n=0;n<r;n++)for(o=e.rows[n],s=0;s<o.length;s++)o[s].tokens=[],this.lexer.inlineTokens(o[s].text,o[s].tokens);return e}}}lheading(e){const t=this.rules.block.lheading.exec(e);if(t){const e={type:"heading",raw:t[0],depth:"="===t[2].charAt(0)?1:2,text:t[1],tokens:[]};return this.lexer.inline(e.text,e.tokens),e}}paragraph(e){const t=this.rules.block.paragraph.exec(e);if(t){const e={type:"paragraph",raw:t[0],text:"\n"===t[1].charAt(t[1].length-1)?t[1].slice(0,-1):t[1],tokens:[]};return this.lexer.inline(e.text,e.tokens),e}}text(e){const t=this.rules.block.text.exec(e);if(t){const e={type:"text",raw:t[0],text:t[0],tokens:[]};return this.lexer.inline(e.text,e.tokens),e}}escape(e){const t=this.rules.inline.escape.exec(e);if(t)return {type:"escape",raw:t[0],text:ZV(t[1])}}tag(e){const t=this.rules.inline.tag.exec(e);if(t)return !this.lexer.state.inLink&&/^<a /i.test(t[0])?this.lexer.state.inLink=!0:this.lexer.state.inLink&&/^<\/a>/i.test(t[0])&&(this.lexer.state.inLink=!1),!this.lexer.state.inRawBlock&&/^<(pre|code|kbd|script)(\s|>)/i.test(t[0])?this.lexer.state.inRawBlock=!0:this.lexer.state.inRawBlock&&/^<\/(pre|code|kbd|script)(\s|>)/i.test(t[0])&&(this.lexer.state.inRawBlock=!1),{type:this.options.sanitize?"text":"html",raw:t[0],inLink:this.lexer.state.inLink,inRawBlock:this.lexer.state.inRawBlock,text:this.options.sanitize?this.options.sanitizer?this.options.sanitizer(t[0]):ZV(t[0]):t[0]}}link(e){const t=this.rules.inline.link.exec(e);if(t){const e=t[2].trim();if(!this.options.pedantic&&/^</.test(e)){if(!/>$/.test(e))return;const t=dR(e.slice(0,-1),"\\");if((e.length-t.length)%2==0)return}else {const e=function(e,t){if(-1===e.indexOf(t[1]))return -1;const i=e.length;let n=0,s=0;for(;s<i;s++)if("\\"===e[s])s++;else if(e[s]===t[0])n++;else if(e[s]===t[1]&&(n--,n<0))return s;return -1}(t[2],"()");if(e>-1){const i=(0===t[0].indexOf("!")?5:4)+t[1].length+e;t[2]=t[2].substring(0,e),t[0]=t[0].substring(0,i).trim(),t[3]="";}}let i=t[2],n="";if(this.options.pedantic){const e=/^([^'"]*[^\s])\s+(['"])(.*)\2/.exec(i);e&&(i=e[1],n=e[3]);}else n=t[3]?t[3].slice(1,-1):"";return i=i.trim(),/^</.test(i)&&(i=this.options.pedantic&&!/>$/.test(e)?i.slice(1):i.slice(1,-1)),mR(t,{href:i?i.replace(this.rules.inline._escapes,"$1"):i,title:n?n.replace(this.rules.inline._escapes,"$1"):n},t[0],this.lexer)}}reflink(e,t){let i;if((i=this.rules.inline.reflink.exec(e))||(i=this.rules.inline.nolink.exec(e))){let e=(i[2]||i[1]).replace(/\s+/g," ");if(e=t[e.toLowerCase()],!e||!e.href){const e=i[0].charAt(0);return {type:"text",raw:e,text:e}}return mR(i,e,i[0],this.lexer)}}emStrong(e,t,i=""){let n=this.rules.inline.emStrong.lDelim.exec(e);if(!n)return;if(n[3]&&i.match(/[\p{L}\p{N}]/u))return;const s=n[1]||n[2]||"";if(!s||s&&(""===i||this.rules.inline.punctuation.exec(i))){const i=n[0].length-1;let s,o,r=i,a=0;const l="*"===n[0][0]?this.rules.inline.emStrong.rDelimAst:this.rules.inline.emStrong.rDelimUnd;for(l.lastIndex=0,t=t.slice(-1*e.length+i);null!=(n=l.exec(t));){if(s=n[1]||n[2]||n[3]||n[4]||n[5]||n[6],!s)continue;if(o=s.length,n[3]||n[4]){r+=o;continue}if((n[5]||n[6])&&i%3&&!((i+o)%3)){a+=o;continue}if(r-=o,r>0)continue;if(o=Math.min(o,o+r+a),Math.min(i,o)%2){const t=e.slice(1,i+n.index+o);return {type:"em",raw:e.slice(0,i+n.index+o+1),text:t,tokens:this.lexer.inlineTokens(t,[])}}const t=e.slice(2,i+n.index+o-1);return {type:"strong",raw:e.slice(0,i+n.index+o+1),text:t,tokens:this.lexer.inlineTokens(t,[])}}}}codespan(e){const t=this.rules.inline.code.exec(e);if(t){let e=t[2].replace(/\n/g," ");const i=/[^ ]/.test(e),n=/^ /.test(e)&&/ $/.test(e);return i&&n&&(e=e.substring(1,e.length-1)),e=ZV(e,!0),{type:"codespan",raw:t[0],text:e}}}br(e){const t=this.rules.inline.br.exec(e);if(t)return {type:"br",raw:t[0]}}del(e){const t=this.rules.inline.del.exec(e);if(t)return {type:"del",raw:t[0],text:t[2],tokens:this.lexer.inlineTokens(t[2],[])}}autolink(e,t){const i=this.rules.inline.autolink.exec(e);if(i){let e,n;return "@"===i[2]?(e=ZV(this.options.mangle?t(i[1]):i[1]),n="mailto:"+e):(e=ZV(i[1]),n=e),{type:"link",raw:i[0],text:e,href:n,tokens:[{type:"text",raw:e,text:e}]}}}url(e,t){let i;if(i=this.rules.inline.url.exec(e)){let e,n;if("@"===i[2])e=ZV(this.options.mangle?t(i[0]):i[0]),n="mailto:"+e;else {let t;do{t=i[0],i[0]=this.rules.inline._backpedal.exec(i[0])[0];}while(t!==i[0]);e=ZV(i[0]),n="www."===i[1]?"http://"+e:e;}return {type:"link",raw:i[0],text:e,href:n,tokens:[{type:"text",raw:e,text:e}]}}}inlineText(e,t){const i=this.rules.inline.text.exec(e);if(i){let e;return e=this.lexer.state.inRawBlock?this.options.sanitize?this.options.sanitizer?this.options.sanitizer(i[0]):ZV(i[0]):i[0]:ZV(this.options.smartypants?t(i[0]):i[0]),{type:"text",raw:i[0],text:e}}}}const fR={newline:/^(?: *(?:\n|$))+/,code:/^( {4}[^\n]+(?:\n(?: *(?:\n|$))*)?)+/,fences:/^ {0,3}(`{3,}(?=[^`\n]*\n)|~{3,})([^\n]*)\n(?:|([\s\S]*?)\n)(?: {0,3}\1[~`]* *(?=\n|$)|$)/,hr:/^ {0,3}((?:- *){3,}|(?:_ *){3,}|(?:\* *){3,})(?:\n+|$)/,heading:/^ {0,3}(#{1,6})(?=\s|$)(.*)(?:\n+|$)/,blockquote:/^( {0,3}> ?(paragraph|[^\n]*)(?:\n|$))+/,list:/^( {0,3}bull)( [^\n]+?)?(?:\n|$)/,html:"^ {0,3}(?:<(script|pre|style|textarea)[\\s>][\\s\\S]*?(?:</\\1>[^\\n]*\\n+|$)|comment[^\\n]*(\\n+|$)|<\\?[\\s\\S]*?(?:\\?>\\n*|$)|<![A-Z][\\s\\S]*?(?:>\\n*|$)|<!\\[CDATA\\[[\\s\\S]*?(?:\\]\\]>\\n*|$)|</?(tag)(?: +|\\n|/?>)[\\s\\S]*?(?:(?:\\n *)+\\n|$)|<(?!script|pre|style|textarea)([a-z][\\w-]*)(?:attribute)*? */?>(?=[ \\t]*(?:\\n|$))[\\s\\S]*?(?:(?:\\n *)+\\n|$)|</(?!script|pre|style|textarea)[a-z][\\w-]*\\s*>(?=[ \\t]*(?:\\n|$))[\\s\\S]*?(?:(?:\\n *)+\\n|$))",def:/^ {0,3}\[(label)\]: *(?:\n *)?<?([^\s>]+)>?(?:(?: +(?:\n *)?| *\n *)(title))? *(?:\n+|$)/,table:aR,lheading:/^([^\n]+)\n {0,3}(=+|-+) *(?:\n+|$)/,_paragraph:/^([^\n]+(?:\n(?!hr|heading|lheading|blockquote|fences|list|html|table| +\n)[^\n]+)*)/,text:/^[^\n]+/,_label:/(?!\s*\])(?:\\.|[^\[\]\\])+/,_title:/(?:"(?:\\"?|[^"\\])*"|'[^'\n]*(?:\n[^'\n]+)*\n?'|\([^()]*\))/};fR.def=XV(fR.def).replace("label",fR._label).replace("title",fR._title).getRegex(),fR.bullet=/(?:[*+-]|\d{1,9}[.)])/,fR.listItemStart=XV(/^( *)(bull) */).replace("bull",fR.bullet).getRegex(),fR.list=XV(fR.list).replace(/bull/g,fR.bullet).replace("hr","\\n+(?=\\1?(?:(?:- *){3,}|(?:_ *){3,}|(?:\\* *){3,})(?:\\n+|$))").replace("def","\\n+(?="+fR.def.source+")").getRegex(),fR._tag="address|article|aside|base|basefont|blockquote|body|caption|center|col|colgroup|dd|details|dialog|dir|div|dl|dt|fieldset|figcaption|figure|footer|form|frame|frameset|h[1-6]|head|header|hr|html|iframe|legend|li|link|main|menu|menuitem|meta|nav|noframes|ol|optgroup|option|p|param|section|source|summary|table|tbody|td|tfoot|th|thead|title|tr|track|ul",fR._comment=/<!--(?!-?>)[\s\S]*?(?:-->|$)/,fR.html=XV(fR.html,"i").replace("comment",fR._comment).replace("tag",fR._tag).replace("attribute",/ +[a-zA-Z:_][\w.:-]*(?: *= *"[^"\n]*"| *= *'[^'\n]*'| *= *[^\s"'=<>`]+)?/).getRegex(),fR.paragraph=XV(fR._paragraph).replace("hr",fR.hr).replace("heading"," {0,3}#{1,6} ").replace("|lheading","").replace("|table","").replace("blockquote"," {0,3}>").replace("fences"," {0,3}(?:`{3,}(?=[^`\\n]*\\n)|~{3,})[^\\n]*\\n").replace("list"," {0,3}(?:[*+-]|1[.)]) ").replace("html","</?(?:tag)(?: +|\\n|/?>)|<(?:script|pre|style|textarea|!--)").replace("tag",fR._tag).getRegex(),fR.blockquote=XV(fR.blockquote).replace("paragraph",fR.paragraph).getRegex(),fR.normal=lR({},fR),fR.gfm=lR({},fR.normal,{table:"^ *([^\\n ].*\\|.*)\\n {0,3}(?:\\| *)?(:?-+:? *(?:\\| *:?-+:? *)*)(?:\\| *)?(?:\\n((?:(?! *\\n|hr|heading|blockquote|code|fences|list|html).*(?:\\n|$))*)\\n*|$)"}),fR.gfm.table=XV(fR.gfm.table).replace("hr",fR.hr).replace("heading"," {0,3}#{1,6} ").replace("blockquote"," {0,3}>").replace("code"," {4}[^\\n]").replace("fences"," {0,3}(?:`{3,}(?=[^`\\n]*\\n)|~{3,})[^\\n]*\\n").replace("list"," {0,3}(?:[*+-]|1[.)]) ").replace("html","</?(?:tag)(?: +|\\n|/?>)|<(?:script|pre|style|textarea|!--)").replace("tag",fR._tag).getRegex(),fR.gfm.paragraph=XV(fR._paragraph).replace("hr",fR.hr).replace("heading"," {0,3}#{1,6} ").replace("|lheading","").replace("table",fR.gfm.table).replace("blockquote"," {0,3}>").replace("fences"," {0,3}(?:`{3,}(?=[^`\\n]*\\n)|~{3,})[^\\n]*\\n").replace("list"," {0,3}(?:[*+-]|1[.)]) ").replace("html","</?(?:tag)(?: +|\\n|/?>)|<(?:script|pre|style|textarea|!--)").replace("tag",fR._tag).getRegex(),fR.pedantic=lR({},fR.normal,{html:XV("^ *(?:comment *(?:\\n|\\s*$)|<(tag)[\\s\\S]+?</\\1> *(?:\\n{2,}|\\s*$)|<tag(?:\"[^\"]*\"|'[^']*'|\\s[^'\"/>\\s]*)*?/?> *(?:\\n{2,}|\\s*$))").replace("comment",fR._comment).replace(/tag/g,"(?!(?:a|em|strong|small|s|cite|q|dfn|abbr|data|time|code|var|samp|kbd|sub|sup|i|b|u|mark|ruby|rt|rp|bdi|bdo|span|br|wbr|ins|del|img)\\b)\\w+(?!:|[^\\w\\s@]*@)\\b").getRegex(),def:/^ *\[([^\]]+)\]: *<?([^\s>]+)>?(?: +(["(][^\n]+[")]))? *(?:\n+|$)/,heading:/^(#{1,6})(.*)(?:\n+|$)/,fences:aR,paragraph:XV(fR.normal._paragraph).replace("hr",fR.hr).replace("heading"," *#{1,6} *[^\n]").replace("lheading",fR.lheading).replace("blockquote"," {0,3}>").replace("|fences","").replace("|list","").replace("|html","").getRegex()});const pR={escape:/^\\([!"#$%&'()*+,\-./:;<=>?@\[\]\\^_`{|}~])/,autolink:/^<(scheme:[^\s\x00-\x1f<>]*|email)>/,url:aR,tag:"^comment|^</[a-zA-Z][\\w:-]*\\s*>|^<[a-zA-Z][\\w-]*(?:attribute)*?\\s*/?>|^<\\?[\\s\\S]*?\\?>|^<![a-zA-Z]+\\s[\\s\\S]*?>|^<!\\[CDATA\\[[\\s\\S]*?\\]\\]>",link:/^!?\[(label)\]\(\s*(href)(?:\s+(title))?\s*\)/,reflink:/^!?\[(label)\]\[(ref)\]/,nolink:/^!?\[(ref)\](?:\[\])?/,reflinkSearch:"reflink|nolink(?!\\()",emStrong:{lDelim:/^(?:\*+(?:([punct_])|[^\s*]))|^_+(?:([punct*])|([^\s_]))/,rDelimAst:/^[^_*]*?\_\_[^_*]*?\*[^_*]*?(?=\_\_)|[punct_](\*+)(?=[\s]|$)|[^punct*_\s](\*+)(?=[punct_\s]|$)|[punct_\s](\*+)(?=[^punct*_\s])|[\s](\*+)(?=[punct_])|[punct_](\*+)(?=[punct_])|[^punct*_\s](\*+)(?=[^punct*_\s])/,rDelimUnd:/^[^_*]*?\*\*[^_*]*?\_[^_*]*?(?=\*\*)|[punct*](\_+)(?=[\s]|$)|[^punct*_\s](\_+)(?=[punct*\s]|$)|[punct*\s](\_+)(?=[^punct*_\s])|[\s](\_+)(?=[punct*])|[punct*](\_+)(?=[punct*])/},code:/^(`+)([^`]|[^`][\s\S]*?[^`])\1(?!`)/,br:/^( {2,}|\\)\n(?!\s*$)/,del:aR,text:/^(`+|[^`])(?:(?= {2,}\n)|[\s\S]*?(?:(?=[\\<!\[`*_]|\b_|$)|[^ ](?= {2,}\n)))/,punctuation:/^([\spunctuation])/};function bR(e){return e.replace(/---/g,"—").replace(/--/g,"–").replace(/(^|[-\u2014/(\[{"\s])'/g,"$1‘").replace(/'/g,"’").replace(/(^|[-\u2014/(\[{\u2018\s])"/g,"$1“").replace(/"/g,"”").replace(/\.{3}/g,"…")}function wR(e){let t,i,n="";const s=e.length;for(t=0;t<s;t++)i=e.charCodeAt(t),Math.random()>.5&&(i="x"+i.toString(16)),n+="&#"+i+";";return n}pR._punctuation="!\"#$%&'()+\\-.,/:;<=>?@\\[\\]`^{|}~",pR.punctuation=XV(pR.punctuation).replace(/punctuation/g,pR._punctuation).getRegex(),pR.blockSkip=/\[[^\]]*?\]\([^\)]*?\)|`[^`]*?`|<[^>]*?>/g,pR.escapedEmSt=/\\\*|\\_/g,pR._comment=XV(fR._comment).replace("(?:--\x3e|$)","--\x3e").getRegex(),pR.emStrong.lDelim=XV(pR.emStrong.lDelim).replace(/punct/g,pR._punctuation).getRegex(),pR.emStrong.rDelimAst=XV(pR.emStrong.rDelimAst,"g").replace(/punct/g,pR._punctuation).getRegex(),pR.emStrong.rDelimUnd=XV(pR.emStrong.rDelimUnd,"g").replace(/punct/g,pR._punctuation).getRegex(),pR._escapes=/\\([!"#$%&'()*+,\-./:;<=>?@\[\]\\^_`{|}~])/g,pR._scheme=/[a-zA-Z][a-zA-Z0-9+.-]{1,31}/,pR._email=/[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+(@)[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)+(?![-_])/,pR.autolink=XV(pR.autolink).replace("scheme",pR._scheme).replace("email",pR._email).getRegex(),pR._attribute=/\s+[a-zA-Z:_][\w.:-]*(?:\s*=\s*"[^"]*"|\s*=\s*'[^']*'|\s*=\s*[^\s"'=<>`]+)?/,pR.tag=XV(pR.tag).replace("comment",pR._comment).replace("attribute",pR._attribute).getRegex(),pR._label=/(?:\[(?:\\.|[^\[\]\\])*\]|\\.|`[^`]*`|[^\[\]\\`])*?/,pR._href=/<(?:\\.|[^\n<>\\])+>|[^\s\x00-\x1f]*/,pR._title=/"(?:\\"?|[^"\\])*"|'(?:\\'?|[^'\\])*'|\((?:\\\)?|[^)\\])*\)/,pR.link=XV(pR.link).replace("label",pR._label).replace("href",pR._href).replace("title",pR._title).getRegex(),pR.reflink=XV(pR.reflink).replace("label",pR._label).replace("ref",fR._label).getRegex(),pR.nolink=XV(pR.nolink).replace("ref",fR._label).getRegex(),pR.reflinkSearch=XV(pR.reflinkSearch,"g").replace("reflink",pR.reflink).replace("nolink",pR.nolink).getRegex(),pR.normal=lR({},pR),pR.pedantic=lR({},pR.normal,{strong:{start:/^__|\*\*/,middle:/^__(?=\S)([\s\S]*?\S)__(?!_)|^\*\*(?=\S)([\s\S]*?\S)\*\*(?!\*)/,endAst:/\*\*(?!\*)/g,endUnd:/__(?!_)/g},em:{start:/^_|\*/,middle:/^()\*(?=\S)([\s\S]*?\S)\*(?!\*)|^_(?=\S)([\s\S]*?\S)_(?!_)/,endAst:/\*(?!\*)/g,endUnd:/_(?!_)/g},link:XV(/^!?\[(label)\]\((.*?)\)/).replace("label",pR._label).getRegex(),reflink:XV(/^!?\[(label)\]\s*\[([^\]]*)\]/).replace("label",pR._label).getRegex()}),pR.gfm=lR({},pR.normal,{escape:XV(pR.escape).replace("])","~|])").getRegex(),_extended_email:/[A-Za-z0-9._+-]+(@)[a-zA-Z0-9-_]+(?:\.[a-zA-Z0-9-_]*[a-zA-Z0-9])+(?![-_])/,url:/^((?:ftp|https?):\/\/|www\.)(?:[a-zA-Z0-9\-]+\.?)+[^\s<]*|^email/,_backpedal:/(?:[^?!.,:;*_~()&]+|\([^)]*\)|&(?![a-zA-Z0-9]+;$)|[?!.,:;*_~)]+(?!$))+/,del:/^(~~?)(?=[^\s~])([\s\S]*?[^\s~])\1(?=[^~]|$)/,text:/^([`~]+|[^`~])(?:(?= {2,}\n)|(?=[a-zA-Z0-9.!#$%&'*+\/=?_`{\|}~-]+@)|[\s\S]*?(?:(?=[\\<!\[`*~_]|\b_|https?:\/\/|ftp:\/\/|www\.|$)|[^ ](?= {2,}\n)|[^a-zA-Z0-9.!#$%&'*+\/=?_`{\|}~-](?=[a-zA-Z0-9.!#$%&'*+\/=?_`{\|}~-]+@)))/}),pR.gfm.url=XV(pR.gfm.url,"i").replace("email",pR.gfm._extended_email).getRegex(),pR.breaks=lR({},pR.gfm,{br:XV(pR.br).replace("{2,}","*").getRegex(),text:XV(pR.gfm.text).replace("\\b_","\\b_| {2,}\\n").replace(/\{2,\}/g,"*").getRegex()});class _R{constructor(e){this.tokens=[],this.tokens.links=Object.create(null),this.options=e||$V,this.options.tokenizer=this.options.tokenizer||new gR,this.tokenizer=this.options.tokenizer,this.tokenizer.options=this.options,this.tokenizer.lexer=this,this.inlineQueue=[],this.state={inLink:!1,inRawBlock:!1,top:!0};const t={block:fR.normal,inline:pR.normal};this.options.pedantic?(t.block=fR.pedantic,t.inline=pR.pedantic):this.options.gfm&&(t.block=fR.gfm,this.options.breaks?t.inline=pR.breaks:t.inline=pR.gfm),this.tokenizer.rules=t;}static get rules(){return {block:fR,inline:pR}}static lex(e,t){return new _R(t).lex(e)}static lexInline(e,t){return new _R(t).inlineTokens(e)}lex(e){let t;for(e=e.replace(/\r\n|\r/g,"\n").replace(/\t/g,"    "),this.blockTokens(e,this.tokens);t=this.inlineQueue.shift();)this.inlineTokens(t.src,t.tokens);return this.tokens}blockTokens(e,t=[]){let i,n,s,o;for(this.options.pedantic&&(e=e.replace(/^ +$/gm,""));e;)if(!(this.options.extensions&&this.options.extensions.block&&this.options.extensions.block.some((n=>!!(i=n.call({lexer:this},e,t))&&(e=e.substring(i.raw.length),t.push(i),!0)))))if(i=this.tokenizer.space(e))e=e.substring(i.raw.length),1===i.raw.length&&t.length>0?t[t.length-1].raw+="\n":t.push(i);else if(i=this.tokenizer.code(e))e=e.substring(i.raw.length),n=t[t.length-1],!n||"paragraph"!==n.type&&"text"!==n.type?t.push(i):(n.raw+="\n"+i.raw,n.text+="\n"+i.text,this.inlineQueue[this.inlineQueue.length-1].src=n.text);else if(i=this.tokenizer.fences(e))e=e.substring(i.raw.length),t.push(i);else if(i=this.tokenizer.heading(e))e=e.substring(i.raw.length),t.push(i);else if(i=this.tokenizer.hr(e))e=e.substring(i.raw.length),t.push(i);else if(i=this.tokenizer.blockquote(e))e=e.substring(i.raw.length),t.push(i);else if(i=this.tokenizer.list(e))e=e.substring(i.raw.length),t.push(i);else if(i=this.tokenizer.html(e))e=e.substring(i.raw.length),t.push(i);else if(i=this.tokenizer.def(e))e=e.substring(i.raw.length),n=t[t.length-1],!n||"paragraph"!==n.type&&"text"!==n.type?this.tokens.links[i.tag]||(this.tokens.links[i.tag]={href:i.href,title:i.title}):(n.raw+="\n"+i.raw,n.text+="\n"+i.raw,this.inlineQueue[this.inlineQueue.length-1].src=n.text);else if(i=this.tokenizer.table(e))e=e.substring(i.raw.length),t.push(i);else if(i=this.tokenizer.lheading(e))e=e.substring(i.raw.length),t.push(i);else {if(s=e,this.options.extensions&&this.options.extensions.startBlock){let t=1/0;const i=e.slice(1);let n;this.options.extensions.startBlock.forEach((function(e){n=e.call({lexer:this},i),"number"==typeof n&&n>=0&&(t=Math.min(t,n));})),t<1/0&&t>=0&&(s=e.substring(0,t+1));}if(this.state.top&&(i=this.tokenizer.paragraph(s)))n=t[t.length-1],o&&"paragraph"===n.type?(n.raw+="\n"+i.raw,n.text+="\n"+i.text,this.inlineQueue.pop(),this.inlineQueue[this.inlineQueue.length-1].src=n.text):t.push(i),o=s.length!==e.length,e=e.substring(i.raw.length);else if(i=this.tokenizer.text(e))e=e.substring(i.raw.length),n=t[t.length-1],n&&"text"===n.type?(n.raw+="\n"+i.raw,n.text+="\n"+i.text,this.inlineQueue.pop(),this.inlineQueue[this.inlineQueue.length-1].src=n.text):t.push(i);else if(e){const t="Infinite loop on byte: "+e.charCodeAt(0);if(this.options.silent){console.error(t);break}throw new Error(t)}}return this.state.top=!0,t}inline(e,t){this.inlineQueue.push({src:e,tokens:t});}inlineTokens(e,t=[]){let i,n,s,o,r,a,l=e;if(this.tokens.links){const e=Object.keys(this.tokens.links);if(e.length>0)for(;null!=(o=this.tokenizer.rules.inline.reflinkSearch.exec(l));)e.includes(o[0].slice(o[0].lastIndexOf("[")+1,-1))&&(l=l.slice(0,o.index)+"["+uR("a",o[0].length-2)+"]"+l.slice(this.tokenizer.rules.inline.reflinkSearch.lastIndex));}for(;null!=(o=this.tokenizer.rules.inline.blockSkip.exec(l));)l=l.slice(0,o.index)+"["+uR("a",o[0].length-2)+"]"+l.slice(this.tokenizer.rules.inline.blockSkip.lastIndex);for(;null!=(o=this.tokenizer.rules.inline.escapedEmSt.exec(l));)l=l.slice(0,o.index)+"++"+l.slice(this.tokenizer.rules.inline.escapedEmSt.lastIndex);for(;e;)if(r||(a=""),r=!1,!(this.options.extensions&&this.options.extensions.inline&&this.options.extensions.inline.some((n=>!!(i=n.call({lexer:this},e,t))&&(e=e.substring(i.raw.length),t.push(i),!0)))))if(i=this.tokenizer.escape(e))e=e.substring(i.raw.length),t.push(i);else if(i=this.tokenizer.tag(e))e=e.substring(i.raw.length),n=t[t.length-1],n&&"text"===i.type&&"text"===n.type?(n.raw+=i.raw,n.text+=i.text):t.push(i);else if(i=this.tokenizer.link(e))e=e.substring(i.raw.length),t.push(i);else if(i=this.tokenizer.reflink(e,this.tokens.links))e=e.substring(i.raw.length),n=t[t.length-1],n&&"text"===i.type&&"text"===n.type?(n.raw+=i.raw,n.text+=i.text):t.push(i);else if(i=this.tokenizer.emStrong(e,l,a))e=e.substring(i.raw.length),t.push(i);else if(i=this.tokenizer.codespan(e))e=e.substring(i.raw.length),t.push(i);else if(i=this.tokenizer.br(e))e=e.substring(i.raw.length),t.push(i);else if(i=this.tokenizer.del(e))e=e.substring(i.raw.length),t.push(i);else if(i=this.tokenizer.autolink(e,wR))e=e.substring(i.raw.length),t.push(i);else if(this.state.inLink||!(i=this.tokenizer.url(e,wR))){if(s=e,this.options.extensions&&this.options.extensions.startInline){let t=1/0;const i=e.slice(1);let n;this.options.extensions.startInline.forEach((function(e){n=e.call({lexer:this},i),"number"==typeof n&&n>=0&&(t=Math.min(t,n));})),t<1/0&&t>=0&&(s=e.substring(0,t+1));}if(i=this.tokenizer.inlineText(s,bR))e=e.substring(i.raw.length),"_"!==i.raw.slice(-1)&&(a=i.raw.slice(-1)),r=!0,n=t[t.length-1],n&&"text"===n.type?(n.raw+=i.raw,n.text+=i.text):t.push(i);else if(e){const t="Infinite loop on byte: "+e.charCodeAt(0);if(this.options.silent){console.error(t);break}throw new Error(t)}}else e=e.substring(i.raw.length),t.push(i);return t}}class vR{constructor(e){this.options=e||$V;}code(e,t,i){const n=(t||"").match(/\S*/)[0];if(this.options.highlight){const t=this.options.highlight(e,n);null!=t&&t!==e&&(i=!0,e=t);}return e=e.replace(/\n$/,"")+"\n",n?'<pre><code class="'+this.options.langPrefix+ZV(n,!0)+'">'+(i?e:ZV(e,!0))+"</code></pre>\n":"<pre><code>"+(i?e:ZV(e,!0))+"</code></pre>\n"}blockquote(e){return "<blockquote>\n"+e+"</blockquote>\n"}html(e){return e}heading(e,t,i,n){return this.options.headerIds?"<h"+t+' id="'+this.options.headerPrefix+n.slug(i)+'">'+e+"</h"+t+">\n":"<h"+t+">"+e+"</h"+t+">\n"}hr(){return this.options.xhtml?"<hr/>\n":"<hr>\n"}list(e,t,i){const n=t?"ol":"ul";return "<"+n+(t&&1!==i?' start="'+i+'"':"")+">\n"+e+"</"+n+">\n"}listitem(e){return "<li>"+e+"</li>\n"}checkbox(e){return "<input "+(e?'checked="" ':"")+'disabled="" type="checkbox"'+(this.options.xhtml?" /":"")+"> "}paragraph(e){return "<p>"+e+"</p>\n"}table(e,t){return t&&(t="<tbody>"+t+"</tbody>"),"<table>\n<thead>\n"+e+"</thead>\n"+t+"</table>\n"}tablerow(e){return "<tr>\n"+e+"</tr>\n"}tablecell(e,t){const i=t.header?"th":"td";return (t.align?"<"+i+' align="'+t.align+'">':"<"+i+">")+e+"</"+i+">\n"}strong(e){return "<strong>"+e+"</strong>"}em(e){return "<em>"+e+"</em>"}codespan(e){return "<code>"+e+"</code>"}br(){return this.options.xhtml?"<br/>":"<br>"}del(e){return "<del>"+e+"</del>"}link(e,t,i){if(null===(e=iR(this.options.sanitize,this.options.baseUrl,e)))return i;let n='<a href="'+ZV(e)+'"';return t&&(n+=' title="'+t+'"'),n+=">"+i+"</a>",n}image(e,t,i){if(null===(e=iR(this.options.sanitize,this.options.baseUrl,e)))return i;let n='<img src="'+e+'" alt="'+i+'"';return t&&(n+=' title="'+t+'"'),n+=this.options.xhtml?"/>":">",n}text(e){return e}}class yR{strong(e){return e}em(e){return e}codespan(e){return e}del(e){return e}html(e){return e}text(e){return e}link(e,t,i){return ""+i}image(e,t,i){return ""+i}br(){return ""}}class kR{constructor(){this.seen={};}serialize(e){return e.toLowerCase().trim().replace(/<[!\/a-z].*?>/gi,"").replace(/[\u2000-\u206F\u2E00-\u2E7F\\'!"#$%&()*+,./:;<=>?@[\]^`{|}~]/g,"").replace(/\s/g,"-")}getNextSafeSlug(e,t){let i=e,n=0;if(this.seen.hasOwnProperty(i)){n=this.seen[e];do{n++,i=e+"-"+n;}while(this.seen.hasOwnProperty(i))}return t||(this.seen[e]=n,this.seen[i]=0),i}slug(e,t={}){const i=this.serialize(e);return this.getNextSafeSlug(i,t.dryrun)}}class CR{constructor(e){this.options=e||$V,this.options.renderer=this.options.renderer||new vR,this.renderer=this.options.renderer,this.renderer.options=this.options,this.textRenderer=new yR,this.slugger=new kR;}static parse(e,t){return new CR(t).parse(e)}static parseInline(e,t){return new CR(t).parseInline(e)}parse(e,t=!0){let i,n,s,o,r,a,l,c,d,h,u,m,g,f,p,b,w,_,v,y="";const k=e.length;for(i=0;i<k;i++)if(h=e[i],this.options.extensions&&this.options.extensions.renderers&&this.options.extensions.renderers[h.type]&&(v=this.options.extensions.renderers[h.type].call({parser:this},h),!1!==v||!["space","hr","heading","code","table","blockquote","list","html","paragraph","text"].includes(h.type)))y+=v||"";else switch(h.type){case"space":continue;case"hr":y+=this.renderer.hr();continue;case"heading":y+=this.renderer.heading(this.parseInline(h.tokens),h.depth,QV(this.parseInline(h.tokens,this.textRenderer)),this.slugger);continue;case"code":y+=this.renderer.code(h.text,h.lang,h.escaped);continue;case"table":for(c="",l="",o=h.header.length,n=0;n<o;n++)l+=this.renderer.tablecell(this.parseInline(h.header[n].tokens),{header:!0,align:h.align[n]});for(c+=this.renderer.tablerow(l),d="",o=h.rows.length,n=0;n<o;n++){for(a=h.rows[n],l="",r=a.length,s=0;s<r;s++)l+=this.renderer.tablecell(this.parseInline(a[s].tokens),{header:!1,align:h.align[s]});d+=this.renderer.tablerow(l);}y+=this.renderer.table(c,d);continue;case"blockquote":d=this.parse(h.tokens),y+=this.renderer.blockquote(d);continue;case"list":for(u=h.ordered,m=h.start,g=h.loose,o=h.items.length,d="",n=0;n<o;n++)p=h.items[n],b=p.checked,w=p.task,f="",p.task&&(_=this.renderer.checkbox(b),g?p.tokens.length>0&&"paragraph"===p.tokens[0].type?(p.tokens[0].text=_+" "+p.tokens[0].text,p.tokens[0].tokens&&p.tokens[0].tokens.length>0&&"text"===p.tokens[0].tokens[0].type&&(p.tokens[0].tokens[0].text=_+" "+p.tokens[0].tokens[0].text)):p.tokens.unshift({type:"text",text:_}):f+=_),f+=this.parse(p.tokens,g),d+=this.renderer.listitem(f,w,b);y+=this.renderer.list(d,u,m);continue;case"html":y+=this.renderer.html(h.text);continue;case"paragraph":y+=this.renderer.paragraph(this.parseInline(h.tokens));continue;case"text":for(d=h.tokens?this.parseInline(h.tokens):h.text;i+1<k&&"text"===e[i+1].type;)h=e[++i],d+="\n"+(h.tokens?this.parseInline(h.tokens):h.text);y+=t?this.renderer.paragraph(d):d;continue;default:{const e='Token with "'+h.type+'" type was not found.';if(this.options.silent)return void console.error(e);throw new Error(e)}}return y}parseInline(e,t){t=t||this.renderer;let i,n,s,o="";const r=e.length;for(i=0;i<r;i++)if(n=e[i],this.options.extensions&&this.options.extensions.renderers&&this.options.extensions.renderers[n.type]&&(s=this.options.extensions.renderers[n.type].call({parser:this},n),!1!==s||!["escape","html","link","image","strong","em","codespan","br","del","text"].includes(n.type)))o+=s||"";else switch(n.type){case"escape":case"text":o+=t.text(n.text);break;case"html":o+=t.html(n.text);break;case"link":o+=t.link(n.href,n.title,this.parseInline(n.tokens,t));break;case"image":o+=t.image(n.href,n.title,n.text);break;case"strong":o+=t.strong(this.parseInline(n.tokens,t));break;case"em":o+=t.em(this.parseInline(n.tokens,t));break;case"codespan":o+=t.codespan(n.text);break;case"br":o+=t.br();break;case"del":o+=t.del(this.parseInline(n.tokens,t));break;default:{const e='Token with "'+n.type+'" type was not found.';if(this.options.silent)return void console.error(e);throw new Error(e)}}return o}}function xR(e,t,i){if(null==e)throw new Error("marked(): input parameter is undefined or null");if("string"!=typeof e)throw new Error("marked(): input parameter is of type "+Object.prototype.toString.call(e)+", string expected");if("function"==typeof t&&(i=t,t=null),hR(t=lR({},xR.defaults,t||{})),i){const n=t.highlight;let s;try{s=_R.lex(e,t);}catch(e){return i(e)}const o=function(e){let o;if(!e)try{t.walkTokens&&xR.walkTokens(s,t.walkTokens),o=CR.parse(s,t);}catch(t){e=t;}return t.highlight=n,e?i(e):i(null,o)};if(!n||n.length<3)return o();if(delete t.highlight,!s.length)return o();let r=0;return xR.walkTokens(s,(function(e){"code"===e.type&&(r++,setTimeout((()=>{n(e.text,e.lang,(function(t,i){if(t)return o(t);null!=i&&i!==e.text&&(e.text=i,e.escaped=!0),r--,0===r&&o();}));}),0));})),void(0===r&&o())}try{const i=_R.lex(e,t);return t.walkTokens&&xR.walkTokens(i,t.walkTokens),CR.parse(i,t)}catch(e){if(e.message+="\nPlease report this to https://github.com/markedjs/marked.",t.silent)return "<p>An error occurred:</p><pre>"+ZV(e.message+"",!0)+"</pre>";throw e}}xR.options=xR.setOptions=function(e){var t;return lR(xR.defaults,e),t=xR.defaults,$V=t,xR},xR.getDefaults=HV,xR.defaults=$V,xR.use=function(...e){const t=lR({},...e),i=xR.defaults.extensions||{renderers:{},childTokens:{}};let n;e.forEach((e=>{if(e.extensions&&(n=!0,e.extensions.forEach((e=>{if(!e.name)throw new Error("extension name required");if(e.renderer){const t=i.renderers?i.renderers[e.name]:null;i.renderers[e.name]=t?function(...i){let n=e.renderer.apply(this,i);return !1===n&&(n=t.apply(this,i)),n}:e.renderer;}if(e.tokenizer){if(!e.level||"block"!==e.level&&"inline"!==e.level)throw new Error("extension level must be 'block' or 'inline'");i[e.level]?i[e.level].unshift(e.tokenizer):i[e.level]=[e.tokenizer],e.start&&("block"===e.level?i.startBlock?i.startBlock.push(e.start):i.startBlock=[e.start]:"inline"===e.level&&(i.startInline?i.startInline.push(e.start):i.startInline=[e.start]));}e.childTokens&&(i.childTokens[e.name]=e.childTokens);}))),e.renderer){const i=xR.defaults.renderer||new vR;for(const t in e.renderer){const n=i[t];i[t]=(...s)=>{let o=e.renderer[t].apply(i,s);return !1===o&&(o=n.apply(i,s)),o};}t.renderer=i;}if(e.tokenizer){const i=xR.defaults.tokenizer||new gR;for(const t in e.tokenizer){const n=i[t];i[t]=(...s)=>{let o=e.tokenizer[t].apply(i,s);return !1===o&&(o=n.apply(i,s)),o};}t.tokenizer=i;}if(e.walkTokens){const i=xR.defaults.walkTokens;t.walkTokens=function(t){e.walkTokens.call(this,t),i&&i.call(this,t);};}n&&(t.extensions=i),xR.setOptions(t);}));},xR.walkTokens=function(e,t){for(const i of e)switch(t.call(xR,i),i.type){case"table":for(const e of i.header)xR.walkTokens(e.tokens,t);for(const e of i.rows)for(const i of e)xR.walkTokens(i.tokens,t);break;case"list":xR.walkTokens(i.items,t);break;default:xR.defaults.extensions&&xR.defaults.extensions.childTokens&&xR.defaults.extensions.childTokens[i.type]?xR.defaults.extensions.childTokens[i.type].forEach((function(e){xR.walkTokens(i[e],t);})):i.tokens&&xR.walkTokens(i.tokens,t);}},xR.parseInline=function(e,t){if(null==e)throw new Error("marked.parseInline(): input parameter is undefined or null");if("string"!=typeof e)throw new Error("marked.parseInline(): input parameter is of type "+Object.prototype.toString.call(e)+", string expected");hR(t=lR({},xR.defaults,t||{}));try{const i=_R.lexInline(e,t);return t.walkTokens&&xR.walkTokens(i,t.walkTokens),CR.parseInline(i,t)}catch(e){if(e.message+="\nPlease report this to https://github.com/markedjs/marked.",t.silent)return "<p>An error occurred:</p><pre>"+ZV(e.message+"",!0)+"</pre>";throw e}},xR.Parser=CR,xR.parser=CR.parse,xR.Renderer=vR,xR.TextRenderer=yR,xR.Lexer=_R,xR.lexer=_R.lex,xR.Tokenizer=gR,xR.Slugger=kR,xR.parse=xR,xR.options,xR.setOptions,xR.use,xR.walkTokens,xR.parseInline,CR.parse,_R.lex;var HR="undefined"!=typeof window?window:{};(function(){var e=HR.DOMParser,t=!1;try{(new e).parseFromString("","text/html")&&(t=!0);}catch(e){}return t})()?HR.DOMParser:function(){var e=function(){};return !function(){var e=!1;try{document.implementation.createHTMLDocument("").open();}catch(t){HR.ActiveXObject&&(e=!0);}return e}()?e.prototype.parseFromString=function(e){var t=document.implementation.createHTMLDocument("");return t.open(),t.write(e),t.close(),t}:e.prototype.parseFromString=function(e){var t=new window.ActiveXObject("htmlfile");return t.designMode="on",t.open(),t.write(e),t.close(),t},e}();[ga.arrowup,ga.arrowdown,ga.esc];[ga.enter,ga.tab];(()=>[Kp.defaultPositions.northArrowSouth,Kp.defaultPositions.northArrowSouthWest,Kp.defaultPositions.northArrowSouthEast,Kp.defaultPositions.southArrowNorth,Kp.defaultPositions.southArrowNorthWest,Kp.defaultPositions.southArrowNorthEast,Kp.defaultPositions.viewportStickyNorth])();

  const editorConfig$4 = {
    height: 500,
  	toolbar: {
  		items: [
        'heading',
  			'bold',
  			'italic',
  			'underline',
        'link',
  			'code',
  			'|',
  			'bulletedList',
  			'numberedList',
  			'blockQuote',
        'strikethrough',
  		],
  		shouldNotGroupWhenFull: false
  	},
    heading: {
  		options: [
  				{
  					model: 'paragraph',
  					title: 'Paragraph',
  					class: 'ck-heading_paragraph',
  				},
  				{
  					model: 'heading2',
  					view: 'h2',
  					title: 'Heading 2',
  					class: 'ck-heading_heading2',
  				},
  				{
  					model: 'heading3',
  					view: 'h3',
  					title: 'Heading 3',
  					class: 'ck-heading_heading3',
  				},
  				{
  					model: 'heading4',
  					view: 'h4',
  					title: 'Heading 4',
  					class: 'ck-heading_heading4',
  				},
  			],
  	},
  	plugins: [
  		gv,
  		tI,
  		pv,
  		h_,
  		py,
  		Cv,
  		Sv,
  		MC,
  		vx,
      TA,
  		GA,
  		Bv,
  		nI,
  		tP,
  		AP,
  		_A,
  		Nv,
  		Xv,
  		_x
  	],
  	balloonToolbar: ['bold', 'italic', '|', 'link', '|', 'blockQuote', 'highlight'],
  	fontFamily: {
  		supportAllValues: true
  	},
  	list: {
  		properties: {
  			styles: true,
  			startIndex: true,
  			reversed: true
  		}
  	},
  	placeholder: 'Type your topic content here!',
  	style: {
  		definitions: [
  			{
  				name: 'Article category',
  				element: 'h3',
  				classes: ['category']
  			},
  			{
  				name: 'Title',
  				element: 'h2',
  				classes: ['document-title']
  			},
  			{
  				name: 'Subtitle',
  				element: 'h3',
  				classes: ['document-subtitle']
  			},
  			{
  				name: 'Info box',
  				element: 'p',
  				classes: ['info-box']
  			},
  			{
  				name: 'Side quote',
  				element: 'blockquote',
  				classes: ['side-quote']
  			},
  			{
  				name: 'Marker',
  				element: 'span',
  				classes: ['marker']
  			},
  			{
  				name: 'Spoiler',
  				element: 'span',
  				classes: ['spoiler']
  			},
  			{
  				name: 'Code (dark)',
  				element: 'pre',
  				classes: ['fancy-code', 'fancy-code-dark']
  			},
  			{
  				name: 'Code (bright)',
  				element: 'pre',
  				classes: ['fancy-code', 'fancy-code-bright']
  			}
  		]
  	},
  	table: {
  		contentToolbar: ['tableColumn', 'tableRow', 'mergeTableCells', 'tableProperties', 'tableCellProperties']
  	},
  };

  class CreateTopic extends HTMLDivElement {
    constructor() {
      // We are not even going to touch this.
      super();

      this.name = null;
      this.slug = null;
      this.summary = null;
      this.editor = null;

      this.step = 1;

      // let's create our shadow root
      // this.shadowObj = this.attachShadow({ mode: "open" });

      this._url = this.getAttribute('api');

      this.render();
    }

    render() {
      // this.shadowObj.innerHTML = this.getTemplate();
      this.innerHTML = this.getTemplate();
    }

    connectedCallback() {
      // select the form
      const form = this.querySelector('form');

      // select the section
      const section = this.querySelector('section#content');

      if (form && section) {
        // add event listener to the form
        this.submitForm(form, section);

        // validate the slug
        this.validateForm(form);
      }

      const btns = this.querySelectorAll('.cancel-btn');
      const overlay = this.querySelector('.overlay');

      // Close the modal
      if (overlay && btns) {
        this.closePopup(overlay, btns);
      }

      this.disableScroll();
    }

    initEditor() {
      jC.create(this.querySelector('textarea#editor'), editorConfig$4)
      .then(editor => {
        this.editor = editor;
      })
      .catch(error => {
        console.log('Failed to initialize the editor. Error: ', error);
      });
    }

    disconnectedCallback() {
      this.enableScroll();
    }

    closePopup = (overlay, btns) => {
      overlay.addEventListener('click', e => {
        e.preventDefault();
        this.remove();
      });

      btns.forEach(btn => {
        btn.addEventListener('click', e => {
          e.preventDefault();
          this.remove();
        });
      });
    }

    disableScroll() {
      // Get the current page scroll position
      let scrollTop = window.scrollY || document.documentElement.scrollTop;
      let scrollLeft = window.scrollX || document.documentElement.scrollLeft;
      document.body.classList.add("stop-scrolling");

      // if any scroll is attempted, set this to the previous value
      window.onscroll = function () {
        window.scrollTo(scrollLeft, scrollTop);
      };
    }

    enableScroll() {
      document.body.classList.remove("stop-scrolling");
      window.onscroll = function () { };
    }

    submitForm = async (form, section) => {
      const outerThis = this;
      // add submit event listener
      form.addEventListener('submit', async e => {
        e.preventDefault();

        const serverStatus = form.querySelector('.server-status');

        // if server status is already showing, remove it
        if (serverStatus) {
          serverStatus.remove();
        }

        const button = form.querySelector('.action.next');
        const actions = form.querySelector('.actions');

        // show loader inside the button
        button.innerHTML = this.getButtonLoader();
        // disable pointer events
        button.style.pointerEvents = 'none';

        if (this.step === 1) {
          // validate the form
          const isValid = this.validateStepOne(form, actions);

          if (!isValid) {
            return;
          } else {
            this.checkIfTopicExists(form, button, actions);
            return;
          }
        }

        // get the editor data
        const data = this.editor.getData();

        // validate the editor data
        if (!this.validateStepTwo(form, data, actions)) return;

        // send data to server
        const options = {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            slug: this.slug,
            name: this.name,
            summary: this.summary
          })
        };

        try {
          const url = '/api/v1/t/add';
          const response = await outerThis.fetchWithTimeout(url, options);
          const result = await response.json();

          // check if request was successful
          if (result.success) {
            // activate the finish step
            section.innerHTML = this.getFinish();
            this.activateFinish();
          } else {
            // show error message
            actions.insertAdjacentHTML('beforebegin', outerThis.getServerSuccessMsg(false, result.message));

            // reset button
            button.innerHTML = '<span class="text">Create</span>';
            // enable pointer events
            button.style.pointerEvents = 'auto';
          }
        }
        catch (error) {
          console.error(error);
          // show error message
          actions.insertAdjacentHTML('beforebegin', outerThis.getServerSuccessMsg(false, 'An error occurred, please try again'));

          // reset button
          button.innerHTML = '<span class="text">Create</span>';
          // enable pointer events
          button.style.pointerEvents = 'auto';
        }

        // remove success message
        setTimeout(() => {
          const serverStatus = form.querySelector('.server-status');
          if (serverStatus) {
            serverStatus.remove();
          }
        }, 5000);
      });
    }

    checkIfTopicExists = async (form, button, actions) => {
      const url  = '/api/v1/t/check/topic';
      const options = {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          slug: this.slug,
          name: this.name
        })
      };

      try {
        const response = await this.fetchWithTimeout(url, options);
        const result = await response.json();

        if (result.success) {
          // activate the next step
          // replace the current fields with the editor
          form.querySelector('.fields-container').innerHTML = this.getSummaryEditor();
          this.initEditor();

          // restore button
          button.innerHTML = '<span class="text">Create</span>';
          // enable pointer events
          button.style.pointerEvents = 'auto';
          this.step = 2;
        } else {
          // show error message
          actions.insertAdjacentHTML('beforebegin', this.getServerSuccessMsg(false, result.message));

          // restore button
          button.innerHTML = '<span class="text">Next</span>';
          // enable pointer events
          button.style.pointerEvents = 'auto';

          // remove success message
          setTimeout(() => {
            const serverStatus = form.querySelector('.server-status');
            if (serverStatus) {
              serverStatus.remove();
            }
          }, 5000);
        }
      }
      catch (error) {
        console.error(error);
        // show error message
        actions.insertAdjacentHTML('beforebegin', this.getServerSuccessMsg(false, 'An error occurred, please try again'));

        // restore button
        button.innerHTML = '<span class="text">Next</span>';
        // enable pointer events
        button.style.pointerEvents = 'auto';

        // remove success message
        setTimeout(() => {
          const serverStatus = form.querySelector('.server-status');
          if (serverStatus) {
            serverStatus.remove();
          }
        }, 5000);
      }
    }

    validateStepOne = (form, actions) => {
      const outerThis = this;
      // get and validate form data
      const formData = new FormData(form);

      // get form data
      const data = {
        slug: formData.get('slug'),
        name: formData.get('title'),
      };

      // check if form data is valid
      if (!data.slug) {
        
        const errorMsg = 'slug must be defined!';

        // show error message
        actions.insertAdjacentHTML('beforebegin', outerThis.getServerSuccessMsg(false, errorMsg));
        setTimeout(() => {
          const serverStatus = form.querySelector('.server-status');
          if (serverStatus) {
            serverStatus.remove();
          }
        }, 5000);

        return false;
      }

      // validate slug
      if (data.slug.length < 3) {
        // show error message
        actions.insertAdjacentHTML('beforebegin', outerThis.getServerSuccessMsg(false, 'slug must be at least 3 characters'));

        setTimeout(() => {
          const serverStatus = form.querySelector('.server-status');
          if (serverStatus) {
            serverStatus.remove();
          }
        }, 5000);

        return false;
      }

      // validate slug: only letters, numbers, and hyphens and lower case
      if(!/^[a-z0-9-]*$/.test(data.slug)) {
        // show error message
        actions.insertAdjacentHTML('beforebegin', outerThis.getServerSuccessMsg(false, 'slug can only contain letters, numbers, and hyphens and lowercase'));

        setTimeout(() => {
          const serverStatus = form.querySelector('.server-status');
          if (serverStatus) {
            serverStatus.remove();
          }
        }, 5000);

        return false;
      }

      // validate title and not less than 2 characters
      if (!data.name || data.name.length < 2) {
        // show error message
        actions.insertAdjacentHTML('beforebegin', outerThis.getServerSuccessMsg(false, 'title must be at least 2 characters'));

        setTimeout(() => {
          const serverStatus = form.querySelector('.server-status');
          if (serverStatus) {
            serverStatus.remove();
          }
        }, 5000);

        return false;
      }

      // set the data
      this.name = data.name;
      this.slug = data.slug;

      return true;
    }

    validateStepTwo = (form, summary, actions) => {
      // check if post summary is valid
      if (!summary) {
        // show error message
        actions.insertAdjacentHTML('beforebegin', this.getServerSuccessMsg(false, 'Post content must be defined!'));

        setTimeout(() => {
          const serverStatus = form.querySelector('.server-status');
          if (serverStatus) {
            serverStatus.remove();
          }
        }, 5000);

        return false;
      }

      // clone the data
      let content = summary;

      // validate post content: count length without html tags
      content = content.replace(/<[^>]*>?/gm, '');

      if (content.length < 3) {
        // show error message
        actions.insertAdjacentHTML('beforebegin', this.getServerSuccessMsg(false, 'Post content must be at least 3 characters'));

        setTimeout(() => {
          const serverStatus = form.querySelector('.server-status');
          if (serverStatus) {
            serverStatus.remove();
          }
        }, 5000);

        return false;
      }

      // set the data
      this.summary = summary;
        
      return true;
    }

    fetchWithTimeout = async (url, options = {}, timeout = 9500) => {
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), timeout);
    
      try {
        const response = await fetch(url, {
          ...options,
          signal: controller.signal
        });

        return response;
      } catch (error) {
        if (error.name === 'AbortError') {
          throw new Error('Request timed out');
        }
        throw new Error(`Network error: ${error.message}`);
      } finally {
        clearTimeout(timeoutId);
      }
    };

    getServerSuccessMsg = (success, text) => {
      if (!success) {
        return `
        <p class="server-status">${text}</p>
      `
      }
      return `
      <p class="server-status success">${text}</p>
    `
    }

    getTemplate() {
      // Show HTML Here
      return /*html*/`
      <div class="content-wrapper">
        <div class="overlay"></div>
        <section id="content" class="content">
          ${this.getBody()}
        </section>
      </div>
    ${this.getStyles()}`
    }

    getBody = () => {
      return /* html */`
      ${this.getHeader()}
      <form class="fields" id="topic-form">
        <div class="fields-container">
          ${this.getFields()}
        </div>
        <div class="actions">
          <span class="action-info">Creating a new topic</span>
          <button type="submit" class="action next">
            <span class="text">Next</span>
          </button>
        </div>
      </form>
    `;
    }

    getFields = () => {
      return /* html */`
      <div class="field">
        <label for="title">Name</label>
        <input type="text" name="title" id="title" placeholder="Enter the title of the topic" required />
        <span class="status"></span>
      </div>
      <div class="field">
        <label for="slug">Slug</label>
        <input type="text" name="slug" id="slug" placeholder="Enter a unique slug for the topic" required />
        <span class="status"></span>
      </div>
    `;
    }

    getSummaryEditor = () => {
      return /* html */`
      <textarea name="editor" id="editor" cols="30" rows="10" placeholder="Type your topic content here!"></textarea>
    `;
    }

    getFinish = () => {
      return /* html */`
      <div class="finish">
        <h2 class="title">Topic Created!</h2>
        <p class="desc">
          Your topic has been successfully created and will appear in the feeds. You can now close this modal using the button below.
        </p>
        <button class="finish">Close</button>
      </div>
    `;
    }

    activateFinish = () => {
      const button = this.querySelector('section#content button.finish');
      if (button) {
        button.addEventListener('click', e => {
          e.preventDefault();
          
          // close the modal
          this.remove();
        });
      }
    }

    validateForm = form => {
      const input = form.querySelector('input[name="slug"]');
      const title = form.querySelector('input[name="title"]');

      if (input && title) {
        // add an input event listener
        input.addEventListener('input', e => {
          const value = e.target.value;

          if (!value) {
            input.parentElement.classList.remove('success');
            input.parentElement.classList.add('failed');
            input.parentElement.querySelector('span.status').textContent = 'slug is required';
            return;
          }

          if (value.length < 3) {
            input.parentElement.classList.remove('success');
            input.parentElement.classList.add('failed');
            input.parentElement.querySelector('span.status').textContent = 'slug must be at least 3 characters';
            return;
          }

          if(!/^[a-z0-9-]*$/.test(value)) {
            input.parentElement.classList.remove('success');
            input.parentElement.classList.add('failed');
            input.parentElement.querySelector('span.status').textContent = 'slug can only contain letters, numbers, and hyphens and be in lowercase';
            return;
          }

          input.parentElement.classList.remove('failed');
          input.parentElement.classList.add('success');
          input.parentElement.querySelector('span.status').textContent = '';
        });

        // add an input event listener to title
        title.addEventListener('input', e => {
          const value = e.target.value;

          if (!value) {
            title.parentElement.classList.remove('success');
            title.parentElement.classList.add('failed');
            title.parentElement.querySelector('span.status').textContent = 'title is required';
            return;
          }

          // check for length
          if (value.length < 2) {
            title.parentElement.classList.remove('success');
            title.parentElement.classList.add('failed');
            title.parentElement.querySelector('span.status').textContent = 'title must be at least 2 characters';
            return;
          }

          title.parentElement.classList.remove('failed');
          title.parentElement.classList.add('success');
          title.parentElement.querySelector('span.status').textContent = '';
        });
      }
    }

    getHeader = () => {
      return /* html */`
      <h2 class="pop-title">
        <span class="control cancel-btn">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" fill="currentColor">
            <path d="M3.72 3.72a.75.75 0 0 1 1.06 0L8 6.94l3.22-3.22a.749.749 0 0 1 1.275.326.749.749 0 0 1-.215.734L9.06 8l3.22 3.22a.749.749 0 0 1-.326 1.275.749.749 0 0 1-.734-.215L8 9.06l-3.22 3.22a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042L6.94 8 3.72 4.78a.75.75 0 0 1 0-1.06Z"></path>
          </svg>
        </span>
        <span class="text">Create a topic</span>
      </h2>
    `;
    }

    getButtonLoader() {
      return /*html*/`
      <span id="btn-loader">
				<span class="loader"></span>
			</span>
    `
    }

    getStyles() {
      return /* css */`
      <link rel="stylesheet" href="/static/css/ckeditor.css">
      <style>
        *,
        *:after,
        *:before {
          box-sizing: border-box !important;
          font-family: inherit;
          -webkit-box-sizing: border-box !important;
        }

        *:focus {
          outline: inherit !important;
        }

        *::-webkit-scrollbar {
          -webkit-appearance: none;
        }

        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
          padding: 0;
          margin: 0;
          font-family: inherit;
        }

        p,
        ul,
        ol {
          padding: 0;
          margin: 0;
        }

        a {
          text-decoration: none;
        }

        .content-wrapper {
          border: none;
          padding: 0;
          justify-self: end;
          display: flex;
          flex-flow: column;
          align-items: center;
          justify-content: center;
          gap: 10px;
          z-index: 100;
          width: 100%;
          min-width: 100vw;
          position: fixed;
          right: 0;
          top: 0;
          bottom: 0;
          left: 0;
        }

        div.overlay {
          position: absolute;
          top: 0;
          right: 0;
          bottom: 0;
          left: 0;
          height: 100%;
          width: 100%;
          background-color: var(--modal-background);
          backdrop-filter: blur(3px);
          -webkit-backdrop-filter: blur(3px);
        }

        #content {
          z-index: 1;
          background-color: var(--background);
          padding: 20px 18px 15px;
          display: flex;
          flex-flow: column;
          align-items: center;
          justify-content: start;
          gap: 15px;
          width: 700px;
          max-height: 90%;
          height: max-content;
          border-radius: 15px;
          position: relative;
          overflow-y: auto;
        }

        p.server-status {
          margin: 0;
          width: 100%;
          text-align: start;
          font-family: var(--font-read), sans-serif;
          color: var(--error-color);
          font-weight: 500;
          line-height: 1.4;
          font-size: 1.18rem;
        }

        p.server-status.success {
          color: transparent;
          background: var(--accent-linear);
          background-clip: text;
          -webkit-background-clip: text;
        }

        #btn-loader {
          position: absolute;
          top: 0;
          left: 0;
          bottom: 0;
          right: 0;
          z-index: 5;
          display: flex;
          align-items: center;
          justify-content: center;
          border-radius: inherit;
        }

        #btn-loader > .loader {
          width: 20px;
          aspect-ratio: 1;
          --_g: no-repeat radial-gradient(farthest-side, #18A565 94%, #0000);
          --_g1: no-repeat radial-gradient(farthest-side, #21D029 94%, #0000);
          --_g2: no-repeat radial-gradient(farthest-side, #df791a 94%, #0000);
          --_g3: no-repeat radial-gradient(farthest-side, #f09c4e 94%, #0000);
          background:    var(--_g) 0 0,    var(--_g1) 100% 0,    var(--_g2) 100% 100%,    var(--_g3) 0 100%;
          background-size: 30% 30%;
          animation: l38 .9s infinite ease-in-out;
          -webkit-animation: l38 .9s infinite ease-in-out;
        }

        @keyframes l38 {
          100% {
            background-position: 100% 0, 100% 100%, 0 100%, 0 0
          }
        }

        h2.pop-title {
          width: 100%;
          font-size: 1.35rem;
          font-weight: 600;
          margin: 0;
          padding: 10px 10px;
          background-color: var(--gray-background);
          text-align: center;
          border-radius: 12px;
          font-family: var(--font-read), sans-serif;
          color: var(--text-color);
          font-weight: 500;
          position: relative;
        }

        h2.pop-title > span.control {
          padding: 0;
          cursor: pointer;
          display: flex;
          flex-flow: column;
          gap: 0px;
          justify-content: center;
          position: absolute;
          top: 50%;
          left: 10px;
          transform: translateY(-50%);
        }

        h2.pop-title > span.control svg {
          width: 21px;
          height: 21px;
          color: var(--text-color);
        }

        h2.pop-title > span.control svg:hover{
          color: var(--error-color);
        }

        .top {
          display: flex;
          flex-flow: column;
          gap: 5px;
          padding: 0;
          width: 100%;
        }

        .top > .desc {
          margin: 0;
          padding: 10px 0 20px;
          color: var(--text-color);
          font-size: 0.95rem;
          font-family: var(--font-main), sans-serif;
        }

        .top > .desc > span {
          display: inline-block;
          margin: 10px 0 5px;
          color: var(--gray-color);
          font-size: 0.85rem;
          font-style: italic;
          font-family: var(--font-read), sans-serif;
        }

        form.fields {
          margin: 0;
          width: 100%;
          display: flex;
          flex-flow: column;
          justify-content: center;
          align-items: center;
          gap: 20px;
        }

        form.fields > .fields-container {
          width: 100%;
          display: flex;
          flex-flow: column;
          justify-content: center;
          align-items: start;
          gap: 0;
        }

        form.fields > .fields-container > .field {
          width: 100%;
          display: flex;
          flex-flow: column;
          justify-content: center;
          align-items: start;
          gap: 5px;
        }

        form.fields label {
          padding: 0 0 1px 5px;
          color: var(--text-color);
        }

        form.fields label {
          color: var(--label-color);
          margin: 20px 0 0 0;
          font-size: 1.1rem;
          font-family: var(--font-read), sans-serif;
          transition: all 0.3s ease-in-out;
          pointer-events: none;
        }

        form.fields .field input {
          border: var(--input-border);
          border: none;
          transition: border-color 0.3s ease-in-out;
          background: var(--background);
          font-family: var(--font-read), sans-serif;
          font-size: 1rem;
          width: 100%;
          height: 40px;
          outline: none;
          padding: 10px 12px;
          border-radius: 12px;
          color: var(--text-color);
          -webkit-border-radius: 12px;
          -moz-border-radius: 12px;
          -ms-border-radius: 12px;
          -o-border-radius: 12px;
        }

        form.fields .field input {
          border: none;
          border: var(--border);
          font-family: var(--font-read), sans-serif;
          background-color: var(--background) !important;
          font-size: 1rem;
          width: 100%;
          height: 40px;
          outline: none;
          padding: 10px 12px;
          border-radius: 12px;
          color: var(--text-color);
        }
        
        form.fields .field input:-webkit-autofill,
        form.fields .field input:-webkit-autofill:hover, 
        form.fields .field input:-webkit-autofill:focus {
          -webkit-box-shadow: 0 0 0px 1000px var(--background) inset;
          -webkit-text-fill-color: var(--text-color) !important;
          transition: background-color 5000s ease-in-out 0s;
          color: var(--text-color) !important;
        }
        
        form.fields .field input:autofill {
          filter: none;
          color: var(--text-color) !important;
        }

        form.fields .field input:focus {
          border: var(--input-border-focus);
        }

        form.fields textarea {
          border: none;
          border: var(--border);
          font-family: var(--font-read), sans-serif;
          background: var(--background);
          font-size: 1rem;
          padding: 10px 12px;
          margin: 0;
          width: 100%;
          resize: none;
          height: 120px;
          gap: 5px;
          font-weight: 400;
          color: var(--text-color);
          -ms-overflow-style: none;
          scrollbar-width: none;
          border-radius: 12px;
        }

        form.fields textarea::-webkit-scrollbar {
          display: none !important;
          visibility: hidden;
        }

        form.fields textarea:focus {
          border: var(--input-border-focus);
        }

        form.fields .field span.wrapper {
          display: flex;
          align-items: center;
          align-items: center;
          gap: 0;
          width: 100%;
        }

        form.fields .field.success > span.wrapper > input,
        form.fields .field.success > span.wrapper > input:focus,
        form.fields .field.success input,
        form.fields .field.success input:focus {
          border: var(--input-border-focus);
        }

        form.fields .field.failed > span.wrapper > input,
        form.fields .field.failed > span.wrapper > input:focus,
        form.fields .field.failed input,
        form.fields .field.failed input:focus {
          border: var(--input-border-error);
        }

        form.fields .field.success span.wrapper > input,
        form.fields .field.success input {
          color: var(--accent-color);
        }

        form.fields .field.failed span.wrapper > input,
        form.fields .field.failed input {
          color: var(--error-color);
        }

        form.fields label.focused {
          top: -10px;
          font-size: 0.9rem;
          background-color: var(--label-focus-background);
          padding: 0 5px;
        }

        form.fields .field span.status {
          color: var(--error-color);
          font-size: 0.95rem;
          display: none;
          padding: 0 0 0 5px;
        }

        form.fields .field.failed span.status {
          color: var(--error-color);
          font-size: 0.8rem;
          display: inline-block;
        }

        form.fields .field.success span.status {
          color: var(--accent-color);
          font-size: 0.8rem;
          display: inline-block;
        }

        form.fields .field.success span.status {
          display: none;
        }

        form.fields .actions {
          border-top: var(--border);
          display: flex;
          align-items: center;
          justify-content: space-between;
          width: 100%;
          gap: 20px;
          margin: 0 0 0 2px;
          padding: 15px 0 0;
        }

        form.fields .actions > span.action-info {
          color: var(--gray-color);
          font-size: 0.95rem;
          font-family: var(--font-read), sans-serif;
          font-weight: 400;
          line-height: 1.5;
        }

        form.fields .actions > .action {
          border: none;
          background: var(--accent-linear);
          font-family: var(--font-main), sans-serif;
          text-decoration: none;
          color: var(--white-color);
          font-size: 1rem;
          font-weight: 600;
          cursor: pointer;
          display: flex;
          flex-flow: row;
          align-items: center;
          text-transform: capitalize;
          justify-content: center;
          padding: 7px 15px 8px;
          min-height: 35px;
          height: 35px;
          min-width: 60px;
          width: max-content;
          position: relative;
          border-radius: 50px;
          -webkit-border-radius: 50px;
          -moz-border-radius: 50px;
        }

        form.fields .actions > .action.cancel-btn {
          background: var(--gray-background);
          fill: var(--text-color);
          /*text-transform: lowercase;*/
        }

        form.fields .actions > .action.prev svg path {
          fill: var(--text-color);
        }

        form.fields .actions > .action.next {
          color: var(--white-color);
          background: var(--stage-no-linear);
        }

        form.fields .actions > .action.next svg path {
          fill: var(--white-color);
        }

        form.fields .actions > .action.disabled {
          pointer-events: none;
        }

        div.finish {
          padding: 15px 0;
          width: 100%;
          min-width: 100%;
          height: auto;
          display: flex;
          flex-flow: column;
          justify-content: center;
          align-items: center;
          gap: 15px;
        }

        div.finish > h2.title {
          margin: 0;
          font-size: 1.25rem;
          font-weight: 600;
          font-family: var(--font-main), sans-serif;
          color: var(--text-color);
        }

        div.finish > p.desc {
          margin: 0;
          font-size: 0.95rem;
          font-family: var(--font-read), sans-serif;
          color: var(--text-color);
          line-height: 1.4;
          text-align: center;
        }

        div.finish > button.finish {
          border: none;
          background: var(--accent-linear);
          font-family: var(--font-main), sans-serif;
          text-decoration: none;
          color: var(--white-color);
          font-size: 1rem;
          font-weight: 600;
          cursor: pointer;
          display: flex;
          width: max-content;
          flex-flow: row;
          align-items: center;
          text-transform: capitalize;
          justify-content: center;
          padding: 7px 15px 8px;
          border-radius: 50px;
          -webkit-border-radius: 50px;
          -moz-border-radius: 50px;
        }

        #editor {
          min-width: 100%;
          width: 100%;
          max-height: 250px;
          height: 250px;
          overflow-y: auto;
          font-family: var(--font-text), sans-serif;
        }

        .ck.ck-editor__main > .ck-editor__editable {
          color: var(--editor-color);
        }

        .ck.ck-editor__main > .ck-editor__editable a {
          color: var(--anchor-color);
        }

        .ck-editor__editable_inline:not(.ck-comment__input *) {
          height: calc(90dvh - 205px);
          font-family: var(--font-text), sans-serif;
          overflow-y: auto;
        }

        .ck-body-wrapper {
          display: none;
          opacity: 0;
          visibility: hidden;
        }

        .ck.ck-reset.ck-editor {
          display: -webkit-box;
          display: -moz-box;
          display: -ms-flexbox;
          display: -webkit-flex;
          display: flex;
          -webkit-flex-direction: column;
          -moz-flex-direction: column;
          -ms-flex-direction: column;
          flex-direction: column;
        }

        .ck-focused, .ck.ck-editor__editable:not(.ck-editor__nested-editable).ck-focused {
          border: none;
          border: none;
          outline: none !important;
          -moz-outline: none !important;
          -webkit-outline: none !important;
          -ms-outline: none !important;
          -webkit-box-shadow: none;
          -moz-box-shadow: none;
          box-shadow: none
        }

        @media screen and (max-width:600px) {
          .content-wrapper {
            border: none;
            background-color: var(--modal-background);
            padding: 0px;
            justify-self: end;
            display: flex;
            flex-flow: column;
            align-items: center;
            justify-content: end;
            gap: 10px;
            z-index: 20;
            position: fixed;
            right: 0;
            top: 0;
            bottom: 0;
            left: 0;
            min-width: 100dvw;
            min-height: 100dvh;
          }

          #content {
            box-sizing: border-box !important;
            padding: 20px 10px 15px 10px;
            margin: 0;
            width: 100%;
            max-width: 100%;
            max-height: 100%;
            min-height: 100%;
            border-radius: 0;
            overflow-y: auto;
          }

          #content span.control {
            cursor: default !important;
          }

          ::-webkit-scrollbar {
            -webkit-appearance: none;
          }

          h2.pop-title {
            width: 100%;
            font-size: 1.2rem;
            padding: 10px 10px;
            background-color: var(--gray-background);
            text-align: center;
            border-radius: 12px;
          }

          .top > .desc {
            margin: 0;
            padding: 6px 0 10px;
            font-size: 0.95rem;
            line-height: 1.5;
            font-family: var(--font-main), sans-serif;
          }

          div.finish {
            padding: 25px 0 10px;
            width: 100%;
            min-width: 100%;
            height: auto;
            display: flex;
            flex-flow: column;
            justify-content: center;
            align-items: center;
            gap: 18px;
          }

          div.post-type > div.types {
            width: 100%;
            display: flex;
            flex-flow: column;

            gap: 20px;
          }

          form.fields .actions {
            align-items: center;
            width: 100%;
            gap: 25px;
          }

          div.finish > button.finish {
            margin: 10px 0 0;
          }

          form.fields > .field.polls > div.remove > span.remove-poll,
          form.fields > .field.polls > .poll-inputs > span.add-option,
          div.finish > button.finish,
          form.fields .actions > .action {
            cursor: default !important;
          }

          .ck-editor__editable_inline:not(.ck-comment__input *) {
            height: calc(100dvh - 215px);
            overflow-y: auto;
          }
        }
      </style>
    `;
    }
  }

  const editorConfig$3 = {
    height: 500,
  	toolbar: {
  		items: [
  			'bold',
  			'italic',
  			'underline',
        'link',
  			'code',
  			'|',
  			'bulletedList',
  			'numberedList',
  			'blockQuote',
  			'|',
        'strikethrough',
  		],
  		shouldNotGroupWhenFull: false
  	},
  	plugins: [
  		gv,
  		tI,
  		pv,
  		h_,
  		py,
  		Cv,
  		Sv,
  		MC,
  		vx,
  		GA,
  		Bv,
  		nI,
  		tP,
  		AP,
  		_A,
  		Nv,
  		Xv,
  		_x
  	],
  	balloonToolbar: ['bold', 'italic', '|', 'link', '|', 'blockQuote'],
  	fontFamily: {
  		supportAllValues: true
  	},
    link: {
  		addTargetToExternalLinks: true,
  		defaultProtocol: 'https://',
  		decorators: {
  			toggleDownloadable: {
  				mode: 'manual',
  				label: 'Downloadable',
  				attributes: {
  					download: 'file'
  				}
  			}
  		}
  	},
  	list: {
  		properties: {
  			styles: true,
  			startIndex: true,
  			reversed: true
  		}
  	},
  	placeholder: 'Type or paste your content here!',
  	style: {
  		definitions: [
  			{
  				name: 'Article category',
  				element: 'h3',
  				classes: ['category']
  			},
  			{
  				name: 'Title',
  				element: 'h2',
  				classes: ['document-title']
  			},
  			{
  				name: 'Subtitle',
  				element: 'h3',
  				classes: ['document-subtitle']
  			},
  			{
  				name: 'Info box',
  				element: 'p',
  				classes: ['info-box']
  			},
  			{
  				name: 'Side quote',
  				element: 'blockquote',
  				classes: ['side-quote']
  			},
  			{
  				name: 'Marker',
  				element: 'span',
  				classes: ['marker']
  			},
  			{
  				name: 'Spoiler',
  				element: 'span',
  				classes: ['spoiler']
  			},
  			{
  				name: 'Code (dark)',
  				element: 'pre',
  				classes: ['fancy-code', 'fancy-code-dark']
  			},
  			{
  				name: 'Code (bright)',
  				element: 'pre',
  				classes: ['fancy-code', 'fancy-code-bright']
  			}
  		]
  	},
  	table: {
  		contentToolbar: ['tableColumn', 'tableRow', 'mergeTableCells', 'tableProperties', 'tableCellProperties']
  	},
    // AutoGrow configuration
    autoGrow: {
      minHeight: '100px',
      maxHeight: '300px'
    },
  };

  class NewPost extends HTMLDivElement {
    constructor() {
      // We are not even going to touch this.
      super();

      this.editor = null;

      // let's create our shadow root
      // this.shadowObj = this.attachShadow({ mode: "open" });

      this._url = this.getAttribute('api');

      this._option = 'Post';

      this.render();
    }

    render() {
      // this.shadowObj.innerHTML = this.getTemplate();
      this.innerHTML = this.getTemplate();
    }

    connectedCallback() {
      // select section
      const section = this.querySelector('section.content');

      // select the form
      const form = this.querySelector('form');

      if (form && section) {
        // add event listener to the form
        this.submitForm(form, section);

        // activate the post type
        this.activatePostType(form);

        // activate the poll type
        this.activatePollType(form);
      }
      
      const btns = this.querySelectorAll('.cancel-btn');
      const overlay = this.querySelector('.overlay');

      // Close the modal
      if (overlay && btns) {
        this.closePopup(overlay, btns);
      }

      this.disableScroll();
    }

    initEditor() {
      const actions = this.querySelector('form.fields .actions');
      jC.create(this.querySelector('#editor'), editorConfig$3)
      .then(editor => {
        this.editor = editor;

        // add event listener to the editor
        this.editor.model.document.on('change:data', () => {
          // console.log('The data has changed!');
          if(actions) {
            // check if data is not empty or not an empty string
            if(this.editor.getData().trim() !== '') {
              actions.classList.add('active');
              actions.querySelector('.action.submit').style.pointerEvents = 'auto';
            } else {
              actions.classList.remove('active');
              actions.querySelector('.action.submit').style.pointerEvents = 'none';
            }
          }
        });

      })
      .catch(error => {
        console.log('Failed to initialize the editor. Error: ', error);
      });
    }

    activatePoll = form => {
      const textarea = form.querySelector('textarea#poll');
      const pollInputs = form.querySelector('div#poll-inputs');
      const actions = form.querySelector('.actions');

      // add event listener to the textarea
      if (textarea && pollInputs && actions) {
        this.growTextarea(form);
        this.addPollOption(pollInputs);

        // enable the submit button
        actions.classList.add('active');
        actions.querySelector('.action.submit').style.pointerEvents = 'auto';
      }
    }

    disconnectedCallback() {
      this.enableScroll();
    }

    closePopup = (overlay, btns) => {
      overlay.addEventListener('click', e => {
        e.preventDefault();
        this.remove();
      });

      btns.forEach(btn => {
        btn.addEventListener('click', e => {
          e.preventDefault();
          this.remove();
        });
      });
    }

    disableScroll() {
      // Get the current page scroll position
      let scrollTop = window.scrollY || document.documentElement.scrollTop;
      let scrollLeft = window.scrollX || document.documentElement.scrollLeft;
      document.body.classList.add("stop-scrolling");

      // if any scroll is attempted, set this to the previous value
      window.onscroll = function () {
        window.scrollTo(scrollLeft, scrollTop);
      };
    }

    enableScroll() {
      document.body.classList.remove("stop-scrolling");
      window.onscroll = function () { };
    }

    submitForm = async (form, section) => {
      const outerThis = this;
      // add submit event listener
      form.addEventListener('submit', async e => {
        e.preventDefault();
        // declare variables
        let body;

        const serverStatus = form.querySelector('.server-status');

        // if server status is already showing, remove it
        if (serverStatus) {
          serverStatus.remove();
        }

        const button = form.querySelector('.action.submit');

        const actions = form.querySelector('.actions');

        // get and validate form data
        const formData = this.getFormData(form);

        if (formData.postType === 'Poll') {
          if (!this.validatePollData(form, formData, actions)) {
            return;
          }

          // remove out empty null / empty / undefined options
          const options = [];
          formData.options.forEach(option => {
            if (option) {
              options.push(option);
            }
          });

          // Surround the content with a p and all \n with <br>
          const content = outerThis.processTextAreaInput(formData.content);

          // Construct the body object
          body = {
            kind: 'poll',
            published: true,
            content: content,
            poll: options,
            end: parseInt(formData.end)
          };

          // show loader inside the button
          const button = form.querySelector('.actions .action.submit');
          button.innerHTML = this.getButtonLoader();
          // disable pointer events
          button.style.pointerEvents = 'none';
        } else {
          if (!this.validatePostData(form, formData, actions)) {
            return;
          }

          // get images-uploader: images attribute
          const imagesUploader = form.querySelector('images-uploader');
          let images = imagesUploader.getAttribute('images').split(',');

          // filter out empty strings
          images = images.filter(image => image.trim() !== '' && image !== 'null' && image.length > 5);

          // if length is greater than 0, add them to the body
          if (images.length > 0) {
            // Construct the body object
            body = {
              kind: 'post',
              published: true,
              images: images,
              content: formData.content
            };
          } else {
            // Construct the body object
            body = {
              kind: 'post',
              published: true,
              content: formData.content
            };
          }

          // show loader inside the button
          const button = form.querySelector('.actions .action.submit');
          button.innerHTML = this.getButtonLoader();
          // disable pointer events
          button.style.pointerEvents = 'none';
        }

        // send data to server
        const options = {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(body)
        };

        try {
          const response = await outerThis.fetchWithTimeout(outerThis._url, options);
          const result = await response.json();

          // check if request was successful
          if (result.success) {
            // show success message
            actions.insertAdjacentHTML('beforebegin', 
              outerThis.getServerSuccessMsg(true, 'Post created successfully')
            );

            // add finish message
            outerThis.removeFormAndTopDesc(section);
          } else {
            // show error message
            actions.insertAdjacentHTML('beforebegin', outerThis.getServerSuccessMsg(false, result.message));

            // reset button
            button.innerHTML = '<span class="text">Post</span>';
            // enable pointer events
            button.style.pointerEvents = 'auto';
          }
        }
        catch (error) {
          // show error message
          actions.insertAdjacentHTML('beforebegin', outerThis.getServerSuccessMsg(false, 'An error occurred, please try again'));

          // reset button
          button.innerHTML = '<span class="text">Post</span>';
          // enable pointer events
          button.style.pointerEvents = 'auto';
        }

        // remove success message
        setTimeout(() => {
          const serverStatus = form.querySelector('.server-status');
          if (serverStatus) {
            serverStatus.remove();
          }
        }, 5000);
      });
    }

    processTextAreaInput = input => {
      return input
        .split('\n') // Split the input by new lines
        .map(line => line.trim()) // Trim each line to remove spaces
        .filter(line => line.length > 0) // Remove empty lines
        .map(line => `<p>${this.escapeHtml(line)}</p>`)  // Surround each line with <p> tags
        .join(''); // Join the array back into a single string
    }

    escapeHtml = html => {
      const text = document.createTextNode(html);
      const div = document.createElement('div');
      div.appendChild(text);
      return div.innerHTML; // Return the escaped HTML
    }

    validatePollData = (form, data, actions) => {
      // check if poll data is valid
      if (!data.content) {
        // show error message
        actions.insertAdjacentHTML('beforebegin', this.getServerSuccessMsg(false, 'Poll question must be defined!'));

        setTimeout(() => {
          const serverStatus = form.querySelector('.server-status');
          if (serverStatus) {
            serverStatus.remove();
          }
        }, 5000);

        return false;
      }

      // validate poll question
      if (data.content.length < 3) {
        // show error message
        actions.insertAdjacentHTML('beforebegin', this.getServerSuccessMsg(false, 'Poll question must be at least 3 characters'));

        setTimeout(() => {
          const serverStatus = form.querySelector('.server-status');
          if (serverStatus) {
            serverStatus.remove();
          }
        }, 5000);

        return false;
      }

      // validate poll options
      if (!data.options || data.options.length < 2) {
        // show error message
        actions.insertAdjacentHTML('beforebegin', this.getServerSuccessMsg(false, 'Poll must have at least 2 options'));

        setTimeout(() => {
          const serverStatus = form.querySelector('.server-status');
          if (serverStatus) {
            serverStatus.remove();
          }
        }, 5000);

        return false;
      }

      // validate poll options
      if (data.options.length > 4) {
        // show error message
        actions.insertAdjacentHTML('beforebegin', this.getServerSuccessMsg(false, 'Poll can only have a maximum of 4 options'));

        setTimeout(() => {
          const serverStatus = form.querySelector('.server-status');
          if (serverStatus) {
            serverStatus.remove();
          }
        }, 5000);

        return false;
      }

      // validate poll end
      if (!data.end || data.end < 1 || data.end > 7) {
        // show error message
        actions.insertAdjacentHTML('beforebegin', this.getServerSuccessMsg(false, 'Poll end must be defined and greater than 0 and less than or equal to 7'));

        setTimeout(() => {
          const serverStatus = form.querySelector('.server-status');
          if (serverStatus) {
            serverStatus.remove();
          }
        }, 5000);

        return false;
      }

      return true;
    }

    validatePostData = (form, data, actions) => {
      // console.log(data);
      // check if post data is valid
      if (!data.content) {
        // show error message
        actions.insertAdjacentHTML('beforebegin', this.getServerSuccessMsg(false, 'Post content must be defined!'));

        setTimeout(() => {
          const serverStatus = form.querySelector('.server-status');
          if (serverStatus) {
            serverStatus.remove();
          }
        }, 5000);

        return false;
      }

      // clone the data
      let content = data.content;

      // validate post content: count length without html tags
      content = content.replace(/<[^>]*>?/gm, '');

      if (content.length < 3) {
        // show error message
        actions.insertAdjacentHTML('beforebegin', this.getServerSuccessMsg(false, 'Post content must be at least 3 characters'));

        setTimeout(() => {
          const serverStatus = form.querySelector('.server-status');
          if (serverStatus) {
            serverStatus.remove();
          }
        }, 5000);

        return false;
      }
        
      return true;
    }

    getFormData = form => {
      const postType =  this._option;

      if (postType === 'Poll') {
        const data = new FormData(form);

        return {
          postType: postType,
          content: data.get('poll'),
          options: [
            data.get('option1'),
            data.get('option2'),
            data.get('option3'),
            data.get('option4')
          ],
          end: data.get('poll-end')
        };

      } else {
        // get data from the editor
        const data = this.editor.getData();

        return {
          postType: postType,
          content: this.cleanWysiwygText(data)
        };
      }
    }

    cleanWysiwygText(input) {
      let cleanedText = input;

      // Step 1: Remove whitespace between tags
      cleanedText = cleanedText.replace(/>\s+</g, '><');

      // Step 2: Remove empty tags and tags with only &nbsp; or whitespace
      cleanedText = cleanedText.replace(/<(\w+)>(\s|&nbsp;)*<\/\1>/g, '');

      // Step 3: Remove <br> tags immediately after opening tags
      cleanedText = cleanedText.replace(/<(\w+)><br>/g, '<$1>');

      // Additional step: Remove <br> tags immediately before closing tags
      cleanedText = cleanedText.replace(/<br><\/(\w+)>/g, '</$1>');

      // Preserve <br> tags in the middle of content
      cleanedText = cleanedText.replace(/>(\s*<br>\s*)+</g, '><br><');

      return cleanedText;
    }

    fetchWithTimeout = async (url, options = {}, timeout = 9500) => {
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), timeout);
    
      try {
        const response = await fetch(url, {
          ...options,
          signal: controller.signal
        });

        return response;
      } catch (error) {
        if (error.name === 'AbortError') {
          throw new Error('Request timed out');
        }
        throw new Error(`Network error: ${error.message}`);
      } finally {
        clearTimeout(timeoutId);
      }
    }

    getServerSuccessMsg = (success, text) => {
      if (!success) {
        return `
        <p class="server-status">${text}</p>
      `
      }
      return `
      <p class="server-status success">${text}</p>
    `
    }

    getTemplate() {
      // Show HTML Here
      return /*html*/`
      <div class="content-wrapper">
        <div class="overlay"></div>
        <section id="content" class="content">
          ${this.getBody()}
        </section>
      </div>
      ${this.getStyles()}
    `
    }

    getBody = () => {
      return /* html */`
      <form class="fields post" id="post-form">
        ${this.getPostTypes()}
        <div class="actions">
          <span class="action-info">Publishing</span>
          <div class="buttons">
            <span class="action cancel-btn">
              <span class="text">Cancel</span>
            </span>
            <button type="submit" class="action submit">
              <span class="text">Post</span>
            </button>
          </div>
        </div>
      </form>
    `;
    }

    getPostEditor = () => {
      return /* html */`
      <textarea name="editor" id="editor" cols="30" rows="10" placeholder="Type or paste your content hare!"></textarea>
      ${this.getImagesEditor()}
    `;
    }

    getPollEditor = () => {
      return /* html */`
      <div class="field polls" id="poll-inputs">
        <span class="title">Poll</span>
        <div class="poll-inputs texts">
          <textarea name="poll" id="poll" cols="30" rows="1" required placeholder="What's your poll question?"></textarea>
          <input type="text" name="option1" id="option1" placeholder="Option 1" required spellcheck="false">
          <input type="text" name="option2" id="option2" placeholder="Option 2" required spellcheck="false">
          <span class="add-option">Add option</span>
        </div>
        <div class="poll-inputs">
          <input type="number" name="poll-end" id="poll-end" placeholder="Poll ends in? e.g 7 (days)" max="7" min="1" required>
        </div>
        <div class="remove">
          <span class="remove-poll">Remove poll</span>
        </div>
      </div>
    `;
    }

    growTextarea = form => {
      const input = form.querySelector('textarea#poll');
      if (form && input) {
        input.focus();
        const adjustRows = () => {
          const maxRows = 7;
          const style = window.getComputedStyle(input);
          const lineHeight = parseInt(style.lineHeight, 10);
          
          // Calculate the height offset (padding + border)
          const paddingHeight = parseInt(style.paddingTop, 10) + parseInt(style.paddingBottom, 10);
          const borderHeight = parseInt(style.borderTopWidth, 10) + parseInt(style.borderBottomWidth, 10);
          const offset = paddingHeight + borderHeight;
    
          // Reset the rows to 1 to calculate the new height
          input.rows = 1;
    
          // Calculate the number of rows based on scrollHeight minus the offset
          const newRows = Math.ceil((input.scrollHeight - offset) / lineHeight);
          input.rows = Math.min(maxRows, Math.max(newRows, 1)); // Ensure at least 1 row
        };
    
        input.addEventListener('input', adjustRows);
        input.addEventListener('paste', adjustRows);
        
        // Initial adjustment on page load
        adjustRows();
      }
    }

    addPollOption = container => {
      const addOption = container.querySelector('span.add-option ');
      const removePoll = container.querySelector('div.remove > span.remove-poll');

      if(addOption && removePoll) {
        addOption.addEventListener('click', e => {
          e.preventDefault();
          const pollInputs = container.querySelector('.poll-inputs.texts');
          const options = pollInputs.querySelectorAll('input[type="text"]');
          options[options.length - 1];

          if (options.length >= 4) {
            return;
          }

          const newOption = document.createElement('input');
          newOption.type = 'text';
          newOption.name = `option${options.length + 1}`;
          newOption.id = `option${options.length + 1}`;
          newOption.placeholder = `Option ${options.length + 1}`;
          newOption.required = true;
          newOption.spellcheck = false;

          pollInputs.insertBefore(newOption, addOption);

          // if length is now 4, hide the add option button
          if (options.length === 3) {
            addOption.style.display = 'none';
          }
        });

        removePoll.addEventListener('click', e => {
          e.preventDefault();
          const pollInputs = container.querySelector('.poll-inputs');
          const options = pollInputs.querySelectorAll('input[type="text"]');
          const lastOption = options[options.length - 1];

          if (options.length <= 2) {
            return;
          }

          lastOption.remove();

          // if length is now 3, show the add option button
          if (options.length === 4) {
            addOption.style.display = 'flex';
          }
        });
      }
    }
    
    getPostTypes = () => {
      return /* html */`
      <div class="post-type">
        <div class="types">
          <div class="type post">
            <h4 class="title">Post</h4>
            <p class="desc">
              You can add a post with text, images, links, and more. A post can be a short story, a poem, a quote, or anything you want to share.
            </p>
          </div>
          <div class="type poll">
            <h4 class="title">Poll</h4>
            <p class="desc">You can add a question and options, a poll can have a maximum of 4 options and runs upto a maximum of 7 days, i.e 168 hours.
            </p>
          </div>
        </div>
      </div>
    `;
    }

    activatePollType = form => {
      // select post-type
      const postType = form.querySelector('.post-type');
      // select the post type: poll
      const pollType = form.querySelector('.post-type > .types > .type.poll');
      // select actions
      const actions = form.querySelector('.actions');

      if (pollType && actions && postType) {
        pollType.addEventListener('click', e => {
          e.preventDefault();

          // get pollEditor
          const pollEditor = this.getPollEditor();

          // Remove the post type
          postType.remove();

          // insert the poll editor
          form.insertAdjacentHTML('afterbegin', pollEditor);

          // activate the poll
          this.activatePoll(form);

          // add display flex to the actions
          actions.style.display = 'flex';

          // update the option
          this._option = 'Poll';
        });
      }
    }

    activatePostType = form => {
      // select post-type
      const postTypeMain = form.querySelector('.post-type');
      // select the post type: post
      const postType = form.querySelector('.post-type > .types > .type.post');
      // select actions
      const actions = form.querySelector('.actions');

      if (postType && actions && postTypeMain) {
        postType.addEventListener('click', e => {
          e.preventDefault();

          // get postEditor
          const postEditor = this.getPostEditor();

          // Remove the post type
          postTypeMain.remove();

          // insert the post editor
          form.insertAdjacentHTML('afterbegin', postEditor);

          // activate the editor
          this.initEditor();

          // add display flex to the actions
          actions.style.display = 'flex';

          // update the option
          this._option = 'Post';
        });
      }
    }

    getFinish = () => {
      return /* html */`
      <div class="finish">
        <h2 class="title">You're all set!</h2>
        <p class="desc">
          Your post has been created successfully. You can view it in the feeds or from your profile.
          To edit the post, go to settings then click on "your content".
        </p>
        <button class="finish">Close</button>
      </div>
    `;
    }

    activateFinish = finish => {
      const button = finish.querySelector('button.finish');
      if (button) {
        button.addEventListener('click', e => {
          e.preventDefault();
          this.remove();
        });
      }
    }

    removeFormAndTopDesc = section => {
      const form = section.querySelector('form');

      if (form) {
        form.remove();
      }

      // insert the finish message
      section.innerHTML = this.getFinish();

      const finish = this.querySelector('div.finish');

      // activate the finish button
      this.activateFinish(finish);
    }

    getImagesEditor = () => {
      return /* html */`
      <images-uploader api="/api/v1/i/upload" multiple="true" accept="image/*" max="5" images=''></images-uploader>
    `;
    }

    getButtonLoader() {
      return /*html*/`
      <span id="btn-loader">
				<span class="loader"></span>
			</span>
    `
    }

    getStyles() {
      return /* css */`
      <link rel="stylesheet" href="/static/css/ckeditor.css">
      <style>
        *,
        *:after,
        *:before {
          box-sizing: border-box !important;
          font-family: inherit;
          -webkit-box-sizing: border-box !important;
        }

        *:focus {
          outline: inherit !important;
        }

        *::-webkit-scrollbar {
          -webkit-appearance: none;
        }

        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
          padding: 0;
          margin: 0;
          font-family: inherit;
        }

        p,
        ul,
        ol {
          font-family: inherit;
        }

        a {
          text-decoration: none;
        }

        .content-wrapper {
          border: none;
          padding: 0;
          justify-self: end;
          display: flex;
          flex-flow: column;
          align-items: center;
          justify-content: center;
          gap: 10px;
          z-index: 100;
          width: 100%;
          min-width: 100vw;
          position: fixed;
          right: 0;
          top: 0;
          bottom: 0;
          left: 0;
        }

        div.overlay {
          position: absolute;
          top: 0;
          right: 0;
          bottom: 0;
          left: 0;
          height: 100%;
          width: 100%;
          background-color: var(--modal-background);
          backdrop-filter: blur(3px);
          -webkit-backdrop-filter: blur(3px);
        }

        #content {
          z-index: 1;
          background-color: var(--background);
          padding: 15px;
          display: flex;
          flex-flow: column;
          align-items: center;
          justify-content: start;
          gap: 10px;
          width: 700px;
          max-height: 95%;
          height: 90%;
          height: max-content;
          border-radius: 15px;
          position: relative;
          overflow-y: auto;
        }

        p.server-status {
          margin: 0;
          width: 100%;
          text-align: start;
          font-family: var(--font-read), sans-serif;
          color: var(--error-color);
          font-weight: 500;
          line-height: 1.4;
          font-size: 1.18rem;
        }

        p.server-status.success {
          color: transparent;
          background: var(--accent-linear);
          background-clip: text;
          -webkit-background-clip: text;
        }

        #btn-loader {
          position: absolute;
          top: 0;
          left: 0;
          bottom: 0;
          right: 0;
          z-index: 5;
          display: flex;
          align-items: center;
          justify-content: center;
          border-radius: inherit;
        }

        #btn-loader > .loader {
          width: 20px;
          aspect-ratio: 1;
          --_g: no-repeat radial-gradient(farthest-side, #18A565 94%, #0000);
          --_g1: no-repeat radial-gradient(farthest-side, #21D029 94%, #0000);
          --_g2: no-repeat radial-gradient(farthest-side, #df791a 94%, #0000);
          --_g3: no-repeat radial-gradient(farthest-side, #f09c4e 94%, #0000);
          background: var(--_g) 0 0,  var(--_g1) 100% 0, var(--_g2) 100% 100%, var(--_g3) 0 100%;
          background-size: 30% 30%;
          animation: l38 .9s infinite ease-in-out;
          -webkit-animation: l38 .9s infinite ease-in-out;
        }

        @keyframes l38 {
          100% {
            background-position: 100% 0, 100% 100%, 0 100%, 0 0
          }
        }

        h2.pop-title {
          width: 100%;
          font-size: 1.35rem;
          font-weight: 600;
          margin: 0;
          padding: 10px 10px;
          background-color: var(--gray-background);
          text-align: center;
          border-radius: 12px;
          font-family: var(--font-read), sans-serif;
          color: var(--text-color);
          font-weight: 500;
          position: relative;
        }

        h2.pop-title > span.control {
          padding: 0;
          cursor: pointer;
          display: flex;
          flex-flow: column;
          gap: 0px;
          justify-content: center;
          position: absolute;
          top: 50%;
          left: 10px;
          transform: translateY(-50%);
        }

        h2.pop-title > span.control svg {
          width: 21px;
          height: 21px;
          color: var(--text-color);
        }

        h2.pop-title > span.control svg:hover{
          color: var(--error-color);
        }

        .top {
          display: flex;
          flex-flow: column;
          gap: 5px;
          padding: 0;
          width: 100%;
        }

        .top > .desc {
          margin: 0;
          padding: 10px 0 20px;
          color: var(--text-color);
          font-size: 0.95rem;
          font-family: var(--font-main), sans-serif;
        }

        .top > .desc > span {
          display: inline-block;
          margin: 10px 0 5px;
          color: var(--gray-color);
          font-size: 0.85rem;
          font-style: italic;
          font-family: var(--font-read), sans-serif;
        }

        form.fields {
          margin: 0;
          padding: 0;
          width: 100%;
          min-width: 100%;
          height: auto;
          display: flex;
          flex-flow: column;
          justify-content: center;
          align-items: center;
          gap: 0;
        }

        form.fields images-uploader {
          width: 100%;
          min-width: 100%;
          display: flex;
          flex-flow: column;
        }

        div.post-type {
          width: 100%;
          display: flex;
          flex-flow: column;
          gap: 15px;
          padding: 10px 0;
        }

        div.post-type > h2.title {
          width: 100%;
          margin: 0;
          padding: 0;
          font-size: 1.25rem;
          text-align: center;
          font-weight: 500;
          font-family: var(--font-main), sans-serif;
          color: var(--text-color);
        }

        div.post-type > div.types {
          width: 100%;
          display: flex;
          flex-flow: row;
          gap: 20px;
        }

        div.post-type > div.types > div.type {
          width: 100%;
          display: flex;
          flex-flow: column;
          gap: 5px;
          padding: 10px;
          border-radius: 12px;
          background: var(--create-background);
          cursor: pointer;
        }

        div.post-type > div.types > div.type:hover {
          background: var(--background);
          border: var(--border);
        }

        div.post-type > div.types > div.type > h4.title {
          margin: 0;
          padding: 0;
          font-size: 1.1rem;
          font-weight: 500;
          font-family: var(--font-main), sans-serif;
          color: var(--text-color);
        }

        div.post-type > div.types > div.type > p.desc {
          margin: 0;
          padding: 5px 0;
          font-size: 0.85rem;
          font-family: var(--font-read), sans-serif;
          color: var(--gray-color);
        }

        form.fields > .field {
          width: 100%;
          display: flex;
          flex-flow: column;
          justify-content: center;
          align-items: start;
          gap: 0;
        }

        form.fields > .field.polls {
          padding: 10px 0 0 0;
        }

        form.fields > .field.polls > span.title {
          display: none;
          margin: 0;
          padding: 0 0 10px 3px;
          color: var(--text-color);
          font-size: 1rem;
          font-weight: 600;
          font-family: var(--font-main), sans-serif;
        }

        form.fields > .field.polls > .poll-inputs {
          width: 100%;
          display: flex;
          flex-flow: column;
          justify-content: center;
          align-items: start;
          gap: 15px;
        }

        form.fields > .field.polls > .poll-inputs.texts {
          margin: 0 0 18px;
        }

        form.fields > .field.polls > div.remove {
          width: 100%;
          display: flex;
          flex-flow: row;
          justify-content: end;
          align-items: center;
          gap: 0;
          padding: 8px 0 20px;
        }

        form.fields > .field.polls > div.remove > span.remove-poll {
          width: max-content;
          padding: 0 5px;
          display: flex;
          cursor: pointer;
          font-family: var(--font-read), sans-serif;
          font-size: 0.95rem;
          font-weight: 400;
          color: var(--gray-color);
        }

        form.fields > .field.polls > .poll-inputs > span.add-option {
          background: var(--gray-background);
          font-family: var(--font-main), sans-serif;
          font-size: 1rem;
          font-weight: 500;
          display: flex;
          justify-content: center;
          align-items: center;
          width: 100%;
          cursor: pointer;
          height: 40px;
          border-radius: 12px;
          color: var(--gray-color);
          -webkit-border-radius: 12px;
          -moz-border-radius: 12px;
          -ms-border-radius: 12px;
          -o-border-radius: 12px;
        }

        form.fields > .field.polls > .poll-inputs > span.add-option:hover {
          color: var(--accent-color);
        }

        form.fields .field input {
          border: var(--input-border);
          background: var(--background);
          font-family: var(--font-read), sans-serif;
          font-size: 0.95rem;
          width: 100%;
          height: 40px;
          outline: none;
          padding: 10px 12px;
          border-radius: 12px;
          color: var(--text-color);
          -webkit-border-radius: 12px;
          -moz-border-radius: 12px;
          -ms-border-radius: 12px;
          -o-border-radius: 12px;
        }

        form.fields .field input {
          border: none;
          display: inline-block;
          border: var(--border);
          font-family: var(--font-read), sans-serif;
          background-color: var(--background) !important;
          font-size: 1rem;
          width: 100%;
          min-width: 100%;
          height: 40px;
          outline: none;
          padding: 10px 12px;
          border-radius: 12px;
          color: var(--text-color);
        }
        
        form.fields .field input:-webkit-autofill,
        form.fields .field input:-webkit-autofill:hover, 
        form.fields .field input:-webkit-autofill:focus {
          -webkit-box-shadow: 0 0 0px 1000px var(--background) inset;
          -webkit-text-fill-color: var(--text-color) !important;
          transition: background-color 5000s ease-in-out 0s;
          color: var(--text-color) !important;
        }
        
        form.fields .field input:autofill {
          filter: none;
          color: var(--text-color) !important;
        }

        form.fields .field input:focus {
          border: var(--border);
        }

        form.fields textarea {
          border: none;
          font-family: var(--font-main), sans-serif;
          background: var(--background);
          font-size: 1rem;
          padding: 0 5px 7px;
          margin: 5px 0 0 0;
          width: 100%;
          resize: none;
          height: auto;
          line-height: 1.5;
          scroll-padding-top: 7px;
          scroll-padding-bottom: 7px;
          gap: 5px;
          font-weight: 400;
          color: var(--text-color);
          scrollbar-width: 3px;
          border-radius: 0;
        }

        form.fields textarea::-webkit-scrollbar {
          width: 3px;
          -webkit-appearance: auto;
        }

        form.fields textarea:focus {
          border: none;
        }

        form.fields .field span.wrapper {
          display: flex;
          align-items: center;
          align-items: center;
          gap: 0;
          width: 100%;
        }

        form.fields label.focused {
          top: -10px;
          font-size: 0.9rem;
          background-color: var(--label-focus-background);
          padding: 0 5px;
        }

        form.fields .field span.status {
          color: var(--error-color);
          font-size: 0.95rem;
          display: none;
          padding: 0 0 0 5px;
        }

        form.fields .field .input-group.failed span.status {
          color: var(--error-color);
          font-size: 0.8rem;
          display: inline-block;
        }

        form.fields .field .input-group.success span.status {
          color: var(--accent-color);
          font-size: 0.8rem;
          display: inline-block;
        }

        form.fields .field .input-group.success span.status {
          display: none;
        }

        form.fields .actions {
          border-top: var(--border);
          display: none;
          align-items: center;
          justify-content: space-between;
          width: 100%;
          height: max-content;
          gap: 20px;
          margin: 0;
          padding: 10px 0 0;
        }

        form.fields .actions.active {
          border-top: var(--input-border-focus);
        }

        form.fields .actions > span.action-info {
          color: var(--gray-color);
          font-size: 0.95rem;
          font-family: var(--font-read), sans-serif;
          font-weight: 400;
          line-height: 1.5;
        }

        form.fields .actions > .buttons {
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 20px;
          margin: 0;
        }

        form.fields .actions .action {
          background: var(--gray-background);
          color: var(--gray-color);
          border: none;
          font-family: var(--font-main), sans-serif;
          text-decoration: none;
          font-size: 1rem;
          font-weight: 600;
          cursor: pointer;
          display: flex;
          flex-flow: row;
          align-items: center;
          text-transform: capitalize;
          justify-content: center;
          padding: 7px 15px 8px;
          min-height: 35px;
          height: 35px;
          min-width: 60px;
          width: max-content;
          position: relative;
          border-radius: 50px;
          -webkit-border-radius: 50px;
          -moz-border-radius: 50px;
        }

        form.fields .actions .action.cancel-btn {
          background: var(--gray-background);
          color: var(--gray-color);
        }

        form.fields .actions.active .action.submit {
          border: none;
          background: var(--accent-linear);
          font-family: var(--font-main), sans-serif;
          text-decoration: none;
          color: var(--white-color);
        }

        form.fields .actions > .action.disabled {
          pointer-events: none;
        }

        div.finish {
          padding: 15px 0;
          width: 100%;
          min-width: 100%;
          height: auto;
          display: flex;
          flex-flow: column;
          justify-content: center;
          align-items: center;
          gap: 15px;
        }

        div.finish > h2.title {
          margin: 0;
          font-size: 1.25rem;
          font-weight: 600;
          font-family: var(--font-main), sans-serif;
          color: var(--text-color);
        }

        div.finish > p.desc {
          margin: 0;
          font-size: 0.95rem;
          font-family: var(--font-read), sans-serif;
          color: var(--text-color);
          line-height: 1.4;
          text-align: center;
        }

        div.finish > button.finish {
          border: none;
          background: var(--accent-linear);
          font-family: var(--font-main), sans-serif;
          text-decoration: none;
          color: var(--white-color);
          font-size: 1rem;
          font-weight: 600;
          cursor: pointer;
          display: flex;
          width: max-content;
          flex-flow: row;
          align-items: center;
          text-transform: capitalize;
          justify-content: center;
          padding: 7px 15px 8px;
          border-radius: 50px;
          -webkit-border-radius: 50px;
          -moz-border-radius: 50px;
        }

        #editor {
          min-width: 100%;
          width: 100%;
          overflow-y: auto;
          font-family: var(--font-text), sans-serif;
        }

        .ck.ck-editor__main > .ck-editor__editable {
          color: var(--editor-color);
        }

        .ck.ck-editor__main > .ck-editor__editable a {
          color: var(--anchor-color);
        }

        .ck-editor__editable_inline:not(.ck-comment__input *) {
          font-family: var(--font-text), sans-serif;
          overflow-y: auto;
        }

        .ck-editor__editable_inline {
          max-height: 350px;
        }

        .ck-body-wrapper {
          display: none;
          opacity: 0;
          visibility: hidden;
        }

        .ck.ck-reset.ck-editor {
          display: -webkit-box;
          display: -moz-box;
          display: -ms-flexbox;
          display: -webkit-flex;
          display: flex;
          -webkit-flex-direction: column;
          -moz-flex-direction: column;
          -ms-flex-direction: column;
          flex-direction: column;
        }

        .ck-focused, .ck.ck-editor__editable:not(.ck-editor__nested-editable).ck-focused {
          border: none;
          border: none;
          outline: none !important;
          -moz-outline: none !important;
          -webkit-outline: none !important;
          -ms-outline: none !important;
          -webkit-box-shadow: none;
          -moz-box-shadow: none;
          box-shadow: none
        }

        .ck.ck-editor__main h6,
        .ck.ck-editor__main h5,
        .ck.ck-editor__main h4,
        .ck.ck-editor__main h3,
        .ck.ck-editor__main h1 {
          padding: 0;
          color: var(--title-color);
          font-weight: 500;
          line-height: 1.5;
          margin: 10px 0;
          font-family: var(--font-main), sans-serif;
        }

        .ck.ck-editor__main h6 {
          font-size: initial;
        }

        .ck.ck-editor__main h5 {
          font-size: initial;
        }

        .ck.ck-editor__main h4 {
          font-size: 1.25rem;
        }

        .ck.ck-editor__main h3 {
          font-size: 1.3rem !important;;
        }

        .ck.ck-editor__main h2 {
          font-size: 1.35rem !important;
          color: var(--title-color);
          font-weight: 600;
          line-height: 1.2;
          margin: 0;
          padding: 2px 0 0 13px;
          margin: 20px 0 10px;
          position: relative;
        }

        .ck.ck-editor__main h2:before {
          content: "";
          position: absolute;
          bottom: 10%;
          left: 0;
          width: 2px;
          height: 80%;
          background: var(--action-linear);
          border-radius: 5px;
        }

        .ck.ck-editor__main p {
          margin: 5px 0;
          line-height: 1.4;
        }

        .ck.ck-editor__main a {
          text-decoration: none;
          cursor: pointer;
          color: var(--anchor-color) !important;
        }

        .ck.ck-editor__main a:hover {
          text-decoration: underline;
        }

        .ck.ck-editor__main blockquote {
          margin: 10px 0;
          padding: 5px 15px;
          font-style: italic;
          border-left: 2px solid var(--gray-color);
          background: var(--background);
          color: var(--text-color);
          font-weight: 400;
        }

        .ck.ck-editor__main blockquote:before {
          content: open-quote;
          color: var(--gray-color);
          font-size: 1.5rem;
          line-height: 1;
          margin: 0 0 0 -5px;
        }

        .ck.ck-editor__main blockquote:after {
          content: close-quote;
          color: var(--gray-color);
          font-size: 1.5rem;
          line-height: 1;
          margin: 0 0 0 -5px;
        }

        .ck.ck-editor__main hr {
          border: none;
          background-color: var(--gray-color);
          height: 1px;
          margin: 10px 0;
        }

        .ck.ck-editor__main ul,
        .ck.ck-editor__main ol {
          margin: 5px 0 15px 20px;
          padding: 0 0 0 15px;
          color: inherit;
        }

        .ck.ck-editor__main ul li,
        .ck.ck-editor__main ol li {
          padding: 5px 0;
        }

        .ck.ck-editor__main code {
          background: var(--gray-background);
          padding: 0 5px;
          font-family: var(--font-mono);
          font-size: 0.9rem;
          border-radius: 5px;
        }

        .ck.ck-editor__main img {
          max-width: 100%;
          height: auto;
          object-fit: contain;
          border-radius: 5px;
        }

        figure {
          max-width: 100% !important;
          height: auto;
          width: max-content;
          padding: 0;
          max-width: 100%;
          display: block;
          margin-block-start: 5px;
          margin-block-end: 5px;
          margin-inline-start: 0 !important;
          margin-inline-end: 0 !important;
        }

        @media screen and (max-width:600px) {
          .content-wrapper {
            border: none;
            background-color: var(--modal-background);
            padding: 0px;
            justify-self: end;
            display: flex;
            flex-flow: column;
            align-items: center;
            justify-content: end;
            gap: 10px;
            z-index: 20;
            position: fixed;
            right: 0;
            top: 0;
            bottom: 0;
            left: 0;
            min-width: 100dvw;
            min-height: 100dvh;
          }

          #content {
            box-sizing: border-box !important;
            padding: 5px 10px 10px;
            margin: 0;
            position: fixed;
            right: 0;
            left: 0;
            bottom: 0;
            width: 100%;
            max-width: 100%;
            height: max-content;
            border-radius: 0;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
            overflow-y: auto;
          }

          #content span.control {
            cursor: default !important;
          }

          ::-webkit-scrollbar {
            -webkit-appearance: none;
          }

          h2.pop-title {
            width: 100%;
            font-size: 1.2rem;
            padding: 10px 10px;
            background-color: var(--gray-background);
            text-align: center;
            border-radius: 12px;
          }

          .top > .desc {
            margin: 0;
            padding: 6px 0 10px;
            font-size: 0.95rem;
            line-height: 1.5;
            font-family: var(--font-main), sans-serif;
          }

          div.finish {
            padding: 25px 0;
            width: 100%;
            min-width: 100%;
            height: auto;
            display: flex;
            flex-flow: column;
            justify-content: center;
            align-items: center;
            gap: 18px;
          }

          div.post-type > div.types {
            width: 100%;
            display: flex;
            flex-flow: column;

            gap: 20px;
          }

          form.fields .actions {
            align-items: center;
            width: 100%;
            gap: 25px;
          }

          div.finish > button.finish {
            margin: 10px 0 0;
          }

          form.fields > .field.polls > div.remove > span.remove-poll,
          form.fields > .field.polls > .poll-inputs > span.add-option,
          div.post-type > div.types > div.type,
          div.finish > button.finish,
          form.fields .actions .action,
          div.finish > button.finish {
            cursor: default !important;
          }

          .ck-editor__editable_inline:not(.ck-comment__input *) {
            overflow-y: auto;
          }

          .ck-editor__editable_inline {
            max-height: 300px;
          }
        }
      </style>
    `;
    }
  }

  class CustomUploadAdapter {
    constructor(loader) {
      this.loader = loader;
    }

    upload() {
      return this.loader.file
        .then(file => new Promise((resolve, reject) => {
          this._initRequest();
          this._initListeners(resolve, reject, file);
          this._sendRequest(file);
        }));
    }

    abort() {
      if (this.xhr) {
        this.xhr.abort();
      }
    }

    _initRequest() {
      const xhr = this.xhr = new XMLHttpRequest();
      xhr.open('POST', '/api/v1/i/upload', true);
      xhr.responseType = 'json';
    }

    _initListeners(resolve, reject, file) {
      const xhr = this.xhr;
      const loader = this.loader;
      const genericErrorText = `Couldn't upload file: ${file.name}.`;

      xhr.addEventListener('error', () => reject(genericErrorText));
      xhr.addEventListener('abort', () => reject());
      xhr.addEventListener('load', () => {
        const response = xhr.response;
        if (!response || response.success === false) {
          return reject(response && response.error ? response.error : genericErrorText);
        }
        resolve({ default: response.url });
      });

      if (xhr.upload) {
        xhr.upload.addEventListener('progress', evt => {
          if (evt.lengthComputable) {
            loader.uploadTotal = evt.total;
            loader.uploaded = evt.loaded;
          }
        });
      }
    }

    _sendRequest(file) {
      const data = new FormData();
      data.append('file', file);  // Changed 'upload' to 'file'
      this.xhr.send(data);
    }
  }

  class CustomUploadAdapterPlugin extends Ga {
    static get pluginName() {
      return 'CustomUploadAdapter';
    }

    init() {
      this.editor.plugins.get('FileRepository').createUploadAdapter = (loader) => {
        return new CustomUploadAdapter(loader);
      };
    }
  }

  const editorConfig$2 = {
  	toolbar: {
  		items: [
        'heading',
  			'bold',
  			'underline',
        'italic',
        'link',
        'insertImage',
  			'|',
  			'bulletedList',
  			'numberedList',
  			'blockQuote',
        'strikethrough',
  			'code',
  		],
  		shouldNotGroupWhenFull: false
  	},
    heading: {
  		options: [
  				{
  					model: 'paragraph',
  					title: 'Paragraph',
  					class: 'ck-heading_paragraph',
  				},
  				{
  					model: 'heading2',
  					view: 'h2',
  					title: 'Heading 2',
  					class: 'ck-heading_heading2',
  				},
  				{
  					model: 'heading3',
  					view: 'h3',
  					title: 'Heading 3',
  					class: 'ck-heading_heading3',
  				},
  				{
  					model: 'heading4',
  					view: 'h4',
  					title: 'Heading 4',
  					class: 'ck-heading_heading4',
  				},
  			],
  	},
  	plugins: [
  		gv,
  		tI,
  		pv,
  		h_,
  		py,
  		Cv,
  		Sv,
  		vx,
      Vg,
      TA,
  		GA,
      pT,
      mT,
      yT,
      fT,
      DT,
      NT,
      eS,
      mS,
      eT,
      gS,
      MT,
  		Bv,
  		nI,
  		tP,
  		AP,
  		_A,
  		Nv,
  		Xv,
  		_x,
      CustomUploadAdapterPlugin
  	],
  	fontFamily: {
  		supportAllValues: true
  	},
  	list: {
  		properties: {
  			styles: true,
  			startIndex: true,
  			reversed: true
  		}
  	},
    image: {
      toolbar: [
        'imageStyle:inline',
        'imageStyle:block',
        'imageStyle:wrapText',
  			'imageStyle:breakText',
        '|',
        'toggleImageCaption',
        'imageTextAlternative',
        'resizeImage'
      ],
    },
  	placeholder: 'Type your article content here!',
  	style: {
  		definitions: [
  			{
  				name: 'Article category',
  				element: 'h3',
  				classes: ['category']
  			},
  			{
  				name: 'Title',
  				element: 'h2',
  				classes: ['document-title']
  			},
  			{
  				name: 'Subtitle',
  				element: 'h3',
  				classes: ['document-subtitle']
  			},
  			{
  				name: 'Info box',
  				element: 'p',
  				classes: ['info-box']
  			},
  			{
  				name: 'Side quote',
  				element: 'blockquote',
  				classes: ['side-quote']
  			},
  			{
  				name: 'Marker',
  				element: 'span',
  				classes: ['marker']
  			},
  			{
  				name: 'Spoiler',
  				element: 'span',
  				classes: ['spoiler']
  			},
  			{
  				name: 'Code (dark)',
  				element: 'pre',
  				classes: ['fancy-code', 'fancy-code-dark']
  			},
  			{
  				name: 'Code (bright)',
  				element: 'pre',
  				classes: ['fancy-code', 'fancy-code-bright']
  			}
  		]
  	},
  	table: {
  		contentToolbar: ['tableColumn', 'tableRow', 'mergeTableCells', 'tableProperties', 'tableCellProperties']
  	},
  };

  class CreateArticle extends HTMLDivElement {
    constructor() {
      // We are not even going to touch this.
      super();

      this._title = null;
      this.slug = null;
      this.content = null;
      this.editor = null;

      this.step = 1;

      // let's create our shadow root
      // this.shadowObj = this.attachShadow({ mode: "open" });

      this._url = this.getAttribute('api');

      this.render();
    }

    render() {
      // this.shadowObj.innerHTML = this.getTemplate();
      this.innerHTML = this.getTemplate();
    }

    connectedCallback() {
      // select the form
      const form = this.querySelector('form');

      // select the section
      const section = this.querySelector('section#content');

      if (form && section) {
        // add event listener to the form
        this.submitForm(form, section);

        // validate the slug
        this.validateForm(form);
      }

      const btns = this.querySelectorAll('.cancel-btn');
      const overlay = this.querySelector('.overlay');

      // Close the modal
      if (overlay && btns) {
        this.closePopup(overlay, btns);
      }

      this.disableScroll();
    }

    initEditor() {
      const actions = this.querySelector('.actions');
      jC.create(this.querySelector('textarea#editor'), editorConfig$2)
      .then(editor => {
        this.editor = editor;

        if(actions) {
          // add active to actions
          actions.classList.add('active');
          // add pointer events to submit button
          actions.querySelector('.action.submit').style.pointerEvents = 'auto';
        }
      })
      .catch(error => {
        console.log('Failed to initialize the editor. Error: ', error);
      });
    }

    disconnectedCallback() {
      this.enableScroll();
    }

    closePopup = (overlay, btns) => {
      overlay.addEventListener('click', e => {
        e.preventDefault();
        this.remove();
      });

      btns.forEach(btn => {
        btn.addEventListener('click', e => {
          e.preventDefault();
          this.remove();
        });
      });
    }

    disableScroll() {
      // Get the current page scroll position
      let scrollTop = window.scrollY || document.documentElement.scrollTop;
      let scrollLeft = window.scrollX || document.documentElement.scrollLeft;
      document.body.classList.add("stop-scrolling");

      // if any scroll is attempted, set this to the previous value
      window.onscroll = function () {
        window.scrollTo(scrollLeft, scrollTop);
      };
    }

    enableScroll() {
      document.body.classList.remove("stop-scrolling");
      window.onscroll = function () { };
    }

    submitForm = async (form, section) => {
      const outerThis = this;
      // add submit event listener
      form.addEventListener('submit', async e => {
        e.preventDefault();

        const serverStatus = form.querySelector('.server-status');

        // if server status is already showing, remove it
        if (serverStatus) {
          serverStatus.remove();
        }

        const button = form.querySelector('.action.submit');
        const actions = form.querySelector('.actions');

        // show loader inside the button
        button.innerHTML = this.getButtonLoader();
        // disable pointer events
        button.style.pointerEvents = 'none';

        if (this.step === 1) {
          // validate the form
          const isValid = this.validateStepOne(form, actions);

          if (!isValid) {
            return;
          } else {
            this.checkIfStoryExists(form, button, actions);
            return;
          }
        }

        // get the editor data
        const data = this.editor.getData();

        // validate the editor data
        if (!this.validateStepTwo(form, data, actions)) return;

        // send data to server
        const options = {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            kind: 'story',
            published: true,
            slug: this.slug,
            title: this._title,
            content: this.content
          })
        };

        try {
          const url = '/api/v1/s/add';
          const response = await outerThis.fetchWithTimeout(url, options);
          const result = await response.json();

          // check if request was successful
          if (result.success) {
            // activate the finish step
            section.innerHTML = this.getFinish();
            this.activateFinish();
          } else {
            // show error message
            actions.insertAdjacentHTML('beforebegin', outerThis.getServerSuccessMsg(false, result.message));

            // reset button
            button.innerHTML = '<span class="text">Post</span>';
            // enable pointer events
            button.style.pointerEvents = 'auto';
          }
        }
        catch (error) {
          console.error(error);
          // show error message
          actions.insertAdjacentHTML('beforebegin', outerThis.getServerSuccessMsg(false, 'An error occurred, please try again'));

          // reset button
          button.innerHTML = '<span class="text">Post</span>';
          // enable pointer events
          button.style.pointerEvents = 'auto';
        }

        // remove success message
        setTimeout(() => {
          const serverStatus = form.querySelector('.server-status');
          if (serverStatus) {
            serverStatus.remove();
          }
        }, 5000);
      });
    }

    checkIfStoryExists = async (form, button, actions) => {
      const url  = '/api/v1/s/check';
      const options = {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          slug: this.slug
        })
      };

      try {
        const response = await this.fetchWithTimeout(url, options);
        const result = await response.json();

        if (result.success) {
          // activate the next step
          // replace the current fields with the editor
          form.querySelector('.fields-container').innerHTML = this.getSummaryEditor();
          this.initEditor();

          // restore button
          button.innerHTML = '<span class="text">Post</span>';
          // enable pointer events
          button.style.pointerEvents = 'auto';
          this.step = 2;
        } else {
          // show error message
          actions.insertAdjacentHTML('beforebegin', this.getServerSuccessMsg(false, result.message));

          // restore button
          button.innerHTML = '<span class="text">Next</span>';
          // enable pointer events
          button.style.pointerEvents = 'auto';

          // remove success message
          setTimeout(() => {
            const serverStatus = form.querySelector('.server-status');
            if (serverStatus) {
              serverStatus.remove();
            }
          }, 5000);
        }
      }
      catch (error) {
        console.error(error);
        // show error message
        actions.insertAdjacentHTML('beforebegin', this.getServerSuccessMsg(false, 'An error occurred, please try again'));

        // restore button
        button.innerHTML = '<span class="text">Next</span>';
        // enable pointer events
        button.style.pointerEvents = 'auto';

        // remove success message
        setTimeout(() => {
          const serverStatus = form.querySelector('.server-status');
          if (serverStatus) {
            serverStatus.remove();
          }
        }, 5000);
      }
    }

    validateStepOne = (form, actions) => {
      const outerThis = this;
      // get and validate form data
      const formData = new FormData(form);

      // get form data
      const data = {
        slug: formData.get('slug'),
        title: formData.get('title'),
      };

      // check if form data is valid
      if (!data.slug) {
        
        const errorMsg = 'slug must be defined!';

        // show error message
        actions.insertAdjacentHTML('beforebegin', outerThis.getServerSuccessMsg(false, errorMsg));
        setTimeout(() => {
          const serverStatus = form.querySelector('.server-status');
          if (serverStatus) {
            serverStatus.remove();
          }
        }, 5000);

        return false;
      }

      // validate slug
      if (data.slug.length < 3) {
        // show error message
        actions.insertAdjacentHTML('beforebegin', outerThis.getServerSuccessMsg(false, 'slug must be at least 3 characters'));

        setTimeout(() => {
          const serverStatus = form.querySelector('.server-status');
          if (serverStatus) {
            serverStatus.remove();
          }
        }, 5000);

        return false;
      }

      // validate slug: only letters, numbers, and hyphens and lower case
      if(!/^[a-z0-9-]*$/.test(data.slug)) {
        // show error message
        actions.insertAdjacentHTML('beforebegin', outerThis.getServerSuccessMsg(false, 'slug can only contain letters, numbers, and hyphens and lowercase'));

        setTimeout(() => {
          const serverStatus = form.querySelector('.server-status');
          if (serverStatus) {
            serverStatus.remove();
          }
        }, 5000);

        return false;
      }

      // validate title and not less than 2 characters
      if (!data.title || data.title.length < 2) {
        // show error message
        actions.insertAdjacentHTML('beforebegin', outerThis.getServerSuccessMsg(false, 'title must be at least 2 characters'));

        setTimeout(() => {
          const serverStatus = form.querySelector('.server-status');
          if (serverStatus) {
            serverStatus.remove();
          }
        }, 5000);

        return false;
      }

      // set the data
      this._title = data.title;
      this.slug = data.slug;

      return true;
    }

    slugifyInput = input => {
      return input.replace(/\s+/g, '-')
        .replace(/[^a-z0-9-]/gi, '')
        .replace(/-{2,}/g, '-')
        .toLowerCase();
    }

    validateStepTwo = (form, summary, actions) => {
      // check if post summary is valid
      if (!summary) {
        // show error message
        actions.insertAdjacentHTML('beforebegin', this.getServerSuccessMsg(false, 'Post content must be defined!'));

        setTimeout(() => {
          const serverStatus = form.querySelector('.server-status');
          if (serverStatus) {
            serverStatus.remove();
          }
        }, 5000);

        return false;
      }

      // clone the data
      let content = summary;

      // validate post content: count length without html tags
      content = content.replace(/<[^>]*>?/gm, '');

      if (content.length < 3) {
        // show error message
        actions.insertAdjacentHTML('beforebegin', this.getServerSuccessMsg(false, 'Post content must be at least 3 characters'));

        setTimeout(() => {
          const serverStatus = form.querySelector('.server-status');
          if (serverStatus) {
            serverStatus.remove();
          }
        }, 5000);

        return false;
      }

      // set the data
      this.content = this.cleanWysiwygText(summary);
        
      return true;
    }

    cleanWysiwygText(input) {
      let cleanedText = input;

      // Step 1: Remove whitespace between tags
      cleanedText = cleanedText.replace(/>\s+</g, '><');

      // Step 2: Remove empty tags and tags with only &nbsp; or whitespace
      cleanedText = cleanedText.replace(/<(\w+)>(\s|&nbsp;)*<\/\1>/g, '');

      // Step 3: Remove <br> tags immediately after opening tags
      cleanedText = cleanedText.replace(/<(\w+)><br>/g, '<$1>');

      // Additional step: Remove <br> tags immediately before closing tags
      cleanedText = cleanedText.replace(/<br><\/(\w+)>/g, '</$1>');

      // Preserve <br> tags in the middle of content
      cleanedText = cleanedText.replace(/>(\s*<br>\s*)+</g, '><br><');

      return cleanedText;
    }

    fetchWithTimeout = async (url, options = {}, timeout = 9500) => {
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), timeout);
    
      try {
        const response = await fetch(url, {
          ...options,
          signal: controller.signal
        });

        return response;
      } catch (error) {
        if (error.name === 'AbortError') {
          throw new Error('Request timed out');
        }
        throw new Error(`Network error: ${error.message}`);
      } finally {
        clearTimeout(timeoutId);
      }
    };

    getServerSuccessMsg = (success, text) => {
      if (!success) {
        return `
        <p class="server-status">${text}</p>
      `
      }
      return `
      <p class="server-status success">${text}</p>
    `
    }

    getTemplate() {
      // Show HTML Here
      return /*html*/`
      <div class="content-wrapper">
        <div class="overlay"></div>
        <section id="content" class="content">
          ${this.getBody()}
        </section>
      </div>
    ${this.getStyles()}`
    }

    getBody = () => {
      return /* html */`
      <form class="fields" id="topic-form">
        <div class="fields-container">
          ${this.getFields()}
        </div>
        <div class="actions active">
          <span class="action-info">Publishing</span>
          <div class="buttons">
            <span class="action cancel-btn">
              <span class="text">Cancel</span>
            </span>
            <button type="submit" class="action submit">
              <span class="text">Next</span>
            </button>
          </div>
        </div>
      </form>
    `;
    }

    getFields = () => {
      return /* html */`
      <div class="field">
        <label for="title">Title</label>
        <input type="text" name="title" id="title" placeholder="Enter the title of the article" required />
        <span class="status"></span>
      </div>
      <div class="field">
        <label for="slug">Slug</label>
        <input type="text" name="slug" id="slug" placeholder="Enter a unique slug for the article" required />
        <span class="status"></span>
      </div>
    `;
    }

    getSummaryEditor = () => {
      return /* html */`
      <textarea name="editor" id="editor" cols="30" rows="10" placeholder="Type your article content here!"></textarea>
    `;
    }

    getFinish = () => {
      return /* html */`
      <div class="finish">
        <h2 class="title">Article Created!</h2>
        <p class="desc">
          Your article has been successfully created. You can now view it on the platform feeds and in your profile.
          To edit the article, go to settings and click on my content.
        </p>
        <button class="finish">Close</button>
      </div>
    `;
    }

    activateFinish = () => {
      const button = this.querySelector('section#content button.finish');
      if (button) {
        button.addEventListener('click', e => {
          e.preventDefault();
          
          // close the modal
          this.remove();
        });
      }
    }

    validateForm = form => {
      const input = form.querySelector('input[name="slug"]');
      const title = form.querySelector('input[name="title"]');

      if (input && title) {
        // add an input event listener
        input.addEventListener('input', e => {
          let value = e.target.value;

          if (!value) {
            input.parentElement.classList.remove('success');
            input.parentElement.classList.add('failed');
            input.parentElement.querySelector('span.status').textContent = 'slug is required';
            return;
          }
          // slugify the input
          const slug = this.slugifyInput(value);
          input.value = slug;
          value = slug;

          if (value.length < 3) {
            input.parentElement.classList.remove('success');
            input.parentElement.classList.add('failed');
            input.parentElement.querySelector('span.status').textContent = 'slug must be at least 3 characters';
            return;
          }

          if(!/^[a-z0-9-]*$/.test(value)) {
            input.parentElement.classList.remove('success');
            input.parentElement.classList.add('failed');
            input.parentElement.querySelector('span.status').textContent = 'slug can only contain letters, numbers, and hyphens and be in lowercase';
            return;
          }

          input.parentElement.classList.remove('failed');
          input.parentElement.classList.add('success');
          input.parentElement.querySelector('span.status').textContent = '';
        });

        // add an input event listener to title
        title.addEventListener('input', e => {
          const value = e.target.value;

          if (!value) {
            title.parentElement.classList.remove('success');
            title.parentElement.classList.add('failed');
            title.parentElement.querySelector('span.status').textContent = 'title is required';
            return;
          }

          // check for length
          if (value.length < 2) {
            title.parentElement.classList.remove('success');
            title.parentElement.classList.add('failed');
            title.parentElement.querySelector('span.status').textContent = 'title must be at least 2 characters';
            return;
          }

          title.parentElement.classList.remove('failed');
          title.parentElement.classList.add('success');
          title.parentElement.querySelector('span.status').textContent = '';
        });
      }
    }

    getButtonLoader() {
      return /*html*/`
      <span id="btn-loader">
				<span class="loader"></span>
			</span>
    `
    }

    getStyles() {
      return /* css */`
      <link rel="stylesheet" href="/static/css/ckeditor.css">
      <style>
        *,
        *:after,
        *:before {
          box-sizing: border-box !important;
          font-family: inherit;
          -webkit-box-sizing: border-box !important;
        }

        *:focus {
          outline: inherit !important;
        }

        *::-webkit-scrollbar {
          -webkit-appearance: none;
        }

        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
          padding: 0;
          margin: 0;
          font-family: inherit;
        }

        p,
        ul,
        ol {
          padding: 0;
          margin: 0;
        }

        a {
          text-decoration: none;
        }

        .content-wrapper {
          border: none;
          padding: 0;
          justify-self: end;
          display: flex;
          flex-flow: column;
          align-items: center;
          justify-content: center;
          gap: 10px;
          z-index: 100;
          width: 100%;
          min-width: 100vw;
          position: fixed;
          right: 0;
          top: 0;
          bottom: 0;
          left: 0;
        }

        div.overlay {
          position: absolute;
          top: 0;
          right: 0;
          bottom: 0;
          left: 0;
          height: 100%;
          width: 100%;
          background-color: var(--modal-background);
          backdrop-filter: blur(3px);
          -webkit-backdrop-filter: blur(3px);
        }

        #content {
          z-index: 1;
          background-color: var(--background);
          padding: 10px 10px;
          display: flex;
          flex-flow: column;
          align-items: center;
          justify-content: start;
          gap: 15px;
          width: 900px;
          max-width: 90%;
          max-height: 90%;
          height: max-content;
          border-radius: 15px;
          position: relative;
          scrollbar-width: none;
        }

        #content::-webkit-scrollbar {
          visibility: hidden;
          display: none;
        }

        p.server-status {
          margin: 0;
          width: 100%;
          text-align: start;
          font-family: var(--font-read), sans-serif;
          color: var(--error-color);
          font-weight: 500;
          line-height: 1.4;
          font-size: 1.18rem;
        }

        p.server-status.success {
          color: transparent;
          background: var(--accent-linear);
          background-clip: text;
          -webkit-background-clip: text;
        }

        #btn-loader {
          position: absolute;
          top: 0;
          left: 0;
          bottom: 0;
          right: 0;
          z-index: 5;
          display: flex;
          align-items: center;
          justify-content: center;
          border-radius: inherit;
        }

        #btn-loader > .loader {
          width: 20px;
          aspect-ratio: 1;
          --_g: no-repeat radial-gradient(farthest-side, #18A565 94%, #0000);
          --_g1: no-repeat radial-gradient(farthest-side, #21D029 94%, #0000);
          --_g2: no-repeat radial-gradient(farthest-side, #df791a 94%, #0000);
          --_g3: no-repeat radial-gradient(farthest-side, #f09c4e 94%, #0000);
          background:    var(--_g) 0 0,    var(--_g1) 100% 0,    var(--_g2) 100% 100%,    var(--_g3) 0 100%;
          background-size: 30% 30%;
          animation: l38 .9s infinite ease-in-out;
          -webkit-animation: l38 .9s infinite ease-in-out;
        }

        @keyframes l38 {
          100% {
            background-position: 100% 0, 100% 100%, 0 100%, 0 0
          }
        }

        h2.pop-title {
          width: 100%;
          font-size: 1.35rem;
          font-weight: 600;
          margin: 0;
          padding: 10px 10px;
          background-color: var(--gray-background);
          text-align: center;
          border-radius: 12px;
          font-family: var(--font-read), sans-serif;
          color: var(--text-color);
          font-weight: 500;
          position: relative;
        }

        h2.pop-title > span.control {
          padding: 0;
          cursor: pointer;
          display: flex;
          flex-flow: column;
          gap: 0px;
          justify-content: center;
          position: absolute;
          top: 50%;
          left: 10px;
          transform: translateY(-50%);
        }

        h2.pop-title > span.control svg {
          width: 21px;
          height: 21px;
          color: var(--text-color);
        }

        h2.pop-title > span.control svg:hover{
          color: var(--error-color);
        }

        .top {
          display: flex;
          flex-flow: column;
          gap: 5px;
          padding: 0;
          width: 100%;
        }

        .top > .desc {
          margin: 0;
          padding: 10px 0 20px;
          color: var(--text-color);
          font-size: 0.95rem;
          font-family: var(--font-main), sans-serif;
        }

        .top > .desc > span {
          display: inline-block;
          margin: 10px 0 5px;
          color: var(--gray-color);
          font-size: 0.85rem;
          font-style: italic;
          font-family: var(--font-read), sans-serif;
        }

        form.fields {
          margin: 0;
          width: 100%;
          display: flex;
          flex-flow: column;
          justify-content: center;
          align-items: center;
          gap: 5px;
        }

        form.fields > .fields-container {
          width: 100%;
          display: flex;
          flex-flow: column;
          justify-content: center;
          align-items: start;
          gap: 0;
        }

        form.fields > .fields-container > .field {
          width: 100%;
          display: flex;
          flex-flow: column;
          justify-content: center;
          align-items: start;
          gap: 5px;
        }

        form.fields label {
          color: var(--label-color);
          margin: 10px 0 0 0;
          font-size: 1.1rem;
          font-family: var(--font-read), sans-serif;
          transition: all 0.3s ease-in-out;
          pointer-events: none;
        }

        form.fields .field input {
          border: var(--input-border);
          border: none;
          transition: border-color 0.3s ease-in-out;
          background: var(--background);
          font-family: var(--font-read), sans-serif;
          font-size: 1rem;
          width: 100%;
          height: 40px;
          outline: none;
          padding: 10px 12px;
          border-radius: 12px;
          color: var(--text-color);
          -webkit-border-radius: 12px;
          -moz-border-radius: 12px;
          -ms-border-radius: 12px;
          -o-border-radius: 12px;
        }

        form.fields .field input {
          border: none;
          border: var(--border);
          font-family: var(--font-read), sans-serif;
          background-color: var(--background) !important;
          font-size: 1rem;
          width: 100%;
          height: 40px;
          outline: none;
          padding: 10px 12px;
          margin: 0 0 10px;
          border-radius: 12px;
          color: var(--text-color);
        }
        
        form.fields .field input:-webkit-autofill,
        form.fields .field input:-webkit-autofill:hover, 
        form.fields .field input:-webkit-autofill:focus {
          -webkit-box-shadow: 0 0 0px 1000px var(--background) inset;
          -webkit-text-fill-color: var(--text-color) !important;
          transition: background-color 5000s ease-in-out 0s;
          color: var(--text-color) !important;
        }
        
        form.fields .field input:autofill {
          filter: none;
          color: var(--text-color) !important;
        }

        form.fields .field input:focus {
          border: var(--input-border-focus);
        }

        form.fields textarea {
          border: none;
          border: var(--border);
          font-family: var(--font-read), sans-serif;
          background: var(--background);
          font-size: 1rem;
          padding: 10px 12px;
          margin: 0;
          width: 100%;
          resize: none;
          height: 120px;
          gap: 5px;
          font-weight: 400;
          color: var(--text-color);
          -ms-overflow-style: none;
          scrollbar-width: none;
          border-radius: 12px;
        }

        form.fields textarea::-webkit-scrollbar {
          display: none !important;
          visibility: hidden;
        }

        form.fields textarea:focus {
          border: var(--input-border-focus);
        }

        form.fields .field span.wrapper {
          display: flex;
          align-items: center;
          align-items: center;
          gap: 0;
          width: 100%;
        }

        form.fields .field.success > span.wrapper > input,
        form.fields .field.success > span.wrapper > input:focus,
        form.fields .field.success input,
        form.fields .field.success input:focus {
          border: var(--input-border-focus);
        }

        form.fields .field.failed > span.wrapper > input,
        form.fields .field.failed > span.wrapper > input:focus,
        form.fields .field.failed input,
        form.fields .field.failed input:focus {
          border: var(--input-border-error);
        }

        form.fields .field.success span.wrapper > input,
        form.fields .field.success input {
          color: var(--accent-color);
        }

        form.fields .field.failed span.wrapper > input,
        form.fields .field.failed input {
          color: var(--error-color);
        }

        form.fields label.focused {
          top: -10px;
          font-size: 0.9rem;
          background-color: var(--label-focus-background);
          padding: 0 5px;
        }

        form.fields .field span.status {
          color: var(--error-color);
          font-size: 0.95rem;
          display: none;
          padding: 0 0 0 5px;
        }

        form.fields .field.failed span.status {
          color: var(--error-color);
          font-size: 0.8rem;
          display: inline-block;
        }

        form.fields .field.success span.status {
          color: var(--accent-color);
          font-size: 0.8rem;
          display: inline-block;
        }

        form.fields .field.success span.status {
          display: none;
        }

        form.fields .actions {
          border-top: var(--border);
          display: flex;
          align-items: center;
          justify-content: space-between;
          width: 100%;
          height: max-content;
          gap: 20px;
          margin: 0;
          padding: 10px 0 0;
        }

        form.fields .actions.active {
          border-top: var(--input-border-focus);
        }

        form.fields .actions > span.action-info {
          color: var(--gray-color);
          font-size: 0.95rem;
          font-family: var(--font-read), sans-serif;
          font-weight: 400;
          line-height: 1.5;
        }

        form.fields .actions > .buttons {
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 20px;
          margin: 0;
        }

        form.fields .actions .action {
          background: var(--gray-background);
          color: var(--gray-color);
          border: none;
          font-family: var(--font-main), sans-serif;
          text-decoration: none;
          font-size: 1rem;
          font-weight: 600;
          cursor: pointer;
          display: flex;
          flex-flow: row;
          align-items: center;
          text-transform: capitalize;
          justify-content: center;
          padding: 7px 15px 8px;
          min-height: 35px;
          height: 35px;
          min-width: 60px;
          width: max-content;
          position: relative;
          border-radius: 50px;
          -webkit-border-radius: 50px;
          -moz-border-radius: 50px;
        }

        form.fields .actions .action.cancel-btn {
          background: var(--gray-background);
          color: var(--gray-color);
        }

        form.fields .actions.active .action.submit {
          border: none;
          background: var(--accent-linear);
          font-family: var(--font-main), sans-serif;
          text-decoration: none;
          color: var(--white-color);
        }

        form.fields .actions > .action.disabled {
          pointer-events: none;
        }

        div.finish {
          padding: 15px 0;
          width: 100%;
          min-width: 100%;
          height: auto;
          display: flex;
          flex-flow: column;
          justify-content: center;
          align-items: center;
          gap: 15px;
        }

        div.finish > h2.title {
          margin: 0;
          font-size: 1.25rem;
          font-weight: 600;
          font-family: var(--font-main), sans-serif;
          color: var(--text-color);
        }

        div.finish > p.desc {
          margin: 0;
          font-size: 0.95rem;
          font-family: var(--font-read), sans-serif;
          color: var(--text-color);
          line-height: 1.4;
          text-align: center;
        }

        div.finish > button.finish {
          border: none;
          background: var(--accent-linear);
          font-family: var(--font-main), sans-serif;
          text-decoration: none;
          color: var(--white-color);
          font-size: 1rem;
          font-weight: 600;
          cursor: pointer;
          display: flex;
          width: max-content;
          flex-flow: row;
          align-items: center;
          text-transform: capitalize;
          justify-content: center;
          padding: 7px 15px 8px;
          border-radius: 50px;
          -webkit-border-radius: 50px;
          -moz-border-radius: 50px;
        }

        #editor {
          min-width: 100%;
          width: 100%;
          overflow-y: auto;
          font-family: var(--font-main), sans-serif;
        }

        .ck.ck-editor__main > .ck-editor__editable {
          color: var(--editor-color);
        }

        .ck.ck-editor__main > .ck-editor__editable a {
          color: var(--anchor-color);
        }

        .ck-editor__editable_inline:not(.ck-comment__input *) {
          font-family: var(--font-main), sans-serif;
          overflow-y: auto;
        }

        .ck-editor__editable_inline {
          max-height: 70vh;
          min-height: 200px;
        }

        .ck-body-wrapper {
          display: none;
          opacity: 0;
          visibility: hidden;
        }

        .ck.ck-reset.ck-editor {
          display: -webkit-box;
          display: -moz-box;
          display: -ms-flexbox;
          display: -webkit-flex;
          display: flex;
          -webkit-flex-direction: column;
          -moz-flex-direction: column;
          -ms-flex-direction: column;
          flex-direction: column;
        }

        .ck-focused, .ck.ck-editor__editable:not(.ck-editor__nested-editable).ck-focused {
          border: none;
          border: none;
          outline: none !important;
          -moz-outline: none !important;
          -webkit-outline: none !important;
          -ms-outline: none !important;
          -webkit-box-shadow: none;
          -moz-box-shadow: none;
          box-shadow: none
        }

        h6,
        h5,
        h4,
        h3,
        h1 {
          padding: 0;
          color: var(--title-color);
          font-weight: 500;
          line-height: 1.5;
          margin: 10px 0;
          font-family: var(--font-main), sans-serif;
        }

        h6 {
          font-size: initial;
        }

        h5 {
          font-size: initial;
        }

        h4 {
          font-size: 1.25rem;
        }

        h3 {
          font-size: 1.3rem !important;;
        }

        h2 {
          font-size: 1.35rem !important;
          color: var(--title-color);
          font-weight: 600;
          line-height: 1.2;
          margin: 0;
          padding: 2px 0 0 13px;
          margin: 20px 0 10px;
          position: relative;
        }

        h2:before {
          content: "";
          position: absolute;
          bottom: 10%;
          left: 0;
          width: 2px;
          height: 80%;
          background: var(--action-linear);
          border-radius: 5px;
        }

        p {
          margin: 5px 0;
          line-height: 1.4;
        }

        a {
          text-decoration: none;
          cursor: pointer;
          color: var(--anchor-color) !important;
        }

        a:hover {
          text-decoration: underline;
        }

        blockquote {
          margin: 10px 0;
          padding: 5px 15px;
          font-style: italic;
          border-left: 2px solid var(--gray-color);
          background: var(--background);
          color: var(--text-color);
          font-weight: 400;
        }

        blockquote:before {
          content: open-quote;
          color: var(--gray-color);
          font-size: 1.5rem;
          line-height: 1;
          margin: 0 0 0 -5px;
        }

        blockquote:after {
          content: close-quote;
          color: var(--gray-color);
          font-size: 1.5rem;
          line-height: 1;
          margin: 0 0 0 -5px;
        }

        hr {
          border: none;
          background-color: var(--gray-color);
          height: 1px;
          margin: 10px 0;
        }

        ul,
        ol {
          margin: 5px 0 15px 20px;
          padding: 0 0 0 15px;
          color: inherit;
        }

        ul li,
        ol li {
          padding: 5px 0;
        }

        code {
          background: var(--gray-background);
          padding: 0 5px;
          font-family: var(--font-mono);
          font-size: 0.9rem;
          border-radius: 5px;
        }

        figure {
          max-width: 100% !important;
          height: auto;
          width: max-content;
          padding: 0;
          max-width: 100%;
          display: block;
          margin-block-start: 5px;
          margin-block-end: 5px;
          margin-inline-start: 0 !important;
          margin-inline-end: 0 !important;
        }

        img {
          max-width: 100%;
          height: auto;
          object-fit: contain;
          border-radius: 5px;
        }

        @media screen and (max-width:600px) {
          .content-wrapper {
            border: none;
            background-color: var(--modal-background);
            padding: 0px;
            justify-self: end;
            display: flex;
            flex-flow: column;
            align-items: center;
            justify-content: end;
            gap: 10px;
            z-index: 20;
            position: fixed;
            right: 0;
            top: 0;
            bottom: 0;
            left: 0;
            min-width: 100dvw;
            min-height: 100dvh;
          }

          #content {
            box-sizing: border-box !important;
            padding: 5px 10px 10px;
            margin: 0;
            position: fixed;
            top: 0;
            right: 0;
            left: 0;
            bottom: 0;
            width: 100%;
            max-width: 100%;
            height: 100dvh;
            min-height: 100dvh;
            border-radius: 0;
          }

          #content span.control {
            cursor: default !important;
          }

          ::-webkit-scrollbar {
            -webkit-appearance: none;
          }

          h2.pop-title {
            width: 100%;
            font-size: 1.2rem;
            padding: 10px 10px;
            background-color: var(--gray-background);
            text-align: center;
            border-radius: 12px;
          }

          .top > .desc {
            margin: 0;
            padding: 6px 0 10px;
            font-size: 0.95rem;
            line-height: 1.5;
            font-family: var(--font-main), sans-serif;
          }

          div.finish {
            padding: 25px 0;
            width: 100%;
            min-width: 100%;
            height: auto;
            display: flex;
            flex-flow: column;
            justify-content: center;
            align-items: center;
            gap: 18px;
          }

          div.post-type > div.types {
            width: 100%;
            display: flex;
            flex-flow: column;
            gap: 20px;
          }

          form.fields .actions {
            align-items: center;
            width: 100%;
            gap: 25px;
          }

          div.finish > button.finish {
            margin: 10px 0 0;
          }

          form.fields > .field.polls > div.remove > span.remove-poll,
          form.fields > .field.polls > .poll-inputs > span.add-option,
          div.post-type > div.types > div.type,
          div.finish > button.finish,
          form.fields .actions .action,
          div.finish > button.finish {
            cursor: default !important;
          }

          .ck-editor__editable_inline:not(.ck-comment__input *) {
            overflow-y: auto;
          }

          .ck-editor__editable_inline {
            max-height: calc(100dvh - 100px);
            height: calc(100dvh - 100px);
          }
        }
      </style>
    `;
    }
  }

  const editorConfig$1 = {
  	toolbar: {
  		items: [
  			'bold',
  			'italic',
  			'underline',
        'link',
  			'code',
  			'|',
  			'bulletedList',
  			'numberedList',
  			'blockQuote',
        'strikethrough',
  		],
  		shouldNotGroupWhenFull: false
  	},
  	plugins: [
  		gv,
  		tI,
  		pv,
  		h_,
  		py,
  		Cv,
  		Sv,
  		MC,
  		vx,
  		GA,
  		Bv,
  		nI,
  		tP,
  		AP,
  		_A,
  		Nv,
  		Xv,
  		_x
  	],
  	balloonToolbar: ['bold', 'italic', '|', 'link', '|', 'blockQuote'],
  	fontFamily: {
  		supportAllValues: true
  	},
  	list: {
  		properties: {
  			styles: true,
  			startIndex: true,
  			reversed: true
  		}
  	},
  	placeholder: 'Type or paste your content here!',
  	style: {
  		definitions: [
  			{
  				name: 'Article category',
  				element: 'h3',
  				classes: ['category']
  			},
  			{
  				name: 'Title',
  				element: 'h2',
  				classes: ['document-title']
  			},
  			{
  				name: 'Subtitle',
  				element: 'h3',
  				classes: ['document-subtitle']
  			},
  			{
  				name: 'Info box',
  				element: 'p',
  				classes: ['info-box']
  			},
  			{
  				name: 'Side quote',
  				element: 'blockquote',
  				classes: ['side-quote']
  			},
  			{
  				name: 'Marker',
  				element: 'span',
  				classes: ['marker']
  			},
  			{
  				name: 'Spoiler',
  				element: 'span',
  				classes: ['spoiler']
  			},
  			{
  				name: 'Code (dark)',
  				element: 'pre',
  				classes: ['fancy-code', 'fancy-code-dark']
  			},
  			{
  				name: 'Code (bright)',
  				element: 'pre',
  				classes: ['fancy-code', 'fancy-code-bright']
  			}
  		]
  	},
  	table: {
  		contentToolbar: ['tableColumn', 'tableRow', 'mergeTableCells', 'tableProperties', 'tableCellProperties']
  	},
  };

  class EditPost extends HTMLDivElement {
    constructor() {
      // We are not even going to touch this.
      super();

      this.editor = null;

      // get innerHTML before it is removed
      this._innerHTML = this.innerHTML;

      this._url = this.getAttribute('api');

      this._option = this.getAttribute('kind');

      this.render();
    }

    render() {
      // this.shadowObj.innerHTML = this.getTemplate();
      this.innerHTML = this.getTemplate();
    }

    connectedCallback() {
      // select section
      const section = this.querySelector('section.content');

      // select the form
      const form = this.querySelector('form');

      if (form && section) {
        // add event listener to the form
        this.submitForm(form, section);

        this.activatePostType();
      }
      
      const btns = this.querySelectorAll('.cancel-btn');
      const overlay = this.querySelector('.overlay');

      // Close the modal
      if (overlay && btns) {
        this.closePopup(overlay, btns);
      }

      this.disableScroll();
    }

    initEditor() {
      jC.create(this.querySelector('#editor'), editorConfig$1)
      .then(editor => {
        // set data to the editor
        editor.setData(this._innerHTML);
        this.editor = editor;
      })
      .catch(error => {
        console.log('Failed to initialize the editor. Error: ', error);
      });
    }

    disconnectedCallback() {
      this.enableScroll();
    }

    closePopup = (overlay, btns) => {
      overlay.addEventListener('click', e => {
        e.preventDefault();
        this.remove();
      });

      btns.forEach(btn => {
        btn.addEventListener('click', e => {
          e.preventDefault();
          this.remove();
        });
      });
    }

    disableScroll() {
      // Get the current page scroll position
      let scrollTop = window.scrollY || document.documentElement.scrollTop;
      let scrollLeft = window.scrollX || document.documentElement.scrollLeft;
      document.body.classList.add("stop-scrolling");

      // if any scroll is attempted, set this to the previous value
      window.onscroll = function () {
        window.scrollTo(scrollLeft, scrollTop);
      };
    }

    enableScroll() {
      document.body.classList.remove("stop-scrolling");
      window.onscroll = function () { };
    }

    submitForm = async (form, section) => {
      const outerThis = this;
      // add submit event listener
      form.addEventListener('submit', async e => {
        e.preventDefault();

        const serverStatus = form.querySelector('.server-status');

        // if server status is already showing, remove it
        if (serverStatus) {
          serverStatus.remove();
        }

        const button = form.querySelector('.action.submit');

        const actions = form.querySelector('.actions');

        // get and validate form data
        const formData = this.getFormData(form);

        if (!this.validatePostData(form, formData, actions)) {
          return;
        }

        // Construct the body object
        let body = {
          content: formData.content
        };

        button.innerHTML = this.getButtonLoader();
        // disable pointer events
        button.style.pointerEvents = 'none';

        // get images-uploader: images attribute
        const imagesUploader = form.querySelector('div.images-editor');
        let images = imagesUploader.getAttribute('images').split(',');

        // filter out empty strings, null, 'null' or whose length is <5
        images = images.filter(img => img && img !== 'null' && img.length > 5);

        // check if images length is greater than 0
        if (images.length > 0) {
          body.images = images;
        }

        // send data to server
        const options = {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(body)
        };

        try {
          const response = await outerThis.fetchWithTimeout(outerThis._url, options);
          const result = await response.json();

          // check if request was successful
          if (result.success) {
            // show success message
            actions.insertAdjacentHTML('beforebegin', 
              outerThis.getServerSuccessMsg(true, 'Post created successfully')
            );

            // add finish message
            outerThis.removeFormAndTopDesc(section);

            if(window.toBeChanged) {
              window.toBeChanged.innerHTML = body.content;
              window.toBeChanged.setAttribute('reload', 'true');
              window.toBeChanged = null;
            }
          } else {
            // show error message
            actions.insertAdjacentHTML('beforebegin', outerThis.getServerSuccessMsg(false, result.message));

            // reset button
            button.innerHTML = '<span class="text">Post</span>';
            // enable pointer events
            button.style.pointerEvents = 'auto';
          }
        }
        catch (error) {
          // show error message
          actions.insertAdjacentHTML('beforebegin', outerThis.getServerSuccessMsg(false, 'An error occurred, please try again'));

          // reset button
          button.innerHTML = '<span class="text">Post</span>';
          // enable pointer events
          button.style.pointerEvents = 'auto';
        }

        // remove success message
        setTimeout(() => {
          const serverStatus = form.querySelector('.server-status');
          if (serverStatus) {
            serverStatus.remove();
          }
        }, 5000);
      });
    }

    validatePostData = (form, data, actions) => {
      // console.log(data);
      // check if post data is valid
      if (!data.content) {
        // show error message
        actions.insertAdjacentHTML('beforebegin', this.getServerSuccessMsg(false, 'Post content must be defined!'));

        setTimeout(() => {
          const serverStatus = form.querySelector('.server-status');
          if (serverStatus) {
            serverStatus.remove();
          }
        }, 5000);

        return false;
      }

      // clone the data
      let content = data.content;

      // validate post content: count length without html tags
      content = content.replace(/<[^>]*>?/gm, '');

      if (content.length < 3) {
        // show error message
        actions.insertAdjacentHTML('beforebegin', this.getServerSuccessMsg(false, 'Post content must be at least 3 characters'));

        setTimeout(() => {
          const serverStatus = form.querySelector('.server-status');
          if (serverStatus) {
            serverStatus.remove();
          }
        }, 5000);

        return false;
      }
        
      return true;
    }

    getFormData = () => {
      // get data from the editor
      const data = this.editor.getData();

      return {
        content: this.cleanWysiwygText(data)
      };
    }

    cleanWysiwygText(input) {
      let cleanedText = input;

      // Step 1: Remove whitespace between tags
      cleanedText = cleanedText.replace(/>\s+</g, '><');

      // Step 2: Remove empty tags and tags with only &nbsp; or whitespace
      cleanedText = cleanedText.replace(/<(\w+)>(\s|&nbsp;)*<\/\1>/g, '');

      // Step 3: Remove <br> tags immediately after opening tags
      cleanedText = cleanedText.replace(/<(\w+)><br>/g, '<$1>');

      // Additional step: Remove <br> tags immediately before closing tags
      cleanedText = cleanedText.replace(/<br><\/(\w+)>/g, '</$1>');

      // Preserve <br> tags in the middle of content
      cleanedText = cleanedText.replace(/>(\s*<br>\s*)+</g, '><br><');

      return cleanedText;
    }

    fetchWithTimeout = async (url, options = {}, timeout = 9500) => {
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), timeout);
    
      try {
        const response = await fetch(url, {
          ...options,
          signal: controller.signal
        });

        return response;
      } catch (error) {
        if (error.name === 'AbortError') {
          throw new Error('Request timed out');
        }
        throw new Error(`Network error: ${error.message}`);
      } finally {
        clearTimeout(timeoutId);
      }
    }

    getServerSuccessMsg = (success, text) => {
      if (!success) {
        return `
        <p class="server-status">${text}</p>
      `
      }
      return `
      <p class="server-status success">${text}</p>
    `
    }

    getTemplate() {
      // Show HTML Here
      return /*html*/`
      <div class="content-wrapper">
        <div class="overlay"></div>
        <section id="content" class="content">
          ${this.getBody()}
        </section>
      </div>
      ${this.getStyles()}
    `
    }

    getBody = () => {
      return /* html */`
      <form class="fields post" id="post-form">
        ${this.getPostEditor()} 
        ${this.getImagesEditor(this.getAttribute('kind'))}
        <div class="actions active">
          <span class="action-info">Publishing</span>
          <div class="buttons">
            <span class="action cancel-btn">
              <span class="text">Cancel</span>
            </span>
            <button type="submit" class="action submit">
              <span class="text">Post</span>
            </button>
          </div>
        </div>
      </form>
    `;
    }

    getPostEditor = () => {
      return /* html */`
      <textarea name="editor" id="editor" cols="30" rows="10" placeholder="Type or paste your content hare!"></textarea>
    `;
    }

    getImagesEditor = kind => {
      // if kind is poll return: empty string
      if (kind === 'poll') {
        return '';
      } else {
        return /* html */`
        <div is="images-editor" class="images-editor" hash="${this.getAttribute('hash')}" kind="${this.getAttribute('kind')}"
          api="/api/v1/i/upload" multiple="true" accept="image/*" max="10" images='${this.getAttribute('images')}'>
        </div>
      `;
      }
    }

    activatePostType = ()=> {
      // activate the editor
      this.initEditor();
    }

    getFinish = () => {
      return /* html */`
      <div class="finish">
        <h2 class="title">You're all set!</h2>
        <p class="desc">
          Your ${this._option.toLowerCase()} has been successfully edited and published to the feeds.
          You can now close this modal using the button below.
        </p>
        <button class="finish">Close</button>
      </div>
    `;
    }

    activateFinish = finish => {
      const button = finish.querySelector('button.finish');
      if (button) {
        button.addEventListener('click', e => {
          e.preventDefault();
          this.remove();
        });
      }
    }

    removeFormAndTopDesc = section => {
      section.innerHTML = this.getFinish();

      const finish = this.querySelector('div.finish');

      // activate the finish button
      this.activateFinish(finish);
    }

    getButtonLoader() {
      return /*html*/`
      <span id="btn-loader">
				<span class="loader"></span>
			</span>
    `
    }

    getStyles() {
      return /* css */`
      <link rel="stylesheet" href="/static/css/ckeditor.css">
      <style>
        *,
        *:after,
        *:before {
          box-sizing: border-box !important;
          font-family: inherit;
          -webkit-box-sizing: border-box !important;
        }

        *:focus {
          outline: inherit !important;
        }

        *::-webkit-scrollbar {
          -webkit-appearance: none;
        }

        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
          padding: 0;
          margin: 0;
          font-family: inherit;
        }

        p,
        ul,
        ol {
          font-family: inherit;
        }

        a {
          text-decoration: none;
        }

        .content-wrapper {
          border: none;
          padding: 0;
          justify-self: end;
          display: flex;
          flex-flow: column;
          align-items: center;
          justify-content: center;
          gap: 10px;
          z-index: 100;
          width: 100%;
          min-width: 100vw;
          position: fixed;
          right: 0;
          top: 0;
          bottom: 0;
          left: 0;
        }

        div.overlay {
          position: absolute;
          top: 0;
          right: 0;
          bottom: 0;
          left: 0;
          height: 100%;
          width: 100%;
          background-color: var(--modal-background);
          backdrop-filter: blur(3px);
          -webkit-backdrop-filter: blur(3px);
        }

        #content {
          z-index: 1;
          background-color: var(--background);
          padding: 20px;
          display: flex;
          flex-flow: column;
          align-items: center;
          justify-content: start;
          gap: 10px;
          width: 700px;
          max-height: 95%;
          height: 90%;
          height: max-content;
          border-radius: 15px;
          position: relative;
          overflow-y: auto;
        }

        p.server-status {
          margin: 0;
          width: 100%;
          text-align: start;
          font-family: var(--font-read), sans-serif;
          color: var(--error-color);
          font-weight: 500;
          line-height: 1.4;
          font-size: 1.18rem;
        }

        p.server-status.success {
          color: transparent;
          background: var(--accent-linear);
          background-clip: text;
          -webkit-background-clip: text;
        }

        #btn-loader {
          position: absolute;
          top: 0;
          left: 0;
          bottom: 0;
          right: 0;
          z-index: 5;
          display: flex;
          align-items: center;
          justify-content: center;
          border-radius: inherit;
        }

        #btn-loader > .loader {
          width: 20px;
          aspect-ratio: 1;
          --_g: no-repeat radial-gradient(farthest-side, #18A565 94%, #0000);
          --_g1: no-repeat radial-gradient(farthest-side, #21D029 94%, #0000);
          --_g2: no-repeat radial-gradient(farthest-side, #df791a 94%, #0000);
          --_g3: no-repeat radial-gradient(farthest-side, #f09c4e 94%, #0000);
          background: var(--_g) 0 0,  var(--_g1) 100% 0, var(--_g2) 100% 100%, var(--_g3) 0 100%;
          background-size: 30% 30%;
          animation: l38 .9s infinite ease-in-out;
          -webkit-animation: l38 .9s infinite ease-in-out;
        }

        @keyframes l38 {
          100% {
            background-position: 100% 0, 100% 100%, 0 100%, 0 0
          }
        }

        h2.pop-title {
          width: 100%;
          font-size: 1.35rem;
          font-weight: 600;
          margin: 0;
          padding: 10px 10px;
          background-color: var(--gray-background);
          text-align: center;
          border-radius: 12px;
          font-family: var(--font-read), sans-serif;
          color: var(--text-color);
          font-weight: 500;
          position: relative;
        }

        h2.pop-title > span.control {
          padding: 0;
          cursor: pointer;
          display: flex;
          flex-flow: column;
          gap: 0px;
          justify-content: center;
          position: absolute;
          top: 50%;
          left: 10px;
          transform: translateY(-50%);
        }

        h2.pop-title > span.control svg {
          width: 21px;
          height: 21px;
          color: var(--text-color);
        }

        h2.pop-title > span.control svg:hover{
          color: var(--error-color);
        }

        .top {
          display: flex;
          flex-flow: column;
          gap: 5px;
          padding: 0;
          width: 100%;
        }

        .top > .desc {
          margin: 0;
          padding: 10px 0 20px;
          color: var(--text-color);
          font-size: 0.95rem;
          font-family: var(--font-main), sans-serif;
        }

        .top > .desc > span {
          display: inline-block;
          margin: 10px 0 5px;
          color: var(--gray-color);
          font-size: 0.85rem;
          font-style: italic;
          font-family: var(--font-read), sans-serif;
        }

        form.fields {
          margin: 0;
          width: 100%;
          min-width: 100%;
          height: auto;
          display: flex;
          flex-flow: column;
          justify-content: center;
          align-items: center;
          gap: 0;
        }

        form.fields div.images-editor {
          width: 100%;
          min-width: 100%;
        }

        div.post-type {
          width: 100%;
          display: flex;
          flex-flow: column;
          gap: 15px;
          padding: 10px 0;
        }

        div.post-type > h2.title {
          width: 100%;
          margin: 0;
          padding: 0;
          font-size: 1.25rem;
          text-align: center;
          font-weight: 500;
          text-transform: capitalize;
          font-family: var(--font-main), sans-serif;
          color: var(--text-color);
        }

        div.post-type > div.types {
          width: 100%;
          display: flex;
          flex-flow: row;
          gap: 20px;
        }

        div.post-type > div.types > div.type {
          width: 100%;
          display: flex;
          flex-flow: column;
          gap: 5px;
          padding: 10px;
          border-radius: 12px;
          background: var(--create-background);
          cursor: pointer;
        }

        div.post-type > div.types > div.type:hover {
          background: var(--background);
          border: var(--border);
        }

        div.post-type > div.types > div.type > h4.title {
          margin: 0;
          padding: 0;
          font-size: 1.1rem;
          font-weight: 500;
          font-family: var(--font-main), sans-serif;
          color: var(--text-color);
        }

        div.post-type > div.types > div.type > p.desc {
          margin: 0;
          padding: 5px 0;
          font-size: 0.85rem;
          font-family: var(--font-read), sans-serif;
          color: var(--gray-color);
        }

        form.fields > .field {
          width: 100%;
          display: flex;
          flex-flow: column;
          justify-content: center;
          align-items: start;
          gap: 0;
        }

        form.fields > .field.polls {
          padding: 10px 0 0 0;
        }

        form.fields > .field.polls > span.title {
          display: none;
          margin: 0;
          padding: 0 0 10px 3px;
          color: var(--text-color);
          font-size: 1rem;
          font-weight: 600;
          font-family: var(--font-main), sans-serif;
        }

        form.fields > .field.polls > .poll-inputs {
          width: 100%;
          display: flex;
          flex-flow: column;
          justify-content: center;
          align-items: start;
          gap: 15px;
        }

        form.fields > .field.polls > .poll-inputs.texts {
          margin: 0 0 18px;
        }

        form.fields > .field.polls > div.remove {
          width: 100%;
          display: flex;
          flex-flow: row;
          justify-content: end;
          align-items: center;
          gap: 0;
          padding: 8px 0 20px;
        }

        form.fields > .field.polls > div.remove > span.remove-poll {
          width: max-content;
          padding: 0 5px;
          display: flex;
          cursor: pointer;
          font-family: var(--font-read), sans-serif;
          font-size: 0.95rem;
          font-weight: 400;
          color: var(--gray-color);
        }

        form.fields > .field.polls > .poll-inputs > span.add-option {
          /*border: var(--border);*/
          background: var(--gray-background);
          font-family: var(--font-main), sans-serif;
          font-size: 1rem;
          font-weight: 500;
          display: flex;
          justify-content: center;
          align-items: center;
          width: 100%;
          cursor: pointer;
          height: 40px;
          border-radius: 12px;
          color: var(--gray-color);
          -webkit-border-radius: 12px;
          -moz-border-radius: 12px;
          -ms-border-radius: 12px;
          -o-border-radius: 12px;
        }

        form.fields > .field.polls > .poll-inputs > span.add-option:hover {
          color: var(--accent-color);
        }

        form.fields .field input {
          border: var(--input-border);
          background: var(--background);
          font-family: var(--font-read), sans-serif;
          font-size: 0.95rem;
          width: 100%;
          height: 40px;
          outline: none;
          padding: 10px 12px;
          border-radius: 12px;
          color: var(--text-color);
          -webkit-border-radius: 12px;
          -moz-border-radius: 12px;
          -ms-border-radius: 12px;
          -o-border-radius: 12px;
        }

        form.fields .field input {
          border: none;
          display: inline-block;
          border: var(--border);
          font-family: var(--font-read), sans-serif;
          background-color: var(--background) !important;
          font-size: 1rem;
          width: 100%;
          min-width: 100%;
          height: 40px;
          outline: none;
          padding: 10px 12px;
          border-radius: 12px;
          color: var(--text-color);
        }
        
        form.fields .field input:-webkit-autofill,
        form.fields .field input:-webkit-autofill:hover, 
        form.fields .field input:-webkit-autofill:focus {
          -webkit-box-shadow: 0 0 0px 1000px var(--background) inset;
          -webkit-text-fill-color: var(--text-color) !important;
          transition: background-color 5000s ease-in-out 0s;
          color: var(--text-color) !important;
        }
        
        form.fields .field input:autofill {
          filter: none;
          color: var(--text-color) !important;
        }

        form.fields .field input:focus {
          /* border: var(--input-border-focus); */
          border: var(--border);
        }

        form.fields textarea {
          border: none;
          /* border: var(--border); */
          font-family: var(--font-read), sans-serif;
          background: var(--background);
          font-size: 1rem;
          padding: 10px 5px;
          margin: 0;
          width: 100%;
          resize: none;
          height: auto;
          line-height: 1.5;
          gap: 5px;
          font-weight: 400;
          color: var(--text-color);
          scrollbar-width: 3px;
          border-radius: 12px;
        }

        form.fields textarea::-webkit-scrollbar {
          width: 3px;
          -webkit-appearance: auto;
        }

        form.fields textarea:focus {
          /*border: var(--input-border-focus);*/
          border: none;
        }

        form.fields .field span.wrapper {
          display: flex;
          align-items: center;
          align-items: center;
          gap: 0;
          width: 100%;
        }

        form.fields label.focused {
          top: -10px;
          font-size: 0.9rem;
          background-color: var(--label-focus-background);
          padding: 0 5px;
        }

        form.fields .field span.status {
          color: var(--error-color);
          font-size: 0.95rem;
          display: none;
          padding: 0 0 0 5px;
        }

        form.fields .field .input-group.failed span.status {
          color: var(--error-color);
          font-size: 0.8rem;
          display: inline-block;
        }

        form.fields .field .input-group.success span.status {
          color: var(--accent-color);
          font-size: 0.8rem;
          display: inline-block;
        }

        form.fields .field .input-group.success span.status {
          display: none;
        }

        form.fields .actions {
          border-top: var(--border);
          display: flex;
          align-items: center;
          justify-content: space-between;
          width: 100%;
          height: max-content;
          gap: 20px;
          margin: 0;
          padding: 10px 0 0;
        }

        form.fields .actions.active {
          border-top: var(--input-border-focus);
        }

        form.fields .actions > span.action-info {
          color: var(--gray-color);
          font-size: 0.95rem;
          font-family: var(--font-read), sans-serif;
          font-weight: 400;
          line-height: 1.5;
        }

        form.fields .actions > .buttons {
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 20px;
          margin: 0;
        }

        form.fields .actions .action {
          background: var(--gray-background);
          color: var(--gray-color);
          border: none;
          font-family: var(--font-main), sans-serif;
          text-decoration: none;
          font-size: 1rem;
          font-weight: 600;
          cursor: pointer;
          display: flex;
          flex-flow: row;
          align-items: center;
          text-transform: capitalize;
          justify-content: center;
          padding: 7px 15px 8px;
          min-height: 35px;
          height: 35px;
          min-width: 60px;
          width: max-content;
          position: relative;
          border-radius: 50px;
          -webkit-border-radius: 50px;
          -moz-border-radius: 50px;
        }

        form.fields .actions .action.cancel-btn {
          background: var(--gray-background);
          color: var(--gray-color);
        }

        form.fields .actions.active .action.submit {
          border: none;
          background: var(--accent-linear);
          font-family: var(--font-main), sans-serif;
          text-decoration: none;
          color: var(--white-color);
        }

        form.fields .actions > .action.disabled {
          pointer-events: none;
        }

        div.finish {
          padding: 15px 0;
          width: 100%;
          min-width: 100%;
          height: auto;
          display: flex;
          flex-flow: column;
          justify-content: center;
          align-items: center;
          gap: 15px;
        }

        div.finish > h2.title {
          margin: 0;
          font-size: 1.25rem;
          font-weight: 600;
          font-family: var(--font-main), sans-serif;
          color: var(--text-color);
        }

        div.finish > p.desc {
          margin: 0;
          font-size: 0.95rem;
          font-family: var(--font-read), sans-serif;
          color: var(--text-color);
          line-height: 1.4;
          text-align: center;
        }

        div.finish > button.finish {
          border: none;
          background: var(--accent-linear);
          font-family: var(--font-main), sans-serif;
          text-decoration: none;
          color: var(--white-color);
          font-size: 1rem;
          font-weight: 600;
          cursor: pointer;
          display: flex;
          width: max-content;
          flex-flow: row;
          align-items: center;
          text-transform: capitalize;
          justify-content: center;
          padding: 7px 15px 8px;
          border-radius: 50px;
          -webkit-border-radius: 50px;
          -moz-border-radius: 50px;
        }

        #editor {
          min-width: 100%;
          width: 100%;
          overflow-y: auto;
          font-family: var(--font-text), sans-serif;
        }

        .ck.ck-editor__main > .ck-editor__editable {
          color: var(--editor-color);
        }

        .ck.ck-editor__main > .ck-editor__editable a {
          color: var(--anchor-color);
        }

        .ck-editor__editable_inline:not(.ck-comment__input *) {
          font-family: var(--font-text), sans-serif;
          overflow-y: auto;
        }

        .ck-editor__editable_inline {
          max-height: 350px;
        }

        .ck-body-wrapper {
          display: none;
          opacity: 0;
          visibility: hidden;
        }

        .ck.ck-reset.ck-editor {
          display: -webkit-box;
          display: -moz-box;
          display: -ms-flexbox;
          display: -webkit-flex;
          display: flex;
          -webkit-flex-direction: column;
          -moz-flex-direction: column;
          -ms-flex-direction: column;
          flex-direction: column;
        }

        .ck-focused, .ck.ck-editor__editable:not(.ck-editor__nested-editable).ck-focused {
          border: none;
          border: none;
          outline: none !important;
          -moz-outline: none !important;
          -webkit-outline: none !important;
          -ms-outline: none !important;
          -webkit-box-shadow: none;
          -moz-box-shadow: none;
          box-shadow: none
        }

        .ck.ck-editor__main h6,
        .ck.ck-editor__main h5,
        .ck.ck-editor__main h4,
        .ck.ck-editor__main h3,
        .ck.ck-editor__main h1 {
          padding: 0;
          color: var(--title-color);
          font-weight: 500;
          line-height: 1.5;
          margin: 10px 0;
          font-family: var(--font-main), sans-serif;
        }

        .ck.ck-editor__main h6 {
          font-size: initial;
        }

        .ck.ck-editor__main h5 {
          font-size: initial;
        }

        .ck.ck-editor__main h4 {
          font-size: 1.25rem;
        }

        .ck.ck-editor__main h3 {
          font-size: 1.3rem !important;;
        }

        .ck.ck-editor__main h2 {
          font-size: 1.35rem !important;
          color: var(--title-color);
          font-weight: 600;
          line-height: 1.2;
          margin: 0;
          padding: 2px 0 0 13px;
          margin: 20px 0 10px;
          position: relative;
        }

        .ck.ck-editor__main h2:before {
          content: "";
          position: absolute;
          bottom: 10%;
          left: 0;
          width: 2px;
          height: 80%;
          background: var(--action-linear);
          border-radius: 5px;
        }

        .ck.ck-editor__main p {
          margin: 5px 0;
          line-height: 1.4;
        }

        .ck.ck-editor__main a {
          text-decoration: none;
          cursor: pointer;
          color: var(--anchor-color) !important;
        }

        .ck.ck-editor__main a:hover {
          text-decoration: underline;
        }

        .ck.ck-editor__main blockquote {
          margin: 10px 0;
          padding: 5px 15px;
          font-style: italic;
          border-left: 2px solid var(--gray-color);
          background: var(--background);
          color: var(--text-color);
          font-weight: 400;
        }

        .ck.ck-editor__main blockquote:before {
          content: open-quote;
          color: var(--gray-color);
          font-size: 1.5rem;
          line-height: 1;
          margin: 0 0 0 -5px;
        }

        .ck.ck-editor__main blockquote:after {
          content: close-quote;
          color: var(--gray-color);
          font-size: 1.5rem;
          line-height: 1;
          margin: 0 0 0 -5px;
        }

        .ck.ck-editor__main hr {
          border: none;
          background-color: var(--gray-color);
          height: 1px;
          margin: 10px 0;
        }

        .ck.ck-editor__main ul,
        .ck.ck-editor__main ol {
          margin: 5px 0 15px 20px;
          padding: 0 0 0 15px;
          color: inherit;
        }

        .ck.ck-editor__main ul li,
        .ck.ck-editor__main ol li {
          padding: 5px 0;
        }

        .ck.ck-editor__main code {
          background: var(--gray-background);
          padding: 0 5px;
          font-family: var(--font-mono);
          font-size: 0.9rem;
          border-radius: 5px;
        }

        .ck.ck-editor__main img {
          max-width: 100%;
          height: auto;
          object-fit: contain;
          border-radius: 5px;
        }

        figure {
          max-width: 100% !important;
          height: auto;
          width: max-content;
          padding: 0;
          max-width: 100%;
          display: block;
          margin-block-start: 5px;
          margin-block-end: 5px;
          margin-inline-start: 0 !important;
          margin-inline-end: 0 !important;
        }

        @media screen and (max-width:600px) {
          .content-wrapper {
            border: none;
            background-color: var(--modal-background);
            padding: 0px;
            justify-self: end;
            display: flex;
            flex-flow: column;
            align-items: center;
            justify-content: end;
            gap: 10px;
            z-index: 20;
            position: fixed;
            right: 0;
            top: 0;
            bottom: 0;
            left: 0;
            min-width: 100dvw;
            min-height: 100dvh;
          }

          #content {
            box-sizing: border-box !important;
            padding: 5px 10px 10px;
            margin: 0;
            position: fixed;
            right: 0;
            left: 0;
            bottom: 0;
            width: 100%;
            max-width: 100%;
            height: max-content;
            border-radius: 0;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
            overflow-y: auto;
          }

          #content span.control {
            cursor: default !important;
          }

          ::-webkit-scrollbar {
            -webkit-appearance: none;
          }

          h2.pop-title {
            width: 100%;
            font-size: 1.2rem;
            padding: 10px 10px;
            background-color: var(--gray-background);
            text-align: center;
            border-radius: 12px;
          }

          .top > .desc {
            margin: 0;
            padding: 6px 0 10px;
            font-size: 0.95rem;
            line-height: 1.5;
            font-family: var(--font-main), sans-serif;
          }

          div.finish {
            padding: 25px 0;
            width: 100%;
            min-width: 100%;
            height: auto;
            display: flex;
            flex-flow: column;
            justify-content: center;
            align-items: center;
            gap: 18px;
          }

          div.post-type > div.types {
            width: 100%;
            display: flex;
            flex-flow: column;

            gap: 20px;
          }

          form.fields .actions {
            align-items: center;
            width: 100%;
            gap: 25px;
          }

          div.finish > button.finish {
            margin: 10px 0 0;
          }

          form.fields > .field.polls > div.remove > span.remove-poll,
          form.fields > .field.polls > .poll-inputs > span.add-option,
          div.post-type > div.types > div.type,
          div.finish > button.finish,
          form.fields .actions .action,
          div.finish > button.finish {
            cursor: default !important;
          }

          .ck-editor__editable_inline:not(.ck-comment__input *) {
            overflow-y: auto;
          }

          .ck-editor__editable_inline {
            max-height: 300px;
          }
        }
      </style>
    `;
    }
  }

  const editorConfig = {
  	toolbar: {
  		items: [
        'heading',
  			'bold',
  			'underline',
        'italic',
        'link',
        'insertImage',
  			'|',
  			'bulletedList',
  			'numberedList',
  			'blockQuote',
        'strikethrough',
  			'code',
  		],
  		shouldNotGroupWhenFull: false
  	},
    heading: {
  		options: [
  				{
  					model: 'paragraph',
  					title: 'Paragraph',
  					class: 'ck-heading_paragraph',
  				},
  				{
  					model: 'heading2',
  					view: 'h2',
  					title: 'Heading 2',
  					class: 'ck-heading_heading2',
  				},
  				{
  					model: 'heading3',
  					view: 'h3',
  					title: 'Heading 3',
  					class: 'ck-heading_heading3',
  				},
  				{
  					model: 'heading4',
  					view: 'h4',
  					title: 'Heading 4',
  					class: 'ck-heading_heading4',
  				},
  			],
  	},
  	plugins: [
  		gv,
  		tI,
  		pv,
  		h_,
  		py,
  		Cv,
  		Sv,
  		vx,
      Vg,
      TA,
  		GA,
      pT,
      mT,
      yT,
      fT,
      DT,
      NT,
      eS,
      mS,
      eT,
      gS,
      MT,
  		Bv,
  		nI,
  		tP,
  		AP,
  		_A,
  		Nv,
  		Xv,
  		_x,
      CustomUploadAdapterPlugin
  	],
  	fontFamily: {
  		supportAllValues: true
  	},
  	list: {
  		properties: {
  			styles: true,
  			startIndex: true,
  			reversed: true
  		}
  	},
    image: {
      toolbar: [
        'imageStyle:inline',
        'imageStyle:block',
        'imageStyle:wrapText',
  			'imageStyle:breakText',
        '|',
        'toggleImageCaption',
        'imageTextAlternative',
        'resizeImage'
      ],
    },
  	placeholder: 'Type your article content here!',
  	style: {
  		definitions: [
  			{
  				name: 'Article category',
  				element: 'h3',
  				classes: ['category']
  			},
  			{
  				name: 'Title',
  				element: 'h2',
  				classes: ['document-title']
  			},
  			{
  				name: 'Subtitle',
  				element: 'h3',
  				classes: ['document-subtitle']
  			},
  			{
  				name: 'Info box',
  				element: 'p',
  				classes: ['info-box']
  			},
  			{
  				name: 'Side quote',
  				element: 'blockquote',
  				classes: ['side-quote']
  			},
  			{
  				name: 'Marker',
  				element: 'span',
  				classes: ['marker']
  			},
  			{
  				name: 'Spoiler',
  				element: 'span',
  				classes: ['spoiler']
  			},
  			{
  				name: 'Code (dark)',
  				element: 'pre',
  				classes: ['fancy-code', 'fancy-code-dark']
  			},
  			{
  				name: 'Code (bright)',
  				element: 'pre',
  				classes: ['fancy-code', 'fancy-code-bright']
  			}
  		]
  	},
  	table: {
  		contentToolbar: ['tableColumn', 'tableRow', 'mergeTableCells', 'tableProperties', 'tableCellProperties']
  	},
  };

  class EditArticle extends HTMLDivElement {
    constructor() {
      // We are not even going to touch this.
      super();

      this.editor = null;

      // get innerHTML before it is removed
      this._innerHTML = this.innerHTML;

      this._url = this.getAttribute('api');

      this._option = null;

      this._title = this.getAttribute('story-title');
      this.slug = this.getAttribute('slug');

      this.hash = this.getAttribute('hash');

      this.render();
    }

    render() {
      // this.shadowObj.innerHTML = this.getTemplate();
      this.innerHTML = this.getTemplate();
    }

    connectedCallback() {
      // select section
      const section = this.querySelector('section.content');

      // select the form
      const form = this.querySelector('form');

      if (form && section) {
        // add event listener to the form
        this.submitForm(form, section);

        // activate the title type
        this.activateTitleType(form);

        // activate the slug type
        this.activateSlugType(form);

        // activate the content type
        this.activateContentType(form);
      }

      const btns = this.querySelectorAll('.cancel-btn');
      const overlay = this.querySelector('.overlay');

      // Close the modal
      if (overlay && btns) {
        this.closePopup(overlay, btns);
      }

      this.disableScroll();
    }

    initEditor() {
      jC.create(this.querySelector('#editor'), editorConfig)
        .then(editor => {
          // set the editor data
          editor.setData(this._innerHTML);
          // set the editor
          this.editor = editor;
        })
        .catch(error => {
          console.log('Failed to initialize the editor. Error: ', error);
        });
    }

    activateTitle = form => {
      // select input for title
      const title = form.querySelector('input[name="title"]');

      if (title) {
        // add an input event listener to title
        title.addEventListener('input', e => {
          const value = e.target.value;

          if (!value) {
            title.parentElement.classList.remove('success');
            title.parentElement.classList.add('failed');
            title.parentElement.querySelector('span.status').textContent = 'title is required';
            return;
          }

          // check for length
          if (value.length < 2) {
            title.parentElement.classList.remove('success');
            title.parentElement.classList.add('failed');
            title.parentElement.querySelector('span.status').textContent = 'title must be at least 2 characters';
            return;
          }

          title.parentElement.classList.remove('failed');
          title.parentElement.classList.add('success');
          title.parentElement.querySelector('span.status').textContent = '';
        });
      }
    }

    activateSlug = form => {
      // select input for slug
      const input = form.querySelector('input[name="slug"]');

      if (input) {
        // add an input event listener to slug
        input.addEventListener('input', e => {
          let value = e.target.value;

          if (!value) {
            input.parentElement.classList.remove('success');
            input.parentElement.classList.add('failed');
            input.parentElement.querySelector('span.status').textContent = 'slug is required';
            return;
          }

          // slugify the input
          const slug = this.slugifyInput(value);
          input.value = slug;
          value = slug;

          if (value.length < 3) {
            input.parentElement.classList.remove('success');
            input.parentElement.classList.add('failed');
            input.parentElement.querySelector('span.status').textContent = 'slug must be at least 3 characters';
            return;
          }

          // check if slug is valid
          if (!/^[a-z0-9-]*$/.test(value)) {
            input.parentElement.classList.remove('success');
            input.parentElement.classList.add('failed');
            input.parentElement.querySelector('span.status').textContent = 'slug can only contain letters, numbers, and hyphens and be in lowercase';
            return;
          }

          input.parentElement.classList.remove('failed');
          input.parentElement.classList.add('success');
          input.parentElement.querySelector('span.status').textContent = '';
        });
      }
    }

    disconnectedCallback() {
      this.enableScroll();
    }

    closePopup = (overlay, btns) => {
      overlay.addEventListener('click', e => {
        e.preventDefault();
        this.remove();
      });

      btns.forEach(btn => {
        btn.addEventListener('click', e => {
          e.preventDefault();
          this.remove();
        });
      });
    }

    disableScroll() {
      // Get the current page scroll position
      let scrollTop = window.scrollY || document.documentElement.scrollTop;
      let scrollLeft = window.scrollX || document.documentElement.scrollLeft;
      document.body.classList.add("stop-scrolling");

      // if any scroll is attempted, set this to the previous value
      window.onscroll = function () {
        window.scrollTo(scrollLeft, scrollTop);
      };
    }

    enableScroll() {
      document.body.classList.remove("stop-scrolling");
      window.onscroll = function () { };
    }

    submitForm = async (form, section) => {
      const outerThis = this;
      // add submit event listener
      form.addEventListener('submit', async e => {
        e.preventDefault();
        // declare variables
        let body;
        let url = this._url;

        const serverStatus = form.querySelector('.server-status');

        // if server status is already showing, remove it
        if (serverStatus) {
          serverStatus.remove();
        }

        const button = form.querySelector('.action.submit');
        const actions = form.querySelector('.actions');

        // get and validate form data
        const formData = this.getFormData(form);

        if (formData.postType === 'title') {
          if (!this.validateTitleData(form, formData.title, actions)) {
            return;
          }

          // Construct the body object
          body = {
            title: formData.title
          };

          // update the url
          url = `${url}/title`;

          // show loader inside the button
          const button = form.querySelector('.action.submit');
          button.innerHTML = this.getButtonLoader();
          // disable pointer events
          button.style.pointerEvents = 'none';
        } else if (formData.postType === 'slug') {
          if (!this.validateSlugData(form, formData.slug, actions)) {
            return;
          }

          // Construct the body object
          body = {
            slug: formData.slug
          };

          // update the url
          url = `${url}/slug`;

          // show loader inside the button
          const button = form.querySelector('.action.submit');
          button.innerHTML = this.getButtonLoader();
          // disable pointer events
          button.style.pointerEvents = 'none';
        } else {
          // get data from the editor
          const content = formData.content;

          if (!this.validateContentData(form, content, actions)) {
            return;
          }

          // Construct the body object
          body = {
            content: content
          };

          // update the url
          url = `${url}/content`;

          // show loader inside the button
          const button = form.querySelector('.action.submit');
          button.innerHTML = this.getButtonLoader();
          // disable pointer events
          button.style.pointerEvents = 'none';
        }

        // send data to server
        const options = {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(body)
        };

        try {
          const response = await outerThis.fetchWithTimeout(url, options);
          const result = await response.json();

          // check if request was successful
          if (result.success) {
            // show success message
            actions.insertAdjacentHTML('beforebegin',
              outerThis.getServerSuccessMsg(true, result.message)
            );

            // add finish message
            outerThis.removeFormAndTopDesc(section);
            if (window.toBeChanged) {
              if (formData.postType === 'title') {
                window.toBeChanged.setAttribute('story-title', formData.title);
              } else if (formData.postType === 'slug') {
                window.toBeChanged.setAttribute('slug', formData.slug);
              } else {
                window.toBeChanged.innerHTML = formData.content;
              }
              window.toBeChanged.setAttribute('reload', 'true');
              window.toBeChanged = null;
            }
          } else {
            // show error message
            actions.insertAdjacentHTML('beforebegin', outerThis.getServerSuccessMsg(false, result.message));

            // reset button
            button.innerHTML = '<span class="text">Post</span>';
            // enable pointer events
            button.style.pointerEvents = 'auto';
          }
        }
        catch (error) {
          // show error message
          actions.insertAdjacentHTML('beforebegin', outerThis.getServerSuccessMsg(false, 'An error occurred, please try again'));

          // reset button
          button.innerHTML = '<span class="text">Post</span>';
          // enable pointer events
          button.style.pointerEvents = 'auto';
        }

        // remove success message
        setTimeout(() => {
          const serverStatus = form.querySelector('.server-status');
          if (serverStatus) {
            serverStatus.remove();
          }
        }, 5000);
      });
    }

    validateTitleData = (form, title, actions) => {
      // check if title is valid
      if (!title) {
        // show error message
        actions.insertAdjacentHTML('beforebegin', this.getServerSuccessMsg(false, 'Title must be defined!'));

        setTimeout(() => {
          const serverStatus = form.querySelector('.server-status');
          if (serverStatus) {
            serverStatus.remove();
          }
        }, 5000);

        return false;
      }

      // validate if title is at least 2 characters
      if (title.length < 2) {
        // show error message
        actions.insertAdjacentHTML('beforebegin', this.getServerSuccessMsg(false, 'Title must be at least 2 characters'));

        setTimeout(() => {
          const serverStatus = form.querySelector('.server-status');
          if (serverStatus) {
            serverStatus.remove();
          }
        }, 5000);

        return false;
      }

      return true;
    }

    validateSlugData = (form, slug, actions) => {
      // check if slug is valid
      if (!slug) {
        // show error message
        actions.insertAdjacentHTML('beforebegin', this.getServerSuccessMsg(false, 'Slug must be defined!'));

        setTimeout(() => {
          const serverStatus = form.querySelector('.server-status');
          if (serverStatus) {
            serverStatus.remove();
          }
        }, 5000);

        return false;
      }

      // validate if slug is at least 3 characters
      if (slug.length < 3) {
        // show error message
        actions.insertAdjacentHTML('beforebegin', this.getServerSuccessMsg(false, 'Slug must be at least 3 characters'));

        setTimeout(() => {
          const serverStatus = form.querySelector('.server-status');
          if (serverStatus) {
            serverStatus.remove();
          }
        }, 5000);

        return false;
      }

      // check if slug is valid
      if (!/^[a-z0-9-]*$/.test(slug)) {
        // show error message
        actions.insertAdjacentHTML('beforebegin', this.getServerSuccessMsg(false, 'Slug can only contain letters, numbers, and hyphens and be in lowercase'));

        setTimeout(() => {
          const serverStatus = form.querySelector('.server-status');
          if (serverStatus) {
            serverStatus.remove();
          }
        }, 5000);

        return false;
      }

      return true;
    }

    validateContentData = (form, content, actions) => {
      // check if content is valid
      if (!content) {
        // show error message
        actions.insertAdjacentHTML('beforebegin', this.getServerSuccessMsg(false, 'Content must be defined!'));

        setTimeout(() => {
          const serverStatus = form.querySelector('.server-status');
          if (serverStatus) {
            serverStatus.remove();
          }
        }, 5000);

        return false;
      }

      // check if content is at least 100 characters
      if (content.length < 100) {
        // show error message
        actions.insertAdjacentHTML('beforebegin', this.getServerSuccessMsg(false, 'Content must be at least 100 characters'));

        setTimeout(() => {
          const serverStatus = form.querySelector('.server-status');
          if (serverStatus) {
            serverStatus.remove();
          }
        }, 5000);

        return false;
      }

      return true;
    }

    getFormData = form => {
      const postType = this._option;

      if (postType === 'title') {
        const data = new FormData(form);

        return {
          postType: postType,
          title: data.get('title')
        };
      } else if (postType === 'slug') {
        const data = new FormData(form);

        return {
          postType: postType,
          slug: data.get('slug')
        };
      } else {
        // get data from the editor
        const data = this.editor.getData();

        return {
          postType: postType,
          content: this.cleanWysiwygText(data)
        };
      }
    }

    cleanWysiwygText(input) {
      let cleanedText = input;

      // Step 1: Remove whitespace between tags
      cleanedText = cleanedText.replace(/>\s+</g, '><');

      // Step 2: Remove empty tags and tags with only &nbsp; or whitespace
      cleanedText = cleanedText.replace(/<(\w+)>(\s|&nbsp;)*<\/\1>/g, '');

      // Step 3: Remove <br> tags immediately after opening tags
      cleanedText = cleanedText.replace(/<(\w+)><br>/g, '<$1>');

      // Additional step: Remove <br> tags immediately before closing tags
      cleanedText = cleanedText.replace(/<br><\/(\w+)>/g, '</$1>');

      // Preserve <br> tags in the middle of content
      cleanedText = cleanedText.replace(/>(\s*<br>\s*)+</g, '><br><');

      return cleanedText;
    }

    fetchWithTimeout = async (url, options = {}, timeout = 9500) => {
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), timeout);

      try {
        const response = await fetch(url, {
          ...options,
          signal: controller.signal
        });

        return response;
      } catch (error) {
        if (error.name === 'AbortError') {
          throw new Error('Request timed out');
        }
        throw new Error(`Network error: ${error.message}`);
      } finally {
        clearTimeout(timeoutId);
      }
    }

    getServerSuccessMsg = (success, text) => {
      if (!success) {
        return `
        <p class="server-status">${text}</p>
      `
      }
      return `
      <p class="server-status success">${text}</p>
    `
    }

    getTemplate() {
      // Show HTML Here
      return /*html*/`
      <div class="content-wrapper">
        <div class="overlay"></div>
        <section id="content" class="content">
          ${this.getBody()}
        </section>
      </div>
      ${this.getStyles()}
    `
    }

    getBody = () => {
      return /* html */`
      <form class="fields post" id="post-form">
        ${this.getArticleOptions()}
        <div class="actions active">
          <span class="action-info">Publishing</span>
          <div class="buttons">
            <span class="action cancel-btn">
              <span class="text">Cancel</span>
            </span>
            <button type="submit" class="action submit">
              <span class="text">Next</span>
            </button>
          </div>
        </div>
      </form>
    `;
    }

    getArticleEditor = () => {
      return /* html */`
      <textarea name="editor" id="editor" cols="30" rows="10" placeholder="Type or paste your content hare!"></textarea>
    `;
    }

    getTitleField = () => {
      return /* html */`
      <div class="field">
        <label for="title">Title</label>
        <input type="text" name="title" id="title" placeholder="Enter the title of the article" required  value="${this._title}" />
        <span class="status"></span>
      </div>
    `;
    }

    getSlugField = () => {
      return /* html */`
      <div class="field">
        <label for="slug">Slug</label>
        <input type="text" name="slug" id="slug" placeholder="Enter a unique slug for the article" required value="${this.slug}" />
        <span class="status"></span>
      </div>
    `;
    }

    getArticleOptions = () => {
      return /* html */`
      <div class="post-type">
        <div class="types">
          <div class="type title">
            <h4 class="title">Title</h4>
            <p class="desc">
              Edit the title of the selected article.
            </p>
          </div>
          <div class="type slug">
            <h4 class="title">Slug</h4>
            <p class="desc">
              Edit the slug of the selected article.
            </p>
          </div>
          <div class="type content">
            <h4 class="title">Content</h4>
            <p class="desc">
              Modify the content of the selected article.
            </p>
          </div>
        </div>
      </div>
    `;
    }

    activateTitleType = form => {
      // select post-type
      const postType = form.querySelector('.post-type');
      // select the post type: title
      const titleType = form.querySelector('.post-type > .types > .type.title');
      // select actions
      const actions = form.querySelector('.actions');

      if (titleType && actions && postType) {
        titleType.addEventListener('click', e => {
          e.preventDefault();

          // update the option
          this._option = 'title';

          // get title editor
          const titleEditor = this.getTitleField();

          // Remove the post type
          postType.remove();

          // insert the poll editor
          form.insertAdjacentHTML('afterbegin', titleEditor);

          // activate the poll
          this.activateTitle(form);

          // add display flex to the actions
          actions.style.display = 'flex';
        });
      }
    }

    activateSlugType = form => {
      // select post-type
      const postType = form.querySelector('.post-type');
      // select the post type: slug
      const slugType = form.querySelector('.post-type > .types > .type.slug');
      // select actions
      const actions = form.querySelector('.actions');

      if (slugType && actions && postType) {
        slugType.addEventListener('click', e => {
          e.preventDefault();

          // update the option
          this._option = 'slug';

          // get slug editor
          const slugEditor = this.getSlugField();

          // Remove the post type
          postType.remove();

          // insert the poll editor
          form.insertAdjacentHTML('afterbegin', slugEditor);

          // activate the poll
          this.activateSlug(form);

          // add display flex to the actions
          actions.style.display = 'flex';
        });
      }
    }

    slugifyInput = (input) => {
      return input.replace(/\s+/g, '-')
        .replace(/[^a-z0-9-]/gi, '')
        .replace(/-{2,}/g, '-')
        .toLowerCase();
    }

    activateContentType = form => {
      // select post-type
      const postTypeMain = form.querySelector('.post-type');
      // select the post type: content
      const contentType = form.querySelector('.post-type > .types > .type.content');
      // select actions
      const actions = form.querySelector('.actions');

      if (contentType && actions && postTypeMain) {
        contentType.addEventListener('click', e => {
          e.preventDefault();

          // update the option
          this._option = 'content';

          // get content editor
          const contentEditor = this.getArticleEditor();

          // Remove the post type
          postTypeMain.remove();

          // insert the post editor
          form.insertAdjacentHTML('afterbegin', contentEditor);

          // activate the editor
          this.initEditor();

          // add display flex to the actions
          actions.style.display = 'flex';
        });
      }
    }

    getFinish = () => {
      return /* html */`
      <div class="finish">
        <h2 class="title">You're all set!</h2>
        <p class="desc">
          Your changes have been saved successfully, you can view the updated article by visiting the feeds or your profile page.
          You can now close this window.
        </p>
        <button class="finish">Close</button>
      </div>
    `;
    }

    activateFinish = finish => {
      const button = finish.querySelector('button.finish');
      if (button) {
        button.addEventListener('click', e => {
          e.preventDefault();
          this.remove();
        });
      }
    }

    removeFormAndTopDesc = section => {
      const form = section.querySelector('form');

      if (form) {
        form.remove();
      }

      // insert the finish message
      section.innerHTML = this.getFinish();

      const finish = this.querySelector('div.finish');

      // activate the finish button
      this.activateFinish(finish);
    }

    getButtonLoader() {
      return /*html*/`
      <span id="btn-loader">
				<span class="loader"></span>
			</span>
    `
    }

    getStyles() {
      return /* css */`
      <link rel="stylesheet" href="/static/css/ckeditor.css">
      <style>
        *,
        *:after,
        *:before {
          box-sizing: border-box !important;
          font-family: inherit;
          -webkit-box-sizing: border-box !important;
        }

        *:focus {
          outline: inherit !important;
        }

        *::-webkit-scrollbar {
          -webkit-appearance: none;
        }

        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
          padding: 0;
          margin: 0;
          font-family: inherit;
        }

        p,
        ul,
        ol {
          font-family: inherit;
        }

        a {
          text-decoration: none;
        }

        .content-wrapper {
          border: none;
          padding: 0;
          justify-self: end;
          display: flex;
          flex-flow: column;
          align-items: center;
          justify-content: center;
          gap: 10px;
          z-index: 100;
          width: 100%;
          min-width: 100vw;
          position: fixed;
          right: 0;
          top: 0;
          bottom: 0;
          left: 0;
        }

        div.overlay {
          position: absolute;
          top: 0;
          right: 0;
          bottom: 0;
          left: 0;
          height: 100%;
          width: 100%;
          background-color: var(--modal-background);
          backdrop-filter: blur(3px);
          -webkit-backdrop-filter: blur(3px);
        }

        #content {
          z-index: 1;
          background-color: var(--background);
          padding: 20px;
          display: flex;
          flex-flow: column;
          align-items: center;
          justify-content: start;
          gap: 10px;
          width: 700px;
          max-height: 95%;
          height: 90%;
          height: max-content;
          border-radius: 15px;
          position: relative;
          scrollbar-width: none;
        }

        #content::-webkit-scrollbar {
          visibility: hidden;
          display: none;
        }

        p.server-status {
          margin: 0;
          width: 100%;
          text-align: start;
          font-family: var(--font-read), sans-serif;
          color: var(--error-color);
          font-weight: 500;
          line-height: 1.4;
          font-size: 1.18rem;
        }

        p.server-status.success {
          color: transparent;
          background: var(--accent-linear);
          background-clip: text;
          -webkit-background-clip: text;
        }

        #btn-loader {
          position: absolute;
          top: 0;
          left: 0;
          bottom: 0;
          right: 0;
          z-index: 5;
          display: flex;
          align-items: center;
          justify-content: center;
          border-radius: inherit;
        }

        #btn-loader > .loader {
          width: 20px;
          aspect-ratio: 1;
          --_g: no-repeat radial-gradient(farthest-side, #18A565 94%, #0000);
          --_g1: no-repeat radial-gradient(farthest-side, #21D029 94%, #0000);
          --_g2: no-repeat radial-gradient(farthest-side, #df791a 94%, #0000);
          --_g3: no-repeat radial-gradient(farthest-side, #f09c4e 94%, #0000);
          background: var(--_g) 0 0,  var(--_g1) 100% 0, var(--_g2) 100% 100%, var(--_g3) 0 100%;
          background-size: 30% 30%;
          animation: l38 .9s infinite ease-in-out;
          -webkit-animation: l38 .9s infinite ease-in-out;
        }

        @keyframes l38 {
          100% {
            background-position: 100% 0, 100% 100%, 0 100%, 0 0
          }
        }

        h2.pop-title {
          width: 100%;
          font-size: 1.35rem;
          font-weight: 600;
          margin: 0;
          padding: 10px 10px;
          background-color: var(--gray-background);
          text-align: center;
          border-radius: 12px;
          font-family: var(--font-read), sans-serif;
          color: var(--text-color);
          font-weight: 500;
          position: relative;
        }

        h2.pop-title > span.control {
          padding: 0;
          cursor: pointer;
          display: flex;
          flex-flow: column;
          gap: 0px;
          justify-content: center;
          position: absolute;
          top: 50%;
          left: 10px;
          transform: translateY(-50%);
        }

        h2.pop-title > span.control svg {
          width: 21px;
          height: 21px;
          color: var(--text-color);
        }

        h2.pop-title > span.control svg:hover{
          color: var(--error-color);
        }

        .top {
          display: flex;
          flex-flow: column;
          gap: 5px;
          padding: 0;
          width: 100%;
        }

        .top > .desc {
          margin: 0;
          padding: 10px 0 20px;
          color: var(--text-color);
          font-size: 0.95rem;
          font-family: var(--font-main), sans-serif;
        }

        .top > .desc > span {
          display: inline-block;
          margin: 10px 0 5px;
          color: var(--gray-color);
          font-size: 0.85rem;
          font-style: italic;
          font-family: var(--font-read), sans-serif;
        }

        form.fields {
          margin: 0;
          width: 100%;
          min-width: 100%;
          height: auto;
          display: flex;
          flex-flow: column;
          justify-content: center;
          align-items: center;
          gap: 0;
        }

        div.post-type {
          width: 100%;
          display: flex;
          flex-flow: column;
          gap: 15px;
          padding: 10px 0;
        }

        div.post-type > h2.title {
          width: 100%;
          margin: 0;
          padding: 0;
          font-size: 1.25rem;
          text-align: center;
          font-weight: 500;
          font-family: var(--font-main), sans-serif;
          color: var(--text-color);
        }

        div.post-type > div.types {
          width: 100%;
          display: flex;
          flex-flow: row;
          gap: 20px;
        }

        div.post-type > div.types > div.type {
          width: 100%;
          display: flex;
          flex-flow: column;
          gap: 0px;
          padding: 9px 11px;
          border-radius: 12px;
          background: var(--create-background);
          cursor: pointer;
        }

        div.post-type > div.types > div.type:hover {
          background: var(--background);
          border: var(--border);
          padding: 8px 10px;
        }

        div.post-type > div.types > div.type > h4.title {
          margin: 0;
          padding: 0;
          font-size: 1.1rem;
          font-weight: 500;
          font-family: var(--font-main), sans-serif;
          color: var(--text-color);
        }

        div.post-type > div.types > div.type > p.desc {
          margin: 0;
          padding: 5px 0;
          font-size: 0.85rem;
          font-family: var(--font-read), sans-serif;
          color: var(--gray-color);
        }

        form.fields > .field {
          width: 100%;
          display: flex;
          flex-flow: column;
          justify-content: center;
          align-items: start;
          gap: 0;
        }

        form.fields > .field.polls {
          padding: 10px 0 0 0;
        }

        form.fields > .field.polls > span.title {
          display: none;
          margin: 0;
          padding: 0 0 10px 3px;
          color: var(--text-color);
          font-size: 1rem;
          font-weight: 600;
          font-family: var(--font-main), sans-serif;
        }

        form.fields > .field.polls > .poll-inputs {
          width: 100%;
          display: flex;
          flex-flow: column;
          justify-content: center;
          align-items: start;
          gap: 15px;
        }

        form.fields > .field.polls > .poll-inputs.texts {
          margin: 0 0 18px;
        }

        form.fields label {
          padding: 0 0 1px 5px;
          color: var(--text-color);
        }

        form.fields label {
          color: var(--label-color);
          margin: 20px 0 5px 0;
          font-size: 1.1rem;
          font-family: var(--font-read), sans-serif;
          transition: all 0.3s ease-in-out;
          pointer-events: none;
        }

        form.fields .field input {
          border: var(--input-border);
          border: none;
          transition: border-color 0.3s ease-in-out;
          background: var(--background);
          font-family: var(--font-read), sans-serif;
          font-size: 1rem;
          width: 100%;
          height: 40px;
          outline: none;
          margin: 0 0 20px;
          padding: 10px 12px;
          border-radius: 12px;
          color: var(--text-color);
          -webkit-border-radius: 12px;
          -moz-border-radius: 12px;
          -ms-border-radius: 12px;
          -o-border-radius: 12px;
        }

        form.fields .field input {
          border: none;
          border: var(--border);
          font-family: var(--font-read), sans-serif;
          background-color: var(--background) !important;
          font-size: 1rem;
          width: 100%;
          height: 40px;
          outline: none;
          padding: 10px 12px;
          border-radius: 12px;
          color: var(--text-color);
        }
        
        form.fields .field input:-webkit-autofill,
        form.fields .field input:-webkit-autofill:hover, 
        form.fields .field input:-webkit-autofill:focus {
          -webkit-box-shadow: 0 0 0px 1000px var(--background) inset;
          -webkit-text-fill-color: var(--text-color) !important;
          transition: background-color 5000s ease-in-out 0s;
          color: var(--text-color) !important;
        }
        
        form.fields .field input:autofill {
          filter: none;
          color: var(--text-color) !important;
        }

        form.fields .field input:focus {
          border: var(--input-border-focus);
        }

        form.fields textarea {
          border: none;
          border: var(--border);
          font-family: var(--font-read), sans-serif;
          background: var(--background);
          font-size: 1rem;
          padding: 10px 12px;
          margin: 0;
          width: 100%;
          resize: none;
          height: 120px;
          gap: 5px;
          font-weight: 400;
          color: var(--text-color);
          -ms-overflow-style: none;
          scrollbar-width: none;
          border-radius: 12px;
        }

        form.fields textarea::-webkit-scrollbar {
          display: none !important;
          visibility: hidden;
        }

        form.fields textarea:focus {
          border: var(--input-border-focus);
        }

        form.fields .field span.wrapper {
          display: flex;
          align-items: center;
          align-items: center;
          gap: 0;
          width: 100%;
        }

        form.fields .field.success > span.wrapper > input,
        form.fields .field.success > span.wrapper > input:focus,
        form.fields .field.success input,
        form.fields .field.success input:focus {
          border: var(--input-border-focus);
        }

        form.fields .field.failed > span.wrapper > input,
        form.fields .field.failed > span.wrapper > input:focus,
        form.fields .field.failed input,
        form.fields .field.failed input:focus {
          border: var(--input-border-error);
        }

        form.fields .field.success span.wrapper > input,
        form.fields .field.success input {
          color: var(--accent-color);
        }

        form.fields .field.failed span.wrapper > input,
        form.fields .field.failed input {
          color: var(--error-color);
        }

        form.fields label.focused {
          top: -10px;
          font-size: 0.9rem;
          background-color: var(--label-focus-background);
          padding: 0 5px;
        }

        form.fields .field span.status {
          color: var(--error-color);
          font-size: 0.95rem;
          display: none;
          padding: 0 0 0 5px;
        }

        form.fields .field.failed span.status {
          color: var(--error-color);
          font-size: 0.8rem;
          display: inline-block;
        }

        form.fields .field.success span.status {
          color: var(--accent-color);
          font-size: 0.8rem;
          display: inline-block;
        }

        form.fields .field.success span.status {
          display: none;
        }

        form.fields .actions {
          border-top: var(--border);
          display: flex;
          align-items: center;
          justify-content: space-between;
          width: 100%;
          height: max-content;
          gap: 20px;
          margin: 0;
          padding: 10px 0 0;
        }

        form.fields .actions.active {
          border-top: var(--input-border-focus);
        }

        form.fields .actions > span.action-info {
          color: var(--gray-color);
          font-size: 0.95rem;
          font-family: var(--font-read), sans-serif;
          font-weight: 400;
          line-height: 1.5;
        }

        form.fields .actions > .buttons {
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 20px;
          margin: 0;
        }

        form.fields .actions .action {
          background: var(--gray-background);
          color: var(--gray-color);
          border: none;
          font-family: var(--font-main), sans-serif;
          text-decoration: none;
          font-size: 1rem;
          font-weight: 600;
          cursor: pointer;
          display: flex;
          flex-flow: row;
          align-items: center;
          text-transform: capitalize;
          justify-content: center;
          padding: 7px 15px 8px;
          min-height: 35px;
          height: 35px;
          min-width: 60px;
          width: max-content;
          position: relative;
          border-radius: 50px;
          -webkit-border-radius: 50px;
          -moz-border-radius: 50px;
        }

        form.fields .actions .action.cancel-btn {
          background: var(--gray-background);
          color: var(--gray-color);
        }

        form.fields .actions.active .action.submit {
          border: none;
          background: var(--accent-linear);
          font-family: var(--font-main), sans-serif;
          text-decoration: none;
          color: var(--white-color);
        }

        form.fields .actions > .action.disabled {
          pointer-events: none;
        }

        div.finish {
          padding: 15px 0;
          width: 100%;
          min-width: 100%;
          height: auto;
          display: flex;
          flex-flow: column;
          justify-content: center;
          align-items: center;
          gap: 15px;
        }

        div.finish > h2.title {
          margin: 0;
          font-size: 1.25rem;
          font-weight: 600;
          font-family: var(--font-main), sans-serif;
          color: var(--text-color);
        }

        div.finish > p.desc {
          margin: 0;
          font-size: 0.95rem;
          font-family: var(--font-read), sans-serif;
          color: var(--text-color);
          line-height: 1.4;
          text-align: center;
        }

        div.finish > button.finish {
          border: none;
          background: var(--accent-linear);
          font-family: var(--font-main), sans-serif;
          text-decoration: none;
          color: var(--white-color);
          font-size: 1rem;
          font-weight: 600;
          cursor: pointer;
          display: flex;
          width: max-content;
          flex-flow: row;
          align-items: center;
          text-transform: capitalize;
          justify-content: center;
          padding: 7px 15px 8px;
          border-radius: 50px;
          -webkit-border-radius: 50px;
          -moz-border-radius: 50px;
        }

        #editor {
          min-width: 100%;
          width: 100%;
          overflow-y: auto;
          font-family: var(--font-main), sans-serif;
        }

        .ck.ck-editor__main > .ck-editor__editable {
          color: var(--editor-color);
        }

        .ck.ck-editor__main > .ck-editor__editable a {
          color: var(--anchor-color);
        }

        .ck-editor__editable_inline:not(.ck-comment__input *) {
          font-family: var(--font-main), sans-serif;
          overflow-y: auto;
        }

        .ck-editor__editable_inline {
          max-height: 70vh;
          min-height: 200px;
        }

        .ck-body-wrapper {
          display: none;
          opacity: 0;
          visibility: hidden;
        }

        .ck.ck-reset.ck-editor {
          display: -webkit-box;
          display: -moz-box;
          display: -ms-flexbox;
          display: -webkit-flex;
          display: flex;
          -webkit-flex-direction: column;
          -moz-flex-direction: column;
          -ms-flex-direction: column;
          flex-direction: column;
        }

        .ck-focused, .ck.ck-editor__editable:not(.ck-editor__nested-editable).ck-focused {
          border: none;
          border: none;
          outline: none !important;
          -moz-outline: none !important;
          -webkit-outline: none !important;
          -ms-outline: none !important;
          -webkit-box-shadow: none;
          -moz-box-shadow: none;
          box-shadow: none
        }

        * {
          line-height: 1.3;
          color: inherit;
          font-family: inherit;
        }

        h6,
        h5,
        h4,
        h3,
        h1 {
          padding: 0;
          color: var(--title-color);
          font-weight: 500;
          line-height: 1.5;
          margin: 10px 0;
          font-family: var(--font-main), sans-serif;
        }

        h6 {
          font-size: initial;
        }

        h5 {
          font-size: initial;
        }

        h4 {
          font-size: 1.25rem;
        }

        h3 {
          font-size: 1.3rem !important;;
        }

        h2 {
          font-size: 1.35rem !important;
          color: var(--title-color);
          font-weight: 600;
          line-height: 1.2;
          margin: 0;
          padding: 2px 0 0 13px;
          margin: 20px 0 10px;
          position: relative;
        }

        h2:before {
          content: "";
          position: absolute;
          bottom: 10%;
          left: 0;
          width: 2px;
          height: 80%;
          background: var(--action-linear);
          border-radius: 5px;
        }

        p {
          margin: 5px 0;
          line-height: 1.4;
        }

        a {
          text-decoration: none;
          cursor: pointer;
          color: var(--anchor-color) !important;
        }

        a:hover {
          text-decoration: underline;
        }

        blockquote {
          margin: 10px 0;
          padding: 5px 15px;
          font-style: italic;
          border-left: 2px solid var(--gray-color);
          background: var(--background);
          color: var(--text-color);
          font-weight: 400;
        }

        blockquote:before {
          content: open-quote;
          color: var(--gray-color);
          font-size: 1.5rem;
          line-height: 1;
          margin: 0 0 0 -5px;
        }

        blockquote:after {
          content: close-quote;
          color: var(--gray-color);
          font-size: 1.5rem;
          line-height: 1;
          margin: 0 0 0 -5px;
        }

        hr {
          border: none;
          background-color: var(--gray-color);
          height: 1px;
          margin: 10px 0;
        }

        ul,
        ol {
          margin: 5px 0 15px 20px;
          padding: 0 0 0 15px;
          color: inherit;
        }

        ul li,
        ol li {
          padding: 5px 0;
        }

        code {
          background: var(--gray-background);
          padding: 0 5px;
          font-family: var(--font-mono);
          font-size: 0.9rem;
          border-radius: 5px;
        }

        figure {
          max-width: 100% !important;
          height: auto;
          width: max-content;
          padding: 0;
          max-width: 100%;
          display: block;
          margin-block-start: 5px;
          margin-block-end: 5px;
          margin-inline-start: 0 !important;
          margin-inline-end: 0 !important;
        }

        img {
          max-width: 100%;
          height: auto;
          object-fit: contain;
          border-radius: 5px;
        }

        @media screen and (max-width:600px) {
          .content-wrapper {
            border: none;
            background-color: var(--modal-background);
            padding: 0px;
            justify-self: end;
            display: flex;
            flex-flow: column;
            align-items: center;
            justify-content: end;
            gap: 10px;
            z-index: 20;
            position: fixed;
            right: 0;
            top: 0;
            bottom: 0;
            left: 0;
            min-width: 100dvw;
            min-height: 100dvh;
          }

          #content {
            box-sizing: border-box !important;
            padding: 5px 10px 10px;
            margin: 0;
            position: fixed;
            top: 0;
            right: 0;
            left: 0;
            bottom: 0;
            width: 100%;
            max-width: 100%;
            height: 100dvh;
            min-height: 100dvh;
            border-radius: 0;
          }

          #content span.control {
            cursor: default !important;
          }

          ::-webkit-scrollbar {
            -webkit-appearance: none;
          }

          h2.pop-title {
            width: 100%;
            font-size: 1.2rem;
            padding: 10px 10px;
            background-color: var(--gray-background);
            text-align: center;
            border-radius: 12px;
          }

          .top > .desc {
            margin: 0;
            padding: 6px 0 10px;
            font-size: 0.95rem;
            line-height: 1.5;
            font-family: var(--font-main), sans-serif;
          }

          div.finish {
            padding: 25px 0;
            width: 100%;
            min-width: 100%;
            height: auto;
            display: flex;
            flex-flow: column;
            justify-content: center;
            align-items: center;
            gap: 18px;
          }

          div.post-type > div.types {
            width: 100%;
            display: flex;
            flex-flow: column;
            gap: 20px;
          }

          form.fields .actions {
            align-items: center;
            width: 100%;
            gap: 25px;
          }

          div.finish > button.finish {
            margin: 10px 0 0;
          }

          form.fields > .field.polls > div.remove > span.remove-poll,
          form.fields > .field.polls > .poll-inputs > span.add-option,
          div.post-type > div.types > div.type,
          div.finish > button.finish,
          form.fields .actions .action,
          div.finish > button.finish {
            cursor: default !important;
          }

          .ck-editor__editable_inline:not(.ck-comment__input *) {
            overflow-y: auto;
          }

          .ck-editor__editable_inline {
            max-height: calc(100dvh - 100px);
            height: calc(100dvh - 100px);
          }
        }
      </style>
    `;
    }
  }

  class CreateReply extends HTMLDivElement {
    constructor() {
      // We are not even going to touch this.
      super();

      this.content = null;
      this.editor = null;

      this.hash = this.getAttribute('hash');

      this._url = this.getAttribute('api');

      this.kind = this.getAttribute('kind');

      this.render();
    }

    render() {
      // this.shadowObj.innerHTML = this.getTemplate();
      this.innerHTML = this.getTemplate();
    }

    connectedCallback() {
      // select the form
      const form = this.querySelector('form');

      // select the section
      const section = this.querySelector('section#content');

      if (form && section) {
        // add event listener to the form
        this.submitForm(form, section);

        this.growTextarea(form);
      }

      const btns = this.querySelectorAll('.cancel-btn');
      const overlay = this.querySelector('.overlay');

      // Close the modal
      if (overlay && btns) {
        this.closePopup(overlay, btns);
      }

      this.disableScroll();
    }

    growTextarea = form => {
      const input = form.querySelector('textarea#editor');
      const actions = form.querySelector('.actions');
      
      if (form && actions) {
        const adjustRows = () => {
          const maxRows = 7;
          const style = window.getComputedStyle(input);
          const lineHeight = parseInt(style.lineHeight, 10);
          
          // Calculate the height offset (padding + border)
          const paddingHeight = parseInt(style.paddingTop, 10) + parseInt(style.paddingBottom, 10);
          const borderHeight = parseInt(style.borderTopWidth, 10) + parseInt(style.borderBottomWidth, 10);
          const offset = paddingHeight + borderHeight;
    
          // Reset the rows to 1 to calculate the new height
          input.rows = 1;
    
          // Calculate the number of rows based on scrollHeight minus the offset
          const newRows = Math.ceil((input.scrollHeight - offset) / lineHeight);
          input.rows = Math.min(maxRows, Math.max(newRows, 1)); // Ensure at least 1 row
    
          // Toggle actions visibility based on input
          if (input.value.trim().length > 0) {
            actions.classList.add('active');
          } else {
            actions.classList.remove('active');
          }
        };
    
        input.addEventListener('input', adjustRows);
        input.addEventListener('paste', adjustRows);
        
        // Initial adjustment on page load
        adjustRows();
      }
    };    

    disconnectedCallback() {
      this.enableScroll();
    }

    closePopup = (overlay, btns) => {
      overlay.addEventListener('click', e => {
        e.preventDefault();
        this.remove();
      });

      btns.forEach(btn => {
        btn.addEventListener('click', e => {
          e.preventDefault();
          this.remove();
        });
      });
    }

    disableScroll() {
      // Get the current page scroll position
      let scrollTop = window.scrollY || document.documentElement.scrollTop;
      let scrollLeft = window.scrollX || document.documentElement.scrollLeft;
      document.body.classList.add("stop-scrolling");

      // if any scroll is attempted, set this to the previous value
      window.onscroll = function () {
        window.scrollTo(scrollLeft, scrollTop);
      };
    }

    enableScroll() {
      document.body.classList.remove("stop-scrolling");
      window.onscroll = function () { };
    }

    submitForm = async (form, section) => {
      const outerThis = this;
      // add submit event listener
      form.addEventListener('submit', async e => {
        e.preventDefault();

        const serverStatus = form.querySelector('.server-status');

        // if server status is already showing, remove it
        if (serverStatus) {
          serverStatus.remove();
        }

        const button = form.querySelector('.action.submit');
        const actions = form.querySelector('.actions');

        // show loader inside the button
        button.innerHTML = this.getButtonLoader();
        // disable pointer events
        button.style.pointerEvents = 'none';

        // get the editor data
        const data = new FormData(form);

        const body = {
          content: data.get('editor')
        };

        // validate the editor data
        if (!this.validateData(form, body, actions)) {
          // reset button
          button.innerHTML = '<span class="text">Reply</span>';
          // enable pointer events
          button.style.pointerEvents = 'auto';

          return;
        }
        // get images-uploader: images attribute
        const imagesUploader = form.querySelector('images-uploader');
        let images = imagesUploader.getAttribute('images').split(',');

        images = images.filter(image => image.trim() !== '' && image !== 'null' && image.length > 5);
        
        // if length is greater than 0, add them to the body
        if (images.length > 0) {
          // Construct the body object
          body.images = images;
        }

        body.kind = this.kind;
        body.content = outerThis.processTextAreaInput(body.content);

        // send data to server
        const options = {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(body)
        };

        try {
          const response = await outerThis.fetchWithTimeout(this._url, options);
          const result = await response.json();

          // check if request was successful
          if (result.success) {
            // activate the finish step
            section.innerHTML = this.getFinish();
            this.activateFinish();
          } else {
            // show error message
            actions.insertAdjacentHTML('beforebegin', outerThis.getServerSuccessMsg(false, result.message));

            // reset button
            button.innerHTML = '<span class="text">Reply</span>';
            // enable pointer events
            button.style.pointerEvents = 'auto';
          }
        }
        catch (error) {
          console.error(error);
          // show error message
          actions.insertAdjacentHTML('beforebegin', outerThis.getServerSuccessMsg(false, 'An error occurred, please try again'));

          // reset button
          button.innerHTML = '<span class="text">Reply</span>';
          // enable pointer events
          button.style.pointerEvents = 'auto';
        }

        // remove success message
        setTimeout(() => {
          const serverStatus = form.querySelector('.server-status');
          if (serverStatus) {
            serverStatus.remove();
          }
        }, 5000);
      });
    }

    processTextAreaInput = input => {
      return input
        .split('\n') // Split the input by new lines
        .map(line => line.trim()) // Trim each line to remove spaces
        .filter(line => line.length > 0) // Remove empty lines
        .map(line => `<p>${this.escapeHtml(line)}</p>`)  // Surround each line with <p> tags
        .join(''); // Join the array back into a single string
    }

    escapeHtml = html => {
      const text = document.createTextNode(html);
      const div = document.createElement('div');
      div.appendChild(text);
      return div.innerHTML; // Return the escaped HTML
    }

    validateData = (form, reply, actions) => {
      // check if post reply is valid
      if (!reply) {
        // show error message
        actions.insertAdjacentHTML('beforebegin', this.getServerSuccessMsg(false, "Reply content cannot be empty!"));

        setTimeout(() => {
          const serverStatus = form.querySelector('.server-status');
          if (serverStatus) {
            serverStatus.remove();
          }
        }, 5000);

        return false;
      }

      // clone the data
      let content = reply;

      if (content.length < 3) {
        // show error message
        actions.insertAdjacentHTML('beforebegin', this.getServerSuccessMsg(false, 'Reply content must be at least 3 characters'));

        setTimeout(() => {
          const serverStatus = form.querySelector('.server-status');
          if (serverStatus) {
            serverStatus.remove();
          }
        }, 5000);

        return false;
      }
        
      return true;
    }

    fetchWithTimeout = async (url, options = {}, timeout = 9500) => {
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), timeout);
    
      try {
        const response = await fetch(url, {
          ...options,
          signal: controller.signal
        });

        return response;
      } catch (error) {
        if (error.name === 'AbortError') {
          throw new Error('Request timed out');
        }
        throw new Error(`Network error: ${error.message}`);
      } finally {
        clearTimeout(timeoutId);
      }
    }

    getServerSuccessMsg = (success, text) => {
      if (!success) {
        return `
        <p class="server-status">${text}</p>
      `
      }
      return `
      <p class="server-status success">${text}</p>
    `
    }

    getTemplate() {
      // Show HTML Here
      return /*html*/`
      <div class="content-wrapper">
        <div class="overlay"></div>
        <section id="content" class="content">
          ${this.getBody()}
        </section>
      </div>
    ${this.getStyles()}`
    }

    getBody = () => {
      return /* html */`
      <reply-post hash="${this.getAttribute('hash')}" preview-title="${this.getAttribute('preview-title')}" time="${this.getAttribute('time')}"
        author-you="${this.getAttribute('author-you')}"
        author-hash="${this.getAttribute('author-hash')}" author-img="${this.getAttribute('author-img')}" author-name="${this.getAttribute('author-name')}"
        author-stories="${this.getAttribute('author-stories')}" author-replies="${this.getAttribute('author-replies')}"
        author-followers="${this.getAttribute('author-followers')}" author-following="${this.getAttribute('author-following')}" author-follow="${this.getAttribute('author-follow')}"
        author-verified="${this.getAttribute('author-verified')}" author-url="${this.getAttribute('author-url')}" author-contact='${this.getAttribute("author-contact")}'
        author-bio="${this.getAttribute('author-bio')}">
        ${this.innerHTML}
      </reply-post>
      <form class="fields" id="topic-form">
        <div class="fields-container">
          ${this.getReplyEditor()}
          ${this.getImagesEditor()}
        </div>
        <div class="actions">
          <span class="hash">${this.hash}</span>
          <div class="buttons">
            <span class="action cancel-btn">
              <span class="text">Cancel</span>
            </span>
            <button type="submit" class="action submit">
              <span class="text">Reply</span>
            </button>
          </div>
        </div>
      </form>
    `;
    }

    getReplyEditor = () => {
      return /* html */`
      <textarea name="editor" id="editor" cols="30" rows="1" placeholder="Type your reply here!" required></textarea>
    `;
    }

    getFinish = () => {
      return /* html */`
      <div class="finish">
        <h2 class="title">You're all set!</h2>  
        <p class="desc">
          Your reply has been successfully created.
          To edit your reply, visit settings page then your content. You can now close this window.
        </p>
        <button class="finish">Close</button>
      </div>
    `;
    }

    activateFinish = () => {
      const button = this.querySelector('section#content button.finish');
      if (button) {
        button.addEventListener('click', e => {
          e.preventDefault();
          
          // close the modal
          this.remove();
        });
      }
    }

    getImagesEditor = () => {
      return /* html */`
      <images-uploader api="/api/v1/i/upload" multiple="true" accept="image/*" max="10" images=''></images-uploader>
    `;
    }

    getButtonLoader() {
      return /*html*/`
      <span id="btn-loader">
				<span class="loader"></span>
			</span>
    `
    }

    getStyles() {
      return /* css */`
      <style>
        *,
        *:after,
        *:before {
          box-sizing: border-box !important;
          font-family: inherit;
          -webkit-box-sizing: border-box !important;
        }

        *:focus {
          outline: inherit !important;
        }

        *::-webkit-scrollbar {
          -webkit-appearance: none;
        }

        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
          padding: 0;
          margin: 0;
          font-family: inherit;
        }

        p,
        ul,
        ol {
          padding: 0;
          margin: 0;
        }

        a {
          text-decoration: none;
        }

        .content-wrapper {
          border: none;
          padding: 0;
          justify-self: end;
          display: flex;
          flex-flow: column;
          align-items: center;
          justify-content: center;
          gap: 10px;
          z-index: 100;
          width: 100%;
          min-width: 100vw;
          position: fixed;
          right: 0;
          top: 0;
          bottom: 0;
          left: 0;
        }

        div.overlay {
          position: absolute;
          top: 0;
          right: 0;
          bottom: 0;
          left: 0;
          height: 100%;
          width: 100%;
          background-color: var(--modal-background);
          backdrop-filter: blur(3px);
          -webkit-backdrop-filter: blur(3px);
        }

        #content {
          z-index: 1;
          background-color: var(--background);
          padding: 20px 18px 15px;
          display: flex;
          flex-flow: column;
          align-items: center;
          justify-content: start;
          gap: 0;
          width: 700px;
          height: max-content;
          border-radius: 15px;
          position: relative;
          overflow-y: auto;
        }

        p.server-status {
          margin: 0;
          width: 100%;
          text-align: start;
          font-family: var(--font-read), sans-serif;
          color: var(--error-color);
          font-weight: 500;
          line-height: 1.4;
          font-size: 1.18rem;
        }

        p.server-status.success {
          color: transparent;
          background: var(--accent-linear);
          background-clip: text;
          -webkit-background-clip: text;
        }

        #btn-loader {
          position: absolute;
          top: 0;
          left: 0;
          bottom: 0;
          right: 0;
          z-index: 5;
          display: flex;
          align-items: center;
          justify-content: center;
          border-radius: inherit;
        }

        #btn-loader > .loader {
          width: 20px;
          aspect-ratio: 1;
          --_g: no-repeat radial-gradient(farthest-side, #18A565 94%, #0000);
          --_g1: no-repeat radial-gradient(farthest-side, #21D029 94%, #0000);
          --_g2: no-repeat radial-gradient(farthest-side, #df791a 94%, #0000);
          --_g3: no-repeat radial-gradient(farthest-side, #f09c4e 94%, #0000);
          background:    var(--_g) 0 0,    var(--_g1) 100% 0,    var(--_g2) 100% 100%,    var(--_g3) 0 100%;
          background-size: 30% 30%;
          animation: l38 .9s infinite ease-in-out;
          -webkit-animation: l38 .9s infinite ease-in-out;
        }

        @keyframes l38 {
          100% {
            background-position: 100% 0, 100% 100%, 0 100%, 0 0
          }
        }

        span.control svg {
          width: 15px;
          height: 15px;
          color: var(--text-color);
        }

        span.control svg:hover{
          color: var(--error-color);
        }

        .top {
          display: flex;
          flex-flow: column;
          gap: 5px;
          padding: 0;
          width: 100%;
        }

        .top > .desc {
          margin: 0;
          padding: 10px 0 20px;
          color: var(--text-color);
          font-size: 0.95rem;
          font-family: var(--font-main), sans-serif;
        }

        .top > .desc > span {
          display: inline-block;
          margin: 10px 0 5px;
          color: var(--gray-color);
          font-size: 0.85rem;
          font-style: italic;
          font-family: var(--font-read), sans-serif;
        }

        form.fields {
          margin: 5px 0 0 0;
          position: relative;
          width: 100%;
          display: flex;
          flex-flow: column;
          justify-content: center;
          align-items: center;
          gap: 0;
        }

        form.fields::before {
          content: '';
          display: block;
          position: absolute;
          top: -10px;
          left: 2px;
          width: 2px;
          min-height: 10px;
          height: 10px;
          background: var(--action-linear);
          border-radius: 5px;
        }

        form.fields > .fields-container {
          width: 100%;
          display: flex;
          flex-flow: column;
          justify-content: center;
          align-items: start;
          gap: 0;
        }

        form.fields > .fields-container > .field {
          width: 100%;
          display: flex;
          flex-flow: column;
          justify-content: center;
          align-items: start;
          gap: 5px;
        }

        form.fields label {
          padding: 0 0 1px 5px;
          color: var(--text-color);
        }

        form.fields label {
          color: var(--label-color);
          margin: 20px 0 0 0;
          font-size: 1.1rem;
          font-family: var(--font-read), sans-serif;
          transition: all 0.3s ease-in-out;
          pointer-events: none;
        }

        form.fields .field input {
          border: var(--input-border);
          border: none;
          transition: border-color 0.3s ease-in-out;
          background: var(--background);
          font-family: var(--font-read), sans-serif;
          font-size: 1rem;
          width: 100%;
          height: 40px;
          outline: none;
          padding: 10px 12px;
          border-radius: 12px;
          color: var(--text-color);
          -webkit-border-radius: 12px;
          -moz-border-radius: 12px;
          -ms-border-radius: 12px;
          -o-border-radius: 12px;
        }

        form.fields .field input {
          border: none;
          border: var(--border);
          font-family: var(--font-read), sans-serif;
          background-color: var(--background) !important;
          font-size: 1rem;
          width: 100%;
          height: 40px;
          outline: none;
          padding: 10px 12px;
          border-radius: 12px;
          color: var(--text-color);
        }
        
        form.fields .field input:-webkit-autofill,
        form.fields .field input:-webkit-autofill:hover, 
        form.fields .field input:-webkit-autofill:focus {
          -webkit-box-shadow: 0 0 0px 1000px var(--background) inset;
          -webkit-text-fill-color: var(--text-color) !important;
          transition: background-color 5000s ease-in-out 0s;
          color: var(--text-color) !important;
        }
        
        form.fields .field input:autofill {
          filter: none;
          color: var(--text-color) !important;
        }

        form.fields .field input:focus {
          border: var(--input-border-focus);
        }

        form.fields textarea {
          border: none;
          /* border: var(--border); */
          font-family: var(--font-main), sans-serif;
          background: var(--background);
          font-size: 1rem;
          padding: 0 0 7px 0;
          margin: 5px 0 0 0;
          width: 100%;
          resize: none;
          height: auto;
          line-height: 1.5;
          scroll-padding-top: 7px;
          scroll-padding-bottom: 7px;
          gap: 5px;
          font-weight: 400;
          color: var(--text-color);
          scrollbar-width: 3px;
          border-radius: 0;
        }

        form.fields textarea::-webkit-scrollbar {
          width: 3px;
          -webkit-appearance: auto;
        }

        form.fields textarea:focus {
          border: none;
        }

        form.fields .field span.wrapper {
          display: flex;
          align-items: center;
          align-items: center;
          gap: 0;
          width: 100%;
        }

        form.fields .field.success > span.wrapper > input,
        form.fields .field.success > span.wrapper > input:focus,
        form.fields .field.success input,
        form.fields .field.success input:focus {
          border: var(--input-border-focus);
        }

        form.fields .field.failed > span.wrapper > input,
        form.fields .field.failed > span.wrapper > input:focus,
        form.fields .field.failed input,
        form.fields .field.failed input:focus {
          border: var(--input-border-error);
        }

        form.fields .field.success span.wrapper > input,
        form.fields .field.success input {
          color: var(--accent-color);
        }

        form.fields .field.failed span.wrapper > input,
        form.fields .field.failed input {
          color: var(--error-color);
        }

        form.fields label.focused {
          top: -10px;
          font-size: 0.9rem;
          background-color: var(--label-focus-background);
          padding: 0 5px;
        }

        form.fields .field span.status {
          color: var(--error-color);
          font-size: 0.95rem;
          display: none;
          padding: 0 0 0 5px;
        }

        form.fields .field.failed span.status {
          color: var(--error-color);
          font-size: 0.8rem;
          display: inline-block;
        }

        form.fields .field.success span.status {
          color: var(--accent-color);
          font-size: 0.8rem;
          display: inline-block;
        }

        form.fields .field.success span.status {
          display: none;
        }

        form.fields .actions {
          border-top: var(--border);
          display: flex;
          align-items: center;
          justify-content: space-between;
          width: 100%;
          gap: 20px;
          margin: 0;
          padding: 10px 0 0;
        }

        form.fields .actions.active {
          border-top: var(--input-border-focus);
        }

        form.fields .actions > span.hash {
          color: transparent;
          background: var(--action-linear);
          background-clip: text;
          -webkit-background-clip: text;
          font-family: var(--font-mono), monospace;
          font-size: 0.95rem;
          line-height: 1.5;
          font-weight: 500;
        }

        form.fields .actions > .buttons {
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 20px;
          margin: 0;
        }

        form.fields .actions .action {
          background: var(--gray-background);
          color: var(--gray-color);
          border: none;
          font-family: var(--font-main), sans-serif;
          text-decoration: none;
          font-size: 1rem;
          font-weight: 600;
          cursor: pointer;
          display: flex;
          flex-flow: row;
          align-items: center;
          text-transform: capitalize;
          justify-content: center;
          padding: 7px 15px 8px;
          min-height: 35px;
          height: 35px;
          min-width: 60px;
          width: max-content;
          position: relative;
          border-radius: 50px;
          -webkit-border-radius: 50px;
          -moz-border-radius: 50px;
        }

        form.fields .actions .action.cancel-btn {
          background: var(--gray-background);
          color: var(--gray-color);
        }

        form.fields .actions.active .action.submit {
          border: none;
          background: var(--accent-linear);
          font-family: var(--font-main), sans-serif;
          text-decoration: none;
          color: var(--white-color);
        }

        form.fields .actions > .action.disabled {
          pointer-events: none;
        }

        div.finish {
          padding: 15px 0;
          width: 100%;
          min-width: 100%;
          height: auto;
          display: flex;
          flex-flow: column;
          justify-content: center;
          align-items: center;
          gap: 15px;
        }

        div.finish > h2.title {
          margin: 0;
          font-size: 1.25rem;
          font-weight: 600;
          font-family: var(--font-main), sans-serif;
          color: var(--text-color);
        }

        div.finish > p.desc {
          margin: 0;
          font-size: 0.95rem;
          font-family: var(--font-read), sans-serif;
          color: var(--text-color);
          line-height: 1.4;
          text-align: center;
        }

        div.finish > button.finish {
          border: none;
          background: var(--accent-linear);
          font-family: var(--font-main), sans-serif;
          text-decoration: none;
          color: var(--white-color);
          font-size: 1rem;
          font-weight: 600;
          cursor: pointer;
          display: flex;
          width: max-content;
          flex-flow: row;
          align-items: center;
          text-transform: capitalize;
          justify-content: center;
          padding: 7px 15px 8px;
          border-radius: 50px;
          -webkit-border-radius: 50px;
          -moz-border-radius: 50px;
        }

        .ck.ck-editor__main h6,
        .ck.ck-editor__main h5,
        .ck.ck-editor__main h4,
        .ck.ck-editor__main h3,
        .ck.ck-editor__main h1 {
          padding: 0;
          color: var(--title-color);
          font-weight: 500;
          line-height: 1.5;
          margin: 10px 0;
          font-family: var(--font-main), sans-serif;
        }

        .ck.ck-editor__main h6 {
          font-size: initial;
        }

        .ck.ck-editor__main h5 {
          font-size: initial;
        }

        .ck.ck-editor__main h4 {
          font-size: 1.25rem;
        }

        .ck.ck-editor__main h3 {
          font-size: 1.3rem !important;;
        }

        .ck.ck-editor__main h2 {
          font-size: 1.35rem !important;
          color: var(--title-color);
          font-weight: 600;
          line-height: 1.2;
          margin: 0;
          padding: 2px 0 0 13px;
          margin: 20px 0 10px;
          position: relative;
        }

        .ck.ck-editor__main h2:before {
          content: "";
          position: absolute;
          bottom: 10%;
          left: 0;
          width: 2px;
          height: 80%;
          background: var(--action-linear);
          border-radius: 5px;
        }

        .ck.ck-editor__main p {
          margin: 5px 0;
          line-height: 1.4;
        }

        .ck.ck-editor__main a {
          text-decoration: none;
          cursor: pointer;
          color: var(--anchor-color) !important;
        }

        .ck.ck-editor__main a:hover {
          text-decoration: underline;
        }

        .ck.ck-editor__main blockquote {
          margin: 10px 0;
          padding: 5px 15px;
          font-style: italic;
          border-left: 2px solid var(--gray-color);
          background: var(--background);
          color: var(--text-color);
          font-weight: 400;
        }

        .ck.ck-editor__main blockquote:before {
          content: open-quote;
          color: var(--gray-color);
          font-size: 1.5rem;
          line-height: 1;
          margin: 0 0 0 -5px;
        }

        .ck.ck-editor__main blockquote:after {
          content: close-quote;
          color: var(--gray-color);
          font-size: 1.5rem;
          line-height: 1;
          margin: 0 0 0 -5px;
        }

        .ck.ck-editor__main hr {
          border: none;
          background-color: var(--gray-color);
          height: 1px;
          margin: 10px 0;
        }

        .ck.ck-editor__main ul,
        .ck.ck-editor__main ol {
          margin: 5px 0 15px 20px;
          padding: 0 0 0 15px;
          color: inherit;
        }

        .ck.ck-editor__main ul li,
        .ck.ck-editor__main ol li {
          padding: 5px 0;
        }

        .ck.ck-editor__main code {
          background: var(--gray-background);
          padding: 0 5px;
          font-family: var(--font-mono);
          font-size: 0.9rem;
          border-radius: 5px;
        }

        .ck.ck-editor__main img {
          max-width: 100%;
          height: auto;
          object-fit: contain;
          border-radius: 5px;
        }

        img {
          max-width: 100%;
          height: auto;
          object-fit: contain;
          border-radius: 5px;
        }

        @media screen and (max-width:600px) {
          .content-wrapper {
            border: none;
            background-color: var(--modal-background);
            padding: 0px;
            justify-self: end;
            display: flex;
            flex-flow: column;
            align-items: center;
            justify-content: end;
            gap: 10px;
            z-index: 20;
            position: fixed;
            right: 0;
            top: 0;
            bottom: 0;
            left: 0;
            min-width: 100dvw;
            min-height: 100dvh;
          }

          #content {
            box-sizing: border-box !important;
            padding: 5px 15px 5px;
            margin: 0;
            position: fixed;
            right: 0;
            left: 0;
            bottom: 0;
            width: 100%;
            max-width: 100%;
            height: max-content;
            border-radius: 0;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
            overflow-y: auto;
          }

          #content span.control {
            cursor: default !important;
          }

          ::-webkit-scrollbar {
            -webkit-appearance: none;
          }

          h2.pop-title {
            width: 100%;
            font-size: 1.2rem;
            padding: 10px 10px;
            background-color: var(--gray-background);
            text-align: center;
            border-radius: 12px;
          }

          .top > .desc {
            margin: 0;
            padding: 6px 0 10px;
            font-size: 0.95rem;
            line-height: 1.5;
            font-family: var(--font-main), sans-serif;
          }

          div.finish {
            padding: 25px 0 10px;
            width: 100%;
            min-width: 100%;
            height: auto;
            display: flex;
            flex-flow: column;
            justify-content: center;
            align-items: center;
            gap: 18px;
          }

          div.post-type > div.types {
            width: 100%;
            display: flex;
            flex-flow: column;

            gap: 20px;
          }

          form.fields .actions {
            align-items: center;
            width: 100%;
            gap: 25px;
          }

          form.fields .actions .action.cancel-btn {
            display: none;
          }

          div.finish > button.finish {
            margin: 10px 0 0;
          }

          div.finish > button.finish,
          form.fields .actions .action {
            cursor: default !important;
          }
        }
      </style>
    `;
    }
  }

  class ImagesEditor extends HTMLDivElement {
    constructor() {
      super();
      this.api = this.getAttribute("api");
      this.uploadCount = this.getImagesLength(this.getAttribute("images"));
      this.maxUploads = 10;
      this.render();
    }

    render() {
      this.innerHTML = this.getTemplate();
      this.setupEventListeners();
      this.initializeImages();
    }

    getImagesLength = images => {
      try {
        return images.split(',').length;
      } catch (error) {
        return 0;
      }
    }

    connectedCallback() {
      // Component connected to the DOM
    }

    disconnectedCallback() {
      // Component disconnected from the DOM
    }

    setupEventListeners() {
      const addButton = this.querySelector('.add');
      const fileInput = this.querySelector('#fileInput');

      addButton.addEventListener('click', () => fileInput.click());
      fileInput.addEventListener('change', this.handleFileUpload.bind(this));
    }

    initializeImages = () => {
      try {
        let images = this.getAttribute("images").split(',');

        // remove empty strings, null, 'null' and whose length is less than 5
        images = images.filter(image => image.trim() !== '' && image !== 'null' && image.length > 5);
        
        images.forEach(imageUrl => {
          this.addImageToGallery(imageUrl);
        });

        // if uploads are more than the maxUploads, hide the add button
        if (this.uploadCount >= this.maxUploads) {
          this.hideAddButton();
        }
      } catch (error) {
        console.warn('No images to initialize');
      }
    }

    sendDeleteUrl = url => {
      const data = {
        type: 'update',
        frontend: true,
        data: {
          url: url,
          kind: 'delete',
          story: this.getAttribute('kind'),
          hash: this.getAttribute('hash')
        }
      };

      // send the view data
      if (window.wss) {
        window.wss.sendMessage(data);
      } else {
        console.warn('WebSocket connection not available. view information not sent.');
      }
    }

    updateDeletedImage = url => {
      if(window.toBeChanged) {
        try {
          let images = window.toBeChanged.getAttribute('images');

          // if images is empty or null, set it to an empty string
          if (!images || images === 'null'){
            window.toBeChanged.setAttribute('images', '');
            return;
          }

          let imagesArray = images.split(',');

          // Remove the url from the images array
          const index = imagesArray.indexOf(url);
          imagesArray.splice(index, 1);

          imagesArray = imagesArray.filter(image => image.trim() !== '' && image !== 'null' && image.length > 5);

          // if the resulting array is empty, or contains empty strings, set it to an empty string
          if (imagesArray.length === 0 || imagesArray.every(image => image.trim().length < 5)) {
            window.toBeChanged.setAttribute('images', '');
            return;
          }

          // Set the new images array
          window.toBeChanged.setAttribute('images', imagesArray.join(','));
        } catch (error) {
          console.error('Error updating deleted image:', error);
        }
      }
    }

    updateAddedImage = url => {
      try {
        let images = window.toBeChanged.getAttribute('images');
        let imagesArray = [];

        if (images && images !== 'null'){
          imagesArray = images.split(',');
        }

        // filter out the null values and empty strings
        imagesArray = imagesArray.filter(image => image.trim() !== '' && image !== 'null' && image.length > 5);

        // Add the urls to the images array if they are not already there
        if (!imagesArray.includes(url)) {
          imagesArray.push(url);
        }

        // Set the new images array
        window.toBeChanged.setAttribute('images', imagesArray.join(','));
      } catch (error) {
        console.error('Error updating added image:', error);
      }
    }

    async handleFileUpload(event) {
      const imagesContainer = this.querySelector('div.images');
      if (this.uploadCount >= this.maxUploads) {
        imagesContainer.insertAdjacentHTML('beforebegin', this.getServerSuccessMsg(false, 'You have reached the maximum uploads'));
        return;
      }

      const file = event.target.files[0];
      if (!file) return;

      const addDiv = this.querySelector('div.add');

      // check file size: uploads more than 1MB to be downsized/downgraded

      try {
        // add loader to the addDiv
        addDiv.innerHTML = this.getButtonLoader();

        // display pointer-events: none on the addDiv
        addDiv.style.pointerEvents = 'none';

        const webpBlob = await this.convertToWebP(file);
        const formData = new FormData();
        formData.append('file', webpBlob, 'image.webp');

        const response = await this.fetchWithTimeout(this.api, {
          method: 'POST',
          body: formData
        });

        const data = await response.json();

        if (data.success) {
          this.addImageToGallery(data.url);
          this.addImageToAttribute(data.url);
          this.uploadCount++;
          
          if (this.uploadCount >= this.maxUploads) {
            this.hideAddButton();
          } else {
            addDiv.innerHTML = this.getSvg();
            addDiv.style.pointerEvents = 'all';
          }
        } else {
          imagesContainer.insertAdjacentHTML('beforebegin', this.getServerSuccessMsg(false, data.message));
        }
      } catch (error) {
        console.error('Error uploading image:', error);
        imagesContainer.insertAdjacentHTML('beforebegin', this.getServerSuccessMsg(false, error.message));

        // remove message after 3 seconds
        setTimeout(() => {
          const serverStatus = this.querySelector('.server-status');
          if (serverStatus) {
            serverStatus.remove();
          }
        }, 3000);

        // remove loader and show add button
        addDiv.innerHTML = this.getSvg();
        addDiv.style.pointerEvents = 'all';
      }
    }

    async convertToWebP(file) {
      return new Promise((resolve) => {
        const img = new Image();
        img.onload = () => {
          const canvas = document.createElement('canvas');
          let width = img.width;
          let height = img.height;

          // Only downscale if the image is larger than 1MB
          if (file.size > 1024 * 1024) {
            const aspectRatio = width / height;
            const maxWidth = 1280;
            const maxHeight = 1280;

            if (width > maxWidth || height > maxHeight) {
              if (aspectRatio > 1) {
                // Landscape image
                width = maxWidth;
                height = width / aspectRatio;
              } else {
                // Portrait image
                height = maxHeight;
                width = height * aspectRatio;
              }
            }
          }

          // Set canvas dimensions
          canvas.width = width;
          canvas.height = height;

          // Draw image on canvas
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0, width, height);

          // Convert to WebP
          canvas.toBlob((blob) => {
            // Generate a unique filename
            const filename = `image_${Date.now()}.webp`;
            resolve(new File([blob], filename, { type: 'image/webp' }));
          }, 'image/webp', 0.9); // Increased quality to 0.9
        };
        img.src = URL.createObjectURL(file);
      });
    }

    addImageToGallery(imageUrl) {
      const imageDiv = document.createElement('div');
      imageDiv.className = 'image-container loading';
      imageDiv.innerHTML = `<img src="${imageUrl}" alt="Post Image" loading="lazy"> ${this.getButtonLoader()} ${this.getCancel()}`;
      this.querySelector('.add').insertAdjacentElement('beforebegin', imageDiv);

      // add load listener to the image
      this.addImageLoadListener(imageDiv.querySelector('img'));

      // add remove listener to the cancel button
      this.removeFromGallery(imageDiv.querySelector('.cancel-btn'));

      // update the added image
      this.updateAddedImage(imageUrl);
    }

    removeFromGallery = btn => {
      btn.addEventListener('click', () => {
        const imageDiv = btn.parentElement;
        const imageUrl = imageDiv.querySelector('img').src;

        // remove image from gallery
        imageDiv.remove();

        // remove image from attribute
        this.removeImageFromAttribute(imageUrl);

        // decrement upload count
        this.uploadCount--;

        // show add button
        this.showAddButton();

        // send delete url to server
        this.sendDeleteUrl(imageUrl);

        // update the deleted image
        this.updateDeletedImage(imageUrl);
      });
    }

    removeImageFromAttribute = imageUrl => {
      // get images attribute: array
      let images = this.getAttribute("images").split(',');
      const index = images.indexOf(imageUrl);
      images.splice(index, 1);

      // remove empty strings, null, 'null' and whose length is less than 5
      images = images.filter(image => image.trim() !== '' && image !== 'null' && image.length > 5);

      // set images attribute: array
      this.setAttribute("images", images.join(','));
    }

    addImageToAttribute(imageUrl) {
      try {
        let images = this.getAttribute("images").split(',');
        images.push(imageUrl);
        
        images = images.filter(image => image.trim() !== '' && image !== 'null' && image.length > 5);

        // set images attribute: array
        this.setAttribute("images", images.join(','));
      } catch (error) {
        console.error('Error adding image to attribute:', error);
      }
    }

    hideAddButton() {
      const addButton = this.querySelector('.add');
      addButton.style.display = 'none';
    }

    showAddButton() {
      const addButton = this.querySelector('.add');
      addButton.innerHTML = this.getSvg();
      addButton.style.pointerEvents = 'all';
      addButton.style.display = 'flex';
    }

    addImageLoadListener = img => {
      img.addEventListener('load', () => {
        // remove loader and blur(.loading) class)
  			img.parentElement.classList.remove('loading');
  			const loader = img.parentElement.querySelector('#btn-loader');
  			if(loader) { loader.remove(); }
      });
      img.addEventListener('error', () => {
        img.parentElement.classList.add('error');
      });
    }

    fetchWithTimeout = async (url, options = {}, timeout = 9500) => {
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), timeout);
    
      try {
        const response = await fetch(url, {
          ...options,
          signal: controller.signal
        });

        return response;
      } catch (error) {
        if (error.name === 'AbortError') {
          throw new Error('Request timed out');
        }
        throw new Error(`Network error: ${error.message}`);
      } finally {
        clearTimeout(timeoutId);
      }
    }

    getTemplate = () => {
      return `
      <div class="images">
        ${this.getBody()}
      </div>
      ${this.getStyles()}
    `;
    }

    getServerSuccessMsg = (success, text) => {
      if (!success) {
        return `
        <p class="server-status">${text}</p>
      `
      }
      return `
      <p class="server-status success">${text}</p>
    `
    }

    getBody = () => {
      return /* html */`
      <div class="add">
        ${this.getSvg()}
        <input type="file" id="fileInput" accept=".avif, image/*, image/webp, image/avif" style="display: none;">
      </div>
    `;
    }

    getSvg = () => {
      return /* svg */`
      <svg id="Image" width="24" height="24" viewBox="0 0 25 25" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path fill-rule="evenodd" clip-rule="evenodd" d="M8.58093 11.8089C7.30893 11.8089 6.27393 10.7739 6.27393 9.50187C6.27393 8.22787 7.30893 7.19287 8.58093 7.19287C9.85393 7.19387 10.8889 8.22987 10.8889 9.50187C10.8889 10.7739 9.85293 11.8089 8.58093 11.8089ZM8.57993 8.69287C8.13593 8.69287 7.77393 9.05487 7.77393 9.50187C7.77393 9.94687 8.13593 10.3089 8.58093 10.3089C9.02693 10.3089 9.38893 9.94687 9.38893 9.50187C9.38893 9.05587 9.02593 8.69387 8.57993 8.69287Z" fill="currentColor"/>
        <path d="M6.06878 17.604C5.95678 17.604 5.84178 17.579 5.73478 17.525C5.36478 17.34 5.21478 16.892 5.39778 16.522C5.50278 16.311 6.46278 14.468 8.06378 14.468C8.88778 14.468 9.49078 14.916 9.97578 15.278C10.4478 15.628 10.7568 15.843 11.1598 15.843C11.4448 15.839 12.1838 14.95 12.5808 14.471C13.4278 13.451 14.3048 12.395 15.4218 12.395C17.3358 12.395 18.5258 14.94 18.6548 15.23C18.8228 15.608 18.6538 16.05 18.2758 16.219C17.9008 16.39 17.4548 16.22 17.2848 15.842C16.9998 15.207 16.1678 13.895 15.4218 13.895C15.0097 13.895 14.2454 14.8147 13.7384 15.4247L13.7348 15.429C12.9178 16.414 12.1458 17.343 11.1598 17.343C10.2398 17.343 9.59678 16.865 9.08078 16.481C8.65278 16.164 8.37578 15.968 8.06378 15.968C7.52878 15.968 6.94178 16.792 6.74078 17.19C6.60878 17.453 6.34378 17.604 6.06878 17.604Z" fill="currentColor"/>
        <path fill-rule="evenodd" clip-rule="evenodd" d="M2 12.396C2 19.779 4.617 22.396 12 22.396C19.383 22.396 22 19.779 22 12.396C22 5.013 19.383 2.396 12 2.396C4.617 2.396 2 5.013 2 12.396ZM3.5 12.396C3.5 5.882 5.486 3.896 12 3.896C18.514 3.896 20.5 5.882 20.5 12.396C20.5 18.91 18.514 20.896 12 20.896C5.486 20.896 3.5 18.91 3.5 12.396Z" fill="currentColor"/>
      </svg>
    `;
    }

    getCancel = () => {
      return /* svg */`
      <span class="cancel-btn">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" fill="currentColor">
          <path d="M3.72 3.72a.75.75 0 0 1 1.06 0L8 6.94l3.22-3.22a.749.749 0 0 1 1.275.326.749.749 0 0 1-.215.734L9.06 8l3.22 3.22a.749.749 0 0 1-.326 1.275.749.749 0 0 1-.734-.215L8 9.06l-3.22 3.22a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042L6.94 8 3.72 4.78a.75.75 0 0 1 0-1.06Z"></path>
        </svg>
      </span>
    `;
    }

    getButtonLoader() {
      return /*html*/`
      <span id="btn-loader">
				<span class="loader"></span>
			</span>
    `
    }

  	getStyles() {
  		return /* css */`
	    <style>
	      *,
	      *:after,
	      *:before {
	        box-sizing: border-box !important;
	        font-family: inherit;
	        -webkit-box-sizing: border-box !important;
	      }

	      *:focus {
	        outline: inherit !important;
	      }

	      *::-webkit-scrollbar {
	        width: 3px;
	      }

	      *::-webkit-scrollbar-track {
	        background: var(--scroll-bar-background);
	      }

	      *::-webkit-scrollbar-thumb {
	        width: 3px;
	        background: var(--scroll-bar-linear);
	        border-radius: 50px;
	      }

	      h1,
	      h2,
	      h3,
	      h4,
	      h5,
	      h6 {
	        padding: 0;
	        margin: 0;
	        font-family: inherit;
	      }

	      p,
	      ul,
	      ol {
	        padding: 0;
	        margin: 0;
	      }

	      a {
	        text-decoration: none;
	      }

        p.server-status {
          margin: 0;
          width: 100%;
          text-align: start;
          font-family: var(--font-read), sans-serif;
          color: var(--error-color);
          font-weight: 500;
          line-height: 1.5;
          font-size: 1.18rem;
        }

        p.server-status.success {
          color: transparent;
          background: var(--accent-linear);
          background-clip: text;
          -webkit-background-clip: text;
        }

        #btn-loader {
          position: absolute;
          top: 0;
          left: 0;
          bottom: 0;
          right: 0;
          z-index: 5;
          display: flex;
          align-items: center;
          justify-content: center;
          border-radius: inherit;
        }

        #btn-loader > .loader {
          width: 20px;
          aspect-ratio: 1;
          --_g: no-repeat radial-gradient(farthest-side, #18A565 94%, #0000);
          --_g1: no-repeat radial-gradient(farthest-side, #21D029 94%, #0000);
          --_g2: no-repeat radial-gradient(farthest-side, #df791a 94%, #0000);
          --_g3: no-repeat radial-gradient(farthest-side, #f09c4e 94%, #0000);
          background: var(--_g) 0 0,  var(--_g1) 100% 0, var(--_g2) 100% 100%, var(--_g3) 0 100%;
          background-size: 30% 30%;
          animation: l38 .9s infinite ease-in-out;
          -webkit-animation: l38 .9s infinite ease-in-out;
        }

        @keyframes l38 {
          100% {
            background-position: 100% 0, 100% 100%, 0 100%, 0 0
          }
        }

	      div.images {
          width: 100%;
          min-width: 100%;
          max-width: 100%;
          display: flex;
          flex-flow: row;
          gap: 10px;
          position: relative;
          justify-content: start;
          align-items: center;
          margin: 0;
          padding: 10px 0;
          overflow-x: scroll;
          -ms-overflow-style: none;
          scrollbar-width: none;
        }

        ::-webkit-scrollbar {
          display: none !important;
          visibility: hidden;
        }
        
        div.images > .image-container {
					border: var(--border);
					position: relative;
					display: flex;
					justify-content: center;
					align-items: center;
					position: relative;
					cursor: pointer;
					overflow: hidden;
					height: 80px;
					min-width: 60px;
					border-radius: 12px;
				}

				div.images > .image-container.error {
					border: var(--input-border-error);
				}

        div.images > .image-container.loading img {
					filter: blur(8px);
				}

				div.images > .image-container > img {
					height: 100%;
					width: auto;
					min-width: 60px;
					max-height: 80px;
					object-fit: cover;
					object-position: center;
					border-radius: 12px;
					overflow: hidden;
					transition: transform 0.4s ease-in-out;
				}

        div.images > .image-container > span.cancel-btn {
          position: absolute;
          top: 5px;
          right: 5px;
          padding: 0;
          cursor: pointer;
          display: flex;
          flex-flow: column;
          gap: 0px;
          justify-content: center;
        }

        div.images > .image-container > span.cancel-btn svg {
          width: 15px;
          height: 15px;
          color: var(--error-color);
        }

				div.images > .image-container:hover img {
					transform: scale(1.3);
				}
        
        div.images > div.add {
          height: 50px;
          min-width: 50px;
          background: var(--gray-background);
          display: flex;
          justify-content: center;
          align-items: center;
          position: relative;
          cursor: pointer;
          overflow: hidden;
          max-height: 60px;
          box-shadow: var(--image-shadow);
          border-radius: 12px;
        }
        
        div.images > div.add > svg {
          height: 30px;
          width: 30px;
          color: var(--gray-color);
          transition: all 0.3s ease;
        }
        
        div.images > div.add:hover svg {
          color: var(--accent-color);
        }

				@media screen and (max-width:660px) {
					:host {
        		font-size: 16px;
					}

					::-webkit-scrollbar {
						-webkit-appearance: none;
					}

          div.image-container,
          div.images > div.add,
					a {
						cursor: default !important;
					}
				}
	    </style>
    `;
  	}
  }

  let FormContainer$1 = class FormContainer extends HTMLElement {
    constructor() {
      // We are not even going to touch this.
      super();

      // let's create our shadow root
      this.shadowObj = this.attachShadow({ mode: "open" });

      this.render();
    }

    render() {
      this.shadowObj.innerHTML = this.getTemplate();
    }

    connectedCallback() {
      // activate topic
      this.activateTopicButton();
      // activate post
      this.activatePostButton();

      // activate article
      this.activateArticleButton();
    }

    activateTopicButton = () => {
      // Get the topic button
      const topicButton = this.shadowObj.querySelector('.topic');
      // Add an event listener to the topic button
      topicButton.addEventListener('click', e => {
        e.preventDefault();
        // Get the body element
        const body = document.querySelector('body');
        // Get the content of the topic page
        const content = this.getTopic();

        // insert the content into the body
        body.insertAdjacentHTML('beforeend', content);
      });
    }

    activatePostButton = () => {
      // Get the post button
      const postButton = this.shadowObj.querySelector('.post');
      // Add an event listener to the post button
      postButton.addEventListener('click', e => {
        e.preventDefault();
        // Get the body element
        const body = document.querySelector('body');
        // Get the content
        const content = this.getPost();

        // insert the content into the body
        body.insertAdjacentHTML('beforeend', content);
      });
    }

    activateArticleButton = () => {
      // Get the article button
      const articleButton = this.shadowObj.querySelector('.article');
      // Add an event listener to the article button
      articleButton.addEventListener('click', e => {
        e.preventDefault();

        // Get the body element
        const body = document.querySelector('body');

        // Get the content
        const content = this.getArticle();

        // insert the content into the body
        body.insertAdjacentHTML('beforeend', content);
      });
    }

    getTopic = () => {
      // Show Topic Page Here
      return /* html */`
      <div is="create-topic" api="/api/v1/t/add" method="PUT"></div>
    `;
    }

    getPost = () => {
      // Show Post Page Here
      return /* html */`
      <div is="create-post" api="/api/v1/s/add" method="PUT"></div>
    `;
    }

    getArticle = () => {
      // Show Article Page Here
      return /* html */`
      <div is="create-article" api="/api/v1/s/add" method="PUT"></div>
    `;
    }

    getTemplate = () => {
      // Show HTML Here
      return `
      ${this.getContent()}
      ${this.getStyles()}
    `;
    }

    getContent = () => {
      return /* html */`
      <p class="title"> What's on your mind?</p>
      <div class="options">
        <a href="/create/article" class="option article">Article</a>
        <a href="/create/post" class="option post">Post</a>
        <a href="/create/topic" class="option topic">Topic</a>
      </div>
    `;
    }

    getStyles() {
      return /* css */`
	    <style>
	      *,
	      *:after,
	      *:before {
	        box-sizing: border-box !important;
	        font-family: inherit;
	        -webkit-box-sizing: border-box !important;
	      }

	      *:focus {
	        outline: inherit !important;
	      }

	      *::-webkit-scrollbar {
	        width: 3px;
	      }

	      *::-webkit-scrollbar-track {
	        background: var(--scroll-bar-background);
	      }

	      *::-webkit-scrollbar-thumb {
	        width: 3px;
	        background: var(--scroll-bar-linear);
	        border-radius: 50px;
	      }

	      h1,
	      h2,
	      h3,
	      h4,
	      h5,
	      h6 {
	        padding: 0;
	        margin: 0;
	        font-family: inherit;
	      }

	      p,
	      ul,
	      ol {
	        padding: 0;
	        margin: 0;
	      }

	      a {
	        text-decoration: none;
	      }

	      :host {
          font-size: 16px;
          background-color: var(--background);
          border-bottom: var(--border);
          padding: 0;
          display: flex;
          flex-flow: column;
          margin: 0;
          gap: 10px;
          padding: 10px 0;
          width: 100%;
        }

        p.title {
          color: var(--title-color);
          font-family: var(--font-main), sans-serif;
          font-weight: 500;
          font-size: 1.1rem;
        }

        div.options {
          display: flex;
          align-items: flex-start;
          gap: 10px;
          padding: 0 0 5px 0;
          font-size: 1rem;
          font-weight: 400;
          position: relative;
          overflow-x: scroll;
          scrollbar-width: none;
        }

        div.options::-webkit-scrollbar {
          display: none;
          visibility: hidden;
        }

        div.options > a.option {
          border: none;
          color: var(--add-color);
          background: var(--option-background);
          font-family: var(--font-text), sans-serif;
          cursor: pointer;
          text-decoration: none;
          padding: 2px 10px 3px;
          font-weight: 500;
          width: 80px;
          cursor: pointer;
          display: flex;
          flex-flow: row;
          flex-wrap: nowrap;
          align-items: center;
          justify-content: center;
          gap: 5px;
          border-radius: 12px;
          -webkit-border-radius: 12px;
          -moz-border-radius: 12px;
        }

        div.options > a.option.article {
          background: var(--gray-background);
        }

        div.options > a.option.post {
          background: var(--light-linear);
        }

        div.options > a.option.topic {
          background: var(--gray-background);
        }

        div.options > a.option:hover {
          color: transparent;
          background: var(--accent-linear);
          background-clip: text;
          -webkit-background-clip: text;
        }

				@media screen and (max-width:660px) {
					:host {
            font-size: 16px;
            gap: 10px;
					}

          div.container {
            display: flex;
            flex-flow: column;
            gap: 10px;
            padding: 5px 0 10px 0;
          }  

          div.options {
            display: flex;
            align-items: flex-start;
            gap: 15px;
            width: 100%;
            overflow-x: scroll;
            scrollbar-width: none;
          }

          div.options::-webkit-scrollbar {
            display: none;
            visibility: hidden;
          }

          div.options > a.option {
            cursor: default !important;
            color: var(--add-color);
            font-family: var(--font-text), sans-serif;
            padding: 3px 10px 4px;
            font-weight: 600;
            width: 80px;
          }
				}
	    </style>
    `;
    }
  };

  class ActivityContainer extends HTMLElement {
    constructor() {
      // We are not even going to touch this.
      super();

      // let's create our shadow root
      this.shadowObj = this.attachShadow({ mode: "open" });

      this.render();
    }

    render() {
      this.shadowObj.innerHTML = this.getTemplate();
    }

    connectedCallback() {
      this.activateTab();
    }

    activateTab = () => {
      const outerThis = this;
      const tab = this.shadowObj.querySelector('ul#tab');
      const contentContainer = this.shadowObj.querySelector('.content');

      if (tab && contentContainer) {
        const line = tab.querySelector('span.line');
        const tabItems = tab.querySelectorAll('li.tab-item');
        let activeTab = tab.querySelector('li.tab-item.active');

        tabItems.forEach((tab, index) => {
          tab.addEventListener('click', e => {
            e.preventDefault();
            e.stopPropagation();

            // Calculate half tab width - 10px
            const tabWidth = (tab.offsetWidth / 2) - 20;

            if (index === 0) {
              line.style.left = '0';
            }
            else {
              line.style.left = `${tab.offsetLeft + tabWidth}px`;
            }

            if (tab.dataset.element === activeTab.dataset.element) {
              return;
            }
            else {
              activeTab.classList.remove('active');
              tab.classList.add('active');
              activeTab = tab;
              const url = tab.getAttribute('url');
              contentContainer.innerHTML = outerThis.getAll(url);
            }
          });
        });
      }
    }

    getTemplate = () => {
      // Show HTML Here
      return `
      ${this.getBody()}
      ${this.getStyles()}
    `;
    }

    getBody = () => {
      // language=HTML
      return `
      ${this.getHeader()}
      ${this.getTab()}
			<div class="content">
				${this.getAll(this.getAttribute('api-all'))}
      </div>
    `;
    }

    getAll = url => {
      return /* html */`
			<activity-feed url="${url}" page="1" limit="10"></activity-feed>
		`
    }

    getHeader = () => {
      return /* html */`
      <div class="top">
        <p class="desc">
          Your activity is a summary of your interactions on the platform. You can view your stories, replies and likes.
        </p>
      </div>
    `;
    }

    getTab = () => {
      return /* html */`
      <div class="actions">
        <ul id="tab" class="tab">
          <li data-element="all" class="tab-item all active" url="${this.getAttribute('api-all')}">
            <span class="text">All</span>
          </li>
          <li data-element="stories" class="tab-item stories" url="${this.getAttribute('api-stories')}">
            <span class="text">Stories</span>
          </li>
          <li data-element="replies" class="tab-item replies" url="${this.getAttribute('api-replies')}">
            <span class="text">Replies</span>
          </li>
          <li data-element="people" class="tab-item people" url="${this.getAttribute('api-users')}">
            <span class="text">People</span>
          </li>
          <li data-element="topics" class="tab-item topics" url="${this.getAttribute('api-topics')}">
            <span class="text">Topics</span>
          </li>
          <span class="line"></span>
        </ul>
      </div>
    `;
    }

    getStyles() {
      return /* css */`
      <style>
        *,
        *:after,
        *:before {
          box-sizing: border-box !important;
          font-family: inherit;
          -webkit-box-sizing: border-box !important;
        }

        *:focus {
          outline: inherit !important;
        }

        *::-webkit-scrollbar {
          width: 3px;
        }

        *::-webkit-scrollbar-track {
          background: var(--scroll-bar-background);
        }

        *::-webkit-scrollbar-thumb {
          width: 3px;
          background: var(--scroll-bar-linear);
          border-radius: 50px;
        }

        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
          padding: 0;
          margin: 0;
          font-family: inherit;
        }

        p,
        ul,
        ol {
          padding: 0;
          margin: 0;
        }

        a {
          text-decoration: none;
        }

        :host {
          font-size: 16px;
          display: flex;
          flex-flow: column;
          gap: 0;
          padding: 0;
          width: 100%;
        }

        .top {
          display: flex;
          flex-flow: column;
          gap: 5px;
          padding: 0;
          width: 100%;
        }

        .top > h4.title {
          border-bottom: var(--border-mobile);
          display: flex;
          align-items: center;
          color: var(--title-color);
          font-size: 1.3rem;
          font-weight: 500;
          margin: 0;
          padding: 0 0 6px 0;
        }

        .top > .desc {
          margin: 0;
          padding: 6px 0 10px;
          color: var(--text-color);
          font-size: 1rem;
          line-height: 1.3;
          font-family: var(--font-main), sans-serif;
        }

        .actions {
          border-bottom: var(--border);
          background-color: var(--background);
          display: flex;
          flex-flow: column;
          gap: 0;
          z-index: 3;
          width: 100%;
          position: sticky;
          top: 60px;
        }

        .actions > ul.tab {
          height: max-content;
          width: 100%;
          padding: 0;
          margin: 0;
          list-style-type: none;
          display: flex;
          gap: 0;
          align-items: center;
          max-width: 100%;
          overflow-x: scroll;
          -ms-overflow-style: none;
          scrollbar-width: none;
        }

        .actions > ul.tab::-webkit-scrollbar {
          display: none !important;
          visibility: hidden;
        }

        .actions > ul.tab > li.tab-item {
          color: var(--gray-color);
          font-family: var(--font-text), sans-serif;
          font-weight: 400;
          padding: 6px 20px 8px 0;
          margin: 0;
          display: flex;
          align-items: center;
          cursor: pointer;
          overflow: visible;
          font-size: 0.95rem;
        }

        .actions > ul.tab > li.tab-item > .text {
          font-weight: 500;
          font-size: 1rem;
        }

        .actions > ul.tab > li.tab-item:hover > .text {
          color: transparent;
          background: var(--accent-linear);
          background-clip: text;
          -webkit-background-clip: text;
        }

        .actions > ul.tab > li.active {
          font-size: 0.95rem;
        }

        .actions > ul.tab > li.active > .text {
          color: transparent;
          background: var(--accent-linear);
          background-clip: text;
          -webkit-background-clip: text;
          font-family: var(--font-read);
        }

        .actions > ul.tab span.line {
          position: absolute;
          z-index: 1;
          background: var(--accent-linear);
          display: inline-block;
          bottom: -2.5px;
          left: 0px;
          width: 20px;
          min-height: 5px;
          border-top-left-radius: 5px;
          border-top-right-radius: 5px;
          border-bottom-left-radius: 5px;
          border-bottom-right-radius: 5px;
          transition: all 300ms ease-in-out;
        }

        .content {
          display: flex;
          flex-flow: column;
          gap: 0;
          padding: 0;
          width: 100%;
        }

        @media screen and (max-width:600px) {

          ::-webkit-scrollbar {
            -webkit-appearance: none;
          }

          .top > .desc {
            margin: 0;
            padding: 6px 0 10px;
            font-size: 1rem;
            line-height: 1.5;
          }

          .actions {
            position: sticky;
            top: 50px;
          }

          a,
          .actions > ul.tab > li.tab-item {
            cursor: default !important;
          }
        }
      </style>
    `;
    }
  }

  class FormContainer extends HTMLElement {
  	constructor() {
  		// We are not even going to touch this.
  		super();

  		// let's create our shadow root
  		this.shadowObj = this.attachShadow({ mode: "open" });

  		this.render();
  	}

  	render() {
  		this.shadowObj.innerHTML = this.getTemplate();
  	}

  	connectedCallback() {

      this.expandTextArea();
  	}

    expandTextArea = () => {
      const replyTextarea = this.shadowObj.querySelector('textarea');
      if (replyTextarea) {
        replyTextarea.addEventListener('input', () => {
          replyTextarea.style.height = 'auto';
          const height = replyTextarea.scrollHeight;
          if (height <= 60) {
            replyTextarea.style.height = `38px`;
          }
          else if (height <= 100) {
            replyTextarea.style.height = `${height + 10}px`;
          }
          else {
            replyTextarea.style.height = `100px`;
          }
        });
      }
    }

  	getTemplate = () => {
  		// Show HTML Here
  		return `
      ${this.getBody()}
      ${this.getStyles()}
    `;
  	}

  	getBody = () => {
  		return /* html */`
      <form action="" class="reply">
        <textarea name="reply" placeholder="What's your reply?" id="reply"></textarea>
        <div class="footer">
          <div class="actions">
            <span class="action at" title="Mention">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 512 512">
                <path d="M256 48C141.1 48 48 141.1 48 256s93.1 208 208 208c13.3 0 24 10.7 24 24s-10.7 24-24 24C114.6 512 0 397.4 0 256S114.6 0 256 0S512 114.6 512 256v28c0 50.8-41.2 92-92 92c-31.1 0-58.7-15.5-75.3-39.2C322.7 360.9 291.1 376 256 376c-66.3 0-120-53.7-120-120s53.7-120 120-120c28.8 0 55.2 10.1 75.8 27c4.3-6.6 11.7-11 20.2-11c13.3 0 24 10.7 24 24v80 28c0 24.3 19.7 44 44 44s44-19.7 44-44V256c0-114.9-93.1-208-208-208zm72 208a72 72 0 1 0 -144 0 72 72 0 1 0 144 0z"/>
              </svg>
            </span>
            <span class="action poll" title="Poll">
              <svg viewBox="0 0 24 24"  fill="currentColor">
                <g>
                  <path d="M6 5c-1.1 0-2 .895-2 2s.9 2 2 2 2-.895 2-2-.9-2-2-2zM2 7c0-2.209 1.79-4 4-4s4 1.791 4 4-1.79 4-4 4-4-1.791-4-4zm20 1H12V6h10v2zM6 15c-1.1 0-2 .895-2 2s.9 2 2 2 2-.895 2-2-.9-2-2-2zm-4 2c0-2.209 1.79-4 4-4s4 1.791 4 4-1.79 4-4 4-4-1.791-4-4zm20 1H12v-2h10v2zM7 7c0 .552-.45 1-1 1s-1-.448-1-1 .45-1 1-1 1 .448 1 1z"></path>
                </g>
              </svg>
            </span>
            <span class="action link" title="Link">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 640 512">
                <path d="M580.3 267.2c56.2-56.2 56.2-147.3 0-203.5C526.8 10.2 440.9 7.3 383.9 57.2l-6.1 5.4c-10 8.7-11 23.9-2.3 33.9s23.9 11 33.9 2.3l6.1-5.4c38-33.2 95.2-31.3 130.9 4.4c37.4 37.4 37.4 98.1 0 135.6L433.1 346.6c-37.4 37.4-98.2 37.4-135.6 0c-35.7-35.7-37.6-92.9-4.4-130.9l4.7-5.4c8.7-10 7.7-25.1-2.3-33.9s-25.1-7.7-33.9 2.3l-4.7 5.4c-49.8 57-46.9 142.9 6.6 196.4c56.2 56.2 147.3 56.2 203.5 0L580.3 267.2zM59.7 244.8C3.5 301 3.5 392.1 59.7 448.2c53.6 53.6 139.5 56.4 196.5 6.5l6.1-5.4c10-8.7 11-23.9 2.3-33.9s-23.9-11-33.9-2.3l-6.1 5.4c-38 33.2-95.2 31.3-130.9-4.4c-37.4-37.4-37.4-98.1 0-135.6L207 165.4c37.4-37.4 98.1-37.4 135.6 0c35.7 35.7 37.6 92.9 4.4 130.9l-5.4 6.1c-8.7 10-7.7 25.1 2.3 33.9s25.1 7.7 33.9-2.3l5.4-6.1c49.9-57 47-142.9-6.5-196.5c-56.2-56.2-147.3-56.2-203.5 0L59.7 244.8z"/>
              </svg>
            </span>
            <span class="action emoji" title="Emoji">
              <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" width="16" height="16" viewBox="0 0 512 512">
                <path d="M464 256A208 208 0 1 0 48 256a208 208 0 1 0 416 0zM0 256a256 256 0 1 1 512 0A256 256 0 1 1 0 256zm177.6 62.1C192.8 334.5 218.8 352 256 352s63.2-17.5 78.4-33.9c9-9.7 24.2-10.4 33.9-1.4s10.4 24.2 1.4 33.9c-22 23.8-60 49.4-113.6 49.4s-91.7-25.5-113.6-49.4c-9-9.7-8.4-24.9 1.4-33.9s24.9-8.4 33.9 1.4zM144.4 208a32 32 0 1 1 64 0 32 32 0 1 1 -64 0zm192-32a32 32 0 1 1 0 64 32 32 0 1 1 0-64z"/>
              </svg>
            </span>
            <span class="action schedule" title=Schedule">
              <svg viewBox="0 0 24 24"  fill="currentColor">
                <g>
                  <path d="M6 3V2h2v1h6V2h2v1h1.5C18.88 3 20 4.119 20 5.5v2h-2v-2c0-.276-.22-.5-.5-.5H16v1h-2V5H8v1H6V5H4.5c-.28 0-.5.224-.5.5v12c0 .276.22.5.5.5h3v2h-3C3.12 20 2 18.881 2 17.5v-12C2 4.119 3.12 3 4.5 3H6zm9.5 8c-2.49 0-4.5 2.015-4.5 4.5s2.01 4.5 4.5 4.5 4.5-2.015 4.5-4.5-2.01-4.5-4.5-4.5zM9 15.5C9 11.91 11.91 9 15.5 9s6.5 2.91 6.5 6.5-2.91 6.5-6.5 6.5S9 19.09 9 15.5zm5.5-2.5h2v2.086l1.71 1.707-1.42 1.414-2.29-2.293V13z"></path>
                </g>
              </svg>
            </span>
            <span class="action code" title="Code">
              <svg xmlns="http://www.w3.org/2000/svg" width="16px" height="16px" fill="currentColor" viewBox="0 0 640 512">
                <path d="M399.1 1.1c-12.7-3.9-26.1 3.1-30 15.8l-144 464c-3.9 12.7 3.1 26.1 15.8 30s26.1-3.1 30-15.8l144-464c3.9-12.7-3.1-26.1-15.8-30zm71.4 118.5c-9.1 9.7-8.6 24.9 1.1 33.9L580.9 256 471.6 358.5c-9.7 9.1-10.2 24.3-1.1 33.9s24.3 10.2 33.9 1.1l128-120c4.8-4.5 7.6-10.9 7.6-17.5s-2.7-13-7.6-17.5l-128-120c-9.7-9.1-24.9-8.6-33.9 1.1zm-301 0c-9.1-9.7-24.3-10.2-33.9-1.1l-128 120C2.7 243 0 249.4 0 256s2.7 13 7.6 17.5l128 120c9.7 9.1 24.9 8.6 33.9-1.1s8.6-24.9-1.1-33.9L59.1 256 168.4 153.5c9.7-9.1 10.2-24.3 1.1-33.9z"/>
              </svg>
            </span>
          </div>
          <button type="submit">Reply</button>
        </div>
      </form>
    `;
  	}


  	getStyles() {
  		return /* css */`
	    <style>
	      *,
	      *:after,
	      *:before {
	        box-sizing: border-box !important;
	        font-family: inherit;
	        -webkit-box-sizing: border-box !important;
	      }

	      *:focus {
	        outline: inherit !important;
	      }

	      *::-webkit-scrollbar {
	        width: 3px;
	      }

	      *::-webkit-scrollbar-track {
	        background: var(--scroll-bar-background);
	      }

	      *::-webkit-scrollbar-thumb {
	        width: 3px;
	        background: var(--scroll-bar-linear);
	        border-radius: 50px;
	      }

	      h1,
	      h2,
	      h3,
	      h4,
	      h5,
	      h6 {
	        padding: 0;
	        margin: 0;
	        font-family: inherit;
	      }

	      p,
	      ul,
	      ol {
	        padding: 0;
	        margin: 0;
	      }

	      a {
	        text-decoration: none;
	      }

	      :host {
          font-size: 16px;
          background-color: var(--background);
          border-bottom: ${this.getAttribute('full') === "true" ? 'var(--border)' : 'none'};
          padding: ${this.getAttribute('full') === "true" ? '0 0 15px 0' : '0'};
          display: flex;
          flex-flow: column;
          gap: 0;
        }

        form.reply {
          padding: 0;
          margin: 0;
          display: flex;
          flex-flow: column;
          gap: 0;
          font-size: 1rem;
          font-weight: 400;
          color: var(--gray-color);
          position: relative;
        }

        form.reply > textarea {
          border: none;
          background-color: var(--background) !important;
          padding: 4px 0 0 2px;
          margin: 0;
          width: calc(100% - 35px);
          resize: none;
          height: 45px;
          display: flex;
          flex-flow: column;
          align-items: center;
          justify-content: center;
          gap: 5px;
          font-size: 1rem;
          font-weight: 400;
          color: var(--text-color);
          -ms-overflow-style: none;
          scrollbar-width: none;
        }

        form.reply > textarea::-webkit-scrollbar {
          display: none !important;
          visibility: hidden;
        }

        form.reply .footer {
          padding: 0;
          width: 100%;
          display: flex;
          align-items: center;
          justify-content: space-between;
          gap: 10px;
        }

        form.reply .footer > .actions {
          padding: 0;
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 10px;
        }

        form.reply .footer * {
          transition: all 300ms ease-in-out;
          -webkit-transition: all 300ms ease-in-out;
          -moz-transition: all 300ms ease-in-out;
          -ms-transition: all 300ms ease-in-out;
          -o-transition: all 300ms ease-in-out;
        }

        form.reply .footer > .actions > .action {
          /* border: var(--input-border); */
          cursor: pointer;
          padding: 0;
          color: var(--gray-color);
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 0;
        }

        form.reply .footer > .actions > .action > svg {
          /* border: var(--input-border); */
          padding: 0;
          display: flex;
          align-items: center;
          justify-content: center;
          color: inherit;
          width: 20px;
          height: 20px;
        }

        form.reply .footer > .actions > .action:hover {
          /* border: var(--input-border); */
          color: var(--accent-color);
        }

        form.reply .footer > button {
          border: none;
          cursor: pointer;
          color: var(--white-color);
          background: var(--accent-linear);
          height: 30px;
          width: 60px;
          padding: 0;
          font-size: 0.9rem;
          font-weight: 600;
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 0;
          border-radius: 50px;
          -webkit-border-radius: 50px;
          -moz-border-radius: 50px;
        }

				@media screen and (max-width:660px) {
					:host {
            font-size: 16px;
					}

          div.options > span {
            border: var(--border-mobile);
          }
				}
	    </style>
    `;
  	}
  }

  class HighlightsContainer extends HTMLElement {
  	constructor() {
  		// We are not even going to touch this.
  		super();

      this._url = this.getAttribute('url');

  		// let's create our shadow root
  		this.shadowObj = this.attachShadow({ mode: "open" });

  		this.render();
  	}

  	render() {
  		this.shadowObj.innerHTML = this.getTemplate();
  	}

  	connectedCallback() {
  		
  		const contentContainer = this.shadowObj.querySelector('div.content');

  		this.fetchTopics(contentContainer);
  	}

  	fetchTopics = (contentContainer) => {
      const outerThis = this;
  		const topicsLoader = this.shadowObj.querySelector('post-loader');
  		setTimeout(() => {
        // fetch the user stats
        const options = {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          }
        };
    
        this.fetchWithTimeout(this._url, options)
          .then(response => {
            return response.json();
          })
          .then(data => {
            // check for success response
            if (data.success) {
              // update the content
              const content = outerThis.getHighlights(data.data);
              // remove the loader
              topicsLoader.remove();
              // insert the content
              contentContainer.insertAdjacentHTML('beforeend', content);
            }
            else {
              // display error message
              const content = outerThis.getEmpty();
              topicsLoader.remove();
              contentContainer.insertAdjacentHTML('beforeend', content);
            }
          })
          .catch(error => {
            // display error message
            const content = outerThis.getEmpty();
            topicsLoader.remove();
            contentContainer.insertAdjacentHTML('beforeend', content);
          });
  		}, 2000);
  	}

    fetchWithTimeout = async (url, options = {}, timeout = 9500) => {
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), timeout);
    
      try {
        const response = await fetch(url, {
          ...options,
          signal: controller.signal
        });

        return response;
      } catch (error) {
        if (error.name === 'AbortError') {
          throw new Error('Request timed out');
        }
        throw new Error(`Network error: ${error.message}`);
      } finally {
        clearTimeout(timeoutId);
      }
    };

    formatNumber = n => {
      if (n >= 0 && n <= 999) {
        return n.toString();
      } else if (n >= 1000 && n <= 9999) {
        const value = (n / 1000).toFixed(2);
        return `${value}k`;
      } else if (n >= 10000 && n <= 99999) {
        const value = (n / 1000).toFixed(1);
        return `${value}k`;
      } else if (n >= 100000 && n <= 999999) {
        const value = (n / 1000).toFixed(0);
        return `${value}k`;
      } else if (n >= 1000000 && n <= 9999999) {
        const value = (n / 1000000).toFixed(2);
        return `${value}M`;
      } else if (n >= 10000000 && n <= 99999999) {
        const value = (n / 1000000).toFixed(1);
        return `${value}M`;
      } else if (n >= 100000000 && n <= 999999999) {
        const value = (n / 1000000).toFixed(0);
        return `${value}M`;
      } else if (n >= 1000000000) {
        return "1B+";
      }
      else {
        return 0;
      }
    }

    parseToNumber = num_str => {
      // Try parsing the string to an integer
      const num = parseInt(num_str);

      // Check if parsing was successful
      if (!isNaN(num)) {
        return num;
      } else {
        return 0;
      }
    }

  	getTemplate = () => {
  		// Show HTML Here
  		return `
      ${this.getBody()}
      ${this.getStyles()}
    `;
  	}

  	getLoader = () => {
  		return `
			<post-loader speed="300"></post-loader>
		`
  	}

  	getBody = () => {
  		// language=HTML
  		return /* html */`
			<div class="content">
				${this.getLoader()}
			</div>
    `;
  	}

    getHighlights = data => {
      // Get the number of followers, views, stories and topics
      const followers = this.parseToNumber(this.getAttribute('followers'));
      data.all;
      const stories = this.parseToNumber(this.getAttribute('stories'));
      const topics = data.topics;

      const replies = this.parseToNumber(this.getAttribute('replies'));

      // get current and last month views
      const currentMonthViews = data.current;
      const lastMonthViews = data.last;

      let name = this.getAttribute('name');

      if (name) {
        name = name.split(' ');

        name = name[0];
        name = name.toLowerCase();
      }
      else {
        name = 'User';
      }

      // calculate the percentage increase or decrease in views
      const percentage = lastMonthViews === 0 ? 100 : ((currentMonthViews - lastMonthViews) / lastMonthViews) * 100;

      let increaseOrDecrease = this.getLevel(name);

      // check if last month views is 0 and this month views is also 0
      if (lastMonthViews > 0 || currentMonthViews > 0) {
        // convert percentage to 1 decimal place if it is a decimal
        const percentageFormatted = percentage % 1 === 0 ? percentage : percentage.toFixed(1);

        // get the increase or decrease in views
        increaseOrDecrease = percentage > 0 ? this.getIncrease(percentageFormatted) : this.getDecrease(Math.abs(percentageFormatted));
      }

      // format the number of followers, views, stories and topics
      const followersFormatted = this.formatNumber(followers);
      const viewsFormatted = this.formatNumber(currentMonthViews);
      const storiesFormatted = this.formatNumber(stories);
      const topicsFormatted = this.formatNumber(topics);

      return /* html */`
      <p class="title">Highlights</p>
      <ul class="info">
        <li class="item">
          <span class="icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" fill="currentColor">
              <path d="M2 5.5a3.5 3.5 0 1 1 5.898 2.549 5.508 5.508 0 0 1 3.034 4.084.75.75 0 1 1-1.482.235 4 4 0 0 0-7.9 0 .75.75 0 0 1-1.482-.236A5.507 5.507 0 0 1 3.102 8.05 3.493 3.493 0 0 1 2 5.5ZM11 4a3.001 3.001 0 0 1 2.22 5.018 5.01 5.01 0 0 1 2.56 3.012.749.749 0 0 1-.885.954.752.752 0 0 1-.549-.514 3.507 3.507 0 0 0-2.522-2.372.75.75 0 0 1-.574-.73v-.352a.75.75 0 0 1 .416-.672A1.5 1.5 0 0 0 11 5.5.75.75 0 0 1 11 4Zm-5.5-.5a2 2 0 1 0-.001 3.999A2 2 0 0 0 5.5 3.5Z"></path>
            </svg>
          </span>
          <span class="link">
            <span class="numbers" id="followers">${followersFormatted}</span> ${followers === 1 ? 'person' : 'people'} follows ${name.toLowerCase()}
          </span>
        </li>
        <li class="item">
          <span class="icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" fill="currentColor">
              <path d="M6 2c.306 0 .582.187.696.471L10 10.731l1.304-3.26A.751.751 0 0 1 12 7h3.25a.75.75 0 0 1 0 1.5h-2.742l-1.812 4.528a.751.751 0 0 1-1.392 0L6 4.77 4.696 8.03A.75.75 0 0 1 4 8.5H.75a.75.75 0 0 1 0-1.5h2.742l1.812-4.529A.751.751 0 0 1 6 2Z"></path>
            </svg>
          </span>
          <span class="link">
            <span class="numbers" id="views">${viewsFormatted}</span> content views this month
          </span>
        </li>
        ${increaseOrDecrease}
        <li class="item">
          <span class="icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" fill="currentColor">
              <path d="M0 3.75C0 2.784.784 2 1.75 2h12.5c.966 0 1.75.784 1.75 1.75v8.5A1.75 1.75 0 0 1 14.25 14H1.75A1.75 1.75 0 0 1 0 12.25Zm1.75-.25a.25.25 0 0 0-.25.25v8.5c0 .138.112.25.25.25h12.5a.25.25 0 0 0 .25-.25v-8.5a.25.25 0 0 0-.25-.25ZM3.5 6.25a.75.75 0 0 1 .75-.75h7a.75.75 0 0 1 0 1.5h-7a.75.75 0 0 1-.75-.75Zm.75 2.25h4a.75.75 0 0 1 0 1.5h-4a.75.75 0 0 1 0-1.5Z"></path>
            </svg>
          </span>
          <span class="link">
            <span class="numbers" id="stories">${storiesFormatted}</span> published ${stories === 1 ? 'story' : 'stories'}/${stories === 1 ? 'post' : 'posts'}
          </span>
        </li>
        <li class="item">
          <span class="icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" fill="currentColor">
              <path d="M6.78 1.97a.75.75 0 0 1 0 1.06L3.81 6h6.44A4.75 4.75 0 0 1 15 10.75v2.5a.75.75 0 0 1-1.5 0v-2.5a3.25 3.25 0 0 0-3.25-3.25H3.81l2.97 2.97a.749.749 0 0 1-.326 1.275.749.749 0 0 1-.734-.215L1.47 7.28a.75.75 0 0 1 0-1.06l4.25-4.25a.75.75 0 0 1 1.06 0Z"></path>
            </svg>
          </span>
          <span class="link">
            <span class="numbers" id="replies">${replies}</span> replies addded so far
          </span>
        </li>
        <li class="item">
          <span class="icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" fill="currentColor">
              <path d="M6.368 1.01a.75.75 0 0 1 .623.859L6.57 4.5h3.98l.46-2.868a.75.75 0 0 1 1.48.237L12.07 4.5h2.18a.75.75 0 0 1 0 1.5h-2.42l-.64 4h2.56a.75.75 0 0 1 0 1.5h-2.8l-.46 2.869a.75.75 0 0 1-1.48-.237l.42-2.632H5.45l-.46 2.869a.75.75 0 0 1-1.48-.237l.42-2.632H1.75a.75.75 0 0 1 0-1.5h2.42l.64-4H2.25a.75.75 0 0 1 0-1.5h2.8l.46-2.868a.75.75 0 0 1 .858-.622ZM9.67 10l.64-4H6.33l-.64 4Z"></path>
            </svg>
          </span>
          <span class="link">
            subscribed to <span class="numbers" id="topics">${topicsFormatted}</span> topic${topics === 1 ? '' : 's'}
          </span>
        </li>
      </ul>
    `
    }

    getIncrease = percentage => {
      return /*html*/`
      <li class="item">
        <span class="icon increase">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" fill="currentColor">
            <path d="M4.53 4.75A.75.75 0 0 1 5.28 4h6.01a.75.75 0 0 1 .75.75v6.01a.75.75 0 0 1-1.5 0v-4.2l-5.26 5.261a.749.749 0 0 1-1.275-.326.749.749 0 0 1 .215-.734L9.48 5.5h-4.2a.75.75 0 0 1-.75-.75Z"></path>
          </svg>
        </span>
        <span class="link">
          <span class="numbers" id="percentage">${percentage}%</span> increase in views this month
        </span>
      </li>
    `
    }

    getLevel = name => {
      return /*html*/`
      <li class="item">
        <span class="icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" fill="currentColor">
            <path d="M11.93 8.5a4.002 4.002 0 0 1-7.86 0H.75a.75.75 0 0 1 0-1.5h3.32a4.002 4.002 0 0 1 7.86 0h3.32a.75.75 0 0 1 0 1.5Zm-1.43-.75a2.5 2.5 0 1 0-5 0 2.5 2.5 0 0 0 5 0Z"></path>
          </svg>
        </span>
        <span class="link">
          ${name} has no content views yet
        </span>
      </li>
    `
    }

    getDecrease = percentage => {
      return /*html*/`
      <li class="item">
        <span class="icon decrease">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" fill="currentColor">
            <path d="M4.22 4.179a.75.75 0 0 1 1.06 0l5.26 5.26v-4.2a.75.75 0 0 1 1.5 0v6.01a.75.75 0 0 1-.75.75H5.28a.75.75 0 0 1 0-1.5h4.2L4.22 5.24a.75.75 0 0 1 0-1.06Z"></path>
          </svg>
        </span>
        <span class="link">
          <span class="numbers" id="percentage">${percentage}%</span> decrease in views this month
        </span>
      </li>
    `
    }

    getEmpty = () => {
      return /* html */`
      <p class="title">Highlights</p>
      <div class="empty">
        <p>User highlights were not loaded, and error while fetching data</p>
        <p>Try refreshing the page or check your internet connection. If the problem persists, please contact support.</p>
      </div>
    `
    }

  	getStyles() {
  		return /* css */`
	    <style>
	      *,
	      *:after,
	      *:before {
	        box-sizing: border-box !important;
	        font-family: inherit;
	        -webkit-box-sizing: border-box !important;
	      }

	      *:focus {
	        outline: inherit !important;
	      }

	      *::-webkit-scrollbar {
	        width: 3px;
	      }

	      *::-webkit-scrollbar-track {
	        background: var(--scroll-bar-background);
	      }

	      *::-webkit-scrollbar-thumb {
	        width: 3px;
	        background: var(--scroll-bar-linear);
	        border-radius: 50px;
	      }

	      h1,
	      h2,
	      h3,
	      h4,
	      h5,
	      h6 {
	        padding: 0;
	        margin: 0;
	        font-family: inherit;
	      }

	      p,
	      ul,
	      ol {
	        padding: 0;
	        margin: 0;
	      }

	      a {
	        text-decoration: none;
	      }

	      :host {
        	font-size: 16px;
					margin: 0;
				  padding: 10px 0 0 0;
				  display: flex;
				  flex-flow: column;
				  gap: 10px;
				}

				div.content {
				  padding: 0;
				  display: flex;
				  flex-flow: row;
				  flex-wrap: wrap;
				  align-items: center;
				  justify-content: start;
				  width: 100%;
          padding: 0;
          gap: 10px;
        }
        
        p.title {
          width: 100%;
          border-bottom: var(--border);
          color: var(--text-color);
          font-family: var(--font-text), sans-serif;
          font-size: 1.2rem;
          line-height: 1.3;
          font-weight: 600;
          margin: 0;
          display: none;
          padding: 0 0 8px;
        }

        div.empty {
          width: 100%;
          padding: 0;
          margin: 0;
          display: flex;
          flex-flow: column;
          gap: 8px;
        }

        div.empty > p {
          width: 100%;
          padding: 0;
          margin: 0;
          color: var(--text-color);
          font-family: var(--font-text), sans-serif;
          font-size: 1rem;
          font-weight: 400;
        }
        
        ul.info {
          width: 100%;
          padding: 0;
          margin: 0;
          list-style-type: none;
          display: flex;
          flex-flow: column;
          gap: 10px;
        }
        
        ul.info > li.item {
          padding: 0;
          margin: 0;
          width: 100%;
          display: flex;
          flex-flow: row;
          align-items: center;
          flex-wrap: nowrap;
          gap: 10px;
        }
        
        ul.info > li.item > .icon {
          display: flex;
          align-items: center;
          justify-content: center;
          height: 26px;
          width: 26px;
          min-height: 26px;
          min-width: 26px;
          max-height: 26px;
          max-width: 26px;
          padding: 3px;
          border-radius: 50px;
          -webkit-border-radius: 50px;
          -moz-border-radius: 50px;
          background-color: var(--gray-background);
          color: var(--gray-color);
          font-size: 0.9rem;
          font-weight: 500;
          text-transform: capitalize;
        }
        
        ul.info > li.item > .icon > svg {
          height: 15px;
          width: 15px;
        }

        ul.info > li.item > .icon.increase {
          background: var(--accent-linear);
          color: var(--white-color);
        }

        ul.info > li.item > .icon.decrease {
          background: var(--error-linear);
          color: var(--white-color);
        }
        
        ul.info > li.item > .link {
          color: var(--text-color);
          font-family: var(--font-main), sans-serif;
          font-size: 1rem;
          font-weight: 400;
          text-decoration: none;
        }
        
        ul.info > li.item > a.link:hover {
          color: var(--text-color);
        }
        
        ul.info > li.item > .link .numbers {
          color: var(--highlight-color);
          font-weight: 600;
          font-family: var(--font-main), sans-serif;
          font-size: 0.95rem;
          display: inline-block;
          margin: 0 0 -2px 0;
        }
        
        ul.info > li.item.last {
          background-color: var(--gray-background);
          padding: 10px;
          margin: 5px 0;
          border-radius: 12px;
          -webkit-border-radius: 12px;
        }

				@media screen and (max-width:660px) {
					:host {
        		font-size: 16px;
					}

					::-webkit-scrollbar {
						-webkit-appearance: none;
					}

					a {
						cursor: default !important;
					}
				}
	    </style>
    `;
  	}
  }

  class InfoContainer extends HTMLElement {
  	constructor() {
  		// We are not even going to touch this.
  		super();

  		// let's create our shadow root
  		this.shadowObj = this.attachShadow({ mode: "open" });

  		this.render();
  	}

  	render() {
  		this.shadowObj.innerHTML = this.getTemplate();
  	}

  	connectedCallback() {
  		const contentContainer = this.shadowObj.querySelector('div.content');

  		this.fetchTopics(contentContainer);
  	}

  	fetchTopics = (contentContainer) => {
  		const topicsLoader = this.shadowObj.querySelector('info-loader');
  		const content = this.getInfo();
  		setTimeout(() => {
  			topicsLoader.remove();
  			contentContainer.insertAdjacentHTML('beforeend', content);
  		}, 2000);
  	}

  	getTemplate = () => {
  		// Show HTML Here
  		return `
      ${this.getBody()}
      ${this.getStyles()}
    `;
  	}

  	getLoader = () => {
  		return `
			<info-loader speed="300"></info-loader>
		`
  	}

  	getBody = () => {
  		// language=HTML
  		return /* html */`
			<div class="content">
				${this.getLoader()}
			</div>
    `;
  	}

    getInfo = () => {
      return /*html*/`
      <div class="company">
        <ul class="footer-list">
          <li class="item">
            <a href="/soon" class="item-link">Docs</a>
          </li>
          <li class="item">
            <a href="/soon" class="item-link">What’s New</a>
            <span class="dot"></span>
          </li>
          <li class="item">
            <a href="/soon" class="item-link">Give a feedback </a>
          </li>
          <li class="item">
            <a href="/soon" class="item-link">Request a feature</a>
          </li>
          <li class="item">
            <a href="/soon" class="item-link">Source code</a>
            <span class="dot"></span>
          </li>
          <li class="item">
            <a href="https://www.buymeacoffee.com/femar" class="item-link">Donate</a>
          </li>
          <li class="item">
            <a href="/soon" class="item-link">Contact</a>
          </li>
          <li class="item">
            <a href="/soon" class="item-link">&copy 2024 aduki, Inc</a>
          </li>
        </ul>
      </div>
    `
    }

  	getStyles() {
  		return /* css */`
	    <style>
	      *,
	      *:after,
	      *:before {
	        box-sizing: border-box !important;
	        font-family: inherit;
	        -webkit-box-sizing: border-box !important;
	      }

	      *:focus {
	        outline: inherit !important;
	      }

	      *::-webkit-scrollbar {
	        width: 3px;
	      }

	      *::-webkit-scrollbar-track {
	        background: var(--scroll-bar-background);
	      }

	      *::-webkit-scrollbar-thumb {
	        width: 3px;
	        background: var(--scroll-bar-linear);
	        border-radius: 50px;
	      }

	      h1,
	      h2,
	      h3,
	      h4,
	      h5,
	      h6 {
	        padding: 0;
	        margin: 0;
	        font-family: inherit;
	      }

	      p,
	      ul,
	      ol {
	        padding: 0;
	        margin: 0;
	      }

	      a {
	        text-decoration: none;
	      }

	      :host {
        	font-size: 16px;
					margin: 0;
				  padding: 0;
				  display: flex;
				  flex-flow: column;
				  gap: 10px;
				}

				div.content {
				  padding: 0;
				  display: flex;
				  flex-flow: row;
				  flex-wrap: wrap;
				  align-items: center;
				  justify-content: start;
				  gap: 0;
				  width: 100%;
				}

				.company {
          display: flex;
          flex-flow: column;
          align-items: center;
          gap: 10px;
          max-width: 500px;
        }

        .company >.title {
          color: var(--text-color);
          font-family: var(--font-text), sans-serif;
          font-size: 1.1rem;
          font-weight: 600;
        }

        .company > ul.footer-list {
          margin: 0;
          list-style-type: none;
          padding: 0 0 0 1px;
          display: flex;
          flex-flow: row;
          flex-wrap: wrap;
          align-items: center;
          justify-content: start;
          gap: 10px;
        }

        .company > ul.footer-list > li.item {
          margin: 0 10px 0 0;
          padding: 0;
          width: max-content;
          position: relative;
        }

        .company > ul.footer-list > li.item > .dot {
          display: inline-block;
          background: var(--accent-linear);
          width: 5px;
          height: 5px;
          position: absolute;
          right: -9px;
          top: 3px;
          border-radius: 5px;
          -webkit-border-radius: 5px;
          -moz-border-radius: 5px;
        }

        .company > ul.footer-list > li.item > a.item-link {
          color: var(--gray-color);
          /* font-size: 0.98rem; */
          text-decoration: none;
          font-weight: 400;
          font-size: 0.9rem;
        }

        .company > ul.footer-list > li.item > a.item-link:hover {
          /* color: var(--accent-color); */
          color: transparent;
          background: var(--accent-linear);
          background-clip: text;
          -webkit-background-clip: text;
          border-bottom: 1px solid var(--accent-color);
        }

				@media screen and (max-width:660px) {
					:host {
        		font-size: 16px;
					}

					::-webkit-scrollbar {
						-webkit-appearance: none;
					}

					a {
						cursor: default !important;
					}
				}
	    </style>
    `;
  	}
  }

  class PeopleContainer extends HTMLElement {
  	constructor() {
  		// We are not even going to touch this.
  		super();

  		this._url = this.getAttribute('url') || '/api/v1/users/recommended';

  		// let's create our shadow root
  		this.shadowObj = this.attachShadow({ mode: "open" });

  		this.render();
  	}

  	render() {
  		this.shadowObj.innerHTML = this.getTemplate();
  	}

  	connectedCallback() {
  		const contentContainer = this.shadowObj.querySelector('div.content');

  		this.fetchPeople(contentContainer);
  	}

  	fetchPeople = contentContainer => {
      const outerThis = this;
  		const peopleLoader = this.shadowObj.querySelector('people-loader');
  		setTimeout(() => {
        // fetch the user stats
        const options = {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          }
        };
    
        this.fetchWithTimeout(this._url, options)
          .then(response => {
            return response.json();
          })
          .then(data => {
            // check for success response
            if (data.success) {
              // update the content
              const content = outerThis.mapUsers(data.people);
              // remove the loader
              peopleLoader.remove();
              // insert the content
              contentContainer.insertAdjacentHTML('beforeend', content);
            }
            else {
              // display error message
              const content = outerThis.getEmpty();
              peopleLoader.remove();
              contentContainer.insertAdjacentHTML('beforeend', content);
            }
          })
          .catch(error => {
            // display error message
            const content = outerThis.getEmpty();
            peopleLoader.remove();
            contentContainer.insertAdjacentHTML('beforeend', content);
          });
  		}, 2000);
  	}

    fetchWithTimeout = async (url, options = {}, timeout = 9500) => {
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), timeout);
    
      try {
        const response = await fetch(url, {
          ...options,
          signal: controller.signal
        });

        return response;
      } catch (error) {
        if (error.name === 'AbortError') {
          throw new Error('Request timed out');
        }
        throw new Error(`Network error: ${error.message}`);
      } finally {
        clearTimeout(timeoutId);
      }
    };

  	mapUsers = data => {
      return data.map(user => {
  			let bio = user.bio === null ? 'This user has not added a bio yet.' : user.bio;
        // replace all " and ' with &quot; and &apos; to avoid breaking the html
        bio = bio.replace(/"/g, '&quot;').replace(/'/g, '&apos;');
        return /*html*/`
				<user-wrapper hash="${user.hash}" you="${user.you}" url="/u/${user.hash}" stories="${user.stories}" replies="${user.replies}" posts="${user.posts}"
          picture="${user.picture}" verified="${user.verified}" name="${user.name}" followers="${user.followers}" contact='${user.contact ? JSON.stringify(user.contact) : null}'
          following="${user.following}" user-follow="${user.is_following}" bio="${bio}">
				</user-wrapper>
      `
      }).join('');
    }

  	getTemplate = () => {
  		// Show HTML Here
  		return `
      ${this.getBody()}
      ${this.getStyles()}
    `;
  	}

  	getLoader = () => {
  		return `
			<people-loader speed="300"></people-loader>
		`
  	}

  	getBody = () => {
  		// language=HTML
  		return /* html */`
			<div class="title">
				<h2>Authors to follow</h2>
			</div>
			<div class="content">
				${this.getLoader()}
			</div>
    `;
  	}

    getEmpty = () => {
      return /* html */`
      <div class="empty">
        <p>No authors recommendation found at the moment.</p>
				<p> There might an issues, try refreshing the page or check back later.</p>
      </div>
    `
    }

  	getStyles() {
  		return /* css */`
	    <style>
	      *,
	      *:after,
	      *:before {
	        box-sizing: border-box !important;
	        font-family: inherit;
	        -webkit-box-sizing: border-box !important;
	      }

	      *:focus {
	        outline: inherit !important;
	      }

	      *::-webkit-scrollbar {
	        width: 3px;
	      }

	      *::-webkit-scrollbar-track {
	        background: var(--scroll-bar-background);
	      }

	      *::-webkit-scrollbar-thumb {
	        width: 3px;
	        background: var(--scroll-bar-linear);
	        border-radius: 50px;
	      }

	      h1,
	      h2,
	      h3,
	      h4,
	      h5,
	      h6 {
	        padding: 0;
	        margin: 0;
	        font-family: inherit;
	      }

	      p,
	      ul,
	      ol {
	        padding: 0;
	        margin: 0;
	      }

	      a {
	        text-decoration: none;
	      }

	      :host {
        	font-size: 16px;
					margin: 0;
				  padding: 0;
				  display: flex;
				  flex-flow: column;
				  gap: 8px;
				}

				div.content {
				  margin: 0;
				  padding: 0;
				  display: flex;
				  flex-flow: row;
				  flex-wrap: wrap;
				  align-items: center;
				  justify-content: start;
				  gap: 10px;
				  width: 100%;
				}

				div.empty {
          width: 100%;
          padding: 0;
          margin: 0;
          display: flex;
          flex-flow: column;
          gap: 8px;
        }

        div.empty > p {
          width: 100%;
          padding: 0;
          margin: 0;
          color: var(--text-color);
          font-family: var(--font-text), sans-serif;
          font-size: 1rem;
          font-weight: 400;
        }

				.title {
          display: flex;
					width: 100%;
          flex-flow: column;
					padding: 5px 10px 6px;
          gap: 0;
					background: var(--light-linear);
					border-radius: 7px;
        }

        .title > h2 {
          font-size: 1.5rem;
          font-weight: 500;
          font-family: var(--font-text), sans-serif;
          margin: 0;
          color: var(--text-color);
        }

        .title > p.info {
          margin: 0;
          font-size: 0.9rem;
          font-style: italic;
          font-weight: 400;
          font-family: var(--font-text), sans-serif;
          margin: 0;
          color: var(--text-color);
        }


				@media screen and (max-width:660px) {
					:host {
        		font-size: 16px;
						padding: 15px 0;
					}

					::-webkit-scrollbar {
						-webkit-appearance: none;
					}

					a {
						cursor: default !important;
					}
				}
	    </style>
    `;
  	}
  }

  class DiscoverPeople extends HTMLElement {
    constructor() {
      // We are not even going to touch this.
      super();

  		this._url = this.getAttribute('url');

  		// add limit query in the url
  		this._url = `${this._url}?limit=20`;

  		this._isHome = this.getAttribute('home') === 'true';

      // let's create our shadow root
      this.shadowObj = this.attachShadow({ mode: "open" });

      this.render();
    }

    render() {
      this.shadowObj.innerHTML = this.getTemplate();
    }

    connectedCallback() {
      // get mql
  		const mql = window.matchMedia('(min-width: 660px)');

      const contentContainer = this.shadowObj.querySelector('.people-list');

  		this.fetchPeople(contentContainer, mql.matches);
    }

  	activateRefresh = () => {
      const finish = this.shadowObj.querySelector('.finish');
      if (finish) {
        const btn = finish.querySelector('button.finish');
        btn.addEventListener('click', () => {
          // unblock the fetching
          this._block = false;
          this._empty = false;
          
          // re fetch the content
          const feedContainer = this.shadowObj.querySelector('.people-list');

          // set the loader
          feedContainer.innerHTML = this.getLoader();

          setTimeout(() => {
            this.fetchPeople(feedContainer);
          }, 1000);
        });
      }
    }

    fetchPeople = (contentContainer, mql) => {
      const outerThis = this;
  		const peopleLoader = this.shadowObj.querySelector('authors-loader');
  		const options = {
  			method: 'GET',
  			// set the cache control to max-age to 2 hours
  			"Cache-Control": "max-age=7200",
  			"Accept": "application/json"
  		};
  		this.getCacheData(this._url, 7200, options)
  			.then(result => {
  				const data = result.data;
  				// check for success response
  				if (result.success) {
  					if (data.people.length === 0) {
  						// display empty message
  						const content = outerThis.getEmpty();
  						// remove loader
  						peopleLoader.remove();
  						contentContainer.insertAdjacentHTML('beforeend', content);
  						return;
  					}
  					// update the content
  					const content = outerThis.mapUsers(data.people);
  					// remove loader
  					peopleLoader.remove();
  					// add title
  					contentContainer.insertAdjacentHTML('beforebegin', outerThis.getTitle());
  					contentContainer.insertAdjacentHTML('beforeend', content);
  					// activate controls
  					if (mql) {
  						outerThis.activateControls(contentContainer);
  					}

  					// set next
  					window.home = {
  						last: false,
  						next: 4,
  						loaded: true
  					};
  				}
  				else {
  					// display error message
  					const content = outerThis.getEmpty();
  					// remove loader
  					peopleLoader.remove();
  					contentContainer.insertAdjacentHTML('beforeend', content);				}
  			})
  			.catch(error => {
  				// console.error(error);
  				// display error message
  				const content = outerThis.getWrongMessage();
  				// remove loader
  				peopleLoader.remove();
  				contentContainer.insertAdjacentHTML('beforeend', content);

  				// activate refresh
  				outerThis.activateRefresh();
  			});
  	}

    fetchWithTimeout = async (url, options = {}, timeout = 9500) => {
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), timeout);
    
      try {
        const response = await fetch(url, {
          ...options,
          signal: controller.signal
        });

        return response;
      } catch (error) {
        if (error.name === 'AbortError') {
          throw new Error('Request timed out');
        }
        throw new Error(`Network error: ${error.message}`);
      } finally {
        clearTimeout(timeoutId);
      }
    };

  	getCacheData = async (url, maxAge, options = {}) => {
  		const cacheName = "user-cache";

  		try {
  			const cache = await caches.open(cacheName);
  			const cachedResponse = await cache.match(url);

  			if (cachedResponse) {
  				const cachedData = await cachedResponse.json();
  				const cacheTime = cachedData.timestamp;

  				// Check if cache is still valid
  				if (Date.now() - cacheTime < maxAge) {
  					return cachedData.data;
  				}
  			}

  			// If cache doesn't exist or is expired, fetch new data
  			const networkResponse = await this.fetchWithTimeout(url, options);
  			const data = await networkResponse.clone().json();

  			// Store the new data in cache with a timestamp
  			const cacheData = {
  				data: data,
  				timestamp: Date.now()
  			};
  			
  			const cacheResponse = new Response(JSON.stringify(cacheData));
  			await cache.put(url, cacheResponse);

  			return data;
  		} catch (error) {
  			console.error('Error fetching data:', error);
  			throw error;
  		}
  	};

  	mapUsers = data => {
      return data.map(user => {
  			let bio = user.bio === null ? 'This user has not added a bio yet.' : user.bio;
        // replace all " and ' with &quot; and &apos; to avoid breaking the html
        bio = bio.replace(/"/g, '&quot;').replace(/'/g, '&apos;');
        return /*html*/`
				<person-wrapper hash="${user.hash}" you="${user.you}" url="/u/${user.hash}" stories="${user.stories}" replies="${user.replies}" posts="${user.posts}"
          picture="${user.picture}" verified="${user.verified}" name="${user.name}" followers="${user.followers}" contact='${user.contact ? JSON.stringify(user.contact) : null}'
          following="${user.following}" user-follow="${user.is_following}" bio="${bio}">
				</person-wrapper>
      `
      }).join('');
    }

  	activateControls = contentContainer => {
  		// select all controls
  		const leftControl = this.shadowObj.querySelector('.control.left');
  		const rightControl = this.shadowObj.querySelector('.control.right');

  		// If left control and right control exists
  		if (leftControl && rightControl) {

  			// add event listener to left control
  			leftControl.addEventListener('click', () => {
  				// Scroll by 200px smoothly
  				contentContainer.scrollTo({
  					left: contentContainer.scrollLeft - 300,
  					behavior: 'smooth'
  				});
  			});

  			// add event listener to right control
  			rightControl.addEventListener('click', () => {
  				// Scroll by 200px smoothly
  				contentContainer.scrollTo({
  					left: contentContainer.scrollLeft + 300,
  					behavior: 'smooth'
  				});
  			});
  			
  		}
  	}

    getTemplate = () => {
      // Show HTML Here
      return `
      ${this.getBody()}
      ${this.getStyles()}
    `;
    }

    getLoader = () => {
      return `
			<authors-loader speed="300"></authors-loader>
		`
    }

    getBody = () => {
  		// get mql
  		const mql = window.matchMedia('(min-width: 660px)');
      // language=HTML
      return `
			<div class="people-list">
				${this.getLoader()}
				${this.getControls(mql.matches)}
			</div>
    `;
    }

  	getControls = mql => {
  		// Check if mql is desktop
  		if(mql) {
  			return /*html*/`
				<div class="left control">
					<span>
						<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" fill="currentColor">
							<path d="M9.78 12.78a.75.75 0 0 1-1.06 0L4.47 8.53a.75.75 0 0 1 0-1.06l4.25-4.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042L6.06 8l3.72 3.72a.75.75 0 0 1 0 1.06Z"></path>
						</svg>
					</span>
				</div>
				<div class="right control">
					<span>
						<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" fill="currentColor">
							<path d="M6.22 3.22a.75.75 0 0 1 1.06 0l4.25 4.25a.75.75 0 0 1 0 1.06l-4.25 4.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042L9.94 8 6.22 4.28a.75.75 0 0 1 0-1.06Z"></path>
						</svg>
					</span>
				</div>
			`
  		}
  		else return '';
  	}

  	getTitle = () => {
  		return /*html*/`
			<div class="title">
				<h2>Discover people</h2>
			</div>
		`
  	}

  	getEmpty = () => {
      return /* html */`
      <div class="empty">
        <p>No authors recommendation found at the moment.</p>
      </div>
    `
    }

    getWrongMessage = () => {
      return /* html */`
      <div class="finish">
        <h2 class="finish__title">Oops!</h2>
        <p class="desc">
          An error occurred while fetching the recommended authors. Please check your connection and try again.
        </p>
        <button class="finish">Retry</button>
      </div>
    `;
    }

    getStyles() {
      return /* css */`
	    <style>
	      *,
	      *:after,
	      *:before {
	        box-sizing: border-box !important;
	        font-family: inherit;
	        -webkit-box-sizing: border-box !important;
	      }

	      *:focus {
	        outline: inherit !important;
	      }

	      *::-webkit-scrollbar {
	        width: 3px;
	      }

	      *::-webkit-scrollbar-track {
	        background: var(--scroll-bar-background);
	      }

	      *::-webkit-scrollbar-thumb {
	        width: 3px;
	        background: var(--scroll-bar-linear);
	        border-radius: 50px;
	      }

	      h1,
	      h2,
	      h3,
	      h4,
	      h5,
	      h6 {
	        padding: 0;
	        margin: 0;
	        font-family: inherit;
	      }

	      p,
	      ul,
	      ol {
	        padding: 0;
	        margin: 0;
	      }

	      a {
	        text-decoration: none;
	      }

	      :host {
        	font-size: 16px;
				  background-color: var(--background);
					border-bottom: var(--border);
				  padding: 15px 0;
					position: relative;
				  display: flex;
				  flex-flow: column;
				  gap: 15px;
          width: 100%;
          max-width: 100%;
				}

				div.empty {
          width: 100%;
          padding: 0;
          margin: 0;
          display: flex;
          flex-flow: column;
          gap: 8px;
        }

        div.empty > p {
          width: 100%;
          padding: 0;
          margin: 0;
          color: var(--text-color);
          font-family: var(--font-text), sans-serif;
          font-size: 1rem;
          font-weight: 400;
        }

				.people-list {
					background-color: var(--background);
					display: flex;
					flex-flow: row;
					padding: 0;
					gap: 20px;
					width: 100%;
          max-width: 100%;
					overflow-x: scroll;
					-ms-overflow-style: none;
					scrollbar-width: none;
				}

				.people-list::-webkit-scrollbar {
					display: none !important;
					visibility: hidden;
					-webkit-appearance: none;
				}

				.control {
					position: absolute;
					z-index: 3;
					opacity: 0;
					top: 20%;
					left: 0;
					width: 40px;
					height: 80%;
					pointer-events: none;
					display: flex;
					align-items: center;
					justify-content: center;
					background: var(--controls-gradient-left);
					transition: all 0.3s ease-in-out;
				}

				.control.right {
					left: unset;
					right: 0;
					background: var(--controls-gradient-right);
				}

				.people-list:hover .control {
					opacity: 1;
					pointer-events: all;
				}

				.control > span {
					cursor: pointer;
					display: flex;
					align-items: center;
					justify-content: center;
					background: var(--accent-linear);
					color: var(--white-color);
					border-radius: 50%;
					width: 30px;
					height: 30px;
					transition: background-color 0.3s;
				}

				.title {
          display: flex;
					width: 100%;
          flex-flow: column;
					padding: 5px 10px 6px;
					margin: 0 0 0 -2px;
          gap: 0;
					background: var(--light-linear);
					border-radius: 7px;
        }

        .title > h2 {
          font-size: 1.5rem;
          font-weight: 500;
          font-family: var(--font-text), sans-serif;
          margin: 0;
          color: var(--text-color);
        }

        .title > p.info {
          margin: 0;
          font-size: 0.9rem;
          font-style: italic;
          font-weight: 400;
          font-family: var(--font-text), sans-serif;
          margin: 0;
          color: var(--text-color);
        }

				div.finish {
          padding: 10px 0 40px;
          width: 100%;
          min-width: 100%;
          height: auto;
          display: flex;
          flex-flow: column;
          justify-content: center;
          align-items: center;
          gap: 5px;
        }

        div.finish > h2.finish__title {
          margin: 10px 0 0 0;
          font-size: 1.25rem;
          font-weight: 500;
          font-family: var(--font-read), sans-serif;
          color: var(--text-color);
        }

        div.finish > p.desc {
          margin: 0;
          font-size: 0.85rem;
          font-family: var(--font-read), sans-serif;
          color: var(--gray-color);
          line-height: 1.4;
          text-align: center;
        }

        div.finish > button.finish {
          border: none;
          background: var(--accent-linear);
          font-family: var(--font-main), sans-serif;
          text-decoration: none;
          color: var(--white-color);
          margin: 10px 0 0;
          font-size: 1rem;
          font-weight: 500;
          cursor: pointer;
          display: flex;
          width: max-content;
          flex-flow: row;
          align-items: center;
          text-transform: capitalize;
          justify-content: center;
          padding: 7px 18px 8px;
          border-radius: 50px;
          -webkit-border-radius: 50px;
          -moz-border-radius: 50px;
        }

				@media screen and (max-width:660px) {
					:host {
        		font-size: 16px;
						padding: 15px 0 10px;
						border-bottom: none;
					}

					a {
						cursor: default !important;
					}

					div.finish > button.finish {
            cursor: default !important;
          }
				}
	    </style>
    `;
    }
  }

  class StatContainer extends HTMLElement {
    constructor() {
      // We are not even going to touch this.
      super();

      this._url = this.getAttribute('api') || '/api/v1/u/stats';

      // let's create our shadow root
      this.shadowObj = this.attachShadow({ mode: "open" });

      this.render();
    }

    render() {
      this.shadowObj.innerHTML = this.getTemplate();
    }

    connectedCallback() {
      this.activateTab();
    }

    activateTab = () => {
      const outerThis = this;
      const tab = this.shadowObj.querySelector('ul#tab');
      const contentContainer = this.shadowObj.querySelector('.content');

      if (tab && contentContainer) {
        const line = tab.querySelector('span.line');
        const tabItems = tab.querySelectorAll('li.tab-item');
        let activeTab = tab.querySelector('li.tab-item.active');

        tabItems.forEach((tab, index) => {
          tab.addEventListener('click', e => {
            e.preventDefault();
            e.stopPropagation();

            // Calculate half tab width - 10px
            const tabWidth = (tab.offsetWidth / 2) - 20;

            if (index === 0) {
              line.style.left = '0';
            }
            else {
              line.style.left = `${tab.offsetLeft + tabWidth}px`;
            }

            if (tab.dataset.element === activeTab.dataset.element) {
              return;
            }
            else {
              activeTab.classList.remove('active');
              tab.classList.add('active');
              activeTab = tab;
              if (tab.dataset.element === "all") {
                contentContainer.innerHTML = ` ${outerThis.getStats()}`;
              } else if (tab.dataset.element === "stories") {
                contentContainer.innerHTML = outerThis.getStatFeedStories();
              } else if (tab.dataset.element === "replies") {
                contentContainer.innerHTML = outerThis.getStatFeedReplies();
              }
            }
          });
        });
      }
    }

    getTemplate = () => {
      // Show HTML Here
      return `
      ${this.getBody()}
      ${this.getStyles()}
    `;
    }

    getBody = () => {
      // language=HTML
      return `
      ${this.getHeader()}
      ${this.getTab()}
			<div class="content">
				${this.getStats()}
      </div>
    `;
    }

    getStats = () =>  {
      return /* html */`
      <month-stat url="${this._url}"></month-stat>
    `;
    }

    getStatFeedStories = () => {
      return /* html */`
      <stat-feed kind="stories" api="${this.getAttribute('stories-stats')}" page="1" limit="10"></stat-feed>
    `;
    }

    getStatFeedReplies = () => {
      return /* html */`
      <stat-feed kind="replies" api="${this.getAttribute('replies-stats')}" page="1" limit="10"></stat-feed>
    `;
    }

    getHeader = () => {
      return /* html */`
      <div class="top">
        <p class="desc">
          Your stats are a summary of your interactions on the platform. You can view your stories, replies and likes and it updates on a daily basis.
        </p>
      </div>
    `;
    }

    getTab = () => {
      return /* html */`
      <div class="actions">
        <ul id="tab" class="tab">
          <li data-element="all" class="tab-item all active">
            <span class="text">All</span>
          </li>
          <li data-element="stories" class="tab-item stories">
            <span class="text">Stories</span>
          </li>
          <li data-element="replies" class="tab-item replies">
            <span class="text">Replies</span>
          </li>
          <span class="line"></span>
        </ul>
      </div>
    `;
    }

    getStyles() {
      return /* css */`
      <style>
        *,
        *:after,
        *:before {
          box-sizing: border-box !important;
          font-family: inherit;
          -webkit-box-sizing: border-box !important;
        }

        *:focus {
          outline: inherit !important;
        }

        *::-webkit-scrollbar {
          width: 3px;
        }

        *::-webkit-scrollbar-track {
          background: var(--scroll-bar-background);
        }

        *::-webkit-scrollbar-thumb {
          width: 3px;
          background: var(--scroll-bar-linear);
          border-radius: 50px;
        }

        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
          padding: 0;
          margin: 0;
          font-family: inherit;
        }

        p,
        ul,
        ol {
          padding: 0;
          margin: 0;
        }

        a {
          text-decoration: none;
        }

        :host {
          font-size: 16px;
          display: flex;
          flex-flow: column;
          gap: 0;
          padding: 0;
          width: 100%;
        }

        .top {
          display: flex;
          flex-flow: column;
          gap: 5px;
          padding: 0;
          width: 100%;
        }

        .top > h4.title {
          border-bottom: var(--border-mobile);
          display: flex;
          align-items: center;
          color: var(--title-color);
          font-size: 1.3rem;
          font-weight: 500;
          margin: 0;
          padding: 0 0 6px 0;
        }

        .top > .desc {
          margin: 0;
          padding: 10px 0;
          color: var(--text-color);
          font-size: 1rem;
          font-family: var(--font-main), sans-serif;
        }

        .actions {
          border-bottom: var(--border);
          background-color: var(--background);
          display: flex;
          flex-flow: column;
          gap: 0;
          z-index: 3;
          width: 100%;
          position: sticky;
          top: 60px;
        }

        .actions > ul.tab {
          height: max-content;
          width: 100%;
          padding: 0;
          margin: 0;
          list-style-type: none;
          display: flex;
          gap: 0;
          align-items: center;
          max-width: 100%;
          overflow-x: scroll;
          -ms-overflow-style: none;
          scrollbar-width: none;
        }

        .actions > ul.tab::-webkit-scrollbar {
          display: none !important;
          visibility: hidden;
        }

        .actions > ul.tab > li.tab-item {
          color: var(--gray-color);
          font-family: var(--font-text), sans-serif;
          font-weight: 400;
          padding: 6px 20px 8px 0;
          margin: 0;
          display: flex;
          align-items: center;
          cursor: pointer;
          overflow: visible;
          font-size: 0.95rem;
        }

        .actions > ul.tab > li.tab-item > .text {
          font-weight: 500;
          font-size: 1rem;
        }

        .actions > ul.tab > li.tab-item:hover > .text {
          color: transparent;
          background: var(--accent-linear);
          background-clip: text;
          -webkit-background-clip: text;
        }

        .actions > ul.tab > li.active {
          font-size: 0.95rem;
          font-family: var(--font-read), sans-serif;
        }

        .actions > ul.tab > li.active > .text {
          color: transparent;
          background: var(--accent-linear);
          background-clip: text;
          -webkit-background-clip: text;
          font-family: var(--font-read), sans-serif;
        }

        .actions > ul.tab span.line {
          position: absolute;
          z-index: 1;
          background: var(--accent-linear);
          display: inline-block;
          bottom: -2.5px;
          left: 0px;
          width: 20px;
          min-height: 5px;
          border-top-left-radius: 5px;
          border-top-right-radius: 5px;
          border-bottom-left-radius: 5px;
          border-bottom-right-radius: 5px;
          transition: all 300ms ease-in-out;
        }

        .content {
          /* border: var(--border); */
          display: flex;
          flex-flow: column;
          gap: 10px;
          padding: 0;
          width: 100%;
        }

        @media screen and (max-width:600px) {
          ::-webkit-scrollbar {
            -webkit-appearance: none;
          }

          .top > .desc {
            margin: 0;
            padding: 6px 0 10px;
            color: var(--text-color);
            font-size: 1rem;
            line-height: 1.3;
            font-family: var(--font-main), sans-serif;
          }

          .actions {
            position: sticky;
            top: 50px;
          }

          a,
          .actions > ul.tab > li.tab-item {
            cursor: default !important;
          }
        }

      </style>
    `;
    }
  }

  class StoriesContainer extends HTMLElement {
    constructor() {
      // We are not even going to touch this.
      super();

      this._url = this.getAttribute('url');

      // let's create our shadow root
      this.shadowObj = this.attachShadow({ mode: "open" });

      this.render();
    }

    convertToBoolean = value => {
      return value === 'true';
    }

    render() {
      this.shadowObj.innerHTML = this.getTemplate();
    }

    connectedCallback() {
      const contentContainer = this.shadowObj.querySelector('.stories');

      // check if offline
      const offline = this.convertToBoolean(this.getAttribute('offline'));

      if (offline) {
        this.fetchOfflineFeeds(contentContainer);
      } else {
        this.fetchStories(contentContainer);
      }
    }

    activateRefresh = () => {
      const finish = this.shadowObj.querySelector('.finish');
      if (finish) {
        const btn = finish.querySelector('button.finish');
        btn.addEventListener('click', () => {
          // unblock the fetching
          this._block = false;
          this._empty = false;
          
          // re fetch the content
          const feedContainer = this.shadowObj.querySelector('.stories');

          // set the loader
          feedContainer.innerHTML = this.getLoader();

          setTimeout(() => {
            this.fetchStories(feedContainer);
          }, 1000);
        });
      }
    }

    activateOfflineRefresh = () => {
      const finish = this.shadowObj.querySelector('.finish');
      if (finish) {
        const btn = finish.querySelector('button.finish');
        btn.addEventListener('click', () => {
          // unblock the fetching
          this._block = false;
          this._empty = false;
          
          // re fetch the content
          const feedContainer = this.shadowObj.querySelector('.stories');

          // set the loader
          feedContainer.innerHTML = this.getLoader();

          setTimeout(() => {
            this.fetchOfflineFeeds(feedContainer);
          }, 1000);
        });
      }
    }

    fetchStories = contentContainer => {
      const mql = window.matchMedia('(max-width: 660px)');
      const outerThis = this;
  		// fetch the user stats
      const options = {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json'
        }
      };

      this.fetchWithTimeout(this._url, options)
        .then(response => {
          return response.json();
        })
        .then(data => {
          // check for success response
          if (data.success) {
            if(data.stories.length === 0) {
              // display empty message
              const content = outerThis.getEmpty();
              contentContainer.innerHTML = content;
              return;
            }
            // update the content
            const content = outerThis.mapFields(data.stories);
            contentContainer.innerHTML = content;
            // set the last item border-bottom to none
            outerThis.setLastItem(contentContainer);

            if (mql.matches) {
              // set next
              window.home = {
                last: false,
                next: 2,
                loaded: true
              };
            } else {
              // set next
              window.home = {
                last: false,
                next: 3,
                loaded: true
              };
            }
          }
          else {
            // display error message
            const content = outerThis.getEmpty();
            contentContainer.innerHTML = content;
          }
        })
        .catch(error => {
          // display error message
          contentContainer.innerHTML = outerThis.getWrongMessage();

          // activate the refresh button
          outerThis.activateRefresh();
        });
  	}

    fetchOfflineFeeds = async feedContainer => {
      const mql = window.matchMedia('(max-width: 660px)');
      const outerThis = this;
      const url = this._url;
      try {
        // fetch from cache
        const data = await outerThis.getOfflineData(url);

        // if empty
        if (data.stories.length === 0) {
          // display empty message
          feedContainer.innerHTML = outerThis.getEmpty();
          return;
        }

        // update the content
        const content = outerThis.mapFields(data.stories);
        feedContainer.innerHTML = content;
        // set the last item border-bottom to none
        outerThis.setLastItem(feedContainer);

        if (mql.matches) {
          // set next
          window.home = {
            last: false,
            next: 2,
            loaded: true
          };
        } else {
          // set next
          window.home = {
            last: false,
            next: 3,
            loaded: true
          };
        }
      } catch (error) {
        // display error message
        feedContainer.innerHTML = outerThis.getOfflineWrong();
        outerThis.activateOfflineRefresh();
      }
    }

    getOfflineData = async url => {
      const cacheName = "user-cache";

      try {
        const cache = await caches.open(cacheName);
        const cachedResponse = await cache.match(url);

        if (cachedResponse) {
          const cachedData = await cachedResponse.json();
    
          // return the data
          return cachedData.data;
        } else {
          // throw an error
          throw new Error('No data available');
        }

      } catch (error) {
        // console.error('Error fetching data:', error);
        throw error;
      }
    }

    fetchWithTimeout = async (url, options = {}, timeout = 9500) => {
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), timeout);
    
      try {
        const response = await fetch(url, {
          ...options,
          signal: controller.signal
        });

        return response;
      } catch (error) {
        if (error.name === 'AbortError') {
          throw new Error('Request timed out');
        }
        throw new Error(`Network error: ${error.message}`);
      } finally {
        clearTimeout(timeoutId);
      }
    }

    mapFields = data => {
      return data.map(story => {
        const author = story.story_author;
        let bio = author.bio === null ? 'This user has not added a bio yet.' : author.bio;
        // replace all " and ' with &quot; and &apos; to avoid breaking the html
        bio = bio.replace(/"/g, '&quot;').replace(/'/g, '&apos;');
        const url = `/p/${story.hash.toLowerCase()}`;
        const images = story.images ? story.images.join(',') : ''; 
        if (story.kind === "post") {
          return /*html*/`
          <quick-post story="quick" url="${url}" hash="${story.hash}" likes="${story.likes}" 
            replies="${story.replies}" liked="${story.liked ? 'true' : 'false'}" views="${story.views}" time="${story.createdAt}" 
            replies-url="/api/v1${url}/replies" likes-url="/api/v1${url}/likes" images="${images}"
            author-url="/u/${author.hash}" author-stories="${author.stories}" author-replies="${author.replies}"
            author-hash="${author.hash}" author-you="${story.you ? 'true' : 'false'}" author-img="${author.picture}" 
            author-verified="${author.verified ? 'true' : 'false'}" author-name="${author.name}" author-followers="${author.followers}" 
            author-following="${author.following}" author-follow="${author.is_following ? 'true' : 'false'}" author-contact='${author.contact ? JSON.stringify(author.contact) : null}' 
            author-bio="${bio}">
            ${story.content}
          </quick-post>
        `
        }
        else if(story.kind === "poll") {
          return /*html*/`
          <poll-post story="poll" url="${url}" hash="${story.hash}" likes="${story.likes}" images="${images}"
            replies="${story.replies}" liked="${story.liked ? 'true' : 'false'}" views="${story.views}" time="${story.createdAt}" 
            voted="${story.option ? 'true' : 'false'}" selected="${story.option}" end-time="${story.end}" replies-url="/api/v1${url}/replies" 
            likes-url="/api/v1${url}/likes" options='${story.poll}' votes="${story.votes}" 
            author-url="/u/${author.hash}" author-stories="${author.stories}" author-replies="${author.replies}"
            author-hash="${author.hash}" author-you="${story.you ? 'true' : 'false'}" author-img="${author.picture}" 
            author-verified="${author.verified ? 'true' : 'false'}" author-name="${author.name}" author-followers="${author.followers}" 
            author-following="${author.following}" author-follow="${author.is_following ? 'true' : 'false'}" author-contact='${author.contact ? JSON.stringify(author.contact) : null}'
            author-bio="${bio}">
            ${story.content}
          </poll-post>
        `
        }
        else if (story.kind === "story") {
          return /*html*/`
          <story-post story="story" hash="${story.hash}" url="${url}" images="${images}"
            topics="${story.topics.length === 0 ? 'story' : story.topics }" story-title="${story.title}" time="${story.createdAt}" replies-url="/api/v1${url}/replies" 
            likes-url="/api/v1${url}/likes" replies="${story.replies}" liked="${story.liked ? 'true' : 'false'}" likes="${story.likes}" 
            views="${story.views}" 
            author-url="/u/${author.hash}" author-stories="${author.stories}" author-replies="${author.replies}"
            author-hash="${author.hash}" author-you="${story.you ? 'true' : 'false'}" author-contact='${author.contact ? JSON.stringify(author.contact) : null}'
            author-img="${author.picture}" author-verified="${author.verified ? 'true' : 'false'}" author-name="${author.name}" 
            author-followers="${author.followers}" author-following="${author.following}" author-follow="${author.is_following ? 'true' : 'false'}" 
            author-bio="${bio}">
            ${story.content}
          </story-post>
        `
        }
      }).join('');
    }

    setLastItem = contentContainer => {
      // get last element child (can be a story or a reply)
      const lastItem = contentContainer.lastElementChild;

      // set border-bottom to none
      if (lastItem) {
        lastItem.style.setProperty('border-bottom', 'none');
      }
    }

    getTemplate = () => {
      // Show HTML Here
      return `
      ${this.getBody()}
      ${this.getStyles()}
    `;
    }

    getLoader() {
      return /* html */`
      <div class="loader-container">
        <span id="btn-loader">
          <span class="loader-alt"></span>
        </span>
      </div>
    `
    }

    getBody = () => {
      // language=HTML
      return /*html*/`
			<div class="stories new">
				${this.getLoader()}
      </div>
    `;
    }

    getEmpty = () => {
      return /* html */`
    <div class="finish">
      <h2 class="title">Oops!</h2>
      <p class="desc">
        There are no stories available at the moment. Please check back later.
      </p>
      <button class="finish">Retry</button>
    </div>
    `
    }

    getWrongMessage = () => {
      return /* html */`
      <div class="finish">
        <h2 class="title">Oops!</h2>
        <p class="desc">
          An error occurred while fetching the stories. Please check your connection and try again.
        </p>
        <button class="finish">Retry</button>
      </div>
    `;
    }

    getOfflineWrong = () => {
      return /* html */`
      <div class="finish">
        <h2 class="title">Something went wrong!</h2>
        <p class="desc">
          There was an error getting offline feeds. Please you need to be online to fetch the feeds.
        </p>
        <button class="finish">Retry</button>
      </div>
    `;
    }

    getStyles() {
      return /* css */`
      <style>
        *,
        *:after,
        *:before {
          box-sizing: border-box !important;
          font-family: inherit;
          -webkit-box-sizing: border-box !important;
        }

        *:focus {
          outline: inherit !important;
        }

        *::-webkit-scrollbar {
          width: 3px;
        }

        *::-webkit-scrollbar-track {
          background: var(--scroll-bar-background);
        }

        *::-webkit-scrollbar-thumb {
          width: 3px;
          background: var(--scroll-bar-linear);
          border-radius: 50px;
        }

        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
          padding: 0;
          margin: 0;
          font-family: inherit;
        }

        p,
        ul,
        ol {
          padding: 0;
          margin: 0;
        }

        a {
          text-decoration: none;
        }

        :host {
          font-size: 16px;
          width: 100%;
        }

        div.loader-container {
          position: relative;
          width: 100%;
          height: 180px;
          padding: 0 0 30px 0;
        }

        #btn-loader {
          position: absolute;
          top: 0;
          left: 0;
          bottom: 0;
          right: 0;
          z-index: 5;
          display: flex;
          align-items: center;
          justify-content: center;
          border-radius: inherit;
        }

        #btn-loader > .loader-alt {
          width: 35px;
          aspect-ratio: 1;
          --_g: no-repeat radial-gradient(farthest-side, #18A565 94%, #0000);
          --_g1: no-repeat radial-gradient(farthest-side, #21D029 94%, #0000);
          --_g2: no-repeat radial-gradient(farthest-side, #df791a 94%, #0000);
          --_g3: no-repeat radial-gradient(farthest-side, #f09c4e 94%, #0000);
          background:    var(--_g) 0 0,    var(--_g1) 100% 0,    var(--_g2) 100% 100%,    var(--_g3) 0 100%;
          background-size: 30% 30%;
          animation: l38 .9s infinite ease-in-out;
          -webkit-animation: l38 .9s infinite ease-in-out;
        }

        #btn-loader > .loader {
          width: 20px;
          aspect-ratio: 1;
          --_g: no-repeat radial-gradient(farthest-side, #ffffff 94%, #0000);
          --_g1: no-repeat radial-gradient(farthest-side, #ffffff 94%, #0000);
          --_g2: no-repeat radial-gradient(farthest-side, #df791a 94%, #0000);
          --_g3: no-repeat radial-gradient(farthest-side, #f09c4e 94%, #0000);
          background:    var(--_g) 0 0,    var(--_g1) 100% 0,    var(--_g2) 100% 100%,    var(--_g3) 0 100%;
          background-size: 30% 30%;
          animation: l38 .9s infinite ease-in-out;
          -webkit-animation: l38 .9s infinite ease-in-out;
        }

        @keyframes l38 {
          100% {
            background-position: 100% 0, 100% 100%, 0 100%, 0 0
          }
        }

        div.empty {
          width: 100%;
          padding: 15px 0;
          margin: 0;
          display: flex;
          flex-flow: column;
          gap: 8px;
        }

        div.empty > p {
          width: 100%;
          padding: 15px 0;
          margin: 0;
          color: var(--text-color);
          font-family: var(--font-text), sans-serif;
          font-size: 1rem;
          font-weight: 400;
        }

        div.stories {
          padding: 0;
          width: 100%;
          display: flex;
          flex-flow: column;
          gap: 0;
        }

        div.finish {
          padding: 10px 0 40px;
          width: 100%;
          min-width: 100%;
          height: auto;
          display: flex;
          flex-flow: column;
          justify-content: center;
          align-items: center;
          gap: 5px;
        }

        div.finish > h2.title {
          margin: 10px 0 0 0;
          font-size: 1.15rem;
          font-weight: 500;
          font-family: var(--font-read), sans-serif;
          color: var(--text-color);
        }

        div.finish > p.desc {
          margin: 0;
          font-size: 0.85rem;
          font-family: var(--font-read), sans-serif;
          color: var(--gray-color);
          line-height: 1.4;
          text-align: center;
        }

        div.finish > button.finish {
          border: none;
          background: var(--accent-linear);
          font-family: var(--font-main), sans-serif;
          text-decoration: none;
          color: var(--white-color);
          margin: 10px 0 0;
          font-size: 1rem;
          font-weight: 500;
          cursor: pointer;
          display: flex;
          width: max-content;
          flex-flow: row;
          align-items: center;
          text-transform: capitalize;
          justify-content: center;
          padding: 7px 18px 8px;
          border-radius: 50px;
          -webkit-border-radius: 50px;
          -moz-border-radius: 50px;
        }

        @media screen and (max-width:660px) {
          .last {
            width: 100%;
            padding: 15px 0;
            border-bottom: var(--border);
            display: flex;
            flex-flow: column;
            align-items: center;
            justify-content: center;
          }

          .empty {
            width: 100%;
            padding: 20px 0;
            display: flex;
            flex-flow: column;
            align-items: center;
            justify-content: center;
          }

          div.finish > button.finish {
            cursor: default !important;
          }
        }
      </style>
    `;
    }
  }

  class TopicsContainer extends HTMLElement {
  	constructor() {
  		// We are not even going to touch this.
  		super();

  		this._url = this.getAttribute('url');

  		// let's create our shadow root
  		this.shadowObj = this.attachShadow({ mode: "open" });

  		this.render();
  	}

  	render() {
  		this.shadowObj.innerHTML = this.getTemplate();
  	}

    convertToBoolean = value => {
      return value === 'true';
    }

  	connectedCallback() {
  		const contentContainer = this.shadowObj.querySelector('div.content');

      // get offline attribute
      const offline = this.convertToBoolean(this.getAttribute('offline'));

      // if offline is true
      if (offline) {
        this.fetchOfflineFeeds(contentContainer);
      } else {
  			this.fetchTopics(contentContainer);
  		}
  	}

    activateRefresh = () => {
      const finish = this.shadowObj.querySelector('.finish');
      if (finish) {
        const btn = finish.querySelector('button.finish');
        btn.addEventListener('click', () => {
          // unblock the fetching
          this._block = false;
          this._empty = false;
          
          // re fetch the content
          const feedContainer = this.shadowObj.querySelector('div.content');

          // set the loader
          feedContainer.innerHTML = this.getLoader();

          setTimeout(() => {
            this.fetchTopics(feedContainer);
          }, 1000);
        });
      }
    }

    activateOfflineRefresh = () => {
      const finish = this.shadowObj.querySelector('.finish');
      if (finish) {
        const btn = finish.querySelector('button.finish');
        btn.addEventListener('click', () => {
          // unblock the fetching
          this._block = false;
          this._empty = false;
          
          // re fetch the content
          const feedContainer = this.shadowObj.querySelector('.stories');

          // set the loader
          feedContainer.innerHTML = this.getLoader();

          setTimeout(() => {
            this.fetchOfflineFeeds(feedContainer);
          }, 1000);
        });
      }
    }

  	fetching = async (url, topicsContainer) => {
      const mql = window.matchMedia('(max-width: 660px)');
      const outerThis = this;
      const options = { 
        method: 'GET',
        // set the cache control to max-age to 2 hours
        "Cache-Control": "max-age=7200",
        "Accept": "application/json"
      };


      try {
        // fetch 
        const result = await outerThis.getCacheData(url, 7200, options);

        // if result is not successful
        if (!result.success) {
          topicsContainer.innerHTML = outerThis.getWrongMessage();
          this.activateRefresh();
          return;
        }
        
        const data = result.data;
    
        if(data.topics.length === 0) {
          topicsContainer.innerHTML = outerThis.getEmptyMsg();
          return;
        }
        
        const content = outerThis.mapFields(data.topics);
        topicsContainer.insertAdjacentHTML('beforebegin', outerThis.getTitle());
        topicsContainer.innerHTML =  content;
        outerThis.setLastItem(topicsContainer);

        if (mql.matches) {
          // set next
          window.home = {
            last: false,
            next: 3,
            loaded: true
          };
        }
      } catch (error) {
        // console.log(error)
        topicsContainer.innerHTML = outerThis.getWrongMessage();
        // activate the refresh button
        outerThis.activateRefresh();
      }
    }

    fetchOfflineFeeds = async topicsContainer => {
      const mql = window.matchMedia('(max-width: 660px)');
      const outerThis = this;
      const url = this._url;
      try {
        // fetch from cache
        const result = await outerThis.getOfflineData(url);

        // if result is not successful
        if (!result.success) {
          topicsContainer.innerHTML = outerThis.getWrongMessage();
          this.activateOfflineRefresh();
          return;
        }

        // get the data
        const data = result.data;

        // if topics is empty
        if (data.topics.length === 0) {
          topicsContainer.innerHTML = outerThis.getEmptyMsg();
          this.activateOfflineRefresh();
          return;
        }

        // map the fields
        const content = outerThis.mapFields(data.topics);
        topicsContainer.innerHTML = content;
        outerThis.setLastItem(topicsContainer);
        if(mql.matches) {
          // set next
          window.home = {
            last: false,
            next: 3,
            loaded: true
          };
        }
      } catch (error) {
        // display error message
        topicsContainer.innerHTML = outerThis.getOfflineWrong();

        // activate the refresh button
        outerThis.activateOfflineRefresh();
      }
    }

    getOfflineData = async url => {
      const cacheName = "user-cache";

      try {
        const cache = await caches.open(cacheName);
        const cachedResponse = await cache.match(url);

        if (cachedResponse) {
          const cachedData = await cachedResponse.json();
    
          // return the data
          return cachedData.data;
        } else {
          // throw an error
          throw new Error('No data available');
        }

      } catch (error) {
        // console.error('Error fetching data:', error);
        throw error;
      }
    }

    getCacheData = async (url, maxAge, options = {}) => {
      const cacheName = "user-cache";
    
      try {
        const cache = await caches.open(cacheName);
        const cachedResponse = await cache.match(url);
    
        if (cachedResponse) {
          const cachedData = await cachedResponse.json();
          const cacheTime = cachedData.timestamp;
    
          // Check if cache is still valid
          if (Date.now() - cacheTime < maxAge) {
            return cachedData.data;
          }
        }
    
        // If cache doesn't exist or is expired, fetch new data
        const networkResponse = await this.fetchWithTimeout(url, options);
        const data = await networkResponse.clone().json();
    
        // Store the new data in cache with a timestamp
        const cacheData = {
          data: data,
          timestamp: Date.now()
        };
        
        const cacheResponse = new Response(JSON.stringify(cacheData));
        await cache.put(url, cacheResponse);
    
        return data;
      } catch (error) {
        console.error('Error fetching data:', error);
        throw error;
      }
    };

    fetchTopics = topicsContainer => {
      const outerThis = this;
      const url = `${this._url}?limit=10`;

      if(!this._block && !this._empty) {
        outerThis.fetching(url, topicsContainer);
      }
    }

    populateTopics = (content, topicsContainer) => {
      // get the loader and remove it
      const loader = topicsContainer.querySelector('topic-loader');
      if (loader){
        loader.remove();
      }

      // insert the content
      topicsContainer.insertAdjacentHTML('beforeend', content);
    }
    
    mapFields = data => {
      return data.map(topic => {
        const author = topic.topic_author;
        let bio = author.bio === null ? 'This user has not added a bio yet.' : author.bio;
        // replace all " and ' with &quot; and &apos; to avoid breaking the html
        bio = bio.replace(/"/g, '&quot;').replace(/'/g, '&apos;');
        const url = `/t/${topic.hash.toLowerCase()}`;
        return /*html*/`
        <topic-wrapper hash="${topic.hash}" name="${topic.name}" slug="${topic.slug}"
          topic-follow="${topic.is_following}" subscribed="${topic.is_subscribed}" url="${url}" views="${topic.views}"
          subscribers="${topic.subscribers}" followers="${topic.followers}" stories="${topic.stories}"
          author-hash="${author.hash}" author-you="${topic.you}" author-url="/u/${author.hash}"
          author-img="${author.picture}" author-verified="${author.verified}" author-name="${author.name}" author-followers="${author.followers}"
          author-following="${author.following}" author-follow="${author.is_following}" author-contact='${author.contact ? JSON.stringify(author.contact) : null}'
          author-bio="${bio}">
          ${this.topicContent(topic.summary)}
        </topic-wrapper>
      `
      }).join('');
    }

    topicContent = data => {
      if (data.length <= 0 || !data) {
        return /*html*/`
        <div class="empty">
          <p>The topic has no information yet.
            More information will be available once the author(s) adds more content.
          </p>
        </div>
      `;
      }
      else {
        return data
      }
    }

    fetchWithTimeout = async (url, options = {}, timeout = 9500) => {
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), timeout);
    
      try {
        const response = await fetch(url, {
          ...options,
          signal: controller.signal
        });

        return response;
      } catch (error) {
        if (error.name === 'AbortError') {
          throw new Error('Request timed out');
        }
        throw new Error(`Network error: ${error.message}`);
      } finally {
        clearTimeout(timeoutId);
      }
    };

    setLastItem = contentContainer => {
      // get last element child (topic)
      const lastItem = contentContainer.lastElementChild;

      // set border-bottom to none
      if (lastItem) {
        lastItem.style.setProperty('border-bottom', 'none');
        lastItem.style.setProperty('padding-bottom', '0');
      }
    }

  	getTemplate = () => {
  		// Show HTML Here
  		return `
      ${this.getBody()}
      ${this.getStyles()}
    `;
  	}

  	getLoader = () => {
  		return `
			<topic-loader speed="300"></topic-loader>
		`
  	}

  	getBody = () => {
  		// get mql for media query: desktop
  		return /* html */`
		  <div class="content">
				${this.getLoader()}
			</div>
		`;
  	}

  	getTitle = () => {
  		return /*html*/`
			<div class="title">
				<h2>Most read topics</h2>
			</div>
		`
  	}

  	getEmptyMsg = () => {
      // get the next attribute
      return /*html*/`
    <div class="empty">
      <div class="title">
        <h2>Most read topics</h2>
      </div>
      <p class="desc">
        No topics was found, you can retry or come back later. Optionally you check your connection.
      </p>
    </div>
    `
    }

    getWrongMessage = () => {
      return /* html */`
      <div class="finish">
        <h2 class="finish__title">Oops!</h2>
        <p class="desc">
          An error occurred while fetching trending topics. Please check your connection and try again.
        </p>
        <button class="finish">Retry</button>
      </div>
    `;
    }

    getOfflineWrong = () => {
      return /* html */`
      <div class="finish">
        <h2 class="title">Something went wrong!</h2>
        <p class="desc">
          There was an error getting offline feeds. Please you need to be online to fetch the feeds.
        </p>
        <button class="finish">Retry</button>
      </div>
    `;
    }

  	getStyles() {
  		return /* css */`
	    <style>
	      *,
	      *:after,
	      *:before {
	        box-sizing: border-box !important;
	        font-family: inherit;
	        -webkit-box-sizing: border-box !important;
	      }

	      *:focus {
	        outline: inherit !important;
	      }

	      *::-webkit-scrollbar {
	        width: 3px;
	      }

	      *::-webkit-scrollbar-track {
	        background: var(--scroll-bar-background);
	      }

	      *::-webkit-scrollbar-thumb {
	        width: 3px;
	        background: var(--scroll-bar-linear);
	        border-radius: 50px;
	      }

	      h1,
	      h2,
	      h3,
	      h4,
	      h5,
	      h6 {
	        padding: 0;
	        margin: 0;
	        font-family: inherit;
	      }

	      p,
	      ul,
	      ol {
	        padding: 0;
	        margin: 0;
	      }

	      a {
	        text-decoration: none;
	      }

	      :host {
        	font-size: 16px;
					margin: 0;
				  padding: 0;
				  display: flex;
				  flex-flow: column;
				  gap: 0;
        }

				div.content {
				  margin: 0;
				  padding: 0;
				  display: flex;
				  flex-flow: row;
				  flex-wrap: wrap;
				  align-items: center;
				  justify-content: start;
				  gap: 0;
				  width: 100%;
				}

				.title {
          display: flex;
					width: 100%;
          flex-flow: column;
					padding: 5px 10px 6px;
          margin: 0 0 0 -2px;
          gap: 0;
					background: var(--light-linear);
					border-radius: 7px;
        }

        .title > h2 {
          font-size: 1.5rem;
          font-weight: 500;
          font-family: var(--font-text), sans-serif;
          margin: 0;
          color: var(--text-color);
        }

        .title > p.info {
          margin: 0;
          font-size: 0.9rem;
          font-style: italic;
          font-weight: 400;
          font-family: var(--font-text), sans-serif;
          margin: 0;
          color: var(--text-color);
        }

        div.finish {
          padding: 10px 0 40px;
          width: 100%;
          min-width: 100%;
          height: auto;
          display: flex;
          flex-flow: column;
          justify-content: center;
          align-items: center;
          gap: 5px;
        }

        div.empty {
          padding: 10px 0;
          width: 100%;
          min-width: 100%;
          height: auto;
          display: flex;
          flex-flow: column;
          justify-content: center;
          align-items: center;
          gap: 5px;
        }

        div.finish > h2.finish__title {
          margin: 10px 0 0 0;
          font-size: 1.15rem;
          font-weight: 500;
          font-family: var(--font-read), sans-serif;
          color: var(--text-color);
        }

        div.empty p.desc,
        div.finish > p.desc {
          margin: 0;
          font-size: 0.85rem;
          font-family: var(--font-read), sans-serif;
          color: var(--gray-color);
          line-height: 1.4;
          text-align: center;
        }

        div.finish > button.finish {
          border: none;
          background: var(--accent-linear);
          font-family: var(--font-main), sans-serif;
          text-decoration: none;
          color: var(--white-color);
          margin: 10px 0 0;
          font-size: 1rem;
          font-weight: 500;
          cursor: pointer;
          display: flex;
          width: max-content;
          flex-flow: row;
          align-items: center;
          text-transform: capitalize;
          justify-content: center;
          padding: 7px 18px 8px;
          border-radius: 50px;
          -webkit-border-radius: 50px;
          -moz-border-radius: 50px;
        }

				@media screen and (max-width:660px) {
					:host {
        		font-size: 16px;
						padding: 5px 0 10px;
					}

					::-webkit-scrollbar {
						-webkit-appearance: none;
					}

					a,
          div.finish > button.finish {
            cursor: default !important;
          }
				}
	    </style>
    `;
  	}
  }

  class FeedContainer extends HTMLElement {
    constructor() {
      // We are not even going to touch this.
      super();

      this._url = this.getAttribute('url');

      // let's create our shadow root
      this.shadowObj = this.attachShadow({ mode: "open" });

      this.render();
    }

    render() {
      this.shadowObj.innerHTML = this.getTemplate();
    }

    convertToBoolean = value => {
      return value === 'true' ? true : false;
    }

    connectedCallback() {
      const feedContainer = this.shadowObj.querySelector('.stories');

      const offline = this.convertToBoolean(this.getAttribute('offline'));
      if (offline) {
        this.fetchOfflineFeeds(feedContainer);
      } else {
        this.fetchFeeds(feedContainer);
      }
    }

    activateRefresh = () => {
      const finish = this.shadowObj.querySelector('.finish');
      if (finish) {
        const btn = finish.querySelector('button.finish');
        btn.addEventListener('click', () => {
          // unblock the fetching
          this._block = false;
          this._empty = false;
          
          // re fetch the content
          const feedContainer = this.shadowObj.querySelector('.stories');

          // set the loader
          feedContainer.innerHTML = this.getLoader();

          setTimeout(() => {
            this.fetchFeeds(feedContainer);
          }, 1000);
        });
      }
    }

    activateOfflineRefresh = () => {
      const finish = this.shadowObj.querySelector('.finish');
      if (finish) {
        const btn = finish.querySelector('button.finish');
        btn.addEventListener('click', () => {
          // unblock the fetching
          this._block = false;
          this._empty = false;
          
          // re fetch the content
          const feedContainer = this.shadowObj.querySelector('.stories');

          // set the loader
          feedContainer.innerHTML = this.getLoader();

          setTimeout(() => {
            this.fetchOfflineFeeds(feedContainer);
          }, 1000);
        });
      }
    }

    disableScroll() {
      // Get the current page scroll position
      let scrollTop = window.scrollY || document.documentElement.scrollTop;
      let scrollLeft = window.scrollX || document.documentElement.scrollLeft;
      document.body.classList.add("stop-scrolling");

      // if any scroll is attempted, set this to the previous value
      window.onscroll = function () {
        window.scrollTo(scrollLeft, scrollTop);
      };
    }

    enableScroll() {
      document.body.classList.remove("stop-scrolling");
      window.onscroll = function () { };
    }

    fetching = async (url, feedContainer) => {
      const outerThis = this;
      const options = { 
        method: 'GET',
        // set the cache control to max-age to 30 minutes
        "Cache-Control": "max-age=1800",
        "Accept": "application/json"
      };

      try {
        const response = await outerThis.fetchWithTimeout(url, options);
        const result = await response.json();

        if (result.success) {
          const data = result.data;
          if (data.last && outerThis._page === 1 && data.stories.length === 0 && data.replies.length === 0) {
            outerThis.populateFeeds(outerThis.getEmptyMsg(), feedContainer);
          }
          else {
            const content = outerThis.mapFeeds(data.stories, data.replies);
            outerThis.populateFeeds(content, feedContainer);
            outerThis.setLastItem(feedContainer);
          }

          // set next
          window.home = {
            last: false,
            next: 1,
            loaded: true
          };
        } else {
          outerThis.populateFeeds(outerThis.getWrongMessage(), feedContainer);
          // activate the refresh button
          outerThis.activateRefresh();
        }
      } 
      catch (error) {
        outerThis.populateFeeds(outerThis.getWrongMessage(), feedContainer);
        // activate the refresh button
        outerThis.activateRefresh();
      }
    }

    fetchFeeds = feedContainer => {
      const outerThis = this;
      const url = this._url;

      if (!this._block && !this._empty) {
        outerThis._empty = true;
        outerThis._block = true;
        // fetch the stories
        outerThis.fetching(url, feedContainer);
      }
    }

    fetchOfflineFeeds = async feedContainer => {
      const outerThis = this;
      const url = this._url;
      try {
        // fetch from cache
        const result = await outerThis.getOfflineData(url);

        // check if it was not success:
        if (!result.success) {
          outerThis.populateFeeds(outerThis.getWrongMessage(), feedContainer);
          // activate the refresh button
          outerThis.activateOfflineRefresh();
          return;
        }

        // get the data
        const data = result.data;

        if (data.last && data.stories.length === 0 && data.replies.length === 0) {
          outerThis.populateFeeds(outerThis.getEmptyMsg(), feedContainer);
          return;
        }

        const content = outerThis.mapFeeds(data.stories, data.replies);

        outerThis.populateFeeds(content, feedContainer);
        outerThis.setLastItem(feedContainer);

        // set next
        window.home = {
          last: false,
          next: 1,
          loaded: true
        };
      } catch (error) {
        outerThis.populateFeeds(outerThis.getOfflineWrong(), feedContainer);
        // activate the refresh button
        outerThis.activateOfflineRefresh();
      }
    }

    populateFeeds = (content, feedContainer) => {
      // get the loader and remove it
      const loader = feedContainer.querySelector('.loader-container');
      if (loader) {
        loader.remove();
      }

      // insert the content
      feedContainer.insertAdjacentHTML('beforeend', content);
    }

    mapFeeds = (stories, replies) => {
      const outerThis = this;
      let content = '';
      
      // Check if the stories is empty and replies is not empty
      if (stories.length === 0 && replies.length > 0) {
        content = replies.map(reply => outerThis.mapReply(reply)).join('');
      }
      else if (stories.length > 0 && replies.length === 0) {
        content = stories.map(story => outerThis.mapStory(story)).join('');
      }
      else {
        // for each story follow by a reply, if there is any(i.e): append ine story and one reply if either is available else append the other
        // check the longest array
        if (stories.length >= replies.length) {
          for (let i = 0; i < stories.length; i++) {
            content += outerThis.mapStory(stories[i]);
            if (replies[i]) {
              content += outerThis.mapReply(replies[i]);
            }
          }
        }
        else {
          for (let i = 0; i < replies.length; i++) {
            if (stories[i]) {
              content += outerThis.mapStory(stories[i]);
            }
            content += outerThis.mapReply(replies[i]);
          }
        }
      }

      return content;
    }

    mapStory = story => {
      const author = story.story_author;
      let bio = author.bio === null ? 'This user has not added a bio yet.' : author.bio;
      // replace all " and ' with &quot; and &apos; to avoid breaking the html
      bio = bio.replace(/"/g, '&quot;').replace(/'/g, '&apos;');
      const url = `/p/${story.hash.toLowerCase()}`;
      const images = story.images ? story.images.join(',') : '';
      if (story.kind === "post") {
        return /*html*/`
        <quick-post story="quick" url="${url}" hash="${story.hash}" likes="${story.likes}" 
          replies="${story.replies}" liked="${story.liked ? 'true' : 'false'}" views="${story.views}" time="${story.createdAt}" 
          replies-url="/api/v1${url}/replies" likes-url="/api/v1${url}/likes" images="${images}"
          author-url="/u/${author.hash}" author-stories="${author.stories}" author-replies="${author.replies}"
          author-hash="${author.hash}" author-you="${story.you ? 'true' : 'false'}" author-img="${author.picture}" 
          author-verified="${author.verified ? 'true' : 'false'}" author-name="${author.name}" author-followers="${author.followers}" 
          author-following="${author.following}" author-follow="${author.is_following ? 'true' : 'false'}" author-contact='${author.contact ? JSON.stringify(author.contact) : null}'
          author-bio="${bio}">
          ${story.content}
        </quick-post>
      `
      }
      else if (story.kind === "poll") {
        return /*html*/`
        <poll-post story="poll" url="${url}" hash="${story.hash}" likes="${story.likes}" 
          replies="${story.replies}" liked="${story.liked ? 'true' : 'false'}" views="${story.views}" time="${story.createdAt}" 
          voted="${story.option ? 'true' : 'false'}" selected="${story.option}" end-time="${story.end}" replies-url="/api/v1${url}/replies" 
          likes-url="/api/v1${url}/likes" options='${story.poll}' votes="${story.votes}" 
          author-url="/u/${author.hash}" author-stories="${author.stories}" author-replies="${author.replies}"
          author-hash="${author.hash}" author-you="${story.you ? 'true' : 'false'}" author-img="${author.picture}" 
          author-verified="${author.verified ? 'true' : 'false'}" author-name="${author.name}" author-followers="${author.followers}" 
          author-following="${author.following}" author-follow="${author.is_following ? 'true' : 'false'}" author-contact='${author.contact ? JSON.stringify(author.contact) : null}'
          author-bio="${bio}">
          ${story.content}
        </poll-post>
      `
      }
      else if (story.kind === "story") {
        return /*html*/`
        <story-post story="story" hash="${story.hash}" url="${url}" 
          topics="${story.topics.length === 0 ? 'story' : story.topics}" story-title="${story.title}" time="${story.createdAt}" replies-url="/api/v1${url}/replies" 
          likes-url="/api/v1${url}/likes" replies="${story.replies}" liked="${story.liked ? 'true' : 'false'}" likes="${story.likes}" 
          views="${story.views}" images="${images}"
          author-url="/u/${author.hash}" author-stories="${author.stories}" author-replies="${author.replies}"
          author-hash="${author.hash}" author-you="${story.you ? 'true' : 'false'}" author-contact='${author.contact ? JSON.stringify(author.contact) : null}'
          author-img="${author.picture}" author-verified="${author.verified ? 'true' : 'false'}" author-name="${author.name}" 
          author-followers="${author.followers}" author-following="${author.following}" author-follow="${author.is_following ? 'true' : 'false'}" 
          author-bio="${bio}">
          ${story.content}
        </story-post>
      `
      }
    }

    mapReply = reply => {
      const author = reply.reply_author;
      let bio = author.bio === null ? 'This user has not added a bio yet.' : author.bio;
      // replace all " and ' with &quot; and &apos; to avoid breaking the html
      bio = bio.replace(/"/g, '&quot;').replace(/'/g, '&apos;');
      const images = reply.images ? reply.images.join(',') : '';
      return /*html*/`
      <quick-post story="reply" hash="${reply.hash}" url="/r/${reply.hash.toLowerCase()}" likes="${reply.likes}" replies="${reply.replies}" liked="${reply.liked}"
        views="${reply.views}" time="${reply.createdAt}" replies-url="/api/v1/r/${reply.hash}/replies" likes-url="/api/v1/r/${reply.hash}/likes" images="${images}"
        author-hash="${author.hash}" author-you="${reply.you}" author-url="/u/${author.hash}" author-contact='${author.contact ? JSON.stringify(author.contact) : null}'
        author-stories="${author.stories}" author-replies="${author.replies}" parent="${reply.story ? reply.story : reply.reply}"
        author-img="${author.picture}" author-verified="${author.verified}" author-name="${author.name}" author-followers="${author.followers}"
        author-following="${author.following}" author-follow="${author.is_following}" author-bio="${bio}">
        ${reply.content}
      </quick-post>
    `
    }

    getOfflineData = async url => {
      const cacheName = "user-cache";

      const cache = await caches.open(cacheName);
      const cachedResponse = await cache.match(url);

      if (cachedResponse) {
        const cachedData = await cachedResponse.json();
        // return the data
        return cachedData.data;
      } else {
        // throw an error
        throw new Error('No data available');
      }
    }

    getCacheData = async (url, maxAge, options = {}) => {
      const cacheName = "user-cache";
    
      try {
        const cache = await caches.open(cacheName);
        const cachedResponse = await cache.match(url);
    
        if (cachedResponse) {
          const cachedData = await cachedResponse.json();
          const cacheTime = cachedData.timestamp;
    
          // Check if cache is still valid
          if (Date.now() - cacheTime < maxAge) {
            return cachedData.data;
          }
        }
    
        // If cache doesn't exist or is expired, fetch new data
        const networkResponse = await this.fetchWithTimeout(url, options);
        const data = await networkResponse.clone().json();
    
        // Store the new data in cache with a timestamp
        const cacheData = {
          data: data,
          timestamp: Date.now()
        };
        
        const cacheResponse = new Response(JSON.stringify(cacheData));
        await cache.put(url, cacheResponse);
    
        return data;
      } catch (error) {
        console.error('Error fetching data:', error);
        throw error;
      }
    };

    fetchWithTimeout = async (url, options = {}, timeout = 9500) => {
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), timeout);
    
      try {
        const response = await fetch(url, {
          ...options,
          signal: controller.signal
        });

        return response;
      } catch (error) {
        if (error.name === 'AbortError') {
          throw new Error('Request timed out');
        }
        throw new Error(`Network error: ${error.message}`);
      } finally {
        clearTimeout(timeoutId);
      }
    };

    parseToNumber = num_str => {
      // Try parsing the string to an integer
      const num = parseInt(num_str);

      // Check if parsing was successful
      if (!isNaN(num)) {
        return num;
      } else {
        return 0;
      }
    }

    setLastItem = contentContainer => {
      // get last element child (can be a story or a reply)
      const lastItem = contentContainer.lastElementChild;

      // set border-bottom to none
      if (lastItem) {
        lastItem.style.setProperty('border-bottom', 'none');
      }
    }

    getTemplate = () => {
      // Show HTML Here
      return `
      ${this.getBody()}
      ${this.getStyles()}
    `;
    }

    getLoader() {
      return /* html */`
      <div class="loader-container">
        <span id="btn-loader">
          <span class="loader-alt"></span>
        </span>
      </div>
    `
    }

    getBody = () => {
      // language=HTML
      return `
			<div class="stories">
				${this.getLoader()}
      </div>
    `;
    }

    getEmptyMsg = () => {
      // get the next attribute
      return /*html*/`
      <div class="finish">
        <h2 class="title">No feeds!</h2>
        <p class="desc">
          There are no feeds available for this feed. You can always come back later or refresh the page to check for new feeds.
        </p>
      </div>
    `
    }

    getWrongMessage = () => {
      return /* html */`
      <div class="finish">
        <h2 class="title">Something went wrong!</h2>
        <p class="desc">
          There was an error fetching the feeds. Please retry using the button below, or check your internet connection.
        </p>
        <button class="finish">Retry</button>
      </div>
    `;
    }

    getOfflineWrong = () => {
      return /* html */`
      <div class="finish">
        <h2 class="title">Something went wrong!</h2>
        <p class="desc">
          There was an error getting offline feeds. Please you need to be online to fetch the feeds.
        </p>
        <button class="finish">Retry</button>
      </div>
    `;
    }

    getStyles() {
      return /* css */`
      <style>
        *,
        *:after,
        *:before {
          box-sizing: border-box !important;
          font-family: inherit;
          -webkit-box-sizing: border-box !important;
        }

        *:focus {
          outline: inherit !important;
        }

        *::-webkit-scrollbar {
          width: 3px;
        }

        *::-webkit-scrollbar-track {
          background: var(--scroll-bar-background);
        }

        *::-webkit-scrollbar-thumb {
          width: 3px;
          background: var(--scroll-bar-linear);
          border-radius: 50px;
        }

        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
          padding: 0;
          margin: 0;
          font-family: inherit;
        }

        p,
        ul,
        ol {
          padding: 0;
          margin: 0;
        }

        a {
          text-decoration: none;
        }

        :host {
          font-size: 16px;
          width: 100%;
          padding: 0;
        }

        div.loader-container {
          position: relative;
          width: 100%;
          height: 150px;
          padding: 20px 0 0 0;
        }

        #btn-loader {
          position: absolute;
          top: 0;
          left: 0;
          bottom: 0;
          right: 0;
          z-index: 5;
          display: flex;
          align-items: center;
          justify-content: center;
          border-radius: inherit;
        }

        #btn-loader > .loader-alt {
          width: 35px;
          aspect-ratio: 1;
          --_g: no-repeat radial-gradient(farthest-side, #18A565 94%, #0000);
          --_g1: no-repeat radial-gradient(farthest-side, #21D029 94%, #0000);
          --_g2: no-repeat radial-gradient(farthest-side, #df791a 94%, #0000);
          --_g3: no-repeat radial-gradient(farthest-side, #f09c4e 94%, #0000);
          background:    var(--_g) 0 0,    var(--_g1) 100% 0,    var(--_g2) 100% 100%,    var(--_g3) 0 100%;
          background-size: 30% 30%;
          animation: l38 .9s infinite ease-in-out;
          -webkit-animation: l38 .9s infinite ease-in-out;
        }

        #btn-loader > .loader {
          width: 20px;
          aspect-ratio: 1;
          --_g: no-repeat radial-gradient(farthest-side, #ffffff 94%, #0000);
          --_g1: no-repeat radial-gradient(farthest-side, #ffffff 94%, #0000);
          --_g2: no-repeat radial-gradient(farthest-side, #df791a 94%, #0000);
          --_g3: no-repeat radial-gradient(farthest-side, #f09c4e 94%, #0000);
          background:    var(--_g) 0 0,    var(--_g1) 100% 0,    var(--_g2) 100% 100%,    var(--_g3) 0 100%;
          background-size: 30% 30%;
          animation: l38 .9s infinite ease-in-out;
          -webkit-animation: l38 .9s infinite ease-in-out;
        }

        @keyframes l38 {
          100% {
            background-position: 100% 0, 100% 100%, 0 100%, 0 0
          }
        }

        .empty {
          width: 100%;
          padding: 10px 0 30px;
          display: flex;
          flex-flow: column;
          align-items: center;
          justify-content: center;
        }

        .last {
          width: 100%;
          padding: 10px 0 30px;
          display: flex;
          flex-flow: column;
          align-items: center;
          justify-content: center;
        }

        .last > h2,
        .empty > h2 {
          width: 100%;
          margin: 5px 0;
          text-align: start;
          font-family: var(--font-text), sans-serif;
          color: var(--text-color);
          line-height: 1.4;
          font-size: 1.2rem;
        }

        .last p,
        .empty p {
          width: 100%;
          margin: 0;
          text-align: start;
          font-family: var(--font-read), sans-serif;
          color: var(--gray-color);
          line-height: 1.4;
          font-size: 0.95rem;
        }

        .last p.next > .url,
        .empty  p.next > .url {
          background: var(--gray-background);
          color: var(--gray-color);
          padding: 2px 5px;
          font-size: 0.95rem;
          font-weight: 400;
          border-radius: 5px;
        }

        .last p.next > .warn,
        .empty  p.next .warn {
          color: var(--error-color);
          font-weight: 500;
          font-size: 0.9rem;
          background: var(--gray-background);
          padding: 2px 5px;
          border-radius: 5px;
        }

        div.stories {
          padding: 0;
          width: 100%;
          display: flex;
          flex-flow: column;
          gap: 0;
        }

        div.finish {
          padding: 50px 0 20px;
          width: 100%;
          min-width: 100%;
          height: auto;
          display: flex;
          flex-flow: column;
          justify-content: center;
          align-items: center;
          gap: 12px;
        }

        div.finish > h2.title {
          margin: 10px 0 0 0;
          font-size: 1.15rem;
          font-weight: 500;
          font-family: var(--font-read), sans-serif;
          color: var(--text-color);
        }

        div.finish > p.desc {
          margin: 0;
          font-size: 0.85rem;
          font-family: var(--font-read), sans-serif;
          color: var(--text-color);
          line-height: 1.4;
          text-align: center;
        }

        div.finish > button.finish {
          border: none;
          background: var(--accent-linear);
          font-family: var(--font-main), sans-serif;
          text-decoration: none;
          color: var(--white-color);
          margin: 3px 0 0;
          font-size: 1rem;
          font-weight: 500;
          cursor: pointer;
          display: flex;
          width: max-content;
          flex-flow: row;
          align-items: center;
          text-transform: capitalize;
          justify-content: center;
          padding: 5px 15px 6px;
          border-radius: 12px;
          -webkit-border-radius: 12px;
          -moz-border-radius: 12px;
        }

        @media screen and (max-width:660px) {
          .last {
            width: 100%;
            padding: 15px 0;
            border-bottom: var(--border);
            display: flex;
            flex-flow: column;
            align-items: center;
            justify-content: center;
          }

          .empty {
            width: 100%;
            padding: 20px 0;
            display: flex;
            flex-flow: column;
            align-items: center;
            justify-content: center;
          }

          div.finish > button.finish {
            cursor: default !important;
          }
        }
      </style>
    `;
    }
  }

  class UpdateContainer extends HTMLElement {
    constructor() {
      // We are not even going to touch this.
      super();

      // let's create our shadow root
      this.shadowObj = this.attachShadow({ mode: "open" });

      this.render();
    }

    render() {
      this.shadowObj.innerHTML = this.getTemplate();
    }

    connectedCallback() {
      this.activateTab();
    }

    activateTab = () => {
      const outerThis = this;
      const tab = this.shadowObj.querySelector('ul#tab');
      const contentContainer = this.shadowObj.querySelector('.content');

      if (tab && contentContainer) {
        const line = tab.querySelector('span.line');
        const tabItems = tab.querySelectorAll('li.tab-item');
        let activeTab = tab.querySelector('li.tab-item.active');

        tabItems.forEach((tab, index) => {
          tab.addEventListener('click', e => {
            e.preventDefault();
            e.stopPropagation();

            // Calculate half tab width - 10px
            const tabWidth = (tab.offsetWidth / 2) - 20;

            if (index === 0) {
              line.style.left = '0';
            }
            else {
              line.style.left = `${tab.offsetLeft + tabWidth}px`;
            }

            if (tab.dataset.element === activeTab.dataset.element) {
              return;
            }
            else {
              activeTab.classList.remove('active');
              tab.classList.add('active');
              activeTab = tab;
              const url = tab.getAttribute('url');
              contentContainer.innerHTML = outerThis.getAll(url);
            }
          });
        });
      }
    }

    getTemplate = () => {
      // Show HTML Here
      return `
      ${this.getBody()}
      ${this.getStyles()}
    `;
    }

    getBody = () => {
      // language=HTML
      return `
      ${this.getHeader()}
      ${this.getTab()}
			<div class="content">
				${this.getAll(this.getAttribute('api-all'))}
      </div>
    `;
    }

    getAll = url => {
      return /* html */`
			<update-feed url="${url}" page="1" limit="10"></update-feed>
		`
    }

    getHeader = () => {
      return /* html */`
      <div class="top">
        <p class="desc">
          Your updates contains summary of all actions performed by other users on your content or profile.
          You can filter by stories, replies, people, and topics.<br>
          <span>Note that a button label <b>user</b> will preview the user who has perform the action/update.
        </p>
      </div>
    `;
    }

    getTab = () => {
      return /* html */`
      <div class="actions">
        <ul id="tab" class="tab">
          <li data-element="all" class="tab-item all active" url="${this.getAttribute('api-all')}">
            <span class="text">All</span>
          </li>
          <li data-element="stories" class="tab-item stories" url="${this.getAttribute('api-stories')}">
            <span class="text">Stories</span>
          </li>
          <li data-element="replies" class="tab-item replies" url="${this.getAttribute('api-replies')}">
            <span class="text">Replies</span>
          </li>
          <li data-element="people" class="tab-item people" url="${this.getAttribute('api-users')}">
            <span class="text">People</span>
          </li>
          <li data-element="topics" class="tab-item topics" url="${this.getAttribute('api-topics')}">
            <span class="text">Topics</span>
          </li>
          <span class="line"></span>
        </ul>
      </div>
    `;
    }

    getStyles() {
      return /* css */`
      <style>
        *,
        *:after,
        *:before {
          box-sizing: border-box !important;
          font-family: inherit;
          -webkit-box-sizing: border-box !important;
        }

        *:focus {
          outline: inherit !important;
        }

        *::-webkit-scrollbar {
          width: 3px;
        }

        *::-webkit-scrollbar-track {
          background: var(--scroll-bar-background);
        }

        *::-webkit-scrollbar-thumb {
          width: 3px;
          background: var(--scroll-bar-linear);
          border-radius: 50px;
        }

        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
          padding: 0;
          margin: 0;
          font-family: inherit;
        }

        p,
        ul,
        ol {
          padding: 0;
          margin: 0;
        }

        a {
          text-decoration: none;
        }

        :host {
          font-size: 16px;
          display: flex;
          flex-flow: column;
          gap: 0;
          padding: 0;
          width: 100%;
        }

        .top {
          display: flex;
          flex-flow: column;
          gap: 5px;
          padding: 0;
          width: 100%;
        }

        .top > h4.title {
          border-bottom: var(--border-mobile);
          display: flex;
          align-items: center;
          color: var(--title-color);
          font-size: 1.3rem;
          font-weight: 500;
          margin: 0;
          padding: 0 0 6px 0;
        }

        .top > .desc {
          margin: 0;
          padding: 6px 0 10px;
          color: var(--text-color);
          font-size: 1rem;
          line-height: 1.5;
          font-family: var(--font-main), sans-serif;
        }

        .top > .desc > span {
          margin: 0;
          color: var(--gray-color);
          font-size: 0.85rem;
          line-height: 1.5;
          font-family: var(--font-read), sans-serif;
        }

        .actions {
          border-bottom: var(--border);
          background-color: var(--background);
          display: flex;
          flex-flow: column;
          gap: 0;
          z-index: 3;
          width: 100%;
          position: sticky;
          top: 60px;
        }

        .actions > ul.tab {
          height: max-content;
          width: 100%;
          padding: 0;
          margin: 0;
          list-style-type: none;
          display: flex;
          gap: 0;
          align-items: center;
          max-width: 100%;
          overflow-x: scroll;
          -ms-overflow-style: none;
          scrollbar-width: none;
        }

        .actions > ul.tab::-webkit-scrollbar {
          display: none !important;
          visibility: hidden;
        }

        .actions > ul.tab > li.tab-item {
          color: var(--gray-color);
          font-family: var(--font-text), sans-serif;
          font-weight: 400;
          padding: 6px 20px 8px 0;
          margin: 0;
          display: flex;
          align-items: center;
          cursor: pointer;
          overflow: visible;
          font-size: 0.95rem;
        }

        .actions > ul.tab > li.tab-item > .text {
          font-weight: 500;
          font-size: 1rem;
        }

        .actions > ul.tab > li.tab-item:hover > .text {
          color: transparent;
          background: var(--accent-linear);
          background-clip: text;
          -webkit-background-clip: text;
        }

        .actions > ul.tab > li.active {
          font-size: 0.95rem;
        }

        .actions > ul.tab > li.active > .text {
          color: transparent;
          background: var(--accent-linear);
          background-clip: text;
          -webkit-background-clip: text;
          font-family: var(--font-read);
        }

        .actions > ul.tab span.line {
          position: absolute;
          z-index: 1;
          background: var(--accent-linear);
          display: inline-block;
          bottom: -2.5px;
          left: 0px;
          width: 20px;
          min-height: 5px;
          border-top-left-radius: 5px;
          border-top-right-radius: 5px;
          border-bottom-left-radius: 5px;
          border-bottom-right-radius: 5px;
          transition: all 300ms ease-in-out;
        }

        .content {
          display: flex;
          flex-flow: column;
          gap: 0;
          padding: 0;
          width: 100%;
        }

        @media screen and (max-width:600px) {

          ::-webkit-scrollbar {
            -webkit-appearance: none;
          }

          .top > .desc {
            margin: 0;
            padding: 6px 0 10px;
            font-size: 1rem;
            line-height: 1.5;
          }

          .actions {
            position: sticky;
            top: 50px;
          }

          a,
          .actions > ul.tab > li.tab-item {
            cursor: default !important;
          }
        }
      </style>
    `;
    }
  }

  class ContentContainer extends HTMLElement {
    constructor() {
      // We are not even going to touch this.
      super();

      this._url = this.getAttribute('stories') || '/api/v1/user/content/stories';

      // Get default active tab
      this._active = this.getAttribute('tab') || "stories";

      // let's create our shadow root
      this.shadowObj = this.attachShadow({ mode: "open" });

      this.render();
    }

    render() {
      this.shadowObj.innerHTML = this.getTemplate();
    }

    connectedCallback() {
      this.updateActiveTab(this._active);
      this.activateTab();
    }

    updateActiveTab = active => {
      // Select tab with active class
      const tab = this.shadowObj.querySelector(`ul#tab > li.${active}`);
      // select line
      const line = this.shadowObj.querySelector('ul#tab span.line');

      if (tab && line) {
        tab.classList.add('active');

        // Calculate half tab width - 10px
        const tabWidth = (tab.offsetWidth/2) - 20;

        // update line
        line.style.left = `${tab.offsetLeft + tabWidth}px`;
      }
      else {
        // select stories tab
        const stories = this.shadowObj.querySelector(`ul#tab > li.stories`);
        stories.classList.add('active');
      }
    }

    activateTab = () => {
      const outerThis = this;
      const tab = this.shadowObj.querySelector('ul#tab');
      const contentContainer = this.shadowObj.querySelector('.content');

      if (tab && contentContainer) {
        const line = tab.querySelector('span.line');
        const tabItems = tab.querySelectorAll('li.tab-item');
        let activeTab = tab.querySelector('li.tab-item.active');

        tabItems.forEach((tab, index) => {
          tab.addEventListener('click', e => {
            e.preventDefault();
            e.stopPropagation();

            // Calculate half tab width - 10px
            const tabWidth = (tab.offsetWidth / 2) - 20;

            line.style.left = `${tab.offsetLeft + tabWidth}px`;

            if (tab.dataset.element === activeTab.dataset.element) {
              return;
            }
            else {
              activeTab.classList.remove('active');
              tab.classList.add('active');
              activeTab = tab;
              if (tab.dataset.element === "stories") {
                contentContainer.innerHTML = outerThis.getStatFeedStories();
              } else if (tab.dataset.element === "replies") {
                contentContainer.innerHTML = outerThis.getStatFeedReplies();
              }
            }
          });
        });
      }
    }

    getTemplate = () => {
      // Show HTML Here
      return `
      ${this.getBody()}
      ${this.getStyles()}
    `;
    }

    getBody = () => {
      // language=HTML
      return `
      ${this.getHeader()}
      ${this.getTab()}
			<div class="content">
				${this.getStatFeedStories()}
      </div>
    `;
    }

    getStatFeedStories = () => {
      return /* html */`
      <content-feed kind="stories" api="${this.getAttribute('stories')}" page="1" limit="10"></content-feed>
    `;
    }

    getStatFeedReplies = () => {
      return /* html */`
      <content-feed kind="replies" api="${this.getAttribute('replies')}" page="1" limit="10"></content-feed>
    `;
    }

    getHeader = () => {
      return /* html */`
      <div class="top">
        <p class="desc">
          Your content is the list of all stories or replies you've created in this platform. You can view your stories, and replies.
        </p>
      </div>
    `;
    }

    getTab = () => {
      return /* html */`
      <div class="actions">
        <ul id="tab" class="tab">
          <li data-element="stories" class="tab-item stories active">
            <span class="text">Stories</span>
          </li>
          <li data-element="replies" class="tab-item replies">
            <span class="text">Replies</span>
          </li>
          <span class="line"></span>
        </ul>
      </div>
    `;
    }

    getStyles() {
      return /* css */`
      <style>
        *,
        *:after,
        *:before {
          box-sizing: border-box !important;
          font-family: inherit;
          -webkit-box-sizing: border-box !important;
        }

        *:focus {
          outline: inherit !important;
        }

        *::-webkit-scrollbar {
          width: 3px;
        }

        *::-webkit-scrollbar-track {
          background: var(--scroll-bar-background);
        }

        *::-webkit-scrollbar-thumb {
          width: 3px;
          background: var(--scroll-bar-linear);
          border-radius: 50px;
        }

        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
          padding: 0;
          margin: 0;
          font-family: inherit;
        }

        p,
        ul,
        ol {
          padding: 0;
          margin: 0;
        }

        a {
          text-decoration: none;
        }

        :host {
          font-size: 16px;
          display: flex;
          flex-flow: column;
          gap: 0;
          padding: 0;
          width: 100%;
        }

        .top {
          display: flex;
          flex-flow: column;
          gap: 5px;
          padding: 0;
          width: 100%;
        }

        .top > h4.title {
          border-bottom: var(--border-mobile);
          display: flex;
          align-items: center;
          color: var(--title-color);
          font-size: 1.3rem;
          font-weight: 500;
          margin: 0;
          padding: 0 0 6px 0;
        }

        .top > .desc {
          margin: 0;
          padding: 10px 0;
          color: var(--gray-color);
          font-size: 1rem;
          font-family: var(--font-main), sans-serif;
        }

        .actions {
          border-bottom: var(--border);
          background-color: var(--background);
          display: flex;
          flex-flow: column;
          gap: 0;
          z-index: 3;
          width: 100%;
          position: sticky;
          top: 60px;
        }

        .actions > ul.tab {
          height: max-content;
          width: 100%;
          padding: 0;
          margin: 0;
          list-style-type: none;
          display: flex;
          gap: 0;
          z-index: 3;
          align-items: center;
          max-width: 100%;
          overflow-x: scroll;
          -ms-overflow-style: none;
          scrollbar-width: none;
        }

        .actions > ul.tab::-webkit-scrollbar {
          display: none !important;
          visibility: hidden;
        }

        .actions > ul.tab > li.tab-item {
          color: var(--gray-color);
          font-family: var(--font-text), sans-serif;
          font-weight: 400;
          padding: 6px 20px 8px 0;
          margin: 0;
          display: flex;
          align-items: center;
          cursor: pointer;
          overflow: visible;
          font-size: 0.95rem;
        }

        .actions > ul.tab > li.tab-item > .text {
          font-weight: 500;
          font-size: 1rem;
        }

        .actions > ul.tab > li.tab-item:hover > .text {
          color: transparent;
          background: var(--accent-linear);
          background-clip: text;
          -webkit-background-clip: text;
        }

        .actions > ul.tab > li.active {
          font-size: 0.95rem;
          font-family: var(--font-read), sans-serif;
        }

        .actions > ul.tab > li.active > .text {
          color: transparent;
          background: var(--accent-linear);
          background-clip: text;
          -webkit-background-clip: text;
          font-family: var(--font-read), sans-serif;
        }

        .actions > ul.tab span.line {
          position: absolute;
          z-index: 1;
          background: var(--accent-linear);
          display: inline-block;
          bottom: -2.5px;
          left: 0px;
          width: 20px;
          min-height: 5px;
          border-top-left-radius: 5px;
          border-top-right-radius: 5px;
          border-bottom-left-radius: 5px;
          border-bottom-right-radius: 5px;
          transition: all 300ms ease-in-out;
        }

        .content {
          display: flex;
          flex-flow: column;
          gap: 10px;
          padding: 0;
          width: 100%;
        }

        @media screen and (max-width:600px) {
          ::-webkit-scrollbar {
            -webkit-appearance: none;
          }

          .top > .desc {
            margin: 0;
            padding: 6px 0 10px;
            color: var(--gray-color);
            font-size: 1rem;
            line-height: 1.5;
            font-family: var(--font-main), sans-serif;
          }

          .actions {
            position: sticky;
            top: 50px;
          }

          a,
          .actions > ul.tab > li.tab-item {
            cursor: default !important;
          }
        }

      </style>
    `;
    }
  }

  // Extending the functionality of the span element
  class CustomSpan extends HTMLSpanElement {
    constructor() {
      super('span');

      // render the element
      this.render();

      // set styles
      this.setStyles();
    }

    // attributes to watch for
    static get observedAttributes() {
      return ['width'];
    }

    // render the element
    render() {
      this.innerHTML = this.getTemplate();
    }

    // connected callback
    connectedCallback() {
    }

    // attribute change callback
    attributeChangedCallback(name, oldValue, newValue) {
      this.setStyles();
    }

    // get the template
    getTemplate() {
      return `
      ${this.innerHTML}
    `;
    }

    // Set styles
    setStyles() {
      // set display property to inline-block
      this.style.display = 'inline-block';

      // set width based on the attribute
      this.style.width = this.getAttribute('width') || 'auto';
    }
  }

  class QuickPost extends HTMLElement {
    constructor() {
      // We are not even going to touch this.
      super();

      // let's create our shadow root
      this.shadowObj = this.attachShadow({ mode: "open" });

      this.boundHandleWsMessage = this.handleWsMessage.bind(this);
      this.checkAndAddHandler = this.checkAndAddHandler.bind(this);

      this.noPreview = this.convertToBoolean(this.getAttribute('no-preview'));

      this.viewTimer = null;
      this.hasBeenViewed = false;
      this.observerOptions = {
        root: null,
        rootMargin: '0px',
        threshold: 0.5, // Consider the post visible when 50% is in view
      };

      this.render();
    }

    convertToBoolean = value => {
      return value === "true";
    }

    render() {
      this.shadowObj.innerHTML = this.getTemplate();
    }

    connectedCallback() {
      this.style.display = 'flex';

      // style the last block
      this.styleLastBlock();

      // Check and add handler
      this.checkAndAddHandler();

      this.setupIntersectionObserver();

      // Open read more
      this.openReadMore();

      // Open full post
      this.openQuickPost();

      // Open url
      this.openUrl();
    }

    checkAndAddHandler() {
      if (window.wss) {
        window.wss.addMessageHandler(this.boundHandleWsMessage);
        // console.log('WebSocket handler added successfully');
      } else {
        // console.log('WebSocket manager not available, retrying...');
        setTimeout(this.checkAndAddHandler, 500); // Retry after 500ms
      }
    }

    disconnectedCallback() {
      if (window.wss) {
        window.wss.removeMessageHandler(this.boundHandleWsMessage);
      }

      if (this.observer) {
        this.observer.disconnect();
      }
      this.clearViewTimer();
    }

    handleWsMessage = message => {
      // Handle the message in this component
      // console.log('Message received in component:', message);
      const data = message.data;

      if (message.type !== 'action') return;

      const user = data?.user;
      const userHash = window.hash;

      const author = this.shadowObj.querySelector('hover-author');
      const actionWrapper = this.shadowObj.querySelector('action-wrapper');

      const hash = this.getAttribute('hash').toUpperCase();
      const authorHash = this.getAttribute('author-hash').toUpperCase();

      const target = data.hashes.target;

      if (data.action === 'connect' && data.kind === 'user') {
        this.handleConnectAction(data, author, userHash, authorHash);
      } else if (target === hash) {
        if (data.action === 'like') {
          if(user !== null && user === userHash) {
            return;
          }
          // get likes parsed to number
          const likes = (this.parseToNumber(this.getAttribute('likes')) + data.value);
          // update likes
          this.setAttribute('likes', likes);
          // update likes in the action wrapper
          actionWrapper.setAttribute('likes', likes);
          actionWrapper.setAttribute('reload', 'true');
        } 
        else if(data.action === 'reply'){
          const replies = this.parseToNumber(this.getAttribute('replies')) + data.value;
          this.setAttribute('replies', replies);
          actionWrapper.setAttribute('replies', replies);
          actionWrapper.setAttribute('reload', 'true');
        } 
        else if(data.action === 'view') {
          const views = this.parseToNumber(this.getAttribute('views')) + data.value;
          this.setAttribute('views', views);
          actionWrapper.setAttribute('views', views);
          actionWrapper.setAttribute('reload', 'true');
        }
      }
    }

    sendWsMessage(data) {
      if (window.wss) {
        window.wss.sendMessage(data);
      } else {
        console.warn('WebSocket connection not available. view information not sent.');
      }
    }

    handleConnectAction = (data, author, userHash, authorHash) => {
      const to = data.hashes.to;
      if(to === authorHash) {
        const followers = this.parseToNumber(this.getAttribute('author-followers')) + data.value;
        this.setAttribute('author-followers', followers);
        this.updateFollowers(author, this.getAttribute('author-followers'));

        if (data.hashes.from === userHash) {
          const value = data.value === 1 ? 'true' : 'false';
    
          // update user-follow/auth-follow attribute
          this.setAttribute('author-follow', value);
          author.setAttribute('user-follow', value);
        }

        author.setAttribute('reload', 'true');
      }
    }

    updateFollowers = (element, value) => {
      element.setAttribute('followers', value);
    }

    setupIntersectionObserver() {
      this.observer = new IntersectionObserver((entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            this.startViewTimer();
          } else {
            this.clearViewTimer();
          }
        });
      }, this.observerOptions);

      this.observer.observe(this);
    }

    startViewTimer() {
      if (this.hasBeenViewed) return;

      this.viewTimer = setTimeout(() => {
        this.sendViewData();
        this.hasBeenViewed = true;
      }, 5000); // 5 seconds
    }

    clearViewTimer() {
      if (this.viewTimer) {
        clearTimeout(this.viewTimer);
        this.viewTimer = null;
      }
    }

    sendViewData() {
      const authorHash = this.getAttribute('author-hash').toUpperCase();
      // check if the author is the user
      if (authorHash === window.hash) return;

      const hash = this.getAttribute('hash').toUpperCase();
      let kind = this.getAttribute('story');
      if(kind === 'quick') {
        kind = 'story';
      }
      const viewData = {
        type: 'action',
        frontend: true,
        data: {
          kind: kind,
          publish: true,
          hashes: { target: hash },
          action: 'view',
          value: 1
        }
      };

      // send the view data
      this.sendWsMessage(viewData);
    }

    disableScroll() {
      // Get the current page scroll position
      let scrollTop = window.scrollY || document.documentElement.scrollTop;
      let scrollLeft = window.scrollX || document.documentElement.scrollLeft;
      document.body.classList.add("stop-scrolling");

      // if any scroll is attempted, set this to the previous value
      window.onscroll = function () {
        window.scrollTo(scrollLeft, scrollTop);
      };
    }

    enableScroll() {
      document.body.classList.remove("stop-scrolling");
      window.onscroll = function () { };
    }

    // Open quick post
    openQuickPost = () => {
      // get url
      let url = this.getAttribute('url');

      url = url.trim().toLowerCase();

      // Get the body
      const body = document.querySelector('body');

      // get current content
      const content = this.shadowObj.querySelector('#content');

      if(body && content) {
        content.addEventListener('click', event => {
          event.preventDefault();

          // Get full post
          const post =  this.getFullPost();
    
          // replace and push states
          this.replaceAndPushStates(url, body, post);

          body.innerHTML = post;
        });
      }
    }

    // Replace and push states
    replaceAndPushStates = (url, body, post) => {
      // get the first custom element in the body
      const firstElement = body.firstElementChild;

      // convert the custom element to a string
      const elementString = firstElement.outerHTML;

      // get window location
      const pageUrl = window.location.href;
      window.history.replaceState(
        { page: 'page', content: elementString },
        url, pageUrl
      );

      // Updating History State
      window.history.pushState(
        { page: 'page', content: post},
        url, url
      );
    }

    // Get lapse time
    getLapseTime = isoDateStr => {
      const dateIso = new Date(isoDateStr); // ISO strings with timezone are automatically handled
      let userTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;

      // Convert posted time to the current timezone
      const date = new Date(dateIso.toLocaleString('en-US', { timeZone: userTimezone }));

      // Get the current time
      const currentTime = new Date();

      // Get the difference in time
      const timeDifference = currentTime - date;

      // Get the seconds
      const seconds = timeDifference / 1000;

      // Check if seconds is less than 60: return Just now
      if (seconds < 60) {
        return 'Just now';
      }
      // check if seconds is less than 86400: return time AM/PM
      if (seconds < 86400) {
        return date.toLocaleTimeString('en-US', { hour: 'numeric', minute: 'numeric', hour12: true });
      }

      // check if seconds is less than 604800: return day and time
      if (seconds <= 604800) {
        return date.toLocaleDateString('en-US', { weekday: 'short', hour: 'numeric', minute: 'numeric', hour12: true });
      }

      // Check if the date is in the current year:: return date and month short 2-digit year without time
      if (date.getFullYear() === currentTime.getFullYear()) {
        return date.toLocaleDateString('en-US', { day: 'numeric', month: 'short', });
      }
      else {
        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
      }
    }

    openReadMore = () => {
      // Get the read more button
      const readMore = this.shadowObj.querySelector('.content .read-more');

      // Get the content
      const content = this.shadowObj.querySelector('.content');

      // Check if the read more button exists
      if (readMore && content) {
        readMore.addEventListener('click', e => {
          // prevent the default action
          e.preventDefault();

          // prevent the propagation of the event
          e.stopPropagation();

          // Prevent event from reaching any immediate nodes.
          e.stopImmediatePropagation();

          // Toggle the active class
          content.classList.remove('extra');

          // remove the read more button
          readMore.remove();
        });
      }
    }

    formatNumber = n => {
      if (n >= 0 && n <= 999) {
        return n.toString();
      } else if (n >= 1000 && n <= 9999) {
        const value = (n / 1000).toFixed(2);
        return `${value}k`;
      } else if (n >= 10000 && n <= 99999) {
        const value = (n / 1000).toFixed(1);
        return `${value}k`;
      } else if (n >= 100000 && n <= 999999) {
        const value = (n / 1000).toFixed(0);
        return `${value}k`;
      } else if (n >= 1000000 && n <= 9999999) {
        const value = (n / 1000000).toFixed(2);
        return `${value}M`;
      } else if (n >= 10000000 && n <= 99999999) {
        const value = (n / 1000000).toFixed(1);
        return `${value}M`;
      } else if (n >= 100000000 && n <= 999999999) {
        const value = (n / 1000000).toFixed(0);
        return `${value}M`;
      } else if (n >= 1000000000) {
        return "1B+";
      }
      else {
        return 0;
      }
    }

    parseToNumber = num_str => {
      // Try parsing the string to an integer
      const num = parseInt(num_str);

      // Check if parsing was successful
      if (!isNaN(num)) {
        return num;
      } else {
        return 0;
      }
    }

    openUrl = () => {
      // get all the links
      const links = this.shadowObj.querySelectorAll('div#content a');
      const body = document.querySelector('body');

      // loop through the links
      if (!links) return;

      links.forEach(link => {
        // add event listener to the link
        link.addEventListener('click', event => {
          event.preventDefault();
          event.stopPropagation();
          event.stopImmediatePropagation();
          // get the url
          const url = link.getAttribute('href');

          // link pop up
          let linkPopUp = `<url-popup url="${url}"></url-popup>`;

          // open the popup
          body.insertAdjacentHTML('beforeend', linkPopUp);
        });
      });
    }

    getTemplate() {
      // Show HTML Here
      return `
      ${this.getBody()}
      ${this.getStyles()}
    `;
    }

    getBody() {
      return `
      ${this.getHeader()}
      ${this.getContent()}
      ${this.getImages()}
      ${this.getFooter()}
      ${this.getReply(this.getAttribute('story'))}
    `;
    }

    getHeader = () => {
      return /*html*/`
      <div class="meta top-meta">
        <span class="by">by</span>
        ${this.getAuthorHover()}
        <span class="sp">•</span>
        <time class="time" datetime="${this.getAttribute('time')}">
          ${this.getLapseTime(this.getAttribute('time'))}
        </time>
      </div>
    `
    }

    getContent = () => {
      const mql = window.matchMedia('(max-width: 660px)');
      const content = this.innerHTML;

      // Convert content to str and check length
      const contentStr = content.replace(/<[^>]*>/g, '');
      const contentLength = contentStr.length;

      let chars = 300;

      // Check if its a mobile view
      if (mql.matches) {
        chars = 200;
      }

      // Check if content length is greater than 300
      if (contentLength > 300) {
        return /*html*/`
        <div class="content extra ${chars <= 200 ? 'feed' : ''}" id="content">
          ${content}
          <div class="read-more">
            <span class="action">view more</span>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" fill="currentColor">
              <path d="M12.78 5.22a.749.749 0 0 1 0 1.06l-4.25 4.25a.749.749 0 0 1-1.06 0L3.22 6.28a.749.749 0 1 1 1.06-1.06L8 8.939l3.72-3.719a.749.749 0 0 1 1.06 0Z"></path>
            </svg>
          </div>
        </div>
      `
      }
      else {
        return /*html*/`
        <div class="content" id="content">
          ${content}
        </div>
      `
      }
    }

    // style the last paragraph or the last block element in content
    styleLastBlock = () => {
      const content = this.shadowObj.querySelector('.content#content');
      if (!content) return;

      const lastBlock = content.lastElementChild;
      if (!lastBlock) return;

      // style the last block
      lastBlock.style.setProperty('padding', '0 0 0');
      lastBlock.style.setProperty('margin', '0 0 0');
    }

    getPreview = url => {
      return /*html*/`
      <preview-popup url="${url}"></preview-popup> 
    `
    }

    getReply = story => {
      if(this.noPreview) return '';
      if (story === 'reply') {
        const parent = this.getAttribute('parent');
        let url = parent.startsWith('P') ? `/api/v1/p/${parent.toLowerCase()}/preview` : `/api/v1/r/${parent.toLowerCase()}/preview`;
        return /*html*/`
        <preview-post url="${url}" hash="${parent}" preview="quick"></preview-post>
      `
      } else return '';
    }

    getFooter = () => {
      return /*html*/`
      <action-wrapper full="false" kind="${this.getAttribute('story')}" reload="false" likes="${this.getAttribute('likes')}" 
        replies="${this.getAttribute('replies')}" liked="${this.getAttribute('liked')}" wrapper="false" images="${this.getAttribute('images')}"
        hash="${this.getAttribute('hash')}" views="${this.getAttribute('views')}"  url="${this.getAttribute('url')}" summary="Post by - ${this.getAttribute('author-name')}"
        preview-title="" time="${this.getAttribute('time')}" author-hash="${this.getAttribute('author-hash')}">
        ${this.getHTML()}
      </action-wrapper>
    `
    }

    getHTML = () => {
      const text = this.innerHTML;
      const parser = new DOMParser();
      const doc = parser.parseFromString(text, 'text/html');
      return doc.body.innerHTML;
    }

    getAuthorHover = () => {
      let url = this.getAttribute('author-url');
      url = url.trim().toLowerCase();
      let bio = this.getAttribute('author-bio') || 'This author has not provided a bio yet.';
      // replace all " and ' with &quot; and &apos; to avoid breaking the html
      bio = bio.replace(/"/g, '&quot;').replace(/'/g, '&apos;');
      return /* html */`
			<hover-author url="${url}" you="${this.getAttribute('author-you')}" hash="${this.getAttribute('author-hash')}"
        picture="${this.getAttribute('author-img')}" name="${this.getAttribute('author-name')}" contact='${this.getAttribute("author-contact")}'
        stories="${this.getAttribute('author-stories')}" replies="${this.getAttribute('author-replies')}"
        followers="${this.getAttribute('author-followers')}" following="${this.getAttribute('author-following')}" user-follow="${this.getAttribute('author-follow')}"
        verified="${this.getAttribute('author-verified')}" bio="${bio}">
      </hover-author>
		`
    }

    getFullPost = () => {
      const parent = this.getAttribute('parent');
      let text = parent ? `parent="${parent}"` : '';
      const story = this.getAttribute('story') === 'quick' ? 'quick' : 'reply';
      const images = this.getAttribute('images');
      return /* html */`
      <app-post story="${story}" tab="replies" url="${this.getAttribute('url')}" hash="${this.getAttribute('hash')}"
        likes="${this.getAttribute('likes')}" replies="${this.getAttribute('replies')}" ${text} preview="full"
        replies-url="${this.getAttribute('replies-url')}" likes-url="${this.getAttribute('likes-url')}" images='${images}'
        liked="${this.getAttribute('liked')}" views="${this.getAttribute('views')}" time="${this.getAttribute('time')}"
        author-stories="${this.getAttribute('author-stories')}" author-replies="${this.getAttribute('author-replies')}" author-contact='${this.getAttribute("author-contact")}'
        author-you="${this.getAttribute('author-you')}" author-hash="${this.getAttribute('author-hash')}" author-url="${this.getAttribute('author-url')}"
        author-img="${this.getAttribute('author-img')}" author-verified="${this.getAttribute('author-verified')}" author-name="${this.getAttribute('author-name')}"
        author-followers="${this.getAttribute('author-followers')}" author-following="${this.getAttribute('author-following')}" author-follow="${this.getAttribute('author-follow')}"
        author-bio="${this.getAttribute('author-bio')}">
        ${this.innerHTML}
      </app-post>
    `
    }

    getFullCss = () => {
      if(this.noPreview) {
        return "padding: 10px 0 5px;"
      } else {
        if(this.getAttribute('story') === 'reply') {
          return "padding: 10px 0 13px;"
        } else {
          return "padding: 10px 0 5px;"
        }
      }
    }

    getImages = () => {
      const images = this.getAttribute('images');
      if(!images || images === 'null') return '';

      const imageArray = images.split(',');

      // if length is greater is less than 1
      if(imageArray.length < 1) return '';

      // return
      return /* html */`
      <images-wrapper images="${images}"></images-wrapper>
    `
    }

    getStyles() {
      return /* css */`
      <style>

        *,
        *:after,
        *:before {
          box-sizing: border-box !important;
          font-family: inherit;
          -webkit-box-sizing: border-box !important;
        }

        *:focus {
          outline: inherit !important;
        }

        *::-webkit-scrollbar {
          -webkit-appearance: none;
        }

        a {
          text-decoration: none;
        }


        :host {
          font-size: 16px;
          border-bottom: var(--border);
          font-family: var(--font-main), sans-serif;
          ${this.getFullCss()}
          margin: 0;
          width: 100%;
          display: flex;
          flex-flow: column;
          gap: 0;
        }

        .meta {
          width: 100%;
          height: max-content;
          display: flex;
          position: relative;
          color: var(--gray-color);
          align-items: center;
          font-family: var(--font-mono),monospace;
          gap: 5px;
          font-size: 0.9rem;
          line-height: 1.5;
        }

        .meta > span.sp {
          margin: 1px 0 0 0;
        }

        .meta > span.by {
          font-weight: 500;
          font-size: 0.93rem;
          margin: 0 0 1px 1px;
        }

        .meta > time.time {
          font-family: var(--font-text), sans-serif;
          font-size: 0.83rem;
          font-weight: 500;
          margin: 1px 0 0 0;
        }

        .meta a.link {
          text-decoration: none;
          color: transparent;
          background-image: var(--action-linear);
          background-clip: text;
          -webkit-background-clip: text;
        }

        .meta  a.author-link {
          text-decoration: none;
          color: transparent;
          background: var(--accent-linear);
          background-clip: text;
          -webkit-background-clip: text;
        }

        .content {
          width: 100%;
          display: flex;
          cursor: pointer;
          flex-flow: column;
          color: var(--text-color);
          font-family: var(--font-main), sans-serif;
          line-height: 1.4;
          gap: 0;
          margin: 0;
          padding: 0;
        }

        .content.extra {
          max-height: 200px;
          overflow: hidden;
          position: relative;
        }

        .content.extra.feed {
          max-height: 150px;
        }

        .content.extra .read-more {
          position: absolute;
          bottom: -5px;
          right: 0;
          left: 0;
          width: 100%;
          padding: 5px 0;
          display: flex;
          align-items: end;
          justify-content: center;
          min-height: 80px;
          gap: 3px;
          cursor: pointer;
          font-weight: 500;
          font-family: var(--font-main), sans-serif;
          color: var(--gray-color);
          background: var(--fade-linear-gradient);
        }

        .content.extra .read-more svg {
          display: inline-block;
          width: 16px;
          height: 16px;
          margin: 0 0 2px 0;
        }

        .content h6,
        .content h5,
        .content h4,
        .content h3,
        .content h1 {
          padding: 0;
          font-size: 1.3rem !important;
          color: var(--title-color);
          font-weight: 500;
          line-height: 1.5;
          margin: 5px 0;
        }

        .content p {
          font-size: 1rem;
          margin: 0 0 5px;
          line-height: 1.4;
        }

        .content a {
          text-decoration: none;
          cursor: pointer;
          color: var(--anchor-color) !important;
        }

        .content a:hover {
          text-decoration: underline;
        }

        .content blockquote {
          margin: 2px 0;
          padding: 5px 0;
          font-style: italic;
          background: var(--background);
          color: var(--text-color);
          font-weight: 400;
          line-height: 1.4;
        }

        .content blockquote p {
          margin: 0;
        }

        .content blockquote * {
          margin: 0;
        }

        .content hr {
          border: none;
          background-color: var(--text-color);
          height: 1px;
          margin: 10px 0;
        }

        .content code {
          background: var(--gray-background);
          padding: 0 5px;
          font-family: var(--font-mono);
          font-size: 0.9rem;
          border-radius: 5px;
        }

        .content b,
        .content strong {
          font-weight: 700;
          line-height: 1.4;

        }

        .content ul,
        .content ol {
          margin: 5px 0 15px 20px;
          padding: 0 0 0 15px;
          color: inherit;
          line-height: 1.4;
        }

        .content ul li,
        .content ol li {
          margin: 6px 0;
          padding: 0;
          color: inherit;
        }

        figure {
          max-width: 100% !important;
          height: auto;
          width: max-content;
          padding: 0;
          max-width: 100%;
          display: block;
          margin-block-start: 5px;
          margin-block-end: 5px;
          margin-inline-start: 0 !important;
          margin-inline-end: 0 !important;
        }

        @media screen and (max-width:660px) {
          :host {
            font-size: 16px;
            width: 100%;
            border-bottom: var(--border);
          }

          ::-webkit-scrollbar {
            -webkit-appearance: none;
          }

          .meta a.reply-link,
          .meta div.author-name > a,
          a,
          .stats > .stat {
            cursor: default !important;
          }

          .content a {
            cursor: default !important;
          }

          a,
          .content.extra .read-more,
          .replying-to,
          .content,
          span.action {
            cursor: default !important;
          }
        }
      </style>
    `;
    }
  }

  class PollPost extends HTMLElement {
    constructor() {
      // We are not even going to touch this.
      super();

      // let's create our shadow root
      this.shadowObj = this.attachShadow({ mode: "open" });

      this.boundHandleWsMessage = this.handleWsMessage.bind(this);
      this.checkAndAddHandler = this.checkAndAddHandler.bind(this);

      this.viewTimer = null;
      this.hasBeenViewed = false;
      this.observerOptions = {
        root: null,
        rootMargin: '0px',
        threshold: 0.5, // Consider the post visible when 50% is in view
      };

      this.render();
    }

    render() {
      this.shadowObj.innerHTML = this.getTemplate();
    }

    connectedCallback() {
      this.style.display = 'flex';

      // style the last block
      this.styleLastBlock();

      // Check and add handler
      this.checkAndAddHandler();

      this.setupIntersectionObserver();

      // Open poll post
      this.openPollPost();

      // Open url
      this.openUrl();
    }

    checkAndAddHandler() {
      if (window.wss) {
        window.wss.addMessageHandler(this.boundHandleWsMessage);
        // console.log('WebSocket handler added successfully');
      } else {
        // console.log('WebSocket manager not available, retrying...');
        setTimeout(this.checkAndAddHandler, 500); // Retry after 500ms
      }
    }

    disconnectedCallback() {
      if (window.wss) {
        window.wss.removeMessageHandler(this.boundHandleWsMessage);
      }

      if (this.observer) {
        this.observer.disconnect();
      }
      this.clearViewTimer();
    }

    handleWsMessage = message => {
      // Handle the message in this component
      // console.log('Message received in component:', message);
      const data = message.data;

      if (message.type !== 'action') return;

      const user = data?.user;
      const userHash = window.hash;

      const author = this.shadowObj.querySelector('hover-author');
      const actionWrapper = this.shadowObj.querySelector('action-wrapper');
      const voteEl = this.shadowObj.querySelector('votes-wrapper');

      const hash = this.getAttribute('hash').toUpperCase();
      const authorHash = this.getAttribute('author-hash').toUpperCase();

      const target = data.hashes.target;

      if (data.action === 'connect' && data.kind === 'user') {
        this.handleConnectAction(data, author, userHash, authorHash);
      } else if (target === hash) {
        if (data.action === 'like') {
          if(user !== null && user === userHash) {
            return;
          }
          // get likes parsed to number
          const likes = (this.parseToNumber(this.getAttribute('likes')) + data.value);
          // update likes
          this.setAttribute('likes', likes);
          // update likes in the action wrapper
          actionWrapper.setAttribute('likes', likes);
          actionWrapper.setAttribute('reload', 'true');
        } 
        else if(data.action === 'reply'){
          const replies = this.parseToNumber(this.getAttribute('replies')) + data.value;
          this.setAttribute('replies', replies);
          actionWrapper.setAttribute('replies', replies);
          actionWrapper.setAttribute('reload', 'true');
        } 
        else if(data.action === 'view') {
          const views = this.parseToNumber(this.getAttribute('views')) + data.value;
          this.setAttribute('views', views);
          actionWrapper.setAttribute('views', views);
          actionWrapper.setAttribute('reload', 'true');
        } else if (data.action === 'vote') {
          if(user !== null && user === userHash) {
            return;
          }
          // update vote
          voteEl.setAttribute('vote', data.value);
        }
      }
    }

    sendWsMessage(data) {
      if (window.wss) {
        window.wss.sendMessage(data);
      } else {
        console.warn('WebSocket connection not available. view information not sent.');
      }
    }

    handleConnectAction = (data, author, userHash, authorHash) => {
      const to = data.hashes.to;
      if(to === authorHash) {
        const followers = this.parseToNumber(this.getAttribute('author-followers')) + data.value;
        this.setAttribute('author-followers', followers);
        this.updateFollowers(author, this.getAttribute('author-followers'));

        if (data.hashes.from === userHash) {
          const value = data.value === 1 ? 'true' : 'false';
    
          // update user-follow/auth-follow attribute
          this.setAttribute('author-follow', value);
          author.setAttribute('user-follow', value);
        }

        author.setAttribute('reload', 'true');
      }
    }

    updateFollowers = (element, value) => {
      element.setAttribute('followers', value);
    }

    setupIntersectionObserver() {
      this.observer = new IntersectionObserver((entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            this.startViewTimer();
          } else {
            this.clearViewTimer();
          }
        });
      }, this.observerOptions);

      this.observer.observe(this);
    }

    startViewTimer() {
      if (this.hasBeenViewed) return;

      this.viewTimer = setTimeout(() => {
        this.sendViewData();
        this.hasBeenViewed = true;
      }, 5000); // 5 seconds
    }

    clearViewTimer() {
      if (this.viewTimer) {
        clearTimeout(this.viewTimer);
        this.viewTimer = null;
      }
    }

    sendViewData() {
      const authorHash = this.getAttribute('author-hash').toUpperCase();
      // check if the author is the user
      if (authorHash === window.hash) return;

      const hash = this.getAttribute('hash').toUpperCase();
      const viewData = {
        type: 'action',
        frontend: true,
        data: {
          kind: 'story',
          publish: true,
          hashes: { target: hash },
          action: 'view',
          value: 1
        }
      };

      // send the view data
      this.sendWsMessage(viewData);
    }

    openPollPost = () => {
      // get url
      let url = this.getAttribute('url');

      url = url.trim().toLowerCase();

      // Get the body
      const body = document.querySelector('body');

      // get current content
      const content = this.shadowObj.querySelector('#content');

      if(body && content) {
        content.addEventListener('click', event => {
          event.preventDefault();
          event.stopPropagation();
          event.stopImmediatePropagation();

          // Get full post
          const post =  this.getFullPost();

          // replace and push states
          this.replaceAndPushStates(url, body, post);

          body.innerHTML = post;
        });
      }
    }

    replaceAndPushStates = (url, body, post) => {
      // get the first custom element in the body
      const firstElement = body.firstElementChild;

      // convert the custom element to a string
       const elementString = firstElement.outerHTML;

      // get window location
      const pageUrl = window.location.href;
      window.history.replaceState(
        { page: 'page', content: elementString },
        url, pageUrl
      );

      // Updating History State
      window.history.pushState(
        { page: 'page', content: post},
        url, url
      );
    }

    disableScroll() {
      // Get the current page scroll position
      let scrollTop = window.scrollY || document.documentElement.scrollTop;
      let scrollLeft = window.scrollX || document.documentElement.scrollLeft;
      document.body.classList.add("stop-scrolling");

      // if any scroll is attempted, set this to the previous value
      window.onscroll = function () {
        window.scrollTo(scrollLeft, scrollTop);
      };
    }

    enableScroll() {
      document.body.classList.remove("stop-scrolling");
      window.onscroll = function () { };
    }

    // style the last paragraph or the last block element in content
    styleLastBlock = () => {
      const content = this.shadowObj.querySelector('.content#content');
      if (!content) return;

      const lastBlock = content.lastElementChild;
      if (!lastBlock) return;

      // style the last block
      lastBlock.style.setProperty('padding', '0 0 0');
      lastBlock.style.setProperty('margin', '0 0 0');
    }

    formatNumber = n => {
      if (n >= 0 && n <= 999) {
        return n.toString();
      } else if (n >= 1000 && n <= 9999) {
        const value = (n / 1000).toFixed(2);
        return `${value}k`;
      } else if (n >= 10000 && n <= 99999) {
        const value = (n / 1000).toFixed(1);
        return `${value}k`;
      } else if (n >= 100000 && n <= 999999) {
        const value = (n / 1000).toFixed(0);
        return `${value}k`;
      } else if (n >= 1000000 && n <= 9999999) {
        const value = (n / 1000000).toFixed(2);
        return `${value}M`;
      } else if (n >= 10000000 && n <= 99999999) {
        const value = (n / 1000000).toFixed(1);
        return `${value}M`;
      } else if (n >= 100000000 && n <= 999999999) {
        const value = (n / 1000000).toFixed(0);
        return `${value}M`;
      } else if (n >= 1000000000) {
        return "1B+";
      }
      else {
        return 0;
      }
    }

    parseToNumber = str => {
      // Try parsing the string to an integer
      const num = parseInt(str);

      // Check if parsing was successful
      if (!isNaN(num)) {
        return num;
      } else {
        return 0;
      }
    }

    numberWithCommas = x => {
      return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }

    getLapseTime = isoDateStr => {
      const dateIso = new Date(isoDateStr); // ISO strings with timezone are automatically handled
      let userTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;

      // Convert posted time to the current timezone
      const date = new Date(dateIso.toLocaleString('en-US', { timeZone: userTimezone }));

      // Get the current time
      const currentTime = new Date();

      // Get the difference in time
      const timeDifference = currentTime - date;

      // Get the seconds
      const seconds = timeDifference / 1000;

      // Check if seconds is less than 60: return Just now
      if (seconds < 60) {
        return 'Just now';
      }
      // check if seconds is less than 86400: return time AM/PM
      if (seconds < 86400) {
        return date.toLocaleTimeString('en-US', { hour: 'numeric', minute: 'numeric', hour12: true });
      }

      // check if seconds is less than 604800: return day and time
      if (seconds <= 604800) {
        return date.toLocaleDateString('en-US', { weekday: 'short', hour: 'numeric', minute: 'numeric', hour12: true });
      }

      // Check if the date is in the current year:: return date and month short 2-digit year without time
      if (date.getFullYear() === currentTime.getFullYear()) {
        return date.toLocaleDateString('en-US', { day: 'numeric', month: 'short', });
      }
      else {
        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
      }
    }

    openUrl = () => {
      // get all the links
      const links = this.shadowObj.querySelectorAll('div#content a');
      const body = document.querySelector('body');

      // loop through the links
      if (!links) return;

      links.forEach(link => {
        // add event listener to the link
        link.addEventListener('click', event => {
          event.preventDefault();
          event.stopPropagation();
          event.stopImmediatePropagation();
          // get the url
          const url = link.getAttribute('href');

          // link pop up
          let linkPopUp = `<url-popup url="${url}"></url-popup>`;

          // open the popup
          body.insertAdjacentHTML('beforeend', linkPopUp);
        });
      });
    }

    getTemplate() {
      // Show HTML Here
      return `
      ${this.getBody()}
      ${this.getStyles()}
    `;
    }

    getBody() {
      return `
      ${this.getHeader()}
      ${this.getContent()}
      ${this.getPoll()}
      ${this.getFooter()}
    `;
    }

    getHeader = () => {
      let authorUrl = this.getAttribute('author-url');
      authorUrl = authorUrl.trim().toLowerCase();
      return /*html*/`
      <div class="meta top-meta">
        <span class="by">by</span>
        ${this.getAuthorHover()}
        <span class="sp">•</span>
        <time class="time" datetime="${this.getAttribute('time')}">
          ${this.getLapseTime(this.getAttribute('time'))}
        </time>
      </div>
    `
    }

    getPoll = () =>  {
      return /*html*/`
      <votes-wrapper reload="false" votes="${this.getAttribute('votes')}" selected="${this.getAttribute('selected')}"
        hash="${this.getAttribute('hash')}"
        end-time="${this.getAttribute('end-time')}" voted="${this.getAttribute('voted')}" options="${this.getAttribute('options')}">
      </votes-wrapper>
    `
    }

    getContent = () => {
      return `
      <div class="content" id="content">
        ${this.innerHTML}
      </div>
    `
    }

    getFooter = () => {
      return /*html*/`
      <action-wrapper full="false" kind="story" reload="false" likes="${this.getAttribute('likes')}" 
        replies="${this.getAttribute('replies')}" liked="${this.getAttribute('liked')}" wrapper="false"
        hash="${this.getAttribute('hash')}" views="${this.getAttribute('views')}" url="${this.getAttribute('url')}" summary="Post by - ${this.getAttribute('author-name')}"
        preview-title="" time="${this.getAttribute('time')}" images="${this.getAttribute('images')}" 
        author-hash="${this.getAttribute('author-hash')}">
        ${this.getHTML()}
      </action-wrapper>
    `
    }

    getHTML = () => {
      const text = this.innerHTML;
      const parser = new DOMParser();
      const doc = parser.parseFromString(text, 'text/html');
      return doc.body.innerHTML;
    }

    getAuthorHover = () => {
      let url = this.getAttribute('author-url');
      url = url.trim().toLowerCase();
      let bio = this.getAttribute('author-bio') || 'This author has not provided a bio yet.';
      // replace all " and ' with &quot; and &apos; to avoid breaking the html
      bio = bio.replace(/"/g, '&quot;').replace(/'/g, '&apos;');
      return /* html */`
			<hover-author url="${url}" you="${this.getAttribute('author-you')}" hash="${this.getAttribute('author-hash')}"
        picture="${this.getAttribute('author-img')}" name="${this.getAttribute('author-name')}" contact='${this.getAttribute("author-contact")}'
        stories="${this.getAttribute('author-stories')}" replies="${this.getAttribute('author-replies')}"
        followers="${this.getAttribute('author-followers')}" following="${this.getAttribute('author-following')}" user-follow="${this.getAttribute('author-follow')}"
        verified="${this.getAttribute('author-verified')}" bio="${bio}">
      </hover-author>
		`
    }

    getFullPost = () => {
      return /* html */`
      <app-post story="poll" tab="replies" url="${this.getAttribute('url')}" hash="${this.getAttribute('hash')}"
        likes="${this.getAttribute('likes')}" replies="${this.getAttribute('replies')}"
        replies-url="${this.getAttribute('replies-url')}" likes-url="${this.getAttribute('likes-url')}"
        options='${this.getAttribute("options")}' voted="${this.getAttribute('voted')}" selected="${this.getAttribute('selected')}"
        end-time="${this.getAttribute('end-time')}" votes="${this.getAttribute('votes')}"
        liked="${this.getAttribute('liked')}" views="${this.getAttribute('views')}" time="${this.getAttribute('time')}"
        author-you="${this.getAttribute('author-you')}" author-stories="${this.getAttribute('author-stories')}" author-replies="${this.getAttribute('author-replies')}"
        author-hash="${this.getAttribute('author-hash')}" author-url="${this.getAttribute('author-url')}" author-contact='${this.getAttribute("author-contact")}'
        author-img="${this.getAttribute('author-img')}" author-verified="${this.getAttribute('author-verified')}" author-name="${this.getAttribute('author-name')}"
        author-followers="${this.getAttribute('author-followers')}" author-following="${this.getAttribute('author-following')}" author-follow="${this.getAttribute('author-follow')}"
        author-bio="${this.getAttribute('author-bio')}">
        ${this.innerHTML}
      </app-post>
    `
    }

    getStyles() {
      return /* css */`
      <style>
        *,
        *:after,
        *:before {
          box-sizing: border-box !important;
          font-family: inherit;
          -webkit-box-sizing: border-box !important;
        }

        *:focus {
          outline: inherit !important;
        }

        *::-webkit-scrollbar {
          -webkit-appearance: none;
        }

        a {
          text-decoration: none;
        }

        :host {
          font-size: 16px;
          border-bottom: var(--border);
          font-family: var(--font-main), sans-serif;
          padding: 10px 0 5px;
          margin: 0;
          width: 100%;
          display: flex;
          flex-flow: column;
          gap: 0;
        }

        .meta {
          height: max-content;
          display: flex;
          position: relative;
          color: var(--gray-color);
          align-items: center;
          font-family: var(--font-mono),monospace;
          gap: 5px;
          font-size: 0.9rem;
          line-height: 1.5;
        }

        .meta > span.sp {
          margin: 1px 0 0 0;
        }

        .meta > span.by {
          font-weight: 500;
          font-size: 0.93rem;
          margin: 0 0 1px 1px;
        }

        .meta > time.time {
          font-family: var(--font-text), sans-serif;
          font-size: 0.83rem;
          font-weight: 500;
          margin: 1px 0 0 0;
        }

        .meta a.link {
          text-decoration: none;
          color: transparent;
          background-image: var(--action-linear);
          background-clip: text;
          -webkit-background-clip: text;
        }

        .meta  a.author-link {
          text-decoration: none;
          color: transparent;
          background: var(--accent-linear);
          background-clip: text;
          -webkit-background-clip: text;
        }

        .content {
          display: flex;
          cursor: pointer;
          flex-flow: column;
          font-family: var(--font-main), sans-serif;
          color: var(--text-color);
          line-height: 1.4;
          gap: 0;
          margin: 0;
          padding: 0;
        }

        .content h6,
        .content h5,
        .content h4,
        .content h3,
        .content h1 {
          padding: 0;
          font-size: 1.3rem !important;
          color: var(--title-color);
          font-weight: 500;
          line-height: 1.5;
          margin: 5px 0;
        }

        .content p {
          font-size: 1rem;
          margin: 5px 0;
          line-height: 1.4;
        }

        .content a {
          text-decoration: none;
          cursor: pointer;
          color: var(--anchor-color) !important;
        }

        .content a:hover {
          text-decoration: underline;
        }

        .content blockquote {
          margin: 2px 0;
          padding: 5px 0;
          font-style: italic;
          background: var(--background);
          color: var(--text-color);
          font-weight: 400;
          line-height: 1.4;
        }

        .content blockquote p {
          margin: 0;
        }

        .content blockquote * {
          margin: 0;
        }

        .content hr {
          border: none;
          background-color: var(--text-color);
          height: 1px;
          margin: 10px 0;
        }

        .content code {
          background: var(--gray-background);
          padding: 0 5px;
          font-family: var(--font-mono);
          font-size: 0.9rem;
          border-radius: 5px;
        }

        .content b,
        .content strong {
          font-weight: 700;
          line-height: 1.4;

        }

        .content ul,
        .content ol {
          margin: 5px 0 15px 20px;
          padding: 0 0 0 15px;
          color: inherit;
          line-height: 1.4;
        }

        .content ul li,
        .content ol li {
          margin: 6px 0;
          padding: 0;
          color: inherit;
        }

        @media screen and (max-width: 660px) {
          :host {
            font-size: 16px;
            border-bottom: var(--border);
            font-family: var(--font-main), sans-serif;
            margin: 0;
            width: 100%;
            display: flex;
            flex-flow: column;
            gap: 0;
          }

          ::-webkit-scrollbar {
            -webkit-appearance: none;
          }

          #content,
          .content {
            cursor: unset;
          }

          .meta a.reply-link,
          .meta div.author-name > a,
          a,{
            cursor: default !important;
          }

          .content a {
            cursor: default !important;
          }

          a,
          span.stat,
          span.action,
          .content , #content,{
            cursor: default !important;
          }
        }
      </style>
    `;
    }
  }

  class StoryPost extends HTMLElement {
    constructor() {
      // We are not even going to touch this.
      super();

      this._data = this.getSummaryAndWords();

      // let's create our shadow root
      this.shadowObj = this.attachShadow({ mode: "open" });

      this.boundHandleWsMessage = this.handleWsMessage.bind(this);
      this.checkAndAddHandler = this.checkAndAddHandler.bind(this);

      this.render();
    }

    render() {
      this.shadowObj.innerHTML = this.getTemplate();
    }

    connectedCallback() {
      this.style.display = 'flex';

      // Check and add handler
      this.checkAndAddHandler();

      // get url
      let url = this.getAttribute('url');

      url = url.trim().toLowerCase();
   
      // Get the body
      const body = document.querySelector('body');

      // Open Full post
      this.openFullPost(url, body);

      this.openHighlights(body);

      // Open Url
      this.openUrl();
    }

    checkAndAddHandler() {
      if (window.wss) {
        window.wss.addMessageHandler(this.boundHandleWsMessage);
        // console.log('WebSocket handler added successfully');
      } else {
        // console.log('WebSocket manager not available, retrying...');
        setTimeout(this.checkAndAddHandler, 500); // Retry after 500ms
      }
    }

    disconnectedCallback() {
      if (window.wss) {
        window.wss.removeMessageHandler(this.boundHandleWsMessage);
      }
    }

    handleWsMessage = message => {
      // Handle the message in this component
      // console.log('Message received in component:', message);
      const data = message.data;

      if (message.type !== 'action') return;

      const user = data?.user;
      const userHash = window.hash;

      const author = this.shadowObj.querySelector('hover-author');

      const hash = this.getAttribute('hash').toUpperCase();
      const authorHash = this.getAttribute('author-hash').toUpperCase();

      const target = data.hashes.target;

      if (data.action === 'connect' && data.kind === 'user') {
        this.handleConnectAction(data, author, userHash, authorHash);
      } else if (target === hash) {
        if (data.action === 'like') {
          if(user !== null && user === userHash) {
            return;
          }
          // get likes parsed to number
          const likes = (this.parseToNumber(this.getAttribute('likes')) + data.value);
          // update likes
          this.setAttribute('likes', likes);
        } 
        else if(data.action === 'reply'){
          const replies = this.parseToNumber(this.getAttribute('replies')) + data.value;
          this.setAttribute('replies', replies);
        } 
        else if(data.action === 'view') {
          const views = this.parseToNumber(this.getAttribute('views')) + data.value;
          this.setAttribute('views', views);
        }
      }
    }

    handleConnectAction = (data, author, userHash, authorHash) => {
      const to = data.hashes.to;
      if(to === authorHash) {
        const followers = this.parseToNumber(this.getAttribute('author-followers')) + data.value;
        this.setAttribute('author-followers', followers);
        this.updateFollowers(author, this.getAttribute('author-followers'));

        if (data.hashes.from === userHash) {
          const value = data.value === 1 ? 'true' : 'false';
    
          // update user-follow/auth-follow attribute
          this.setAttribute('author-follow', value);
          author.setAttribute('user-follow', value);
        }

        author.setAttribute('reload', 'true');
      }
    }

    sendWsMessage(data) {
      window.wss.sendMessage(data);
    }

    updateFollowers = (element, value) => {
      element.setAttribute('followers', value);
    }

    getSummaryAndWords = () => {
      const mql = window.matchMedia('(max-width: 660px)');
      // get this content
      let content = this.innerHTML.toString();

      // remove all html tags and classes and extra spaces and tabs
      content = content.replace(/<[^>]*>/g, '').replace(/\s+/g, ' ').trim();

      let summary = content.substring(0, 500);

      if (mql.matches) {
        summary = content.substring(0, 250);
      }

      // return the summary: first 200 characters
      return {
        summary: `${summary}...`,
        words: content.split(' ').length
      };
    }

    openFullPost = (url, body) => {
      // get h3 > a.link
      const content = this.shadowObj.querySelector('div.content');

      const openFull = this.shadowObj.querySelector('.actions > .action.view');

      if(body && content && openFull) {
        content.addEventListener('click', event => {
          event.preventDefault();
          event.stopPropagation();

          // scroll to the top of the page
          window.scrollTo(0, 0);

          // Get full post
          const post =  this.getFullPost();
    
          // replace and push states
          this.replaceAndPushStates(url, body, post);

          body.innerHTML = post;
        });

        openFull.addEventListener('click', event => {
          event.preventDefault();
          event.stopPropagation();

          // scroll to the top of the page
          window.scrollTo(0, 0);

          // Get full post
          const post =  this.getFullPost();
    
          // replace and push states
          this.replaceAndPushStates(url, body, post);

          body.innerHTML = post;
        });
      }
    }

    replaceAndPushStates = (url, body, post) => {
      // get the first custom element in the body
      const firstElement = body.firstElementChild;

      // convert the custom element to a string
      const elementString = firstElement.outerHTML;
      // get window location
      const pageUrl = window.location.href;
      window.history.replaceState(
        { page: 'page', content: elementString },
        url, pageUrl
      );

      // Updating History State
      window.history.pushState(
        { page: 'page', content: post},
        url, url
      );
    }

    openHighlights = body => {
      // Get the stats action and subscribe action
      const statsBtn = this.shadowObj.querySelector('.actions > .action.stats');

      // add event listener to the stats action
      if (statsBtn) {
        statsBtn.addEventListener('click', e => {
          e.preventDefault();
          e.stopPropagation();

          // Open the highlights popup
          body.insertAdjacentHTML('beforeend', this.getHighlights());
        });
      }
    }

    disableScroll() {
      // Get the current page scroll position
      let scrollTop = window.scrollY || document.documentElement.scrollTop;
      let scrollLeft = window.scrollX || document.documentElement.scrollLeft;
      document.body.classList.add("stop-scrolling");

      // if any scroll is attempted, set this to the previous value
      window.onscroll = function () {
        window.scrollTo(scrollLeft, scrollTop);
      };
    }

    enableScroll() {
      document.body.classList.remove("stop-scrolling");
      window.onscroll = function () { };
    }

    formatNumber = n => {
      if (n >= 0 && n <= 999) {
        return n.toString();
      } else if (n >= 1000 && n <= 9999) {
        const value = (n / 1000).toFixed(2);
        return `${value}k`;
      } else if (n >= 10000 && n <= 99999) {
        const value = (n / 1000).toFixed(1);
        return `${value}k`;
      } else if (n >= 100000 && n <= 999999) {
        const value = (n / 1000).toFixed(0);
        return `${value}k`;
      } else if (n >= 1000000 && n <= 9999999) {
        const value = (n / 1000000).toFixed(2);
        return `${value}M`;
      } else if (n >= 10000000 && n <= 99999999) {
        const value = (n / 1000000).toFixed(1);
        return `${value}M`;
      } else if (n >= 100000000 && n <= 999999999) {
        const value = (n / 1000000).toFixed(0);
        return `${value}M`;
      } else if (n >= 1000000000) {
        return "1B+";
      }
      else {
        return 0;
      }
    }

    parseToNumber = num_str => {
      // Try parsing the string to an integer
      const num = parseInt(num_str);

      // Check if parsing was successful
      if (!isNaN(num)) {
        return num;
      } else {
        return 0;
      }
    }

    getLapseTime = isoDateStr => {
      const dateIso = new Date(isoDateStr); // ISO strings with timezone are automatically handled
      let userTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;

      // Convert posted time to the current timezone
      const date = new Date(dateIso.toLocaleString('en-US', { timeZone: userTimezone }));

      // Get the current time
      const currentTime = new Date();

      // Get the difference in time
      const timeDifference = currentTime - date;

      // Get the seconds
      const seconds = timeDifference / 1000;

      // Check if seconds is less than 60: return Just now
      if (seconds < 60) {
        return 'Just now';
      }
      // check if seconds is less than 86400: return time AM/PM
      if (seconds < 86400) {
        return date.toLocaleTimeString('en-US', { hour: 'numeric', minute: 'numeric', hour12: true });
      }

      // check if seconds is less than 604800: return day and time
      if (seconds <= 604800) {
        return date.toLocaleDateString('en-US', { weekday: 'short', hour: 'numeric', minute: 'numeric', hour12: true });
      }

      // Check if the date is in the current year:: return date and month short 2-digit year without time
      if (date.getFullYear() === currentTime.getFullYear()) {
        return date.toLocaleDateString('en-US', { day: 'numeric', month: 'short', });
      }
      else {
        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
      }
    }

    openUrl = () => {
      // get all the links
      const links = this.shadowObj.querySelectorAll('div#content a');
      const body = document.querySelector('body');

      // loop through the links
      if (!links) return;

      links.forEach(link => {
        // add event listener to the link
        link.addEventListener('click', event => {
          event.preventDefault();
          // get the url
          const url = link.getAttribute('href');

          // link pop up
          let linkPopUp = `<url-popup url="${url}"></url-popup>`;

          // open the popup
          body.insertAdjacentHTML('beforeend', linkPopUp);
        });
      });
    }

    getTemplate() {
      // Show HTML Here
      return `
      ${this.getBody()}
      ${this.getStyles()}
    `;
    }

    calculateReadTime = () => {
      // get the number of words
      const words = this._data.words;

      // calculate the read time
      const readTime = Math.ceil(words / 150);

      // return the read time
      return readTime;
    }

    getReadTime = () => {
      return /*html*/ `
      <span class="time">${this.getAttribute('read-time')}</span>
    `
    }

    getContent = () => {
      // get url
      let url = this.getAttribute('url');
      url = url.trim().toLowerCase();
      return /*html*/`
      <div class="content" id="content">
        <h3 class="title">
          <a href="${url}" class="link">${this.getAttribute('story-title')}</a>
        </h3>
        ${this.getSummery()}
      </div>
		`;
    }

    getImages = () => {
      const imagesText = this.getAttribute('images');
      const text = this.innerHTML.toString();

      const images = this.allImages(imagesText, text);

      // if length is greater is less than 1
      if(images.length < 1) return '';

      // return
      return /* html */`
      <images-wrapper images="${images}"></images-wrapper>
    `
    }

    allImages = (imgs, text) => {
      let images = this.getImagesArray(imgs);

      // find images in the text
      const textImages = this.findImages(text);

      // if images is null return images; else concat the images
      if (!textImages) {
        return images;
      } else {
        // push the text images to the images array
        images.push(...textImages);

        // return filtered images, remove empty strings, and less than 5 in length, and return the images
        return images.filter(img => img.length > 5); 
      }
    }

    findImages = text => {
      // Updated regex to handle various attributes and nested tags
      const imgRegex = /<img\s+(?:[^>]*?\s+)?src\s*=\s*(["'])(.*?)\1/gi;
      const matches = [];
      let match;
    
      // Loop through all matches
      while ((match = imgRegex.exec(text)) !== null) {
        matches.push(match[2]);  // match[2] contains the URL
      }
    
      // Return array of src values or null if no matches found
      return matches.length > 0 ? matches : null;
    }
    
    getImagesArray = images => {
      // if images is null return an empty array
      if (!images) return [];

      // split the images by comma, filter out empty strings, less than in length, and return the images
      return images.split(',').filter(img => img.length > 5);
    }

    getSummery = () => {
      const summary = this._data.summary;

      return /*html*/`
      <div class="summary extra" id="summary">
        <p>${summary}</p>
        <div class="read-more">
        </div>
      </div>
    `
    }

    getHeader = () => {
      return /*html*/`
      <div class="meta top-meta">
        <span class="by">by</span>
        ${this.getAuthorHover()}
        <span class="sp">•</span>
        <time class="time" datetime="${this.getAttribute('time')}">
          ${this.getLapseTime(this.getAttribute('time'))}
        </time>
      </div>
    `
    }

    getBody() {
      return `
      ${this.getHeader()}
      ${this.getContent()}
      ${this.getImages()}
      ${this.getActions()}
    `;
    }

    getActions = () => {
      const views = this.parseToNumber(this.getAttribute('views'));
      return /*html*/`
      <div class="actions">
        <a href="${this.getAttribute('url')}" class="action view" id="view-action">view</a>
        <span class="action stats" id="close-stats">stats</span>
        <span class="action read plain">
          <span class="no">${this.calculateReadTime()}</span> <span class="text">min read</span>
        </span>
        <span class="action views plain">
          <span class="no">${this.formatNumber(views)}</span> <span class="text">views</span>
        </span>
      </div>
    `
    }

    getCover = () => {
      const images = this.getAttribute('images');
      if (images && images !== 'null') {
        return images.split(',')[0];
      } else {
        return this.findFirstImageSrc(this.innerHTML)
      }
    }

    findFirstImageSrc = text => {
      const imgRegex = /<img[^>]+src\s*=\s*['"]([^'"]+)['"][^>]*>/i;
      const match = text.match(imgRegex);
      return match ? match[1] : null;
    }

    getAuthorHover = () => {
      let url = this.getAttribute('author-url');
      url = url.trim().toLowerCase();
      let bio = this.getAttribute('author-bio') || 'This author has not provided a bio yet.';
      // replace all " and ' with &quot; and &apos; to avoid breaking the html
      bio = bio.replace(/"/g, '&quot;').replace(/'/g, '&apos;');
      return /* html */`
			<hover-author url="${url}" you="${this.getAttribute('author-you')}" hash="${this.getAttribute('author-hash')}"
        picture="${this.getAttribute('author-img')}" name="${this.getAttribute('author-name')}" contact='${this.getAttribute("author-contact")}'
        stories="${this.getAttribute('author-stories')}" replies="${this.getAttribute('author-replies')}"
        followers="${this.getAttribute('author-followers')}" following="${this.getAttribute('author-following')}" user-follow="${this.getAttribute('author-follow')}"
        verified="${this.getAttribute('author-verified')}" bio="${bio}">
      </hover-author>
		`
    }

    getFullPost = () => {
      const images = this.getAttribute('images');
      return /* html */`
      <app-story view="true" story="story" tab="replies" hash="${this.getAttribute('hash')}"  url="${this.getAttribute('url')}" topics="${this.getAttribute('topics')}" 
        story-title="${this.getAttribute('story-title')}" time="${this.getAttribute('time')}" images='${images}'
        replies-url="${this.getAttribute('replies-url')}" likes-url="${this.getAttribute('likes-url')}"
        likes="${this.getAttribute('likes')}" replies="${this.getAttribute('replies')}" liked="${this.getAttribute('liked')}" views="${this.getAttribute('views')}"
        author-you="${this.getAttribute('author-you')}"
        author-stories="${this.getAttribute('author-stories')}" author-replies="${this.getAttribute('author-replies')}"
        author-hash="${this.getAttribute('author-hash')}" author-url="${this.getAttribute('author-url')}" author-contact='${this.getAttribute("author-contact")}'
        author-img="${this.getAttribute('author-img')}" author-verified="${this.getAttribute('author-verified')}" author-name="${this.getAttribute('author-name')}"
        author-followers="${this.getAttribute('author-followers')}" author-following="${this.getAttribute('author-following')}" author-follow="${this.getAttribute('author-follow')}"
        author-bio="${this.getAttribute('author-bio')}">
        ${this.innerHTML}
      </app-story>
    `
    }

    getHTML = () => {
      const text = this.innerHTML;
      const parser = new DOMParser();
      const doc = parser.parseFromString(text, 'text/html');
      return doc.body.innerHTML;
    }

    getHighlights = () => {
      return /* html */`
      <views-popup name="post"likes="${this.getAttribute('likes')}" liked="${this.getAttribute('liked')}" views="${this.getAttribute('views')}"
        replies="${this.getAttribute('replies')}">
      </views-popup>
    `
    }

    getStyles() {
      return /* css */`
      <style>
        *,
        *:after,
        *:before {
          box-sizing: border-box !important;
          font-family: inherit;
          -webkit-box-sizing: border-box !important;
        }

        *:focus {
          outline: inherit !important;
        }

        *::-webkit-scrollbar {
          -webkit-appearance: none;
        }

        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
          padding: 0;
          margin: 0;
          font-family: inherit;
        }

        p,
        ul,
        ol {
          padding: 0;
          margin: 0;
        }

        a {
          text-decoration: none;
        }


        :host {
          font-size: 16px;
          border-bottom: var(--border);
          font-family: var(--font-main), sans-serif;
          padding: 10px 0 10px;
          margin: 0;
          width: 100%;
          display: flex;
          flex-flow: column;
          gap: 0;
        }

        .read-time {
          color: var(--gray-color);
          font-size: 0.95rem;
          font-family: var(--font-main), sans-serif;
          display: flex;
          align-items: center;
          gap: 8px;
          padding: 8px 0 0 0;
        }

        .read-time > a.read-full {
          text-decoration: none;
          color: var(--gray-color);
          font-family: var(--font-main),sans-serif;
          border: var(--border);
          font-weight: 500;
          padding: 2.5px 5px 3px 12px;
          border-radius: 10px;
          font-size: 0.93rem;
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 2px;
        }

        .read-time .text .time {
          font-family: var(--font-main), sans-serif;
        }

        .read-time .views {
          font-weight: 500;
        }

        .read-time .views .views-no {
          font-family: var(--font-main), sans-serif;
          font-size: 0.8rem;
        }

        .read-time > span.sp {
          display: inline-block;
          margin: 0 0 -2px;
        }

        .content {
          display: flex;
          position: relative;
          cursor: pointer;
          flex-flow: column;
          font-family: var(--font-main), sans-serif;
          color: var(--text-color);
          line-height: 1.4;
          gap: 0;
          margin: 0;
          padding: 0;
        }

        .content .read-more {
          position: absolute;
          bottom: -5px;
          right: 0;
          left: 0;
          width: 100%;
          padding: 5px 0;
          display: flex;
          align-items: end;
          justify-content: center;
          min-height: 60px;
          gap: 3px;
          cursor: pointer;
          font-weight: 500;
          font-family: var(--font-text), sans-serif;
          color: var(--gray-color);
          background: var(--fade-linear-gradient);
        }

        .content .read-more svg {
          display: inline-block;
          width: 16px;
          height: 16px;
          margin: 0 0 2px 0;
        }

        .content p {
          margin: 0 0 5px 0;
          font-size: 1rem;
          padding: 0;
          line-height: 1.4;
          font-family: var(--font-text), sans-serif;
        }

        .content p:last-of-type {
          margin: 0;
        }

        h3.title {
          color: var(--title-color);
          font-family: var(--font-main), sans-serif;
          margin: 2px 0 7px 0;
          padding: 0;
          font-size: 1.1rem;
          font-weight: 600;
          line-height: 1.2;
        }

        h3.title > a {
          text-decoration: none;
          color: inherit;
        }

        .meta {
          height: max-content;
          display: flex;
          position: relative;
          color: var(--gray-color);
          align-items: center;
          font-family: var(--font-mono),monospace;
          gap: 5px;
          font-size: 0.9rem;
          line-height: 1.5;
        }

        .meta > span.sp {
          margin: 1px 0 0 0;
        }

        .meta > span.by {
          font-weight: 500;
          font-size: 0.95rem;
          margin: 0 0 1px 0;
        }

        .meta > time.time {
          font-family: var(--font-text), sans-serif;
          font-size: 0.83rem;
          font-weight: 500;
          margin: 1px 0 0 0;
        }

        .meta a.link {
          text-decoration: none;
          color: transparent;
          background-image: var(--action-linear);
          background-clip: text;
          -webkit-background-clip: text;
        }

        .meta  a.author-link {
          text-decoration: none;
          color: transparent;
          background: var(--accent-linear);
          background-clip: text;
          -webkit-background-clip: text;
        }

        .actions {
          display: flex;
          font-family: var(--font-main), sans-serif;
          width: 100%;
          flex-flow: row;
          align-items: center;
          gap: 15px;
          margin: 5px 0 3px;
        }
        
        .actions > .action {
          border: var(--border-button);
          text-decoration: none;
          color: var(--gray-color);
          font-size: 0.95rem;
          display: flex;
          width: max-content;
          flex-flow: row;
          align-items: center;
          text-transform: lowercase;
          justify-content: center;
          padding: 2.5px 10px 2.5px;
          border-radius: 10px;
          -webkit-border-radius: 10px;
          -moz-border-radius: 10px;
        }

        .actions > .action.stats {
          cursor: pointer;
        }

        .actions > .action.plain {
          padding: 0;
          font-weight: 500;
          pointer-events: none;
          font-family: var(--font-text), sans-serif;
          color: var(--gray-color);
          border: none;
          background: none;
        }
        
        .actions > .action.plain > span.no {
          font-family: var(--font-main), sans-serif;
          font-size: 0.9rem;
          color: var(--text-color);
        }

        .actions > .action.plain > span.text {
          display: inline-block;
          padding: 0 0 0 3px;
        }

        @media screen and (max-width:660px) {
          :host {
            font-size: 16px;
            border-bottom: var(--border);
          }

          ::-webkit-scrollbar {
            -webkit-appearance: none;
          }

          .meta a.reply-link,
          .meta div.author-name > a,
          a,
          .content .read-more,
          .content,
          .stats > .stat {
            cursor: default !important;
          }

          .read-time > a.read-full {
            border: var(--border-mobile);
          }
    
          h3.title {
            font-weight: 600;
            line-height: 1.2;
          }

          h3.title > a {
            text-decoration: none;
            color: inherit;
          }

          .actions > .action,
          a {
            cursor: default !important;
          }
        }
      </style>
    `;
    }
  }

  class PreviewPost extends HTMLElement {
    constructor() {
      // We are not even going to touch this.
      super();

      this._url = this.getAttribute('url');

      this._story = null;
      this._reply = null;
      this._item = '';

      // let's create our shadow root
      this.shadowObj = this.attachShadow({mode: 'open'});

      this.render();
    }

    render() {
      this.shadowObj.innerHTML = this.getTemplate();
    }

    connectedCallback() {
      const contentContainer = this.shadowObj.querySelector('div.preview');

      // Close the modal
      if (contentContainer) {
        this.activateBtn(contentContainer);
        this.activateFetchPreview(contentContainer);
      }
    }

    activateFetchPreview = contentContainer => {
      this.fetchPreview(contentContainer);
    }

    activateBtn = contentContainer => {
      const btn = this.shadowObj.querySelector('button.fetch');

      if (btn && contentContainer) {
        btn.addEventListener('click', event => {
          event.preventDefault();
          this.fetchPreview(contentContainer);
        });
      }
    }

    activateCloseBtn = contentContainer => {
      const outerThis = this;
      const closeBtn = this.shadowObj.querySelector('.action.close');

      if (closeBtn && contentContainer) {
        closeBtn.addEventListener('click', event => {
          event.preventDefault();
          contentContainer.innerHTML = /*html*/`<button class="fetch">Preview</button>`;

          // activate the button
          outerThis.activateBtn(contentContainer);
        });
      }
    }

    fetchPreview = contentContainer => {
      const outerThis = this;
      // Add the loader
      contentContainer.innerHTML = this.getLoader();
  		const previewLoader = this.shadowObj.querySelector('#loader-container');

      // Check if reply or story is already fetched
      if (this._story || this._reply) {
        // remove the loader
        previewLoader.remove();

        if(this._story) {
          // set this._item
          this._item = this.mapStory(this._story);

          // switch kind of story
          switch(this._story.kind) {
            case 'post':
              contentContainer.innerHTML = outerThis.populatePost(this._story);
              break;
            case 'poll':
              contentContainer.innerHTML = outerThis.populatePoll(this._story);
              break;
            case 'story':
              contentContainer.innerHTML = outerThis.populateStory(this._story);
              break;
          }
        } else {
          // set this._item
          this._item = this.mapReply(this._reply);
          contentContainer.innerHTML = outerThis.populateReply(this._reply);
        }

        // activate the close button
        outerThis.activateCloseBtn(contentContainer);

        // open the story
        this.openStory();

        // open the read more
        this.openReadMore();
        // open the url
        this.openUrl();
        // style lastBlock
        this.styleLastBlock();
        return;
      }

  		setTimeout(async () => {
        // fetch the user stats
        const options = {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json',
            // Set cookie age to 2 hours
            'Cache-Control': 'public, max-age=7200'
          }
        };

        try {
          const result = await this.getCacheData(this._url, 7200, options);

          // check if not successful
          if (!result.success) {
            // display error message
            const content = outerThis.getEmpty();
            previewLoader.remove();
            contentContainer.innerHTML = content;;

            // activate close button
            outerThis.activateCloseBtn(contentContainer);

            // activate the button
            outerThis.activateBtn(contentContainer);

            return;
          }

          // check if story
          if (result.story) {
            const story = result.story;
            outerThis._story = story;

            // set this._item
            this._item = this.mapStory(story);

            // remove the loader
            previewLoader.remove();

            // switch kind of story
            switch(story.kind) {
              case 'post':
                contentContainer.innerHTML = outerThis.populatePost(story);
                break;
              case 'poll':
                contentContainer.innerHTML = outerThis.populatePoll(story);
                break;
              case 'story':
                contentContainer.innerHTML = outerThis.populateStory(story);
                break;
            }

            // activate the close button
            outerThis.activateCloseBtn(contentContainer);

            // open the story
            this.openStory();

            // open the read more
            this.openReadMore();
            // open the url
            this.openUrl();

            // style lastBlock
            this.styleLastBlock();
          }
          else if (result.reply) {
            const reply = result.reply;
            outerThis._reply = reply;

            // set this._item
            this._item = this.mapReply(reply);
            
            // remove the loader
            previewLoader.remove();

            // insert the content
            contentContainer.innerHTML = outerThis.populateReply(reply);

            // activate the close button
            outerThis.activateCloseBtn(contentContainer);

            // open the story
            this.openStory();

            // open the read more
            this.openReadMore();
            // open the url
            this.openUrl();
            // style lastBlock
            this.styleLastBlock();
          }
          else {
            // display error message
            const content = outerThis.getEmpty();
            previewLoader.remove();
            contentContainer.innerHTML = content;;

            // activate close button
            outerThis.activateCloseBtn(contentContainer);

            // activate the button
            outerThis.activateBtn(contentContainer);
          }
        } catch (error) {
          // display error message
          const content = outerThis.getEmpty();
          previewLoader.remove();
          contentContainer.innerHTML = content;
          // activate close button
          outerThis.activateCloseBtn(contentContainer);

          // activate the button
          outerThis.activateBtn(contentContainer);
        }
  		}, 100);
  	}

    fetchWithTimeout = async (url, options = {}, timeout = 9500) => {
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), timeout);
    
      try {
        const response = await fetch(url, {
          ...options,
          signal: controller.signal
        });

        return response;
      } catch (error) {
        if (error.name === 'AbortError') {
          throw new Error('Request timed out');
        }
        throw new Error(`Network error: ${error.message}`);
      } finally {
        clearTimeout(timeoutId);
      }
    }

    getCacheData = async (url, maxAge, options = {}) => {
      const cacheName = "user-cache";
    
      try {
        const cache = await caches.open(cacheName);
        const cachedResponse = await cache.match(url);
    
        if (cachedResponse) {
          const cachedData = await cachedResponse.json();
          const cacheTime = cachedData.timestamp;
    
          // Check if cache is still valid
          if (Date.now() - cacheTime < maxAge) {
            return cachedData.data;
          }
        }
    
        // If cache doesn't exist or is expired, fetch new data
        const networkResponse = await this.fetchWithTimeout(url, options);
        const data = await networkResponse.clone().json();
    
        // Store the new data in cache with a timestamp
        const cacheData = {
          data: data,
          timestamp: Date.now()
        };
        
        const cacheResponse = new Response(JSON.stringify(cacheData));
        await cache.put(url, cacheResponse);
    
        return data;
      } catch (error) {
        throw error;
      }
    }

    populateStory = story => {
      const author = story.story_author;
      author.you = story.you;
      author.time = story.createdAt;
      const url = `/p/${story.hash.toLowerCase()}`;
      const itemContent = this.removeHtml(story.content, story.title);
      return this.getContent(itemContent, url, story.views, story.likes, author);
    }

    populateReply = reply => {
      const author = reply.reply_author;
      author.you = reply.you;
      author.time = reply.createdAt;
      const url = `/r/${reply.hash.toLowerCase()}`;
      const itemContent = this.getPost(reply.content);
      return this.getContent(itemContent, url, reply.views, reply.likes, author);
    }

    populatePost = story => {
      const author = story.story_author;
      author.you = story.you;
      author.time = story.createdAt;
      const url = `/p/${story.hash.toLowerCase()}`;
      const itemContent = this.getPost(story.content);
      return this.getContent(itemContent, url, story.views, story.likes, author);
    }

    populatePoll = story => {
      const author =story.story_author;
      author.you = story.you;
      author.time = story.createdAt;
      const poll = { 
        hash: story.hash,
        votes: story.votes,
        selected: story.option,
        end: story.end,
        voted: story.option ? 'true' : 'false',
        options: story.poll,
        content: story.content
      };
      const pollContent = this.getPoll(poll);
      const url =`/p/${story.hash.toLowerCase()}`;
      return this.getContent(pollContent, url, story.views, story.likes, author);
    }

    getPoll = poll =>  {
      const mql = window.matchMedia('(max-width: 660px)');
      // Remove html tags
      const contentStr = poll.content.replace(/<[^>]*>/g, '');
      const contentLength = contentStr.length;

      let chars = 250;

      // Check if its a mobile view
      if (mql.matches) {
        chars = 200;
      }

      // Check if content length is greater than :chars
      if (contentLength > chars) {
        return /*html*/`
        <div class="content extra ${chars <= 200 ? 'mobile' : ''}" id="content">
          ${poll.content}
          <div class="read-more">
            <span class="action">view more</span>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" fill="currentColor">
              <path d="M12.78 5.22a.749.749 0 0 1 0 1.06l-4.25 4.25a.749.749 0 0 1-1.06 0L3.22 6.28a.749.749 0 1 1 1.06-1.06L8 8.939l3.72-3.719a.749.749 0 0 1 1.06 0Z"></path>
            </svg>
          </div>
        </div>
        <votes-wrapper reload="false" votes="${poll.votes}" selected="${poll.selected}"
          hash="${poll.hash}"
          end-time="${poll.end}" voted="${poll.voted}" options="${poll.options}">
        </votes-wrapper>
      `
      }
      else {
        return /*html*/`
        <div class="content" id="content">
          ${poll.content}
        </div>
        <votes-wrapper reload="false" votes="${poll.votes}" selected="${poll.selected}"
          hash="${poll.hash}"
          end-time="${poll.end}" voted="${poll.voted}" options="${poll.options}">
        </votes-wrapper>
      `
      }
    }

    removeHtml = (text, title)=> {
      let str = text.replace(/<[^>]*>/g, '');

      str = str.trim();
      const filteredTitle = title ? `<h3>${title}</h3>` : '';
      const content = `<p>${this.trimContent(str)}</p>`;

      return `
      ${filteredTitle}
      ${content}
    `
    }

    trimContent = text => {
      // if text is less than 150 characters
      if (text.length <= 200) return text;


      // check for mobile view
      const mql = window.matchMedia('(max-width: 660px)');

      // Check if its a mobile view
      if (mql.matches) {
        // return text substring: 150 characters + ...
        return text.substring(0, 200) + '...';
      } else {
        // trim the text to 250 characters
        return text.substring(0, 300) + '...';
      }
    }

    getPost = content => {
      const mql = window.matchMedia('(max-width: 660px)');
      // Remove html tags
      const contentStr = content.replace(/<[^>]*>/g, '');
      const contentLength = contentStr.length;

      let chars = 250;

      // Check if its a mobile view
      if (mql.matches) {
        chars = 200;
      }

      // Check if content length is greater than: chars
      if (contentLength > chars) {
        return /*html*/`
        <div class="content extra ${chars <= 200 ? 'feed' : ''}" id="content">
          ${content}
          <div class="read-more">
            <span class="action">view more</span>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" fill="currentColor">
              <path d="M12.78 5.22a.749.749 0 0 1 0 1.06l-4.25 4.25a.749.749 0 0 1-1.06 0L3.22 6.28a.749.749 0 1 1 1.06-1.06L8 8.939l3.72-3.719a.749.749 0 0 1 1.06 0Z"></path>
            </svg>
          </div>
        </div>
      `
      }
      else {
        return /*html*/`
        <div class="content" id="content">
          ${content}
        </div>
      `
      }
    }

    getHTML = () => {
      const text = this.innerHTML;
      const parser = new DOMParser();
      const doc = parser.parseFromString(text, 'text/html');
      return doc.body.innerHTML;
    }

    openReadMore = () => {
      // Get the read more button
      const readMore = this.shadowObj.querySelector('.content .read-more');

      // Get the content
      const content = this.shadowObj.querySelector('.content');

      // Check if the read more button exists
      if (readMore && content) {
        readMore.addEventListener('click', e => {
          // prevent the default action
          e.preventDefault();

          // prevent the propagation of the event
          e.stopPropagation();

          // Prevent event from reaching any immediate nodes.
          e.stopImmediatePropagation();

          // Toggle the active class
          content.classList.remove('extra');

          // remove the read more button
          readMore.remove();
        });
      }
    }

    openUrl = () => {
      // get all the links
      const links = this.shadowObj.querySelectorAll('div#content a');
      const body = document.querySelector('body');

      // loop through the links
      if (!links) return;

      links.forEach(link => {
        // add event listener to the link
        link.addEventListener('click', event => {
          event.preventDefault();
          event.stopPropagation();
          event.stopImmediatePropagation();
          // get the url
          const url = link.getAttribute('href');

          // link pop up
          let linkPopUp = `<url-popup url="${url}"></url-popup>`;

          // open the popup
          body.insertAdjacentHTML('beforeend', linkPopUp);
        });
      });
    }

    openStory = () => {
      // Get the body
      const body = document.querySelector('body');

      // get current content
      const content = this.shadowObj.querySelector('.actions > .action#view-action');

      if(body && content) {
        content.addEventListener('click', event => {
          event.preventDefault();

          let url = content.getAttribute('href');

          // Get full post
          const post =  this._item;
    
          // replace and push states
          this.replaceAndPushStates(url, body, post);

          body.innerHTML = post;
        });
      }
    }

    replaceAndPushStates = (url, body, post) => {
      // get the first custom element in the body
      const firstElement = body.firstElementChild;

      // convert the custom element to a string
      const elementString = firstElement.outerHTML;

      // Replace the content with the current url and body content
      // get window location
      const pageUrl = window.location.href;
      window.history.replaceState(
        { page: 'page', content: elementString },
        url, pageUrl
      );

      // Updating History State
      window.history.pushState(
        { page: 'page', content: post},
        url, url
      );
    }

    mapStory = story => {
      const author = story.story_author;
      const url = `/p/${story.hash.toLowerCase()}`;
      const images = story.images ? story.images.join(',') : null;
      if (story.kind === "post") {
        return /*html*/`
        <app-post story="quick" tab="replies" url="${url}" hash="${story.hash}" likes="${story.likes}" replies="${story.replies}" 
          replies-url="/api/v1${url}/replies" likes-url="/api/v1${url}/likes" images='${images}'
          views="${story.views}"  time="${story.createdAt}" liked="${story.liked ? 'true' : 'false'}" 
          author-url="/u/${author.hash}" author-stories="${author.stories}" author-replies="${author.replies}"
          author-hash="${author.hash}" author-you="${story.you ? 'true' : 'false'}" author-img="${author.picture}" 
          author-verified="${author.verified ? 'true' : 'false'}" author-name="${author.name}" author-followers="${author.followers}" 
          author-following="${author.following}" author-follow="${author.is_following ? 'true' : 'false'}" author-contact='${author.contact ? JSON.stringify(author.contact) : null}'
          author-bio="${author.bio === null ? 'This user has not added a bio yet.' : author.bio}">
          ${story.content}
        </app-post>
      `
      }
      else if (story.kind === "poll") {
        return /*html*/`
        <app-post story="poll" tab="replies" url="${url}" hash="${story.hash}" likes="${story.likes}"
          replies="${story.replies}" liked="${story.liked ? 'true' : 'false'}" views="${story.views}" time="${story.createdAt}"
          replies-url="/api/v1${url}/replies" likes-url="/api/v1${url}/likes" options='${story.poll}' voted="${story.option ? 'true' : 'false'}" 
          selected="${story.option}" end-time="${story.end}" votes="${story.votes}" 
          author-url="/u/${author.hash}" author-stories="${author.stories}" author-replies="${author.replies}"
          author-hash="${author.hash}" author-you="${story.you ? 'true' : 'false'}" author-img="${author.picture}" 
          author-verified="${author.verified ? 'true' : 'false'}" author-name="${author.name}" author-followers="${author.followers}" 
          author-following="${author.following}" author-follow="${author.is_following ? 'true' : 'false'}" author-contact='${author.contact ? JSON.stringify(author.contact) : null}' 
          author-bio="${author.bio === null ? 'This user has not added a bio yet.' : author.bio}">
          ${story.content}
        </app-post>
      `
      }
      else if (story.kind === "story") {
        return /*html*/`
        <app-story story="story" hash="${story.hash}" url="${url}" tab="replies" topics="${story.topics.length === 0 ? 'story' : story.topics}" 
          story-title="${story.title}" time="${story.createdAt}" replies-url="/api/v1${url}/replies" images='${images}'
          likes-url="/api/v1${url}/likes" likes="${story.likes}" replies="${story.replies}" liked="${story.liked ? 'true' : 'false'}" views="${story.views}" 
          author-url="/u/${author.hash}" author-stories="${author.stories}" author-replies="${author.replies}"
          author-hash="${author.hash}" author-you="${story.you ? 'true' : 'false'}" author-contact='${author.contact ? JSON.stringify(author.contact) : null}' 
          author-img="${author.picture}" author-verified="${author.verified ? 'true' : 'false'}" author-name="${author.name}" 
          author-followers="${author.followers}" author-following="${author.following}" author-follow="${author.is_following ? 'true' : 'false'}" 
          author-bio="${author.bio === null ? 'This user has not added a bio yet.' : author.bio}">
          ${story.content}
        </app-story>
      `
      }
    }

    mapReply = reply => {
      const author = reply.reply_author;
      const images = reply.images ? reply.images.join(',') : null;
      return /*html*/`
      <app-post story="reply" tab="replies" hash="${reply.hash}" url="/r/${reply.hash.toLowerCase()}" likes="${reply.likes}" liked="${reply.liked}"
        replies="${reply.replies}" views="${reply.views}" time="${reply.createdAt}" replies-url="/api/v1/r/${reply.hash}/replies" 
        parent="${reply.story ? reply.story : reply.reply}" preview="full" likes-url="/api/v1/r/${reply.hash}/likes" images='${images}'
        author-url="/u/${author.hash}" author-hash="${author.hash}" author-you="${reply.you}" author-stories="${author.stories}" 
        author-replies="${author.replies}" author-img="${author.picture}" author-verified="${author.verified}" author-contact='${author.contact ? JSON.stringify(author.contact) : null}'
        author-name="${author.name}" author-followers="${author.followers}" author-following="${author.following}" 
        author-follow="${author.is_following}" author-bio="${author.bio === null ? 'The author has no bio yet!' : author.bio}">
        ${reply.content}
      </app-post>
    `
    }

    formatNumber = n => {
      if (n >= 0 && n <= 999) {
        return n.toString();
      } else if (n >= 1000 && n <= 9999) {
        const value = (n / 1000).toFixed(2);
        return `${value}k`;
      } else if (n >= 10000 && n <= 99999) {
        const value = (n / 1000).toFixed(1);
        return `${value}k`;
      } else if (n >= 100000 && n <= 999999) {
        const value = (n / 1000).toFixed(0);
        return `${value}k`;
      } else if (n >= 1000000 && n <= 9999999) {
        const value = (n / 1000000).toFixed(2);
        return `${value}M`;
      } else if (n >= 10000000 && n <= 99999999) {
        const value = (n / 1000000).toFixed(1);
        return `${value}M`;
      } else if (n >= 100000000 && n <= 999999999) {
        const value = (n / 1000000).toFixed(0);
        return `${value}M`;
      } else if (n >= 1000000000) {
        return "1B+";
      }
      else {
        return 0;
      }
    }

    parseToNumber = str => {
      // Try parsing the string to an integer
      const num = parseInt(str);

      // Check if parsing was successful
      if (!isNaN(num)) {
        return num;
      } else {
        return 0;
      }
    }

    disableScroll() {
      // Get the current page scroll position
      let scrollTop = window.scrollY || document.documentElement.scrollTop;
      let scrollLeft = window.scrollX || document.documentElement.scrollLeft;
      document.body.classList.add("stop-scrolling");

      // if any scroll is attempted, set this to the previous value
      window.onscroll = function() {
        window.scrollTo(scrollLeft, scrollTop);
      };
    }

    enableScroll() {
      document.body.classList.remove("stop-scrolling");
      window.onscroll = function() {};
    }

    // style the last paragraph or the last block element in content
    styleLastBlock = () => {
      const content = this.shadowObj.querySelector('.content#content');
      if (!content) return;

      const lastBlock = content.lastElementChild;
      if (!lastBlock) return;

      // style the last block
      lastBlock.style.setProperty('padding', '0 0 0');
      lastBlock.style.setProperty('margin', '0 0 0');
    }

    getTemplate() {
      const className = this.getClass(this.getAttribute('preview'));
      // const parent = this.getAttribute('hash');
      const kind = this.getAttribute('preview');
      // Show HTML Here
      return /*html*/`
      <div class="welcome">
        ${this.getReplyingTo(kind)}
        <div class="preview ${className}">
          <button class="fetch">Preview</button>
        </div>
      </div>
      ${this.getStyles()}
    `
    }

    getReplyingTo = kind => {
      if (kind === 'full') {
        return /*html*/`
        <div class="replying-to">
          <span class="meta-reply">
            <span class="text">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512" width="16px" height="16px" fill="currentColor">
                <path d="M88.2 309.1c9.8-18.3 6.8-40.8-7.5-55.8C59.4 230.9 48 204 48 176c0-63.5 63.8-128 160-128s160 64.5 160 128s-63.8 128-160 128c-13.1 0-25.8-1.3-37.8-3.6c-10.4-2-21.2-.6-30.7 4.2c-4.1 2.1-8.3 4.1-12.6 6c-16 7.2-32.9 13.5-49.9 18c2.8-4.6 5.4-9.1 7.9-13.6c1.1-1.9 2.2-3.9 3.2-5.9zM0 176c0 41.8 17.2 80.1 45.9 110.3c-.9 1.7-1.9 3.5-2.8 5.1c-10.3 18.4-22.3 36.5-36.6 52.1c-6.6 7-8.3 17.2-4.6 25.9C5.8 378.3 14.4 384 24 384c43 0 86.5-13.3 122.7-29.7c4.8-2.2 9.6-4.5 14.2-6.8c15.1 3 30.9 4.5 47.1 4.5c114.9 0 208-78.8 208-176S322.9 0 208 0S0 78.8 0 176zM432 480c16.2 0 31.9-1.6 47.1-4.5c4.6 2.3 9.4 4.6 14.2 6.8C529.5 498.7 573 512 616 512c9.6 0 18.2-5.7 22-14.5c3.8-8.8 2-19-4.6-25.9c-14.2-15.6-26.2-33.7-36.6-52.1c-.9-1.7-1.9-3.4-2.8-5.1C622.8 384.1 640 345.8 640 304c0-94.4-87.9-171.5-198.2-175.8c4.1 15.2 6.2 31.2 6.2 47.8l0 .6c87.2 6.7 144 67.5 144 127.4c0 28-11.4 54.9-32.7 77.2c-14.3 15-17.3 37.6-7.5 55.8c1.1 2 2.2 4 3.2 5.9c2.5 4.5 5.2 9 7.9 13.6c-17-4.5-33.9-10.7-49.9-18c-4.3-1.9-8.5-3.9-12.6-6c-9.5-4.8-20.3-6.2-30.7-4.2c-12.1 2.4-24.7 3.6-37.8 3.6c-61.7 0-110-26.5-136.8-62.3c-16 5.4-32.8 9.4-50 11.8C279 439.8 350 480 432 480z"/>
              </svg>
              <span class="reply">Replying to</span>
            </span>
          </span>
        </div>
      `
      } else return '';
    }

    getLapseTime = isoDateStr => {
      const dateIso = new Date(isoDateStr); // ISO strings with timezone are automatically handled
      let userTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;

      // Convert posted time to the current timezone
      const date = new Date(dateIso.toLocaleString('en-US', { timeZone: userTimezone }));

      // Get the current time
      const currentTime = new Date();

      // Get the difference in time
      const timeDifference = currentTime - date;

      // Get the seconds
      const seconds = timeDifference / 1000;

      // Check if seconds is less than 60: return Just now
      if (seconds < 60) {
        return 'Just now';
      }
      // check if seconds is less than 86400: return time AM/PM
      if (seconds < 86400) {
        return date.toLocaleTimeString('en-US', { hour: 'numeric', minute: 'numeric', hour12: true });
      }

      // check if seconds is less than 604800: return day and time
      if (seconds <= 604800) {
        return date.toLocaleDateString('en-US', { weekday: 'short', hour: 'numeric', minute: 'numeric', hour12: true });
      }

      // Check if the date is in the current year:: return date and month short 2-digit year without time
      if (date.getFullYear() === currentTime.getFullYear()) {
        return date.toLocaleDateString('en-US', { day: 'numeric', month: 'short', });
      }
      else {
        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
      }
    }

    getContent = (content, url, views, likes, author) => {
      return /*html*/`
      <p>${content}</p>
      ${this.getImages(this._story ? this._story.images : this._reply.images)}
      <span class="meta">
        <span class="by">by</span>
        ${this.getAuthorHover(author)}
        <span class="sp">•</span>
        <time class="time" datetime="${author.time}">
          ${this.getLapseTime(author.time)}
        </time>
      </span>
      ${this.getActions(likes, views, url)}
    `
    }

    getActions = (likes, views, url) => {
      return /*html*/`
      <div class="actions">
        <a href="${url}" class="action view" id="view-action">view</a>
        <span class="action close" id="close-action">close</span>
        <span class="action likes plain">
          <span class="no">${this.formatNumber(likes)}</span> <span class="text">likes</span>
        </span>
        <span class="action views plain">
          <span class="no">${this.formatNumber(views)}</span> <span class="text">views</span>
        </span>
      </div>
    `
    }

    getEmpty = () => {
      return /* html */`
      <div class="empty">
        <p>An error has occurred.</p>
        <div class="actions">
          <button class="fetch last">Retry</button>
          <span class="action close" id="close-action">close</span>
        </div>
      </div>
    `
    }

    getFullCss = preview => {
      if (preview === 'full') {
        return "padding: 10px 0;"
      } else {
        return "padding: 0;"
      }
    }

    getClass = preview => {
      return preview === 'full' ? '' : 'feed';
    }

    getLoader() {
      return `
      <div id="loader-container">
				<div class="loader"></div>
			</div>
    `
    }

    getAuthorHover = author => {
      const url = `/u/${author.hash.toLowerCase()}`;
      let bio = author.bio ? author.bio : 'This user has not added a bio yet.';
      // replace all " and ' with &quot; and &apos; to avoid breaking the html
      bio = bio.replace(/"/g, '&quot;').replace(/'/g, '&apos;');
      return /* html */`
			<hover-author url="${url}" you="${author.you ? 'true' : 'false'}" hash="${author.hash}"
        picture="${author.picture}" name="${author.name}" contact="${author.contact ? JSON.stringify(author.contact) : null}"
        stories="${author.stories}" replies="${author.replies}"
        followers="${author.followers}" following="${author.following}" user-follow="${author.is_following ? 'true' : 'false'}"
        verified="${author.verified ? 'true' : 'false'}" bio="${bio}">
      </hover-author>
		`
    }

    getImages = imageArray => {
      // if length is greater is less than 1
      if(!imageArray || imageArray.length < 1) return '';

      // return
      return /* html */`
      <images-wrapper images="${imageArray.join(',')}"></images-wrapper>
    `
    }

    getStyles() {
      return /*css*/`
      <style>
        * {
          box-sizing: border-box !important;
        }

        :host{
          border: none;
          padding: 0;
          ${this.getFullCss(this.getAttribute('preview'))}
          justify-self: end;
          display: flex;
          flex-flow: column;
          align-items: center;
          justify-content: center;
          gap: 10px;
          width: 100%;
          min-width: 100%;
        }

        #loader-container {
          padding: 10px 0;
          width: 50px;
          background-color: var(--loader-background);
          backdrop-filter: blur(1px);
          -webkit-backdrop-filter: blur(1px);
          display: flex;
          align-items: center;
          justify-content: center;
          border-radius: inherit;
          -webkit-border-radius: inherit;
          -moz-border-radius: inherit;
        }

        #loader-container > .loader {
          width: 20px;
          aspect-ratio: 1;
          --_g: no-repeat radial-gradient(farthest-side, #18A565 94%, #0000);
          --_g1: no-repeat radial-gradient(farthest-side, #21D029 94%, #0000);
          --_g2: no-repeat radial-gradient(farthest-side, #df791a 94%, #0000);
          --_g3: no-repeat radial-gradient(farthest-side, #f09c4e 94%, #0000);
          background:    var(--_g) 0 0,    var(--_g1) 100% 0,    var(--_g2) 100% 100%,    var(--_g3) 0 100%;
          background-size: 30% 30%;
          animation: l38 .9s infinite ease-in-out;
          -webkit-animation: l38 .9s infinite ease-in-out;
        }

        @keyframes l38 {
          100% {
            background-position: 100% 0, 100% 100%, 0 100%, 0 0
          }
        }

        .welcome {
          width: 100%;
          height: max-content;
          position: relative;
          display: flex;
          flex-flow: column;
          align-items: center;
          justify-content: center;
          gap: 0;
        }

        .preview {
          width: 100%;
          position: relative;
          display: flex;
          flex-flow: column;
          color: var(--text-color);
          line-height: 1.4;
          gap: 0;
          margin: 0;
          padding: 0 0 0 16px;
        }

        .preview.feed {
          padding: 0 0 0 16px;
        }

        .preview::before {
          content: '';
          display: block;
          position: absolute;
          top: 50%;
          transform: translateY(-50%);
          left: 4px;
          width: 1.5px;
          height: calc(100% - 10px);
          background: var(--action-linear);
          border-radius: 5px;
        }

        .preview p,
        .preview h3 {
          margin: 0;
          font-family: var(--font-read), sans-serif;
          line-height: 1.2;
        }

        .preview h3 {
          margin: 0 0 5px;
          font-family: var(--font-main), sans-serif;
          color: var(--title-color);
          font-size: 1.1rem;
          font-weight: 500;
        }

        .content {
          width: 100%;
          display: flex;
          flex-flow: column;
          color: var(--text-color);
          font-family: var(--font-main), sans-serif;
          line-height: 1.4;
          gap: 0;
          margin: 0;
          padding: 0;
        }

        .content.extra {
          max-height: 200px;
          overflow: hidden;
          position: relative;
        }

        .content.extra.mobile {
          max-height: 120px;
        }

        .content.extra.feed {
          max-height: 150px;
        }

        .content.extra .read-more {
          position: absolute;
          bottom: -5px;
          right: 0;
          left: 0;
          width: 100%;
          padding: 5px 0;
          display: flex;
          align-items: end;
          justify-content: center;
          min-height: 80px;
          gap: 3px;
          cursor: pointer;
          font-weight: 500;
          font-family: var(--font-main), sans-serif;
          color: var(--gray-color);
          background: var(--fade-linear-gradient);
        }

        .content.extra .read-more svg {
          display: inline-block;
          width: 16px;
          height: 16px;
          margin: 0 0 2px 0;
        }

        .content h6,
        .content h5,
        .content h4,
        .content h3,
        .content h1 {
          padding: 0;
          font-size: 1.3rem !important;
          color: var(--title-color);
          font-weight: 500;
          line-height: 1.5;
          margin: 5px 0;
        }

        .content p {
          font-size: 1rem;
          margin: 0 0 5px 0;
          line-height: 1.4;
        }

        .content a {
          text-decoration: none;
          cursor: pointer;
          color: var(--anchor-color) !important;
        }

        .content a:hover {
          text-decoration: underline;
        }

        .content blockquote {
          margin: 0;
          padding: 0 0 5px;
          font-style: italic;
          background: var(--background);
          color: var(--text-color);
          font-weight: 400;
          line-height: 1.4;
        }

        .content blockquote p {
          margin: 0;
        }

        .content blockquote * {
          margin: 0;
        }

        .content hr {
          border: none;
          background-color: var(--text-color);
          height: 1px;
          margin: 10px 0;
        }

        .content code {
          background: var(--gray-background);
          padding: 0 5px;
          font-family: var(--font-mono);
          font-size: 0.9rem;
          border-radius: 5px;
        }

        .content b,
        .content strong {
          font-weight: 700;
          line-height: 1.4;

        }

        .content ul,
        .content ol {
          margin: 5px 0 15px 20px;
          padding: 0 0 0 15px;
          color: inherit;
          line-height: 1.4;
        }

        .content ul li,
        .content ol li {
          margin: 6px 0;
          padding: 0;
          color: inherit;
        }

        figure {
          max-width: 100% !important;
          height: auto;
          width: max-content;
          padding: 0;
          max-width: 100%;
          display: block;
          margin-block-start: 5px;
          margin-block-end: 5px;
          margin-inline-start: 0 !important;
          margin-inline-end: 0 !important;
        }

        .replying-to {
          position: relative;
          text-decoration: none;
          width: 100%;
          display: flex;
          align-items: center;
          justify-content: start;
          gap: 0;
          margin: 0 0 3px;
          padding: 0;
        }
        
        .replying-to > .meta-reply {
          display: flex;
          width: max-content;
          align-items: start;
          color: var(--gray-color);
          flex-flow: column;
          font-size: 1rem;
          gap: 2px;
        }
        
        .replying-to > .meta-reply > .text {
          display: flex;
          align-items: center;
          justify-content: start;
          gap: 5px;
        }

        .replying-to > .meta-reply > .text > .reply {
          display: flex;
          font-size: 0.89rem;
          font-family: var(--font-read), sans-serif;
          padding: 0;
          font-weight: 400;
        }
        
        .replying-to > .meta-reply > .text > svg {
          color: var(--gray-color);
          width: 16px;
          height: 16px;
          display: inline-block;
          margin: 0 0 0 0;
        }
        
        .replying-to > .meta-reply .parent {
          background: var(--action-linear);
          font-family: var(--font-mono), monospace;
          font-size: 0.8rem;
          line-height: 1;
          color: transparent;
          font-weight: 600;
          background-clip: text;
          -webkit-background-clip: text;
          -moz-background-clip: text;
        }

        .meta {
          height: max-content;
          display: flex;
          position: relative;
          color: var(--gray-color);
          align-items: center;
          font-family: var(--font-mono),monospace;
          gap: 5px;
          font-size: 0.9rem;
          line-height: 1.5;
        }

        .meta > span.sp {
          margin: 1px 0 0 0;
        }

        .meta > span.by {
          font-weight: 500;
          font-size: 0.93rem;
          margin: 0 0 1px 1px;
        }

        .meta > span.hash {
          background: var(--action-linear);
          font-family: var(--font-mono), monospace;
          font-size: 0.9rem;
          line-height: 1;
          color: transparent;
          font-weight: 600;
          background-clip: text;
          -webkit-background-clip: text;
          -moz-background-clip: text;
        }

        .meta > time.time {
          font-family: var(--font-text), sans-serif;
          font-size: 0.83rem;
          font-weight: 500;
          margin: 1px 0 0 0;
        }

        div.empty {
          width: 100%;
          padding: 0;
          margin: 0;
          display: flex;
          flex-flow: column;
          gap: 10px;
        }

        div.empty > p {
          width: max-content;
          padding: 0;
          margin: 5px 0 0 0;
          color: var(--error-color);
          font-family: var(--font-main), sans-serif;
          font-size: 1rem;
          font-weight: 500;
        }

        div.empty > .actions {
          margin: 0;
        }

        button.fetch {
          width: max-content;
          margin: 10px 0;
          display: flex;
          align-items: center;
          justify-content: center;
          padding: 2px 10px 3px;
          font-size: 0.9rem;
          font-family: var(--font-main), sans-serif;
          font-weight: 500;
          background: var(--accent-linear);
          color: var(--white-color);
          border: none;
          border-radius: 10px;
          cursor: pointer
        }

        button.fetch.last {
          margin: 0 0 5px;
        }

        .preview.feed button.fetch {
          margin: 5px 0 3px 0;
          padding: 3px 10px 4px;
          border-radius: 7px;
          font-size: 0.8rem;
        }
        
        .actions {
          display: flex;
          font-family: var(--font-main), sans-serif;
          width: 100%;
          flex-flow: row;
          align-items: center;
          gap: 15px;
          margin: 5px 0 3px;
        }
        
        .actions > .action {
          border: var(--border-button);
          text-decoration: none;
          color: var(--gray-color);
          font-size: 0.9rem;
          display: flex;
          width: max-content;
          flex-flow: row;
          align-items: center;
          text-transform: lowercase;
          justify-content: center;
          padding: 1px 10px 2px;
          border-radius: 10px;
          -webkit-border-radius: 10px;
          -moz-border-radius: 10px;
        }

        .actions > .action.close {
          color: var(--error-color);
          cursor: pointer;
        }

        .actions > .action.plain {
          padding: 0;
          font-weight: 500;
          pointer-events: none;
          font-family: var(--font-text), sans-serif;
          color: var(--gray-color);
          border: none;
          background: none;
        }
        
        .actions > .action.plain > span.no {
          font-family: var(--font-main), sans-serif;
          font-size: 0.9rem;
          color: var(--text-color);
        }

        .actions > .action.plain > span.text {
          display: inline-block;
          padding: 0 0 0 3px;
        }
        
        @media screen and ( max-width: 850px ){
          #content {
            width: 90%;
          }
        }

        @media screen and ( max-width: 660px ) {
          :host {
            border: none;
            ${this.getFullCss(this.getAttribute('preview'))}
            justify-self: end;
            display: flex;
            flex-flow: column;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
            min-width: 100%;
          }

          .preview::before {
            content: '';
            display: block;
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            left: 4.5px;
            width: 1.5px;
            height: calc(100% - 10px);
            background: var(--action-linear);
            border-radius: 5px;
          }

          button.fetch,
          .content.extra .read-more,
          .actions > .action.close,
          a {
            cursor: default !important;
          }
        }
      </style>
    `;
    }
  }

  class ReplyPost extends HTMLElement {
    constructor() {
      // We are not even going to touch this.
      super();
      
      // let's create our shadow root
      this.shadowObj = this.attachShadow({mode: 'open'});

      this.render();
    }

    render() {
      this.shadowObj.innerHTML = this.getTemplate();
    }

    connectedCallback() {
    }

    removeHtml = () => {
      const title = this.getAttribute('preview-title');
      const text = this.getHTML();
      let str = text.replace(/<[^>]*>/g, '');

      str = str.trim();
      let filteredTitle = '';
      if(!title || title === null || title === "null" || title === undefined || title ==="undefined") {
        filteredTitle = '';
      } else {
        filteredTitle = `<h3>${title}</h3>`;
      }

      const content = `<p>${this.trimContent(str)}</p>`;

      return `
      ${filteredTitle}
      ${content}
    `
    }

    trimContent = text => {
      // if text is less than 150 characters
      if (text.length <= 250) return text;

      return text.substring(0, 250) + '...';
    }

    getHTML = () => {
      const text = this.innerHTML;
      const parser = new DOMParser();
      const doc = parser.parseFromString(text, 'text/html');
      return doc.body.innerHTML;
    }
    
    formatNumber = n => {
      if (n >= 0 && n <= 999) {
        return n.toString();
      } else if (n >= 1000 && n <= 9999) {
        const value = (n / 1000).toFixed(2);
        return `${value}k`;
      } else if (n >= 10000 && n <= 99999) {
        const value = (n / 1000).toFixed(1);
        return `${value}k`;
      } else if (n >= 100000 && n <= 999999) {
        const value = (n / 1000).toFixed(0);
        return `${value}k`;
      } else if (n >= 1000000 && n <= 9999999) {
        const value = (n / 1000000).toFixed(2);
        return `${value}M`;
      } else if (n >= 10000000 && n <= 99999999) {
        const value = (n / 1000000).toFixed(1);
        return `${value}M`;
      } else if (n >= 100000000 && n <= 999999999) {
        const value = (n / 1000000).toFixed(0);
        return `${value}M`;
      } else if (n >= 1000000000) {
        return "1B+";
      }
      else {
        return 0;
      }
    }

    parseToNumber = str => {
      // Try parsing the string to an integer
      const num = parseInt(str);

      // Check if parsing was successful
      if (!isNaN(num)) {
        return num;
      } else {
        return 0;
      }
    }

    disableScroll() {
      // Get the current page scroll position
      let scrollTop = window.scrollY || document.documentElement.scrollTop;
      let scrollLeft = window.scrollX || document.documentElement.scrollLeft;
      document.body.classList.add("stop-scrolling");

      // if any scroll is attempted, set this to the previous value
      window.onscroll = function() {
        window.scrollTo(scrollLeft, scrollTop);
      };
    }

    enableScroll() {
      document.body.classList.remove("stop-scrolling");
      window.onscroll = function() {};
    }

    getTemplate() {
      // Show HTML Here
      return /*html*/`
      <div class="welcome">
        <div class="preview">
          ${this.getContent()}
        </div>
      </div>
      ${this.getStyles()}
    `
    }

    getLapseTime = isoDateStr => {
      const dateIso = new Date(isoDateStr); // ISO strings with timezone are automatically handled
      let userTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;

      // Convert posted time to the current timezone
      const date = new Date(dateIso.toLocaleString('en-US', { timeZone: userTimezone }));

      // Get the current time
      const currentTime = new Date();

      // Get the difference in time
      const timeDifference = currentTime - date;

      // Get the seconds
      const seconds = timeDifference / 1000;

      // Check if seconds is less than 60: return Just now
      if (seconds < 60) {
        return 'Just now';
      }
      // check if seconds is less than 86400: return time AM/PM
      if (seconds < 86400) {
        return date.toLocaleTimeString('en-US', { hour: 'numeric', minute: 'numeric', hour12: true });
      }

      // check if seconds is less than 604800: return day and time
      if (seconds <= 604800) {
        return date.toLocaleDateString('en-US', { weekday: 'short', hour: 'numeric', minute: 'numeric', hour12: true });
      }

      // Check if the date is in the current year:: return date and month short 2-digit year without time
      if (date.getFullYear() === currentTime.getFullYear()) {
        return date.toLocaleDateString('en-US', { day: 'numeric', month: 'short', });
      }
      else {
        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
      }
    }

    getContent = () => {
      return /*html*/`
      <p>${this.removeHtml()}</p>
      <span class="meta">
        <span class="by">by</span>
        ${this.getAttribute("author-hash")}
        <span class="sp">•</span>
        <time class="time" datetime="${this.getAttribute('time')}">
          ${this.getLapseTime(this.getAttribute('time'))}
        </time>
      </span>
    `
    }

    getEmpty = () => {
      return /* html */`
      <div class="empty">
        <p>An error has occurred.</p>
        <div class="actions">
          <button class="fetch last">Retry</button>
          <span class="action close" id="close-action">close</span>
        </div>
      </div>
    `
    }

    getStyles() {
      return /*css*/`
      <style>
        * {
          box-sizing: border-box !important;
        }

        :host{
          border: none;
          padding: 0;
          justify-self: end;
          display: flex;
          flex-flow: column;
          align-items: center;
          justify-content: center;
          gap: 10px;
          width: 100%;
          min-width: 100%;
        }

        .welcome {
          width: 100%;
          height: max-content;
          position: relative;
          display: flex;
          flex-flow: column;
          align-items: center;
          justify-content: center;
          gap: 0;
        }

        .preview {
          width: 100%;
          position: relative;
          display: flex;
          flex-flow: column;
          color: var(--text-color);
          line-height: 1.2;
          gap: 0;
          margin: 0;
          padding: 0;
        }

        .preview p,
        .preview h3 {
          margin: 0 0 5px;
          font-family: var(--font-read), sans-serif;
          line-height: 1.2;
        }

        .preview h3 {
          margin: 0 0 5px;
          font-family: var(--font-main), sans-serif;
          color: var(--title-color);
          font-size: 1.1rem;
          font-weight: 500;
        }

        .meta {
          height: max-content;
          display: flex;
          position: relative;
          color: var(--gray-color);
          align-items: center;
          font-family: var(--font-mono),monospace;
          gap: 5px;
          font-size: 0.9rem;
          line-height: 1.5;
        }

        .meta > span.sp {
          margin: 1px 0 0 0;
        }

        .meta > span.by {
          font-weight: 500;
          font-size: 0.93rem;
          margin: 0 0 1px 1px;
        }

        .meta > span.hash {
          background: var(--action-linear);
          font-family: var(--font-mono), monospace;
          font-size: 0.9rem;
          line-height: 1;
          color: transparent;
          font-weight: 600;
          background-clip: text;
          -webkit-background-clip: text;
          -moz-background-clip: text;
        }

        .meta > time.time {
          font-family: var(--font-text), sans-serif;
          font-size: 0.83rem;
          font-weight: 500;
          margin: 1px 0 0 0;
        }

        @media screen and ( max-width: 660px ) {
          :host {
            border: none;
            justify-self: end;
            display: flex;
            flex-flow: column;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
            min-width: 100%;
          }

          button.fetch,
          .actions > .action.close,
          a {
            cursor: default !important;
          }
        }
      </style>
    `;
    }
  }

  class ActivityFeed extends HTMLElement {
    constructor() {
      // We are not even going to touch this.
      super();

      // let's create our shadow root
      this.shadowObj = this.attachShadow({ mode: "open" });

      this._block = false;
      this._empty = false;
      this._page = this.parseToNumber(this.getAttribute('page'));
      this._url = this.getAttribute('url');

      this.render();
    }

    render() {
      this.shadowObj.innerHTML = this.getTemplate();
    }

    connectedCallback() {
      const contentContainer = this.shadowObj.querySelector('.activities');

      this.fetchActivities(contentContainer);

      // watch event 
      setTimeout(() => {
        this.scrollEvent(contentContainer);
      }, 3000);
    }

    activateRefresh = () => {
      const outerThis = this;
      const finish = this.shadowObj.querySelector('.finish');
      if (finish) {
        const btn = finish.querySelector('button.finish');
        btn.addEventListener('click', () => {
          // unblock the fetching
          outerThis._block = false;
          outerThis._empty = false;
          
          // re fetch the content
          const activitiesContainer = outerThis.shadowObj.querySelector('.activities');

          // select finish
          const finishContainer =  activitiesContainer.querySelector('div.finish');

          if (finishContainer) {
            finishContainer.remove();
          }

          // set the loader
          activitiesContainer.insertAdjacentHTML('beforeend', outerThis.getLoader());

          setTimeout(() => {
            outerThis.fetchActivities(activitiesContainer);
          }, 1000);
        });
      }
    }

    fetching = async (url, activitiesContainer) => {
      const outerThis = this;

      try {
        const response = await this.fetchWithTimeout(url);
        const data = await response.json();

        if(!data.success ||!data.activities) {
          outerThis._empty = true;
          outerThis._block = true;
          outerThis.populateActivities(outerThis.getWrongMessage(), activitiesContainer);
          outerThis.activateRefresh();
          return;
        }

        if (data.activities.length === 0 && outerThis._page === 1) {
          outerThis._empty = true;
          outerThis._block = true;
          outerThis.populateActivities(outerThis.getEmptyMsg(), activitiesContainer);
        } else if (data.activities.length < 10) {
          outerThis._empty = true;
          outerThis._block = true;
          const content = outerThis.mapData(data.activities);
          outerThis.populateActivities(content, activitiesContainer);
          outerThis.populateActivities(outerThis.getLastMessage(), activitiesContainer);
        }
        else {
          outerThis._empty = false;
          outerThis._block = false;
          const content = outerThis.mapData(data.activities);
          outerThis.populateActivities(content, activitiesContainer);
        }
      } catch (error) {
        // console.log(error)
        outerThis._empty = true;
        outerThis._block = true;
        outerThis.populateActivities(outerThis.getWrongMessage(), activitiesContainer);
        outerThis.activateRefresh();
      }
    }

    fetchActivities = activitiesContainer => {
      const outerThis = this;
      const url = `${this._url}?page=${this._page}`;

      if (!this._block && !this._empty) {
        outerThis._empty = true;
        outerThis._block = true;
        setTimeout(() => {
          // fetch the activities
          outerThis.fetching(url, activitiesContainer);
        }, 2000);
      }
    }

    populateActivities = (content, activitiesContainer) => {
      // get the loader and remove it
      const loader = activitiesContainer.querySelector('.loader-container');
      if (loader) {
        loader.remove();
      }

      // insert the content
      activitiesContainer.insertAdjacentHTML('beforeend', content);
    }

    scrollEvent = activitiesContainer => {
      const outerThis = this;
      window.addEventListener('scroll', function () {
        let margin = document.body.clientHeight - window.innerHeight - 150;
        if (window.scrollY > margin && !outerThis._empty && !outerThis._block) {
          outerThis._page += 1;
          outerThis.populateActivities(outerThis.getLoader(), activitiesContainer);
          outerThis.fetchActivities(activitiesContainer);
        }
      });

      // Launch scroll event
      const scrollEvent = new Event('scroll');
      window.dispatchEvent(scrollEvent);
    }

    mapData = activities => {
      return activities.map(activity => {
        return /*html*/`
        <activity-item notification="${this.getAttribute('notification')}" id="${activity.id}" 
          hash="${activity.target}" time="${activity.createdAt}" kind="${activity.kind}" read="${activity.read}"
          to="${activity.to}" verb="${activity.verb}" action="${activity.action}" author="${activity.author}">
          ${activity.content}
        </activity-item>
      `
      }).join('');
    }

    fetchWithTimeout = async (url, options = {}, timeout = 9500) => {
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), timeout);
    
      try {
        const response = await fetch(url, {
          ...options,
          signal: controller.signal
        });

        return response;
      } catch (error) {
        if (error.name === 'AbortError') {
          throw new Error('Request timed out');
        }
        throw new Error(`Network error: ${error.message}`);
      } finally {
        clearTimeout(timeoutId);
      }
    };

    parseToNumber = num_str => {
      // Try parsing the string to an integer
      const num = parseInt(num_str);

      // Check if parsing was successful
      if (!isNaN(num)) {
        return num;
      } else {
        return 0;
      }
    }

    getTemplate = () => {
      // Show HTML Here
      return `
      ${this.getBody()}
      ${this.getStyles()}
    `;
    }

    getLoader() {
      return /* html */`
      <div class="loader-container">
        <span id="btn-loader">
          <span class="loader-alt"></span>
        </span>
      </div>
    `
    }

    getBody = () => {
      // language=HTML
      return `
			<div class="activities">
				${this.getLoader()}
      </div>
    `;
    }

    getEmptyMsg = () => {
      // get the next attribute
      return /*html*/`
      <div class="finish">
        <h2 class="finish__title">You no activities yet!</h2>
        <p class="desc">
          Your activities will appear here once you performing various actions on the platform.
        </p>
      </div>
    `
    }

    getLastMessage = () => {
      // get the next attribute
      return /*html*/`
      <div class="finish">
        <h2 class="finish__title">That's all for now!</h2>
        <p class="desc"> That's it, you have reached the end of your activities</p>
      </div>
    `
    }

    getWrongMessage = () => {
      // get the next attribute
      return /*html*/`
      <div class="finish">
        <h2 class="finish__title">Something went wrong!</h2>
        <p class="desc">
         An error occurred while fetching your activity feed. Please check your connection and try again.
        </p>
        <button class="finish">Retry</button>
      </div>
    `
    }

    getStyles() {
      return /* css */`
      <style>
        *,
        *:after,
        *:before {
          box-sizing: border-box !important;
          font-family: inherit;
          -webkit-box-sizing: border-box !important;
        }

        *:focus {
          outline: inherit !important;
        }

        *::-webkit-scrollbar {
          width: 3px;
        }

        *::-webkit-scrollbar-track {
          background: var(--scroll-bar-background);
        }

        *::-webkit-scrollbar-thumb {
          width: 3px;
          background: var(--scroll-bar-linear);
          border-radius: 50px;
        }

        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
          padding: 0;
          margin: 0;
          font-family: inherit;
        }

        p,
        ul,
        ol {
          padding: 0;
          margin: 0;
        }

        a {
          text-decoration: none;
        }

        :host {
          font-size: 16px;
          display: flex;
          flex-flow: column;
          gap: 0;
          padding: 5px 0 10px;
          width: 100%;
        }

        div.loader-container {
          position: relative;
          width: 100%;
          height: 150px;
          padding: 20px 0 0 0;
        }

        #btn-loader {
          position: absolute;
          top: 0;
          left: 0;
          bottom: 0;
          right: 0;
          z-index: 5;
          display: flex;
          align-items: center;
          justify-content: center;
          border-radius: inherit;
        }

        #btn-loader > .loader-alt {
          width: 35px;
          aspect-ratio: 1;
          --_g: no-repeat radial-gradient(farthest-side, #18A565 94%, #0000);
          --_g1: no-repeat radial-gradient(farthest-side, #21D029 94%, #0000);
          --_g2: no-repeat radial-gradient(farthest-side, #df791a 94%, #0000);
          --_g3: no-repeat radial-gradient(farthest-side, #f09c4e 94%, #0000);
          background:    var(--_g) 0 0,    var(--_g1) 100% 0,    var(--_g2) 100% 100%,    var(--_g3) 0 100%;
          background-size: 30% 30%;
          animation: l38 .9s infinite ease-in-out;
          -webkit-animation: l38 .9s infinite ease-in-out;
        }

        #btn-loader > .loader {
          width: 20px;
          aspect-ratio: 1;
          --_g: no-repeat radial-gradient(farthest-side, #ffffff 94%, #0000);
          --_g1: no-repeat radial-gradient(farthest-side, #ffffff 94%, #0000);
          --_g2: no-repeat radial-gradient(farthest-side, #df791a 94%, #0000);
          --_g3: no-repeat radial-gradient(farthest-side, #f09c4e 94%, #0000);
          background:    var(--_g) 0 0,    var(--_g1) 100% 0,    var(--_g2) 100% 100%,    var(--_g3) 0 100%;
          background-size: 30% 30%;
          animation: l38 .9s infinite ease-in-out;
          -webkit-animation: l38 .9s infinite ease-in-out;
        }

        @keyframes l38 {
          100% {
            background-position: 100% 0, 100% 100%, 0 100%, 0 0
          }
        }

        .activities {
          display: flex;
          flex-flow: column;
          gap: 0;
          padding: 0;
          width: 100%;
        }

        div.finish {
          padding: 10px 0 40px;
          width: 100%;
          min-width: 100%;
          height: auto;
          display: flex;
          flex-flow: column;
          justify-content: center;
          align-items: center;
          gap: 5px;
        }

        div.empty {
          padding: 10px 0;
          width: 100%;
          min-width: 100%;
          height: auto;
          display: flex;
          flex-flow: column;
          justify-content: center;
          align-items: center;
          gap: 5px;
        }

        div.finish > h2.finish__title {
          margin: 10px 0 0 0;
          font-size: 1.15rem;
          font-weight: 500;
          font-family: var(--font-read), sans-serif;
          color: var(--text-color);
        }

        div.empty p.desc,
        div.finish > p.desc {
          margin: 0;
          font-size: 0.85rem;
          font-family: var(--font-read), sans-serif;
          color: var(--gray-color);
          line-height: 1.4;
          text-align: center;
        }

        div.finish > button.finish {
          border: none;
          background: var(--accent-linear);
          font-family: var(--font-main), sans-serif;
          text-decoration: none;
          color: var(--white-color);
          margin: 10px 0 0;
          font-size: 1rem;
          font-weight: 500;
          cursor: pointer;
          display: flex;
          width: max-content;
          flex-flow: row;
          align-items: center;
          text-transform: capitalize;
          justify-content: center;
          padding: 7px 18px 8px;
          border-radius: 50px;
          -webkit-border-radius: 50px;
          -moz-border-radius: 50px;
        }

        @media screen and (max-width:660px) {
          a,
          div.finish > button.finish {
            cursor: default !important;
          }
        }

      </style>
    `;
    }
  }

  class PeopleFeed extends HTMLElement {
    constructor() {
      // We are not even going to touch this.
      super();

      this._block = false;
      this._empty = false;
      this._page = this.parseToNumber(this.getAttribute('page'));
      this._total = this.parseToNumber(this.getAttribute('total'));
  		this._kind = this.getAttribute('kind');
      this._url = this.getAttribute('url');
      this._query = this.setQuery(this.getAttribute('query'));

      // let's create our shadow root
      this.shadowObj = this.attachShadow({ mode: "open" });

      this.render();
    }

    setQuery = query => {
      return query && query !== "" && query === "true";
    }

    render() {
      this.shadowObj.innerHTML = this.getTemplate();
    }

    connectedCallback() {
      const peopleContainer = this.shadowObj.querySelector('.people');

  		// check total
  		if (peopleContainer) {
        this.fetchPeople(peopleContainer);     
  		}
    }

    activateRefresh = () => {
      const finish = this.shadowObj.querySelector('.finish');
      if (finish) {
        const btn = finish.querySelector('button.finish');
        btn.addEventListener('click', () => {
          // unblock the fetching
          this._block = false;
          this._empty = false;
          
          // re fetch the content
          const peopleContainer = this.shadowObj.querySelector('.people');

          // remove the finish message
          finish.remove();

          // set the loader
          peopleContainer.insertAdjacentHTML('beforeend', this.getLoader());

          setTimeout(() => {
            this.fetchPeople(peopleContainer);
          }, 1000);
        });
      }
    }

    disableScroll() {
      // Get the current page scroll position
      let scrollTop = window.scrollY || document.documentElement.scrollTop;
      let scrollLeft = window.scrollX || document.documentElement.scrollLeft;
      document.body.classList.add("stop-scrolling");

      // if any scroll is attempted, set this to the previous value
      window.onscroll = function () {
        window.scrollTo(scrollLeft, scrollTop);
      };
    }

    enableScroll() {
      document.body.classList.remove("stop-scrolling");
      window.onscroll = function () { };
    }

    fetching = async (url, peopleContainer) => {
      const outerThis = this;

      try {
        const response = await this.fetchWithTimeout(url);
        const result = await response.json();

        if(!result.success) {
          outerThis._empty = true;
          outerThis._block = true;
          outerThis.populatePeople(outerThis.getWrongMessage(outerThis._kind), peopleContainer);
          outerThis.activateRefresh();
          return;
        }

        const data = result.data;
        if (data.last && outerThis._page === 1 && data.people.length === 0) {
          outerThis._empty = true;
          outerThis._block = true;
          outerThis.populatePeople(outerThis.getEmptyMsg(outerThis._kind), peopleContainer);
        }
        else if (data.last && data.people.length < 10) {
          outerThis._empty = true;
          outerThis._block = true;
          const content = outerThis.mapFields(data.people);
          outerThis.populatePeople(content, peopleContainer);
          outerThis.populatePeople(outerThis.getLastMessage(outerThis._kind), peopleContainer);
        }
        else {
          outerThis._empty = false;
          outerThis._block = false;

          const content = outerThis.mapFields(data.people);
          outerThis.populatePeople(content, peopleContainer);
          outerThis.scrollEvent(peopleContainer);
        }

      } catch (error) {
        // console.log(error)
        outerThis._empty = true;
        outerThis._block = true;
        outerThis.populatePeople(outerThis.getWrongMessage(outerThis._kind), peopleContainer);
        outerThis.activateRefresh();
      }
    }

    fetchPeople = peopleContainer => {
      const outerThis = this;
      const url = this._query ? `${this._url}&page=${this._page}` : `${this._url}?page=${this._page}`;

      if(!this._block && !this._empty) {
        outerThis._empty = true;
        outerThis._block = true;
        setTimeout(() => {
          // fetch the likes
          outerThis.fetching(url, peopleContainer);
        }, 1000);
      }
    }

    populatePeople = (content, peopleContainer) => {
      // get the loader and remove it
      const loader = peopleContainer.querySelector('.loader-container');
      if (loader){
        loader.remove();
      }

      // insert the content
      peopleContainer.insertAdjacentHTML('beforeend', content);
    }
    
    scrollEvent = peopleContainer => {
      const outerThis = this;
      window.addEventListener('scroll', function () {
        let margin = document.body.clientHeight - window.innerHeight - 150;
        if (window.scrollY > margin && !outerThis._empty && !outerThis._block) {
          outerThis._page += 1;
          outerThis.populatePeople(outerThis.getLoader(), peopleContainer);
          outerThis.fetchPeople(peopleContainer);
        }
      });

      // Launch scroll event
      const scrollEvent = new Event('scroll');
      window.dispatchEvent(scrollEvent);
    }

    mapFields = data => {
      return data.map(user => {
        let bio = user.bio === null ? 'This user has not added a bio yet.' : user.bio;
        // replace all " and ' with &quot; and &apos; to avoid breaking the html
        bio = bio.replace(/"/g, '&quot;').replace(/'/g, '&apos;');
        return /*html*/`
				<user-wrapper hash="${user.hash}" you="${user.you}" url="/u/${user.hash}" stories="${user.stories}" replies="${user.replies}"
          picture="${user.picture}" verified="${user.verified}" name="${user.name}" followers="${user.followers}" contact='${user.contact ? JSON.stringify(user.contact) : null}'
          following="${user.following}" user-follow="${user.is_following}" bio="${bio}">
				</user-wrapper>
      `
      }).join('');
    }

    fetchWithTimeout = async (url, options = {}, timeout = 9500) => {
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), timeout);
    
      try {
        const response = await fetch(url, {
          ...options,
          signal: controller.signal
        });

        return response;
      } catch (error) {
        if (error.name === 'AbortError') {
          throw new Error('Request timed out');
        }
        throw new Error(`Network error: ${error.message}`);
      } finally {
        clearTimeout(timeoutId);
      }
    };

    parseToNumber = num_str => {
      // Try parsing the string to an integer
      const num = parseInt(num_str);

      // Check if parsing was successful
      if (!isNaN(num)) {
        return num;
      } else {
        return 0;
      }
    }

    getTemplate = () => {
      // Show HTML Here
      return `
      ${this.getBody()}
      ${this.getStyles()}
    `;
    }

    getLoader() {
      return /* html */`
      <div class="loader-container">
        <span id="btn-loader">
          <span class="loader-alt"></span>
        </span>
      </div>
    `
    }

    getBody = () => {
      // language=HTML
      return `
			<div class="people">
				${this.getLoader()}
      </div>
    `;
    }

    getEmptyMsg = text => {
      switch (text) {
  			case 'likes':
  				return /*html*/`
					<div class="finish">
						<h2 class="finish__title">No Likes found!</h2>
						<p class="desc">
							The post has no likes yet. You can be the first to like it or you can always come back later to check for new likes.
						</p>
					</div>
				`;
  			case 'followers':
  				return /*html*/`
					<div class="finish">
						<h2 class="finish__title">The author has no followers yet!</h2>
						<p class="desc">
							The user has no followers yet. You can be the first to follow the author or you can always come back later to check for new followers.
						</p>
					</div>
				`
  			case 'following':
  				return /*html*/`
					<div class="finish">
						<h2 class="finish__title">The user is not following anyone yet!</h2>
						<p class="desc">
							The user is not following anyone yet. You can always come back later to check.
						</p>
					</div>
				`
        case 'search':
  				return /*html*/`
					<div class="finish">
						<h2 class="finish__title">No user found!</h2>
						<p class="desc">
							The search keyword did not match any user, try searching using a different keyword.
						</p>
					</div>
				`
  			default:
  				return /*html*/`
					<div class="finish">
						<h2 class="finish__title">No data found!</h2>
						<p class="desc">
							No data found. You can always come back later to check for new data.
						</p>
					</div>
				`
  		}
    }

    getLastMessage = text => {
      switch (text) {
  			case 'likes':
  				return /*html*/`
					<div class="finish">
						<h2 class="finish__title">No more likes!</h2>
						<p class="desc">
							You have reached the end of people who liked this post. You can always come back later to check for new likes.
						</p>
					</div>
				`
  			case 'followers':
  				return /*html*/`
					<div class="finish">
						<h2 class="finish__title">No more followers.</h2>
						<p class="desc">
							You have reached the people who are following this user. You can always come back later to check for new followers.
						</p>
					</div>
				`
  			case 'following':
  				return /*html*/`
					<div class="finish">
						<h2 class="finish__title">No more people.</h2>
						<p class="desc">
							You have reached the end of the people who this user is following. You can always come back later to check for new people.
						</p>
					</div>
				`
        case 'search':
  				return /*html*/`
					<div class="finish">
						<h2 class="finish__title">The end of results</h2>
						<p class="desc">
							You have reached the end of the people who matched the query. You can try searching using different keyword.
						</p>
					</div>
				`
  			default:
  				return /*html*/`
					<div class="finish">
						<h2 class="finish__title">No more data.</h2>
						<p class="desc">
							You have reached the end of the data. You can always come back later to check for new data.
						</p>
					</div>
				`
  		}
    }

    getWrongMessage = () => {
      return /* html */`
      <div class="finish">
        <h2 class="finish__title">Something went wrong!</h2>
        <p class="desc">
          An error occurred while retrieving people. Please check your connection and try again.
        </p>
        <button class="finish">Retry</button>
      </div>
    `;
    }


    getStyles() {
      return /* css */`
      <style>
        *,
        *:after,
        *:before {
          box-sizing: border-box !important;
          font-family: inherit;
          -webkit-box-sizing: border-box !important;
        }

        *:focus {
          outline: inherit !important;
        }

        *::-webkit-scrollbar {
          width: 3px;
        }

        *::-webkit-scrollbar-track {
          background: var(--scroll-bar-background);
        }

        *::-webkit-scrollbar-thumb {
          width: 3px;
          background: var(--scroll-bar-linear);
          border-radius: 50px;
        }

        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
          padding: 0;
          margin: 0;
          font-family: inherit;
        }

        p,
        ul,
        ol {
          padding: 0;
          margin: 0;
        }

        a {
          text-decoration: none;
        }

        :host {
          font-size: 16px;
          width: 100%;
          padding: 0;
        }

        div.loader-container {
          position: relative;
          width: 100%;
          height: 150px;
          padding: 20px 0 0 0;
        }

        #btn-loader {
          position: absolute;
          top: 0;
          left: 0;
          bottom: 0;
          right: 0;
          z-index: 5;
          display: flex;
          align-items: center;
          justify-content: center;
          border-radius: inherit;
        }

        #btn-loader > .loader-alt {
          width: 35px;
          aspect-ratio: 1;
          --_g: no-repeat radial-gradient(farthest-side, #18A565 94%, #0000);
          --_g1: no-repeat radial-gradient(farthest-side, #21D029 94%, #0000);
          --_g2: no-repeat radial-gradient(farthest-side, #df791a 94%, #0000);
          --_g3: no-repeat radial-gradient(farthest-side, #f09c4e 94%, #0000);
          background:    var(--_g) 0 0,    var(--_g1) 100% 0,    var(--_g2) 100% 100%,    var(--_g3) 0 100%;
          background-size: 30% 30%;
          animation: l38 .9s infinite ease-in-out;
          -webkit-animation: l38 .9s infinite ease-in-out;
        }

        #btn-loader > .loader {
          width: 20px;
          aspect-ratio: 1;
          --_g: no-repeat radial-gradient(farthest-side, #ffffff 94%, #0000);
          --_g1: no-repeat radial-gradient(farthest-side, #ffffff 94%, #0000);
          --_g2: no-repeat radial-gradient(farthest-side, #df791a 94%, #0000);
          --_g3: no-repeat radial-gradient(farthest-side, #f09c4e 94%, #0000);
          background:    var(--_g) 0 0,    var(--_g1) 100% 0,    var(--_g2) 100% 100%,    var(--_g3) 0 100%;
          background-size: 30% 30%;
          animation: l38 .9s infinite ease-in-out;
          -webkit-animation: l38 .9s infinite ease-in-out;
        }

        @keyframes l38 {
          100% {
            background-position: 100% 0, 100% 100%, 0 100%, 0 0
          }
        }

        div.people {
          padding: 0;
          width: 100%;
          display: flex;
          flex-flow: column;
          gap: 0;
        }

        div.finish {
          padding: 10px 0 40px;
          width: 100%;
          min-width: 100%;
          height: auto;
          display: flex;
          flex-flow: column;
          justify-content: center;
          align-items: center;
          gap: 5px;
        }

        div.finish > h2.finish__title {
          margin: 10px 0 0 0;
          font-size: 1rem;
          font-weight: 500;
          font-family: var(--font-read), sans-serif;
          color: var(--text-color);
        }

        div.finish > p.desc {
          margin: 0;
          font-size: 0.85rem;
          font-family: var(--font-read), sans-serif;
          color: var(--gray-color);
          line-height: 1.4;
          text-align: center;
        }

        div.finish > button.finish {
          border: none;
          background: var(--accent-linear);
          font-family: var(--font-main), sans-serif;
          text-decoration: none;
          color: var(--white-color);
          margin: 10px 0 0;
          font-size: 1rem;
          font-weight: 500;
          cursor: pointer;
          display: flex;
          width: max-content;
          flex-flow: row;
          align-items: center;
          text-transform: capitalize;
          justify-content: center;
          padding: 7px 18px 8px;
          border-radius: 50px;
          -webkit-border-radius: 50px;
          -moz-border-radius: 50px;
        }

        @media screen and (max-width:660px) {
          a,
          div.finish > button.finish {
            cursor: default !important;
          }
        }
      </style>
    `;
    }
  }

  class StoryFeed extends HTMLElement {
    constructor() {
      // We are not even going to touch this.
      super();

      this._block = true;
      this._empty = true;
      this._page = this.parseToNumber(this.getAttribute('page'));
      this._url = this.getAttribute('url');
      this._kind = this.getAttribute('kind');
      this._query = this.setQuery(this.getAttribute('query'));

      // let's create our shadow root
      this.shadowObj = this.attachShadow({ mode: "open" });

      this.render();
    }

    setQuery = query => !(!query || query === "" || query !== "true");

    render() {
      this.shadowObj.innerHTML = this.getTemplate();
    }

    connectedCallback() {
      const storiesContainer = this.shadowObj.querySelector('.stories');

      // check if the total
      if (storiesContainer) {
        this._block = false;
        this._empty = false;
        this.fetchStories(storiesContainer);
      }
    }

    activateRefresh = () => {
      const finish = this.shadowObj.querySelector('.finish');
      if (finish) {
        const btn = finish.querySelector('button.finish');
        btn.addEventListener('click', () => {
          // unblock the fetching
          this._block = false;
          this._empty = false;
          
          // re fetch the content
          const storiesContainer = this.shadowObj.querySelector('div.stories');

          // remove the finish message
          finish.remove();

          // set the loader
          storiesContainer.insertAdjacentHTML('beforeend', this.getLoader());

          setTimeout(() => {
            this.fetchStories(storiesContainer);
          }, 1000);
        });
      }
    }

    disableScroll() {
      // Get the current page scroll position
      let scrollTop = window.scrollY || document.documentElement.scrollTop;
      let scrollLeft = window.scrollX || document.documentElement.scrollLeft;
      document.body.classList.add("stop-scrolling");

      // if any scroll is attempted, set this to the previous value
      window.onscroll = function () {
        window.scrollTo(scrollLeft, scrollTop);
      };
    }

    enableScroll() {
      document.body.classList.remove("stop-scrolling");
      window.onscroll = function () { };
    }

    fetching = async (url, storiesContainer) => {
      const outerThis = this;
      try {
        const response = await this.fetchWithTimeout(url);
        const result = await response.json();

        if (!result.success) {
          outerThis._empty = true;
          outerThis._block = true;
          outerThis.populateStories(outerThis.getWrongMessage(), storiesContainer);
          outerThis.activateRefresh();
          return;
        }

        const data = result.data;
        if (data.last && outerThis._page === 1 && data.stories.length === 0) {
          outerThis._empty = true;
          outerThis._block = true;
          outerThis.populateStories(outerThis.getEmptyMsg(outerThis._kind), storiesContainer);
        }
        else if (data.last && data.stories.length < 10) {
          outerThis._empty = true;
          outerThis._block = true;
          const content = outerThis.mapFields(data.stories);
          outerThis.populateStories(content, storiesContainer);
          outerThis.populateStories(outerThis.getLastMessage(outerThis._kind), storiesContainer);
        }
        else {
          outerThis._empty = false;
          outerThis._block = false;

          const content = outerThis.mapFields(data.stories);
          outerThis.populateStories(content, storiesContainer);

          // Add scroll event
          outerThis.scrollEvent(storiesContainer);
        }
      } catch (error) {
        outerThis._empty = true;
        outerThis._block = true;
        outerThis.populateStories(outerThis.getWrongMessage(), storiesContainer);
        outerThis.activateRefresh();
      }
    }

    fetchStories = storiesContainer => {
      const outerThis = this;
      const url = this._query ? `${this._url}&page=${this._page}` : `${this._url}?page=${this._page}`;

      if(!this._block && !this._empty) {
        outerThis._empty = true;
        outerThis._block = true;
        setTimeout(() => {
          // fetch the stories
          outerThis.fetching(url, storiesContainer);
        }, 1000);
      }
    }

    populateStories = (content, storiesContainer) => {
      // get the loader and remove it
      const loader = storiesContainer.querySelector('.loader-container');
      if (loader){
        loader.remove();
      }

      // insert the content
      storiesContainer.insertAdjacentHTML('beforeend', content);
    }
    
    scrollEvent = storiesContainer => {
      const outerThis = this;
      window.addEventListener('scroll', function () {
        let margin = document.body.clientHeight - window.innerHeight - 150;
        if (window.scrollY > margin && !outerThis._empty && !outerThis._block) {
          outerThis._page += 1;
          outerThis.populateStories(outerThis.getLoader(), storiesContainer);
          outerThis.fetchStories(storiesContainer);
        }
      });

      // Launch scroll event
      const scrollEvent = new Event('scroll');
      window.dispatchEvent(scrollEvent);
    }

    mapFields = data => {
      return data.map(story => {
        const author = story.story_author;
        let bio = author.bio === null ? 'This user has not added a bio yet.' : author.bio;
        // replace all " and ' with &quot; and &apos; to avoid breaking the html
        bio = bio.replace(/"/g, '&quot;').replace(/'/g, '&apos;');
        const url = `/p/${story.hash.toLowerCase()}`;
        const images = story.images ? story.images.join(',') : '';
        if (story.kind === "post") {
          return /*html*/`
          <quick-post story="quick" url="${url}" hash="${story.hash}" likes="${story.likes}" 
            replies="${story.replies}" liked="${story.liked ? 'true' : 'false'}" views="${story.views}" time="${story.createdAt}" 
            replies-url="/api/v1${url}/replies" likes-url="/api/v1${url}/likes" images='${images}'
            author-url="/u/${author.hash}" author-stories="${author.stories}" author-replies="${author.replies}"
            author-hash="${author.hash}" author-you="${story.you ? 'true' : 'false'}" author-img="${author.picture}" 
            author-verified="${author.verified ? 'true' : 'false'}" author-name="${author.name}" author-followers="${author.followers}" 
            author-following="${author.following}" author-follow="${author.is_following ? 'true' : 'false'}" author-contact='${author.contact ? JSON.stringify(author.contact) : null}'
            author-bio="${bio}">
            ${story.content}
          </quick-post>
        `
        }
        else if(story.kind === "poll") {
          return /*html*/`
          <poll-post story="poll" url="${url}" hash="${story.hash}" likes="${story.likes}" 
            replies="${story.replies}" liked="${story.liked ? 'true' : 'false'}" views="${story.views}" time="${story.createdAt}" 
            voted="${story.option ? 'true' : 'false'}" selected="${story.option}" end-time="${story.end}" replies-url="/api/v1${url}/replies" 
            likes-url="/api/v1${url}/likes" options='${story.poll}' votes="${story.votes}" 
            author-url="/u/${author.hash}" author-stories="${author.stories}" author-replies="${author.replies}"
            author-hash="${author.hash}" author-you="${story.you ? 'true' : 'false'}" author-img="${author.picture}" 
            author-verified="${author.verified ? 'true' : 'false'}" author-name="${author.name}" author-followers="${author.followers}" 
            author-following="${author.following}" author-follow="${author.is_following ? 'true' : 'false'}" author-contact='${author.contact ? JSON.stringify(author.contact) : null}'
            author-bio="${bio}">
            ${story.content}
          </poll-post>
        `
        }
        else if (story.kind === "story") {
          return /*html*/`
          <story-post story="story" hash="${story.hash}" url="${url}" 
            topics="${story.topics.length === 0 ? 'story' : story.topics }" story-title="${story.title}" time="${story.createdAt}" replies-url="/api/v1${url}/replies" 
            likes-url="/api/v1${url}/likes" replies="${story.replies}" liked="${story.liked ? 'true' : 'false'}" likes="${story.likes}" 
            views="${story.views}" images='${images}'
            author-url="/u/${author.hash}" author-stories="${author.stories}" author-replies="${author.replies}"
            author-hash="${author.hash}" author-you="${story.you ? 'true' : 'false'}" author-contact='${author.contact ? JSON.stringify(author.contact) : null}'
            author-img="${author.picture}" author-verified="${author.verified ? 'true' : 'false'}" author-name="${author.name}" 
            author-followers="${author.followers}" author-following="${author.following}" author-follow="${author.is_following ? 'true' : 'false'}" 
            author-bio="${bio}">
            ${story.content}
          </story-post>
        `
        }
      }).join('');
    }

    fetchWithTimeout = async (url, options = {}, timeout = 9500) => {
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), timeout);
    
      try {
        const response = await fetch(url, {
          ...options,
          signal: controller.signal
        });

        return response;
      } catch (error) {
        if (error.name === 'AbortError') {
          throw new Error('Request timed out');
        }
        throw new Error(`Network error: ${error.message}`);
      } finally {
        clearTimeout(timeoutId);
      }
    };

    parseToNumber = num_str => {
      // Try parsing the string to an integer
      const num = parseInt(num_str);

      // Check if parsing was successful
      if (!isNaN(num)) {
        return num;
      } else {
        return 0;
      }
    }

    getTemplate = () => {
      // Show HTML Here
      return `
      ${this.getBody()}
      ${this.getStyles()}
    `;
    }

    getLoader() {
      return /* html */`
      <div class="loader-container">
        <span id="btn-loader">
          <span class="loader-alt"></span>
        </span>
      </div>
    `
    }

    getBody = () => {
      // language=HTML
      return `
			<div class="stories">
				${this.getLoader()}
      </div>
    `;
    }

    getEmptyMsg = text => {
      // get the next attribute
     if (text === "feed") {
      return /*html*/`
      <div class="finish">
        <h2 class="finish__title">No stories</h2>
        <p class="desc">
          There are no stories/posts yet. You can come back later, once available they'll appear here.
        </p>
      </div>
    `
     } 
     else if(text === "user") {
      return /*html*/`
      <div class="finish">
        <h2 class="finish__title">No stories or posts</h2>
        <p class="desc">
          The user has not posted any stories yet. You can come back later, once available they'll appear here.
        </p>
      </div>
    `
     } 
     else if(text === "search") {
      return /*html*/`
      <div class="finish">
        <h2 class="finish__title">No stories found!</h2>
        <p class="desc">
          There are no stories/posts found. You can try searching with a different keyword.
        </p>
      </div>
    `
     }
     else if(text === "topic") {
      return /*html*/`
      <div class="finish">
        <h2 class="finish__title">No stories found!</h2>
        <p class="desc">
          No stories/posts found for this topic. You can try coming back later.
        </p>
      </div>
    `
     }
     else {
      return /*html*/`
      <div class="finish">
        <h2 class="finish__title"> No stories found!</h2>
        <p class="desc">
          There are no stories/posts found. You can try coming back later.
        </p>
      </div>
    `
     }
    }

    getLastMessage = text => {
      // get the next attribute
      if (text === "feed") {
        return /*html*/`
        <div class="finish">
          <h2 class="finish__title">That's all for now!</h2>
          <p class="desc">
            You have reached the end of the stories. You can always come back later or refresh the page to check for new stories.
          </p>
        </div>
      `
      }
      else if(text === "user") {
        return /*html*/`
        <div class="finish">
          <h2 class="finish__title">That's all the user's stories!</h2>
          <p class="desc">
            You have exhausted all of the user's stories. You can always come back later to check for new stories.
          </p>
        </div>
      `
      }
      else if(text === "search") {
        return /*html*/`
        <div class="finish">
          <h2 class="finish__title">That's all the results!</h2>
          <p class="desc">
            You have reached the end of the search results. You can try searching with a different keyword.
          </p>
        </div>
      `
      }
      else if(text === "topic") {
        return /*html*/`
        <div class="finish">
          <h2 class="finish__title">That's all the topic stories!</h2>
          <p class="desc">
            You have reached the end of the topic stories. You can come back later to check for new stories.
          </p>
        </div>
      `
      }
      else {
        return /*html*/`
        <div class="finish">
          <h2 class="finish__title">That's all!</h2>
          <p class="desc">
            You have reached the end of the stories. You can always come back later or refresh the page to check for new stories.
          </p>
        </div>
      `
      }
     
    }
    
    getWrongMessage = () => {
      return /* html */`
      <div class="finish">
        <h2 class="finish__title">Something went wrong!</h2>
        <p class="desc">
          An error occurred while retrieving stories. Please check your connection and try again.
        </p>
        <button class="finish">Retry</button>
      </div>
    `;
    }


    getStyles() {
      return /* css */`
      <style>
        *,
        *:after,
        *:before {
          box-sizing: border-box !important;
          font-family: inherit;
          -webkit-box-sizing: border-box !important;
        }

        *:focus {
          outline: inherit !important;
        }

        *::-webkit-scrollbar {
          width: 3px;
        }

        *::-webkit-scrollbar-track {
          background: var(--scroll-bar-background);
        }

        *::-webkit-scrollbar-thumb {
          width: 3px;
          background: var(--scroll-bar-linear);
          border-radius: 50px;
        }

        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
          padding: 0;
          margin: 0;
          font-family: inherit;
        }

        p,
        ul,
        ol {
          padding: 0;
          margin: 0;
        }

        a {
          text-decoration: none;
        }

        :host {
          font-size: 16px;
          width: 100%;
          padding: 0;
        }

        div.loader-container {
          position: relative;
          width: 100%;
          height: 150px;
          padding: 20px 0 0 0;
        }

        #btn-loader {
          position: absolute;
          top: 0;
          left: 0;
          bottom: 0;
          right: 0;
          z-index: 5;
          display: flex;
          align-items: center;
          justify-content: center;
          border-radius: inherit;
        }

        #btn-loader > .loader-alt {
          width: 35px;
          aspect-ratio: 1;
          --_g: no-repeat radial-gradient(farthest-side, #18A565 94%, #0000);
          --_g1: no-repeat radial-gradient(farthest-side, #21D029 94%, #0000);
          --_g2: no-repeat radial-gradient(farthest-side, #df791a 94%, #0000);
          --_g3: no-repeat radial-gradient(farthest-side, #f09c4e 94%, #0000);
          background:    var(--_g) 0 0,    var(--_g1) 100% 0,    var(--_g2) 100% 100%,    var(--_g3) 0 100%;
          background-size: 30% 30%;
          animation: l38 .9s infinite ease-in-out;
          -webkit-animation: l38 .9s infinite ease-in-out;
        }

        #btn-loader > .loader {
          width: 20px;
          aspect-ratio: 1;
          --_g: no-repeat radial-gradient(farthest-side, #ffffff 94%, #0000);
          --_g1: no-repeat radial-gradient(farthest-side, #ffffff 94%, #0000);
          --_g2: no-repeat radial-gradient(farthest-side, #df791a 94%, #0000);
          --_g3: no-repeat radial-gradient(farthest-side, #f09c4e 94%, #0000);
          background:    var(--_g) 0 0,    var(--_g1) 100% 0,    var(--_g2) 100% 100%,    var(--_g3) 0 100%;
          background-size: 30% 30%;
          animation: l38 .9s infinite ease-in-out;
          -webkit-animation: l38 .9s infinite ease-in-out;
        }

        @keyframes l38 {
          100% {
            background-position: 100% 0, 100% 100%, 0 100%, 0 0
          }
        }

        div.stories {
          padding: 0;
          width: 100%;
          display: flex;
          flex-flow: column;
          gap: 0;
        }

        div.finish {
          padding: 10px 0 40px;
          width: 100%;
          min-width: 100%;
          height: auto;
          display: flex;
          flex-flow: column;
          justify-content: center;
          align-items: center;
          gap: 5px;
        }

        div.finish > h2.finish__title {
          margin: 10px 0 0 0;
          font-size: 1rem;
          font-weight: 500;
          font-family: var(--font-read), sans-serif;
          color: var(--text-color);
        }

        div.finish > p.desc {
          margin: 0;
          font-size: 0.85rem;
          font-family: var(--font-read), sans-serif;
          color: var(--gray-color);
          line-height: 1.4;
          text-align: center;
        }

        div.finish > button.finish {
          border: none;
          background: var(--accent-linear);
          font-family: var(--font-main), sans-serif;
          text-decoration: none;
          color: var(--white-color);
          margin: 10px 0 0;
          font-size: 1rem;
          font-weight: 500;
          cursor: pointer;
          display: flex;
          width: max-content;
          flex-flow: row;
          align-items: center;
          text-transform: capitalize;
          justify-content: center;
          padding: 7px 18px 8px;
          border-radius: 50px;
          -webkit-border-radius: 50px;
          -moz-border-radius: 50px;
        }

        @media screen and (max-width:660px) {
          a,
          div.finish > button.finish {
            cursor: default !important;
          }
        }
      </style>
    `;
    }
  }

  class RepliesFeed extends HTMLElement {
    constructor() {
      // We are not even going to touch this.
      super();

      this._block = false;
      this._empty = false;
      this._page = this.parseToNumber(this.getAttribute('page'));
      this._url = this.getAttribute('url');
      this._kind = this.getAttribute('kind');
      this._query = this.setQuery(this.getAttribute('query'));
      this._noPreview = this.convertToBoolean(this.getAttribute('no-preview'));

      // let's create our shadow root
      this.shadowObj = this.attachShadow({ mode: "open" });

      this.render();
    }

    setQuery = query => !(!query || query === "" || query !== "true");

    convertToBoolean = value => {
      return value === "true";
    }

    render() {
      this.shadowObj.innerHTML = this.getTemplate();
    }

    connectedCallback() {
      const repliesContainer = this.shadowObj.querySelector('.replies');

      // check if the container exists
      if (repliesContainer) {
        this.fetchReplies(repliesContainer);
      }
    }

    activateRefresh = () => {
      const finish = this.shadowObj.querySelector('.finish');
      if (finish) {
        const btn = finish.querySelector('button.finish');
        btn.addEventListener('click', () => {
          // unblock the fetching
          this._block = false;
          this._empty = false;
          
          // re fetch the content
          const repliesContainer = this.shadowObj.querySelector('div.replies');

          // remove the finish message
          finish.remove();

          // set the loader
          repliesContainer.insertAdjacentHTML('beforeend', this.getLoader());

          setTimeout(() => {
            this.fetchReplies(repliesContainer);
          }, 1000);
        });
      }
    }

    disableScroll() {
      // Get the current page scroll position
      let scrollTop = window.scrollY || document.documentElement.scrollTop;
      let scrollLeft = window.scrollX || document.documentElement.scrollLeft;
      document.body.classList.add("stop-scrolling");

      // if any scroll is attempted, set this to the previous value
      window.onscroll = function () {
        window.scrollTo(scrollLeft, scrollTop);
      };
    }

    enableScroll() {
      document.body.classList.remove("stop-scrolling");
      window.onscroll = function () { };
    }

    fetching = async(url, repliesContainer) => {
      const outerThis = this;
      try {
        const response = await this.fetchWithTimeout(url);
        const result = await response.json();

        if(!result.success) {
          outerThis._empty = true;
          outerThis._block = true;
          outerThis.populateReplies(outerThis.getWrongMessage(), repliesContainer);
          outerThis.activateRefresh();
          return;
        }

        const data = result.data;
        if (data.last && outerThis._page === 1 && data.replies.length === 0) {
          outerThis._empty = true;
          outerThis._block = true;
          outerThis.populateReplies(outerThis.getEmptyMsg(outerThis._kind), repliesContainer);
        }
        else if (data.last && data.replies.length < 10) {
          outerThis._empty = true;
          outerThis._block = true;
          const content = outerThis.mapFields(data.replies);
          outerThis.populateReplies(content, repliesContainer);
          outerThis.populateReplies(outerThis.getLastMessage(outerThis._kind), repliesContainer);
        }
        else {
          outerThis._empty = false;
          outerThis._block = false;

          const content = outerThis.mapFields(data.replies);
          outerThis.populateReplies(content, repliesContainer);
          outerThis.scrollEvent(repliesContainer);
        }
      } catch (error) {
        // console.log(error)
        outerThis._empty = true;
        outerThis._block = true;
        outerThis.populateReplies(outerThis.getWrongMessage(), repliesContainer);
        this.activateRefresh();
      }
    }

    fetchReplies = repliesContainer => {
      const outerThis = this;
      const url = this._query ? `${this._url}&page=${this._page}` : `${this._url}?page=${this._page}`;

      if(!this._block && !this._empty) {
        outerThis._empty = true;
        outerThis._block = true;
        setTimeout(() => {
          // fetch the replies
          outerThis.fetching(url, repliesContainer);
        }, 1000);
      }
    }

    populateReplies = (content, repliesContainer) => {
      // get the loader and remove it
      const loader = repliesContainer.querySelector('.loader-container');
      if (loader){
        loader.remove();
      }

      // insert the content
      repliesContainer.insertAdjacentHTML('beforeend', content);
    }
    
    scrollEvent = repliesContainer => {
      const outerThis = this;
      window.addEventListener('scroll', function () {
        let margin = document.body.clientHeight - window.innerHeight - 150;
        if (window.scrollY > margin && !outerThis._empty && !outerThis._block) {
          outerThis._page += 1;
          outerThis.populateReplies(outerThis.getLoader(), repliesContainer);
          outerThis.fetchReplies(repliesContainer);
        }
      });

      // Launch scroll event
      const scrollEvent = new Event('scroll');
      window.dispatchEvent(scrollEvent);
    }

    mapFields = data => {
      return data.map(reply => {
        const author = reply.reply_author;
        let bio = author.bio === null ? 'This user has not added a bio yet.' : author.bio;
        // replace all " and ' with &quot; and &apos; to avoid breaking the html
        bio = bio.replace(/"/g, '&quot;').replace(/'/g, '&apos;');
        const images = reply.images ? reply.images.join(',') : null;
        return /*html*/`
        <quick-post story="reply" hash="${reply.hash}" url="/r/${reply.hash}" likes="${reply.likes}" replies="${reply.replies}" liked="${reply.liked}"
          views="${reply.views}" time="${reply.createdAt}" replies-url="/api/v1/r/${reply.hash}/replies" likes-url="/api/v1/r/${reply.hash}/likes" images='${images}'
          author-hash="${author.hash}" author-you="${reply.you}" author-url="/u/${author.hash}" author-contact='${author.contact ? JSON.stringify(author.contact) : null}'
          author-stories="${author.stories}" author-replies="${author.replies}" parent="${reply.story ? reply.story : reply.reply}" no-preview="${this._noPreview ? 'true' : 'false'}"
          author-img="${author.picture}" author-verified="${author.verified}" author-name="${author.name}" author-followers="${author.followers}"
          author-following="${author.following}" author-follow="${author.is_following}" author-bio="${bio}">
          ${reply.content}
        </quick-post>
      `
      }).join('');
    }

    fetchWithTimeout = async (url, options = {}, timeout = 9500) => {
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), timeout);
    
      try {
        const response = await fetch(url, {
          ...options,
          signal: controller.signal
        });

        return response;
      } catch (error) {
        if (error.name === 'AbortError') {
          throw new Error('Request timed out');
        }
        throw new Error(`Network error: ${error.message}`);
      } finally {
        clearTimeout(timeoutId);
      }
    }

    parseToNumber = num_str => {
      // Try parsing the string to an integer
      const num = parseInt(num_str);

      // Check if parsing was successful
      if (!isNaN(num)) {
        return num;
      } else {
        return 0;
      }
    }

    getTemplate = () => {
      // Show HTML Here
      return `
      ${this.getBody()}
      ${this.getStyles()}
    `;
    }

    getLoader() {
      return /* html */`
      <div class="loader-container">
        <span id="btn-loader">
          <span class="loader-alt"></span>
        </span>
      </div>
    `
    }

    getBody = () => {
      // language=HTML
      return `
			<div class="replies">
				${this.getLoader()}
      </div>
    `;
    }

    getEmptyMsg = text => {
      // get the next attribute
     if (text === "post") {
      return `
      <div class="finish">
        <h2 class="finish__title">No replies found!</h2>
        <p class="desc">
          The post has no replies yet. You can be the first one to reply or come back later, once available they'll appear here.
        </p>
      </div>
    `
     }
     else if(text === "reply") {
      return `
      <div class="finish">
        <h2 class="finish__title">No replies found!</h2>
        <p class="desc">
          The reply has no replies yet. You can be the first one to reply or come back later, once available they'll appear here.
        </p>
      </div>
    `
     }
     else if(text === "story") {
      return `
      <div class="finish">
        <h2 class="finish__title">No replies found!</h2>
        <p class="desc">
          The story has no replies yet. You can be the first one to reply or come back later, once available they'll appear here.
        </p>
      </div>
    `
     }
     else if(text === "search") {
      return `
      <div class="finish">
        <h2 class="title">No replies found!</h2>
        <p class="finish__title">
          There are no replies found for this search. You can try a different searching using a different keyword.
        </p>
      </div>
    `
     }
     else if(text === "user") {
      return `
      <div class="finish">
        <h2 class="finish__title">No replies found!</h2>
        <p class="desc">
          The user has no replies yet. You can come back later, once available they'll appear here.
        </p>
      </div>
    `
     } else {
      return `
      <div class="finish">
        <h2 class="finish__title">No replies found!</h2>
        <p class="desc">
          There are no replies yet. You can come back later, once available they'll appear here.
        </p>
      </div>
    `
     }
    }

    getLastMessage = text => {
      // get the next attribute
      if (text === "post") {
        return `
        <div class="finish">
          <h2 class="finish__title">No more replies!</h2>
          <p class="desc">
            You have exhausted all of the post's replies. You can add a new reply or come back later to check for new replies.
          </p>
        </div>
      `
      } 
      else if(text === "reply") {
        return `
        <div class="finish">
          <h2 class="finish__title">No more replies!</h2>
          <p class="desc">
            You have exhausted all of the reply's replies. You can add a new reply or come back later to check for new replies.
          </p>
        </div>
      `
      }
      else if(text === "story") {
        return `
        <div class="finish">
          <h2 class="finish__title">No more replies!</h2>
          <p class="desc">
            You have exhausted all of the story's replies. You can add a new reply or come back later to check for new replies.
          </p>
        </div>
      `
      }
      else if(text === "search") {
        return `
        <div class="finish">
          <h2 class="finish__title">No more replies!</h2>
          <p class="desc">
            You have exhausted all of the search's results. You can try a different search using a different keyword.
          </p>
        </div>
      `
      }
      else if(text === "user") {
        return `
        <div class="finish">
          <h2 class="finish__title">No more replies!</h2>
          <p class="desc">
            You have exhausted all of the user's replies. You can always come back later to check for new replies.
          </p>
        </div>
      `
      }
      else {
        return `
        <div class="finish">
          <h2 class="finish__title">No more replies!</h2>
          <p class="desc">
            You have reached the end of the replies. You can always come back later to check for new replies.
          </p>
        </div>
      `
      }
     
    }

    getWrongMessage = () => {
      return /* html */`
      <div class="finish">
        <h2 class="finish__title">Something went wrong!</h2>
        <p class="desc">
          An error occurred while retrieving replies. Please check your connection and try again.
        </p>
        <button class="finish">Retry</button>
      </div>
    `;
    }

    getStyles() {
      return /* css */`
      <style>
        *,
        *:after,
        *:before {
          box-sizing: border-box !important;
          font-family: inherit;
          -webkit-box-sizing: border-box !important;
        }

        *:focus {
          outline: inherit !important;
        }

        *::-webkit-scrollbar {
          width: 3px;
        }

        *::-webkit-scrollbar-track {
          background: var(--scroll-bar-background);
        }

        *::-webkit-scrollbar-thumb {
          width: 3px;
          background: var(--scroll-bar-linear);
          border-radius: 50px;
        }

        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
          padding: 0;
          margin: 0;
          font-family: inherit;
        }

        p,
        ul,
        ol {
          padding: 0;
          margin: 0;
        }

        a {
          text-decoration: none;
        }

        :host {
          font-size: 16px;
          width: 100%;
          padding: 0;
        }

        div.loader-container {
          position: relative;
          width: 100%;
          height: 150px;
          padding: 20px 0 0 0;
        }

        #btn-loader {
          position: absolute;
          top: 0;
          left: 0;
          bottom: 0;
          right: 0;
          z-index: 5;
          display: flex;
          align-items: center;
          justify-content: center;
          border-radius: inherit;
        }

        #btn-loader > .loader-alt {
          width: 35px;
          aspect-ratio: 1;
          --_g: no-repeat radial-gradient(farthest-side, #18A565 94%, #0000);
          --_g1: no-repeat radial-gradient(farthest-side, #21D029 94%, #0000);
          --_g2: no-repeat radial-gradient(farthest-side, #df791a 94%, #0000);
          --_g3: no-repeat radial-gradient(farthest-side, #f09c4e 94%, #0000);
          background:    var(--_g) 0 0,    var(--_g1) 100% 0,    var(--_g2) 100% 100%,    var(--_g3) 0 100%;
          background-size: 30% 30%;
          animation: l38 .9s infinite ease-in-out;
          -webkit-animation: l38 .9s infinite ease-in-out;
        }

        #btn-loader > .loader {
          width: 20px;
          aspect-ratio: 1;
          --_g: no-repeat radial-gradient(farthest-side, #ffffff 94%, #0000);
          --_g1: no-repeat radial-gradient(farthest-side, #ffffff 94%, #0000);
          --_g2: no-repeat radial-gradient(farthest-side, #df791a 94%, #0000);
          --_g3: no-repeat radial-gradient(farthest-side, #f09c4e 94%, #0000);
          background:    var(--_g) 0 0,    var(--_g1) 100% 0,    var(--_g2) 100% 100%,    var(--_g3) 0 100%;
          background-size: 30% 30%;
          animation: l38 .9s infinite ease-in-out;
          -webkit-animation: l38 .9s infinite ease-in-out;
        }

        @keyframes l38 {
          100% {
            background-position: 100% 0, 100% 100%, 0 100%, 0 0
          }
        }

        div.replies {
          padding: 0;
          width: 100%;
          display: flex;
          flex-flow: column;
          gap: 0;
        }

        div.finish {
          padding: 10px 0 40px;
          width: 100%;
          min-width: 100%;
          height: auto;
          display: flex;
          flex-flow: column;
          justify-content: center;
          align-items: center;
          gap: 5px;
        }

        div.finish > h2.finish__title {
          margin: 10px 0 0 0;
          font-size: 1rem;
          font-weight: 500;
          font-family: var(--font-read), sans-serif;
          color: var(--text-color);
        }

        div.finish > p.desc {
          margin: 0;
          font-size: 0.85rem;
          font-family: var(--font-read), sans-serif;
          color: var(--gray-color);
          line-height: 1.4;
          text-align: center;
        }

        div.finish > button.finish {
          border: none;
          background: var(--accent-linear);
          font-family: var(--font-main), sans-serif;
          text-decoration: none;
          color: var(--white-color);
          margin: 10px 0 0;
          font-size: 1rem;
          font-weight: 500;
          cursor: pointer;
          display: flex;
          width: max-content;
          flex-flow: row;
          align-items: center;
          text-transform: capitalize;
          justify-content: center;
          padding: 7px 18px 8px;
          border-radius: 50px;
          -webkit-border-radius: 50px;
          -moz-border-radius: 50px;
        }

        @media screen and (max-width:660px) {
          a,
          div.finish > button.finish {
            cursor: default !important;
          }
        }
      </style>
    `;
    }
  }

  class StatFeed extends HTMLElement {
    constructor() {
      // We are not even going to touch this.
      super();

      // let's create our shadow root
      this.shadowObj = this.attachShadow({ mode: "open" });

      this._kind = this.getAttribute('kind');

      this._block = false;
      this._empty = false;
      this._page = this.parseToNumber(this.getAttribute('page'));
      this._url = this.getAttribute('api');

      this.render();
    }

    render() {
      this.shadowObj.innerHTML = this.getTemplate();
    }

    connectedCallback() {
      const contentContainer = this.shadowObj.querySelector('.activities');

      this.fetchFeeds(contentContainer);

      // watch event 
      setTimeout(() => {
        this.scrollEvent(contentContainer);
      }, 3000);
    }

    activateRefresh = () => {
      const outerThis = this;
      const finish = this.shadowObj.querySelector('.finish');
      if (finish) {
        const btn = finish.querySelector('button.finish');
        btn.addEventListener('click', () => {
          // unblock the fetching
          outerThis._block = false;
          outerThis._empty = false;
          
          // re fetch the content
          const feedContainer = outerThis.shadowObj.querySelector('.activities');

          // select finish
          const finishContainer =  feedContainer.querySelector('div.finish');

          if (finishContainer) {
            finishContainer.remove();
          }

          // set the loader
          feedContainer.insertAdjacentHTML('beforeend', outerThis.getLoader());

          setTimeout(() => {
            outerThis.fetchFeeds(feedContainer);
          }, 1000);
        });
      }
    }

    fetching = async (url, feedContainer) => {
      const outerThis = this;

      try {
        const response = await this.fetchWithTimeout(url);
        const data = await response.json();

        if (!data.success) {
          outerThis._empty = true;
          outerThis._block = true;
          outerThis.populateFeeds(outerThis.getWrongMessage(), feedContainer);
          outerThis.activateRefresh();
        }


        if (data.stories) {
          if (data.stories.length === 0 && outerThis._page === 1) {
            outerThis._empty = true;
            outerThis._block = true;
            outerThis.populateFeeds(outerThis.getEmptyMsg(), feedContainer);
            
          } else if (data.stories.length < 10) {
            outerThis._empty = true;
            outerThis._block = true;
            const content = outerThis.mapStories(data.stories);
            outerThis.populateFeeds(content, feedContainer);
            outerThis.populateFeeds(outerThis.getLastMessage(), feedContainer);
          }
          else {
            outerThis._empty = false;
            outerThis._block = false;
            const content = outerThis.mapStories(data.stories);
            outerThis.populateFeeds(content, feedContainer);
          }
        }
        else if (data.replies) {
          if (data.replies.length === 0 && outerThis._page === 1) {
            outerThis._empty = true;
            outerThis._block = true;
            outerThis.populateFeeds(outerThis.getEmptyMsg(), feedContainer);
          } else if (data.replies.length < 10) {
            outerThis._empty = true;
            outerThis._block = true;
            const content = outerThis.mapReplies(data.replies);
            outerThis.populateFeeds(content, feedContainer);
            outerThis.populateFeeds(outerThis.getLastMessage(), feedContainer);
          }
          else {
            outerThis._empty = false;
            outerThis._block = false;
            const content = outerThis.mapReplies(data.replies);
            outerThis.populateFeeds(content, feedContainer);
          }
        } else {
          throw new Error("Stories or replies are not defined!");
        }
      } catch (error) {
        // console.log(error)
        outerThis._empty = true;
        outerThis._block = true;
        outerThis.populateFeeds(outerThis.getWrongMessage(), feedContainer);
        outerThis.activateRefresh();
      }
    }

    fetchFeeds = feedContainer => {
      const outerThis = this;
      const url = `${this._url}?page=${this._page}`;

      if (!this._block && !this._empty) {
        outerThis._empty = true;
        outerThis._block = true;
        setTimeout(() => {
          // fetch the stories
          outerThis.fetching(url, feedContainer);
        }, 2000);
      }
    }

    populateFeeds = (content, feedContainer) => {
      // get the loader and remove it
      const loader = feedContainer.querySelector('.loader-container');
      if (loader) {
        loader.remove();
      }

      // insert the content
      feedContainer.insertAdjacentHTML('beforeend', content);
    }

    scrollEvent = feedContainer => {
      const outerThis = this;
      window.addEventListener('scroll', function () {
        let margin = document.body.clientHeight - window.innerHeight - 150;
        if (window.scrollY > margin && !outerThis._empty && !outerThis._block) {
          outerThis._page += 1;
          outerThis.populateFeeds(outerThis.getLoader(), feedContainer);
          outerThis.fetchFeeds(feedContainer);
        }
      });

      // Launch scroll event
      const scrollEvent = new Event('scroll');
      window.dispatchEvent(scrollEvent);
    }

    mapStories= stories => {
      return stories.map(story => {
        const author = story.story_author;
        let bio = author.bio === null ? 'This user has not added a bio yet.' : author.bio;
        // replace all " and ' with &quot; and &apos; to avoid breaking the html
        bio = bio.replace(/"/g, '&quot;').replace(/'/g, '&apos;');
        const url = `/p/${story.hash.toLowerCase()}`;
        const vote = story.kind === "poll" ? `
        voted="${story.option ? 'true' : 'false'}" selected="${story.option}" end-time="${story.end}" 
        options='${story.poll}' votes="${story.votes}" 
      ` : '';
        const images = story.images ? story.images.join(',') : null;
        return /*html*/`
        <stat-story kind="${story.kind}" url="${url}" hash="${story.hash}" likes="${story.likes}" images='${images}'
          replies="${story.replies}" liked="${story.liked ? 'true' : 'false'}" views="${story.views}" time="${story.createdAt}" 
          replies-url="/api/v1${url}/replies" likes-url="/api/v1${url}/likes" story-title="${story.title}"
          topics="${story.topics.length === 0 ? 'story' : story.topics}" ${vote} author-contact='${author.contact ? JSON.stringify(author.contact) : null}'
          author-url="/u/${author.hash}" author-stories="${author.stories}" author-replies="${author.replies}"
          author-hash="${author.hash}" author-you="${story.you ? 'true' : 'false'}" author-img="${author.picture}" 
          author-verified="${author.verified ? 'true' : 'false'}" author-name="${author.name}" author-followers="${author.followers}" 
          author-following="${author.following}" author-follow="${author.is_following ? 'true' : 'false'}" 
          author-bio="${bio}">
          ${story.content}
        </stat-story>
      `
      }).join('');
    }

    mapReplies = replies => {
      return replies.map(reply => {
        const author = reply.reply_author;
        let bio = author.bio === null ? 'This user has not added a bio yet.' : author.bio;
        // replace all " and ' with &quot; and &apos; to avoid breaking the html
        bio = bio.replace(/"/g, '&quot;').replace(/'/g, '&apos;');
        const images = reply.images ? reply.images.join(',') : null;
        return /*html*/`
        <stat-reply kind="reply" hash="${reply.hash}" url="/r/${reply.hash.toLowerCase()}" likes="${reply.likes}" replies="${reply.replies}" liked="${reply.liked}"
          views="${reply.views}" time="${reply.createdAt}" replies-url="/api/v1/r/${reply.hash}/replies" likes-url="/api/v1/r/${reply.hash}/likes"
          author-hash="${author.hash}" author-you="${reply.you}" author-url="/u/${author.hash}" author-contact='${author.contact ? JSON.stringify(author.contact) : null}'
          author-stories="${author.stories}" author-replies="${author.replies}" parent="${reply.story ? reply.story : reply.reply}" images='${images}'
          author-img="${author.picture}" author-verified="${author.verified}" author-name="${author.name}" author-followers="${author.followers}"
          author-following="${author.following}" author-follow="${author.is_following}" author-bio="${bio}">
          ${reply.content}
        </stat-reply>
      `
      }).join('');
    }

    fetchWithTimeout = async (url, options = {}, timeout = 9500) => {
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), timeout);
    
      try {
        const response = await fetch(url, {
          ...options,
          signal: controller.signal
        });

        return response;
      } catch (error) {
        if (error.name === 'AbortError') {
          throw new Error('Request timed out');
        }
        throw new Error(`Network error: ${error.message}`);
      } finally {
        clearTimeout(timeoutId);
      }
    };

    parseToNumber = num_str => {
      // Try parsing the string to an integer
      const num = parseInt(num_str);

      // Check if parsing was successful
      if (!isNaN(num)) {
        return num;
      } else {
        return 0;
      }
    }

    getTemplate = () => {
      // Show HTML Here
      return `
      ${this.getBody()}
      ${this.getStyles()}
    `;
    }

    getLoader() {
      return /* html */`
      <div class="loader-container">
        <span id="btn-loader">
          <span class="loader-alt"></span>
        </span>
      </div>
    `
    }

    getBody = () => {
      // language=HTML
      return `
			<div class="activities">
				${this.getLoader()}
      </div>
    `;
    }

    getEmptyMsg = () => {
      // get the next attribute
      return /*html*/`
      <div class="finish">
        <h2 class="finish__title">You have not created any ${this._kind} yet!</h2>
        <p class="desc">
         You can always create a new ${this._kind}, check homepage for more details.
        </p>
      </div>
    `
    }

    getLastMessage = () => {
      // get the next attribute
      return /*html*/`
      <div class="finish">
        <h2 class="finish__title">That's all for now!</h2>
        <p class="desc">
          That's it, you have reached the end of your ${this._kind}.
        </p>
      </div>
    `
    }

    getWrongMessage = () => {
      // get the next attribute
      return /*html*/`
      <div class="finish">
        <h2 class="finish__title">Something went wrong!</h2>
        <p class="desc">
         An error occurred while fetching your stats feed. Please check your connection and try again.
        </p>
        <button class="finish">Retry</button>
      </div>
    `
    }

    getStyles() {
      return /* css */`
      <style>
        *,
        *:after,
        *:before {
          box-sizing: border-box !important;
          font-family: inherit;
          -webkit-box-sizing: border-box !important;
        }

        *:focus {
          outline: inherit !important;
        }

        *::-webkit-scrollbar {
          width: 3px;
        }

        *::-webkit-scrollbar-track {
          background: var(--scroll-bar-background);
        }

        *::-webkit-scrollbar-thumb {
          width: 3px;
          background: var(--scroll-bar-linear);
          border-radius: 50px;
        }

        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
          padding: 0;
          margin: 0;
          font-family: inherit;
        }

        p,
        ul,
        ol {
          padding: 0;
          margin: 0;
        }

        a {
          text-decoration: none;
        }

        :host {
          font-size: 16px;
          display: flex;
          flex-flow: column;
          gap: 0;
          padding: 5px 0 10px;
          width: 100%;
        }

        div.loader-container {
          position: relative;
          width: 100%;
          height: 150px;
          padding: 20px 0 0 0;
        }

        #btn-loader {
          position: absolute;
          top: 0;
          left: 0;
          bottom: 0;
          right: 0;
          z-index: 5;
          display: flex;
          align-items: center;
          justify-content: center;
          border-radius: inherit;
        }

        #btn-loader > .loader-alt {
          width: 35px;
          aspect-ratio: 1;
          --_g: no-repeat radial-gradient(farthest-side, #18A565 94%, #0000);
          --_g1: no-repeat radial-gradient(farthest-side, #21D029 94%, #0000);
          --_g2: no-repeat radial-gradient(farthest-side, #df791a 94%, #0000);
          --_g3: no-repeat radial-gradient(farthest-side, #f09c4e 94%, #0000);
          background:    var(--_g) 0 0,    var(--_g1) 100% 0,    var(--_g2) 100% 100%,    var(--_g3) 0 100%;
          background-size: 30% 30%;
          animation: l38 .9s infinite ease-in-out;
          -webkit-animation: l38 .9s infinite ease-in-out;
        }

        #btn-loader > .loader {
          width: 20px;
          aspect-ratio: 1;
          --_g: no-repeat radial-gradient(farthest-side, #ffffff 94%, #0000);
          --_g1: no-repeat radial-gradient(farthest-side, #ffffff 94%, #0000);
          --_g2: no-repeat radial-gradient(farthest-side, #df791a 94%, #0000);
          --_g3: no-repeat radial-gradient(farthest-side, #f09c4e 94%, #0000);
          background:    var(--_g) 0 0,    var(--_g1) 100% 0,    var(--_g2) 100% 100%,    var(--_g3) 0 100%;
          background-size: 30% 30%;
          animation: l38 .9s infinite ease-in-out;
          -webkit-animation: l38 .9s infinite ease-in-out;
        }

        @keyframes l38 {
          100% {
            background-position: 100% 0, 100% 100%, 0 100%, 0 0
          }
        }

        .activities {
          display: flex;
          flex-flow: column;
          gap: 0;
          padding: 0;
          width: 100%;
        }

        div.finish {
          padding: 10px 0 40px;
          width: 100%;
          min-width: 100%;
          height: auto;
          display: flex;
          flex-flow: column;
          justify-content: center;
          align-items: center;
          gap: 5px;
        }

        div.empty {
          padding: 10px 0;
          width: 100%;
          min-width: 100%;
          height: auto;
          display: flex;
          flex-flow: column;
          justify-content: center;
          align-items: center;
          gap: 5px;
        }

        div.finish > h2.finish__title {
          margin: 10px 0 0 0;
          font-size: 1.15rem;
          font-weight: 500;
          font-family: var(--font-read), sans-serif;
          color: var(--text-color);
        }

        div.empty p.desc,
        div.finish > p.desc {
          margin: 0;
          font-size: 0.85rem;
          font-family: var(--font-read), sans-serif;
          color: var(--gray-color);
          line-height: 1.4;
          text-align: center;
        }

        div.finish > button.finish {
          border: none;
          background: var(--accent-linear);
          font-family: var(--font-main), sans-serif;
          text-decoration: none;
          color: var(--white-color);
          margin: 10px 0 0;
          font-size: 1rem;
          font-weight: 500;
          cursor: pointer;
          display: flex;
          width: max-content;
          flex-flow: row;
          align-items: center;
          text-transform: capitalize;
          justify-content: center;
          padding: 7px 18px 8px;
          border-radius: 50px;
          -webkit-border-radius: 50px;
          -moz-border-radius: 50px;
        }

        @media screen and (max-width:660px) {
          a,
          div.finish > button.finish {
            cursor: default !important;
          }
        }
      </style>
    `;
    }
  }

  class TopicFeed extends HTMLElement {
    constructor() {
      // We are not even going to touch this.
      super();

      this._block = false;
      this._empty = false;
      this._page = this.parseToNumber(this.getAttribute('page'));
      this._url = this.getAttribute('url');
      this._kind = this.getAttribute('kind');
      this._query = this.setQuery(this.getAttribute('query'));

      // let's create our shadow root
      this.shadowObj = this.attachShadow({ mode: "open" });

      this.render();
    }

    setQuery = query => !(!query || query === "" || query !== "true");

    render() {
      this.shadowObj.innerHTML = this.getTemplate();
    }

    connectedCallback() {
      const topicsContainer = this.shadowObj.querySelector('.topics');

      // check if the total
      if (topicsContainer) {
        this.fetchTopics(topicsContainer);
      }
    }

    activateRefresh = () => {
      const finish = this.shadowObj.querySelector('.finish');
      if (finish) {
        const btn = finish.querySelector('button.finish');
        btn.addEventListener('click', () => {
          // unblock the fetching
          this._block = false;
          this._empty = false;
          
          // re fetch the content
          const topicsContainer = this.shadowObj.querySelector('.topics');

          // remove the finish message
          finish.remove();

          // set the loader
          topicsContainer.insertAdjacentHTML('beforeend', this.getLoader());

          setTimeout(() => {
            this.fetchTopics(topicsContainer);
          }, 1000);
        });
      }
    }

    disableScroll() {
      // Get the current page scroll position
      let scrollTop = window.scrollY || document.documentElement.scrollTop;
      let scrollLeft = window.scrollX || document.documentElement.scrollLeft;
      document.body.classList.add("stop-scrolling");

      // if any scroll is attempted, set this to the previous value
      window.onscroll = function () {
        window.scrollTo(scrollLeft, scrollTop);
      };
    }

    enableScroll() {
      document.body.classList.remove("stop-scrolling");
      window.onscroll = function () { };
    }

    fetching = async (url, topicsContainer) => {
      const outerThis = this;
      try {
        const response = await this.fetchWithTimeout(url);
        const result = await response.json();

        if (!result.success) {
          outerThis._empty = true;
          outerThis._block = true;
          outerThis.populateTopics(outerThis.getWrongMessage(), topicsContainer);
          outerThis.activateRefresh();
          return;
        }

        const data = result.data;
        if (data.last && outerThis._page === 1 && data.topics.length === 0) {
          outerThis._empty = true;
          outerThis._block = true;
          outerThis.populateTopics(outerThis.getEmptyMsg(outerThis._kind), topicsContainer);
        }
        else if (data.last && data.topics.length < 10) {
          outerThis._empty = true;
          outerThis._block = true;
          const content = outerThis.mapFields(data.topics);
          outerThis.populateTopics(content, topicsContainer);
          outerThis.populateTopics(outerThis.getLastMessage(outerThis._kind), topicsContainer);
        }
        else {
          outerThis._empty = false;
          outerThis._block = false;

          const content = outerThis.mapFields(data.topics);
          outerThis.populateTopics(content, topicsContainer);
          outerThis.scrollEvent(topicsContainer);
        }
      } catch (error) {
        // console.log(error)
        outerThis._empty = true;
        outerThis._block = true;
        outerThis.populateTopics(outerThis.getWrongMessage(), topicsContainer);
        this.activateRefresh();
      }
    }

    fetchTopics = topicsContainer => {
      const outerThis = this;
      const url = this._query ? `${this._url}&page=${this._page}` : `${this._url}?page=${this._page}`;

      if(!this._block && !this._empty) {
        outerThis._empty = true;
        outerThis._block = true;
        setTimeout(() => {
          // fetch the topics
          outerThis.fetching(url, topicsContainer);
        }, 1000);
      }
    }

    populateTopics = (content, topicsContainer) => {
      // get the loader and remove it
      const loader = topicsContainer.querySelector('.loader-container');
      if (loader){
        loader.remove();
      }

      // insert the content
      topicsContainer.insertAdjacentHTML('beforeend', content);
    }
    
    scrollEvent = topicsContainer => {
      const outerThis = this;
      window.addEventListener('scroll', function () {
        let margin = document.body.clientHeight - window.innerHeight - 150;
        if (window.scrollY > margin && !outerThis._empty && !outerThis._block) {
          outerThis._page += 1;
          outerThis.populateTopics(outerThis.getLoader(), topicsContainer);
          outerThis.fetchTopics(topicsContainer);
        }
      });

      // Launch scroll event
      const scrollEvent = new Event('scroll');
      window.dispatchEvent(scrollEvent);
    }

    mapFields = data => {
      return data.map(topic => {
        const author = topic.topic_author;
        let bio = author.bio === null ? 'This user has not added a bio yet.' : author.bio;
        // replace all " and ' with &quot; and &apos; to avoid breaking the html
        bio = bio.replace(/"/g, '&quot;').replace(/'/g, '&apos;');
        const url = `/t/${topic.hash.toLowerCase()}`;
        return /*html*/`
        <topic-wrapper hash="${topic.hash}" name="${topic.name}" slug="${topic.slug}"
          topic-follow="${topic.is_following}" subscribed="${topic.is_subscribed}" url="${url}" views="${topic.views}"
          subscribers="${topic.subscribers}" followers="${topic.followers}" stories="${topic.stories}"
          author-hash="${author.hash}" author-you="${topic.you}" author-url="/u/${author.hash}"
          author-img="${author.picture}" author-verified="${author.verified}" author-name="${author.name}" author-followers="${author.followers}"
          author-following="${author.following}" author-follow="${author.is_following}" author-contact='${author.contact ? JSON.stringify(author.contact) : null}'
          author-bio="${bio}">
          ${this.topicContent(topic.summary)}
        </topic-wrapper>
      `
      }).join('');
    }

    topicContent = data => {
      if (data.length <= 0 || !data) {
        return /*html*/`
        <div class="finish">
          <p>The topic has no information yet.
            More information will be available once the author(s) adds more content.
          </p>
        </div>
      `;
      }
      else {
        return data
      }
    }

    fetchWithTimeout = async (url, options = {}, timeout = 9500) => {
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), timeout);
    
      try {
        const response = await fetch(url, {
          ...options,
          signal: controller.signal
        });

        return response;
      } catch (error) {
        if (error.name === 'AbortError') {
          throw new Error('Request timed out');
        }
        throw new Error(`Network error: ${error.message}`);
      } finally {
        clearTimeout(timeoutId);
      }
    }

    parseToNumber = num_str => {
      // Try parsing the string to an integer
      const num = parseInt(num_str);

      // Check if parsing was successful
      if (!isNaN(num)) {
        return num;
      } else {
        return 0;
      }
    }

    getTemplate = () => {
      // Show HTML Here
      return `
      ${this.getBody()}
      ${this.getStyles()}
    `;
    }

    getLoader() {
      return /* html */`
      <div class="loader-container">
        <span id="btn-loader">
          <span class="loader-alt"></span>
        </span>
      </div>
    `
    }

    getBody = () => {
      // language=HTML
      return `
			<div class="topics">
				${this.getLoader()}
      </div>
    `;
    }

    getEmptyMsg = text => {
      // get the next attribute
     if (text === "feed") {
      return `
      <div class="finish">
        <h2 class="finish__title">No topics</h2>
        <p class="desc">
          There are no topics/posts yet. You can come back later, once available they'll appear here.
        </p>
      </div>
    `
     } 
     else if(text === "search") {
      return `
      <div class="finish">
        <h2 class="finish__title">No topics found!</h2>
        <p class="desc">
          No topics found for this search. You can try searching with a different keyword.
        </p>
      </div>
    `
     }
     else if(text === "topic") {
      return `
      <div class="finish">
        <h2 class="finish__title">No topics found!</h2>
        <p class="desc">
          No topics found for this topic. You can come back later, once available they'll appear here.
        </p>
      </div>
    `
     }
     else {
      return `
      <div class="finish">
        <h2 class="finish__title"> No topics found!</h2>
        <p class="desc">
          No topics found. You can come back later, once available they'll appear here.
        </p>
      </div>
    `
     }
    }

    getLastMessage = text => {
      // get the next attribute
      if (text === "feed") {
        return `
        <div class="finish">
          <h2 class="finish__title">That's all for now!</h2>
          <p class="desc">
            You have reached the end of the topics. You can always come back later to check for new topics.
          </p>
        </div>
      `
      }
      else if(text === "user") {
        return `
        <div class="finish">
          <h2 class="finish__title">That's all for now!</h2>
          <p class="desc">
            You have exhausted all of the user's topics. You can always come back later to check for new topics.
          </p>
        </div>
      `
      }
      else if(text === "search") {
        return `
        <div class="finish">
          <h2 class="finish__title">That's all the results!</h2>
          <p class="desc">
            You have reached the end of the search results. You can try searching with a different keyword.
          </p>
        </div>
      `
      }
      else if(text === "topic") {
        return `
        <div class="finish">
          <h2 class="finish__title">That's all for now!</h2>
          <p class="desc">
            You have reached the end of the related topics. You can always come back later or refresh the page to check for new topics.
          </p>
        </div>
      `
      }
      else {
        return `
        <div class="finish">
          <h2 class="finish__title">That's all!</h2>
          <p class="desc">
            You have reached the end of the topics. You can always come back later or refresh the page to check for new topics.
          </p>
        </div>
      `
      }
     
    }

    getWrongMessage = () => {
      return /* html */`
      <div class="finish">
        <h2 class="finish__title">Something went wrong!</h2>
        <p class="desc">
          An error occurred while retrieving topics. Please check your connection and try again.
        </p>
        <button class="finish">Retry</button>
      </div>
    `;
    }

    getStyles() {
      return /* css */`
      <style>
        *,
        *:after,
        *:before {
          box-sizing: border-box !important;
          font-family: inherit;
          -webkit-box-sizing: border-box !important;
        }

        *:focus {
          outline: inherit !important;
        }

        *::-webkit-scrollbar {
          width: 3px;
        }

        *::-webkit-scrollbar-track {
          background: var(--scroll-bar-background);
        }

        *::-webkit-scrollbar-thumb {
          width: 3px;
          background: var(--scroll-bar-linear);
          border-radius: 50px;
        }

        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
          padding: 0;
          margin: 0;
          font-family: inherit;
        }

        p,
        ul,
        ol {
          padding: 0;
          margin: 0;
        }

        a {
          text-decoration: none;
        }

        :host {
          font-size: 16px;
          width: 100%;
          padding: 0;
        }

        div.loader-container {
          position: relative;
          width: 100%;
          height: 150px;
          padding: 20px 0 0 0;
        }

        #btn-loader {
          position: absolute;
          top: 0;
          left: 0;
          bottom: 0;
          right: 0;
          z-index: 5;
          display: flex;
          align-items: center;
          justify-content: center;
          border-radius: inherit;
        }

        #btn-loader > .loader-alt {
          width: 35px;
          aspect-ratio: 1;
          --_g: no-repeat radial-gradient(farthest-side, #18A565 94%, #0000);
          --_g1: no-repeat radial-gradient(farthest-side, #21D029 94%, #0000);
          --_g2: no-repeat radial-gradient(farthest-side, #df791a 94%, #0000);
          --_g3: no-repeat radial-gradient(farthest-side, #f09c4e 94%, #0000);
          background:    var(--_g) 0 0,    var(--_g1) 100% 0,    var(--_g2) 100% 100%,    var(--_g3) 0 100%;
          background-size: 30% 30%;
          animation: l38 .9s infinite ease-in-out;
          -webkit-animation: l38 .9s infinite ease-in-out;
        }

        #btn-loader > .loader {
          width: 20px;
          aspect-ratio: 1;
          --_g: no-repeat radial-gradient(farthest-side, #ffffff 94%, #0000);
          --_g1: no-repeat radial-gradient(farthest-side, #ffffff 94%, #0000);
          --_g2: no-repeat radial-gradient(farthest-side, #df791a 94%, #0000);
          --_g3: no-repeat radial-gradient(farthest-side, #f09c4e 94%, #0000);
          background:    var(--_g) 0 0,    var(--_g1) 100% 0,    var(--_g2) 100% 100%,    var(--_g3) 0 100%;
          background-size: 30% 30%;
          animation: l38 .9s infinite ease-in-out;
          -webkit-animation: l38 .9s infinite ease-in-out;
        }

        @keyframes l38 {
          100% {
            background-position: 100% 0, 100% 100%, 0 100%, 0 0
          }
        }

        div.topics {
          padding: 0;
          width: 100%;
          display: flex;
          flex-flow: column;
          gap: 0;
        }

        div.finish {
          padding: 10px 0 40px;
          width: 100%;
          min-width: 100%;
          height: auto;
          display: flex;
          flex-flow: column;
          justify-content: center;
          align-items: center;
          gap: 5px;
        }

        div.finish > h2.finish__title {
          margin: 10px 0 0 0;
          font-size: 1rem;
          font-weight: 500;
          font-family: var(--font-read), sans-serif;
          color: var(--text-color);
        }

        div.finish > p.desc {
          margin: 0;
          font-size: 0.85rem;
          font-family: var(--font-read), sans-serif;
          color: var(--gray-color);
          line-height: 1.4;
          text-align: center;
        }

        div.finish > button.finish {
          border: none;
          background: var(--accent-linear);
          font-family: var(--font-main), sans-serif;
          text-decoration: none;
          color: var(--white-color);
          margin: 10px 0 0;
          font-size: 1rem;
          font-weight: 500;
          cursor: pointer;
          display: flex;
          width: max-content;
          flex-flow: row;
          align-items: center;
          text-transform: capitalize;
          justify-content: center;
          padding: 7px 18px 8px;
          border-radius: 50px;
          -webkit-border-radius: 50px;
          -moz-border-radius: 50px;
        }

        @media screen and (max-width:660px) {
          a,
          div.finish > button.finish {
            cursor: default !important;
          }
        }
      </style>
    `;
    }
  }

  class HomeFeed extends HTMLElement {
    constructor() {
      // We are not even going to touch this.
      super();

      this._isFirstLoad = true;
      this._block = false;
      this._empty = false;
      this._page = this.parseToNumber(this.getAttribute('page'));
      this._url = this.getAttribute('url');

      // let's create our shadow root
      this.shadowObj = this.attachShadow({ mode: "open" });

      this.render();
    }

    render() {
      this.shadowObj.innerHTML = this.getTemplate();
    }

    connectedCallback() {
      // set next
      window.home = {
        last: true,
        next: 5,
        loaded: true
      };
      const feedContainer = this.shadowObj.querySelector('.stories');

      // check if the total
      if (feedContainer) {
        this.fetchFeeds(feedContainer);
      }
    }

    activateRefresh = () => {
      const finish = this.shadowObj.querySelector('.finish');
      if (finish) {
        const btn = finish.querySelector('button.finish');
        btn.addEventListener('click', () => {
          // unblock the fetching
          this._block = false;
          this._empty = false;
          
          // re fetch the content
          const feedContainer = this.shadowObj.querySelector('div.stories');

          // remove the finish message
          finish.remove();

          // set the loader
          feedContainer.insertAdjacentHTML('beforeend', this.getLoader());

          setTimeout(() => {
            this.fetchFeeds(feedContainer);
          }, 1000);
        });
      }
    }

    disableScroll() {
      // Get the current page scroll position
      let scrollTop = window.scrollY || document.documentElement.scrollTop;
      let scrollLeft = window.scrollX || document.documentElement.scrollLeft;
      document.body.classList.add("stop-scrolling");

      // if any scroll is attempted, set this to the previous value
      window.onscroll = function () {
        window.scrollTo(scrollLeft, scrollTop);
      };
    }

    enableScroll() {
      document.body.classList.remove("stop-scrolling");
      window.onscroll = function () { };
    }

    fetching = (url, feedContainer) => {
      // Remove the scroll event
      this.removeScrollEvent();
      const outerThis = this;
      this.fetchWithTimeout(url, { method: "GET" }).then((response) => {
        response.json().then((result) => {
          if (result.success) {
            const data = result.data;
            if (data.last && outerThis._page === 1 && data.stories.length === 0 && data.replies.length === 0) {
              outerThis._empty = true;
              outerThis._block = true;
              outerThis.populateFeeds(outerThis.getEmptyMsg(), feedContainer);
            }
            else if (data.stories.length < 6 && data.replies.length < 6) {
              outerThis._empty = true;
              outerThis._block = true;
              const content = outerThis.mapFeeds(data.stories, data.replies);
              outerThis.populateFeeds(content, feedContainer);
              outerThis.populateFeeds(outerThis.getLastMessage(), feedContainer);
            }
            else {
              outerThis._empty = false;
              outerThis._block = false;

              const content = outerThis.mapFeeds(data.stories, data.replies);
              outerThis.populateFeeds(content, feedContainer);
            }

            // Add scroll event
            outerThis.scrollEvent(feedContainer);
          }
          else {
            outerThis._empty = true;
            outerThis._block = true;
            outerThis.populateFeeds(outerThis.getWrongMessage(), feedContainer);
            // activate the refresh button
            outerThis.activateRefresh();
          }
        })
          .catch((error) => {
            // console.log(error)
            outerThis._empty = true;
            outerThis._block = true;
            outerThis.populateFeeds(outerThis.getWrongMessage(), feedContainer);

            // activate the refresh button
            outerThis.activateRefresh();
          });
      });
    }

    fetchFeeds = feedContainer => {
      const outerThis = this;
      const url = `${this._url}?page=${this._page}`;

      if (!this._block && !this._empty) {
        outerThis._empty = true;
        outerThis._block = true;
        // fetch the stories
        setTimeout(() => {
          outerThis.fetching(url, feedContainer);
        }, 2000);
      }
    }

    populateFeeds = (content, feedContainer) => {
      // get the loader and remove it
      const loader = feedContainer.querySelector('.loader-container');
      if (loader) {
        loader.remove();
      }

      // insert the content
      feedContainer.insertAdjacentHTML('beforeend', content);
    }

    scrollEvent = feedContainer => {
      const outerThis = this;
      window.addEventListener('scroll', function () {
        let margin = document.body.clientHeight - window.innerHeight - 150;
        if (window.scrollY > margin && !outerThis._empty && !outerThis._block) {
          outerThis._page += 1;
          outerThis.populateFeeds(outerThis.getLoader(), feedContainer);

          outerThis.fetchFeeds(feedContainer);
        }
      });

      // Launch scroll event
      const scrollEvent = new Event('scroll');
      window.dispatchEvent(scrollEvent);
    }

    removeScrollEvent = () => {
      window.removeEventListener('scroll', function () { });
    }

    mapFeeds = (stories, replies) => {
      const outerThis = this;
      let content = '';
      
      // Check if the stories is empty and replies is not empty
      if (stories.length === 0 && replies.length > 0) {
        content = replies.map(reply => outerThis.mapReply(reply)).join('');
      }
      else if (stories.length > 0 && replies.length === 0) {
        content = stories.map(story => outerThis.mapStory(story)).join('');
      }
      else {
        // for each story follow by a reply, if there is any(i.e): append ine story and one reply if either is available else append the other
        // check the longest array
        if (stories.length >= replies.length) {
          for (let i = 0; i < stories.length; i++) {
            content += outerThis.mapStory(stories[i]);
            if (replies[i]) {
              content += outerThis.mapReply(replies[i]);
            }
          }
        }
        else {
          for (let i = 0; i < replies.length; i++) {
            if (stories[i]) {
              content += outerThis.mapStory(stories[i]);
            }
            content += outerThis.mapReply(replies[i]);
          }
        }
      }

      return content;
    }

    mapStory = story => {
      const author = story.story_author;
      let bio = author.bio === null ? 'This user has not added a bio yet.' : author.bio;
      // replace all " and ' with &quot; and &apos; to avoid breaking the html
      bio = bio.replace(/"/g, '&quot;').replace(/'/g, '&apos;');
      const url = `/p/${story.hash.toLowerCase()}`;
      const images = story.images ? story.images.join(',') : null;
      if (story.kind === "post") {
        return /*html*/`
        <quick-post story="quick" url="${url}" hash="${story.hash}" likes="${story.likes}" images='${images}'
          replies="${story.replies}" liked="${story.liked ? 'true' : 'false'}" views="${story.views}" time="${story.createdAt}" 
          replies-url="/api/v1${url}/replies" likes-url="/api/v1${url}/likes" 
          author-url="/u/${author.hash}" author-stories="${author.stories}" author-replies="${author.replies}"
          author-hash="${author.hash}" author-you="${story.you ? 'true' : 'false'}" author-img="${author.picture}" 
          author-verified="${author.verified ? 'true' : 'false'}" author-name="${author.name}" author-followers="${author.followers}" 
          author-following="${author.following}" author-follow="${author.is_following ? 'true' : 'false'}" author-contact='${author.contact ? JSON.stringify(author.contact) : null}'
          author-bio="${bio}">
          ${story.content}
        </quick-post>
      `
      }
      else if (story.kind === "poll") {
        return /*html*/`
        <poll-post story="poll" url="${url}" hash="${story.hash}" likes="${story.likes}" 
          replies="${story.replies}" liked="${story.liked ? 'true' : 'false'}" views="${story.views}" time="${story.createdAt}" 
          voted="${story.option ? 'true' : 'false'}" selected="${story.option}" end-time="${story.end}" 
          options='${story.poll}' votes="${story.votes}" likes-url="/api/v1${url}/likes" replies-url="/api/v1${url}/replies" 
          author-url="/u/${author.hash}" author-stories="${author.stories}" author-replies="${author.replies}"
          author-hash="${author.hash}" author-you="${story.you ? 'true' : 'false'}" author-img="${author.picture}" 
          author-verified="${author.verified ? 'true' : 'false'}" author-name="${author.name}" author-followers="${author.followers}" 
          author-following="${author.following}" author-follow="${author.is_following ? 'true' : 'false'}" author-contact='${author.contact ? JSON.stringify(author.contact) : null}'
          author-bio="${bio}">
          ${story.content}
        </poll-post>
      `
      }
      else if (story.kind === "story") {
        return /*html*/`
        <story-post story="story" hash="${story.hash}" url="${url}" images='${images}'
          topics="${story.topics.length === 0 ? 'story' : story.topics}" story-title="${story.title}" time="${story.createdAt}" replies-url="/api/v1${url}/replies" 
          likes-url="/api/v1${url}/likes" replies="${story.replies}" liked="${story.liked ? 'true' : 'false'}" likes="${story.likes}" 
          views="${story.views}" 
          author-url="/u/${author.hash}" author-stories="${author.stories}" author-replies="${author.replies}"
          author-hash="${author.hash}" author-you="${story.you ? 'true' : 'false'}" author-contact='${author.contact ? JSON.stringify(author.contact) : null}'
          author-img="${author.picture}" author-verified="${author.verified ? 'true' : 'false'}" author-name="${author.name}" 
          author-followers="${author.followers}" author-following="${author.following}" author-follow="${author.is_following ? 'true' : 'false'}" 
          author-bio="${bio}">
          ${story.content}
        </story-post>
      `
      }
    }

    mapReply = reply => {
      const author = reply.reply_author;
      let bio = author.bio === null ? 'This user has not added a bio yet.' : author.bio;
      // replace all " and ' with &quot; and &apos; to avoid breaking the html
      bio = bio.replace(/"/g, '&quot;').replace(/'/g, '&apos;');
      const images = reply.images ? reply.images.join(',') : null;
      return /*html*/`
      <quick-post story="reply" hash="${reply.hash}" url="/r/${reply.hash.toLowerCase()}" likes="${reply.likes}" replies="${reply.replies}" liked="${reply.liked}"
        views="${reply.views}" time="${reply.createdAt}" replies-url="/api/v1/r/${reply.hash}/replies" likes-url="/api/v1/r/${reply.hash}/likes"
        author-hash="${author.hash}" author-you="${reply.you}" author-url="/u/${author.hash}" author-contact='${author.contact ? JSON.stringify(author.contact) : null}'
        author-stories="${author.stories}" author-replies="${author.replies}" parent="${reply.story ? reply.story : reply.reply}" images='${images}'
        author-img="${author.picture}" author-verified="${author.verified}" author-name="${author.name}" author-followers="${author.followers}"
        author-following="${author.following}" author-follow="${author.is_following}" author-bio="${bio}">
        ${reply.content}
      </quick-post>
    `
    }

    fetchWithTimeout = async (url, options = {}, timeout = 9500) => {
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), timeout);
    
      try {
        const response = await fetch(url, {
          ...options,
          signal: controller.signal
        });

        return response;
      } catch (error) {
        if (error.name === 'AbortError') {
          throw new Error('Request timed out');
        }
        throw new Error(`Network error: ${error.message}`);
      } finally {
        clearTimeout(timeoutId);
      }
    };

    parseToNumber = num_str => {
      // Try parsing the string to an integer
      const num = parseInt(num_str);

      // Check if parsing was successful
      if (!isNaN(num)) {
        return num;
      } else {
        return 0;
      }
    }

    getTemplate = () => {
      // Show HTML Here
      return `
      ${this.getBody()}
      ${this.getStyles()}
    `;
    }

    getLoader() {
      return /* html */`
      <div class="loader-container">
        <span id="btn-loader">
          <span class="loader-alt"></span>
        </span>
      </div>
    `
    }

    getBody = () => {
      // language=HTML
      return `
			<div class="stories">
				${this.getLoader()}
      </div>
    `;
    }

    getEmptyMsg = () => {
      // get the next attribute
      return /*html*/`
      <div class="finish">
        <h2 class="finish__title">Feed is not available!</h2>
        <p class="desc">
          There are no feeds available for this feed. You can always come back later or refresh the page to check for new feeds.
        </p>
      </div>
    `
    }

    getLastMessage = () => {
      // get the next attribute
      return /*html*/`
      <div class="finish">
        <h2 class="finish__title">That's all for now!</h2>
        <p class="desc">
         That's it, you have exhausted our feeds for now. You can always come back later or refresh the page to check for new feeds.
        </p>
      </div>
    `
    }

    getWrongMessage = () => {
      return /* html */`
      <div class="finish">
        <h2 class="finish__title">Oops!</h2>
        <p class="desc">
          An error occurred while retrieving the feeds. Please check your connection and try again.
        </p>
        <button class="finish">Retry</button>
      </div>
    `;
    }


    getStyles() {
      return /* css */`
      <style>
        *,
        *:after,
        *:before {
          box-sizing: border-box !important;
          font-family: inherit;
          -webkit-box-sizing: border-box !important;
        }

        *:focus {
          outline: inherit !important;
        }

        *::-webkit-scrollbar {
          width: 3px;
        }

        *::-webkit-scrollbar-track {
          background: var(--scroll-bar-background);
        }

        *::-webkit-scrollbar-thumb {
          width: 3px;
          background: var(--scroll-bar-linear);
          border-radius: 50px;
        }

        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
          padding: 0;
          margin: 0;
          font-family: inherit;
        }

        p,
        ul,
        ol {
          padding: 0;
          margin: 0;
        }

        a {
          text-decoration: none;
        }

        :host {
          font-size: 16px;
          width: 100%;
          padding: 0;
        }

        div.loader-container {
          position: relative;
          width: 100%;
          height: 150px;
          padding: 20px 0 0 0;
        }

        #btn-loader {
          position: absolute;
          top: 0;
          left: 0;
          bottom: 0;
          right: 0;
          z-index: 5;
          display: flex;
          align-items: center;
          justify-content: center;
          border-radius: inherit;
        }

        #btn-loader > .loader-alt {
          width: 35px;
          aspect-ratio: 1;
          --_g: no-repeat radial-gradient(farthest-side, #18A565 94%, #0000);
          --_g1: no-repeat radial-gradient(farthest-side, #21D029 94%, #0000);
          --_g2: no-repeat radial-gradient(farthest-side, #df791a 94%, #0000);
          --_g3: no-repeat radial-gradient(farthest-side, #f09c4e 94%, #0000);
          background:    var(--_g) 0 0,    var(--_g1) 100% 0,    var(--_g2) 100% 100%,    var(--_g3) 0 100%;
          background-size: 30% 30%;
          animation: l38 .9s infinite ease-in-out;
          -webkit-animation: l38 .9s infinite ease-in-out;
        }

        #btn-loader > .loader {
          width: 20px;
          aspect-ratio: 1;
          --_g: no-repeat radial-gradient(farthest-side, #ffffff 94%, #0000);
          --_g1: no-repeat radial-gradient(farthest-side, #ffffff 94%, #0000);
          --_g2: no-repeat radial-gradient(farthest-side, #df791a 94%, #0000);
          --_g3: no-repeat radial-gradient(farthest-side, #f09c4e 94%, #0000);
          background:    var(--_g) 0 0,    var(--_g1) 100% 0,    var(--_g2) 100% 100%,    var(--_g3) 0 100%;
          background-size: 30% 30%;
          animation: l38 .9s infinite ease-in-out;
          -webkit-animation: l38 .9s infinite ease-in-out;
        }

        @keyframes l38 {
          100% {
            background-position: 100% 0, 100% 100%, 0 100%, 0 0
          }
        }

        div.stories {
          padding: 0;
          width: 100%;
          display: flex;
          flex-flow: column;
          gap: 0;
        }

        div.finish {
          padding: 10px 0 40px;
          width: 100%;
          min-width: 100%;
          height: auto;
          display: flex;
          flex-flow: column;
          justify-content: center;
          align-items: center;
          gap: 5px;
        }

        div.finish > h2.finish__title {
          margin: 10px 0 0 0;
          font-size: 1rem;
          font-weight: 500;
          font-family: var(--font-read), sans-serif;
          color: var(--text-color);
        }

        div.finish > p.desc {
          margin: 0;
          font-size: 0.85rem;
          font-family: var(--font-read), sans-serif;
          color: var(--gray-color);
          line-height: 1.4;
          text-align: center;
        }

        div.finish > button.finish {
          border: none;
          background: var(--accent-linear);
          font-family: var(--font-main), sans-serif;
          text-decoration: none;
          color: var(--white-color);
          margin: 10px 0 0;
          font-size: 1rem;
          font-weight: 500;
          cursor: pointer;
          display: flex;
          width: max-content;
          flex-flow: row;
          align-items: center;
          text-transform: capitalize;
          justify-content: center;
          padding: 7px 18px 8px;
          border-radius: 50px;
          -webkit-border-radius: 50px;
          -moz-border-radius: 50px;
        }

        @media screen and (max-width:660px) {
          a,
          div.finish > button.finish {
            cursor: default !important;
          }
        }
      </style>
    `;
    }
  }

  class UpdateFeed extends HTMLElement {
    constructor() {
      // We are not even going to touch this.
      super();

      // let's create our shadow root
      this.shadowObj = this.attachShadow({ mode: "open" });

      this._block = false;
      this._empty = false;
      this._page = this.parseToNumber(this.getAttribute('page'));
      this._url = this.getAttribute('url');

      this.render();
    }

    render() {
      this.shadowObj.innerHTML = this.getTemplate();
    }

    connectedCallback() {
      const contentContainer = this.shadowObj.querySelector('.activities');

      this.fetchActivities(contentContainer);

      // watch event 
      setTimeout(() => {
        this.scrollEvent(contentContainer);
      }, 3000);
    }

    activateRefresh = () => {
      const outerThis = this;
      const finish = this.shadowObj.querySelector('.finish');
      if (finish) {
        const btn = finish.querySelector('button.finish');
        btn.addEventListener('click', () => {
          // unblock the fetching
          outerThis._block = false;
          outerThis._empty = false;
          
          // re fetch the content
          const activitiesContainer = outerThis.shadowObj.querySelector('.activities');

          // select finish
          const finishContainer =  activitiesContainer.querySelector('div.finish');

          if (finishContainer) {
            finishContainer.remove();
          }

          // set the loader
          activitiesContainer.insertAdjacentHTML('beforeend', outerThis.getLoader());

          setTimeout(() => {
            outerThis.fetchActivities(activitiesContainer);
          }, 1000);
        });
      }
    }

    fetching = async (url, activitiesContainer) => {
      const outerThis = this;

      try {
        const response = await this.fetchWithTimeout(url);
        const data = await response.json();

        if(!data.success ||!data.updates) {
          outerThis._empty = true;
          outerThis._block = true;
          outerThis.populateActivities(outerThis.getWrongMessage(), activitiesContainer);
          outerThis.activateRefresh();
          return;
        }

        if (data.updates.length === 0 && outerThis._page === 1) {
          outerThis._empty = true;
          outerThis._block = true;
          outerThis.populateActivities(outerThis.getEmptyMsg(), activitiesContainer);
        } else if (data.updates.length < 10) {
          outerThis._empty = true;
          outerThis._block = true;
          const content = outerThis.mapData(data.updates);
          outerThis.populateActivities(content, activitiesContainer);
          outerThis.populateActivities(outerThis.getLastMessage(), activitiesContainer);
        }
        else {
          outerThis._empty = false;
          outerThis._block = false;
          const content = outerThis.mapData(data.updates);
          outerThis.populateActivities(content, activitiesContainer);
        }
      } catch (error) {
        // console.log(error)
        outerThis._empty = true;
        outerThis._block = true;
        outerThis.populateActivities(outerThis.getWrongMessage(), activitiesContainer);
        outerThis.activateRefresh();
      }
    }

    fetchActivities = activitiesContainer => {
      const outerThis = this;
      const url = `${this._url}?page=${this._page}`;

      if (!this._block && !this._empty) {
        outerThis._empty = true;
        outerThis._block = true;
        setTimeout(() => {
          // fetch the updates
          outerThis.fetching(url, activitiesContainer);
        }, 2000);
      }
    }

    populateActivities = (content, activitiesContainer) => {
      // get the loader and remove it
      const loader = activitiesContainer.querySelector('.loader-container');
      if (loader) {
        loader.remove();
      }

      // insert the content
      activitiesContainer.insertAdjacentHTML('beforeend', content);
    }

    scrollEvent = activitiesContainer => {
      const outerThis = this;
      window.addEventListener('scroll', function () {
        let margin = document.body.clientHeight - window.innerHeight - 150;
        if (window.scrollY > margin && !outerThis._empty && !outerThis._block) {
          outerThis._page += 1;
          outerThis.populateActivities(outerThis.getLoader(), activitiesContainer);
          outerThis.fetchActivities(activitiesContainer);
        }
      });

      // Launch scroll event
      const scrollEvent = new Event('scroll');
      window.dispatchEvent(scrollEvent);
    }

    mapData = updates => {
      return updates.map(update => {
        return /*html*/`
        <update-item id="${update.id}" hash="${update.target}" time="${update.createdAt}" kind="${update.kind}" read="${update.read}"
          to="${update.to}" verb="${update.verb}" action="${update.action}" author="${update.author}" name="${update.name}">
          ${update.content}
        </update-item>
      `
      }).join('');
    }

    fetchWithTimeout = async (url, options = {}, timeout = 9500) => {
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), timeout);
    
      try {
        const response = await fetch(url, {
          ...options,
          signal: controller.signal
        });

        return response;
      } catch (error) {
        if (error.name === 'AbortError') {
          throw new Error('Request timed out');
        }
        throw new Error(`Network error: ${error.message}`);
      } finally {
        clearTimeout(timeoutId);
      }
    }

    parseToNumber = num_str => {
      // Try parsing the string to an integer
      const num = parseInt(num_str);

      // Check if parsing was successful
      if (!isNaN(num)) {
        return num;
      } else {
        return 0;
      }
    }

    getTemplate = () => {
      // Show HTML Here
      return `
      ${this.getBody()}
      ${this.getStyles()}
    `;
    }

    getLoader() {
      return /* html */`
      <div class="loader-container">
        <span id="btn-loader">
          <span class="loader-alt"></span>
        </span>
      </div>
    `
    }

    getBody = () => {
      // language=HTML
      return `
			<div class="activities">
				${this.getLoader()}
      </div>
    `;
    }

    getEmptyMsg = () => {
      // get the next attribute
      return /*html*/`
      <div class="finish">
        <h2 class="finish__title">You no updates yet!</h2>
        <p class="desc">
          Your updates will appear here once people start interacting with your content on the platform.
        </p>
      </div>
    `
    }

    getLastMessage = () => {
      // get the next attribute
      return /*html*/`
      <div class="finish">
        <h2 class="finish__title">That's all for now!</h2>
        <p class="desc"> That's it, you have reached the end of your updates</p>
      </div>
    `
    }

    getWrongMessage = () => {
      // get the next attribute
      return /*html*/`
      <div class="finish">
        <h2 class="finish__title">Something went wrong!</h2>
        <p class="desc">
         An error occurred while fetching your updates feed. Please check your connection and try again.
        </p>
        <button class="finish">Retry</button>
      </div>
    `
    }

    getStyles() {
      return /* css */`
      <style>
        *,
        *:after,
        *:before {
          box-sizing: border-box !important;
          font-family: inherit;
          -webkit-box-sizing: border-box !important;
        }

        *:focus {
          outline: inherit !important;
        }

        *::-webkit-scrollbar {
          width: 3px;
        }

        *::-webkit-scrollbar-track {
          background: var(--scroll-bar-background);
        }

        *::-webkit-scrollbar-thumb {
          width: 3px;
          background: var(--scroll-bar-linear);
          border-radius: 50px;
        }

        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
          padding: 0;
          margin: 0;
          font-family: inherit;
        }

        p,
        ul,
        ol {
          padding: 0;
          margin: 0;
        }

        a {
          text-decoration: none;
        }

        :host {
          font-size: 16px;
          display: flex;
          flex-flow: column;
          gap: 0;
          padding: 5px 0 10px;
          width: 100%;
        }

        div.loader-container {
          position: relative;
          width: 100%;
          height: 150px;
          padding: 20px 0 0 0;
        }

        #btn-loader {
          position: absolute;
          top: 0;
          left: 0;
          bottom: 0;
          right: 0;
          z-index: 5;
          display: flex;
          align-items: center;
          justify-content: center;
          border-radius: inherit;
        }

        #btn-loader > .loader-alt {
          width: 35px;
          aspect-ratio: 1;
          --_g: no-repeat radial-gradient(farthest-side, #18A565 94%, #0000);
          --_g1: no-repeat radial-gradient(farthest-side, #21D029 94%, #0000);
          --_g2: no-repeat radial-gradient(farthest-side, #df791a 94%, #0000);
          --_g3: no-repeat radial-gradient(farthest-side, #f09c4e 94%, #0000);
          background:    var(--_g) 0 0,    var(--_g1) 100% 0,    var(--_g2) 100% 100%,    var(--_g3) 0 100%;
          background-size: 30% 30%;
          animation: l38 .9s infinite ease-in-out;
          -webkit-animation: l38 .9s infinite ease-in-out;
        }

        #btn-loader > .loader {
          width: 20px;
          aspect-ratio: 1;
          --_g: no-repeat radial-gradient(farthest-side, #ffffff 94%, #0000);
          --_g1: no-repeat radial-gradient(farthest-side, #ffffff 94%, #0000);
          --_g2: no-repeat radial-gradient(farthest-side, #df791a 94%, #0000);
          --_g3: no-repeat radial-gradient(farthest-side, #f09c4e 94%, #0000);
          background:    var(--_g) 0 0,    var(--_g1) 100% 0,    var(--_g2) 100% 100%,    var(--_g3) 0 100%;
          background-size: 30% 30%;
          animation: l38 .9s infinite ease-in-out;
          -webkit-animation: l38 .9s infinite ease-in-out;
        }

        @keyframes l38 {
          100% {
            background-position: 100% 0, 100% 100%, 0 100%, 0 0
          }
        }

        .activities {
          display: flex;
          flex-flow: column;
          gap: 0;
          padding: 0;
          width: 100%;
        }

        div.finish {
          padding: 10px 0 40px;
          width: 100%;
          min-width: 100%;
          height: auto;
          display: flex;
          flex-flow: column;
          justify-content: center;
          align-items: center;
          gap: 5px;
        }

        div.empty {
          padding: 10px 0;
          width: 100%;
          min-width: 100%;
          height: auto;
          display: flex;
          flex-flow: column;
          justify-content: center;
          align-items: center;
          gap: 5px;
        }

        div.finish > h2.finish__title {
          margin: 10px 0 0 0;
          font-size: 1.15rem;
          font-weight: 500;
          font-family: var(--font-read), sans-serif;
          color: var(--text-color);
        }

        div.empty p.desc,
        div.finish > p.desc {
          margin: 0;
          font-size: 0.85rem;
          font-family: var(--font-read), sans-serif;
          color: var(--gray-color);
          line-height: 1.4;
          text-align: center;
        }

        div.finish > button.finish {
          border: none;
          background: var(--accent-linear);
          font-family: var(--font-main), sans-serif;
          text-decoration: none;
          color: var(--white-color);
          margin: 10px 0 0;
          font-size: 1rem;
          font-weight: 500;
          cursor: pointer;
          display: flex;
          width: max-content;
          flex-flow: row;
          align-items: center;
          text-transform: capitalize;
          justify-content: center;
          padding: 7px 18px 8px;
          border-radius: 50px;
          -webkit-border-radius: 50px;
          -moz-border-radius: 50px;
        }

        @media screen and (max-width:660px) {
          a,
          div.finish > button.finish {
            cursor: default !important;
          }
        }
      </style>
    `;
    }
  }

  class ContentFeed extends HTMLElement {
    constructor() {
      // We are not even going to touch this.
      super();

      // let's create our shadow root
      this.shadowObj = this.attachShadow({ mode: "open" });

      this._kind = this.getAttribute('kind');

      this._block = false;
      this._empty = false;
      this._page = this.parseToNumber(this.getAttribute('page'));
      this._url = this.getAttribute('api');

      this.render();
    }

    render() {
      this.shadowObj.innerHTML = this.getTemplate();
    }

    connectedCallback() {
      const contentContainer = this.shadowObj.querySelector('.activities');

      this.fetchFeeds(contentContainer);

      // watch event 
      setTimeout(() => {
        this.scrollEvent(contentContainer);
      }, 3000);
    }

    activateRefresh = () => {
      const outerThis = this;
      const finish = this.shadowObj.querySelector('.finish');
      if (finish) {
        const btn = finish.querySelector('button.finish');
        btn.addEventListener('click', () => {
          // unblock the fetching
          outerThis._block = false;
          outerThis._empty = false;
          
          // re fetch the content
          const feedContainer = outerThis.shadowObj.querySelector('.activities');

          // select finish
          const finishContainer =  feedContainer.querySelector('div.finish');

          if (finishContainer) {
            finishContainer.remove();
          }

          // set the loader
          feedContainer.insertAdjacentHTML('beforeend', outerThis.getLoader());

          setTimeout(() => {
            outerThis.fetchFeeds(feedContainer);
          }, 1000);
        });
      }
    }

    fetching = async (url, feedContainer) => {
      const outerThis = this;

      try {
        const response = await this.fetchWithTimeout(url);
        const data = await response.json();

        if (!data.success) {
          outerThis._empty = true;
          outerThis._block = true;
          outerThis.populateFeeds(outerThis.getWrongMessage(), feedContainer);
          outerThis.activateRefresh();
          return;
        }

        if (data.stories) {
          if (data.stories.length === 0 && outerThis._page === 1) {
            outerThis._empty = true;
            outerThis._block = true;
            outerThis.populateFeeds(outerThis.getEmptyMsg(), feedContainer);
            
          } else if (data.stories.length < 10) {
            outerThis._empty = true;
            outerThis._block = true;
            const content = outerThis.mapStories(data.stories);
            outerThis.populateFeeds(content, feedContainer);
            outerThis.populateFeeds(outerThis.getLastMessage(), feedContainer);
          }
          else {
            outerThis._empty = false;
            outerThis._block = false;
            const content = outerThis.mapStories(data.stories);
            outerThis.populateFeeds(content, feedContainer);
          }
        }
        else if (data.replies) {
          if (data.replies.length === 0 && outerThis._page === 1) {
            outerThis._empty = true;
            outerThis._block = true;
            outerThis.populateFeeds(outerThis.getEmptyMsg(), feedContainer);
          } else if (data.replies.length < 10) {
            outerThis._empty = true;
            outerThis._block = true;
            const content = outerThis.mapReplies(data.replies);
            outerThis.populateFeeds(content, feedContainer);
            outerThis.populateFeeds(outerThis.getLastMessage(), feedContainer);
          }
          else {
            outerThis._empty = false;
            outerThis._block = false;
            const content = outerThis.mapReplies(data.replies);
            outerThis.populateFeeds(content, feedContainer);
          }
        } else {
          throw new Error("Stories or replies are not defined!");
        }
      } catch (error) {
        // console.log(error)
        outerThis._empty = true;
        outerThis._block = true;
        outerThis.populateFeeds(outerThis.getWrongMessage(), feedContainer);
        outerThis.activateRefresh();
      }
    }

    fetchFeeds = feedContainer => {
      const outerThis = this;
      const url = `${this._url}?page=${this._page}`;

      if (!this._block && !this._empty) {
        outerThis._empty = true;
        outerThis._block = true;
        setTimeout(() => {
          // fetch the stories
          outerThis.fetching(url, feedContainer);
        }, 2000);
      }
    }

    populateFeeds = (content, feedContainer) => {
      // get the loader and remove it
      const loader = feedContainer.querySelector('.loader-container');
      if (loader) {
        loader.remove();
      }

      // insert the content
      feedContainer.insertAdjacentHTML('beforeend', content);
    }

    scrollEvent = feedContainer => {
      const outerThis = this;
      window.addEventListener('scroll', function () {
        let margin = document.body.clientHeight - window.innerHeight - 150;
        if (window.scrollY > margin && !outerThis._empty && !outerThis._block) {
          outerThis._page += 1;
          outerThis.populateFeeds(outerThis.getLoader(), feedContainer);
          outerThis.fetchFeeds(feedContainer);
        }
      });

      // Launch scroll event
      const scrollEvent = new Event('scroll');
      window.dispatchEvent(scrollEvent);
    }

    mapStories= stories => {
      return stories.map(story => {
        const author = story.story_author;
        const url = `/p/${story.hash.toLowerCase()}`;
        const vote = story.kind === "poll" ? `
        voted="${story.option ? 'true' : 'false'}" selected="${story.option}" end-time="${story.end}" 
        options='${story.poll}' votes="${story.votes}" 
      ` : '';
        let bio = author.bio === null ? 'This user has not added a bio yet.' : author.bio;
        // replace all " and ' with &quot; and &apos; to avoid breaking the html
        bio = bio.replace(/"/g, '&quot;').replace(/'/g, '&apos;');
        const images = story.images ? story.images.join(',') : null;
        return /*html*/`
        <content-story published="${story.published}" kind="${story.kind}" url="${url}" hash="${story.hash}" likes="${story.likes}" 
          replies="${story.replies}" liked="${story.liked ? 'true' : 'false'}" views="${story.views}" time="${story.createdAt}" images='${images}'
          replies-url="/api/v1${url}/replies" likes-url="/api/v1${url}/likes" story-title="${story.title}" slug="${story.slug}"
          topics="${story.topics.length === 0 ? 'story' : story.topics}" ${vote} author-contact='${author.contact ? JSON.stringify(author.contact) : null}'
          author-url="/u/${author.hash}" author-stories="${author.stories}" author-replies="${author.replies}" images='${story.images ? "" : JSON.stringify(story.images)}'
          author-hash="${author.hash}" author-you="${story.you ? 'true' : 'false'}" author-img="${author.picture}" 
          author-verified="${author.verified ? 'true' : 'false'}" author-name="${author.name}" author-followers="${author.followers}" 
          author-following="${author.following}" author-follow="${author.is_following ? 'true' : 'false'}" 
          author-bio="${bio}">
          ${story.content}
        </content-story>
      `
      }).join('');
    }

    mapReplies = replies => {
      return replies.map(reply => {
        const author = reply.reply_author;
        let bio = author.bio === null ? 'This user has not added a bio yet.' : author.bio;
        // replace all " and ' with &quot; and &apos; to avoid breaking the html
        bio = bio.replace(/"/g, '&quot;').replace(/'/g, '&apos;');
        const images = reply.images ? reply.images.join(',') : null;
        return /*html*/`
        <content-reply kind="reply" hash="${reply.hash}" url="/r/${reply.hash.toLowerCase()}" likes="${reply.likes}" replies="${reply.replies}" liked="${reply.liked}"
          views="${reply.views}" time="${reply.createdAt}" replies-url="/api/v1/r/${reply.hash}/replies" likes-url="/api/v1/r/${reply.hash}/likes"
          author-hash="${author.hash}" author-you="${reply.you}" author-url="/u/${author.hash}" author-contact='${author.contact ? JSON.stringify(author.contact) : null}'
          author-stories="${author.stories}" author-replies="${author.replies}" parent="${reply.story ? reply.story : reply.reply}" images='${images}'
          author-img="${author.picture}" author-verified="${author.verified}" author-name="${author.name}" author-followers="${author.followers}"
          author-following="${author.following}" author-follow="${author.is_following}" author-bio="${bio}">
          ${reply.content}
        </content-reply>
      `
      }).join('');
    }

    fetchWithTimeout = async (url, options = {}, timeout = 9500) => {
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), timeout);
    
      try {
        const response = await fetch(url, {
          ...options,
          signal: controller.signal
        });

        return response;
      } catch (error) {
        if (error.name === 'AbortError') {
          throw new Error('Request timed out');
        }
        throw new Error(`Network error: ${error.message}`);
      } finally {
        clearTimeout(timeoutId);
      }
    };

    parseToNumber = num_str => {
      // Try parsing the string to an integer
      const num = parseInt(num_str);

      // Check if parsing was successful
      if (!isNaN(num)) {
        return num;
      } else {
        return 0;
      }
    }

    getTemplate = () => {
      // Show HTML Here
      return `
      ${this.getBody()}
      ${this.getStyles()}
    `;
    }

    getLoader() {
      return /* html */`
      <div class="loader-container">
        <span id="btn-loader">
          <span class="loader-alt"></span>
        </span>
      </div>
    `
    }

    getBody = () => {
      // language=HTML
      return `
			<div class="activities">
				${this.getLoader()}
      </div>
    `;
    }

    getEmptyMsg = () => {
      // get the next attribute
      return /*html*/`
      <div class="finish">
        <h2 class="finish__title">You have not created any ${this._kind} yet!</h2>
        <p class="desc">
         You can always create a new ${this._kind}, check homepage for more details.
        </p>
      </div>
    `
    }

    getLastMessage = () => {
      // get the next attribute
      return /*html*/`
      <div class="finish">
        <h2 class="finish__title">That's all for now!</h2>
        <p class="desc">
          That's it, you have reached the end of your ${this._kind}.
        </p>
      </div>
    `
    }

    getWrongMessage = () => {
      // get the next attribute
      return /*html*/`
      <div class="finish">
        <h2 class="finish__title">Something went wrong!</h2>
        <p class="desc">
         An error occurred while fetching your content feed. Please check your connection and try again.
        </p>
        <button class="finish">Retry</button>
      </div>
    `
    }

    getStyles() {
      return /* css */`
      <style>
        *,
        *:after,
        *:before {
          box-sizing: border-box !important;
          font-family: inherit;
          -webkit-box-sizing: border-box !important;
        }

        *:focus {
          outline: inherit !important;
        }

        *::-webkit-scrollbar {
          width: 3px;
        }

        *::-webkit-scrollbar-track {
          background: var(--scroll-bar-background);
        }

        *::-webkit-scrollbar-thumb {
          width: 3px;
          background: var(--scroll-bar-linear);
          border-radius: 50px;
        }

        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
          padding: 0;
          margin: 0;
          font-family: inherit;
        }

        p,
        ul,
        ol {
          padding: 0;
          margin: 0;
        }

        a {
          text-decoration: none;
        }

        :host {
          font-size: 16px;
          display: flex;
          flex-flow: column;
          gap: 0;
          padding: 5px 0 10px;
          width: 100%;
        }

        div.loader-container {
          position: relative;
          width: 100%;
          height: 150px;
          padding: 20px 0 0 0;
        }

        #btn-loader {
          position: absolute;
          top: 0;
          left: 0;
          bottom: 0;
          right: 0;
          z-index: 5;
          display: flex;
          align-items: center;
          justify-content: center;
          border-radius: inherit;
        }

        #btn-loader > .loader-alt {
          width: 35px;
          aspect-ratio: 1;
          --_g: no-repeat radial-gradient(farthest-side, #18A565 94%, #0000);
          --_g1: no-repeat radial-gradient(farthest-side, #21D029 94%, #0000);
          --_g2: no-repeat radial-gradient(farthest-side, #df791a 94%, #0000);
          --_g3: no-repeat radial-gradient(farthest-side, #f09c4e 94%, #0000);
          background:    var(--_g) 0 0,    var(--_g1) 100% 0,    var(--_g2) 100% 100%,    var(--_g3) 0 100%;
          background-size: 30% 30%;
          animation: l38 .9s infinite ease-in-out;
          -webkit-animation: l38 .9s infinite ease-in-out;
        }

        #btn-loader > .loader {
          width: 20px;
          aspect-ratio: 1;
          --_g: no-repeat radial-gradient(farthest-side, #ffffff 94%, #0000);
          --_g1: no-repeat radial-gradient(farthest-side, #ffffff 94%, #0000);
          --_g2: no-repeat radial-gradient(farthest-side, #df791a 94%, #0000);
          --_g3: no-repeat radial-gradient(farthest-side, #f09c4e 94%, #0000);
          background:    var(--_g) 0 0,    var(--_g1) 100% 0,    var(--_g2) 100% 100%,    var(--_g3) 0 100%;
          background-size: 30% 30%;
          animation: l38 .9s infinite ease-in-out;
          -webkit-animation: l38 .9s infinite ease-in-out;
        }

        @keyframes l38 {
          100% {
            background-position: 100% 0, 100% 100%, 0 100%, 0 0
          }
        }

        .activities {
          display: flex;
          flex-flow: column;
          gap: 0;
          padding: 0;
          width: 100%;
        }

        div.finish {
          padding: 10px 0 40px;
          width: 100%;
          min-width: 100%;
          height: auto;
          display: flex;
          flex-flow: column;
          justify-content: center;
          align-items: center;
          gap: 5px;
        }

        div.empty {
          padding: 10px 0;
          width: 100%;
          min-width: 100%;
          height: auto;
          display: flex;
          flex-flow: column;
          justify-content: center;
          align-items: center;
          gap: 5px;
        }

        div.finish > h2.finish__title {
          margin: 10px 0 0 0;
          font-size: 1.15rem;
          font-weight: 500;
          font-family: var(--font-read), sans-serif;
          color: var(--text-color);
        }

        div.empty p.desc,
        div.finish > p.desc {
          margin: 0;
          font-size: 0.85rem;
          font-family: var(--font-read), sans-serif;
          color: var(--gray-color);
          line-height: 1.4;
          text-align: center;
        }

        div.finish > button.finish {
          border: none;
          background: var(--accent-linear);
          font-family: var(--font-main), sans-serif;
          text-decoration: none;
          color: var(--white-color);
          margin: 10px 0 0;
          font-size: 1rem;
          font-weight: 500;
          cursor: pointer;
          display: flex;
          width: max-content;
          flex-flow: row;
          align-items: center;
          text-transform: capitalize;
          justify-content: center;
          padding: 7px 18px 8px;
          border-radius: 50px;
          -webkit-border-radius: 50px;
          -moz-border-radius: 50px;
        }

        @media screen and (max-width:660px) {
          a,
          div.finish > button.finish {
            cursor: default !important;
          }
        }

      </style>
    `;
    }
  }

  class FormBio extends HTMLElement {
    constructor() {
      // We are not even going to touch this.
      super();

      // let's create our shadow root
      this.shadowObj = this.attachShadow({ mode: "open" });

      this._url = this.getAttribute('api');

      this.render();
    }

    render() {
      this.shadowObj.innerHTML = this.getTemplate();
    }

    connectedCallback() {
      // select form
      const form = this.shadowObj.querySelector('#bio-form');

      // submit form
      this.submitForm(form);
    }

    disableScroll() {
      // Get the current page scroll position
      let scrollTop = window.scrollY || document.documentElement.scrollTop;
      let scrollLeft = window.scrollX || document.documentElement.scrollLeft;
      document.body.classList.add("stop-scrolling");

      // if any scroll is attempted, set this to the previous value
      window.onscroll = function () {
        window.scrollTo(scrollLeft, scrollTop);
      };
    }

    enableScroll() {
      document.body.classList.remove("stop-scrolling");
      window.onscroll = function () { };
    }

    submitForm = async form => {
      const outerThis = this;
      // add submit event listener
      form.addEventListener('submit', async e => {
        e.preventDefault();

        const serverStatus = form.querySelector('.server-status');

        // if server status is already showing, remove it
        if (serverStatus) {
          serverStatus.remove();
        }

        const actions = form.querySelector('.actions');

        // get and validate form data
        const formData = new FormData(form);

        // get form data
        const data = {
          bio: formData.get('bio')
        };

        // check if form data is valid
        if (!data.bio || data.bio.length < 10) {
          
          const errorMsg = 'Bio must be at least 10 characters long';

          // show error message
          actions.insertAdjacentHTML('beforebegin', outerThis.getServerSuccessMsg(false, errorMsg));

          return;
        }

        // check if bio is more than 300 characters
        if (data.bio.length > 300) {
          const errorMsg = 'Bio must not be more than 300 characters long';

          // show error message
          actions.insertAdjacentHTML('beforebegin', outerThis.getServerSuccessMsg(false, errorMsg));

          return;
        }

        // show loader
        const button = form.querySelector('.action.next');
        button.innerHTML = outerThis.getButtonLoader();

        // send data to server
        const options = {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(data)
        };

        try {
          const response = await outerThis.fetchWithTimeout(outerThis._url, options);
          const result = await response.json();

          // check if request was successful
          if (result.success) {
            // show success message
            actions.insertAdjacentHTML('beforebegin', outerThis.getServerSuccessMsg(true, result.message));

            // reset button
            button.innerHTML = '<span class="text">Send</span>';
          } else {
            // show error message
            actions.insertAdjacentHTML('beforebegin', outerThis.getServerSuccessMsg(false, result.message));

            // reset button
            button.innerHTML = '<span class="text">Send</span>';
          }
        }
        catch (error) {
          // show error message
          actions.insertAdjacentHTML('beforebegin', outerThis.getServerSuccessMsg(false, 'An error occurred, please try again'));

          // reset button
          button.innerHTML = '<span class="text">Send</span>';
        }

        // remove success message
        setTimeout(() => {
          const serverStatus = form.querySelector('.server-status');
          if (serverStatus) {
            serverStatus.remove();
          }
        }, 5000);
      });
    }

    fetchWithTimeout = async (url, options = {}, timeout = 9500) => {
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), timeout);
    
      try {
        const response = await fetch(url, {
          ...options,
          signal: controller.signal
        });

        return response;
      } catch (error) {
        if (error.name === 'AbortError') {
          throw new Error('Request timed out');
        }
        throw new Error(`Network error: ${error.message}`);
      } finally {
        clearTimeout(timeoutId);
      }
    };

    getServerSuccessMsg = (success, text) => {
      if (!success) {
        return `
        <p class="server-status">${text}</p>
      `
      }
      return `
      <p class="server-status success">${text}</p>
    `
    }

    getButtonLoader() {
      return `
      <span id="btn-loader">
				<span class="loader"></span>
			</span>
    `
    }

    getTemplate() {
      // Show HTML Here
      return `
      ${this.getBody()}
      ${this.getStyles()}
    `;
    }

    getBody = () => {
      return /* html */`
      ${this.getHeader()}
      <form class="fields bio" id="bio-form">
        <div class="field your-bio">
          <div class="input-group your-bio">
            <label for="bio" class="center">Your bio</label>
            <textarea name="bio" id="bio" cols="30" rows="10" required>${this.getAttribute('bio')}</textarea>
            <span class="status">Bio is required</span>
          </div>
        </div>
        <div class="actions">
          <button type="submit" class="action next">
            <span class="text">Send</span>
          </button>
        </div>
      </form>
    `;
    }

    getHeader = () => {
      return /* html */`
      <div class="top">
        <p class="desc">
          Your bio is a brief summary of yourself. It should be no more than 160 characters in length.
          Use this space to highlight your interests, skills, or any other relevant information about yourself.
        </p>
      </div>
    `;
    }

    getStyles() {
      return /* css */`
      <style>
        *,
        *:after,
        *:before {
          box-sizing: border-box !important;
          font-family: inherit;
          -webkit-box-sizing: border-box !important;
        }

        *:focus {
          outline: inherit !important;
        }

        *::-webkit-scrollbar {
          -webkit-appearance: none;
        }

        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
          padding: 0;
          margin: 0;
          font-family: inherit;
        }

        p,
        ul,
        ol {
          padding: 0;
          margin: 0;
        }

        a {
          text-decoration: none;
        }

        :host {
          font-size: 16px;
          display: flex;
          flex-flow: column;
          gap: 10px;
          padding: 0;
          width: 100%;
        }

        p.server-status {
          margin: 0;
          width: 100%;
          text-align: start;
          font-family: var(--font-read), sans-serif;
          color: var(--error-color);
          font-weight: 500;
          line-height: 1.4;
          font-size: 1.18rem;
        }

        p.server-status.success {
          color: transparent;
          background: var(--accent-linear);
          background-clip: text;
          -webkit-background-clip: text;
        }

        @keyframes l38 {
          100% {
            background-position: 100% 0, 100% 100%, 0 100%, 0 0
          }
        }

        #btn-loader {
          position: absolute;
          top: 0;
          left: 0;
          bottom: 0;
          right: 0;
          z-index: 5;
          display: flex;
          align-items: center;
          justify-content: center;
          border-radius: inherit;
        }

        #btn-loader > .loader-alt {
          width: 20px;
          aspect-ratio: 1;
          --_g: no-repeat radial-gradient(farthest-side, #18A565 94%, #0000);
          --_g1: no-repeat radial-gradient(farthest-side, #21D029 94%, #0000);
          --_g2: no-repeat radial-gradient(farthest-side, #df791a 94%, #0000);
          --_g3: no-repeat radial-gradient(farthest-side, #f09c4e 94%, #0000);
          background:    var(--_g) 0 0,    var(--_g1) 100% 0,    var(--_g2) 100% 100%,    var(--_g3) 0 100%;
          background-size: 30% 30%;
          animation: l38 .9s infinite ease-in-out;
          -webkit-animation: l38 .9s infinite ease-in-out;
        }

        #btn-loader > .loader {
          width: 20px;
          aspect-ratio: 1;
          --_g: no-repeat radial-gradient(farthest-side, #ffffff 94%, #0000);
          --_g1: no-repeat radial-gradient(farthest-side, #ffffff 94%, #0000);
          --_g2: no-repeat radial-gradient(farthest-side, #df791a 94%, #0000);
          --_g3: no-repeat radial-gradient(farthest-side, #f09c4e 94%, #0000);
          background: var(--_g) 0 0,    var(--_g1) 100% 0,    var(--_g2) 100% 100%,    var(--_g3) 0 100%;
          background-size: 30% 30%;
          animation: l38 .9s infinite ease-in-out;
          -webkit-animation: l38 .9s infinite ease-in-out;
        }

        .top {
          display: flex;
          flex-flow: column;
          gap: 5px;
          padding: 0;
          width: 100%;
        }

        .top > h4.title {
          border-bottom: var(--border-mobile);
          display: flex;
          align-items: center;
          color: var(--title-color);
          font-size: 1.3rem;
          font-weight: 500;
          margin: 0;
          padding: 0 0 6px 0;
        }

        .top > .desc {
          margin: 0;
          padding: 10px 0;
          color: var(--text-color);
          font-size: 1rem;
          font-family: var(--font-main), sans-serif;
        }

        form.fields {
          margin: 0;
          width: 100%;
          display: flex;
          flex-flow: column;
          justify-content: center;
          align-items: center;
          gap: 20px;
        }

        form.fields > .field {
          width: 100%;
          display: flex;
          flex-flow: column;
          justify-content: center;
          align-items: start;
          gap: 20px;
        }

        form.fields.center > .field {
          align-items: center;
        }

        form.fields .field .input-group {
          width: 100%;
          display: flex;
          flex-flow: column;
          justify-content: center;
          align-items: start;
          color: var(--text-color);
          gap: 5px;
          position: relative;
          transition: border-color 0.3s ease-in-out;
        }

        form.fields .field.bio .input-group {
          width: 100%;
        }

        form.fields .field.bio .input-group.code,
        form.fields .field.bio .input-group.email {
          grid-column: 1/3;
          width: 100%;
        }

        form.fields .field .input-group > svg {
          position: absolute;
          right: 10px;
          top: 38px;
          width: 20px;
          height: 20px;
        }

        form.fields .field .input-group > svg {
          display: none;
        }

        form.fields .field .input-group.success > svg {
          display: inline-block;
        }

        form.fields .field .input-group.failed > svg {
          display: inline-block;
        }

        form.fields .field .input-group.success > svg {
          color: var(--accent-color);
        }

        form.fields .field .input-group.failed > svg {
          color: var(--error-color);
        }

        form.fields label {
          padding: 0 0 5px 0;
          color: var(--text-color);
        }

        form.fields .field.bio label {
          padding: 0 0 0 5px;
        }

        form.fields label {
          color: var(--label-color);
          font-size: 1.1rem;
          font-family: var(--font-main), sans-serif;
          transition: all 0.3s ease-in-out;
          pointer-events: none;
        }

        form.fields .field input {
          border: var(--input-border);
          background: var(--background);
          font-size: 1rem;
          width: 100%;
          height: 40px;
          outline: none;
          padding: 10px 12px;
          border-radius: 12px;
          color: var(--text-color);
          -webkit-border-radius: 12px;
          -moz-border-radius: 12px;
          -ms-border-radius: 12px;
          -o-border-radius: 12px;
        }

        form.fields textarea {
          border: none;
          border: var(--input-border);
          background: var(--background);
          font-size: 1rem;
          padding: 10px 12px;
          margin: 0;
          width: 100%;
          resize: none;
          height: 120px;
          gap: 5px;
          font-weight: 400;
          color: var(--text-color);
          -ms-overflow-style: none;
          scrollbar-width: none;
          border-radius: 12px;
        }

        form.fields textarea::-webkit-scrollbar {
          display: none !important;
          visibility: hidden;
        }

        form.fields textarea:focus,
        form.fields .field input:focus {
          border: var(--input-border-focus);
        }

        form.fields .field span.wrapper {
          display: flex;
          align-items: center;
          align-items: center;
          gap: 0;
          width: 100%;
        }

        form.fields .field .input-group.success > span.wrapper > input,
        form.fields .field .input-group.success > span.wrapper > input:focus,
        form.fields .field .input-group.success input,
        form.fields .field .input-group.success input:focus {
          border: var(--input-border-focus);
        }

        form.fields .field .input-group.failed > span.wrapper > input,
        form.fields .field .input-group.failed > span.wrapper > input:focus,
        form.fields .field .input-group.failed input,
        form.fields .field .input-group.failed input:focus {
          border: var(--input-border-error);
        }

        form.fields .field .input-group.success span.wrapper > input,
        form.fields .field .input-group.success input {
          color: var(--accent-color);
        }

        form.fields .field .input-group.failed span.wrapper > input,
        form.fields .field .input-group.failed input {
          color: var(--error-color);
        }

        form.fields label.focused {
          top: -10px;
          font-size: 0.9rem;
          background-color: var(--label-focus-background);
          padding: 0 5px;
        }

        form.fields .field span.status {
          color: var(--error-color);
          font-size: 0.95rem;
          display: none;
          padding: 0 0 0 5px;
        }

        form.fields .field .input-group.failed span.status {
          color: var(--error-color);
          font-size: 0.8rem;
          display: inline-block;
        }

        form.fields .field .input-group.success span.status {
          color: var(--accent-color);
          font-size: 0.8rem;
          display: inline-block;
        }

        form.fields .field .input-group.success span.status {
          display: none;
        }

        form.fields .actions {
          display: flex;
          align-items: center;
          justify-content: space-between;
          width: 100%;
          margin: 0 0 0 2px;
        }

        form.fields .actions > .action {
          border: none;
          background: var(--accent-linear);
          font-family: var(--font-main), sans-serif;
          text-decoration: none;
          color: var(--white-color);
          font-size: 1rem;
          font-weight: 600;
          cursor: pointer;
          display: flex;
          flex-flow: row;
          align-items: center;
          text-transform: capitalize;
          justify-content: center;
          padding: 7px 15px 8px;
          min-height: 35px;
          height: 35px;
          min-width: 60px;
          width: max-content;
          position: relative;
          border-radius: 50px;
          -webkit-border-radius: 50px;
          -moz-border-radius: 50px;
        }

        form.fields .actions > .action.prev svg path {
          fill: var(--text-color);
        }

        form.fields .actions > .action.next {
          color: var(--white-color);
          background: var(--stage-no-linear);
        }

        form.fields .actions > .action.next svg path {
          fill: var(--white-color);
        }

        form.fields .actions > .action.disabled {
          pointer-events: none;
        }

        @media screen and (max-width:600px) {
          ::-webkit-scrollbar {
            -webkit-appearance: none;
          }

          .top > .desc {
            margin: 0;
            padding: 6px 0 10px;
            font-size: 1rem;
            line-height: 1.5;
            font-family: var(--font-main), sans-serif;
          }

          form.fields .actions > .action {
            cursor: default !important;
          }
        }
      </style>
    `;
    }
  }

  class FormEmail extends HTMLElement {
    constructor() {
      // We are not even going to touch this.
      super();

      // let's create our shadow root
      this.shadowObj = this.attachShadow({ mode: "open" });

      this._url = this.getAttribute('api');

      this.render();
    }

    render() {
      this.shadowObj.innerHTML = this.getTemplate();
    }

    connectedCallback() {
      // select the form
      const form = this.shadowObj.querySelector('form');

      // add event listener to the form
      this.submitForm(form);
    }

     disableScroll() {
      // Get the current page scroll position
      let scrollTop = window.scrollY || document.documentElement.scrollTop;
      let scrollLeft = window.scrollX || document.documentElement.scrollLeft;
      document.body.classList.add("stop-scrolling");

      // if any scroll is attempted, set this to the previous value
      window.onscroll = function () {
        window.scrollTo(scrollLeft, scrollTop);
      };
    }

    enableScroll() {
      document.body.classList.remove("stop-scrolling");
      window.onscroll = function () { };
    }

    submitForm = async form => {
      const outerThis = this;
      // add submit event listener
      form.addEventListener('submit', async e => {
        e.preventDefault();

        const serverStatus = form.querySelector('.server-status');

        // if server status is already showing, remove it
        if (serverStatus) {
          serverStatus.remove();
        }

        const actions = form.querySelector('.actions');

        // get and validate form data
        const formData = new FormData(form);

        // get form data
        const data = {
          email: formData.get('email')
        };

        // check if form data is valid
        if (!data.email) {
          
          const errorMsg = 'Email must be defined!';

          // show error message
          actions.insertAdjacentHTML('beforebegin', outerThis.getServerSuccessMsg(false, errorMsg));

          return;
        }

        // validate email using regex
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

        if (!emailRegex.test(data.email)) {
          // show error message
          actions.insertAdjacentHTML('beforebegin', outerThis.getServerSuccessMsg(false, 'Invalid email address'));

          return;
        }

        // show loader
        const button = form.querySelector('.action.next');
        button.innerHTML = outerThis.getButtonLoader();

        // send data to server
        const options = {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(data)
        };

        try {
          const response = await outerThis.fetchWithTimeout(outerThis._url, options);
          const result = await response.json();

          // check if request was successful
          if (result.success) {
            // show success message
            actions.insertAdjacentHTML('beforebegin', outerThis.getServerSuccessMsg(true, result.message));

            // reset button
            button.innerHTML = '<span class="text">Send</span>';
          } else {
            // show error message
            actions.insertAdjacentHTML('beforebegin', outerThis.getServerSuccessMsg(false, result.message));

            // reset button
            button.innerHTML = '<span class="text">Send</span>';
          }
        }
        catch (error) {
          // show error message
          actions.insertAdjacentHTML('beforebegin', outerThis.getServerSuccessMsg(false, 'An error occurred, please try again'));

          // reset button
          button.innerHTML = '<span class="text">Send</span>';
        }

        // remove success message
        setTimeout(() => {
          const serverStatus = form.querySelector('.server-status');
          if (serverStatus) {
            serverStatus.remove();
          }
        }, 5000);
      });
    }

    fetchWithTimeout = async (url, options = {}, timeout = 9500) => {
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), timeout);
    
      try {
        const response = await fetch(url, {
          ...options,
          signal: controller.signal
        });

        return response;
      } catch (error) {
        if (error.name === 'AbortError') {
          throw new Error('Request timed out');
        }
        throw new Error(`Network error: ${error.message}`);
      } finally {
        clearTimeout(timeoutId);
      }
    };

    getServerSuccessMsg = (success, text) => {
      if (!success) {
        return `
        <p class="server-status">${text}</p>
      `
      }
      return `
      <p class="server-status success">${text}</p>
    `
    }

    getButtonLoader() {
      return `
      <span id="btn-loader">
				<span class="loader"></span>
			</span>
    `
    }

    getTemplate() {
      // Show HTML Here
      return `
      ${this.getBody()}
      ${this.getStyles()}
    `;
    }

    getBody = () => {
      return /* html */`
      ${this.getHeader()}
      <form class="fields email" id="email-form">
        <div class="field email">
          <div class="input-group email">
            <label for="email" class="center">Your email</label>
            <input type="email" name="email" value="${this.getAttribute('email')}" id="email" placeholder="e.g john@example.com" />
            <span class="status">Email is required</span>
          </div>
        </div>
        <div class="actions">
          <button type="submit" class="action next">
            <span class="text">Send</span>
          </button>
        </div>
      </form>
    `;
    }

    getHeader = () => {
      return /* html */`
      <div class="top">
        <p class="desc">
          Your email is how you will recover your account in case you forget your password. You can also use it to log in, reset your password, and receive notifications.
        </p>
      </div>
    `;
    }

    getStyles() {
      return /* css */`
      <style>
        *,
        *:after,
        *:before {
          box-sizing: border-box !important;
          font-family: inherit;
          -webkit-box-sizing: border-box !important;
        }

        *:focus {
          outline: inherit !important;
        }

        *::-webkit-scrollbar {
          -webkit-appearance: none;
        }

        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
          padding: 0;
          margin: 0;
          font-family: inherit;
        }

        p,
        ul,
        ol {
          padding: 0;
          margin: 0;
        }

        a {
          text-decoration: none;
        }

        :host {
          font-size: 16px;
          display: flex;
          flex-flow: column;
          gap: 10px;
          padding: 0;
          width: 100%;
        }

        p.server-status {
          margin: 0;
          width: 100%;
          text-align: start;
          font-family: var(--font-read), sans-serif;
          color: var(--error-color);
          font-weight: 500;
          line-height: 1.4;
          font-size: 1.18rem;
        }

        p.server-status.success {
          color: transparent;
          background: var(--accent-linear);
          background-clip: text;
          -webkit-background-clip: text;
        }

        @keyframes l38 {
          100% {
            background-position: 100% 0, 100% 100%, 0 100%, 0 0
          }
        }

        #btn-loader {
          position: absolute;
          top: 0;
          left: 0;
          bottom: 0;
          right: 0;
          z-index: 5;
          display: flex;
          align-items: center;
          justify-content: center;
          border-radius: inherit;
        }

        #btn-loader > .loader-alt {
          width: 20px;
          aspect-ratio: 1;
          --_g: no-repeat radial-gradient(farthest-side, #18A565 94%, #0000);
          --_g1: no-repeat radial-gradient(farthest-side, #21D029 94%, #0000);
          --_g2: no-repeat radial-gradient(farthest-side, #df791a 94%, #0000);
          --_g3: no-repeat radial-gradient(farthest-side, #f09c4e 94%, #0000);
          background:    var(--_g) 0 0,    var(--_g1) 100% 0,    var(--_g2) 100% 100%,    var(--_g3) 0 100%;
          background-size: 30% 30%;
          animation: l38 .9s infinite ease-in-out;
          -webkit-animation: l38 .9s infinite ease-in-out;
        }

        #btn-loader > .loader {
          width: 20px;
          aspect-ratio: 1;
          --_g: no-repeat radial-gradient(farthest-side, #ffffff 94%, #0000);
          --_g1: no-repeat radial-gradient(farthest-side, #ffffff 94%, #0000);
          --_g2: no-repeat radial-gradient(farthest-side, #df791a 94%, #0000);
          --_g3: no-repeat radial-gradient(farthest-side, #f09c4e 94%, #0000);
          background:    var(--_g) 0 0,    var(--_g1) 100% 0,    var(--_g2) 100% 100%,    var(--_g3) 0 100%;
          background-size: 30% 30%;
          animation: l38 .9s infinite ease-in-out;
          -webkit-animation: l38 .9s infinite ease-in-out;
        }

        .top {
          display: flex;
          flex-flow: column;
          gap: 5px;
          padding: 0;
          width: 100%;
        }

        .top > h4.title {
          border-bottom: var(--border-mobile);
          display: flex;
          align-items: center;
          color: var(--title-color);
          font-size: 1.3rem;
          font-weight: 500;
          margin: 0;
          padding: 0 0 6px 0;
        }

        .top > .desc {
          margin: 0;
          padding: 10px 0;
          color: var(--text-color);
          font-size: 1rem;
          font-family: var(--font-main), sans-serif;
        }

        form.fields {
          margin: 0;
          width: 100%;
          display: flex;
          flex-flow: column;
          justify-content: center;
          align-items: center;
          gap: 20px;
        }

        form.fields > .field {
          width: 100%;
          display: flex;
          flex-flow: column;
          justify-content: center;
          align-items: start;
          gap: 20px;
        }

        form.fields.center > .field {
          align-items: center;
        }

        form.fields .field .input-group {
          width: 100%;
          display: flex;
          flex-flow: column;
          justify-content: center;
          align-items: start;
          color: var(--text-color);
          gap: 5px;
          position: relative;
          transition: border-color 0.3s ease-in-out;
        }

        form.fields .field.bio .input-group {
          width: 100%;
        }

        form.fields .field.bio .input-group.code,
        form.fields .field.bio .input-group.email {
          grid-column: 1/3;
          width: 100%;
        }

        form.fields .field .input-group > svg {
          position: absolute;
          right: 10px;
          top: 38px;
          width: 20px;
          height: 20px;
        }

        form.fields .field .input-group > svg {
          display: none;
        }

        form.fields .field .input-group.success > svg {
          display: inline-block;
        }

        form.fields .field .input-group.failed > svg {
          display: inline-block;
        }

        form.fields .field .input-group.success > svg {
          color: var(--accent-color);
        }

        form.fields .field .input-group.failed > svg {
          color: var(--error-color);
        }

        form.fields label {
          padding: 0 0 5px 0;
          color: var(--text-color);
        }

        form.fields .field.bio label {
          padding: 0 0 0 5px;
        }

        form.fields label {
          color: var(--label-color);
          font-size: 1.1rem;
          font-family: var(--font-main), sans-serif;
          transition: all 0.3s ease-in-out;
          pointer-events: none;
        }

        form.fields .field input {
          border: var(--input-border);
          background: var(--background);
          font-size: 1rem;
          width: 100%;
          height: 40px;
          outline: none;
          padding: 10px 12px;
          border-radius: 12px;
          color: var(--text-color);
          -webkit-border-radius: 12px;
          -moz-border-radius: 12px;
          -ms-border-radius: 12px;
          -o-border-radius: 12px;
        }

        form.fields .field input {
          border: var(--input-border);
          background-color: var(--background) !important;
          font-size: 1rem;
          width: 100%;
          height: 40px;
          outline: none;
          padding: 10px 12px;
          border-radius: 12px;
          color: var(--text-color);
        }
        
        form.fields .field input:-webkit-autofill,
        form.fields .field input:-webkit-autofill:hover, 
        form.fields .field input:-webkit-autofill:focus {
          -webkit-box-shadow: 0 0 0px 1000px var(--background) inset;
          -webkit-text-fill-color: var(--text-color) !important;
          transition: background-color 5000s ease-in-out 0s;
          color: var(--text-color) !important;
        }
        
        form.fields .field input:autofill {
          filter: none;
          color: var(--text-color) !important;
        }

        form.fields .field input:focus {
          border: var(--input-border-focus);
        }

        form.fields .field span.wrapper {
          display: flex;
          align-items: center;
          align-items: center;
          gap: 0;
          width: 100%;
        }

        form.fields .field .input-group.success > span.wrapper > input,
        form.fields .field .input-group.success > span.wrapper > input:focus,
        form.fields .field .input-group.success input,
        form.fields .field .input-group.success input:focus {
          border: var(--input-border-focus);
        }

        form.fields .field .input-group.failed > span.wrapper > input,
        form.fields .field .input-group.failed > span.wrapper > input:focus,
        form.fields .field .input-group.failed input,
        form.fields .field .input-group.failed input:focus {
          border: var(--input-border-error);
        }

        form.fields .field .input-group.success span.wrapper > input,
        form.fields .field .input-group.success input {
          color: var(--accent-color);
        }

        form.fields .field .input-group.failed span.wrapper > input,
        form.fields .field .input-group.failed input {
          color: var(--error-color);
        }

        form.fields label.focused {
          top: -10px;
          font-size: 0.9rem;
          background-color: var(--label-focus-background);
          padding: 0 5px;
        }

        form.fields .field span.status {
          color: var(--error-color);
          font-size: 0.95rem;
          display: none;
          padding: 0 0 0 5px;
        }

        form.fields .field .input-group.failed span.status {
          color: var(--error-color);
          font-size: 0.8rem;
          display: inline-block;
        }

        form.fields .field .input-group.success span.status {
          color: var(--accent-color);
          font-size: 0.8rem;
          display: inline-block;
        }

        form.fields .field .input-group.success span.status {
          display: none;
        }

        form.fields .actions {
          display: flex;
          align-items: center;
          justify-content: space-between;
          width: 100%;
          margin: 0 0 0 2px;
        }

        form.fields .actions > .action {
          border: none;
          background: var(--accent-linear);
          font-family: var(--font-main), sans-serif;
          text-decoration: none;
          color: var(--white-color);
          font-size: 1rem;
          font-weight: 600;
          cursor: pointer;
          display: flex;
          flex-flow: row;
          align-items: center;
          text-transform: capitalize;
          justify-content: center;
          padding: 7px 15px 8px;
          min-height: 35px;
          height: 35px;
          min-width: 60px;
          width: max-content;
          position: relative;
          border-radius: 50px;
          -webkit-border-radius: 50px;
          -moz-border-radius: 50px;
        }

        form.fields .actions > .action.prev svg path {
          fill: var(--text-color);
        }

        form.fields .actions > .action.next {
          color: var(--white-color);
          background: var(--stage-no-linear);
        }

        form.fields .actions > .action.next svg path {
          fill: var(--white-color);
        }

        form.fields .actions > .action.disabled {
          pointer-events: none;
        }

        @media screen and (max-width:600px) {
          ::-webkit-scrollbar {
            -webkit-appearance: none;
          }

          .top > .desc {
            margin: 0;
            padding: 6px 0 10px;
            font-size: 1rem;
            line-height: 1.5;
            font-family: var(--font-main), sans-serif;
          }

          form.fields .actions > .action {
            cursor: default !important;
          }
        }
      </style>
    `;
    }
  }

  class FormPassword extends HTMLElement {
    constructor() {
      // We are not even going to touch this.
      super();

      // let's create our shadow root
      this.shadowObj = this.attachShadow({ mode: "open" });

      // get the url
      this._url = this.getAttribute('api');

      this.render();
    }

    render() {
      this.shadowObj.innerHTML = this.getTemplate();
    }

    connectedCallback() {
      // Get the form
      const form = this.shadowObj.querySelector('form');

      // Submit form
      this.submitForm(form);
    }

     disableScroll() {
      // Get the current page scroll position
      let scrollTop = window.scrollY || document.documentElement.scrollTop;
      let scrollLeft = window.scrollX || document.documentElement.scrollLeft;
      document.body.classList.add("stop-scrolling");

      // if any scroll is attempted, set this to the previous value
      window.onscroll = function () {
        window.scrollTo(scrollLeft, scrollTop);
      };
    }

    enableScroll() {
      document.body.classList.remove("stop-scrolling");
      window.onscroll = function () { };
    }

    submitForm = async form => {
      const outerThis = this;
      // add submit event listener
      form.addEventListener('submit', async e => {
        e.preventDefault();

        const serverStatus = form.querySelector('.server-status');

        // if server status is already showing, remove it
        if (serverStatus) {
          serverStatus.remove();
        }

        const actions = form.querySelector('.actions');

        // get and validate form data
        const formData = new FormData(form);

        // get form data
        const data = {
          old_password: formData.get('current-password').trim(),
          password: formData.get('new-password').trim(),
          confirm_password: formData.get('confirm-password').trim()
        };

        // check if form data is valid
        if (!data.old_password || !data.password || !data.confirm_password) {
          actions.insertAdjacentHTML('beforebegin', outerThis.getServerSuccessMsg(false, 'All fields are required'));
          return;
        }

        // check if password is i. at least 6 characters long, ii. contains a number, iii. contains a special character, iv. contains an uppercase letter using regex
        const passwordRegex = /^(?=.*\d)(?=.*[!@#$%^&*])(?=.*[a-z])(?=.*[A-Z]).{6,}$/;

        if (!passwordRegex.test(data.password)) {
          actions.insertAdjacentHTML('beforebegin', outerThis.getServerSuccessMsg(false, 'Password must be at least 6 characters long, contain a number, a special character, and an uppercase letter'));
          return;
        }

        // check if new password and confirm password match
        if (data.password !== data.confirm_password) {
          actions.insertAdjacentHTML('beforebegin', outerThis.getServerSuccessMsg(false, 'New password and confirm password do not match'));
          return;
        }

        // show loader
        const button = form.querySelector('.action.next');
        button.innerHTML = outerThis.getButtonLoader();

        // send data to server
        const options = {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(data)
        };

        try {
          const response = await outerThis.fetchWithTimeout(outerThis._url, options);
          const result = await response.json();

          // check if request was successful
          if (result.success) {
            // show success message
            actions.insertAdjacentHTML('beforebegin', outerThis.getServerSuccessMsg(true, result.message));

            // reset button
            button.innerHTML = '<span class="text">Send</span>';
          } else {
            // show error message
            actions.insertAdjacentHTML('beforebegin', outerThis.getServerSuccessMsg(false, result.message));

            // reset button
            button.innerHTML = '<span class="text">Send</span>';
          }
        }
        catch (error) {
          // show error message
          actions.insertAdjacentHTML('beforebegin', outerThis.getServerSuccessMsg(false, 'An error occurred, please try again'));

          // reset button
          button.innerHTML = '<span class="text">Send</span>';
        }

        // remove success message
        setTimeout(() => {
          const serverStatus = form.querySelector('.server-status');
          if (serverStatus) {
            serverStatus.remove();
          }
        }, 5000);
      });
    }

    fetchWithTimeout = async (url, options = {}, timeout = 9500) => {
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), timeout);
    
      try {
        const response = await fetch(url, {
          ...options,
          signal: controller.signal
        });

        return response;
      } catch (error) {
        if (error.name === 'AbortError') {
          throw new Error('Request timed out');
        }
        throw new Error(`Network error: ${error.message}`);
      } finally {
        clearTimeout(timeoutId);
      }
    };

    getServerSuccessMsg = (success, text) => {
      if (!success) {
        return `
        <p class="server-status">${text}</p>
      `
      }
      return `
      <p class="server-status success">${text}</p>
    `
    }

    getButtonLoader() {
      return `
      <span id="btn-loader">
				<span class="loader"></span>
			</span>
    `
    }

    getTemplate() {
      // Show HTML Here
      return `
      ${this.getBody()}
      ${this.getStyles()}
    `;
    }

    getBody = () => {
      return /* html */`
      ${this.getHeader()}
      <form class="fields password" id="password-form">
        <div class="field password">
          <div class="input-group current-password">
            <label for="current-password" class="center">Current password</label>
            <input type="password" name="current-password" id="current-password" placeholder="Enter your current password" />
            <span class="status">Current password is required</span>
          </div>
          <div class="input-group new-password">
            <label for="new-password" class="center">New password</label>
            <input type="password" name="new-password" id="new-password" placeholder="Enter your new password" />
            <span class="status">New password is required</span>
          </div>
          <div class="input-group confirm-password">
            <label for="confirm-password" class="center">Confirm password</label>
            <input type="password" name="confirm-password" id="confirm-password" placeholder="Confirm your new password" />
            <span class="status">Confirm password is required</span>
          </div>
        </div>
        <div class="actions">
          <button type="submit" class="action next">
            <span class="text">Send</span>
          </button>
        </div>
      </form>
    `;
    }

    getHeader = () => {
      return /* html */`
      <div class="top">
        <p class="desc">
          Your password is how you will log in to your account. You can change your password using the form below. You're required to enter your current password, then your new password.
        </p>
      </div>
    `;
    }

    getStyles() {
      return /* css */`
      <style>
        *,
        *:after,
        *:before {
          box-sizing: border-box !important;
          font-family: inherit;
          -webkit-box-sizing: border-box !important;
        }

        *:focus {
          outline: inherit !important;
        }

        *::-webkit-scrollbar {
          -webkit-appearance: none;
        }

        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
          padding: 0;
          margin: 0;
          font-family: inherit;
        }

        p,
        ul,
        ol {
          padding: 0;
          margin: 0;
        }

        a {
          text-decoration: none;
        }

        :host {
          font-size: 16px;
          display: flex;
          flex-flow: column;
          gap: 10px;
          padding: 0;
          width: 100%;
        }

        p.server-status {
          margin: 0;
          width: 100%;
          text-align: start;
          font-family: var(--font-read), sans-serif;
          color: var(--error-color);
          font-weight: 500;
          line-height: 1.4;
          font-size: 1.18rem;
        }

        p.server-status.success {
          color: transparent;
          background: var(--accent-linear);
          background-clip: text;
          -webkit-background-clip: text;
        }

        @keyframes l38 {
          100% {
            background-position: 100% 0, 100% 100%, 0 100%, 0 0
          }
        }

        #btn-loader {
          position: absolute;
          top: 0;
          left: 0;
          bottom: 0;
          right: 0;
          z-index: 5;
          display: flex;
          align-items: center;
          justify-content: center;
          border-radius: inherit;
        }

        #btn-loader > .loader-alt {
          width: 20px;
          aspect-ratio: 1;
          --_g: no-repeat radial-gradient(farthest-side, #18A565 94%, #0000);
          --_g1: no-repeat radial-gradient(farthest-side, #21D029 94%, #0000);
          --_g2: no-repeat radial-gradient(farthest-side, #df791a 94%, #0000);
          --_g3: no-repeat radial-gradient(farthest-side, #f09c4e 94%, #0000);
          background:    var(--_g) 0 0,    var(--_g1) 100% 0,    var(--_g2) 100% 100%,    var(--_g3) 0 100%;
          background-size: 30% 30%;
          animation: l38 .9s infinite ease-in-out;
          -webkit-animation: l38 .9s infinite ease-in-out;
        }

        #btn-loader > .loader {
          width: 20px;
          aspect-ratio: 1;
          --_g: no-repeat radial-gradient(farthest-side, #ffffff 94%, #0000);
          --_g1: no-repeat radial-gradient(farthest-side, #ffffff 94%, #0000);
          --_g2: no-repeat radial-gradient(farthest-side, #df791a 94%, #0000);
          --_g3: no-repeat radial-gradient(farthest-side, #f09c4e 94%, #0000);
          background:    var(--_g) 0 0,    var(--_g1) 100% 0,    var(--_g2) 100% 100%,    var(--_g3) 0 100%;
          background-size: 30% 30%;
          animation: l38 .9s infinite ease-in-out;
          -webkit-animation: l38 .9s infinite ease-in-out;
        }

        .top {
          display: flex;
          flex-flow: column;
          gap: 5px;
          padding: 0;
          width: 100%;
        }

        .top > h4.title {
          border-bottom: var(--border-mobile);
          display: flex;
          align-items: center;
          color: var(--title-color);
          font-size: 1.3rem;
          font-weight: 500;
          margin: 0;
          padding: 0 0 6px 0;
        }

        .top > .desc {
          margin: 0;
          padding: 10px 0;
          color: var(--text-color);
          font-size: 1rem;
          font-family: var(--font-main), sans-serif;
        }

        form.fields {
          margin: 0;
          width: 100%;
          display: flex;
          flex-flow: column;
          justify-content: center;
          align-items: center;
          gap: 20px;
        }

        form.fields > .field {
          width: 100%;
          display: flex;
          flex-flow: column;
          justify-content: center;
          align-items: start;
          gap: 20px;
        }

        form.fields.center > .field {
          align-items: center;
        }

        form.fields .field .input-group {
          width: 100%;
          display: flex;
          flex-flow: column;
          justify-content: center;
          align-items: start;
          color: var(--text-color);
          gap: 5px;
          position: relative;
          transition: border-color 0.3s ease-in-out;
        }

        form.fields .field.bio .input-group {
          width: 100%;
        }

        form.fields .field.bio .input-group.code,
        form.fields .field.bio .input-group.email {
          grid-column: 1/3;
          width: 100%;
        }

        form.fields .field .input-group > svg {
          position: absolute;
          right: 10px;
          top: 38px;
          width: 20px;
          height: 20px;
        }

        form.fields .field .input-group > svg {
          display: none;
        }

        form.fields .field .input-group.success > svg {
          display: inline-block;
        }

        form.fields .field .input-group.failed > svg {
          display: inline-block;
        }

        form.fields .field .input-group.success > svg {
          color: var(--accent-color);
        }

        form.fields .field .input-group.failed > svg {
          color: var(--error-color);
        }

        form.fields label {
          padding: 0 0 5px 0;
          color: var(--text-color);
        }

        form.fields .field.bio label {
          padding: 0 0 0 5px;
        }

        form.fields label {
          color: var(--label-color);
          font-size: 1.1rem;
          font-family: var(--font-main), sans-serif;
          transition: all 0.3s ease-in-out;
          pointer-events: none;
        }

        form.fields .field input {
          border: var(--input-border);
          background-color: var(--background) !important;
          font-size: 1rem;
          width: 100%;
          height: 40px;
          outline: none;
          padding: 10px 12px;
          border-radius: 12px;
          color: var(--text-color);
        }
        
        form.fields .field input:-webkit-autofill,
        form.fields .field input:-webkit-autofill:hover, 
        form.fields .field input:-webkit-autofill:focus {
          -webkit-box-shadow: 0 0 0px 1000px var(--background) inset;
          -webkit-text-fill-color: var(--text-color) !important;
          transition: background-color 5000s ease-in-out 0s;
          color: var(--text-color) !important;
        }
        
        form.fields .field input:autofill {
          filter: none;
          color: var(--text-color) !important;
        }

        form.fields .field input:focus {
          border: var(--input-border-focus);
        }

        form.fields .field span.wrapper {
          display: flex;
          align-items: center;
          align-items: center;
          gap: 0;
          width: 100%;
        }

        form.fields .field .input-group.success > span.wrapper > input,
        form.fields .field .input-group.success > span.wrapper > input:focus,
        form.fields .field .input-group.success input,
        form.fields .field .input-group.success input:focus {
          border: var(--input-border-focus);
        }

        form.fields .field .input-group.failed > span.wrapper > input,
        form.fields .field .input-group.failed > span.wrapper > input:focus,
        form.fields .field .input-group.failed input,
        form.fields .field .input-group.failed input:focus {
          border: var(--input-border-error);
        }

        form.fields .field .input-group.success span.wrapper > input,
        form.fields .field .input-group.success input {
          color: var(--accent-color);
        }

        form.fields .field .input-group.failed span.wrapper > input,
        form.fields .field .input-group.failed input {
          color: var(--error-color);
        }

        form.fields label.focused {
          top: -10px;
          font-size: 0.9rem;
          background-color: var(--label-focus-background);
          padding: 0 5px;
        }

        form.fields .field span.status {
          color: var(--error-color);
          font-size: 0.95rem;
          display: none;
          padding: 0 0 0 5px;
        }

        form.fields .field .input-group.failed span.status {
          color: var(--error-color);
          font-size: 0.8rem;
          display: inline-block;
        }

        form.fields .field .input-group.success span.status {
          color: var(--accent-color);
          font-size: 0.8rem;
          display: inline-block;
        }

        form.fields .field .input-group.success span.status {
          display: none;
        }

        form.fields .actions {
          display: flex;
          align-items: center;
          justify-content: space-between;
          width: 100%;
          margin: 0 0 0 2px;
        }

        form.fields .actions > .action {
          border: none;
          background: var(--accent-linear);
          font-family: var(--font-main), sans-serif;
          text-decoration: none;
          color: var(--white-color);
          font-size: 1rem;
          font-weight: 600;
          cursor: pointer;
          display: flex;
          flex-flow: row;
          align-items: center;
          text-transform: capitalize;
          justify-content: center;
          padding: 7px 15px 8px;
          min-height: 35px;
          height: 35px;
          min-width: 60px;
          width: max-content;
          position: relative;
          border-radius: 50px;
          -webkit-border-radius: 50px;
          -moz-border-radius: 50px;
        }

        form.fields .actions > .action.prev svg path {
          fill: var(--text-color);
        }

        form.fields .actions > .action.next {
          color: var(--white-color);
          background: var(--stage-no-linear);
        }

        form.fields .actions > .action.next svg path {
          fill: var(--white-color);
        }

        form.fields .actions > .action.disabled {
          pointer-events: none;
        }

        @media screen and (max-width:600px) {
          ::-webkit-scrollbar {
            -webkit-appearance: none;
          }

          .top > .desc {
            margin: 0;
            padding: 6px 0 10px;
            font-size: 1rem;
            line-height: 1.5;
            font-family: var(--font-main), sans-serif;
          }

          form.fields .actions > .action {
            cursor: default !important;
          }
        }
      </style>
    `;
    }
  }

  class FormProfile extends HTMLElement {
    constructor() {
      // We are not even going to touch this.
      super();

      // let's create our shadow root
      this.shadowObj = this.attachShadow({ mode: "open" });

      this._url = this.getAttribute('api');

      this.render();
    }

    render() {
      this.shadowObj.innerHTML = this.getTemplate();
    }

    connectedCallback() {
      this.activateForm();

      // get the form
      const form = this.shadowObj.querySelector('form.fields');

      // submit form
      this.submitForm(form);
    }

     disableScroll() {
      // Get the current page scroll position
      let scrollTop = window.scrollY || document.documentElement.scrollTop;
      let scrollLeft = window.scrollX || document.documentElement.scrollLeft;
      document.body.classList.add("stop-scrolling");

      // if any scroll is attempted, set this to the previous value
      window.onscroll = function () {
        window.scrollTo(scrollLeft, scrollTop);
      };
    }

    enableScroll() {
      document.body.classList.remove("stop-scrolling");
      window.onscroll = function () { };
    }

    activateForm = () => {
      const previewContainer = this.shadowObj.querySelector('.image-preview');

      if(previewContainer) {
        const image = previewContainer.querySelector('input[type="file"]');
        image.addEventListener('change', (event) => {
          // console.log('Changed')
          // Get the selected files.
          const imageFiles = event.target.files;

          // Count the number of files selected.
          const imageFilesLength = imageFiles.length;

          //If at least one image is selected, then proceed to display the preview.
          if (imageFilesLength > 0) {
            // Get the image path.
            const imageSrc = URL.createObjectURL(imageFiles[0]);

            //  Add the image as background image.
            previewContainer.style.backgroundImage = `url(${imageSrc})`;
          }
        });
      }
    }

    submitForm = async form => {
      const outerThis = this;
      // add submit event listener
      form.addEventListener('submit', async e => {
        e.preventDefault();

        const serverStatus = form.querySelector('.server-status');

        // if server status is already showing, remove it
        if (serverStatus) {
          serverStatus.remove();
        }

        const actions = form.querySelector('.actions');

        // show loader
        const button = form.querySelector('.action.next');
        button.innerHTML = outerThis.getButtonLoader();

        // get and validate form data
        const formData = new FormData();

        const file = form.querySelector('#profile-image').files[0];

        if (!file) {
          actions.insertAdjacentHTML('beforebegin', outerThis.getServerSuccessMsg(false, 'Please select an image'));

          // reset button
          button.innerHTML = '<span class="text">Send</span>';
          return;
        }

        try {
          // resize image
          const { blob } = await outerThis.resizeImage(file);

          // append image to form data
          formData.append('file', blob, 'file.webp');

          // send data to server
          const options = {
            method: 'PATCH',
            // add a multipart form data
            body: formData
          };

          const response = await outerThis.fetchWithTimeout(outerThis._url, options);
          const result = await response.json();

          // check if request was successful
          if (result.success) {
            // show success message
            actions.insertAdjacentHTML('beforebegin', outerThis.getServerSuccessMsg(true, result.message));

            // reset button
            button.innerHTML = '<span class="text">Send</span>';
          } else {
            // show error message
            actions.insertAdjacentHTML('beforebegin', outerThis.getServerSuccessMsg(false, result.message));

            // reset button
            button.innerHTML = '<span class="text">Send</span>';
          }
        }
        catch (error) {
          // show error message
          actions.insertAdjacentHTML('beforebegin', outerThis.getServerSuccessMsg(false, 'An error occurred, please try again'));

          // reset button
          button.innerHTML = '<span class="text">Send</span>';
        }

        // remove success message
        setTimeout(() => {
          const serverStatus = form.querySelector('.server-status');
          if (serverStatus) {
            serverStatus.remove();
          }
        }, 5000);
      });
    }

    // Function to resize image and crop to square
    resizeImage = async file => {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (event) => {
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const maxSize = 300;
            canvas.width = maxSize;
            canvas.height = maxSize;
            const aspectRatio = img.width / img.height;
            let sourceX = 0;
            let sourceY = 0;
            let sourceWidth = img.width;
            let sourceHeight = img.height;
            if (aspectRatio > 1) {
              sourceX = (img.width - img.height) / 2;
              sourceWidth = img.height;
            } else {
              sourceY = (img.height - img.width) / 2;
              sourceHeight = img.width;
            }
            ctx.drawImage(img, sourceX, sourceY, sourceWidth, sourceHeight, 0, 0, maxSize, maxSize);
            canvas.toBlob(
              (blob) => {
                if (blob) {
                  resolve({ blob, width: maxSize, height: maxSize });
                } else {
                  reject(new Error('Failed to create blob'));
                }
              },
              'image/webp',
              0.9
            );
          };
          img.onerror = () => reject(new Error('Failed to load image'));
          img.src = event.target.result;
        };
        reader.onerror = () => reject(new Error('Failed to read file'));
        reader.readAsDataURL(file);
      });
    }

    fetchWithTimeout = async (url, options = {}, timeout = 9500) => {
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), timeout);
    
      try {
        const response = await fetch(url, {
          ...options,
          signal: controller.signal
        });

        return response;
      } catch (error) {
        if (error.name === 'AbortError') {
          throw new Error('Request timed out');
        }
        throw new Error(`Network error: ${error.message}`);
      } finally {
        clearTimeout(timeoutId);
      }
    };

    getServerSuccessMsg = (success, text) => {
      if (!success) {
        return `
        <p class="server-status">${text}</p>
      `
      }
      return `
      <p class="server-status success">${text}</p>
    `
    }

    getButtonLoader() {
      return `
      <span id="btn-loader">
				<span class="loader"></span>
			</span>
    `
    }

    getTemplate() {
      // Show HTML Here
      return `
      ${this.getBody()}
      ${this.getStyles()}
    `;
    }

    getBody = () => {
      return /* html */`
      ${this.getHeader()}
      <form class="fields picture">
        <div class="image-preview">
          <label for="profile-image">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" fill="currentColor">
              <path d="M11.013 1.427a1.75 1.75 0 0 1 2.474 0l1.086 1.086a1.75 1.75 0 0 1 0 2.474l-8.61 8.61c-.21.21-.47.364-.756.445l-3.251.93a.75.75 0 0 1-.927-.928l.929-3.25c.081-.286.235-.547.445-.758l8.61-8.61Zm.176 4.823L9.75 4.81l-6.286 6.287a.253.253 0 0 0-.064.108l-.558 1.953 1.953-.558a.253.253 0 0 0 .108-.064Zm1.238-3.763a.25.25 0 0 0-.354 0L10.811 3.75l1.439 1.44 1.263-1.263a.25.25 0 0 0 0-.354Z"></path>
            </svg>
          </label>
          <input type="file" id="profile-image" accept="image/*" />
        </div>
        <div class="actions">
          <button type="submit" class="action next">
            <span class="text">Send</span>
          </button>
        </div>
      </form>
    `;
    }

    getHeader = () => {
      return /* html */`
      <div class="top">
        <p class="desc">
          Your profile picture is how people will recognize you on the platform. You can use a photo of yourself or an avatar. <br>
          <span>Note that the image will be cropped to a square and resized to 300x300 pixels, and may take time to reflect everywhere due to local cache.<span>
        </p>
      </div>
    `;
    }

    getStyles() {
      return /* css */`
      <style>
        *,
        *:after,
        *:before {
          box-sizing: border-box !important;
          font-family: inherit;
          -webkit-box-sizing: border-box !important;
        }

        *:focus {
          outline: inherit !important;
        }

        *::-webkit-scrollbar {
          -webkit-appearance: none;
        }

        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
          padding: 0;
          margin: 0;
          font-family: inherit;
        }

        p,
        ul,
        ol {
          padding: 0;
          margin: 0;
        }

        a {
          text-decoration: none;
        }

        :host {
          font-size: 16px;
          display: flex;
          flex-flow: column;
          gap: 10px;
          padding: 0;
          width: 100%;
        }

        p.server-status {
          margin: 0;
          width: 100%;
          text-align: start;
          font-family: var(--font-read), sans-serif;
          color: var(--error-color);
          font-weight: 500;
          line-height: 1.4;
          font-size: 1.18rem;
        }

        p.server-status.success {
          color: transparent;
          background: var(--accent-linear);
          background-clip: text;
          -webkit-background-clip: text;
        }

        @keyframes l38 {
          100% {
            background-position: 100% 0, 100% 100%, 0 100%, 0 0
          }
        }

        #btn-loader {
          position: absolute;
          top: 0;
          left: 0;
          bottom: 0;
          right: 0;
          z-index: 5;
          display: flex;
          align-items: center;
          justify-content: center;
          border-radius: inherit;
        }

        #btn-loader > .loader-alt {
          width: 20px;
          aspect-ratio: 1;
          --_g: no-repeat radial-gradient(farthest-side, #18A565 94%, #0000);
          --_g1: no-repeat radial-gradient(farthest-side, #21D029 94%, #0000);
          --_g2: no-repeat radial-gradient(farthest-side, #df791a 94%, #0000);
          --_g3: no-repeat radial-gradient(farthest-side, #f09c4e 94%, #0000);
          background:    var(--_g) 0 0,    var(--_g1) 100% 0,    var(--_g2) 100% 100%,    var(--_g3) 0 100%;
          background-size: 30% 30%;
          animation: l38 .9s infinite ease-in-out;
          -webkit-animation: l38 .9s infinite ease-in-out;
        }

        #btn-loader > .loader {
          width: 20px;
          aspect-ratio: 1;
          --_g: no-repeat radial-gradient(farthest-side, #ffffff 94%, #0000);
          --_g1: no-repeat radial-gradient(farthest-side, #ffffff 94%, #0000);
          --_g2: no-repeat radial-gradient(farthest-side, #df791a 94%, #0000);
          --_g3: no-repeat radial-gradient(farthest-side, #f09c4e 94%, #0000);
          background:    var(--_g) 0 0,    var(--_g1) 100% 0,    var(--_g2) 100% 100%,    var(--_g3) 0 100%;
          background-size: 30% 30%;
          animation: l38 .9s infinite ease-in-out;
          -webkit-animation: l38 .9s infinite ease-in-out;
        }

        .top {
          display: flex;
          flex-flow: column;
          gap: 5px;
          padding: 0;
          width: 100%;
        }

        .top > h4.title {
          border-bottom: var(--border-mobile);
          display: flex;
          align-items: center;
          color: var(--title-color);
          font-size: 1.3rem;
          font-weight: 500;
          margin: 0;
          padding: 0 0 6px 0;
        }

        .top > .desc {
          margin: 0;
          padding: 10px 0;
          color: var(--text-color);
          font-size: 1rem;
          font-family: var(--font-main), sans-serif;
        }

        .top > .desc > span {
          margin: 0;
          color: var(--gray-color);
          font-size: 0.85rem;
          line-height: 1.5;
          font-style: italic;
          font-family: var(--font-read), sans-serif;
        }

        form.fields {
          margin: 0;
          width: 100%;
          display: flex;
          flex-flow: column;
          justify-content: center;
          align-items: center;
          gap: 20px;
        }

        form.fields > .field {
          width: 100%;
          display: flex;
          flex-flow: column;
          justify-content: center;
          align-items: start;
          gap: 20px;
        }

        form.fields.center > .field {
          align-items: center;
        }

        form.fields .field .input-group {
          width: 100%;
          display: flex;
          flex-flow: column;
          justify-content: center;
          align-items: start;
          color: var(--text-color);
          gap: 5px;
          position: relative;
          transition: border-color 0.3s ease-in-out;
        }

        form.fields .field.bio .input-group {
          width: 100%;
        }

        form.fields .field.bio .input-group.code,
        form.fields .field.bio .input-group.email {
          grid-column: 1/3;
          width: 100%;
        }

        form.fields .field .input-group > svg {
          position: absolute;
          right: 10px;
          top: 38px;
          width: 20px;
          height: 20px;
        }

        form.fields label {
          padding: 0 0 5px 0;
          color: var(--text-color);
        }

        form.fields .field.bio label {
          padding: 0 0 0 5px;
        }

        form.fields label {
          color: var(--label-color);
          font-size: 1.1rem;
          font-family: var(--font-main), sans-serif;
          transition: all 0.3s ease-in-out;
          pointer-events: none;
        }

        form.fields .field input {
          border: var(--input-border);
          background-color: var(--background) !important;
          font-size: 1rem;
          width: 100%;
          height: 40px;
          outline: none;
          padding: 10px 12px;
          border-radius: 12px;
          color: var(--text-color);
        }
        
        form.fields .field input:-webkit-autofill,
        form.fields .field input:-webkit-autofill:hover, 
        form.fields .field input:-webkit-autofill:focus {
          -webkit-box-shadow: 0 0 0px 1000px var(--background) inset;
          -webkit-text-fill-color: var(--text-color) !important;
          transition: background-color 5000s ease-in-out 0s;
          color: var(--text-color) !important;
        }
        
        form.fields .field input:autofill {
          filter: none;
          color: var(--text-color) !important;
        }

        form.fields .field input:focus {
          border: var(--input-border-focus);
        }

        form.fields .field span.wrapper {
          display: flex;
          align-items: center;
          align-items: center;
          gap: 0;
          width: 100%;
        }

        form.fields .field .input-group.success > span.wrapper > input,
        form.fields .field .input-group.success > span.wrapper > input:focus,
        form.fields .field .input-group.success input,
        form.fields .field .input-group.success input:focus {
          border: var(--input-border-focus);
        }

        form.fields .field .input-group.failed > span.wrapper > input,
        form.fields .field .input-group.failed > span.wrapper > input:focus,
        form.fields .field .input-group.failed input,
        form.fields .field .input-group.failed input:focus {
          border: var(--input-border-error);
        }

        form.fields .field .input-group.success span.wrapper > input,
        form.fields .field .input-group.success input {
          color: var(--accent-color);
        }

        form.fields .field .input-group.failed span.wrapper > input,
        form.fields .field .input-group.failed input {
          color: var(--error-color);
        }

        form.fields label.focused {
          top: -10px;
          font-size: 0.9rem;
          background-color: var(--label-focus-background);
          padding: 0 5px;
        }

        form.fields .field span.status {
          color: var(--error-color);
          font-size: 0.95rem;
          display: none;
          padding: 0 0 0 5px;
        }

        form.fields .field .input-group.failed span.status {
          color: var(--error-color);
          font-size: 0.8rem;
          display: inline-block;
        }

        form.fields .field .input-group.success span.status {
          color: var(--accent-color);
          font-size: 0.8rem;
          display: inline-block;
        }

        form.fields .field .input-group.success span.status {
          display: none;
        }

        form.fields .actions {
          display: flex;
          align-items: center;
          justify-content: center;
          width: 100%;
          margin: 0 0 0 2px;
        }

        form.fields .actions > .action {
          border: none;
          background: var(--accent-linear);
          font-family: var(--font-main), sans-serif;
          text-decoration: none;
          color: var(--white-color);
          font-size: 1rem;
          font-weight: 600;
          cursor: pointer;
          display: flex;
          flex-flow: row;
          align-items: center;
          text-transform: capitalize;
          justify-content: center;
          padding: 7px 15px 8px;
          min-height: 35px;
          height: 35px;
          min-width: 60px;
          width: max-content;
          position: relative;
          border-radius: 50px;
          -webkit-border-radius: 50px;
          -moz-border-radius: 50px;
        }

        form.fields .actions > .action.prev svg path {
          fill: var(--text-color);
        }

        form.fields .actions > .action.next {
          color: var(--white-color);
          background: var(--stage-no-linear);
        }

        form.fields .actions > .action.next svg path {
          fill: var(--white-color);
        }

        form.fields .actions > .action.disabled {
          pointer-events: none;
        }

        form.fields.picture > .image-preview {
          border: var(--input-border);
          position: relative;
          width: 200px;
          height: 200px;
          min-width: 200px;
          min-height: 200px;
          object-fit: cover;
          display: flex;
          align-items: center;
          overflow: hidden;
          justify-content: center;
          background-image: url(${this.getAttribute('profile-image')});
          background-repeat: no-repeat !important;
          background-position: 100%;
          background-size: cover;
          border-radius: 50%;
          -webkit-border-radius: 50%;
          -moz-border-radius: 50%;
          -ms-border-radius: 50%;
          -o-border-radius: 50%;
        }

        form.fields.picture > .image-preview img {
          width: 100%;
          height: 100%;
          object-fit: cover;
          display: none;
          border-radius: 20px;
        }

        form.fields.picture > .image-preview input + label {
          display: inline-block;
          width: max-content;
          height: 30px;
          margin-bottom: 0;
          border-radius: 100%;
          background-color: #ffffff45;
          border: 1px solid transparent;
          box-shadow: 0px 2px 4px 0px rgba(0, 0, 0, 0.12);
          cursor: pointer;
          position: absolute;
          right: calc(50% - 20px);
          top: calc(50% - 20px);
          transform: translateY(-50%);
          font-weight: normal;
        }

        form.fields.picture > .image-preview input {
          opacity: 0;
        }

        form.fields.picture > .image-preview label {
          position: absolute;
          width: 40px;
          height: 40px;
          min-width: 40px;
          min-height: 40px;
          top: calc(50% - 20px);
          padding: 7px 12px;
          z-index: 1;
          margin: 0;
          text-align: center;
          background: var(--accent-linear);
          color: var(--white-color);
          font-size: 1rem;
          font-family: var(--font-main), sans-serif;
          font-weight: 500;
          border-radius: 50px;
          cursor: pointer;
          display: flex;
          align-items: center;
          justify-content: center;
        }

        form.fields.picture > .image-preview label svg {
          width: 20px;
          height: 20px;
        }

        @media screen and (max-width:600px) {
          ::-webkit-scrollbar {
            -webkit-appearance: none;
          }

          .top > .desc {
            margin: 0;
            padding: 6px 0 10px;
            font-size: 1rem;
            line-height: 1.5;
            font-family: var(--font-main), sans-serif;
          }

          form.fields .actions > .action {
            cursor: default !important;
          }
        }
      </style>
    `;
    }
  }

  let FormName$1 = class FormName extends HTMLElement {
    constructor() {
      // We are not even going to touch this.
      super();

      // let's create our shadow root
      this.shadowObj = this.attachShadow({ mode: "open" });

      this._url = this.getAttribute('api');

      this.render();
    }

    render() {
      this.shadowObj.innerHTML = this.getTemplate();
    }

    connectedCallback() {
      // Select form
      const form = this.shadowObj.querySelector('#name-form');

      // Submit form
      this.submitForm(form);
    }

     disableScroll() {
      // Get the current page scroll position
      let scrollTop = window.scrollY || document.documentElement.scrollTop;
      let scrollLeft = window.scrollX || document.documentElement.scrollLeft;
      document.body.classList.add("stop-scrolling");

      // if any scroll is attempted, set this to the previous value
      window.onscroll = function () {
        window.scrollTo(scrollLeft, scrollTop);
      };
    }

    enableScroll() {
      document.body.classList.remove("stop-scrolling");
      window.onscroll = function () { };
    }

    submitForm = async form => {
      const outerThis = this;
      // add submit event listener
      form.addEventListener('submit', async e => {
        e.preventDefault();

        const serverStatus = form.querySelector('.server-status');

        // if server status is already showing, remove it
        if (serverStatus) {
          serverStatus.remove();
        }

        const actions = form.querySelector('.actions');

        // get and validate form data
        const formData = new FormData(form);

        // get form data
        const data = {
          first_name: formData.get('firstname'),
          last_name: formData.get('lastname')
        };

        // check if form data is valid
        if (!data.first_name || !data.last_name || data.first_name.length < 3 || data.last_name.length < 3) {
          
          const errorMsg = 'First and last name must be at least 3 characters long';

          // show error message
          actions.insertAdjacentHTML('beforebegin', outerThis.getServerSuccessMsg(false, errorMsg));

          return;
        }

        // show loader
        const button = form.querySelector('.action.next');
        button.innerHTML = outerThis.getButtonLoader();

        // send data to server
        const options = {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(data)
        };

        try {
          const response = await outerThis.fetchWithTimeout(outerThis._url, options);
          const result = await response.json();

          // check if request was successful
          if (result.success) {
            // show success message
            actions.insertAdjacentHTML('beforebegin', outerThis.getServerSuccessMsg(true, 'Name updated successfully'));

            // reset button
            button.innerHTML = '<span class="text">Send</span>';
          } else {
            // show error message
            actions.insertAdjacentHTML('beforebegin', outerThis.getServerSuccessMsg(false, result.message));

            // reset button
            button.innerHTML = '<span class="text">Send</span>';
          }
        }
        catch (error) {
          // show error message
          actions.insertAdjacentHTML('beforebegin', outerThis.getServerSuccessMsg(false, 'An error occurred, please try again'));

          // reset button
          button.innerHTML = '<span class="text">Send</span>';
        }

        // remove success message
        setTimeout(() => {
          const serverStatus = form.querySelector('.server-status');
          if (serverStatus) {
            serverStatus.remove();
          }
        }, 5000);
      });
    }

    fetchWithTimeout = async (url, options = {}, timeout = 9500) => {
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), timeout);
    
      try {
        const response = await fetch(url, {
          ...options,
          signal: controller.signal
        });

        return response;
      } catch (error) {
        if (error.name === 'AbortError') {
          throw new Error('Request timed out');
        }
        throw new Error(`Network error: ${error.message}`);
      } finally {
        clearTimeout(timeoutId);
      }
    };

    getServerSuccessMsg = (success, text) => {
      if (!success) {
        return `
        <p class="server-status">${text}</p>
      `
      }
      return `
      <p class="server-status success">${text}</p>
    `
    }

    getButtonLoader() {
      return `
      <span id="btn-loader">
				<span class="loader"></span>
			</span>
    `
    }

    getTemplate() {
      // Show HTML Here
      return `
      ${this.getBody()}
      ${this.getStyles()}
    `;
    }

    getBody = () => {
      return /* html */`
      ${this.getHeader()}
      <form class="fields initial" id="name-form">
        <div class="field bio">
          <div class="input-group firstname">
            <label for="firstname" class="center">First name</label>
            <input data-name="firstname" type="text" name="firstname" id="firstname" placeholder="Enter your first name"
             value="${this.getAttribute('first-name')}" required>
            <span class="status">First name is required</span>
          </div>
          <div class="input-group lastname">
            <label for="lastname" class="center">Last name</label>
            <input data-name="lastname" type="text" name="lastname" id="lastname" value="${this.getAttribute('last-name')}" placeholder="Enter your last name" required>
            <span class="status">Last name is required</span>
          </div>
        </div>
        <div class="actions">
          <button type="submit" class="action next">
            <span class="text">Send</span>
          </button>
        </div>
      </form>
    `;
    }

    getHeader = () => {
      return /* html */`
      <div class="top">
        <p class="desc">
          Your name is how people will find you on the platform. You can use your real name or a nickname.
          Both first and last name fields can't be empty.
        </p>
      </div>
    `;
    }


    getStyles() {
      return /* css */`
      <style>
        *,
        *:after,
        *:before {
          box-sizing: border-box !important;
          font-family: inherit;
          -webkit-box-sizing: border-box !important;
        }

        *:focus {
          outline: inherit !important;
        }

        *::-webkit-scrollbar {
          -webkit-appearance: none;
        }

        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
          padding: 0;
          margin: 0;
          font-family: inherit;
        }

        p,
        ul,
        ol {
          padding: 0;
          margin: 0;
        }

        a {
          text-decoration: none;
        }

        :host {
          font-size: 16px;
          display: flex;
          flex-flow: column;
          gap: 10px;
          padding: 0;
          width: 100%;
        }

        p.server-status {
          margin: 0;
          width: 100%;
          text-align: start;
          font-family: var(--font-read), sans-serif;
          color: var(--error-color);
          font-weight: 500;
          line-height: 1.4;
          font-size: 1.18rem;
        }

        p.server-status.success {
          color: transparent;
          background: var(--accent-linear);
          background-clip: text;
          -webkit-background-clip: text;
        }

        @keyframes l38 {
          100% {
            background-position: 100% 0, 100% 100%, 0 100%, 0 0
          }
        }

        #btn-loader {
          position: absolute;
          top: 0;
          left: 0;
          bottom: 0;
          right: 0;
          z-index: 5;
          display: flex;
          align-items: center;
          justify-content: center;
          border-radius: inherit;
        }

        #btn-loader > .loader-alt {
          width: 20px;
          aspect-ratio: 1;
          --_g: no-repeat radial-gradient(farthest-side, #18A565 94%, #0000);
          --_g1: no-repeat radial-gradient(farthest-side, #21D029 94%, #0000);
          --_g2: no-repeat radial-gradient(farthest-side, #df791a 94%, #0000);
          --_g3: no-repeat radial-gradient(farthest-side, #f09c4e 94%, #0000);
          background:    var(--_g) 0 0,    var(--_g1) 100% 0,    var(--_g2) 100% 100%,    var(--_g3) 0 100%;
          background-size: 30% 30%;
          animation: l38 .9s infinite ease-in-out;
          -webkit-animation: l38 .9s infinite ease-in-out;
        }

        #btn-loader > .loader {
          width: 20px;
          aspect-ratio: 1;
          --_g: no-repeat radial-gradient(farthest-side, #ffffff 94%, #0000);
          --_g1: no-repeat radial-gradient(farthest-side, #ffffff 94%, #0000);
          --_g2: no-repeat radial-gradient(farthest-side, #df791a 94%, #0000);
          --_g3: no-repeat radial-gradient(farthest-side, #f09c4e 94%, #0000);
          background:    var(--_g) 0 0,    var(--_g1) 100% 0,    var(--_g2) 100% 100%,    var(--_g3) 0 100%;
          background-size: 30% 30%;
          animation: l38 .9s infinite ease-in-out;
          -webkit-animation: l38 .9s infinite ease-in-out;
        }

        .top {
          display: flex;
          flex-flow: column;
          gap: 5px;
          padding: 0;
          width: 100%;
        }

        .top > h4.title {
          border-bottom: var(--border-mobile);
          display: flex;
          align-items: center;
          color: var(--title-color);
          font-size: 1.3rem;
          font-weight: 500;
          margin: 0;
          padding: 0 0 6px 0;
        }

        .top > .desc {
          margin: 0;
          padding: 10px 0;
          color: var(--text-color);
          font-size: 1rem;
          font-family: var(--font-main), sans-serif;
        }

        form.fields {
          margin: 0;
          width: 100%;
          display: flex;
          flex-flow: column;
          justify-content: center;
          align-items: center;
          gap: 20px;
        }

        form.fields > .field {
          width: 100%;
          display: flex;
          flex-flow: column;
          justify-content: center;
          align-items: start;
          gap: 20px;
        }

        form.fields.center > .field {
          align-items: center;
        }

        form.fields .field .input-group {
          width: 100%;
          display: flex;
          flex-flow: column;
          justify-content: center;
          align-items: start;
          color: var(--text-color);
          gap: 5px;
          position: relative;
          transition: border-color 0.3s ease-in-out;
        }

        form.fields .field.bio .input-group {
          width: 100%;
        }

        form.fields .field.bio .input-group.code,
        form.fields .field.bio .input-group.email {
          grid-column: 1/3;
          width: 100%;
        }

        form.fields .field .input-group > svg {
          position: absolute;
          right: 10px;
          top: 38px;
          width: 20px;
          height: 20px;
        }

        form.fields .field .input-group > svg {
          display: none;
        }

        form.fields .field .input-group.success > svg {
          display: inline-block;
        }

        form.fields .field .input-group.failed > svg {
          display: inline-block;
        }

        form.fields .field .input-group.success > svg {
          color: var(--accent-color);
        }

        form.fields .field .input-group.failed > svg {
          color: var(--error-color);
        }

        form.fields label {
          padding: 0 0 5px 0;
          color: var(--text-color);
        }

        form.fields .field.bio label {
          padding: 0 0 0 5px;
        }

        form.fields label {
          color: var(--label-color);
          font-size: 1.1rem;
          font-family: var(--font-main), sans-serif;
          transition: all 0.3s ease-in-out;
          pointer-events: none;
        }

        form.fields .field input {
          border: var(--input-border);
          background-color: var(--background) !important;
          font-size: 1rem;
          width: 100%;
          height: 40px;
          outline: none;
          padding: 10px 12px;
          border-radius: 12px;
          color: var(--text-color);
        }
        
        form.fields .field input:-webkit-autofill,
        form.fields .field input:-webkit-autofill:hover, 
        form.fields .field input:-webkit-autofill:focus {
          -webkit-box-shadow: 0 0 0px 1000px var(--background) inset;
          -webkit-text-fill-color: var(--text-color) !important;
          transition: background-color 5000s ease-in-out 0s;
          color: var(--text-color) !important;
        }
        
        form.fields .field input:autofill {
          filter: none;
          color: var(--text-color) !important;
        }

        form.fields .field input:focus {
          border: var(--input-border-focus);
        }

        form.fields .field span.wrapper {
          display: flex;
          align-items: center;
          align-items: center;
          gap: 0;
          width: 100%;
        }

        form.fields .field .input-group.success > span.wrapper > input,
        form.fields .field .input-group.success > span.wrapper > input:focus,
        form.fields .field .input-group.success input,
        form.fields .field .input-group.success input:focus {
          border: var(--input-border-focus);
        }

        form.fields .field .input-group.failed > span.wrapper > input,
        form.fields .field .input-group.failed > span.wrapper > input:focus,
        form.fields .field .input-group.failed input,
        form.fields .field .input-group.failed input:focus {
          border: var(--input-border-error);
        }

        form.fields .field .input-group.success span.wrapper > input,
        form.fields .field .input-group.success input {
          color: var(--accent-color);
        }

        form.fields .field .input-group.failed span.wrapper > input,
        form.fields .field .input-group.failed input {
          color: var(--error-color);
        }

        form.fields label.focused {
          top: -10px;
          font-size: 0.9rem;
          background-color: var(--label-focus-background);
          padding: 0 5px;
        }

        form.fields .field span.status {
          color: var(--error-color);
          font-size: 0.95rem;
          display: none;
          padding: 0 0 0 5px;
        }

        form.fields .field .input-group.failed span.status {
          color: var(--error-color);
          font-size: 0.8rem;
          display: inline-block;
        }

        form.fields .field .input-group.success span.status {
          color: var(--accent-color);
          font-size: 0.8rem;
          display: inline-block;
        }

        form.fields .field .input-group.success span.status {
          display: none;
        }

        form.fields .actions {
          display: flex;
          align-items: center;
          justify-content: space-between;
          width: 100%;
          margin: 0 0 0 2px;
        }

        form.fields .actions > .action {
          border: none;
          background: var(--accent-linear);
          font-family: var(--font-main), sans-serif;
          text-decoration: none;
          color: var(--white-color);
          font-size: 1rem;
          font-weight: 600;
          cursor: pointer;
          display: flex;
          flex-flow: row;
          align-items: center;
          text-transform: capitalize;
          justify-content: center;
          padding: 7px 15px 8px;
          min-height: 35px;
          height: 35px;
          min-width: 60px;
          width: max-content;
          position: relative;
          border-radius: 50px;
          -webkit-border-radius: 50px;
          -moz-border-radius: 50px;
        }

        form.fields .actions > .action.prev svg path {
          fill: var(--text-color);
        }

        form.fields .actions > .action.next {
          color: var(--white-color);
          background: var(--stage-no-linear);
        }

        form.fields .actions > .action.next svg path {
          fill: var(--white-color);
        }

        form.fields .actions > .action.disabled {
          pointer-events: none;
        }

        @media screen and (max-width:600px) {
          ::-webkit-scrollbar {
            -webkit-appearance: none;
          }

          .top > .desc {
            margin: 0;
            padding: 6px 0 10px;
            font-size: 1rem;
            line-height: 1.5;
            font-family: var(--font-main), sans-serif;
          }

          form.fields .actions > .action {
            cursor: default !important;
          }
        }
      </style>
    `;
    }
  };

  class FormName extends HTMLElement {
    constructor() {
      // We are not even going to touch this.
      super();

      // let's create our shadow root
      this.shadowObj = this.attachShadow({ mode: "open" });

      // get url
      this._url = this.getAttribute('api');

      this.render();
    }

    render() {
      this.shadowObj.innerHTML = this.getTemplate();
    }

    connectedCallback() {
      // get form
      const form = this.shadowObj.querySelector('form');

      // submit form
      this.submitForm(form);
    }

     disableScroll() {
      // Get the current page scroll position
      let scrollTop = window.scrollY || document.documentElement.scrollTop;
      let scrollLeft = window.scrollX || document.documentElement.scrollLeft;
      document.body.classList.add("stop-scrolling");

      // if any scroll is attempted, set this to the previous value
      window.onscroll = function () {
        window.scrollTo(scrollLeft, scrollTop);
      };
    }

    enableScroll() {
      document.body.classList.remove("stop-scrolling");
      window.onscroll = function () { };
    }

    submitForm = async form => {
      const outerThis = this;
      // add submit event listener
      form.addEventListener('submit', async e => {
        e.preventDefault();

        const serverStatus = form.querySelector('.server-status');

        // if server status is already showing, remove it
        if (serverStatus) {
          serverStatus.remove();
        }

        const actions = form.querySelector('.actions');

        // show loader
        const button = form.querySelector('.action.next');
        button.innerHTML = outerThis.getButtonLoader();

        // get and validate form data
        const formData = new FormData(form);

        // get form data
        const data = {
          email: formData.get('email') || null,
          x: formData.get('x') || null,
          linkedin: formData.get('linkedin') || null,
          threads: formData.get('threads') || null,
          link: formData.get('link') || null
        };

        // at least one field must be filled
        if (!data.email && !data.x && !data.linkedin && !data.threads && !data.link) {
          actions.insertAdjacentHTML('beforebegin', outerThis.getServerSuccessMsg(false, 'You must fill at least one field'));

          button.innerHTML = '<span class="text">Send</span>';
          return;
        }

        // get only filled fields
        Object.keys(data).forEach(key => {
          if (!data[key]) { 
            delete data[key];
          }
        });

        // send data to server
        const options = {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            contact: data
          })
        };

        try {
          const response = await outerThis.fetchWithTimeout(outerThis._url, options);
          const result = await response.json();

          // check if request was successful
          if (result.success) {
            // show success message
            actions.insertAdjacentHTML('beforebegin', outerThis.getServerSuccessMsg(true, result.message));

            // reset button
            button.innerHTML = '<span class="text">Send</span>';
          } else {
            // show error message
            actions.insertAdjacentHTML('beforebegin', outerThis.getServerSuccessMsg(false, result.message));

            // reset button
            button.innerHTML = '<span class="text">Send</span>';
          }
        }
        catch (error) {
          // show error message
          actions.insertAdjacentHTML('beforebegin', outerThis.getServerSuccessMsg(false, 'An error occurred, please try again'));

          // reset button
          button.innerHTML = '<span class="text">Send</span>';
        }

        // remove success message
        setTimeout(() => {
          const serverStatus = form.querySelector('.server-status');
          if (serverStatus) {
            serverStatus.remove();
          }
        }, 5000);
      });
    }

    fetchWithTimeout = async (url, options = {}, timeout = 9500) => {
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), timeout);
    
      try {
        const response = await fetch(url, {
          ...options,
          signal: controller.signal
        });

        return response;
      } catch (error) {
        if (error.name === 'AbortError') {
          throw new Error('Request timed out');
        }
        throw new Error(`Network error: ${error.message}`);
      } finally {
        clearTimeout(timeoutId);
      }
    };

    getServerSuccessMsg = (success, text) => {
      if (!success) {
        return `
        <p class="server-status">${text}</p>
      `
      }
      return `
      <p class="server-status success">${text}</p>
    `
    }

    getButtonLoader() {
      return `
      <span id="btn-loader">
				<span class="loader"></span>
			</span>
    `
    }

    getTemplate() {
      // Show HTML Here
      return `
      ${this.getBody()}
      ${this.getStyles()}
    `;
    }

    getContact = () => {
      const data = {
        email: this.getAttribute('email'),
        x: this.getAttribute('x'),
        linkedin: this.getAttribute('linkedin'),
        threads: this.getAttribute('threads'),
        link: this.getAttribute('link')
      };

      // loop through data and replace null, undefined with null
      Object.keys(data).forEach(key => {
        if (data[key] === 'null' || data[key] === 'undefined' || data[key] === null) {
          data[key] = null;
        }
      });

      return data;
    }

    getBody = () => {
      const contact = this.getContact();
      return /* html */`
      ${this.getHeader()}
      <form class="fields initial" id="social-form">
        <div class="field bio">
          <div class="input-group email">
            <span class="wrapper">
              <span class="icon">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" fill="currentColor">
                  <path d="M1.75 2h12.5c.966 0 1.75.784 1.75 1.75v8.5A1.75 1.75 0 0 1 14.25 14H1.75A1.75 1.75 0 0 1 0 12.25v-8.5C0 2.784.784 2 1.75 2ZM1.5 12.251c0 .138.112.25.25.25h12.5a.25.25 0 0 0 .25-.25V5.809L8.38 9.397a.75.75 0 0 1-.76 0L1.5 5.809v6.442Zm13-8.181v-.32a.25.25 0 0 0-.25-.25H1.75a.25.25 0 0 0-.25.25v.32L8 7.88Z"></path>
                </svg>
              </span>
              ${this.getEmail(contact.email)}
            </span>
          </div>
          <div class="input-group x">
            <span class="wrapper">
              <span class="icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-twitter-x" viewBox="0 0 16 16">
                  <path d="M12.6.75h2.454l-5.36 6.142L16 15.25h-4.937l-3.867-5.07-4.425 5.07H.316l5.733-6.57L0 .75h5.063l3.495 4.633L12.601.75Zm-.86 13.028h1.36L4.323 2.145H2.865z" />
                </svg>
              </span>
              ${this.getX(contact.x)}
            </span>
          </div>
          <div class="input-group linkedin">
            <span class="wrapper">
              <span class="icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-linkedin" viewBox="0 0 16 16">
                  <path d="M0 1.146C0 .513.526 0 1.175 0h13.65C15.474 0 16 .513 16 1.146v13.708c0 .633-.526 1.146-1.175 1.146H1.175C.526 16 0 15.487 0 14.854zm4.943 12.248V6.169H2.542v7.225zm-1.2-8.212c.837 0 1.358-.554 1.358-1.248-.015-.709-.52-1.248-1.342-1.248S2.4 3.226 2.4 3.934c0 .694.521 1.248 1.327 1.248zm4.908 8.212V9.359c0-.216.016-.432.08-.586.173-.431.568-.878 1.232-.878.869 0 1.216.662 1.216 1.634v3.865h2.401V9.25c0-2.22-1.184-3.252-2.764-3.252-1.274 0-1.845.7-2.165 1.193v.025h-.016l.016-.025V6.169h-2.4c.03.678 0 7.225 0 7.225z"/>
                </svg>
              </span>
              ${this.getLinkedin(contact.linkedin)}
            </span>
          </div>
          <div class="input-group threads">
            <span class="wrapper">
              <span class="icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-threads" viewBox="0 0 16 16">
                  <path d="M6.321 6.016c-.27-.18-1.166-.802-1.166-.802.756-1.081 1.753-1.502 3.132-1.502.975 0 1.803.327 2.394.948s.928 1.509 1.005 2.644q.492.207.905.484c1.109.745 1.719 1.86 1.719 3.137 0 2.716-2.226 5.075-6.256 5.075C4.594 16 1 13.987 1 7.994 1 2.034 4.482 0 8.044 0 9.69 0 13.55.243 15 5.036l-1.36.353C12.516 1.974 10.163 1.43 8.006 1.43c-3.565 0-5.582 2.171-5.582 6.79 0 4.143 2.254 6.343 5.63 6.343 2.777 0 4.847-1.443 4.847-3.556 0-1.438-1.208-2.127-1.27-2.127-.236 1.234-.868 3.31-3.644 3.31-1.618 0-3.013-1.118-3.013-2.582 0-2.09 1.984-2.847 3.55-2.847.586 0 1.294.04 1.663.114 0-.637-.54-1.728-1.9-1.728-1.25 0-1.566.405-1.967.868ZM8.716 8.19c-2.04 0-2.304.87-2.304 1.416 0 .878 1.043 1.168 1.6 1.168 1.02 0 2.067-.282 2.232-2.423a6.2 6.2 0 0 0-1.528-.161" />
                </svg>
              </span>
              ${this.getThreads(contact.threads)}
            </span>
          </div>
          <div class="input-group threads">
            <span class="wrapper">
              <span class="icon">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"  fill="currentColor"  width="16" height="16">
                  <path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path>
                </svg>
              </span>
              ${this.getLink(contact.link)}
            </span>
          </div>
        </div>
        <div class="actions">
          <button type="submit" class="action next">
            <span class="text">Send</span>
          </button>
        </div>
      </form>
    `;
    }

    getHeader = () => {
      return /* html */`
      <div class="top">
        <p class="desc">
          Your socials are how people will connect with you outside the platform through your email, linkedin, and x accounts. <br>
          <span>Please add only the username part for X(twitter), linkedin, and threads, i.e. without the '@' symbol or https://...</span>
        </p>
      </div>
    `;
    }

    getEmail = email => {
      if(email !== 'null' && email !== undefined && email !== null) {
        return `
        <input type="email" name="email" id="email" placeholder="e.g john@example.com" value="${email}">
      `;
      }
      else {
        return `
        <input type="email" name="email" id="email" placeholder="e.g john@example.com">
      `;
      }
    }

    getX = data => {
      if (data !== 'null' && data !== undefined && data !== null) {
        return `
        <input type="text" name="x" id="x" placeholder="Your X(twitter) username" value="${data}">
      `;
      }
      else {
        return `
        <input type="text" name="x" id="x" placeholder="Your X(twitter) username">
      `;
      }
    }

    getLinkedin = data => {
      if (data !== 'null' && data !== undefined && data !== null) {
        return `
        <input type="text" name="linkedin" id="linkedin" placeholder="Your linkedin username" value="${data}">
      `;
      }
      else {
        return `
        <input type="text" name="linkedin" id="linkedin" placeholder="Your linkedin username">
      `;
      }
    }

    getThreads = data => {
      if (data !== 'null' && data !== undefined && data !== null) {
        return `
        <input type="text" name="threads" id="threads" placeholder="Your threads username" value="${data}">
      `;
      }
      else {
        return `
        <input type="text" name="threads" id="threads" placeholder="Your threads username">
      `;
      }
    }

    getLink = data => {
      if (data !== 'null' && data !== undefined && data !== null) {
        return `
        <input type="url" name="link" id="link" placeholder="Your website or a link" value="${data}">
      `;
      }
      else {
        return `
        <input type="url" name="link" id="link" placeholder="Your website or a link">
      `;
      }
    }

    getStyles() {
      return /* css */`
      <style>
        *,
        *:after,
        *:before {
          box-sizing: border-box !important;
          font-family: inherit;
          -webkit-box-sizing: border-box !important;
        }

        *:focus {
          outline: inherit !important;
        }

        *::-webkit-scrollbar {
          -webkit-appearance: none;
        }

        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
          padding: 0;
          margin: 0;
          font-family: inherit;
        }

        p,
        ul,
        ol {
          padding: 0;
          margin: 0;
        }

        a {
          text-decoration: none;
        }

        :host {
          font-size: 16px;
          display: flex;
          flex-flow: column;
          gap: 10px;
          padding: 0;
          width: 100%;
        }

        p.server-status {
          margin: 0;
          width: 100%;
          text-align: start;
          font-family: var(--font-read), sans-serif;
          color: var(--error-color);
          font-weight: 500;
          line-height: 1.4;
          font-size: 1.18rem;
        }

        p.server-status.success {
          color: transparent;
          background: var(--accent-linear);
          background-clip: text;
          -webkit-background-clip: text;
        }

        @keyframes l38 {
          100% {
            background-position: 100% 0, 100% 100%, 0 100%, 0 0
          }
        }

        #btn-loader {
          position: absolute;
          top: 0;
          left: 0;
          bottom: 0;
          right: 0;
          z-index: 5;
          display: flex;
          align-items: center;
          justify-content: center;
          border-radius: inherit;
        }

        #btn-loader > .loader-alt {
          width: 20px;
          aspect-ratio: 1;
          --_g: no-repeat radial-gradient(farthest-side, #18A565 94%, #0000);
          --_g1: no-repeat radial-gradient(farthest-side, #21D029 94%, #0000);
          --_g2: no-repeat radial-gradient(farthest-side, #df791a 94%, #0000);
          --_g3: no-repeat radial-gradient(farthest-side, #f09c4e 94%, #0000);
          background:    var(--_g) 0 0,    var(--_g1) 100% 0,    var(--_g2) 100% 100%,    var(--_g3) 0 100%;
          background-size: 30% 30%;
          animation: l38 .9s infinite ease-in-out;
          -webkit-animation: l38 .9s infinite ease-in-out;
        }

        #btn-loader > .loader {
          width: 20px;
          aspect-ratio: 1;
          --_g: no-repeat radial-gradient(farthest-side, #ffffff 94%, #0000);
          --_g1: no-repeat radial-gradient(farthest-side, #ffffff 94%, #0000);
          --_g2: no-repeat radial-gradient(farthest-side, #df791a 94%, #0000);
          --_g3: no-repeat radial-gradient(farthest-side, #f09c4e 94%, #0000);
          background:    var(--_g) 0 0,    var(--_g1) 100% 0,    var(--_g2) 100% 100%,    var(--_g3) 0 100%;
          background-size: 30% 30%;
          animation: l38 .9s infinite ease-in-out;
          -webkit-animation: l38 .9s infinite ease-in-out;
        }

        .top {
          display: flex;
          flex-flow: column;
          gap: 5px;
          padding: 0;
          width: 100%;
        }

        .top > h4.title {
          border-bottom: var(--border-mobile);
          display: flex;
          align-items: center;
          color: var(--title-color);
          font-size: 1.3rem;
          font-weight: 500;
          margin: 0;
          padding: 0 0 6px 0;
        }

        .top > .desc {
          margin: 0;
          padding: 10px 0;
          color: var(--text-color);
          font-size: 1rem;
          font-family: var(--font-main), sans-serif;
        }

        .top > .desc > span {
          margin: 0;
          color: var(--gray-color);
          font-size: 0.85rem;
          line-height: 1.5;
          font-style: italic;
          font-family: var(--font-read), sans-serif;
        }

        form.fields {
          margin: 0;
          width: 100%;
          display: flex;
          flex-flow: column;
          justify-content: center;
          align-items: center;
          gap: 20px;
        }

        form.fields > .field {
          width: 100%;
          display: flex;
          flex-flow: column;
          justify-content: center;
          align-items: start;
          gap: 20px;
        }

        form.fields.center > .field {
          align-items: center;
        }

        form.fields .field .input-group {
          width: 100%;
          display: flex;
          flex-flow: column;
          justify-content: center;
          align-items: start;
          color: var(--text-color);
          gap: 5px;
          position: relative;
          transition: border-color 0.3s ease-in-out;
        }

        form.fields .field.bio .input-group {
          width: 100%;
        }

        form.fields .field.bio .input-group.code,
        form.fields .field.bio .input-group.email {
          grid-column: 1/3;
          width: 100%;
        }

        form.fields .field .input-group > svg {
          position: absolute;
          right: 10px;
          top: 38px;
          width: 20px;
          height: 20px;
        }

        form.fields .field .input-group > svg {
          display: none;
        }

        form.fields .field .input-group.success > svg {
          display: inline-block;
        }

        form.fields .field .input-group.failed > svg {
          display: inline-block;
        }

        form.fields .field .input-group.success > svg {
          color: var(--accent-color);
        }

        form.fields .field .input-group.failed > svg {
          color: var(--error-color);
        }

        form.fields label {
          padding: 0 0 5px 0;
          color: var(--text-color);
        }

        form.fields .field.bio label {
          padding: 0 0 0 5px;
        }

        form.fields label {
          color: var(--label-color);
          font-size: 1.1rem;
          font-family: var(--font-main), sans-serif;
          transition: all 0.3s ease-in-out;
          pointer-events: none;
        }

        form.fields .field input {
          border: var(--input-border);
          background-color: var(--background) !important;
          font-size: 1rem;
          width: 100%;
          height: 40px;
          outline: none;
          padding: 10px 12px;
          border-radius: 12px;
          color: var(--text-color);
        }
        
        form.fields .field input:-webkit-autofill,
        form.fields .field input:-webkit-autofill:hover, 
        form.fields .field input:-webkit-autofill:focus {
          -webkit-box-shadow: 0 0 0px 1000px var(--background) inset;
          -webkit-text-fill-color: var(--text-color) !important;
          transition: background-color 5000s ease-in-out 0s;
          color: var(--text-color) !important;
        }
        
        form.fields .field input:autofill {
          filter: none;
          color: var(--text-color) !important;
        }

        form.fields .field input:focus {
          border: var(--input-border-focus);
        }

        form.fields .field span.wrapper {
          display: flex;
          align-items: center;
          align-items: center;
          gap: 0;
          width: 100%;
        }
        form.fields .field span.wrapper {
          display: flex;
          align-items: center;
          align-items: center;
          gap: 0;
          width: 100%;
        }

        form.fields .field span.wrapper > span.icon {
          border: var(--input-border);
          border-right: none;
          max-height: 40px;
          min-height: 40px;
          font-size: 1rem;
          width: 40px;
          padding: 10px 12px;
          border-top-left-radius: 12px;
          border-bottom-left-radius: 12px;
          color: var(--gray-color);
          display: flex;
          align-items: center;
        }

        form.fields .field span.wrapper > input {
          font-size: 1rem;
          padding: 10px 12px;
          border-top-left-radius: 0;
          border-bottom-left-radius: 0;
          width: calc(100% - 40px);
          border-top-right-radius: 12px;
          border-bottom-right-radius: 12px;
        }

        form.fields .field .input-group.success > span.wrapper > input,
        form.fields .field .input-group.success > span.wrapper > input:focus,
        form.fields .field .input-group.success input,
        form.fields .field .input-group.success input:focus {
          border: var(--input-border-focus);
        }

        form.fields .field .input-group.failed > span.wrapper > input,
        form.fields .field .input-group.failed > span.wrapper > input:focus,
        form.fields .field .input-group.failed input,
        form.fields .field .input-group.failed input:focus {
          border: var(--input-border-error);
        }

        form.fields .field .input-group.success span.wrapper > input,
        form.fields .field .input-group.success input {
          color: var(--accent-color);
        }

        form.fields .field .input-group.failed span.wrapper > input,
        form.fields .field .input-group.failed input {
          color: var(--error-color);
        }

        form.fields label.focused {
          top: -10px;
          font-size: 0.9rem;
          background-color: var(--label-focus-background);
          padding: 0 5px;
        }

        form.fields .field span.status {
          color: var(--error-color);
          font-size: 0.95rem;
          display: none;
          padding: 0 0 0 5px;
        }

        form.fields .field .input-group.failed span.status {
          color: var(--error-color);
          font-size: 0.8rem;
          display: inline-block;
        }

        form.fields .field .input-group.success span.status {
          color: var(--accent-color);
          font-size: 0.8rem;
          display: inline-block;
        }

        form.fields .field .input-group.success span.status {
          display: none;
        }

        form.fields .actions {
          display: flex;
          align-items: center;
          justify-content: space-between;
          width: 100%;
          margin: 0 0 0 2px;
        }

        form.fields .actions > .action {
          border: none;
          background: var(--accent-linear);
          font-family: var(--font-main), sans-serif;
          text-decoration: none;
          color: var(--white-color);
          font-size: 1rem;
          font-weight: 600;
          cursor: pointer;
          display: flex;
          flex-flow: row;
          align-items: center;
          text-transform: capitalize;
          justify-content: center;
          padding: 7px 15px 8px;
          min-height: 35px;
          height: 35px;
          min-width: 60px;
          width: max-content;
          position: relative;
          border-radius: 50px;
          -webkit-border-radius: 50px;
          -moz-border-radius: 50px;
        }

        form.fields .actions > .action.prev svg path {
          fill: var(--text-color);
        }

        form.fields .actions > .action.next {
          color: var(--white-color);
          background: var(--stage-no-linear);
        }

        form.fields .actions > .action.next svg path {
          fill: var(--white-color);
        }

        form.fields .actions > .action.disabled {
          pointer-events: none;
        }

        @media screen and (max-width:600px) {
          ::-webkit-scrollbar {
            -webkit-appearance: none;
          }

          .top > .desc {
            margin: 0;
            padding: 6px 0 10px;
            font-size: 1rem;
            line-height: 1.5;
            font-family: var(--font-main), sans-serif;
          }

          form.fields .actions > .action {
            cursor: default !important;
          }
        }
      </style>
    `;
    }
  }

  class AuthorsLoader extends HTMLElement {
  	constructor() {
  		// We are not even going to touch this.
  		super();

  		// let's create our shadow root
  		this.shadowObj = this.attachShadow({ mode: "open" });

  		this.render();
  	}

  	render() {
  		this.shadowObj.innerHTML = this.getTemplate();
  	}

  	connectedCallback() {
  		
  	}

  	getTemplate() {
  		// Show HTML Here
  		return `
      ${this.getBody()}
      ${this.getStyles()}
    `;
  	}

  	getBody() {
  		return `
      <div class="loader">
        <div class="head">
          <span class="profile skeleton"></span>
          <span class="info">
            <span class="name skeleton"></span>
            <span class="followers skeleton"></span>
          </span>
        </div>
        <div class="action skeleton"></div>
      </div>
			<div class="loader">
        <div class="head">
          <span class="profile skeleton"></span>
          <span class="info">
            <span class="name skeleton"></span>
            <span class="followers skeleton"></span>
          </span>
        </div>
        <div class="action skeleton"></div>
      </div>
			<div class="loader">
        <div class="head">
          <span class="profile skeleton"></span>
          <span class="info">
            <span class="name skeleton"></span>
            <span class="followers skeleton"></span>
          </span>
        </div>
        <div class="action skeleton"></div>
      </div>
			<div class="loader">
        <div class="head">
          <span class="profile skeleton"></span>
          <span class="info">
            <span class="name skeleton"></span>
            <span class="followers skeleton"></span>
          </span>
        </div>
        <div class="action skeleton"></div>
      </div>
			<div class="loader">
        <div class="head">
          <span class="profile skeleton"></span>
          <span class="info">
            <span class="name skeleton"></span>
            <span class="followers skeleton"></span>
          </span>
        </div>
        <div class="action skeleton"></div>
      </div>
    `;
  	}

  	getStyles() {
  		return /*css*/`
	    <style>
	      *,
	      *:after,
	      *:before {
	        box-sizing: border-box !important;
	        font-family: inherit;
	        -webkit-box-sizing: border-box !important;
	      }

	      :host {
        	font-size: 16px;
					display: flex;
					flex-flow: row;
          flex-wrap: nowrap;
					padding: 15px 0;
					gap: 15px;
					width: 100%;
					min-width: 100%;
          overflow-x: scroll;
          scrollbar-width: none;
          -ms-overflow-style: none;
				}

        :host::-webkit-scrollbar {
          display: none;
          visibility: hidden;
        }

				.loader {
					padding: 0;
					display: flex;
					width: 156px;
          min-width: 156px;
          height: 160px;
          max-height: 160px;
					flex-flow: column !important;
					gap: 0;
					align-items: center;
					justify-content: space-between;
				}

				.loader .skeleton {
					background: var(--loader-gradient);
					background-size: 500% 500%;
					-webkit-animation: Gradient 2.25s ease infinite;
					-moz-animation: Gradient 2.25s ease infinite;
					animation: Gradient 2.25s ease infinite;
				}

				.loader > .head {
					padding: 0;
					margin: 0;
					width: 100%;
          height: max-content;
					display: flex;
					flex-flow: column;
					align-items: center;
          justify-content: center;
					flex-wrap: nowrap;
					gap: 10px;
				}

				.loader > .head > span.profile {
					display: inline-block;
					width: 80px;
          height: 80px;
					border-radius: 50px;
					-webkit-border-radius: 50px;
					-moz-border-radius: 50px;
				}

				.loader > .head > span.info {
					display: flex;
					flex-flow: column;
          align-items: center;
          justify-content: center;
					gap: 8px;
					min-width: 90%;
				}

				.loader > .head > .info .name {
					display: inline-block;
					margin: 0;
					padding: 0;
					width: 100%;
					height: 8px;
					border-radius: 3px;
					-webkit-border-radius: 3px;
					-moz-border-radius: 3px;
				}

				.loader > .head > .info .followers {
					display: inline-block;
					margin: 0;
					padding: 0;
					width: 80%;
					height: 8px;
					border-radius: 3px;
					-webkit-border-radius: 3px;
					-moz-border-radius: 3px;
				}

				.loader > .action {
					display: inline-block;
					margin: 0;
					padding: 0;
					width: 60%;
					height: 20px;
					border-radius: 4px;
					-webkit-border-radius: 4px;
					-moz-border-radius: 4px;
				}

				@keyframes Gradient {
				  0% {
				    background-position: 0 25%;
				    /*opacity: 0.5;*/
				  }
				  50% {
				    background-position: 25% 50%;
				    /*opacity: 0.75;*/
				  }
				  75% {
				    background-position: 50% 75%;
				    /*opacity: 0.75;*/
				  }
				  100% {
				    background-position: 75% 100%;
				    /*opacity: 1;*/
				  }
				}
	    </style>
    `;
  	}
  }

  class InfoLoader extends HTMLElement {
    constructor() {
      // We are not even going to touch this.
      super();

      // let's create our shadow root
      this.shadowObj = this.attachShadow({ mode: "open" });

      this.render();
    }

    render() {
      this.shadowObj.innerHTML = this.getTemplate();
    }

    connectedCallback() {
      
    }

    getTemplate() {
      // Show HTML Here
      return `
      ${this.getBody()}
      ${this.getStyles()}
    `;
    }

    getBody() {
      return /*html*/`
			<div class="loader author">
				<span class="head">
					<span class="start skeleton"></span>
          <span class="dot skeleton"></span>
          <span class="start skeleton"></span>
				</span>
		  </div>
		  <div class="loader actions">
		    <span class="head">
					<span class="start skeleton"></span>
					<span class="dot skeleton"></span>
					<span class="start skeleton"></span>
          <span class="dot skeleton"></span>
          <span class="start skeleton"></span>
          <span class="dot skeleton"></span>
				</span>
      </div>
      <div class="loader author">
				<span class="head">
          <span class="dot skeleton"></span>
          <span class="dot skeleton"></span>
          <span class="start skeleton"></span>
					<span class="start skeleton"></span>
				</span>
		  </div>
		  <div class="loader actions">
		    <span class="head">
					<span class="start skeleton"></span>
					<span class="dot skeleton"></span>
					<span class="start skeleton"></span>
          <span class="dot skeleton"></span>
          <span class="start skeleton"></span>
				</span>
      </div>
    `;
    }

    getStyles() {
      return /* css */`
	    <style>
	      *,
	      *:after,
	      *:before {
	        box-sizing: border-box !important;
	        font-family: inherit;
	        -webkit-box-sizing: border-box !important;
	      }

	      :host {
        	font-size: 16px;
				  display: flex;
				  flex-flow: column;
					padding: 0;
				  gap: 0;
				  width: 100%;
				}

				.loader {
				  padding: 8px 0;
				  display: flex;
				  flex-flow: column;
				  gap: 6px;
				  width: 100%;
				  max-width: 100%;
				}

				.loader .skeleton {
				  background: var(--loader-gradient);
				  background-size: 500% 500%;
				  -webkit-animation: Gradient 2.25s ease infinite;
				  -moz-animation: Gradient 2.25s ease infinite;
				  animation: Gradient 2.25s ease infinite;
				}

				.loader > .foot,
				.loader > .head {
				  /*border: var(--input-border);*/
				  padding: 0;
				  margin: 0;
				  display: flex;
				  flex-flow: row;
				  align-items: center;
				  flex-wrap: nowrap;
				  gap: 10px;
				  width: 100%;
				  max-width: 100%;
				}

				.loader  span.end,
				.loader  span.start {
				  display: inline-block;
				  height: 8px;
				  /*background-color: #6b728050;*/
				  border-radius: 3px;
				  -webkit-border-radius: 3px;
				  -moz-border-radius: 3px;
				}

				.loader > .foot >  span.start,
				.loader > .head >  span.end {
				  min-width: 40%;
				}

				.loader > .foot >  span.end,
				.loader > .head >  span.start {
				  min-width: 35%;
				}

				.loader  span.dot {
				  display: inline-block;
				  min-width: 15px;
				  height: 8px;
				  border-radius: 3px;
				  -webkit-border-radius: 3px;
				  -moz-border-radius: 3px;
				}

				.loader.actions > .head >  span.start {
          min-width: 20%;
				}
				@keyframes Gradient {
				  0% {
				    background-position: 0 25%;
				    /*opacity: 0.5;*/
				  }
				  50% {
				    background-position: 25% 50%;
				    /*opacity: 0.75;*/
				  }
				  75% {
				    background-position: 50% 75%;
				    /*opacity: 0.75;*/
				  }
				  100% {
				    background-position: 75% 100%;
				    /*opacity: 1;*/
				  }
				}

        @media screen and (max-width:660px) {
          .loader {
            width: 100%;
            max-width: 100%;
          }
        }
	    </style>
    `;
    }
  }

  class PeopleLoader extends HTMLElement {
  	constructor() {
  		// We are not even going to touch this.
  		super();

  		// let's create our shadow root
  		this.shadowObj = this.attachShadow({ mode: "open" });

  		this.render();
  	}

  	render() {
  		this.shadowObj.innerHTML = this.getTemplate();
  	}

  	connectedCallback() {
  		
  	}

  	getTemplate() {
  		// Show HTML Here
  		return `
      ${this.getBody()}
      ${this.getStyles()}
    `;
  	}

  	getBody() {
  		return `
      <div class="loader">
        <div class="head">
          <span class="profile skeleton"></span>
          <span class="info">
            <span class="name skeleton"></span>
            <span class="followers skeleton"></span>
          </span>
        </div>
				<span class="info">
          <span class="name skeleton"></span>
          <span class="dot skeleton"></span>
          <span class="followers skeleton"></span>
        </span>
				<div class="p skeleton"></div>
				<div class="actions">
					<span class="action skeleton"></span>
          <span class="action skeleton"></span>
          <span class="action skeleton"></span>
				</div>
      </div>
			 <div class="loader">
        <div class="head">
          <span class="profile skeleton"></span>
          <span class="info">
            <span class="name skeleton"></span>
            <span class="followers skeleton"></span>
          </span>
        </div>
				<span class="info">
          <span class="name skeleton"></span>
          <span class="dot skeleton"></span>
          <span class="followers skeleton"></span>
        </span>
				<div class="p skeleton"></div>
				<div class="actions">
					<span class="action skeleton"></span>
          <span class="action skeleton"></span>
          <span class="action skeleton"></span>
				</div>
      </div>
			 <div class="loader">
        <div class="head">
          <span class="profile skeleton"></span>
          <span class="info">
            <span class="name skeleton"></span>
            <span class="followers skeleton"></span>
          </span>
        </div>
				<span class="info">
          <span class="name skeleton"></span>
          <span class="dot skeleton"></span>
          <span class="followers skeleton"></span>
        </span>
				<div class="p skeleton"></div>
				<div class="actions">
					<span class="action skeleton"></span>
          <span class="action skeleton"></span>
          <span class="action skeleton"></span>
				</div>
      </div>
			 <div class="loader">
        <div class="head">
          <span class="profile skeleton"></span>
          <span class="info">
            <span class="name skeleton"></span>
            <span class="followers skeleton"></span>
          </span>
        </div>
				<span class="info">
          <span class="name skeleton"></span>
          <span class="dot skeleton"></span>
          <span class="followers skeleton"></span>
        </span>
				<div class="p skeleton"></div>
				<div class="actions">
					<span class="action skeleton"></span>
          <span class="action skeleton"></span>
          <span class="action skeleton"></span>
				</div>
      </div>
			 <div class="loader">
        <div class="head">
          <span class="profile skeleton"></span>
          <span class="info">
            <span class="name skeleton"></span>
            <span class="followers skeleton"></span>
          </span>
        </div>
				<span class="info">
          <span class="name skeleton"></span>
          <span class="dot skeleton"></span>
          <span class="followers skeleton"></span>
        </span>
				<div class="p skeleton"></div>
				<div class="actions">
					<span class="action skeleton"></span>
          <span class="action skeleton"></span>
          <span class="action skeleton"></span>
				</div>
      </div>
			
    `;
  	}

  	getStyles() {
  		return /*css*/`
	    <style>
	      *,
	      *:after,
	      *:before {
	        box-sizing: border-box !important;
	        font-family: inherit;
	        -webkit-box-sizing: border-box !important;
	      }

	      :host {
        	font-size: 16px;
					display: flex;
					flex-flow: column;
					padding: 15px 0;
					gap: 25px;
					width: 100%;
					min-width: 100%;
				}

				.loader {
					padding: 0;
					display: flex;
					width: 100%;
					max-width: 100%;
					flex-flow: column !important;
					gap: 10px;
				}

				.loader .skeleton {
					background: var(--loader-gradient);
					background-size: 500% 500%;
					-webkit-animation: Gradient 2.25s ease infinite;
					-moz-animation: Gradient 2.25s ease infinite;
					animation: Gradient 2.25s ease infinite;
				}

				.loader > .head {
					padding: 0;
					margin: 0;
					width: 80%;
					display: flex;
					flex-flow: row;
					align-items: center;
					flex-wrap: nowrap;
					gap: 10px;
				}

				.loader > .head > span.profile {
					display: inline-block;
					height: 32px;
					width: 32px;
					border-radius: 50px;
					-webkit-border-radius: 50px;
					-moz-border-radius: 50px;
				}

				.loader > .head > span.info {
					display: flex;
					flex-flow: column;
					gap: 8px;
					min-width: calc(100% - 45px);
				}

				.loader > .head > .info .name {
					display: inline-block;
					margin: 0;
					padding: 0;
					width: 100%;
					height: 8px;
					border-radius: 3px;
					-webkit-border-radius: 3px;
					-moz-border-radius: 3px;
				}

				.loader > .head > .info .followers {
					display: inline-block;
					margin: 0;
					padding: 0;
					width: 50%;
					height: 8px;
					border-radius: 3px;
					-webkit-border-radius: 3px;
					-moz-border-radius: 3px;
				}

				.loader > span.info {
					display: flex;
					flex-flow: row;
					gap: 8px;
					min-width: calc(100% - 45px);
				}

				.loader > .info .name {
					display: inline-block;
					margin: 0;
					padding: 0;
					width: 20%;
					height: 8px;
					border-radius: 3px;
					-webkit-border-radius: 3px;
					-moz-border-radius: 3px;
				}

        .loader > .info .dot {
					display: inline-block;
					margin: 0;
					padding: 0;
					width: 20px;
					height: 8px;
					border-radius: 3px;
					-webkit-border-radius: 3px;
					-moz-border-radius: 3px;
				}

				.loader > .info .followers {
					display: inline-block;
					margin: 0;
					padding: 0;
					width: 10%;
					height: 8px;
					border-radius: 3px;
					-webkit-border-radius: 3px;
					-moz-border-radius: 3px;
				}

				.loader > .actions {
					display: flex;
					flex-flow: row;
					gap: 20px;
				}

				.loader > .actions > .action {
					display: inline-block;
					margin: 0;
					padding: 0;
					width: 50px;
					height: 10px;
					border-radius: 4px;
					-webkit-border-radius: 4px;
					-moz-border-radius: 4px;
				}

				.loader > .p {
					display: inline-block;
					margin: 0;
					padding: 0;
					width: 80%;
					height: 5px;
					border-radius: 4px;
					-webkit-border-radius: 4px;
					-moz-border-radius: 4px;
				}

				@keyframes Gradient {
				  0% {
				    background-position: 0 25%;
				    /*opacity: 0.5;*/
				  }
				  50% {
				    background-position: 25% 50%;
				    /*opacity: 0.75;*/
				  }
				  75% {
				    background-position: 50% 75%;
				    /*opacity: 0.75;*/
				  }
				  100% {
				    background-position: 75% 100%;
				    /*opacity: 1;*/
				  }
				}
	    </style>
    `;
  	}
  }

  class PostLoader extends HTMLElement {
  	constructor() {
  		// We are not even going to touch this.
  		super();

  		// let's create our shadow root
  		this.shadowObj = this.attachShadow({ mode: "open" });

  		this.render();
  	}

  	render() {
  		this.shadowObj.innerHTML = this.getTemplate();
  	}

  	connectedCallback() {
  		
  	}

  	getTemplate() {
  		// Show HTML Here
  		return `
      ${this.getBody()}
      ${this.getStyles()}
    `;
  	}

  	getBody() {
  		return /*html*/`
			<div class="loader author">
				<span class="head">
          <span class="dot skeleton"></span>
					<span class="start skeleton"></span>
				</span>
		  </div>
		  <div class="loader">
        <div class="body thin skeleton"></div>
			  <div class="body thin skeleton"></div>
			  <span class="overlap skeleton"></span>
		  </div>
		  <div class="loader">
		    <span class="overlap skeleton"></span>
			  <div class="body skeleton"></div>
		  </div>
		  <div class="loader actions">
		    <span class="head">
					<span class="start skeleton"></span>
					<span class="dot skeleton"></span>
					<span class="start skeleton"></span>
          <span class="dot skeleton"></span>
				</span>
      </div>
    `;
  	}

  	getStyles() {
  		return /* css */`
	    <style>
	      *,
	      *:after,
	      *:before {
	        box-sizing: border-box !important;
	        font-family: inherit;
	        -webkit-box-sizing: border-box !important;
	      }

	      :host {
        	font-size: 16px;
				  display: flex;
				  flex-flow: column;
					padding: 5px 0;
				  gap: 0;
				  width: 100%;
					min-width: 100%;
				}

				.loader {
				  padding: 8px 0;
				  display: flex;
				  flex-flow: column;
				  gap: 6px;
				  width: 100%;
				  max-width: 100%;
				}

				.loader .skeleton {
				  background: var(--loader-gradient);
				  background-size: 500% 500%;
				  -webkit-animation: Gradient 2.25s ease infinite;
				  -moz-animation: Gradient 2.25s ease infinite;
				  animation: Gradient 2.25s ease infinite;
				}

				.loader > .foot,
				.loader > .head{
				  /*border: var(--input-border);*/
				  padding: 0;
				  margin: 0;
				  display: flex;
				  flex-flow: row;
				  align-items: center;
				  flex-wrap: nowrap;
				  gap: 10px;
				  width: 70%;
				  max-width: 100%;
				}
				.loader  span.end,
				.loader  span.start {
				  display: inline-block;
				  height: 8px;
				  /*background-color: #6b728050;*/
				  border-radius: 3px;
				  -webkit-border-radius: 3px;
				  -moz-border-radius: 3px;
				}

				.loader > .foot >  span.start,
				.loader > .head >  span.end {
				  min-width: 65%;
				}

				.loader > .foot >  span.end,
				.loader > .head >  span.start {
				  min-width: 25%;
				}

				.loader  span.dot {
				  display: inline-block;
				  min-width: 15px;
				  height: 8px;
				  border-radius: 3px;
				  -webkit-border-radius: 3px;
				  -moz-border-radius: 3px;
				}

				.loader.actions > .head >  span.start {
          min-width: 30px
				  max-width: 40px;
          width: 40px;
				}

				.loader > .body {
				  /*border: var(--input-border);*/
				  margin: 0;
				  padding: 0;
				  width: 100%;
				  height: 8px;
				  border-radius: 3px;
				  -webkit-border-radius: 3px;
				  -moz-border-radius: 3px;
				}

				.loader > .overlap {
				  /*border: var(--input-border);*/
				  margin: 0;
				  padding: 0;
				  width: 100%;
				  height: 8px;
				  border-radius: 3px;
				  -webkit-border-radius: 3px;
				  -moz-border-radius: 3px;
				}

				.loader > .full {
				  /*border: var(--input-border);*/
				  margin: 0;
				  padding: 0;
				  width: 100%;
				  height: 8px;
				  border-radius: 3px;
				  -webkit-border-radius: 3px;
				  -moz-border-radius: 3px;
				}

				.loader > .body.thin {
					height: 10px;
				}
				@keyframes Gradient {
				  0% {
				    background-position: 0 25%;
				    /*opacity: 0.5;*/
				  }
				  50% {
				    background-position: 25% 50%;
				    /*opacity: 0.75;*/
				  }
				  75% {
				    background-position: 50% 75%;
				    /*opacity: 0.75;*/
				  }
				  100% {
				    background-position: 75% 100%;
				    /*opacity: 1;*/
				  }
				}

        @media screen and (max-width:660px) {
          .loader {
            width: 100%;
            max-width: 100%;
          }
        }
	    </style>
    `;
  	}
  }

  class StoryLoader extends HTMLElement {
  	constructor() {
  		// We are not even going to touch this.
  		super();

  		// let's create our shadow root
  		this.shadowObj = this.attachShadow({ mode: "open" });

  		this.render();
  	}

  	render() {
  		this.shadowObj.innerHTML = this.getTemplate();
  	}

  	connectedCallback() {
  		
  	}

  	getTemplate() {
  		// Show HTML Here
  		return `
      ${this.getBody()}
      ${this.getStyles()}
    `;
  	}

  	getBody() {
  		return /* html */`
			<div class="loader">
				<span class="head">
					<span class="start skeleton"></span>
					<span class="dot skeleton"></span>
					<span class="end skeleton"></span>
				</span>
			  <div class="body thin skeleton"></div>
			  <span class="overlap skeleton"></span>
		  </div>
		  <div class="loader">
		    <div class="body skeleton"></div>
		    <span class="foot">
					<span class="start skeleton"></span>
					<span class="dot skeleton"></span>
					<span class="end skeleton"></span>
				</span>
		  </div>
		  <div class="loader">
				<span class="head">
					<span class="start skeleton"></span>
					<span class="dot skeleton"></span>
					<span class="end skeleton"></span>
				</span>
			  <div class="body thin skeleton"></div>
			  <span class="overlap skeleton"></span>
		  </div>
		  <div class="loader">
		    <span class="foot">
					<span class="start skeleton"></span>
					<span class="dot skeleton"></span>
					<span class="end skeleton"></span>
				</span>
			  <div class="body skeleton"></div>
		  </div>
    `;
  	}

  	getStyles() {
  		return /* css */`
	    <style>
	      *,
	      *:after,
	      *:before {
	        box-sizing: border-box !important;
	        font-family: inherit;
	        -webkit-box-sizing: border-box !important;
	      }

	      :host {
        font-size: 16px;
				  padding: 10px 0;
				  display: flex;
				  flex-flow: column;
				  gap: 5px;
				  width: 100%;
					min-width: 100%;
				}

				.loader {
				  padding: 10px 0;
				  display: flex;
				  flex-flow: column;
				  gap: 6px;
				  /*max-width: 400px;*/
				  width: 100%;
				  min-width: 100%;
				}

				.loader .skeleton {
				  background: var(--loader-gradient);
				  background-size: 500% 500%;
				  -webkit-animation: Gradient 2.25s ease infinite;
				  -moz-animation: Gradient 2.25s ease infinite;
				  animation: Gradient 2.25s ease infinite;
				}

				.loader > .foot,
				.loader > .head{
				  /*border: var(--input-border);*/
				  padding: 0;
				  margin: 0;
				  display: flex;
				  flex-flow: row;
				  align-items: center;
				  flex-wrap: nowrap;
				  gap: 10px;
				  width: 70%;
				  max-width: 100%;
				}
				.loader  span.end,
				.loader  span.start {
				  display: inline-block;
				  height: 8px;
				  /*background-color: #6b728050;*/
				  border-radius: 3px;
				  -webkit-border-radius: 3px;
				  -moz-border-radius: 3px;
				}

				.loader > .foot >  span.start,
				.loader > .head >  span.end {
				  min-width: 65%;
				}

				.loader > .foot >  span.end,
				.loader > .head >  span.start {
				  min-width: 25%;
				}

				.loader  span.dot {
				  display: inline-block;
				  min-width: 15px;
				  height: 8px;
				  border-radius: 3px;
				  -webkit-border-radius: 3px;
				  -moz-border-radius: 3px;
				}

				.loader > .body {
				  /*border: var(--input-border);*/
				  margin: 0;
				  padding: 0;
				  width: 100%;
				  height: 8px;
				  border-radius: 3px;
				  -webkit-border-radius: 3px;
				  -moz-border-radius: 3px;
				}

				.loader > .overlap {
				  /*border: var(--input-border);*/
				  margin: 0;
				  padding: 0;
				  width: 100%;
				  height: 8px;
				  border-radius: 3px;
				  -webkit-border-radius: 3px;
				  -moz-border-radius: 3px;
				}

				.loader > .full {
				  /*border: var(--input-border);*/
				  margin: 0;
				  padding: 0;
				  width: 100%;
				  height: 8px;
				  border-radius: 3px;
				  -webkit-border-radius: 3px;
				  -moz-border-radius: 3px;
				}

				.loader > .body.thin {
					height: 10px;
				}

				@keyframes Gradient {
				  0% {
				    background-position: 0 25%;
				    /*opacity: 0.5;*/
				  }
				  50% {
				    background-position: 25% 50%;
				    /*opacity: 0.75;*/
				  }
				  75% {
				    background-position: 50% 75%;
				    /*opacity: 0.75;*/
				  }
				  100% {
				    background-position: 75% 100%;
				    /*opacity: 1;*/
				  }
				}
				@media screen and (max-width:660px) {
          .loader {
            width: 100%;
            max-width: 100%;
          }
        }
	    </style>
    `;
  	}
  }

  class TopicsLoader extends HTMLElement {
  	constructor() {
  		// We are not even going to touch this.
  		super();

  		// let's create our shadow root
  		this.shadowObj = this.attachShadow({ mode: "open" });

  		this.render();
  	}

  	render() {
  		this.shadowObj.innerHTML = this.getTemplate();
  	}

  	connectedCallback() {
  		
  	}

  	getTemplate() {
  		// Show HTML Here
  		return `
      ${this.getBody()}
      ${this.getStyles()}
    `;
  	}

  	getBody() {
  		return `
      <span class="topic one skeleton"></span>
      <span class="topic two skeleton"></span>
      <span class="topic three skeleton"></span>
      <span class="topic four skeleton"></span>
      <span class="topic five skeleton"></span>
      <span class="topic six skeleton"></span>
      <span class="topic seven skeleton"></span>
      <span class="topic eight skeleton"></span>
      <span class="topic nine skeleton"></span>
      <span class="topic ten skeleton"></span>
      <span class="topic eleven skeleton"></span>
    `;
  	}

  	getStyles() {
  		return /* css */`
	    <style>
	      *,
	      *:after,
	      *:before {
	        box-sizing: border-box !important;
	        font-family: inherit;
	        -webkit-box-sizing: border-box !important;
	      }
	
	      :host {
        	font-size: 16px;
					padding: 8px 0 0;
					display: flex;
					flex-flow: row;
					flex-wrap: wrap;
					gap: 15px;
					width: 100%;
				}
					
				.topic {
					display: inline-block;
					width: 25%;
					height: 17px;
					border-radius: 50px;
					-webkit-border-radius: 50px;
					-moz-border-radius: 50px;
				}
					
				.topic:nth-of-type(odd) {
					width: 20%;
				}
					
				.topic.seven,
				.topic.five {
					width: 40%;
				}
					
				.skeleton {
					background: var(--loader-gradient);
					background-size: 500% 500%;
					-webkit-animation: Gradient 2.25s ease infinite;
					-moz-animation: Gradient 2.25s ease infinite;
					animation: Gradient 2.25s ease infinite;
				}
					
				@keyframes Gradient {
					0% {
						background-position: 0 25%;
					}
					50% {
						background-position: 25% 50%;
					}
					75% {
						background-position: 50% 75%;
					}
					100% {
						background-position: 75% 100%;
					}
				}
	    </style>
    `;
  	}
  }

  class TopicLoader extends HTMLElement {
  	constructor() {
  		// We are not even going to touch this.
  		super();

  		// let's create our shadow root
  		this.shadowObj = this.attachShadow({ mode: "open" });

  		this.render();
  	}

  	render() {
  		this.shadowObj.innerHTML = this.getTemplate();
  	}

  	connectedCallback() {
  		
  	}

  	getTemplate() {
  		// Show HTML Here
  		return `
      ${this.getBody()}
      ${this.getStyles()}
    `;
  	}

  	getBody() {
  		return /*html*/`
      <div class="loader">
        <div class="head">
          <span class="profile skeleton"></span>
          <span class="name skeleton"></span>
          <span class="info">
            <span class="name skeleton"></span>
            <span class="dot skeleton"></span>
            <span class="followers skeleton"></span>
          </span>
        </div>
        <div class="actions">
					<span class="action skeleton"></span>
          <span class="action skeleton"></span>
          <span class="action skeleton"></span>
				</div>
      </div>
      <div class="loader">
        <div class="head">
          <span class="profile skeleton"></span>
          <span class="name skeleton"></span>
          <span class="info">
            <span class="followers skeleton"></span>
            <span class="dot skeleton"></span>
            <span class="name skeleton"></span>
          </span>
        </div>
         <div class="actions">
					<span class="action skeleton"></span>
          <span class="action skeleton"></span>
          <span class="action skeleton"></span>
				</div>
      </div>
      <div class="loader">
        <div class="head">
          <span class="profile skeleton"></span>
          <span class="name skeleton"></span>
          <span class="info">
            <span class="name skeleton"></span>
            <span class="dot skeleton"></span>
            <span class="followers skeleton"></span>
          </span>
        </div>
         <div class="actions">
					<span class="action skeleton"></span>
          <span class="action skeleton"></span>
          <span class="action skeleton"></span>
				</div>
      </div>
      <div class="loader">
        <div class="head">
          <span class="profile skeleton"></span>
          <span class="name skeleton"></span>
          <span class="info">
            <span class="followers skeleton"></span>
            <span class="dot skeleton"></span>
            <span class="name skeleton"></span>
          </span>
        </div>
        <div class="actions">
					<span class="action skeleton"></span>
          <span class="action skeleton"></span>
          <span class="action skeleton"></span>
				</div>
      </div>
    `;
  	}

  	getStyles() {
  		return /*css*/`
	    <style>
	      *,
	      *:after,
	      *:before {
	        box-sizing: border-box !important;
	        font-family: inherit;
	        -webkit-box-sizing: border-box !important;
	      }

	      :host {
        	font-size: 16px;
					display: flex;
					flex-flow: column;
					padding: 20px 0 15px;
					gap: 20px;
					width: 100%;
					max-width: 100%;
				}

				.loader {
					padding: 0;
					display: flex;
					width: 100%;
					max-width: 100%;
					flex-flow: column;
					gap: 10px;
				}

				.loader .skeleton {
					background: var(--loader-gradient);
					background-size: 500% 500%;
					-webkit-animation: Gradient 2.25s ease infinite;
					-moz-animation: Gradient 2.25s ease infinite;
					animation: Gradient 2.25s ease infinite;
				}

				.loader > .head {
					padding: 0;
					margin: 0;
					width: 100%;
					display: flex;
					flex-flow: column;
					align-items: start;
					flex-wrap: nowrap;
					gap: 8px;
				}

				.loader > .head > span.profile {
					display: inline-block;
					height: 8px;
					width: 90%;
					border-radius: 50px;
					-webkit-border-radius: 50px;
					-moz-border-radius: 50px;
				}

        .loader > .head > .name {
					display: inline-block;
					margin: 0;
					padding: 0;
					width: 70%;
					height: 8px;
					border-radius: 3px;
					-webkit-border-radius: 3px;
					-moz-border-radius: 3px;
				}

				.loader > .head > span.info {
					display: flex;
					flex-flow: row;
					gap: 8px;
					min-width: calc(100% - 45px);
				}

				.loader > .head > .info .name {
					display: inline-block;
					margin: 0;
					padding: 0;
					width: 20%;
					height: 8px;
					border-radius: 3px;
					-webkit-border-radius: 3px;
					-moz-border-radius: 3px;
				}

        .loader > .head > .info .dot {
					display: inline-block;
					margin: 0;
					padding: 0;
					width: 20px;
					height: 8px;
					border-radius: 3px;
					-webkit-border-radius: 3px;
					-moz-border-radius: 3px;
				}

				.loader > .head > .info .followers {
					display: inline-block;
					margin: 0;
					padding: 0;
					width: 10%;
					height: 8px;
					border-radius: 3px;
					-webkit-border-radius: 3px;
					-moz-border-radius: 3px;
				}

				.loader > .actions {
					display: flex;
					flex-flow: row;
					gap: 20px;
				}

				.loader > .actions > .action {
					display: inline-block;
					margin: 0;
					padding: 0;
					width: 20%;
					height: 10px;
					border-radius: 4px;
					-webkit-border-radius: 4px;
					-moz-border-radius: 4px;
				}

				@keyframes Gradient {
				  0% {
				    background-position: 0 25%;
				    /*opacity: 0.5;*/
				  }
				  50% {
				    background-position: 25% 50%;
				    /*opacity: 0.75;*/
				  }
				  75% {
				    background-position: 50% 75%;
				    /*opacity: 0.75;*/
				  }
				  100% {
				    background-position: 75% 100%;
				    /*opacity: 1;*/
				  }
				}
	    </style>
    `;
  	}
  }

  class HoverLoader extends HTMLElement {
  	constructor() {
  		// We are not even going to touch this.
  		super();

  		// let's create our shadow root
  		this.shadowObj = this.attachShadow({ mode: "open" });

  		this.render();
  	}

  	render() {
  		this.shadowObj.innerHTML = this.getTemplate();
  	}

  	connectedCallback() {
  		
  	}

  	getTemplate() {
  		// Show HTML Here
  		return `
      ${this.getBody()}
      ${this.getStyles()}
    `;
  	}

  	getBody() {
  		return `
      <div class="loader">
        <div class="head">
          <span class="profile skeleton"></span>
          <span class="info">
            <span class="name skeleton"></span>
            <span class="followers skeleton"></span>
          </span>
        </div>
        <span class="stats">
          <span class="followers skeleton"></span>
          <span class="dot skeleton"></span>
          <span class="following skeleton"></span>
        </span>
        <span class="text">
          <span class="name skeleton"></span>
          <span class="name skeleton"></span>
          <span class="followers skeleton"></span>
        </span>
        <div class="actions">
          <span class="action skeleton"></span>
          <span class="action skeleton"></span>
          <span class="action skeleton"></span>
        </div>
      </div>
    `;
  	}

  	getStyles() {
  		return /*css*/`
	    <style>
	      *,
	      *:after,
	      *:before {
	        box-sizing: border-box !important;
	        font-family: inherit;
	        -webkit-box-sizing: border-box !important;
	      }

	      :host {
        	font-size: 16px;
					display: flex;
					flex-flow: column;
					padding: 0;
					gap: 15px;
					width: 100%;
					min-width: 100%;
          height: max-content;
				}

				.loader {
					padding: 0;
					display: flex;
					width: 100%;
					max-width: 100%;
					flex-flow: column !important;
					gap: 20px;
					align-items: start;
				}

				.loader .skeleton {
					background: var(--loader-gradient);
					background-size: 500% 500%;
					-webkit-animation: Gradient 2.25s ease infinite;
					-moz-animation: Gradient 2.25s ease infinite;
					animation: Gradient 2.25s ease infinite;
				}

				.loader > .head {
					padding: 0;
					margin: 0;
					width: 90%;
					display: flex;
					flex-flow: row;
					align-items: center;
					flex-wrap: nowrap;
					gap: 10px;
				}

				.loader > .head > span.profile {
					display: inline-block;
					height: 32px;
					width: 32px;
					border-radius: 50px;
					-webkit-border-radius: 50px;
					-moz-border-radius: 50px;
				}

				.loader > .head > span.info {
					display: flex;
					flex-flow: column;
					gap: 8px;
					min-width: calc(100% - 45px);
				}

				.loader > .head > .info .name {
					display: inline-block;
					margin: 0;
					padding: 0;
					width: 100%;
					height: 8px;
					border-radius: 3px;
					-webkit-border-radius: 3px;
					-moz-border-radius: 3px;
				}

				.loader > .head > .info .followers {
					display: inline-block;
					margin: 0;
					padding: 0;
					width: 50%;
					height: 8px;
					border-radius: 3px;
					-webkit-border-radius: 3px;
					-moz-border-radius: 3px;
				}

        .loader > span.stats {
					display: flex;
					flex-flow: row !important;
					gap: 10px;
					min-width: 90%;
				}

				.loader > span.stats .followers {
					display: inline-block;
					margin: 0;
					padding: 0;
					width: 30%;
					height: 9px;
					border-radius: 3px;
					-webkit-border-radius: 3px;
					-moz-border-radius: 3px;
				}

        .loader > span.stats .following {
					display: inline-block;
					margin: 0;
					padding: 0;
					width: 30%;
					height: 9px;
					border-radius: 3px;
					-webkit-border-radius: 3px;
					-moz-border-radius: 3px;
				}

				.loader > span.stats .dot {
					display: inline-block;
					margin: 0;
					padding: 0;
					width: 9px;
					height: 9px;
					border-radius: 50px;
				}

        .loader > span.text {
					display: flex;
					flex-flow: column;
					gap: 5px;
					min-width: 90%;
				}

				.loader > span.text .name {
					display: inline-block;
					margin: 0;
					padding: 0;
					width: 100%;
					height: 5px;
					border-radius: 3px;
					-webkit-border-radius: 3px;
					-moz-border-radius: 3px;
				}

				.loader > span.text .followers {
					display: inline-block;
					margin: 0;
					padding: 0;
					width: 70%;
					height: 5px;
					border-radius: 3px;
					-webkit-border-radius: 3px;
					-moz-border-radius: 3px;
				}

        .loader > .actions {
					display: flex;
					flex-flow: row !important;
					gap: 10px;
          margin: 0 0 3px 0;
					min-width: 90%;
				}

				.loader > .actions > .action {
					display: inline-block;
					margin: 0;
					padding: 0;
					width: 40px;
					height: 15px;
					border-radius: 50px;
				}

				@keyframes Gradient {
				  0% {
				    background-position: 0 25%;
				    /*opacity: 0.5;*/
				  }
				  50% {
				    background-position: 25% 50%;
				    /*opacity: 0.75;*/
				  }
				  75% {
				    background-position: 50% 75%;
				    /*opacity: 0.75;*/
				  }
				  100% {
				    background-position: 75% 100%;
				    /*opacity: 1;*/
				  }
				}

        @media screen and (max-width:660px) {
          :host {
            font-size: 16px;
            display: flex;
            flex-flow: column;
            padding: 5px 0 3px;
            gap: 20px;
            width: 100%;
            min-width: 100%;
            height: max-content;
          }
        }
	    </style>
    `;
  	}
  }

  class PostSection extends HTMLElement {
    constructor() {
      // We are not even going to touch this.
      super();

      // Get default active tab
      this._active = this.getAttribute('active');

      // let's create our shadow root
      this.shadowObj = this.attachShadow({ mode: "open" });

      this.render();
    }

    render() {
      this.shadowObj.innerHTML = this.getTemplate();
    }

    connectedCallback() {
      // Select content container
      const contentContainer = this.shadowObj.querySelector('div.feeds');
      // Select the tabContainer
      const tabContainer = this.shadowObj.querySelector('ul#tab');

      // If contentContainer and tabContainer exists
      if (contentContainer && tabContainer) {
        this.updateActiveTab(this._active);
        this.activateTab(contentContainer, tabContainer);
      }
    }

    disableScroll() {
      // Get the current page scroll position
      let scrollTop = window.scrollY || document.documentElement.scrollTop;
      let scrollLeft = window.scrollX || document.documentElement.scrollLeft;
      document.body.classList.add("stop-scrolling");

      // if any scroll is attempted, set this to the previous value
      window.onscroll = function () {
        window.scrollTo(scrollLeft, scrollTop);
      };
    }

    enableScroll() {
      document.body.classList.remove("stop-scrolling");
      window.onscroll = function () { };
    }

    updateActiveTab = active => {
      // Select tab with active class
      const tab = this.shadowObj.querySelector(`ul#tab > li.${active}`);
      // select line
      const line = this.shadowObj.querySelector('ul#tab span.line');

      if (tab && line) {
        tab.classList.add('active');

        // Calculate half tab width - 10px
        const tabWidth = (tab.offsetWidth/2) - 20;

        // update line
        line.style.left = `${tab.offsetLeft + tabWidth}px`;
      }
      else {
        // select replies tab
        const replies = this.shadowObj.querySelector(`ul#tab > li.replies`);
        replies.classList.add('active');
      }
    }

    activateTab = (contentContainer, tabContainer) => {
      const outerThis = this;

      if (tabContainer && contentContainer) {
        const line = tabContainer.querySelector('span.line');
        const tabItems = tabContainer.querySelectorAll('li.tab-item');
        let activeTab = tabContainer.querySelector('li.tab-item.active');

        tabItems.forEach(tab => {
          tab.addEventListener('click', e => {
            e.preventDefault();
            e.stopPropagation();

            // Calculate half tab width - 10px
            const tabWidth = (tab.offsetWidth/2) - 20;

            line.style.left = `${tab.offsetLeft + tabWidth}px`;

            if (tab.dataset.element === activeTab.dataset.element) {
              return;
            }
            else {
              activeTab.classList.remove('active');
              tab.classList.add('active');
              activeTab = tab;

              //get current feed
              const currentFeed = outerThis.getCurrentFeed(tab.dataset.element);

              // Updating History State
              window.history.pushState(
                { tab: tab.dataset.element, content: currentFeed},
                tab.dataset.element, `${tab.getAttribute('url')}`
              );

              // Change active attribute
              outerThis.setAttribute('active', tab.dataset.element);

              switch (tab.dataset.element) {
                case "replies":
                  contentContainer.innerHTML = outerThis.getReplies();
                  break;
                case "likes":
                  contentContainer.innerHTML = outerThis.getLikes();
                  break;
              }

            }
          });
        });

        // Update state on window.onpopstate
        window.onpopstate = event => {
          // This event will be triggered when the browser's back button is clicked

          if (event.state) {
            if (event.state.popup) {
              return;
            }
            
            if (event.state.page) {
              outerThis.updatePage(event.state.content);
            }
            else if (event.state.tab) {

              // Select the state tab
              const tab = outerThis.shadowObj.querySelector(`ul#tab > li.${event.state.tab}`);

              if (tab) {
                activeTab.classList.remove('active');

                tab.classList.add('active');
                activeTab = tab;

                // Calculate half tab width - 10px
                const tabWidth = (tab.offsetWidth/2) - 20;

                // Update the line
                line.style.left = `${tab.offsetLeft + tabWidth}px`;

                outerThis.updateState(event.state, contentContainer);

                // Update active attribute
                outerThis.setAttribute('active', event.state.tab);
              }
            }
          }
          else {
            // Select li with class name as current and content Container
            const currentTab = outerThis.shadowObj.querySelector(`ul#tab > li.tab-item.${this._active}`);
            if (currentTab) {
              activeTab.classList.remove('active');
              activeTab = currentTab;
              currentTab.classList.add('active');

              // Calculate half tab width - 10px
              const tabWidth = (currentTab.offsetWidth/2) - 20;

              // update line position
              line.style.left = `${currentTab.offsetLeft + tabWidth}px`;


              outerThis.updateDefault(contentContainer);

              // Update active attribute
              outerThis.setAttribute('active', currentTab.dataset.element);
            }
          }
        };
      }
    }

    updatePage = content => {
      // select body
      const body = document.querySelector('body');

      // populate content
      body.innerHTML = content;
    }

    updateState = (state, contentContainer)=> {
      // populate content
      contentContainer.innerHTML = state.content;
    }

    updateDefault = contentContainer => {
      contentContainer.innerHTML = this.getContainer(this._active);
    }

    getCurrentFeed = tab => {
      switch (tab) {
        case "replies":
          return this.getReplies();
        case "likes":
          return this.getLikes();
        default:
          return this.getReplies();
      }
    }

    getTemplate() {
      // Show HTML Here
      return `
      ${this.getBody()}
      ${this.getStyles()}
    `;
    }

    getBody = () => {
      return /* html */`
      <div class="content-container">
        ${this.getContent()}
      </div>
    `
    }

    getContent = () => {
      return /* html */`
      ${this.getTab()}
      <div class="feeds">
        ${this.getContainer(this.getAttribute('active'))}
      </div>

		`
    }

    getTab = () => {
      // Get url 
      let url = this.getAttribute('url');

      // convert url to lowercase
      url = url.toLowerCase();

      return /* html */`
      <div class="tab-control">
        <ul id="tab" class="tab">
          <li url="${url}/replies" data-element="replies" class="tab-item replies">
            <span class="text">Replies</span>
          </li>
          <li url="${url}/likes" data-element="likes" class="tab-item likes">
            <span class="text">Likes</span>
          </li>
          <span class="line"></span>
        </ul>
      </div>
    `
    }

    getContainer = active => {
      // Switch between replies and likes
      switch (active) {
        case "replies":
          return this.getReplies();
        case "likes":
          return this.getLikes();
        default:
          return this.getReplies();
      }
    }

    getReplies = () => {
      return /*html*/`
      <replies-feed hash="${this.getAttribute('hash')}" replies="${this.getAttribute('replies')}" page="1" no-preview="true"
        url="${this.getAttribute('replies-url')}" kind="${this.getAttribute('kind')}">
      </replies-feed>
    `
    }

    getLikes = () => {
      return /*html*/`
      <people-feed hash="${this.getAttribute('hash')}" total="${this.getAttribute('likes')}" page="1"
        url="${this.getAttribute('likes-url')}" kind="likes">
      </people-feed>
    `
    }

    getLoader = () => {
      return `
			<post-loader speed="300"></post-loader>
		`
    }

    getStyles() {
      return /* css */`
      <style>
        *,
        *:after,
        *:before {
          box-sizing: border-box !important;
          font-family: inherit;
          -webkit-box-sizing: border-box !important;
        }

        *:focus {
          outline: inherit !important;
        }

        *::-webkit-scrollbar {
          -webkit-appearance: none;
        }

        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
          padding: 0;
          margin: 0;
          font-family: inherit;
        }

        p,
        ul,
        ol {
          padding: 0;
          margin: 0;
        }

        a {
          text-decoration: none;
        }

        :host {
          font-size: 16px;
          padding: 0;
          width: 100%;
          display: flex;
          flex-flow: column;
          gap: 0px;
        }

        div.content-container {
          position: relative;
          width: 100%;
          display: flex;
          flex-flow: column;
          gap: 0;
        }

        div.content-container > .feeds {
          width: 100%;
          display: flex;
          flex-flow: column;
          align-items: start;
          gap: 0;
        }

        .tab-control {
          border-bottom: var(--border);
          background-color: var(--background);
          display: flex;
          flex-flow: column;
          gap: 0;
          z-index: 3;
          width: 100%;
          position: sticky;
          top: 60px;
        }

        .tab-control > .author {
          border-bottom: var(--border);
          padding: 10px 0;
          display: flex;
          align-items: center;
          gap: 5px;
          font-weight: 400;
          color: var(--gray-color);
          font-family: var(--font-mono), monospace;
          font-size: 0.9rem;
        }

        .tab-control > ul.tab {
          height: max-content;
          width: 100%;
          padding: 5px 0 0 0;
          margin: 0;
          list-style-type: none;
          display: flex;
          gap: 0;
          align-items: center;
          max-width: 100%;
          overflow-x: scroll;
          -ms-overflow-style: none;
          scrollbar-width: none;
        }

        .tab-control > ul.tab::-webkit-scrollbar {
          display: none !important;
          visibility: hidden;
        }

        .tab-control > ul.tab > li.tab-item {
          /* border: var(--border); */
          color: var(--gray-color);
          font-family: var(--font-text), sans-serif;
          font-weight: 400;
          padding: 6px 20px 8px 0;
          margin: 0;
          display: flex;
          align-items: center;
          cursor: pointer;
          overflow: visible;
          font-size: 0.95rem;
        }

        .tab-control > ul.tab > li.tab-item > .text {
          font-weight: 500;
          font-size: 1rem;
        }

        .tab-control > ul.tab > li.tab-item:hover > .text {
          color: transparent;
          background: var(--accent-linear);
          background-clip: text;
          -webkit-background-clip: text;
        }

        .tab-control > ul.tab > li.active {
          font-size: 0.95rem;
        }

        .tab-control > ul.tab > li.active > .text {
          color: transparent;
          background: var(--accent-linear);
          background-clip: text;
          -webkit-background-clip: text;
          font-family: var(--font-read);
        }

        .tab-control > ul.tab span.line {
          position: absolute;
          z-index: 1;
          background: var(--accent-linear);
          display: inline-block;
          bottom: -3px;
          left: 12px;
          width: 20px;
          min-height: 5px;
          border-top-left-radius: 5px;
          border-top-right-radius: 5px;
          border-bottom-left-radius: 5px;
          border-bottom-right-radius: 5px;
          transition: all 300ms ease-in-out;
        }

        @media screen and (max-width: 660px) {
          :host {
            padding: 0;
          }

          .tab-control {
            border-bottom: var(--border);
            margin: 0;
            position: sticky;
            top: 50px;
          }

          .tab-control > ul.tab > li.tab-item,
					.action,
					a {
						cursor: default !important;
          }

          ::-webkit-scrollbar {
            -webkit-appearance: none;
          }

          a,
          .stats > .stat {
            cursor: default !important;
          }

          a,
          span.stat,
          span.action {
            cursor: default !important;
          }
        }
      </style>
    `;
    }
  }

  class ProfileSection extends HTMLElement {
    constructor() {
      // We are not even going to touch this.
      super();

      // Get default active tab
      this._active = this.getAttribute('active');

      // let's create our shadow root
      this.shadowObj = this.attachShadow({ mode: "open" });

      this.render();
    }

    render() {
      this.shadowObj.innerHTML = this.getTemplate();
    }

    connectedCallback() {
      // Get the content container
      const contentContainer = this.shadowObj.querySelector('div.feeds');
      
      // Get the tabContainer
      const tabContainer = this.shadowObj.querySelector('ul#tab');

      // if content container and tab container exists
      if (contentContainer && tabContainer) {
        this.updateActiveTab(this._active);
        this.activateTab(contentContainer, tabContainer);
      }
    }

    disableScroll() {
      // Get the current page scroll position
      let scrollTop = window.scrollY || document.documentElement.scrollTop;
      let scrollLeft = window.scrollX || document.documentElement.scrollLeft;
      document.body.classList.add("stop-scrolling");

      // if any scroll is attempted, set this to the previous value
      window.onscroll = function () {
        window.scrollTo(scrollLeft, scrollTop);
      };
    }

    enableScroll() {
      document.body.classList.remove("stop-scrolling");
      window.onscroll = function () { };
    }

    updateActiveTab = active => {
      // Select tab with active class
      const tab = this.shadowObj.querySelector(`ul#tab > li.${active}`);

      // select line
      const line = this.shadowObj.querySelector('ul#tab span.line');

      if (tab && line) {
        tab.classList.add('active');

        // Calculate half tab width - 10px
        const tabWidth = (tab.offsetWidth/2) - 20;

        // update line
        line.style.left = `${tab.offsetLeft + tabWidth}px`;
      }
      else {
        // Select the stories tab
        const storiesTab = this.shadowObj.querySelector("ul#tab > li.stories");
        storiesTab.classList.add('active');
      }
    }

    activateTab = (contentContainer, tabContainer) => {
      const outerThis = this;

      if (tabContainer && contentContainer) {
        const line = tabContainer.querySelector('span.line');
        const tabItems = tabContainer.querySelectorAll('li.tab-item');
        let activeTab = tabContainer.querySelector('li.tab-item.active');

        tabItems.forEach(tab => {
          tab.addEventListener('click', e => {
            e.preventDefault();
            e.stopPropagation();

            // Calculate half tab width - 10px
            const tabWidth = (tab.offsetWidth/2) - 20;

            line.style.left = `${tab.offsetLeft + tabWidth}px`;

            if (tab.dataset.element === activeTab.dataset.element) {
              return;
            }
            else {
              activeTab.classList.remove('active');
              tab.classList.add('active');
              activeTab = tab;

              // get current feed
              const currentFeed = outerThis.getCurrentFeed(tab.dataset.element);

              // Updating History State
              window.history.pushState(
                { tab: tab.dataset.element, content: currentFeed},
                tab.dataset.element, `${tab.getAttribute('url')}`
              );

              // update active attribute
              outerThis.setAttribute('active', tab.dataset.element);

              const tabName = tab.dataset.element; 

              if (tabName === "stories") {
                contentContainer.innerHTML = outerThis.getStories();
              } else if (tabName === "replies") {
                contentContainer.innerHTML = outerThis.getReplies();
              } else if (tabName === "followers") {
                contentContainer.innerHTML = outerThis.getFollowers();
              } else if (tabName === "following") {
                contentContainer.innerHTML = outerThis.getFollowing();
              }
            }
          });
        });

        // Update state on window.onpopstate
        window.onpopstate = event => {
          // This event will be triggered when the browser's back button is clicked

          if (event.state) {
            if (event.state.popup) {
              return;
            }
            if (event.state.page) {
              outerThis.updatePage(event.state.content);
            }
            else if (event.state.tab) {
              // Select the state tab
              const tab = outerThis.shadowObj.querySelector(`ul#tab > li.${event.state.tab}`);

              if (tab) {
                activeTab.classList.remove('active');

                tab.classList.add('active');
                activeTab = tab;

                // Calculate half tab width - 10px
                const tabWidth = (tab.offsetWidth/2) - 20;

                // update line 
                line.style.left = `${tab.offsetLeft + tabWidth}px`;

                outerThis.updateState(event.state, contentContainer);

                //Update active attribute
                outerThis.setAttribute('active', event.state.tab);
              }
            }
          }
          else {
            // Select li with class name as current and content Container
            const currentTab = tabContainer.querySelector(`li.tab-item.${this._active}`);
            if (currentTab) {
              activeTab.classList.remove('active');
              activeTab = currentTab;
              currentTab.classList.add('active');
              
              // Calculate half tab width - 10px
              const tabWidth = (currentTab.offsetWidth/2) - 20;

              // Update line
              line.style.left = `${currentTab.offsetLeft + tabWidth}px`;

              outerThis.updateDefault(contentContainer);

              // Update active attribute
              outerThis.setAttribute('active', this._active);
            }
          }
        };
      }
    }

    updatePage = content => {
      // select body
      const body = document.querySelector('body');

      // populate content
      body.innerHTML = content;
    }

    updateState = (state, contentContainer)=> {
      // populate content
      contentContainer.innerHTML = state.content;
    }

    updateDefault = contentContainer => {
      contentContainer.innerHTML = this.getContainer(this._active);
    }

    // get current feed
    getCurrentFeed = tab => {
      switch (tab) {
        case "stories":
          return this.getStories();
        case "replies":
          return this.getReplies();
        case "followers":
          return this.getFollowers();
        case "following":
          return this.getFollowing();
        default:
          return this.getStories();
      }
    }

    getTemplate() {
      // Show HTML Here
      return /* html */`
      ${this.getBody()}
      ${this.getStyles()}
    `;
    }

    getBody = () => {
      return /* html */`
      <div class="content-container">
        ${this.getTab()}
        ${this.getContent()}
      </div>
    `
    }

    getContent = () => {
      return /* html */`
      <div class="feeds">
        ${this.getContainer(this._active)}
      </div>
		`
    }

    getTab = () => {
      // Get url 
      let url = this.getAttribute('url');

      // convert url to lowercase
      url = url.toLowerCase();
      return /* html */`
      <div class="tab-control">
        <ul id="tab" class="tab">
          <li url="${url}/stories" data-element="stories" class="tab-item stories">
            <span class="text">Stories</span>
          </li>
          <li url="${url}/replies" data-element="replies" class="tab-item replies">
            <span class="text">Replies</span>
          </li>
          <li url="${url}/followers" data-element="followers" class="tab-item followers">
            <span class="text">Followers</span>
          </li>
          <li url="${url}/following" data-element="following" class="tab-item following">
            <span class="text">Following</span>
          </li>
          <span class="line"></span>
        </ul>
      </div>
    `
    }

    getContainer = active => {
      // Switch active tab
      switch (active) {
        case "stories":
          return this.getStories();
        case "replies":
          return this.getReplies();
        case "followers":
          return this.getFollowers();
        case "following":
          return this.getFollowing();
        default:
          return this.getStories();
      }
    }

    getStories = () => {
      return /*html*/`
      <stories-feed hash="${this.getAttribute('hash')}" stories="${this.getAttribute('stories')}" page="1"
        url="${this.getAttribute('stories-url')}"  kind="user">
      </stories-feed>
    `
    }

    getReplies = () => {
      return /* html */`
      <replies-feed hash="${this.getAttribute('hash')}" replies="${this.getAttribute('replies')}" page="1"
        url="${this.getAttribute('replies-url')}" kind="user">
      </replies-feed>
    `
    }

    getFollowers = () => {
      return /*html*/`
      <people-feed hash="${this.getAttribute('hash')}" total="${this.getAttribute('followers')}" page="1"
        url="${this.getAttribute('followers-url')}" kind="followers">
      </people-feed>
    `
    }

    getFollowing = () => {
      return /*html*/`
      <people-feed hash="${this.getAttribute('hash')}" total="${this.getAttribute('following')}" page="1"
        url="${this.getAttribute('following-url')}" kind="following">
      </people-feed>
    `
    }

    getStyles() {
      return /* css */`
      <style>
        *,
        *:after,
        *:before {
          box-sizing: border-box !important;
          font-family: inherit;
          -webkit-box-sizing: border-box !important;
        }

        *:focus {
          outline: inherit !important;
        }

        *::-webkit-scrollbar {
          -webkit-appearance: none;
        }

        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
          padding: 0;
          margin: 0;
          font-family: inherit;
        }

        p,
        ul,
        ol {
          padding: 0;
          margin: 0;
        }

        a {
          text-decoration: none;
        }

        :host {
          font-size: 16px;
          padding: 0;
          width: 100%;
          min-width: 100%;
          display: flex;
          flex-flow: column;
          gap: 0px;
        }

        div.content-container {
          position: relative;
          width: 100%;
          display: flex;
          flex-flow: column;
          gap: 0;
        }

        div.content-container > .feeds {
          width: 100%;
          display: flex;
          flex-flow: column;
          align-items: start;
          gap: 0;
        }

        .tab-control {
          border-bottom: var(--border);
          background-color: var(--background);
          display: flex;
          flex-flow: column;
          gap: 0;
          z-index: 3;
          width: 100%;
          min-width: 100%;
          position: sticky;
          top: 60px;
        }

        .tab-control > .author {
          border-bottom: var(--border);
          padding: 10px 0;
          display: flex;
          align-items: center;
          gap: 5px;
          font-weight: 400;
          color: var(--gray-color);
          font-family: var(--font-mono), monospace;
          font-size: 0.9rem;
        }

        .tab-control > ul.tab {
          height: max-content;
          width: 100%;
          padding: 5px 0 0 0;
          margin: 0;
          list-style-type: none;
          display: flex;
          gap: 0;
          align-items: center;
          max-width: 100%;
          overflow-x: scroll;
          -ms-overflow-style: none;
          scrollbar-width: none;
        }

        .tab-control > ul.tab::-webkit-scrollbar {
          display: none !important;
          visibility: hidden;
        }

        .tab-control > ul.tab > li.tab-item {
          color: var(--gray-color);
          font-family: var(--font-text), sans-serif;
          font-weight: 400;
          padding: 6px 20px 8px 0;
          margin: 0;
          display: flex;
          align-items: center;
          cursor: pointer;
          overflow: visible;
          font-size: 0.95rem;
        }

        .tab-control > ul.tab > li.tab-item > .text {
          font-weight: 500;
          font-size: 1rem;
        }

        .tab-control > ul.tab > li.tab-item:hover > .text {
          color: transparent;
          background: var(--accent-linear);
          background-clip: text;
          -webkit-background-clip: text;
        }

        .tab-control > ul.tab > li.active {
          font-size: 0.95rem;
        }

        .tab-control > ul.tab > li.active > .text {
          color: transparent;
          background: var(--accent-linear);
          background-clip: text;
          -webkit-background-clip: text;
          font-family: var(--font-read);
        }

        .tab-control > ul.tab span.line {
          position: absolute;
          z-index: 1;
          background: var(--accent-linear);
          display: inline-block;
          bottom: -3px;
          left: 12px;
          width: 20px;
          min-height: 5px;
          border-top-left-radius: 5px;
          border-top-right-radius: 5px;
          border-bottom-left-radius: 5px;
          border-bottom-right-radius: 5px;
          transition: all 300ms ease-in-out;
        }

        @media screen and (max-width: 660px) {
          .tab-control {
            margin: 0;
            position: sticky;
            top: 50px;
          }

          .tab-control > ul.tab > li.tab-item,
					.action,
					a {
						cursor: default !important;
          }

          ::-webkit-scrollbar {
            -webkit-appearance: none;
          }

          a,
          .stats > .stat {
            cursor: default !important;
          }

          a,
          span.stat,
          span.action {
            cursor: default !important;
          }
        }
      </style>
    `;
    }
  }

  class TopicSection extends HTMLElement {
    constructor() {
      // We are not even going to touch this.
      super();

      // Get default active tab
      this._active = this.getAttribute('active');

      // let's create our shadow root
      this.shadowObj = this.attachShadow({ mode: "open" });

      this.render();
    }

    render() {
      this.shadowObj.innerHTML = this.getTemplate();
    }

    connectedCallback() {
      const contentContainer = this.shadowObj.querySelector('div.feeds');
      const tabContainer = this.shadowObj.querySelector('ul#tab');

      this.updateActiveTab(tabContainer);
      this.activateTab(contentContainer, tabContainer);

      // Open url
      this.openUrl();
    }

     disableScroll() {
      // Get the current page scroll position
      let scrollTop = window.scrollY || document.documentElement.scrollTop;
      let scrollLeft = window.scrollX || document.documentElement.scrollLeft;
      document.body.classList.add("stop-scrolling");

      // if any scroll is attempted, set this to the previous value
      window.onscroll = function () {
        window.scrollTo(scrollLeft, scrollTop);
      };
    }

    enableScroll() {
      document.body.classList.remove("stop-scrolling");
      window.onscroll = function () { };
    }

    updateActiveTab = tabContainer => {
      // Select tab with active class
      const tab = tabContainer.querySelector(`ul#tab > li.${this._active}`);

      // select line
      const line = tabContainer.querySelector('span.line');

      if (tab && line) {
        tab.classList.add('active');

        // Calculate half tab width - 10px
        const tabWidth = (tab.offsetWidth/2) - 20;

        // update line
        line.style.left = `${tab.offsetLeft + tabWidth}px`;
      }
      else {
        // Select the stories tab
        const storiesTab = tabContainer.querySelector("ul#tab > li.article");
        storiesTab.classList.add('active');
      }
    }

    activateTab = (contentContainer, tabContainer) => {
      const outerThis = this;
      if (tabContainer && contentContainer) {
        const line = tabContainer.querySelector('span.line');
        const tabItems = tabContainer.querySelectorAll('li.tab-item');
        let activeTab = tabContainer.querySelector('li.tab-item.active');

        tabItems.forEach(tab => {
          tab.addEventListener('click', e => {
            e.preventDefault();
            e.stopPropagation();

            // Calculate half tab width - 10px
            const tabWidth = (tab.offsetWidth/2) - 20;

            line.style.left = `${tab.offsetLeft + tabWidth}px`;

            if (tab.dataset.element === activeTab.dataset.element) {
              return;
            }
            else {
              activeTab.classList.remove('active');
              tab.classList.add('active');
              activeTab = tab;

              // get current feed
              const currentFeed = outerThis.getCurrentFeed(tab.dataset.element);

              // Updating History State
              window.history.pushState(
                { tab: tab.dataset.element, content: currentFeed},
                tab.dataset.element, `${tab.getAttribute('url')}`
              );

              // update active attribute
              outerThis.setAttribute('active', tab.dataset.element);

              switch (tab.dataset.element) {
                case "article":
                  contentContainer.innerHTML = outerThis.getArticle();
                  break;
                case "stories":
                  contentContainer.innerHTML = outerThis.getStories();
                  break;
              }

            }
          });
        });

        // Update state on window.onpopstate
        window.onpopstate = event => {
          // This event will be triggered when the browser's back button is clicked

          if (event.state) {
            if (event.state.popup) {
              return;
            }
            
            if (event.state.page) {
              outerThis.updatePage(event.state.content);
            }
            else if (event.state.tab) {

              // Select the state tab
              const tab = outerThis.shadowObj.querySelector(`ul#tab > li.${event.state.tab}`);

              if (tab) {
                activeTab.classList.remove('active');

                tab.classList.add('active');
                activeTab = tab;

                // Calculate half tab width - 10px
                const tabWidth = (tab.offsetWidth/2) - 20;

                // update line 
                line.style.left = `${tab.offsetLeft + tabWidth}px`;

                outerThis.updateState(event.state, contentContainer);

                //Update active attribute
                outerThis.setAttribute('active', event.state.tab);
              }
            }
          }
          else {
             // Select li with class name as current and content Container
             const currentTab = outerThis.shadowObj.querySelector(`ul#tab > li.tab-item.${this._active}`);
            if (currentTab) {
              activeTab.classList.remove('active');
              activeTab = currentTab;
              currentTab.classList.add('active');
              
              // Calculate half tab width - 10px
              const tabWidth = (currentTab.offsetWidth/2) - 20;

              // Update line
              line.style.left = `${currentTab.offsetLeft + tabWidth}px`;

              outerThis.updateDefault(contentContainer);

              // Update active attribute
              outerThis.setAttribute('active', this._active);
            }
          }
        };
      }
    }

    updatePage = content => {
      // select body
      const body = document.querySelector('body');

      // populate content
      body.innerHTML = content;
    }

    updateState = (state, contentContainer)=> {
      // populate content
      contentContainer.innerHTML = state.content;
    }

    updateDefault = contentContainer => {
      contentContainer.innerHTML = this.getContent(this._active);
    }

    // get current feed
    getCurrentFeed = tab => {
      switch (tab) {
        case "article":
          return this.getArticle();
        case "stories":
          return this.getStories();
        default:
          return this.getArticle();
      }
    }

    openUrl = () => {
      // get all the links
      const links = this.shadowObj.querySelectorAll('article.article > .section a');
      const body = document.querySelector('body');

      // loop through the links
      if (!links) return;
      
      links.forEach(link => {
        // add event listener to the link
        link.addEventListener('click', event => {
          event.preventDefault();
          // get the url
          const url = link.getAttribute('href');

          // link pop up
          let linkPopUp = `<url-popup url="${url}"></url-popup>`;

          // open the popup
          body.insertAdjacentHTML('beforeend', linkPopUp);
        });
      });
    }

    getTemplate() {
      // Show HTML Here
      return /* html */`
      ${this.getBody()}
      ${this.getStyles()}
    `;
    }

    getBody = () => {
      return /* html */`
      ${this.getTab()}
      <div class="feeds">
        ${this.getContent(this._active)}
      </div>
    `
    }

    getTab = () => {
      // Get url 
      let url = this.getAttribute('url');

      // convert url to lowercase
      url = url.toLowerCase();
      return /* html */`
      <div class="tab-control">
        <ul id="tab" class="tab">
          <li url="${url}/article" data-element="article" class="tab-item article">
            <span class="text">Article</span>
          </li>
          <li url="${url}/stories" data-element="stories" class="tab-item stories">
            <span class="text">Stories</span>
          </li>
          <span class="line"></span>
        </ul>
      </div>
    `
    }

    getContent = active => {
      switch (active) {
        case "article":
          return this.getArticle();
        case "stories":
          return this.getStories();
        default:
          return this.getArticle();
      }
    }

    getArticle = () => {
      return this.innerHTML;
    }

    getStories = () => {
      return /*html*/`
      <stories-feed hash="${this.getAttribute('slug')}" stories="${this.getAttribute('stories')}" page="1"
        url="${this.getAttribute('stories-url')}"  kind="topic">
      </stories-feed>
    `
    }

    getLoader = () => {
      return /* html */`
			<story-loader speed="300"></story-loader>
		`
    }

    getStyles() {
      return /* css */`
      <style>
        *,
        *:after,
        *:before {
          box-sizing: border-box !important;
          font-family: inherit;
          -webkit-box-sizing: border-box !important;
        }

        *:focus {
          outline: inherit !important;
        }

        *::-webkit-scrollbar {
          -webkit-appearance: none;
        }

        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
          padding: 0;
          margin: 0;
          font-family: inherit;
        }

        p,
        ul,
        ol {
          padding: 0;
          margin: 0;
        }

        a {
          text-decoration: none;
        }

        :host {
          font-size: 16px;
          padding: 0;
          width: 100%;
          min-width: 100%;
          display: flex;
          flex-flow: column;
          gap: 0;
        }

        .feeds {
          width: 100%;
          display: flex;
          flex-flow: column;
          align-items: start;
          gap: 0;
        }

        .tab-control {
          border-bottom: var(--border);
          background-color: var(--background);
          display: flex;
          flex-flow: column;
          gap: 0;
          z-index: 3;
          width: 100%;
          min-width: 100%;
          position: sticky;
          top: 60px;
        }

        .tab-control > .author {
          border-bottom: var(--border);
          padding: 10px 0;
          display: flex;
          align-items: center;
          gap: 5px;
          font-weight: 400;
          color: var(--gray-color);
          font-family: var(--font-mono), monospace;
          font-size: 0.9rem;
        }

        .tab-control > ul.tab {
          height: max-content;
          width: 100%;
          padding: 5px 0 0 0;
          margin: 0;
          list-style-type: none;
          display: flex;
          gap: 0;
          align-items: center;
          max-width: 100%;
          overflow-x: scroll;
          -ms-overflow-style: none;
          scrollbar-width: none;
        }

        .tab-control > ul.tab::-webkit-scrollbar {
          display: none !important;
          visibility: hidden;
        }

        .tab-control > ul.tab > li.tab-item {
          /* border: var(--border); */
          color: var(--gray-color);
          font-family: var(--font-text), sans-serif;
          font-weight: 400;
          padding: 6px 20px 8px 0;
          margin: 0;
          display: flex;
          align-items: center;
          cursor: pointer;
          overflow: visible;
          font-size: 0.95rem;
        }

        .tab-control > ul.tab > li.tab-item > .text {
          font-weight: 500;
          font-size: 1rem;
        }

        .tab-control > ul.tab > li.tab-item:hover > .text {
          color: transparent;
          background: var(--accent-linear);
          background-clip: text;
          -webkit-background-clip: text;
        }

        .tab-control > ul.tab > li.active {
          font-size: 0.95rem;
        }

        .tab-control > ul.tab > li.active > .text {
          color: transparent;
          background: var(--accent-linear);
          background-clip: text;
          -webkit-background-clip: text;
          font-family: var(--font-read);
        }

        .tab-control > ul.tab span.line {
          position: absolute;
          z-index: 1;
          background: var(--accent-linear);
          display: inline-block;
          bottom: -3px;
          left: 12px;
          width: 20px;
          min-height: 5px;
          border-top-left-radius: 5px;
          border-top-right-radius: 5px;
          border-bottom-left-radius: 5px;
          border-bottom-right-radius: 5px;
          transition: all 300ms ease-in-out;
        }

        article.article {
          margin: 15px 0;
          display: flex;
          flex-flow: column;
          color: var(--read-color);
          font-family: var(--font-text), sans-serif;
          gap: 10px;
          font-size: 1rem;
          font-weight: 400;
        }

        article.article * {
          font-size: 1.05rem;
          line-height: 1.3;
          color: inherit;
          font-family: inherit;
        }

        article.article > .section {
          margin: 0 0 10px 0;
          padding: 0;
          display: flex;
          flex-flow: column;
        }

        article.article > .section > h2.title {
          font-size: 1.35rem !important;
          color: var(--title-color);
          font-weight: 600;
          line-height: 1.2;
          margin: 0;
          padding: 2px 0 0 13px;
          position: relative;
        }

        article.article > .section h2.title:before {
          content: "";
          position: absolute;
          bottom: 10%;
          left: 0;
          width: 3px;
          height: 80%;
          background: var(--accent-linear);
          border-radius: 5px;
        }

        article.article h6,
        article.article h5,
        article.article h4,
        article.article h3,
        article.article h1 {
          padding: 0 !important;
          font-size: 1.25rem !important;
          color: var(--title-color);
          font-weight: 500;
          line-height: 1.5;
          margin: 10px 0;
        }

        article.article .intro p {
          margin: 0 0 5px 0;
          line-height: 1.4;
        }

        article.article p {
          margin: 5px 0;
          line-height: 1.4;
        }

        article.article a {
          text-decoration: none;
          cursor: pointer;
          color: var(--anchor-color) !important;
        }

        article.article a:hover {
          text-decoration: underline;
        }

        article.article blockquote {
          margin: 10px 0;
          padding: 5px 15px;
          font-style: italic;
          border-left: 2px solid var(--gray-color);
          background: var(--background);
          color: var(--text-color);
          font-weight: 400;
        }

        article.article blockquote:before {
          content: open-quote;
          color: var(--gray-color);
          font-size: 1.5rem;
          line-height: 1;
          margin: 0;
        }

        article.article blockquote:after {
          content: close-quote;
          color: var(--gray-color);
          font-size: 1.5rem;
          line-height: 1;
          margin: 0;
        }

        article.article hr {
          border: none;
          background-color: var(--gray-color);
          height: 1px;
          margin: 10px 0;
        }

        article.article b,
        article.article strong {
          font-weight: 500;

        }

        article.article ul,
        article.article ol {
          margin: 5px 0 15px 20px;
          padding: 0 0 0 15px;
          color: inherit;
        }

        article.article div.last,
        article.article div.empty {
          display: flex;
          flex-flow: column;
          align-items: center;
          justify-content: center;
          gap: 10px;
          margin: 15px 0;
          padding: 15px 10px;
          background: var(--gray-background);
          border-radius: 15px;
        }

        article.article > div.empty > h2 {
          font-size: 1.3rem;
          font-weight: 700;
          margin: 0;
          color: var(--title-color);
        }

        article.article div.last > p,
        article.article > div.empty > p {
          font-size: 1rem;
          margin: 0;
          text-align: center;
          font-family: var(--font-text), sans-serif;
          color: var(--text-color);
        }

        article.article div.last > a,
        article.article > div.empty > a {
          padding: 5px 20px;
          margin: 5px 0 0 0;
          font-size: 1rem;
          font-weight: 500;
          border-radius: 12px;
          cursor: pointer;
          color: var(--white-color) !important;
          background: var(--accent-linear) !important;
          background-clip: text;
          -webkit-background-clip: text;
        }

        article.article > div.empty > a:hover {
          text-decoration: none;
        }

        @media screen and (max-width: 660px) {
          .tab-control {
            border-bottom: var(--border-mobile);
            margin: 0;
            position: sticky;
            top: 50px;
          }

          .tab-control > ul.tab > li.tab-item,
					.action,
					a {
						cursor: default !important;
          }

          ::-webkit-scrollbar {
            -webkit-appearance: none;
          }

          a,
          .stats > .stat {
            cursor: default !important;
          }

          a,
          span.stat,
          span.action {
            cursor: default !important;
          }
        }
      </style>
    `;
    }
  }

  class ActivityItem extends HTMLElement {
    constructor() {
      // We are not even going to touch this.
      super();

      // let's create our shadow root
      this.shadowObj = this.attachShadow({ mode: "open" });

      this.render();
    }

    render() {
      this.shadowObj.innerHTML = this.getTemplate();
    }

    connectedCallback() {
      // open preview
      this.openPreview();
    }

    openPreview = () => {
      // get replying-to
      const viewBtn = this.shadowObj.querySelector('.actions > .action#view-action');
      const body = document.querySelector('body');
      const hash = this.getAttribute('hash');
      this.getAttribute('author');
      const url = this.getPreviewUrl(this.getAttribute('kind'), hash.toLowerCase());

      if (viewBtn) {
        viewBtn.addEventListener('click', event => {
          event.preventDefault();
          event.stopPropagation();
          event.stopImmediatePropagation();

          //get the preview
          let preview = this.getPreview(url);

          // open the preview
          body.insertAdjacentHTML('beforeend', preview);
        });
      }
    }

    getPreviewUrl = (kind, hash) => {
      if (kind === 'story') {
        return `/api/v1/p/${hash}/preview`;
      }

      if (kind === 'reply') {
        return `/api/v1/r/${hash}/preview`;
      }

      if (kind === 'user') {
        return `/api/v1/u/${hash}/preview`;
      }

      if (kind === 'topic') {
        return `/api/v1/t/${hash}/preview`;
      }
    }

    disableScroll() {
      // Get the current page scroll position
      let scrollTop = window.scrollY || document.documentElement.scrollTop;
      let scrollLeft = window.scrollX || document.documentElement.scrollLeft;
      document.body.classList.add("stop-scrolling");

      // if any scroll is attempted, set this to the previous value
      window.onscroll = function () {
        window.scrollTo(scrollLeft, scrollTop);
      };
    }

    enableScroll() {
      document.body.classList.remove("stop-scrolling");
      window.onscroll = function () { };
    }

    // Get lapse time
    getLapseTime = isoDateStr => {
      const dateIso = new Date(isoDateStr); // ISO strings with timezone are automatically handled
      let userTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;

      // Convert posted time to the current timezone
      const date = new Date(dateIso.toLocaleString('en-US', { timeZone: userTimezone }));

      // Get the current time
      const currentTime = new Date();

      // Get the difference in time
      const timeDifference = currentTime - date;

      // Get the seconds
      const seconds = timeDifference / 1000;

      // Check if seconds is less than 60: return Just now
      if (seconds < 60) {
        return 'Just now';
      }

      // check for minutes
      if (seconds < 3600) {
        const min = Math.floor(seconds / 60);
        return `${min === 1 ? '1 min' : min + ' mins'}`;
      }

      // check for hours
      if (seconds < 86400) {
        const hours = Math.floor(seconds / 3600);
        return `${hours === 1 ? '1 hr' : hours + ' hrs'}`;
      }

      // check if seconds is less than 604800: return day and time
      if (seconds <= 604800) {
        return date.toLocaleDateString('en-US', { weekday: 'short', hour: 'numeric', minute: 'numeric', hour12: true });
      }

      // Check if the date is in the current year:: return date and month short 2-digit year without time
      if (date.getFullYear() === currentTime.getFullYear()) {
        return date.toLocaleDateString('en-US', { day: 'numeric', month: 'short', });
      }
      else {
        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
      }
    }

    getTemplate() {
      // Show HTML Here
      return `
      ${this.getBody()}
      ${this.getStyles()}
    `;
    }

    getBody = () => {
      return /* html */`
      ${this.getHeader(this.getAttribute('kind'))}
      ${this.getContent(this.innerHTML)}
      ${this.getActions()}
    `;
    }

    getContent = content => {
      const kind = this.getAttribute('kind');
      if (kind === 'user' && this.getAttribute('action') === 'follow') {
        return /*html*/`
        <div class="foot">
          User profile for - <span class="by">#${this.getAttribute('to')}</span>
        </div>
      `
      }
      return `
      <div class="content">
        ${content}
      </div>
    `
    }

    getActions = () => {
      const viewUrl = this.getUrl(this.getAttribute('kind'), this.getAttribute('hash'));
      return /*html*/`
      <div class="actions">
        <a href="${viewUrl}" class="action view" id="view-action">view</a>
        <span class="action time plain">${this.getLapseTime(this.getAttribute('time'))}</span>
      </div>
    `
    }

    getUrl = (kind, hash) => {
      hash = hash.toLowerCase();
      if (kind === 'story') {
        return `/p/${hash}`;
      }

      if (kind === 'reply') {
        return `/r/${hash}`;
      }

      if (kind === 'user') {
        return `/u/${hash}`;
      }

      if (kind === 'topic') {
        return `/t/${hash}`;
      }
    }

    getHeader = (kind) => {
      const itemType = this.getAttribute('action');
      if (itemType === 'like') {
        return /* html */`
        <div class="head">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" class="liked" fill="currentColor">
            <path d="m8 14.25.345.666a.75.75 0 0 1-.69 0l-.008-.004-.018-.01a7.152 7.152 0 0 1-.31-.17 22.055 22.055 0 0 1-3.434-2.414C2.045 10.731 0 8.35 0 5.5 0 2.836 2.086 1 4.25 1 5.797 1 7.153 1.802 8 3.02 8.847 1.802 10.203 1 11.75 1 13.914 1 16 2.836 16 5.5c0 2.85-2.045 5.231-3.885 6.818a22.066 22.066 0 0 1-3.744 2.584l-.018.01-.006.003h-.002ZM4.25 2.5c-1.336 0-2.75 1.164-2.75 3 0 2.15 1.58 4.144 3.365 5.682A20.58 20.58 0 0 0 8 13.393a20.58 20.58 0 0 0 3.135-2.211C12.92 9.644 14.5 7.65 14.5 5.5c0-1.836-1.414-3-2.75-3-1.373 0-2.609.986-3.029 2.456a.749.749 0 0 1-1.442 0C6.859 3.486 5.623 2.5 4.25 2.5Z"></path>
          </svg>
          <span class="text">You ${this.getAttribute('verb')} this ${kind}</span>
        </div>
      `
      }

      if (itemType === 'follow') {
        return /* html */`
        <div class="head">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" class="at" fill="currentColor">
            <path d="M10.561 8.073a6.005 6.005 0 0 1 3.432 5.142.75.75 0 1 1-1.498.07 4.5 4.5 0 0 0-8.99 0 .75.75 0 0 1-1.498-.07 6.004 6.004 0 0 1 3.431-5.142 3.999 3.999 0 1 1 5.123 0ZM10.5 5a2.5 2.5 0 1 0-5 0 2.5 2.5 0 0 0 5 0Z"></path>
          </svg>
          <span class="text">You followed this ${kind}</span>
        </div>
      `
      }

      if (itemType === 'subscribe') {
        return /* html */`
        <div class="head">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" class="at" fill="currentColor">
            <path d="M1.75 2h12.5c.966 0 1.75.784 1.75 1.75v8.5A1.75 1.75 0 0 1 14.25 14H1.75A1.75 1.75 0 0 1 0 12.25v-8.5C0 2.784.784 2 1.75 2ZM1.5 12.251c0 .138.112.25.25.25h12.5a.25.25 0 0 0 .25-.25V5.809L8.38 9.397a.75.75 0 0 1-.76 0L1.5 5.809v6.442Zm13-8.181v-.32a.25.25 0 0 0-.25-.25H1.75a.25.25 0 0 0-.25.25v.32L8 7.88Z"></path>
          </svg>
          <span class="text">You subscribed to this ${kind}</span>
        </div>
      `
      }

      if (itemType === 'reply') {
        return /* html */`
        <div class="head">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" class="reply" fill="currentColor">
            <path d="M1.75 1h8.5c.966 0 1.75.784 1.75 1.75v5.5A1.75 1.75 0 0 1 10.25 10H7.061l-2.574 2.573A1.458 1.458 0 0 1 2 11.543V10h-.25A1.75 1.75 0 0 1 0 8.25v-5.5C0 1.784.784 1 1.75 1ZM1.5 2.75v5.5c0 .138.112.25.25.25h1a.75.75 0 0 1 .75.75v2.19l2.72-2.72a.749.749 0 0 1 .53-.22h3.5a.25.25 0 0 0 .25-.25v-5.5a.25.25 0 0 0-.25-.25h-8.5a.25.25 0 0 0-.25.25Zm13 2a.25.25 0 0 0-.25-.25h-.5a.75.75 0 0 1 0-1.5h.5c.966 0 1.75.784 1.75 1.75v5.5A1.75 1.75 0 0 1 14.25 12H14v1.543a1.458 1.458 0 0 1-2.487 1.03L9.22 12.28a.749.749 0 0 1 .326-1.275.749.749 0 0 1 .734.215l2.22 2.22v-2.19a.75.75 0 0 1 .75-.75h1a.25.25 0 0 0 .25-.25Z"></path>
          </svg>
          <span class="text">You ${this.getAttribute('verb')} to this ${kind}</span>
        </div>
      `
      }

      if (itemType === 'vote') {
        return /* html */`
        <div class="head">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" class="reply" fill="currentColor">
            <path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm1.5 0a6.5 6.5 0 1 0 13 0 6.5 6.5 0 0 0-13 0Zm10.28-1.72-4.5 4.5a.75.75 0 0 1-1.06 0l-2-2a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018l1.47 1.47 3.97-3.97a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042Z"></path>
          </svg>
          <span class="text">You ${this.getAttribute('verb')} to this ${kind}</span>
        </div>
      `
      }
      
      return /* html */`
      <div class="head">
        <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16" width="16" height="16">
          <path d="M11.93 8.5a4.002 4.002 0 0 1-7.86 0H.75a.75.75 0 0 1 0-1.5h3.32a4.002 4.002 0 0 1 7.86 0h3.32a.75.75 0 0 1 0 1.5Zm-1.43-.75a2.5 2.5 0 1 0-5 0 2.5 2.5 0 0 0 5 0Z"></path>
        </svg>
        <span class="text">You ${this.getAttribute('verb')} this ${kind}</span>
      </div>
    `
    }

    getPreview = url => {
      return /*html*/`
      <preview-popup url="${url}"></preview-popup> 
    `
    }

    getStyles() {
      return /* css */`
    <style>
      *,
      *:after,
      *:before {
        box-sizing: border-box !important;
        font-family: inherit;
        -webkit-box-sizing: border-box !important;
      }

      *:focus {
        outline: inherit !important;
      }

      *::-webkit-scrollbar {
        -webkit-appearance: none;
      }

      h1,
      h2,
      h3,
      h4,
      h5,
      h6 {
        padding: 0;
        margin: 0;
        font-family: inherit;
      }

      p,
      ul,
      ol {
        padding: 0;
        margin: 0;
      }

      a {
        text-decoration: none;
      }

      :host {
        font-size: 16px;
        border-bottom: var(--border);
        display: flex;
        flex-flow: column;
        gap: 5px;
        padding: 15px 0;
        width: 100%;
      }

      .head {
        color: var(--text-color);
        display: flex;
        align-items: center;
        gap: 5px;
        padding: 0;
        width: 100%;
      }

      .head svg {
        width: 15px;
        height: 15px;
        color: var(--gray-color);
        margin: 0 0 -1px 0;
      }

      .head svg.at {
        width: 14px;
        height: 14px;
        color: var(--gray-color);
        margin: 0 0 0 0;
      }

      .head svg.saved {
        width: 13px;
        height: 13px;
        color: var(--gray-color);
        margin: -2px 0 0 0;
      }

      .head svg.reply,
      .head svg.liked {
        width: 13px;
        height: 13px;
        color: var(--gray-color);
        margin: 0 0 0;
      }

      .head > span.text {
        color: var(--gray-color);
        font-size: 0.9rem;
        font-family: var(--font-read), sans-serif;
        font-style: italic;
      }

      .content {
        color: var(--highlight-color);
        font-family: var(--font-text), sans-serif;
        display: flex;
        flex-flow: column;
        font-size: 1rem;
        gap: 5px;
        padding: 0;
        width: 100%;
      }

      .content h4 {
        color: var(--title-color);
        font-weight: 500;
        font-size: 1.1rem;
        font-family: var(--font-text), sans-serif;
      }

      .foot {
        display: flex;
        flex-flow: row;
        color: var(--text-color);
        align-items: center;
        gap: 5px;
        width: 100%;
        padding: 0;
        font-size: 1rem;
        font-family: var(--font-text), sans-serif;
      }

      .foot span.by {
        font-size: 0.85rem;
        font-family: var(--font-mono), monospace;
        display: flex;
        align-items: center;
        color: var(--gray-color);
        font-weight: 500;
        gap: 3px;
      }
      
      .actions {
        display: flex;
        font-family: var(--font-main), sans-serif;
        width: 100%;
        flex-flow: row;
        align-items: center;
        gap: 15px;
        margin: 5px 0 0 0;
      }
      
      .actions > .action {
        border: var(--border-button);
        text-decoration: none;
        color: var(--gray-color);
        font-size: 0.9rem;
        display: flex;
        width: max-content;
        flex-flow: row;
        align-items: center;
        justify-content: center;
        padding: 1.5px 10px 2.5px;
        border-radius: 10px;
      }

      .actions > .action.edit {
        border: none;
        background: var(--gray-background);
        color: var(--text-color);
        padding: 2.5px 10px 3.5px;
        font-size: 0.9rem;
      }

      .actions > .action.plain {
        padding: 0;
        pointer-events: none;
        font-family: var(--font-main), sans-serif;
        color: var(--gray-color);
        font-size: 0.9rem;
        border: none;
        background: none;
      }

      .actions > .action.plain > span.text {
        display: inline-block;
        padding: 0 0 0 3px;
      }

      @media screen and (max-width:660px) {
        ::-webkit-scrollbar {
          -webkit-appearance: none;
        }

        a,
        .actions > .action {
          cursor: default !important;
        }
      }
    </style>
    `;
    }
  }

  class AllStat extends HTMLElement {
    constructor() {
      // We are not even going to touch this.
      super();

      this._up  = `
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" fill="currentColor">
        <path d="M4.53 4.75A.75.75 0 0 1 5.28 4h6.01a.75.75 0 0 1 .75.75v6.01a.75.75 0 0 1-1.5 0v-4.2l-5.26 5.261a.749.749 0 0 1-1.275-.326.749.749 0 0 1 .215-.734L9.48 5.5h-4.2a.75.75 0 0 1-.75-.75Z"></path>
      </svg>
    `;

      this._down = `
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" fill="currentColor">
        <path d="M4.22 4.179a.75.75 0 0 1 1.06 0l5.26 5.26v-4.2a.75.75 0 0 1 1.5 0v6.01a.75.75 0 0 1-.75.75H5.28a.75.75 0 0 1 0-1.5h4.2L4.22 5.24a.75.75 0 0 1 0-1.06Z"></path>
      </svg>
    `;

      // let's create our shadow root
      this.shadowObj = this.attachShadow({ mode: "open" });

      this.render();
    }

    render() {
      this.shadowObj.innerHTML = this.getTemplate();
    }

    connectedCallback() {
      
    }

    formatNumber = n => {
      if (n >= 0 && n <= 999) {
        return n.toString();
      } else if (n >= 1000 && n <= 9999) {
        const value = (n / 1000).toFixed(2);
        return `${value}k`;
      } else if (n >= 10000 && n <= 99999) {
        const value = (n / 1000).toFixed(1);
        return `${value}k`;
      } else if (n >= 100000 && n <= 999999) {
        const value = (n / 1000).toFixed(0);
        return `${value}k`;
      } else if (n >= 1000000 && n <= 9999999) {
        const value = (n / 1000000).toFixed(2);
        return `${value}M`;
      } else if (n >= 10000000 && n <= 99999999) {
        const value = (n / 1000000).toFixed(1);
        return `${value}M`;
      } else if (n >= 100000000 && n <= 999999999) {
        const value = (n / 1000000).toFixed(0);
        return `${value}M`;
      } else if (n >= 1000000000) {
        return "1B+";
      }
      else {
        return 0;
      }
    }

    calculatePercentageChange = (last, current) => {
      // Calculate the difference between the new and old values
      const difference = current - last;

      let percentageChange  = 0;

      // check if last is zero
      if (last === 0 && current > 0) {
        percentageChange = 100;
      }
      else if(last === 0 && current === 0) {
        percentageChange = 0;
      }
      else {
        // Calculate the percentage change
        percentageChange = (difference / Math.abs(last)) * 100;
      }

      // Round the result to two decimal places
      let roundedPercentageChange = Math.round(percentageChange * 100) / 100;

      // Format the result as a signed float with two decimal places
      const formattedPercentageChange = roundedPercentageChange.toFixed(2);

      // Convert the formatted string back to a number
      const percentageChangeNumber = parseFloat(formattedPercentageChange);

      return percentageChangeNumber;
    }

    parseToNumber = num_str => {
      // Try parsing the string to an integer
      const num = parseInt(num_str);

      // Check if parsing was successful
      if (!isNaN(num)) {
        return num;
      } else {
        return 0;
      }
    }

     disableScroll() {
      // Get the current page scroll position
      let scrollTop = window.scrollY || document.documentElement.scrollTop;
      let scrollLeft = window.scrollX || document.documentElement.scrollLeft;
      document.body.classList.add("stop-scrolling");

      // if any scroll is attempted, set this to the previous value
      window.onscroll = function () {
        window.scrollTo(scrollLeft, scrollTop);
      };
    }

    enableScroll() {
      document.body.classList.remove("stop-scrolling");
      window.onscroll = function () { };
    }

    getTemplate() {
      // Show HTML Here
      return `
      ${this.getBody()}
      ${this.getStyles()}
    `;
    }

    getBody = () => {
      return /* html */`
      ${this.getHeader()}
      <div class="content">
        ${this.getAll()}
        ${this.getStories()}
        ${this.getOpinion()}
      </div>
    `;
    }

    getHeader = () => {
      return /* html */`
      <div class="title">
        <h4 class="text">All contents</h4>
        <span class="desc"> Summary of all engagements</span>
      </div>
    `
    }

    getAll = () => {
      let icon = '';
      const lastAll = this.parseToNumber(this.getAttribute('all-last'));
      const currentAll = this.parseToNumber(this.getAttribute('all'));

      const percentageChange = this.calculatePercentageChange(lastAll, currentAll);

      // if percentageChange is negative, we need to make it positive
      const percentage = Math.abs(percentageChange);

      if (percentageChange > 0) {
        icon = `
        <span class="change up">
          ${this._up}
          <span class="percentage">${percentage}%</span>
        </span>
      `;

      }
      else {
        icon = `
        <span class="change down">
          ${this._down}
          <span class="percentage">${percentage}%</span>
        </span>
      `;
      }

      return /* html */`
      <div class="main">
        <div class="views">
          <div class="text">
            <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16" width="16" height="16">
              <path d="M8.75 1.5a.75.75 0 0 1 .75.75v10.5a.75.75 0 0 1-1.5 0V2.25a.75.75 0 0 1 .75-.75Zm-3.5 3a.75.75 0 0 1 .75.75v7.5a.75.75 0 0 1-1.5 0v-7.5a.75.75 0 0 1 .75-.75Zm7 0a.75.75 0 0 1 .75.75v7.5a.75.75 0 0 1-1.5 0v-7.5a.75.75 0 0 1 .75-.75Z"></path>
            </svg>
            <h2 class="no">
              ${this.formatNumber(currentAll)}
            </h2>
          </div>
          <span class="desc">Total stats</span>
        </div>
        <div class="compared">
          ${icon}
          <span class="info">Compared to prior month</span>
        </div>
      </div>
    `
    }

    getStories = () => {
      let icon = '';
      const lastStory = this.parseToNumber(this.getAttribute('stories-last'));
      const currentStory = this.parseToNumber(this.getAttribute('stories'));

      const percentageChange = this.calculatePercentageChange(lastStory, currentStory);

      // if percentageChange is negative, we need to make it positive
      const percentage = Math.abs(percentageChange);

      if (percentageChange > 0) {
        icon = `
        <span class="change up">
          ${this._up}
          <span class="percentage">${percentage}%</span>
        </span>
      `;

      }
      else {
        icon = `
        <span class="change down">
          ${this._down}
          <span class="percentage">${percentage}%</span>
        </span>
      `;
      }

      return /* html */`
      <div class="main">
        <div class="views">
          <div class="text">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" fill="currentColor">
              <path d="M7.75 14A1.75 1.75 0 0 1 6 12.25v-8.5C6 2.784 6.784 2 7.75 2h6.5c.966 0 1.75.784 1.75 1.75v8.5A1.75 1.75 0 0 1 14.25 14Zm-.25-1.75c0 .138.112.25.25.25h6.5a.25.25 0 0 0 .25-.25v-8.5a.25.25 0 0 0-.25-.25h-6.5a.25.25 0 0 0-.25.25ZM4.9 3.508a.75.75 0 0 1-.274 1.025.249.249 0 0 0-.126.217v6.5c0 .09.048.173.126.217a.75.75 0 0 1-.752 1.298A1.75 1.75 0 0 1 3 11.25v-6.5c0-.649.353-1.214.874-1.516a.75.75 0 0 1 1.025.274ZM1.625 5.533h.001a.249.249 0 0 0-.126.217v4.5c0 .09.048.173.126.217a.75.75 0 0 1-.752 1.298A1.748 1.748 0 0 1 0 10.25v-4.5a1.748 1.748 0 0 1 .873-1.516.75.75 0 1 1 .752 1.299Z"></path>
            </svg>
            <h2 class="no">
              ${this.formatNumber(currentStory)}
            </h2>
          </div>
          <span class="desc">All stories</span>
        </div>
        <div class="compared">
          ${icon}
          <span class="info">Compared to prior month</span>
        </div>
      </div>
    `
    }

    getOpinion = () => {
      let icon = '';
      const lastOpinion = this.parseToNumber(this.getAttribute('replies-last'));
      const currentOpinion = this.parseToNumber(this.getAttribute('replies'));

      const percentageChange = this.calculatePercentageChange(lastOpinion, currentOpinion);

      // if percentageChange is negative, we need to make it positive
      const percentage = Math.abs(percentageChange);

      if (percentageChange > 0) {
        icon = `
        <span class="change up">
          ${this._up}
          <span class="percentage">${percentage}%</span>
        </span>
      `;

      }
      else {
        icon = `
        <span class="change down">
          ${this._down}
          <span class="percentage">${percentage}%</span>
        </span>
      `;
      }

      return /* html */`
      <div class="main">
        <div class="views">
          <div class="text">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512" width="16px" height="16px" fill="currentColor">
              <path d="M88.2 309.1c9.8-18.3 6.8-40.8-7.5-55.8C59.4 230.9 48 204 48 176c0-63.5 63.8-128 160-128s160 64.5 160 128s-63.8 128-160 128c-13.1 0-25.8-1.3-37.8-3.6c-10.4-2-21.2-.6-30.7 4.2c-4.1 2.1-8.3 4.1-12.6 6c-16 7.2-32.9 13.5-49.9 18c2.8-4.6 5.4-9.1 7.9-13.6c1.1-1.9 2.2-3.9 3.2-5.9zM0 176c0 41.8 17.2 80.1 45.9 110.3c-.9 1.7-1.9 3.5-2.8 5.1c-10.3 18.4-22.3 36.5-36.6 52.1c-6.6 7-8.3 17.2-4.6 25.9C5.8 378.3 14.4 384 24 384c43 0 86.5-13.3 122.7-29.7c4.8-2.2 9.6-4.5 14.2-6.8c15.1 3 30.9 4.5 47.1 4.5c114.9 0 208-78.8 208-176S322.9 0 208 0S0 78.8 0 176zM432 480c16.2 0 31.9-1.6 47.1-4.5c4.6 2.3 9.4 4.6 14.2 6.8C529.5 498.7 573 512 616 512c9.6 0 18.2-5.7 22-14.5c3.8-8.8 2-19-4.6-25.9c-14.2-15.6-26.2-33.7-36.6-52.1c-.9-1.7-1.9-3.4-2.8-5.1C622.8 384.1 640 345.8 640 304c0-94.4-87.9-171.5-198.2-175.8c4.1 15.2 6.2 31.2 6.2 47.8l0 .6c87.2 6.7 144 67.5 144 127.4c0 28-11.4 54.9-32.7 77.2c-14.3 15-17.3 37.6-7.5 55.8c1.1 2 2.2 4 3.2 5.9c2.5 4.5 5.2 9 7.9 13.6c-17-4.5-33.9-10.7-49.9-18c-4.3-1.9-8.5-3.9-12.6-6c-9.5-4.8-20.3-6.2-30.7-4.2c-12.1 2.4-24.7 3.6-37.8 3.6c-61.7 0-110-26.5-136.8-62.3c-16 5.4-32.8 9.4-50 11.8C279 439.8 350 480 432 480z"/>
            </svg>
            <h2 class="no">
              ${this.formatNumber(currentOpinion)}
            </h2>
          </div>
          <span class="desc">All replies</span>
        </div>
        <div class="compared">
          ${icon}
          <span class="info">Compared to prior month</span>
        </div>
      </div>
    `
    }

    getStyles() {
      return /* css */`
      <style>
        *,
        *:after,
        *:before {
          box-sizing: border-box !important;
          font-family: inherit;
          -webkit-box-sizing: border-box !important;
        }

        *:focus {
          outline: inherit !important;
        }

        *::-webkit-scrollbar {
          -webkit-appearance: none;
        }

        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
          padding: 0;
          margin: 0;
          font-family: inherit;
        }

        p,
        ul,
        ol {
          padding: 0;
          margin: 0;
        }

        a {
          text-decoration: none;
        }

        :host {
          font-size: 16px;
          border-bottom: var(--border);
          margin: 10px 0 0;
          width: 100%;
          display: flex;
          flex-flow: column;
          gap: 10px;
          justify-content: center;
          padding: 0 0 10px;
        }

        .title {
          display: flex;
          position: relative;
          flex-flow: column;
          padding: 6px 0;
          gap: 0;
          justify-content: center;
          color: var(--text-color);
        }

        .title time {
          position: absolute;
          right: 10px;
          color: var(--gray-color);
          font-family: var(--font-mono), monospace;
          border: var(--input-border);
          padding: 2px 10px;
          border-radius: 5px;
          -webkit-border-radius: 5px;
          -moz-border-radius: 5px;
          -ms-border-radius: 5px;
          -o-border-radius: 5px;
        }

        .title > h4 {
          color: var(--text-color);
          font-size: 1.2rem;
          font-weight: 600;
          font-family: var(--font-main), sans-serif;
          margin: 0;
        }

        .title > span.desc {
          color: var(--gray-color);
          font-size: 0.9rem;
          font-family: var(--font-text), sans-serif;
        }

        .content {
          display: flex;
          flex-flow: row;
          justify-content: space-between;
          gap: 20px;
          padding: 6px 0;
          width: 100%;
        }

        .content > .main {
          display: flex;
          flex-flow: column;
          gap: 0;
          padding: 0;
        }

        .content > .main .views {
          display: flex;
          width: max-content;
          flex-flow: column;
          align-items: center;
          gap: 0;
          padding: 0;
        }

        .content > .main .views .text {
          display: flex;
          flex-flow: row;
          align-items: center;
          gap: 5px;
          color: var(--text-color);
        }

        .content > .main .views .text svg {
          width: 25px;
          height: 25px;
        }

        .content > .main .views .text > h2 {
          color: var(--text-color);
          font-size: 1.25rem;
          font-weight: 600;
          font-family: var(--font-main), sans-serif;
          margin: 0;
        }

        .content > .main .views .desc {
          color: var(--gray-color);
          font-size: 0.9rem;
          font-family: var(--font-main), sans-serif;
        }

        .content > .main .compared {
          display: flex;
          flex-flow: column;
          gap: 0;
          padding: 0;
          margin: 20px 0 0 0;
        }

        .content > .main .compared > .change {
          display: flex;
          flex-flow: row;
          gap: 2px;
          padding: 0;
          align-items: center;
        }

        .content > .main .compared > .change.up {
          color: var(--accent-alt);
        }

        .content > .main .compared > .change.down {
          color: var(--error-color);
        }

        .content > .main .compared > .change.up .percentage {
          color: transparent;
          background: var(--accent-linear);
          background-clip: text;
          -webkit-background-clip: text;
        }

        .content > .main .compared > .change .percentage {
          /* color: var(--text-color); */
          font-size: 1.05rem;
          font-weight: 500;
          font-family: var(--font-read), sans-serif;
          margin: 0;
        }

        .content > .main .compared > .change svg {
          width: 20px;
          height: 20px;
        }

        .content > .main .compared span.info {
          color: var(--gray-color);
          font-size: 0.9rem;
          font-family: var(--font-text), sans-serif;
          font-style: italic;
        }

        @media screen and (max-width:600px) {
          ::-webkit-scrollbar {
            -webkit-appearance: none;
          }

          :host {
            border-bottom: none;
            gap: 0;
            padding: 10px 0;
          }

          .content {
            display: flex;
            flex-flow: column;
            justify-content: center;
            align-items: center;
            gap: 15px;
            padding: 6px 0;
            width: 100%;
          }

          .content > .main {
            border-bottom: var(--border);
            width: 100%;
            display: flex;
            flex-flow: column;
            gap: 0;
            padding: 0 5px 10px;
          }
        }
      </style>
    `;
    }
  }

  class RepliesStat extends HTMLElement {
    constructor() {
      // We are not even going to touch this.
      super();

      this._up = `
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" fill="currentColor">
        <path d="M4.53 4.75A.75.75 0 0 1 5.28 4h6.01a.75.75 0 0 1 .75.75v6.01a.75.75 0 0 1-1.5 0v-4.2l-5.26 5.261a.749.749 0 0 1-1.275-.326.749.749 0 0 1 .215-.734L9.48 5.5h-4.2a.75.75 0 0 1-.75-.75Z"></path>
      </svg>
    `;

      this._down = `
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" fill="currentColor">
        <path d="M4.22 4.179a.75.75 0 0 1 1.06 0l5.26 5.26v-4.2a.75.75 0 0 1 1.5 0v6.01a.75.75 0 0 1-.75.75H5.28a.75.75 0 0 1 0-1.5h4.2L4.22 5.24a.75.75 0 0 1 0-1.06Z"></path>
      </svg>
    `;

      // let's create our shadow root
      this.shadowObj = this.attachShadow({ mode: "open" });

      this.render();
    }

    render() {
      this.shadowObj.innerHTML = this.getTemplate();
    }

    connectedCallback() {
      
    }

    formatNumber = n => {
      if (n >= 0 && n <= 999) {
        return n.toString();
      } else if (n >= 1000 && n <= 9999) {
        const value = (n / 1000).toFixed(2);
        return `${value}k`;
      } else if (n >= 10000 && n <= 99999) {
        const value = (n / 1000).toFixed(1);
        return `${value}k`;
      } else if (n >= 100000 && n <= 999999) {
        const value = (n / 1000).toFixed(0);
        return `${value}k`;
      } else if (n >= 1000000 && n <= 9999999) {
        const value = (n / 1000000).toFixed(2);
        return `${value}M`;
      } else if (n >= 10000000 && n <= 99999999) {
        const value = (n / 1000000).toFixed(1);
        return `${value}M`;
      } else if (n >= 100000000 && n <= 999999999) {
        const value = (n / 1000000).toFixed(0);
        return `${value}M`;
      } else if (n >= 1000000000) {
        return "1B+";
      }
      else {
        return 0;
      }
    }

    calculateDifference = (last, current) => {
      // Calculate the difference between the new and old values
      const difference = current - last;

      return difference;
    }

    parseToNumber = num_str => {
      // Try parsing the string to an integer
      const num = parseInt(num_str);

      // Check if parsing was successful
      if (!isNaN(num)) {
        return num;
      } else {
        return 0;
      }
    }

     disableScroll() {
      // Get the current page scroll position
      let scrollTop = window.scrollY || document.documentElement.scrollTop;
      let scrollLeft = window.scrollX || document.documentElement.scrollLeft;
      document.body.classList.add("stop-scrolling");

      // if any scroll is attempted, set this to the previous value
      window.onscroll = function () {
        window.scrollTo(scrollLeft, scrollTop);
      };
    }

    enableScroll() {
      document.body.classList.remove("stop-scrolling");
      window.onscroll = function () { };
    }

    getTemplate() {
      // Show HTML Here
      return `
      ${this.getBody()}
      ${this.getStyles()}
    `;
    }

    getBody = () => {
      return /* html */`
      ${this.getHeader()}
      <div class="cards">
        ${this.getViews()}
        ${this.getLikes()}
        ${this.getReplies()}
      </div>
    `;
    }

    getHeader = () => {
      return /* html */`
      <div class="title">
        <h4 class="text">Your replies</h4>
        <span class="desc">Replies stats for the last 30 days</span>
      </div>
    `
    }

    getViews = () => {
      let icon = '';
      const lastViews = this.parseToNumber(this.getAttribute('views-last'));
      const currentViews = this.parseToNumber(this.getAttribute('views'));

      const change = this.calculateDifference(lastViews, currentViews);

      // if change is negative, we need to make it positive
      const difference = Math.abs(change);

      if (change > 0) {
        icon = `
        <span class="change up">
          ${this._up}
          <span class="percentage up">${this.formatNumber(difference)}</span>
        </span>
      `;

      }
      else {
        icon = `
        <span class="change down">
          ${this._down}
          <span class="percentage up">${this.formatNumber(difference)}</span>
        </span>
      `;
      }

      return /* html */`
      <div class="card">
        <h4 class="title">Views</h4>
        <div class="stat">
          <h2 class="no">
            ${this.formatNumber(currentViews)}
          </h2>
          ${icon}
        </div>
      </div>
    `
    }

    getLikes = () => {
      let icon = '';
      const lastLikes = this.parseToNumber(this.getAttribute('likes-last'));
      const currentLikes = this.parseToNumber(this.getAttribute('likes'));

      const change = this.calculateDifference(lastLikes, currentLikes);

      // if change is negative, we need to make it positive
      const difference = Math.abs(change);

      if (change > 0) {
        icon = `
        <span class="change up">
          ${this._up}
          <span class="percentage up">${this.formatNumber(difference)}</span>
        </span>
      `;

      }
      else {
        icon = `
        <span class="change down">
          ${this._down}
          <span class="percentage up">${this.formatNumber(difference)}</span>
        </span>
      `;
      }

      return /* html */`
      <div class="card">
        <h4 class="title">Likes</h4>
        <div class="stat">
          <h2 class="no">
            ${this.formatNumber(currentLikes)}
          </h2>
          ${icon}
        </div>
      </div>
    `
    }

    getReplies = () => {
      let icon = '';
      const lastReplies = this.parseToNumber(this.getAttribute('replies-last'));
      const currentReplies = this.parseToNumber(this.getAttribute('replies'));

      const change = this.calculateDifference(lastReplies, currentReplies);

      // if change is negative, we need to make it positive
      const difference = Math.abs(change);

      if (change > 0) {
        icon = `
        <span class="change up">
          ${this._up}
          <span class="percentage up">${this.formatNumber(difference)}</span>
        </span>
      `;

      }
      else {
        icon = `
        <span class="change down">
          ${this._down}
          <span class="percentage up">${this.formatNumber(difference)}</span>
        </span>
      `;
      }

      return /* html */`
      <div class="card">
        <h4 class="title">Replies</h4>
        <div class="stat">
          <h2 class="no">
            ${this.formatNumber(currentReplies)}
          </h2>
          ${icon}
        </div>
      </div>
    `
    }

    getStyles() {
      return /* css */`
      <style>
        *,
        *:after,
        *:before {
          box-sizing: border-box !important;
          font-family: inherit;
          -webkit-box-sizing: border-box !important;
        }

        *:focus {
          outline: inherit !important;
        }

        *::-webkit-scrollbar {
          -webkit-appearance: none;
        }

        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
          padding: 0;
          margin: 0;
          font-family: inherit;
        }

        p,
        ul,
        ol {
          padding: 0;
          margin: 0;
        }

        a {
          text-decoration: none;
        }

        :host {
          font-size: 16px;
          border-bottom: var(--border-mobile);
          margin: 0;
          width: 100%;
          display: flex;
          flex-flow: column;
          gap: 10px;
          justify-content: center;
          padding: 0 0 10px;
        }

        .title {
          display: flex;
          position: relative;
          flex-flow: column;
          padding: 6px 0;
          gap: 0;
          justify-content: center;
          color: var(--text-color);
        }

        .title time {
          position: absolute;
          right: 10px;
          color: var(--gray-color);
          font-family: var(--font-mono), monospace;
          border: var(--input-border);
          padding: 2px 10px;
          border-radius: 5px;
          -webkit-border-radius: 5px;
          -moz-border-radius: 5px;
          -ms-border-radius: 5px;
          -o-border-radius: 5px;
        }

        .title > h4 {
          color: var(--text-color);
          font-size: 1.2rem;
          font-weight: 500;
          font-family: var(--font-main), sans-serif;
          margin: 0;
        }

        .title > span.desc {
          color: var(--gray-color);
          font-size: 0.85rem;
          font-family: var(--font-main), sans-serif;
        }

        .cards {
          display: flex;
          flex-flow: row;
          justify-content: space-between;
          gap: 20px;
          padding: 6px 0;
          width: 100%;
        }

        .cards > .card {
          display: flex;
          flex-flow: column;
          gap: 7px;
          padding: 8px 15px;
          min-width: 200px;
          background-color: var(--stat-background);
          justify-content: center;
          border-radius: 10px;
        }

        .cards > .card > .title {
          color: var(--text-color);
          font-size: 1rem;
          font-weight: 500;
          font-family: var(--font-main), sans-serif;
          margin: 0;
        }

        .cards > .card > .stat {
          color: var(--text-color);
          display: flex;
          flex-flow: row;
          gap: 15px;
          align-items: end;
          font-family: var(--font-main), sans-serif;
          margin: 0;
        }

        .cards > .card > .stat > h2.no {
          color: var(--text-color);
          font-size: 1.25rem;
          font-weight: 600;
          font-family: var(--font-main), sans-serif;
          margin: 0;
        }

        .cards > .card > .stat > .change {
          display: flex;
          flex-flow: row;
          gap: 2px;
          padding: 0 0 2px 0;
        }

        .cards > .card > .stat > .change.up {
          color: var(--accent-alt);
        }

        .cards > .card > .stat > .change.down {
          color: var(--error-color);
        }

        .cards > .card > .stat > .change.up .percentage {
          color: transparent;
          background: var(--accent-linear);
          background-clip: text;
          -webkit-background-clip: text;
        }

        .cards > .card > .stat > .change .percentage {
          font-size: 1rem;
          font-weight: 500;
          font-family: var(--font-main), sans-serif;
          margin: 0;
        }

        .cards > .card > .stat > .change svg {
          width: 18px;
          height: 18px;
          margin-top: 2px;
        }

        .cards > .card > .stat > .change.up > svg {
          margin: 0;
        }

        @media screen and (max-width:950px) {
          .cards > .card {
            min-width: 150px;
          }
        }

        @media screen and (max-width:800px) {
          .cards > .card {
            min-width: 120px;
          }
        }

        @media screen and (max-width:660px) {
          ::-webkit-scrollbar {
            -webkit-appearance: none;
          }

          :host {
            padding-bottom: 25px;
            gap: 0;
          }

          .cards {
            display: flex;
            flex-flow: column;
            justify-content: center;
            align-items: center;
            gap: 0;
            padding: 0;
            width: 100%;
          }

          .cards > .card {
            background-color: transparent;
            border-bottom: var(--border);
            display: flex;
            flex-flow: column;
            width: 100%;
            gap: 10px;
            padding: 10px 5px;
            border-radius: 0;
          }

          .cards > .card > h4.title {
            color: var(--gray-color);
            font-size: 1rem;
            font-weight: 500;
            font-family: var(--font-text), sans-serif;
            margin: 0 0 0 -2px;
          }
        }
      </style>
    `;
    }
  }

  class StatReply extends HTMLElement {
    constructor() {
      // We are not even going to touch this.
      super();

      // let's create our shadow root
      this.shadowObj = this.attachShadow({ mode: "open" });

      this.render();
    }

    render() {
      this.shadowObj.innerHTML = this.getTemplate();
    }

    connectedCallback() {
      // open post
      this.openPost();
    }

     disableScroll() {
      // Get the current page scroll position
      let scrollTop = window.scrollY || document.documentElement.scrollTop;
      let scrollLeft = window.scrollX || document.documentElement.scrollLeft;
      document.body.classList.add("stop-scrolling");

      // if any scroll is attempted, set this to the previous value
      window.onscroll = function () {
        window.scrollTo(scrollLeft, scrollTop);
      };
    }

    enableScroll() {
      document.body.classList.remove("stop-scrolling");
      window.onscroll = function () { };
    }

    openPost = () => {
      // get url
      let url = this.getAttribute('url');

      url = url.trim().toLowerCase();

      // Get the body
      const body = document.querySelector('body');

      // get current content
      const content = this.shadowObj.querySelector('.actions>.action#view-action');

      if(body && content) {
        content.addEventListener('click', event => {
          event.preventDefault();
          event.stopPropagation();
          event.stopImmediatePropagation();

          // Get full post
          const post =  this.getFullPost();

          // replace and push states
          this.replaceAndPushStates(url, body, post);

          body.innerHTML = post;
        });
      }
    }

    // Replace and push states
    replaceAndPushStates = (url, body, post) => {
      // get the first custom element in the body
      const firstElement = body.firstElementChild;

      // convert the custom element to a string
       const elementString = firstElement.outerHTML;

      // get window location
      const pageUrl = window.location.href;
      window.history.replaceState(
        { page: 'page', content: elementString },
        url, pageUrl
      );

      // Updating History State
      window.history.pushState(
        { page: 'page', content: post},
        url, url
      );
    }

    formatNumber = n => {
      if (n >= 0 && n <= 999) {
        return n.toString();
      } else if (n >= 1000 && n <= 9999) {
        const value = (n / 1000).toFixed(2);
        return `${value}k`;
      } else if (n >= 10000 && n <= 99999) {
        const value = (n / 1000).toFixed(1);
        return `${value}k`;
      } else if (n >= 100000 && n <= 999999) {
        const value = (n / 1000).toFixed(0);
        return `${value}k`;
      } else if (n >= 1000000 && n <= 9999999) {
        const value = (n / 1000000).toFixed(2);
        return `${value}M`;
      } else if (n >= 10000000 && n <= 99999999) {
        const value = (n / 1000000).toFixed(1);
        return `${value}M`;
      } else if (n >= 100000000 && n <= 999999999) {
        const value = (n / 1000000).toFixed(0);
        return `${value}M`;
      } else if (n >= 1000000000) {
        return "1B+";
      }
      else {
        return 0;
      }
    }

    parseToNumber = num_str => {
      // Try parsing the string to an integer
      const num = parseInt(num_str);

      // Check if parsing was successful
      if (!isNaN(num)) {
        return num;
      } else {
        return 0;
      }
    }

    getTemplate() {
      // Show HTML Here
      return `
      ${this.getBody()}
      ${this.getStyles()}
    `;
    }

    getBody = () => {
      const likes = this.parseToNumber(this.getAttribute('likes'));
      const views = this.parseToNumber(this.getAttribute('views'));
      return /* html */`
      ${this.getPost()}
      ${this.getActions(likes, views)}
    `;
    }

    getPost = () => {
      const mql = window.matchMedia('(max-width: 660px)');
      let images = this.getAttribute('images');
      images = images  && images !== 'null' ? images.split(',') : [];
      // Remove html tags
      const contentStr = this.innerHTML.replace(/<[^>]*>/g, '');
      const contentLength = contentStr.length;

      let chars = 250;

      // Check if its a mobile view
      if (mql.matches) {
        chars = 200;
      }

      // Check if content length is greater than: chars
      if (contentLength > chars) {
        return /*html*/`
        <div class="content extra ${chars <= 200 ? 'feed' : ''}" id="content">
          ${this.innerHTML}
          <div class="read-more">
            <span class="action">view more</span>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" fill="currentColor">
              <path d="M12.78 5.22a.749.749 0 0 1 0 1.06l-4.25 4.25a.749.749 0 0 1-1.06 0L3.22 6.28a.749.749 0 1 1 1.06-1.06L8 8.939l3.72-3.719a.749.749 0 0 1 1.06 0Z"></path>
            </svg>
          </div>
        </div>
        ${this.getImages(images)}
      `
      }
      else {
        return /*html*/`
        <div class="content" id="content">
          ${this.innerHTML}
        </div>
        ${this.getImages(images)}
      `
      }
    }

    getImages = imageArray => {
      // if length is greater is less than 1
      if(!imageArray || imageArray.length < 1) return '';

      // return
      return /* html */`
      <images-wrapper images="${imageArray.join(',')}"></images-wrapper>
    `
    }

    styleLastBlock = () => {
      const content = this.shadowObj.querySelector('.content#content');
      if (!content) return;

      const lastBlock = content.lastElementChild;
      if (!lastBlock) return;

      // style the last block
      lastBlock.style.setProperty('padding', '0 0 0');
      lastBlock.style.setProperty('margin', '0 0 0');
    }

    openReadMore = () => {
      // Get the read more button
      const readMore = this.shadowObj.querySelector('.content .read-more');

      // Get the content
      const content = this.shadowObj.querySelector('.content');

      // Check if the read more button exists
      if (readMore && content) {
        readMore.addEventListener('click', e => {
          // prevent the default action
          e.preventDefault();

          // prevent the propagation of the event
          e.stopPropagation();

          // Prevent event from reaching any immediate nodes.
          e.stopImmediatePropagation();

          // Toggle the active class
          content.classList.remove('extra');

          // remove the read more button
          readMore.remove();
        });
      }
    }

    openUrl = () => {
      // get all the links
      const links = this.shadowObj.querySelectorAll('div#content a');
      const body = document.querySelector('body');

      // loop through the links
      if (!links) return;

      links.forEach(link => {
        // add event listener to the link
        link.addEventListener('click', event => {
          event.preventDefault();
          event.stopPropagation();
          event.stopImmediatePropagation();
          // get the url
          const url = link.getAttribute('href');

          // link pop up
          let linkPopUp = `<url-popup url="${url}"></url-popup>`;

          // open the popup
          body.insertAdjacentHTML('beforeend', linkPopUp);
        });
      });
    }

    getActions = (likes, views) => {
      const viewUrl = this.getAttribute('url');
      return /*html*/`
      <div class="actions">
        <a href="${viewUrl}" class="action view" id="view-action">view</a>
        <span class="action likes plain">
          <span class="no">${this.formatNumber(likes)}</span> <span class="text">${likes === 1 ? 'like' : 'likes'}</span>
        </span>
        <span class="action views plain">
          <span class="no">${this.formatNumber(views)}</span> <span class="text">${views === 1 ? 'view' : 'views'}</span>
        </span>
      </div>
    `
    }

    getFullPost = () => {
      const parent = this.getAttribute('parent');
      let text = parent ? `parent="${parent}"` : '';
      const images = this.getAttribute('images');
      return /* html */`
      <app-post story="quick" tab="replies" url="${this.getAttribute('url')}" hash="${this.getAttribute('hash')}"
        likes="${this.getAttribute('likes')}" replies="${this.getAttribute('replies')}" ${text} images='${images}'
        replies-url="${this.getAttribute('replies-url')}" likes-url="${this.getAttribute('likes-url')}"
        liked="${this.getAttribute('liked')}" views="${this.getAttribute('views')}" time="${this.getAttribute('time')}"
        author-stories="${this.getAttribute('author-stories')}" author-replies="${this.getAttribute('author-replies')}" author-contact='${this.getAttribute("author-contact")}'
        author-you="${this.getAttribute('author-you')}" author-hash="${this.getAttribute('author-hash')}" author-url="${this.getAttribute('author-url')}"
        author-img="${this.getAttribute('author-img')}" author-verified="${this.getAttribute('author-verified')}" author-name="${this.getAttribute('author-name')}"
        author-followers="${this.getAttribute('author-followers')}" author-following="${this.getAttribute('author-following')}" author-follow="${this.getAttribute('author-follow')}"
        author-bio="${this.getAttribute('author-bio')}">
        ${this.innerHTML}
      </app-post>
    `
    }

    getStyles() {
      return /* css */`
      <style>
        *,
        *:after,
        *:before {
          box-sizing: border-box !important;
          font-family: inherit;
          -webkit-box-sizing: border-box !important;
        }

        *:focus {
          outline: inherit !important;
        }

        *::-webkit-scrollbar {
          -webkit-appearance: none;
        }

        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
          padding: 0;
          margin: 0;
          font-family: inherit;
        }

        p,
        ul,
        ol {
          padding: 0;
          margin: 0;
        }

        a {
          text-decoration: none;
        }

        :host {
          font-size: 16px;
          display: flex;
          flex-flow: column;
          gap: 5px;
          padding: 10px 0;
          border-bottom: var(--border);
          width: 100%;
        }

        .content {
          width: 100%;
          display: flex;
          flex-flow: column;
          color: var(--text-color);
          font-family: var(--font-main), sans-serif;
          line-height: 1.4;
          gap: 0;
          margin: 0;
          padding: 0;
        }

        .content.extra {
          max-height: 200px;
          overflow: hidden;
          position: relative;
        }

        .content.extra.feed {
          max-height: 150px;
        }

        .content.extra .read-more {
          position: absolute;
          bottom: -5px;
          right: 0;
          left: 0;
          width: 100%;
          padding: 5px 0;
          display: flex;
          align-items: end;
          justify-content: center;
          min-height: 80px;
          gap: 3px;
          font-weight: 500;
          font-family: var(--font-main), sans-serif;
          color: var(--gray-color);
          background: var(--fade-linear-gradient);
        }

        .content.extra .read-more svg {
          display: inline-block;
          width: 16px;
          height: 16px;
          margin: 0 0 2px 0;
        }

        .content h6,
        .content h5,
        .content h4,
        .content h3,
        .content h1 {
          padding: 0;
          font-size: 1.3rem !important;
          color: var(--title-color);
          font-weight: 500;
          line-height: 1.5;
          margin: 5px 0;
        }

        .content p {
          font-size: 1rem;
          margin: 0 0 5px;
          line-height: 1.4;
        }

        .content a {
          text-decoration: none;
          cursor: pointer;
          color: var(--anchor-color) !important;
        }

        .content a:hover {
          text-decoration: underline;
        }

        .content blockquote {
          margin: 2px 0;
          padding: 5px 0;
          font-style: italic;
          background: var(--background);
          color: var(--text-color);
          font-weight: 400;
          line-height: 1.4;
        }

        .content blockquote p {
          margin: 0;
        }

        .content blockquote * {
          margin: 0;
        }

        .content hr {
          border: none;
          background-color: var(--text-color);
          height: 1px;
          margin: 10px 0;
        }

        .content code {
          background: var(--gray-background);
          padding: 0 5px;
          font-family: var(--font-mono);
          font-size: 0.9rem;
          border-radius: 5px;
        }

        .content b,
        .content strong {
          font-weight: 700;
          line-height: 1.4;

        }

        .content ul,
        .content ol {
          margin: 5px 0 15px 20px;
          padding: 0 0 0 15px;
          color: inherit;
          line-height: 1.4;
        }

        .content ul li,
        .content ol li {
          margin: 6px 0;
          padding: 0;
          color: inherit;
        }

        .content > h3.story-title {
          margin: 0;
          color: var(--text-color);
          font-family: var(--font-main), sans-serif;
          line-height: 1.5;
          font-size: 1.15rem;
          font-weight: 500;
        }

        .actions {
          display: flex;
          font-family: var(--font-main), sans-serif;
          width: 100%;
          flex-flow: row;
          align-items: center;
          gap: 15px;
          margin: 5px 0 0 0;
        }
        
        .actions > .action {
          border: var(--border-button);
          text-decoration: none;
          color: var(--gray-color);
          font-size: 0.9rem;
          display: flex;
          width: max-content;
          flex-flow: row;
          align-items: center;
          text-transform: lowercase;
          justify-content: center;
          padding: 1.5px 10px 2.5px;
          border-radius: 10px;
        }

        .actions > .action.edit {
          border: none;
          background: var(--gray-background);
          color: var(--text-color);
          font-size: 0.9rem;
          padding: 2.5px 12px 3.5px;
        }

        .actions > .action.publish {
          text-transform: capitalize;
          padding: 2.5px 10px 3.5px;
        }

        .actions > .action.plain {
          padding: 0;
          font-weight: 500;
          pointer-events: none;
          font-family: var(--font-text), sans-serif;
          color: var(--gray-color);
          border: none;
          background: none;
          padding: 2.5px 0 3.5px 0;
        }

        .actions > .action.plain.draft {
          text-transform: capitalize;
          font-family: var(--font-main), sans-serif;
          font-size: 0.9rem;
          font-weight: 500;
          color: var(--text-color);
          padding: 2.5px 0 3.5px 0;
        }
        
        .actions > .action.plain > span.no {
          font-family: var(--font-main), sans-serif;
          font-size: 0.85rem;
          color: var(--text-color);
        }

        .actions > .action.plain > span.text {
          display: inline-block;
          padding: 0 0 0 3px;
        }

        @media screen and (max-width:660px) {
          ::-webkit-scrollbar {
            -webkit-appearance: none;
          }

          .actions {
            width: 100%;
          }

          .actions > .action.plain > span.no {
            font-family: var(--font-main), sans-serif;
            font-size: 0.8rem;
            color: var(--text-color);
          }

          button.fetch,
          .content.extra .read-more,
          .actions > .action.close,
          a {
            cursor: default !important;
          }
        }
      </style>
    `;
    }
  }

  class StatStory extends HTMLElement {
    constructor() {
      // We are not even going to touch this.
      super();

      // let's create our shadow root
      this.shadowObj = this.attachShadow({ mode: "open" });

      this.render();
    }

    render() {
      this.shadowObj.innerHTML = this.getTemplate();
    }

    connectedCallback() {
      // open post 
      this.openPost();

      // open read more
      this.openReadMore();

      // open url
      this.openUrl();

      // style last block
      this.styleLastBlock();
    }

    disableScroll() {
      // Get the current page scroll position
      let scrollTop = window.scrollY || document.documentElement.scrollTop;
      let scrollLeft = window.scrollX || document.documentElement.scrollLeft;
      document.body.classList.add("stop-scrolling");

      // if any scroll is attempted, set this to the previous value
      window.onscroll = function () {
        window.scrollTo(scrollLeft, scrollTop);
      };
    }

    enableScroll() {
      document.body.classList.remove("stop-scrolling");
      window.onscroll = function () { };
    }

    openPost = () => {
      // get url
      let url = this.getAttribute('url');

      url = url.trim().toLowerCase();

      // Get the body
      const body = document.querySelector('body');

      // get current content
      const content = this.shadowObj.querySelector('.actions>.action#view-action');

      if(body && content) {
        content.addEventListener('click', event => {
          event.preventDefault();
          event.stopPropagation();
          event.stopImmediatePropagation();

          // Get full post
          const post =  this.getFullPost(this.getAttribute('kind'));

          // replace and push states
          this.replaceAndPushStates(url, body, post);

          body.innerHTML = post;
        });
      }
    }

    replaceAndPushStates = (url, body, post) => {
      // get the first custom element in the body
      const firstElement = body.firstElementChild;

      // convert the custom element to a string
       const elementString = firstElement.outerHTML;

      // get window location
      const pageUrl = window.location.href;
      window.history.replaceState(
        { page: 'page', content: elementString },
        url, pageUrl
      );

      // Updating History State
      window.history.pushState(
        { page: 'page', content: post},
        url, url
      );
    }

    formatNumber = n => {
      if (n >= 0 && n <= 999) {
        return n.toString();
      } else if (n >= 1000 && n <= 9999) {
        const value = (n / 1000).toFixed(2);
        return `${value}k`;
      } else if (n >= 10000 && n <= 99999) {
        const value = (n / 1000).toFixed(1);
        return `${value}k`;
      } else if (n >= 100000 && n <= 999999) {
        const value = (n / 1000).toFixed(0);
        return `${value}k`;
      } else if (n >= 1000000 && n <= 9999999) {
        const value = (n / 1000000).toFixed(2);
        return `${value}M`;
      } else if (n >= 10000000 && n <= 99999999) {
        const value = (n / 1000000).toFixed(1);
        return `${value}M`;
      } else if (n >= 100000000 && n <= 999999999) {
        const value = (n / 1000000).toFixed(0);
        return `${value}M`;
      } else if (n >= 1000000000) {
        return "1B+";
      }
      else {
        return 0;
      }
    }

    parseToNumber = num_str => {
      // Try parsing the string to an integer
      const num = parseInt(num_str);

      // Check if parsing was successful
      if (!isNaN(num)) {
        return num;
      } else {
        return 0;
      }
    }

    getTemplate() {
      // Show HTML Here
      return `
      ${this.getBody()}
      ${this.getStyles()}
    `;
    }

    getBody = () => {
      const likes = this.parseToNumber(this.getAttribute('likes'));
      const views = this.parseToNumber(this.getAttribute('views'));
      return /* html */`
      ${this.getContent(this.getAttribute('kind'))}
      ${this.getActions(likes, views)}
    `;
    }

    getContent = story => {
      if (story === 'poll') {
        return this.getPoll();
      } else if (story === 'post') {
        return this.getPost();
      } else if (story === 'story') {
        return this.getStory();
      }
    }

    getPoll = () =>  {
      const mql = window.matchMedia('(max-width: 660px)');
      // Remove html tags
      const contentStr = this.innerHTML.replace(/<[^>]*>/g, '');
      const contentLength = contentStr.length;

      let chars = 250;

      // Check if its a mobile view
      if (mql.matches) {
        chars = 200;
      }

      // Check if content length is greater than :chars
      if (contentLength > chars) {
        return /*html*/`
        <div class="content extra ${chars <= 200 ? 'mobile' : ''}" id="content">
          ${this.innerHTML}
          <div class="read-more">
            <span class="action">view more</span>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" fill="currentColor">
              <path d="M12.78 5.22a.749.749 0 0 1 0 1.06l-4.25 4.25a.749.749 0 0 1-1.06 0L3.22 6.28a.749.749 0 1 1 1.06-1.06L8 8.939l3.72-3.719a.749.749 0 0 1 1.06 0Z"></path>
            </svg>
          </div>
        </div>
        ${this.getVotesWrapper()}
      `
      }
      else {
        return /*html*/`
        <div class="content" id="content">
          ${this.innerHTML}
        </div>
        ${this.getVotesWrapper()}
      `
      }
    }

    getVotesWrapper = () => {
      return /*html*/`
      <votes-wrapper reload="false" votes="${this.getAttribute('votes')}" selected="${this.getAttribute('selected')}"
        hash="${this.getAttribute('hash')}" end-time="${this.getAttribute('end-time')}" voted="${this.getAttribute('voted')}"
        options="${this.getAttribute('options')}">
      </votes-wrapper>
    `
    }

    getStory = () => {
      let images = this.getAttribute('images');
      images = images  && images !== 'null' ? images.split(',') : [];
      let str = this.getHTML();
      let title = this.getAttribute('story-title');
      str = str.replace(/<[^>]*>/g, '');

      str = str.trim();
      const filteredTitle = title && title !== 'null' ? `<h3 class="story-title">${title}</h3>` : '';
      const content = `<p>${this.trimContent(str)}</p>`;

      return /*html*/`
      <div class="content" id="content">
        ${filteredTitle}
        ${content}
      </div>
      ${this.getImages(images)}
    `
    }

    getHTML = () => {
      const text = this.innerHTML;
      const parser = new DOMParser();
      const doc = parser.parseFromString(text, 'text/html');
      return doc.body.innerHTML;
    }

    trimContent = text => {
      // if text is less than 150 characters
      if (text.length <= 200) return text;

      // check for mobile view
      const mql = window.matchMedia('(max-width: 660px)');

      // Check if its a mobile view
      if (mql.matches) {
        // return text substring: 150 characters + ...
        return text.substring(0, 200) + '...';
      } else {
        // trim the text to 250 characters
        return text.substring(0, 300) + '...';
      }
    }

    getPost = () => {
      const mql = window.matchMedia('(max-width: 660px)');
      let images = this.getAttribute('images');
      images = images  && images !== 'null' ? images.split(',') : [];
      // Remove html tags
      const contentStr = this.innerHTML.replace(/<[^>]*>/g, '');
      const contentLength = contentStr.length;

      let chars = 250;

      // Check if its a mobile view
      if (mql.matches) {
        chars = 200;
      }

      // Check if content length is greater than: chars
      if (contentLength > chars) {
        return /*html*/`
        <div class="content extra ${chars <= 200 ? 'feed' : ''}" id="content">
          ${this.innerHTML}
          <div class="read-more">
            <span class="action">view more</span>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" fill="currentColor">
              <path d="M12.78 5.22a.749.749 0 0 1 0 1.06l-4.25 4.25a.749.749 0 0 1-1.06 0L3.22 6.28a.749.749 0 1 1 1.06-1.06L8 8.939l3.72-3.719a.749.749 0 0 1 1.06 0Z"></path>
            </svg>
          </div>
        </div>
        ${this.getImages(images)}
      `
      }
      else {
        return /*html*/`
        <div class="content" id="content">
          ${this.innerHTML}
        </div>
        ${this.getImages(images)}
      `
      }
    }

    getImages = imageArray => {
      // if length is greater is less than 1
      if(!imageArray || imageArray.length < 1) return '';

      // return
      return /* html */`
      <images-wrapper images="${imageArray.join(',')}"></images-wrapper>
    `
    }

    styleLastBlock = () => {
      const content = this.shadowObj.querySelector('.content#content');
      if (!content) return;

      const lastBlock = content.lastElementChild;
      if (!lastBlock) return;

      // style the last block
      lastBlock.style.setProperty('padding', '0 0 0');
      lastBlock.style.setProperty('margin', '0 0 0');
    }

    openReadMore = () => {
      // Get the read more button
      const readMore = this.shadowObj.querySelector('.content .read-more');

      // Get the content
      const content = this.shadowObj.querySelector('.content');

      // Check if the read more button exists
      if (readMore && content) {
        readMore.addEventListener('click', e => {
          // prevent the default action
          e.preventDefault();

          // prevent the propagation of the event
          e.stopPropagation();

          // Prevent event from reaching any immediate nodes.
          e.stopImmediatePropagation();

          // Toggle the active class
          content.classList.remove('extra');

          // remove the read more button
          readMore.remove();
        });
      }
    }

    openUrl = () => {
      // get all the links
      const links = this.shadowObj.querySelectorAll('div#content a');
      const body = document.querySelector('body');

      // loop through the links
      if (!links) return;

      links.forEach(link => {
        // add event listener to the link
        link.addEventListener('click', event => {
          event.preventDefault();
          event.stopPropagation();
          event.stopImmediatePropagation();
          // get the url
          const url = link.getAttribute('href');

          // link pop up
          let linkPopUp = `<url-popup url="${url}"></url-popup>`;

          // open the popup
          body.insertAdjacentHTML('beforeend', linkPopUp);
        });
      });
    }

    getActions = (likes, views) => {
      const viewUrl = this.getAttribute('url');
      return /*html*/`
      <div class="actions">
        <a href="${viewUrl}" class="action view" id="view-action">view</a>
        <span class="action likes plain">
          <span class="no">${this.formatNumber(likes)}</span> <span class="text">${likes === 1 ? 'like' : 'likes'}</span>
        </span>
        <span class="action views plain">
          <span class="no">${this.formatNumber(views)}</span> <span class="text">${views === 1 ? 'view' : 'views'}</span>
        </span>
      </div>
    `
    }

    getFullPost = kind => {
      const parent = this.getAttribute('parent');
      let text = parent ? `parent="${parent}"` : '';
      const images = this.getAttribute('images');
      if (kind === "poll") {
        return /* html */`
        <app-post story="poll" tab="replies" url="${this.getAttribute('url')}" hash="${this.getAttribute('hash')}"
          likes="${this.getAttribute('likes')}" replies="${this.getAttribute('replies')}"
          replies-url="${this.getAttribute('replies-url')}" likes-url="${this.getAttribute('likes-url')}"
          options='${this.getAttribute("options")}' voted="${this.getAttribute('voted')}" selected="${this.getAttribute('selected')}"
          end-time="${this.getAttribute('end-time')}" votes="${this.getAttribute('votes')}" author-contact='${this.getAttribute("author-contact")}'
          liked="${this.getAttribute('liked')}" views="${this.getAttribute('views')}" time="${this.getAttribute('time')}"
          author-you="${this.getAttribute('author-you')}" author-stories="${this.getAttribute('author-stories')}" author-replies="${this.getAttribute('author-replies')}"
          author-hash="${this.getAttribute('author-hash')}" author-url="${this.getAttribute('author-url')}"
          author-img="${this.getAttribute('author-img')}" author-verified="${this.getAttribute('author-verified')}" author-name="${this.getAttribute('author-name')}"
          author-followers="${this.getAttribute('author-followers')}" author-following="${this.getAttribute('author-following')}" author-follow="${this.getAttribute('author-follow')}"
          author-bio="${this.getAttribute('author-bio')}">
          ${this.innerHTML}
        </app-post>
      `
      } else if(kind === "post"){
        return /* html */`
        <app-post story="quick" tab="replies" url="${this.getAttribute('url')}" hash="${this.getAttribute('hash')}"
          likes="${this.getAttribute('likes')}" replies="${this.getAttribute('replies')}" ${text} images='${images}'
          replies-url="${this.getAttribute('replies-url')}" likes-url="${this.getAttribute('likes-url')}"
          liked="${this.getAttribute('liked')}" views="${this.getAttribute('views')}" time="${this.getAttribute('time')}"
          author-stories="${this.getAttribute('author-stories')}" author-replies="${this.getAttribute('author-replies')}" author-contact='${this.getAttribute("author-contact")}'
          author-you="${this.getAttribute('author-you')}" author-hash="${this.getAttribute('author-hash')}" author-url="${this.getAttribute('author-url')}"
          author-img="${this.getAttribute('author-img')}" author-verified="${this.getAttribute('author-verified')}" author-name="${this.getAttribute('author-name')}"
          author-followers="${this.getAttribute('author-followers')}" author-following="${this.getAttribute('author-following')}" author-follow="${this.getAttribute('author-follow')}"
          author-bio="${this.getAttribute('author-bio')}">
          ${this.innerHTML}
        </app-post>
      `
      } else if(kind === "story"){
        return /* html */`
        <app-story  story="story" tab="replies" hash="${this.getAttribute('hash')}"  url="${this.getAttribute('url')}" topics="${this.getAttribute('topics')}" 
          story-title="${this.getAttribute('story-title')}" time="${this.getAttribute('time')}" images='${images}'
          replies-url="${this.getAttribute('replies-url')}" likes-url="${this.getAttribute('likes-url')}"
          likes="${this.getAttribute('likes')}" replies="${this.getAttribute('replies')}" liked="${this.getAttribute('liked')}" views="${this.getAttribute('views')}"
          author-you="${this.getAttribute('author-you')}"
          author-stories="${this.getAttribute('author-stories')}" author-replies="${this.getAttribute('author-replies')}"
          author-hash="${this.getAttribute('author-hash')}" author-url="${this.getAttribute('author-url')}" author-contact='${this.getAttribute("author-contact")}'
          author-img="${this.getAttribute('author-img')}" author-verified="${this.getAttribute('author-verified')}" author-name="${this.getAttribute('author-name')}"
          author-followers="${this.getAttribute('author-followers')}" author-following="${this.getAttribute('author-following')}" author-follow="${this.getAttribute('author-follow')}"
          author-bio="${this.getAttribute('author-bio')}">
          ${this.innerHTML}
        </app-story>
      `
      }
    }

    getStyles() {
      return /* css */`
      <style>
        *,
        *:after,
        *:before {
          box-sizing: border-box !important;
          font-family: inherit;
          -webkit-box-sizing: border-box !important;
        }

        *:focus {
          outline: inherit !important;
        }

        *::-webkit-scrollbar {
          -webkit-appearance: none;
        }

        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
          padding: 0;
          margin: 0;
          font-family: inherit;
        }

        p,
        ul,
        ol {
          padding: 0;
          margin: 0;
        }

        a {
          text-decoration: none;
        }

        :host {
          font-size: 16px;
          display: flex;
          flex-flow: column;
          gap: 5px;
          padding: 10px 0;
          border-bottom: var(--border);
          width: 100%;
        }

        .content {
          width: 100%;
          display: flex;
          flex-flow: column;
          color: var(--text-color);
          font-family: var(--font-main), sans-serif;
          line-height: 1.4;
          gap: 0;
          margin: 0;
          padding: 0;
        }

        .content.extra {
          max-height: 200px;
          overflow: hidden;
          position: relative;
        }

        .content.extra.feed {
          max-height: 150px;
        }

        .content.extra .read-more {
          position: absolute;
          bottom: -5px;
          right: 0;
          left: 0;
          width: 100%;
          padding: 5px 0;
          display: flex;
          align-items: end;
          justify-content: center;
          min-height: 80px;
          gap: 3px;
          font-weight: 500;
          font-family: var(--font-main), sans-serif;
          color: var(--gray-color);
          background: var(--fade-linear-gradient);
        }

        .content.extra .read-more svg {
          display: inline-block;
          width: 16px;
          height: 16px;
          margin: 0 0 2px 0;
        }

        .content h6,
        .content h5,
        .content h4,
        .content h3,
        .content h1 {
          padding: 0;
          font-size: 1.3rem !important;
          color: var(--title-color);
          font-weight: 500;
          line-height: 1.5;
          margin: 5px 0;
        }

        .content p {
          font-size: 1rem;
          margin: 0 0 5px;
          line-height: 1.4;
        }

        .content a {
          text-decoration: none;
          cursor: pointer;
          color: var(--anchor-color) !important;
        }

        .content a:hover {
          text-decoration: underline;
        }

        .content blockquote {
          margin: 2px 0;
          padding: 5px 0;
          font-style: italic;
          background: var(--background);
          color: var(--text-color);
          font-weight: 400;
          line-height: 1.4;
        }

        .content blockquote p {
          margin: 0;
        }

        .content blockquote * {
          margin: 0;
        }

        .content hr {
          border: none;
          background-color: var(--text-color);
          height: 1px;
          margin: 10px 0;
        }

        .content code {
          background: var(--gray-background);
          padding: 0 5px;
          font-family: var(--font-mono);
          font-size: 0.9rem;
          border-radius: 5px;
        }

        .content b,
        .content strong {
          font-weight: 700;
          line-height: 1.4;

        }

        .content ul,
        .content ol {
          margin: 5px 0 15px 20px;
          padding: 0 0 0 15px;
          color: inherit;
          line-height: 1.4;
        }

        .content ul li,
        .content ol li {
          margin: 6px 0;
          padding: 0;
          color: inherit;
        }

        .content > h3.story-title {
          margin: 0;
          color: var(--text-color);
          font-family: var(--font-main), sans-serif;
          line-height: 1.5;
          font-size: 1.15rem;
          font-weight: 500;
        }

        .actions {
          display: flex;
          font-family: var(--font-main), sans-serif;
          width: 100%;
          flex-flow: row;
          align-items: center;
          gap: 15px;
          margin: 5px 0 0 0;
        }
        
        .actions > .action {
          border: var(--border-button);
          text-decoration: none;
          color: var(--gray-color);
          font-size: 0.9rem;
          display: flex;
          width: max-content;
          flex-flow: row;
          align-items: center;
          text-transform: lowercase;
          justify-content: center;
          padding: 1.5px 10px 2.5px;
          border-radius: 10px;
        }

        .actions > .action.edit {
          border: none;
          background: var(--gray-background);
          color: var(--text-color);
          font-size: 0.9rem;
          padding: 2.5px 12px 3.5px;
        }

        .actions > .action.publish {
          text-transform: capitalize;
          padding: 2.5px 10px 3.5px;
        }

        .actions > .action.plain {
          padding: 0;
          font-weight: 500;
          pointer-events: none;
          font-family: var(--font-text), sans-serif;
          color: var(--gray-color);
          border: none;
          background: none;
          padding: 2.5px 0 3.5px 0;
        }

        .actions > .action.plain.draft {
          text-transform: capitalize;
          font-family: var(--font-main), sans-serif;
          font-size: 0.9rem;
          font-weight: 500;
          color: var(--text-color);
          padding: 2.5px 0 3.5px 0;
        }
        
        .actions > .action.plain > span.no {
          font-family: var(--font-main), sans-serif;
          font-size: 0.85rem;
          color: var(--text-color);
        }

        .actions > .action.plain > span.text {
          display: inline-block;
          padding: 0 0 0 3px;
        }

        @media screen and (max-width:660px) {
          ::-webkit-scrollbar {
            -webkit-appearance: none;
          }

          .actions {
            width: 100%;
          }

          .actions > .action.plain > span.no {
            font-family: var(--font-main), sans-serif;
            font-size: 0.8rem;
            color: var(--text-color);
          }

          button.fetch,
          .content.extra .read-more,
          .actions > .action.close,
          a {
            cursor: default !important;
          }
        }
      </style>
    `;
    }
  }

  class StoriesStat extends HTMLElement {
    constructor() {
      // We are not even going to touch this.
      super();

      this._up  = `
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" fill="currentColor">
        <path d="M4.53 4.75A.75.75 0 0 1 5.28 4h6.01a.75.75 0 0 1 .75.75v6.01a.75.75 0 0 1-1.5 0v-4.2l-5.26 5.261a.749.749 0 0 1-1.275-.326.749.749 0 0 1 .215-.734L9.48 5.5h-4.2a.75.75 0 0 1-.75-.75Z"></path>
      </svg>
    `;

      this._down = `
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" fill="currentColor">
        <path d="M4.22 4.179a.75.75 0 0 1 1.06 0l5.26 5.26v-4.2a.75.75 0 0 1 1.5 0v6.01a.75.75 0 0 1-.75.75H5.28a.75.75 0 0 1 0-1.5h4.2L4.22 5.24a.75.75 0 0 1 0-1.06Z"></path>
      </svg>
    `;

      // let's create our shadow root
      this.shadowObj = this.attachShadow({ mode: "open" });

      this.render();
    }

    render() {
      this.shadowObj.innerHTML = this.getTemplate();
    }

    connectedCallback() {
      
    }

    formatNumber = n => {
      if (n >= 0 && n <= 999) {
        return n.toString();
      } else if (n >= 1000 && n <= 9999) {
        const value = (n / 1000).toFixed(2);
        return `${value}k`;
      } else if (n >= 10000 && n <= 99999) {
        const value = (n / 1000).toFixed(1);
        return `${value}k`;
      } else if (n >= 100000 && n <= 999999) {
        const value = (n / 1000).toFixed(0);
        return `${value}k`;
      } else if (n >= 1000000 && n <= 9999999) {
        const value = (n / 1000000).toFixed(2);
        return `${value}M`;
      } else if (n >= 10000000 && n <= 99999999) {
        const value = (n / 1000000).toFixed(1);
        return `${value}M`;
      } else if (n >= 100000000 && n <= 999999999) {
        const value = (n / 1000000).toFixed(0);
        return `${value}M`;
      } else if (n >= 1000000000) {
        return "1B+";
      }
      else {
        return 0;
      }
    }

    calculateDifference = (last, current) => {
      // Calculate the difference between the new and old values
      const difference = current - last;

      return difference;
    }

    parseToNumber = num_str => {
      // Try parsing the string to an integer
      const num = parseInt(num_str);

      // Check if parsing was successful
      if (!isNaN(num)) {
        return num;
      } else {
        return 0;
      }
    }

     disableScroll() {
      // Get the current page scroll position
      let scrollTop = window.scrollY || document.documentElement.scrollTop;
      let scrollLeft = window.scrollX || document.documentElement.scrollLeft;
      document.body.classList.add("stop-scrolling");

      // if any scroll is attempted, set this to the previous value
      window.onscroll = function () {
        window.scrollTo(scrollLeft, scrollTop);
      };
    }

    enableScroll() {
      document.body.classList.remove("stop-scrolling");
      window.onscroll = function () { };
    }

    getTemplate() {
      // Show HTML Here
      return `
      ${this.getBody()}
      ${this.getStyles()}
    `;
    }

    getBody = () => {
      return /* html */`
      ${this.getHeader()}
      <div class="cards">
        ${this.getViews()}
        ${this.getLikes()}
        ${this.getReplies()}
      </div>
    `;
    }

    getHeader = () => {
      return /* html */`
      <div class="title">
        <h4 class="text">Your stories</h4>
        <span class="desc">Stories stats for the last 30 days</span>
      </div>
    `
    }

    getViews = () => {
      let icon = '';
      const lastViews = this.parseToNumber(this.getAttribute('views-last'));
      const currentViews = this.parseToNumber(this.getAttribute('views'));


      const change = this.calculateDifference(lastViews, currentViews);

      // if change is negative, we need to make it positive
      const difference = Math.abs(change);

      // console.log(`All Percentage Change: ${change}`);
      if (change > 0) {
        icon = `
        <span class="change up">
          ${this._up}
          <span class="percentage up">${this.formatNumber(difference)}</span>
        </span>
      `;

      }
      else {
        icon = `
        <span class="change down">
          ${this._down}
          <span class="percentage up">${this.formatNumber(difference)}</span>
        </span>
      `;
      }

      return /* html */`
      <div class="card">
        <h4 class="title">Views</h4>
        <div class="stat">
          <h2 class="no">
            ${this.formatNumber(currentViews)}
          </h2>
          ${icon}
        </div>
      </div>
    `
    }

    getLikes = () => {
      let icon = '';
      const lastLikes = this.parseToNumber(this.getAttribute('likes-last'));
      const currentLikes = this.parseToNumber(this.getAttribute('likes'));

      const change = this.calculateDifference(lastLikes, currentLikes);

      // if change is negative, we need to make it positive
      const difference = Math.abs(change);

      // console.log(`All Percentage Change: ${change}`);
      if (change > 0) {
        icon = `
        <span class="change up">
          ${this._up}
          <span class="percentage up">${this.formatNumber(difference)}</span>
        </span>
      `;

      }
      else {
        icon = `
        <span class="change down">
          ${this._down}
          <span class="percentage up">${this.formatNumber(difference)}</span>
        </span>
      `;
      }

      return /* html */`
      <div class="card">
        <h4 class="title">Likes</h4>
        <div class="stat">
          <h2 class="no">
            ${this.formatNumber(currentLikes)}
          </h2>
          ${icon}
        </div>
      </div>
    `
    }

    getReplies = () => {
      let icon = '';
      const lastReplies = this.parseToNumber(this.getAttribute('replies-last'));
      const currentReplies = this.parseToNumber(this.getAttribute('replies'));

      const change = this.calculateDifference(lastReplies, currentReplies);

      // if change is negative, we need to make it positive
      const difference = Math.abs(change);

      // console.log(`All Percentage Change: ${change}`);
      if (change > 0) {
        icon = `
        <span class="change up">
          ${this._up}
          <span class="percentage up">${this.formatNumber(difference)}</span>
        </span>
      `;

      }
      else {
        icon = `
        <span class="change down">
          ${this._down}
          <span class="percentage up">${this.formatNumber(difference)}</span>
        </span>
      `;
      }

      return /* html */`
      <div class="card">
        <h4 class="title">Replies</h4>
        <div class="stat">
          <h2 class="no">
            ${this.formatNumber(currentReplies)}
          </h2>
          ${icon}
        </div>
      </div>
    `
    }

    getStyles() {
      return /* css */`
      <style>
        *,
        *:after,
        *:before {
          box-sizing: border-box !important;
          font-family: inherit;
          -webkit-box-sizing: border-box !important;
        }

        *:focus {
          outline: inherit !important;
        }

        *::-webkit-scrollbar {
          -webkit-appearance: none;
        }

        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
          padding: 0;
          margin: 0;
          font-family: inherit;
        }

        p,
        ul,
        ol {
          padding: 0;
          margin: 0;
        }

        a {
          text-decoration: none;
        }

        :host {
          font-size: 16px;
          border-bottom: var(--border-mobile);
          margin: 0;
          width: 100%;
          display: flex;
          flex-flow: column;
          gap: 10px;
          justify-content: center;
          padding: 0 0 10px;
        }

        .title {
          display: flex;
          position: relative;
          flex-flow: column;
          padding: 6px 0;
          gap: 0;
          justify-content: center;
          color: var(--text-color);
        }

        .title time {
          position: absolute;
          right: 10px;
          color: var(--gray-color);
          font-family: var(--font-mono), monospace;
          border: var(--input-border);
          padding: 2px 10px;
          border-radius: 5px;
          -webkit-border-radius: 5px;
          -moz-border-radius: 5px;
          -ms-border-radius: 5px;
          -o-border-radius: 5px;
        }

        .title > h4 {
          color: var(--text-color);
          font-size: 1.2rem;
          font-weight: 500;
          font-family: var(--font-main), sans-serif;
          margin: 0;
        }

        .title > span.desc {
          color: var(--gray-color);
          font-size: 0.85rem;
          font-family: var(--font-main), sans-serif;
        }

        .cards {
          display: flex;
          flex-flow: row;
          justify-content: space-between;
          gap: 20px;
          padding: 6px 0;
          width: 100%;
        }

        .cards > .card {
          display: flex;
          flex-flow: column;
          gap: 7px;
          padding: 8px 15px;
          min-width: 200px;
          background-color: var(--stat-background);
          justify-content: center;
          border-radius: 10px;
          -webkit-border-radius: 10px;
          -moz-border-radius: 10px;
          -ms-border-radius: 10px;
          -o-border-radius: 10px;
        }

        .cards > .card > .title {
          color: var(--text-color);
          font-size: 1rem;
          font-weight: 500;
          font-family: var(--font-main), sans-serif;
          margin: 0;
        }

        .cards > .card > .stat {
          color: var(--text-color);
          display: flex;
          flex-flow: row;
          gap: 15px;
          align-items: end;
          font-family: var(--font-main), sans-serif;
          margin: 0;
        }

        .cards > .card > .stat > h2.no {
          color: var(--text-color);
          font-size: 1.25rem;
          font-weight: 600;
          font-family: var(--font-main), sans-serif;
          margin: 0;
        }

        .cards > .card > .stat > .change {
          display: flex;
          flex-flow: row;
          gap: 2px;
          padding: 0 0 2px 0;
        }

        .cards > .card > .stat > .change.up {
          color: var(--accent-alt);
        }

        .cards > .card > .stat > .change.down {
          color: var(--error-color);
        }

        .cards > .card > .stat > .change.up .percentage {
          color: transparent;
          background: var(--accent-linear);
          background-clip: text;
          -webkit-background-clip: text;
        }

        .cards > .card > .stat > .change .percentage {
          font-size: 1rem;
          font-weight: 500;
          font-family: var(--font-main), sans-serif;
          margin: 0;
        }

        .cards > .card > .stat > .change svg {
          width: 18px;
          height: 18px;
          margin-top: 2px;
        }

        .cards > .card > .stat > .change.up > svg {
          margin: 0;
        }

        @media screen and (max-width:950px) {
          .cards > .card {
            min-width: 150px;
          }
        }


        @media screen and (max-width:800px) {
          .cards > .card {
            min-width: 120px;
          }
        }

        @media screen and (max-width:660px) {
          ::-webkit-scrollbar {
            -webkit-appearance: none;
          }

          :host {
            padding-bottom: 10px;
            border: none;
            gap: 0;
          }

          .cards {
            display: flex;
            flex-flow: column;
            justify-content: center;
            align-items: center;
            gap: 0;
            padding: 0;
            width: 100%;
          }

          .cards > .card {
            background-color: transparent;
            border-bottom: var(--border);
            display: flex;
            flex-flow: column;
            width: 100%;
            gap: 5px;
            padding: 10px 5px;
            border-radius: 0;
          }

          .cards > .card > h4.title {
            color: var(--gray-color);
            font-size: 1rem;
            font-weight: 500;
            font-family: var(--font-text), sans-serif;
            margin: 0 0 0 -2px;
          }
        }
      </style>
    `;
    }
  }

  class UsersStat extends HTMLElement {
    constructor() {
      // We are not even going to touch this.
      super();

      this._up = `
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" fill="currentColor">
        <path d="M4.53 4.75A.75.75 0 0 1 5.28 4h6.01a.75.75 0 0 1 .75.75v6.01a.75.75 0 0 1-1.5 0v-4.2l-5.26 5.261a.749.749 0 0 1-1.275-.326.749.749 0 0 1 .215-.734L9.48 5.5h-4.2a.75.75 0 0 1-.75-.75Z"></path>
      </svg>
    `;

      this._down = `
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" fill="currentColor">
        <path d="M4.22 4.179a.75.75 0 0 1 1.06 0l5.26 5.26v-4.2a.75.75 0 0 1 1.5 0v6.01a.75.75 0 0 1-.75.75H5.28a.75.75 0 0 1 0-1.5h4.2L4.22 5.24a.75.75 0 0 1 0-1.06Z"></path>
      </svg>
    `;

      // let's create our shadow root
      this.shadowObj = this.attachShadow({ mode: "open" });

      this.render();
    }

    render() {
      this.shadowObj.innerHTML = this.getTemplate();
    }

    connectedCallback() {
      
    }

    formatNumber = n => {
      if (n >= 0 && n <= 999) {
        return n.toString();
      } else if (n >= 1000 && n <= 9999) {
        const value = (n / 1000).toFixed(2);
        return `${value}k`;
      } else if (n >= 10000 && n <= 99999) {
        const value = (n / 1000).toFixed(1);
        return `${value}k`;
      } else if (n >= 100000 && n <= 999999) {
        const value = (n / 1000).toFixed(0);
        return `${value}k`;
      } else if (n >= 1000000 && n <= 9999999) {
        const value = (n / 1000000).toFixed(2);
        return `${value}M`;
      } else if (n >= 10000000 && n <= 99999999) {
        const value = (n / 1000000).toFixed(1);
        return `${value}M`;
      } else if (n >= 100000000 && n <= 999999999) {
        const value = (n / 1000000).toFixed(0);
        return `${value}M`;
      } else if (n >= 1000000000) {
        return "1B+";
      }
      else {
        return 0;
      }
    }

    calculateDifference = (last, current) => {
      // Calculate the difference between the new and old values
      const difference = current - last;

      return difference;
    }

    parseToNumber = num_str => {
      // Try parsing the string to an integer
      const num = parseInt(num_str);

      // Check if parsing was successful
      if (!isNaN(num)) {
        return num;
      } else {
        return 0;
      }
    }

     disableScroll() {
      // Get the current page scroll position
      let scrollTop = window.scrollY || document.documentElement.scrollTop;
      let scrollLeft = window.scrollX || document.documentElement.scrollLeft;
      document.body.classList.add("stop-scrolling");

      // if any scroll is attempted, set this to the previous value
      window.onscroll = function () {
        window.scrollTo(scrollLeft, scrollTop);
      };
    }

    enableScroll() {
      document.body.classList.remove("stop-scrolling");
      window.onscroll = function () { };
    }

    getTemplate() {
      // Show HTML Here
      return `
      ${this.getBody()}
      ${this.getStyles()}
    `;
    }

    getBody = () => {
      return /* html */`
      ${this.getHeader()}
      <div class="cards">
        ${this.getFollowers()}
        ${this.getSubscribers()}
        ${this.getDonations()}
      </div>
    `;
    }

    getHeader = () => {
      return /* html */`
      <div class="title">
        <h4 class="text">Account</h4>
        <span class="desc">Your account summary</span>
      </div>
    `
    }

    getFollowers = () => {
      let icon = '';
      const lastFollowers = this.parseToNumber(this.getAttribute('followers-last'));
      const currentFollowers = this.parseToNumber(this.getAttribute('followers'));

      const change = this.calculateDifference(lastFollowers, currentFollowers);

      // if change is negative, we need to make it positive
      const difference = Math.abs(change);

      // console.log(`All Percentage Change: ${change}`);
      if (change > 0) {
        icon = `
        <span class="change up">
          ${this._up}
          <span class="percentage up">${this.formatNumber(difference)}</span>
        </span>
      `;

      }
      else {
        icon = `
        <span class="change down">
          ${this._down}
          <span class="percentage up">${this.formatNumber(difference)}</span>
        </span>
      `;
      }

      return /* html */`
      <div class="card">
        <h4 class="title">Followers</h4>
        <div class="stat">
          <h2 class="no">
            ${this.formatNumber(currentFollowers)}
          </h2>
          ${icon}
        </div>
      </div>
    `
    }

    getSubscribers = () => {
      let icon = '';

      const lastSubscribers = this.parseToNumber(this.getAttribute('subscribers-last'));
      const currentSubscribers = this.parseToNumber(this.getAttribute('subscribers'));

      const change = this.calculateDifference(lastSubscribers, currentSubscribers);

      // if change is negative, we need to make it positive
      const difference = Math.abs(change);

      // console.log(`All Percentage Change: ${change}`);
      if (change > 0) {
        icon = `
        <span class="change up">
          ${this._up}
          <span class="percentage up">${this.formatNumber(difference)}</span>
        </span>
      `;

      }
      else {
        icon = `
        <span class="change down">
          ${this._down}
          <span class="percentage up">${this.formatNumber(difference)}</span>
        </span>
      `;
      }

      return /* html */`
      <div class="card">
        <h4 class="title">Subscribers</h4>
        <div class="stat">
          <h2 class="no">
            ${this.formatNumber(currentSubscribers)}
          </h2>
          ${icon}
        </div>
      </div>
    `
    }

    getDonations = () => {
      let icon = '';
      const lastDonations = this.parseToNumber(this.getAttribute('donations-last'));
      const currentDonations = this.parseToNumber(this.getAttribute('donations'));

      const change = this.calculateDifference(lastDonations, currentDonations);

      // if change is negative, we need to make it positive
      const difference = Math.abs(change);

      // console.log(`All Percentage Change: ${change}`);
      if (change > 0) {
        icon = `
        <span class="change up">
          ${this._up}
          <span class="percentage up">${this.formatNumber(difference)}</span>
        </span>
      `;

      }
      else {
        icon = `
        <span class="change down">
          ${this._down}
          <span class="percentage up">${this.formatNumber(difference)}</span>
        </span>
      `;
      }

      return /* html */`
      <div class="card">
        <h4 class="title">Donations</h4>
        <div class="stat">
          <h2 class="no">${this.getAttribute('currency')} ${this.formatNumber(currentDonations)}</h2>
          ${icon}
        </div>
      </div>
    `
    }

    getStyles() {
      return /* css */`
    <style>
      *,
      *:after,
      *:before {
        box-sizing: border-box !important;
        font-family: inherit;
        -webkit-box-sizing: border-box !important;
      }

      *:focus {
        outline: inherit !important;
      }

      *::-webkit-scrollbar {
        -webkit-appearance: none;
      }

      h1,
      h2,
      h3,
      h4,
      h5,
      h6 {
        padding: 0;
        margin: 0;
        font-family: inherit;
      }

      p,
      ul,
      ol {
        padding: 0;
        margin: 0;
      }

      a {
        text-decoration: none;
      }

      :host {
        font-size: 16px;
        border-bottom: var(--border-mobile);
        margin: 0;
        width: 100%;
        display: flex;
        flex-flow: column;
        gap: 10px;
        justify-content: center;
        padding: 0 0 10px;
      }

      .title {
        display: flex;
        position: relative;
        flex-flow: column;
        padding: 6px 0;
        gap: 0;
        justify-content: center;
        color: var(--text-color);
      }

      .title time {
        position: absolute;
        right: 10px;
        color: var(--gray-color);
        font-family: var(--font-mono), monospace;
        border: var(--input-border);
        padding: 2px 10px;
        border-radius: 5px;
        -webkit-border-radius: 5px;
        -moz-border-radius: 5px;
        -ms-border-radius: 5px;
        -o-border-radius: 5px;
      }

      .title > h4 {
        color: var(--text-color);
        font-size: 1.2rem;
        font-weight: 500;
        font-family: var(--font-main), sans-serif;
        margin: 0;
      }

      .title > span.desc {
        color: var(--gray-color);
        font-size: 0.9rem;
        font-family: var(--font-text), sans-serif;
      }

      .cards {
        display: flex;
        flex-flow: row;
        justify-content: space-between;
        gap: 20px;
        padding: 6px 0;
        width: 100%;
      }

      .cards > .card {
        /* border: thin solid #4b5563bd; */
        display: flex;
        flex-flow: column;
        gap: 10px;
        padding: 10px 25px 10px 15px;
        background-color: var(--stat-background);
        justify-content: center;
        border-radius: 10px;
        -webkit-border-radius: 10px;
        -moz-border-radius: 10px;
        -ms-border-radius: 10px;
        -o-border-radius: 10px;
      }

      .cards > .card > .title {
        color: var(--gray-color);
        font-size: 1rem;
        font-weight: 400;
        font-family: var(--font-main), sans-serif;
        margin: 0;
      }

      .cards > .card > .stat {
        /* border: thin solid #4b5563bd; */
        color: var(--text-color);
        display: flex;
        flex-flow: row;
        gap: 15px;
        /* height: 50px; */
        align-items: end;
        font-family: var(--font-main), sans-serif;
        margin: 0;
      }

      .cards > .card > .stat > h2.no {
        color: var(--text-color);
        font-size: 1.25rem;
        font-weight: 500;
        font-family: var(--font-main), sans-serif;
        margin: 0;
      }

      .cards > .card > .stat > .change {
        /* border: thin solid #4b5563bd; */
        display: flex;
        flex-flow: row;
        gap: 2px;
        padding: 0 0 2px 0;
      }

      .cards > .card > .stat > .change.up {
        color: var(--accent-alt);
      }

      .cards > .card > .stat > .change.down {
        color: var(--error-color);
      }

      .cards > .card > .stat > .change.up .percentage {
        color: transparent;
        background: var(--accent-linear);
        background-clip: text;
        -webkit-background-clip: text;
      }

      .cards > .card > .stat > .change .percentage {
        /* color: var(--text-color); */
        font-size: 1rem;
        font-weight: 400;
        font-family: var(--font-main), sans-serif;
        margin: 0;
      }

      .cards > .card > .stat > .change svg {
        width: 18px;
        height: 18px;
        margin-top: 2px;
      }

      @media screen and (max-width:600px) {
        ::-webkit-scrollbar {
          -webkit-appearance: none;
        }

        .cards {
          display: flex;
          flex-flow: column;
          justify-content: center;
          align-items: center;
          gap: 20px;
          padding: 6px 0;
          width: 100%;
        }

        .cards > .card {
          display: flex;
          flex-flow: column;
          width: 100%;
          gap: 10px;
          padding: 10px 25px 10px 15px;
        }
      }
    </style>
    `;
    }
  }

  class MonthStat extends HTMLElement {
    constructor() {
      // We are not even going to touch this.
      super();

  		this._url = this.getAttribute('url');

      // let's create our shadow root
      this.shadowObj = this.attachShadow({ mode: "open" });

      this.render();
    }

    render() {
      this.shadowObj.innerHTML = this.getTemplate();
    }

    connectedCallback() {
      // get mql
  		const mql = window.matchMedia('(min-width: 660px)');

      const contentContainer = this.shadowObj.querySelector('.stats');

  		if (contentContainer) {
  			this.fetchStat(contentContainer, mql.matches);
  		}
    }

    activateRefresh = () => {
      const mql = window.matchMedia('(min-width: 660px)');
      const finish = this.shadowObj.querySelector('.finish');
      if (finish) {
        const btn = finish.querySelector('button.finish');
        btn.addEventListener('click', () => {
          const contentContainer = this.shadowObj.querySelector('.stats');

          // set the loader
          contentContainer.innerHTML = this.getLoader();

          setTimeout(() => {
            this.fetchStat(contentContainer, mql.matches);
          }, 1000);
        });
      }
    }

    fetchStat = contentContainer => {
      const outerThis = this;
  		setTimeout(async () => {
        // fetch the user stats
        const options = {
          method: "GET",
          headers: {
            "Content-Type": "application/json",
            // set the cache control to max-age to 1 day
            "Cache-Control": "max-age=86400",
            "Accept": "application/json"
          }
        };

        try {
          // fetch 
          const result = await outerThis.getCacheData(outerThis._url, 86400, options);
    
          // if result is not successful
          if (!result.success) {
            contentContainer.innerHTML = outerThis.getWrongMessage();
            this.activateRefresh();
            return;
          }
          
          const data = result.data;
      
          if(!data) {
            // display empty message
            const content = outerThis.getEmpty();
            contentContainer.innerHTML = content;
            return;
          }
          
          // update the content
          data.all =  outerThis.calculateTotal(data.story, data.reply);

          const content = outerThis.getContent(data);
          contentContainer.innerHTML = content;

        } catch (error) {
          // console.log(error)
          contentContainer.innerHTML = outerThis.getWrongMessage();
          // activate the refresh button
          outerThis.activateRefresh();
        }
  		}, 1000);
  	}

    fetchWithTimeout = async (url, options = {}, timeout = 9500) => {
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), timeout);
    
      try {
        const response = await fetch(url, {
          ...options,
          signal: controller.signal
        });

        return response;
      } catch (error) {
        if (error.name === 'AbortError') {
          throw new Error('Request timed out');
        }
        throw new Error(`Network error: ${error.message}`);
      } finally {
        clearTimeout(timeoutId);
      }
    };

    getCacheData = async (url, maxAge, options = {}) => {
      const cacheName = "user-cache";
    
      try {
        const cache = await caches.open(cacheName);
        const cachedResponse = await cache.match(url);
    
        if (cachedResponse) {
          const cachedData = await cachedResponse.json();
          const cacheTime = cachedData.timestamp;
    
          // Check if cache is still valid
          if (Date.now() - cacheTime < maxAge) {
            return cachedData.data;
          }
        }
    
        // If cache doesn't exist or is expired, fetch new data
        const networkResponse = await this.fetchWithTimeout(url, options);
        const data = await networkResponse.clone().json();
    
        // Store the new data in cache with a timestamp
        const cacheData = {
          data: data,
          timestamp: Date.now()
        };
        
        const cacheResponse = new Response(JSON.stringify(cacheData));
        await cache.put(url, cacheResponse);
    
        return data;
      } catch (error) {
        console.error('Error fetching data:', error);
        throw error;
      }
    };

    calculateTotal = (story, reply) => {
      const data = {
        stories: {
          last: (story.replies.last + story.views.last + story.likes.last),
          current: (story.replies.current + story.views.current + story.likes.current)
        },
        replies: {
          last: (reply.replies.last + reply.views.last + reply.likes.last),
          current: (reply.replies.current + reply.views.current + reply.likes.current)
        }
      };

      data.total = {
        last: (data.stories.last + data.replies.last),
        current: (data.stories.current + data.replies.current),
      };

      return data;
    }

  	getContent = data => {
      const all = this.getAll(data.all);
      const story = this.getStories(data.story);
      const reply = this.getReplies(data.reply);

      return /* html */`
      ${all}
      ${story}
      ${reply}
    `;
    }

    getTemplate = () => {
      // Show HTML Here
      return `
      ${this.getBody()}
      ${this.getStyles()}
    `;
    }

    getLoader() {
      return /* html */`
      <div class="loader-container">
        <span id="btn-loader">
          <span class="loader-alt"></span>
        </span>
      </div>
    `
    }

    getAll = all => {
      return /* html */`
			<all-stat all="${all.total.current}" all-last="${all.total.last}" stories="${all.stories.current}" 
        stories-last="${all.stories.last}" replies="${all.replies.current}" replies-last="${all.replies.last}">
      </all-stat>
		`;
    }

    getStories = data => {
      return /* html */`
			<stories-stat views="${data.views.current}" views-last="${data.views.last}" 
        replies="${data.replies.current}" replies-last="${data.replies.last}" 
        likes="${data.likes.current}" likes-last="${data.likes.last}">
      </stories-stat>
		`
    }

    getReplies = data => {
      return /* html */`
      <replies-stat views="${data.views.current}" views-last="${data.views.last}" 
        replies="${data.replies.current}" replies-last="${data.replies.last}" 
        likes="${data.likes.current}" likes-last="${data.likes.last}">
      </replies-stat>
		`;
    }

    getBody = () => {
      // language=HTML
      return `
			<div class="stats">
				${this.getLoader()}
			</div>
    `;
    }

    getEmpty = () => {
      // get the next attribute
      return /*html*/`
    <div class="empty finish">
      <h2 class="finish__title">No stats data found!</h2>
			<p class="desc">You can try refreshing the page or check back later. If the problem persists, please contact support.</p>
    </div>
    `
    }

    getWrongMessage = () => {
      return /* html */`
      <div class="finish">
        <h2 class="finish__title">Oops!</h2>
        <p class="desc">
          An error occurred while fetching your stats. Please check your connection and try again.
        </p>
        <button class="finish">Retry</button>
      </div>
    `;
    }

    getStyles() {
      return /* css */`
	    <style>
	      *,
	      *:after,
	      *:before {
	        box-sizing: border-box !important;
	        font-family: inherit;
	        -webkit-box-sizing: border-box !important;
	      }

	      *:focus {
	        outline: inherit !important;
	      }

	      *::-webkit-scrollbar {
	        width: 3px;
	      }

	      *::-webkit-scrollbar-track {
	        background: var(--scroll-bar-background);
	      }

	      *::-webkit-scrollbar-thumb {
	        width: 3px;
	        background: var(--scroll-bar-linear);
	        border-radius: 50px;
	      }

	      h1,
	      h2,
	      h3,
	      h4,
	      h5,
	      h6 {
	        padding: 0;
	        margin: 0;
	        font-family: inherit;
	      }

	      p,
	      ul,
	      ol {
	        padding: 0;
	        margin: 0;
	      }

	      a {
	        text-decoration: none;
	      }

	      :host {
        	font-size: 16px;
				  padding: 0;
					position: relative;
				  display: flex;
				  flex-flow: column;
				  gap: 15px;
          width: 100%;
          max-width: 100%;
				}

        
        div.loader-container {
          position: relative;
          width: 100%;
          height: 150px;
          padding: 20px 0 0 0;
        }

        #btn-loader {
          position: absolute;
          top: 0;
          left: 0;
          bottom: 0;
          right: 0;
          z-index: 5;
          display: flex;
          align-items: center;
          justify-content: center;
          border-radius: inherit;
        }

        #btn-loader > .loader-alt {
          width: 35px;
          aspect-ratio: 1;
          --_g: no-repeat radial-gradient(farthest-side, #18A565 94%, #0000);
          --_g1: no-repeat radial-gradient(farthest-side, #21D029 94%, #0000);
          --_g2: no-repeat radial-gradient(farthest-side, #df791a 94%, #0000);
          --_g3: no-repeat radial-gradient(farthest-side, #f09c4e 94%, #0000);
          background:    var(--_g) 0 0,    var(--_g1) 100% 0,    var(--_g2) 100% 100%,    var(--_g3) 0 100%;
          background-size: 30% 30%;
          animation: l38 .9s infinite ease-in-out;
          -webkit-animation: l38 .9s infinite ease-in-out;
        }

        #btn-loader > .loader {
          width: 20px;
          aspect-ratio: 1;
          --_g: no-repeat radial-gradient(farthest-side, #ffffff 94%, #0000);
          --_g1: no-repeat radial-gradient(farthest-side, #ffffff 94%, #0000);
          --_g2: no-repeat radial-gradient(farthest-side, #df791a 94%, #0000);
          --_g3: no-repeat radial-gradient(farthest-side, #f09c4e 94%, #0000);
          background:    var(--_g) 0 0,    var(--_g1) 100% 0,    var(--_g2) 100% 100%,    var(--_g3) 0 100%;
          background-size: 30% 30%;
          animation: l38 .9s infinite ease-in-out;
          -webkit-animation: l38 .9s infinite ease-in-out;
        }

        @keyframes l38 {
          100% {
            background-position: 100% 0, 100% 100%, 0 100%, 0 0
          }
        }

				div.empty {
          width: 100%;
          padding: 0;
          margin: 0;
          display: flex;
          flex-flow: column;
          gap: 5px;
        }

        div.empty > p {
          width: 100%;
          padding: 0;
          margin: 0;
          color: var(--text-color);
          font-family: var(--font-text), sans-serif;
          font-size: 1rem;
          font-weight: 400;
        }

        .title {
				  padding: 2px 0 10px 5px;
          margin: 20px 0;
				  display: flex;
				  flex-flow: column;
				  gap: 0;
				}

				.title h4 {
				  color: #1f2937;
				  font-size: 1.3rem;
				  font-weight: 500;
					padding: 0;
					margin: 0;
				}

				.title > span {
				  color: var(--gray-color);
          font-family: var(--font-text);
				  font-size: 0.85rem;
				}

				.stats {
					background-color: var(--background);
					display: flex;
					flex-flow: column;
					padding:  0;
          min-height: 60vh;
					gap: 0;
					width: 100%;
          max-width: 100%;
				}

        div.finish {
          padding: 10px 0 40px;
          width: 100%;
          min-width: 100%;
          height: auto;
          display: flex;
          flex-flow: column;
          justify-content: center;
          align-items: center;
          gap: 5px;
        }

        div.empty {
          padding: 10px 0;
          width: 100%;
          min-width: 100%;
          height: auto;
          display: flex;
          flex-flow: column;
          justify-content: center;
          align-items: center;
          gap: 5px;
        }

        div.finish > h2.finish__title {
          margin: 10px 0 0 0;
          font-size: 1.15rem;
          font-weight: 500;
          font-family: var(--font-read), sans-serif;
          color: var(--text-color);
        }

        div.empty p.desc,
        div.finish > p.desc {
          margin: 0;
          font-size: 0.85rem;
          font-family: var(--font-read), sans-serif;
          color: var(--gray-color);
          line-height: 1.4;
          text-align: center;
        }

        div.finish > button.finish {
          border: none;
          background: var(--accent-linear);
          font-family: var(--font-main), sans-serif;
          text-decoration: none;
          color: var(--white-color);
          margin: 10px 0 0;
          font-size: 1rem;
          font-weight: 500;
          cursor: pointer;
          display: flex;
          width: max-content;
          flex-flow: row;
          align-items: center;
          text-transform: capitalize;
          justify-content: center;
          padding: 7px 18px 8px;
          border-radius: 50px;
          -webkit-border-radius: 50px;
          -moz-border-radius: 50px;
        }

				@media screen and (max-width:660px) {
					:host {
        		font-size: 16px;
						padding: 0;
						border-bottom: none;
					}

					.title {
						padding: 2px 0 10px 8px;
						margin: 20px 0;
						display: flex;
						flex-flow: column;
						gap: 0;
					}

					a,
          div.finish > button.finish {
            cursor: default !important;
          }
				}
	    </style>
    `;
    }
  }

  class UpdateItem extends HTMLElement {
    constructor() {
      // We are not even going to touch this.
      super();

      // let's create our shadow root
      this.shadowObj = this.attachShadow({ mode: "open" });

      this.read = this.getAttribute('read') === 'true';

      this.render();
    }

    render() {
      this.shadowObj.innerHTML = this.getTemplate();
    }

    connectedCallback() {
      // open preview & author
      this.openPreview();
      this.openAuthor();

      // send read data if not read
      if (!this.read) {
        this.sendReadData();
      }
    }

    openPreview = () => {
      // get replying-to
      const viewBtn = this.shadowObj.querySelector('.actions > .action#view-action');
      const body = document.querySelector('body');
      const hash = this.getAttribute('hash');
      const author = this.getAttribute('author');
      const url = this.getPreviewUrl(this.getAttribute('kind'), hash.toLowerCase(), author.toLowerCase());

      if (viewBtn) {
        viewBtn.addEventListener('click', event => {
          event.preventDefault();
          event.stopPropagation();
          event.stopImmediatePropagation();

          //get the preview
          let preview = this.getPreview(url);

          // open the preview
          body.insertAdjacentHTML('beforeend', preview);
        });
      }
    }

    openAuthor = () => {
      // get replying-to
      const viewBtn = this.shadowObj.querySelector('.actions > .action#author-action');
      const body = document.querySelector('body');
      const url = this.getAuthorUrl(this.getAttribute('author'));

      if (viewBtn) {
        viewBtn.addEventListener('click', event => {
          event.preventDefault();
          event.stopPropagation();
          event.stopImmediatePropagation();

          //get the preview
          let preview = this.getPreview(url);

          // open the preview
          body.insertAdjacentHTML('beforeend', preview);
        });
      }
    }

    getPreviewUrl = (kind, hash, author) => {
      if (kind === 'story') {
        return `/api/v1/p/${hash}/preview`;
      }

      if (kind === 'reply') {
        return `/api/v1/r/${hash}/preview`;
      }

      if (kind === 'user') {
        return `/api/v1/u/${author}/preview`;
      }

      if (kind === 'topic') {
        return `/api/v1/t/${hash}/preview`;
      }
    }

    getAuthorUrl = author => {
      author = author.toLowerCase();
      return `/api/v1/u/${author}/preview`;
    }

    parseToNumber = num_str => {
      // Try parsing the string to an integer
      const num = parseInt(num_str);

      // Check if parsing was successful
      if (!isNaN(num)) {
        return num;
      } else {
        return 0;
      }
    }

    sendReadData() {
      const data = {
        type: 'update',
        frontend: true,
        data: {
          id: this.parseToNumber(this.getAttribute('id')),
          kind: 'read'
        }
      };

      // send the view data
      if (window.wss) {
        window.wss.sendMessage(data);
      } else {
        console.warn('WebSocket connection not available. view information not sent.');
      }
    }

    disableScroll() {
      // Get the current page scroll position
      let scrollTop = window.scrollY || document.documentElement.scrollTop;
      let scrollLeft = window.scrollX || document.documentElement.scrollLeft;
      document.body.classList.add("stop-scrolling");

      // if any scroll is attempted, set this to the previous value
      window.onscroll = function () {
        window.scrollTo(scrollLeft, scrollTop);
      };
    }

    enableScroll() {
      document.body.classList.remove("stop-scrolling");
      window.onscroll = function () { };
    }

    // Get lapse time
    getLapseTime = isoDateStr => {
      const dateIso = new Date(isoDateStr); // ISO strings with timezone are automatically handled
      let userTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;

      // Convert posted time to the current timezone
      const date = new Date(dateIso.toLocaleString('en-US', { timeZone: userTimezone }));

      // Get the current time
      const currentTime = new Date();

      // Get the difference in time
      const timeDifference = currentTime - date;

      // Get the seconds
      const seconds = timeDifference / 1000;

      // Check if seconds is less than 60: return Just now
      if (seconds < 60) {
        return 'Just now';
      }

      // check for minutes
      if (seconds < 3600) {
        const min = Math.floor(seconds / 60);
        return `${min === 1 ? '1 min' : min + ' mins'}`;
      }

      // check for hours
      if (seconds < 86400) {
        const hours = Math.floor(seconds / 3600);
        return `${hours === 1 ? '1 hr' : hours + ' hrs'}`;
      }

      // check if seconds is less than 604800: return day and time
      if (seconds <= 604800) {
        return date.toLocaleDateString('en-US', { weekday: 'short', hour: 'numeric', minute: 'numeric', hour12: true });
      }

      // Check if the date is in the current year:: return date and month short 2-digit year without time
      if (date.getFullYear() === currentTime.getFullYear()) {
        return date.toLocaleDateString('en-US', { day: 'numeric', month: 'short', });
      }
      else {
        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
      }
    }

    getTemplate() {
      // Show HTML Here
      return `
      ${this.getBody()}
      ${this.getStyles()}
    `;
    }

    getBody = () => {
      return /* html */`
      <div class="update">
        ${this.getHeader(this.getAttribute('kind'))}
        ${this.getContent(this.innerHTML)}
        ${this.getActions()}
      </div>
    `;
    }

    getContent = content => {
      return /*html*/`
      <span class="content">
        ${content}
      </span>
    `
    }

    getActions = () => {
      const viewUrl = this.getUrl(this.getAttribute('kind'), this.getAttribute('hash'));
      const author = this.getAuthor(this.getAttribute('kind'), this.getAttribute('author'));
      return /*html*/`
      <div class="actions">
        <a href="${viewUrl}" class="action view" id="view-action">view</a>
        ${author}
        <span class="action time plain">${this.getLapseTime(this.getAttribute('time'))}</span>
      </div>
    `
    }

    getUrl = (kind, hash) => {
      hash = hash.toLowerCase();
      if (kind === 'story') {
        return `/p/${hash}`;
      }

      if (kind === 'reply') {
        return `/r/${hash}`;
      }

      if (kind === 'user') {
        return `/u/${hash}`;
      }

      if (kind === 'topic') {
        return `/t/${hash}`;
      }
    }

    getAuthor = (kind, author) => {
      author = author.toLowerCase();
      if (kind !== 'user') {
        return `
        <a href="/u/${author}" class="action author" id="author-action">user</a>
      `;
      }
      
      return '';
    }

    getHeader = (kind) => {
      const itemType = this.getAttribute('action');
      const name = `<span class="author">${this.getAttribute('author')}</span>`;
      if (itemType === 'like') {
        return /* html */`
        <div class="head">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" class="liked" fill="currentColor">
            <path d="m8 14.25.345.666a.75.75 0 0 1-.69 0l-.008-.004-.018-.01a7.152 7.152 0 0 1-.31-.17 22.055 22.055 0 0 1-3.434-2.414C2.045 10.731 0 8.35 0 5.5 0 2.836 2.086 1 4.25 1 5.797 1 7.153 1.802 8 3.02 8.847 1.802 10.203 1 11.75 1 13.914 1 16 2.836 16 5.5c0 2.85-2.045 5.231-3.885 6.818a22.066 22.066 0 0 1-3.744 2.584l-.018.01-.006.003h-.002ZM4.25 2.5c-1.336 0-2.75 1.164-2.75 3 0 2.15 1.58 4.144 3.365 5.682A20.58 20.58 0 0 0 8 13.393a20.58 20.58 0 0 0 3.135-2.211C12.92 9.644 14.5 7.65 14.5 5.5c0-1.836-1.414-3-2.75-3-1.373 0-2.609.986-3.029 2.456a.749.749 0 0 1-1.442 0C6.859 3.486 5.623 2.5 4.25 2.5Z"></path>
          </svg>
          <span class="text">${name} ${this.getAttribute('verb')} your ${kind}</span>
        </div>
      `
      }

      if (itemType === 'follow') {
        if (kind === 'topic') {
          return /* html */`
          <div class="head">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" class="at" fill="currentColor">
              <path d="M10.561 8.073a6.005 6.005 0 0 1 3.432 5.142.75.75 0 1 1-1.498.07 4.5 4.5 0 0 0-8.99 0 .75.75 0 0 1-1.498-.07 6.004 6.004 0 0 1 3.431-5.142 3.999 3.999 0 1 1 5.123 0ZM10.5 5a2.5 2.5 0 1 0-5 0 2.5 2.5 0 0 0 5 0Z"></path>
            </svg>
            <span class="text">${name} followed your topic</span>
          </div>
        `
        }
        return /* html */`
        <div class="head">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" class="at" fill="currentColor">
            <path d="M10.561 8.073a6.005 6.005 0 0 1 3.432 5.142.75.75 0 1 1-1.498.07 4.5 4.5 0 0 0-8.99 0 .75.75 0 0 1-1.498-.07 6.004 6.004 0 0 1 3.431-5.142 3.999 3.999 0 1 1 5.123 0ZM10.5 5a2.5 2.5 0 1 0-5 0 2.5 2.5 0 0 0 5 0Z"></path>
          </svg>
          <span class="text">${name} followed you</span>
        </div>
      `
      }

      if (itemType === 'subscribe') {
        return /* html */`
        <div class="head">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" class="at" fill="currentColor">
            <path d="M1.75 2h12.5c.966 0 1.75.784 1.75 1.75v8.5A1.75 1.75 0 0 1 14.25 14H1.75A1.75 1.75 0 0 1 0 12.25v-8.5C0 2.784.784 2 1.75 2ZM1.5 12.251c0 .138.112.25.25.25h12.5a.25.25 0 0 0 .25-.25V5.809L8.38 9.397a.75.75 0 0 1-.76 0L1.5 5.809v6.442Zm13-8.181v-.32a.25.25 0 0 0-.25-.25H1.75a.25.25 0 0 0-.25.25v.32L8 7.88Z"></path>
          </svg>
          <span class="text">${name} subscribed to your ${kind}</span>
        </div>
      `
      }

      if (itemType === 'reply') {
        return /* html */`
        <div class="head">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" class="reply" fill="currentColor">
            <path d="M1.75 1h8.5c.966 0 1.75.784 1.75 1.75v5.5A1.75 1.75 0 0 1 10.25 10H7.061l-2.574 2.573A1.458 1.458 0 0 1 2 11.543V10h-.25A1.75 1.75 0 0 1 0 8.25v-5.5C0 1.784.784 1 1.75 1ZM1.5 2.75v5.5c0 .138.112.25.25.25h1a.75.75 0 0 1 .75.75v2.19l2.72-2.72a.749.749 0 0 1 .53-.22h3.5a.25.25 0 0 0 .25-.25v-5.5a.25.25 0 0 0-.25-.25h-8.5a.25.25 0 0 0-.25.25Zm13 2a.25.25 0 0 0-.25-.25h-.5a.75.75 0 0 1 0-1.5h.5c.966 0 1.75.784 1.75 1.75v5.5A1.75 1.75 0 0 1 14.25 12H14v1.543a1.458 1.458 0 0 1-2.487 1.03L9.22 12.28a.749.749 0 0 1 .326-1.275.749.749 0 0 1 .734.215l2.22 2.22v-2.19a.75.75 0 0 1 .75-.75h1a.25.25 0 0 0 .25-.25Z"></path>
          </svg>
          <span class="text">${name} ${this.getAttribute('verb')} to your ${kind}</span>
        </div>
      `
      }

      if (itemType === 'vote') {
        return /* html */`
        <div class="head">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" class="reply" fill="currentColor">
            <path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm1.5 0a6.5 6.5 0 1 0 13 0 6.5 6.5 0 0 0-13 0Zm10.28-1.72-4.5 4.5a.75.75 0 0 1-1.06 0l-2-2a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018l1.47 1.47 3.97-3.97a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042Z"></path>
          </svg>
          <span class="text">${name} voted on your ${kind}</span>
        </div>
      `
      }
      
      return /* html */`
      <div class="head">
        <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16" width="16" height="16">
          <path d="M11.93 8.5a4.002 4.002 0 0 1-7.86 0H.75a.75.75 0 0 1 0-1.5h3.32a4.002 4.002 0 0 1 7.86 0h3.32a.75.75 0 0 1 0 1.5Zm-1.43-.75a2.5 2.5 0 1 0-5 0 2.5 2.5 0 0 0 5 0Z"></path>
        </svg>
        <span class="text">${name} ${this.getAttribute('verb')} your ${kind}</span>
      </div>
    `
    }

    getPreview = url => {
      return /*html*/`
      <preview-popup url="${url}"></preview-popup> 
    `
    }

    getStyles() {
      return /* css */`
      <style>
        *,
        *:after,
        *:before {
          box-sizing: border-box !important;
          font-family: inherit;
          -webkit-box-sizing: border-box !important;
        }

        *:focus {
          outline: inherit !important;
        }

        *::-webkit-scrollbar {
          -webkit-appearance: none;
        }

        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
          padding: 0;
          margin: 0;
          font-family: inherit;
        }

        p,
        ul,
        ol {
          padding: 0;
          margin: 0;
        }

        a {
          text-decoration: none;
        }

        :host {
          font-size: 16px;
          display: flex;
          flex-flow: column;
          gap: 0;
          padding: 0;
          width: 100%;
        }

        .update {
          display: flex;
          border-bottom: var(--border);
          flex-flow: column;
          gap: 5px;
          padding: 15px 0;
          width: 100%;
        }

        .head {
          color: var(--text-color);
          display: flex;
          align-items: center;
          gap: 5px;
          padding: 0;
          width: 100%;
        }

        .head svg {
          width: 15px;
          height: 15px;
          color: var(--gray-color);
          margin: 0 0 -1px 0;
        }

        .head svg.at {
          width: 14px;
          height: 14px;
          color: var(--gray-color);
          margin: 0 0 0 0;
        }

        .head svg.saved {
          width: 13px;
          height: 13px;
          color: var(--gray-color);
          margin: -2px 0 0 0;
        }

        .head svg.reply,
        .head svg.liked {
          width: 13px;
          height: 13px;
          color: var(--gray-color);
          margin: 0 0 0;
        }

        .head > span.text {
          color: var(--gray-color);
          font-size: 0.9rem;
          font-family: var(--font-read), sans-serif;
        }

        .head span.author {
          color: var(--gray-color);
          font-size: 0.8rem;
          font-family: var(--font-mono), monospace;
        }

        .content {
          color: var(--text-color);
          font-family: var(--font-text), sans-serif;
          display: flex;
          flex-flow: column;
          font-size: 1rem;
          gap: 5px;
          padding: 0;
          width: 100%;
        }

        .content h4 {
          color: var(--title-color);
          font-weight: 500;
          font-size: 1.1rem;
          font-family: var(--font-text), sans-serif;
        }

        .foot {
          display: flex;
          flex-flow: row;
          color: var(--text-color);
          align-items: center;
          gap: 5px;
          width: 100%;
          padding: 0;
          font-size: 1rem;
          font-family: var(--font-text), sans-serif;
        }

        .foot span.by {
          font-size: 0.85rem;
          font-family: var(--font-mono), monospace;
          display: flex;
          align-items: center;
          color: var(--gray-color);
          font-weight: 500;
          gap: 3px;
        }
        
        .actions {
          display: flex;
          font-family: var(--font-main), sans-serif;
          width: 100%;
          flex-flow: row;
          align-items: center;
          gap: 15px;
          margin: 5px 0 0 0;
        }
        
        .actions > .action {
          border: var(--border-button);
          text-decoration: none;
          color: var(--gray-color);
          font-size: 0.9rem;
          display: flex;
          width: max-content;
          flex-flow: row;
          align-items: center;
          justify-content: center;
          padding: 1.5px 10px 2.5px;
          border-radius: 10px;
        }

        .actions > .action.author,
        .actions > .action.edit {
          border: none;
          background: var(--gray-background);
          color: var(--text-color);
          padding: 2.5px 10px 3.5px;
          font-size: 0.9rem;
        }

        .actions > .action.plain {
          padding: 0;
          pointer-events: none;
          font-family: var(--font-main), sans-serif;
          color: var(--gray-color);
          font-size: 0.95rem;
          border: none;
          background: none;
        }

        .actions > .action.plain > span.text {
          display: inline-block;
          padding: 0 0 0 3px;
        }

        @media screen and (max-width:660px) {
          ::-webkit-scrollbar {
            -webkit-appearance: none;
          }

          a,
          .actions > .action {
            cursor: default !important;
          }
        }
      </style>
    `;
    }
  }

  class ContentStory extends HTMLElement {
    constructor() {
      // We are not even going to touch this.
      super();

      // let's create our shadow root
      this.shadowObj = this.attachShadow({ mode: "open" });

      this.render();
    }

    // observe the attributes
    static get observedAttributes() {
      return ['reload', 'images'];
    }

    // listen for changes in the attributes
    attributeChangedCallback(name, oldValue, newValue) {
      // check if old value is not equal to new value
      if (name === 'reload') {
        this.render();
      } else if (name === 'images') {
        this.addOrEditImages(newValue);
      }
    }

    addOrEditImages = images => {
      const imageWrapper = this.shadowObj.querySelector('images-wrapper');
      const content = this.shadowObj.querySelector('.content');
      // if images is null , empty or is 'null': remove the images
      if (!images || images === 'null' || images === '') {
        if (imageWrapper) imageWrapper.remove();
        return;
      }

      // if images is not null, empty or is not 'null': add the images
      if (!imageWrapper && content) {
        content.insertAdjacentHTML('afterend', `<images-wrapper images="${images}"></images-wrapper>`);
      } else {
        imageWrapper.setAttribute('images', images);
      }
    }

    render() {
      this.shadowObj.innerHTML = this.getTemplate();
      // open post 
      this.openPost();

      // activate edit button
      this.activateEditButton();

      // style last block
      this.styleLastBlock();

      // open read more
      this.openReadMore();

      // open url
      this.openUrl();
    }

    connectedCallback() {
    }

    disableScroll() {
      // Get the current page scroll position
      let scrollTop = window.scrollY || document.documentElement.scrollTop;
      let scrollLeft = window.scrollX || document.documentElement.scrollLeft;
      document.body.classList.add("stop-scrolling");

      // if any scroll is attempted, set this to the previous value
      window.onscroll = function () {
        window.scrollTo(scrollLeft, scrollTop);
      };
    }

    enableScroll() {
      document.body.classList.remove("stop-scrolling");
      window.onscroll = function () { };
    }

    openPost = () => {
      // get url
      let url = this.getAttribute('url');

      url = url.trim().toLowerCase();

      // Get the body
      const body = document.querySelector('body');

      // get current content
      const content = this.shadowObj.querySelector('.actions>.action#view-action');

      if(body && content) {
        content.addEventListener('click', event => {
          event.preventDefault();
          event.stopPropagation();
          event.stopImmediatePropagation();

          // Get full post
          const post =  this.getFullPost(this.getAttribute('kind'));

          // replace and push states
          this.replaceAndPushStates(url, body, post);

          body.innerHTML = post;
        });
      }
    }

    activateEditButton = () => {
      // Get the body element
      const body = document.querySelector('body');
      // Get the edit button
      const editButton = this.shadowObj.querySelector('.actions>.action#edit-action');
      if(!editButton) return;
      // Add an event listener to the post button
      editButton.addEventListener('click', e => {
        e.preventDefault();
        // Get the content of the topic page
        const content = this.getEdit();

        // set to be deleted:
        window.toBeChanged = this;

        // insert the content into the body
        body.insertAdjacentHTML('beforeend', content);
      });
    }

    getEdit = () => {
      const drafted = this.getAttribute('published').trim() === 'false' ? 'true' : 'false';
      // Show Post Page Here
      return /* html */`
      <post-options kind="${this.getAttribute('kind')}" url="${this.getAttribute('url')}" hash="${this.getAttribute('hash')}" images="${this.getAttribute('images')}" published="${this.getAttribute('published')}"
        drafted="${drafted}" story="true" story-title="${this.getAttribute('story-title')}" slug="${this.getAttribute('slug')}">
        ${this.innerHTML}
      </post-options>
    `;
    }

    replaceAndPushStates = (url, body, post) => {
      // get the first custom element in the body
      const firstElement = body.firstElementChild;

      // convert the custom element to a string
       const elementString = firstElement.outerHTML;

      // get window location
      const pageUrl = window.location.href;
      window.history.replaceState(
        { page: 'page', content: elementString },
        url, pageUrl
      );

      // Updating History State
      window.history.pushState(
        { page: 'page', content: post},
        url, url
      );
    }

    formatNumber = n => {
      if (n >= 0 && n <= 999) {
        return n.toString();
      } else if (n >= 1000 && n <= 9999) {
        const value = (n / 1000).toFixed(2);
        return `${value}k`;
      } else if (n >= 10000 && n <= 99999) {
        const value = (n / 1000).toFixed(1);
        return `${value}k`;
      } else if (n >= 100000 && n <= 999999) {
        const value = (n / 1000).toFixed(0);
        return `${value}k`;
      } else if (n >= 1000000 && n <= 9999999) {
        const value = (n / 1000000).toFixed(2);
        return `${value}M`;
      } else if (n >= 10000000 && n <= 99999999) {
        const value = (n / 1000000).toFixed(1);
        return `${value}M`;
      } else if (n >= 100000000 && n <= 999999999) {
        const value = (n / 1000000).toFixed(0);
        return `${value}M`;
      } else if (n >= 1000000000) {
        return "1B+";
      }
      else {
        return 0;
      }
    }

    parseToNumber = num_str => {
      // Try parsing the string to an integer
      const num = parseInt(num_str);

      // Check if parsing was successful
      if (!isNaN(num)) {
        return num;
      } else {
        return 0;
      }
    }

    getTemplate() {
      // Show HTML Here
      return `
      ${this.getBody()}
      ${this.getStyles()}
    `;
    }

    getBody = () => {
      const likes = this.parseToNumber(this.getAttribute('likes'));
      const views = this.parseToNumber(this.getAttribute('views'));
      return /* html */`
      ${this.getContent(this.getAttribute('kind'))}
      ${this.getActions(likes, views)}
    `;
    }

    getContent = story => {
      if (story === 'poll') {
        return this.getPoll();
      } else if (story === 'post') {
        return this.getPost();
      } else if (story === 'story') {
        return this.getStory();
      }
    }

    getPoll = () =>  {
      const mql = window.matchMedia('(max-width: 660px)');
      // Remove html tags
      const contentStr = this.innerHTML.replace(/<[^>]*>/g, '');
      const contentLength = contentStr.length;

      let chars = 250;

      // Check if its a mobile view
      if (mql.matches) {
        chars = 200;
      }

      // Check if content length is greater than :chars
      if (contentLength > chars) {
        return /*html*/`
        <div class="content extra ${chars <= 200 ? 'mobile' : ''}" id="content">
          ${this.innerHTML}
          <div class="read-more">
            <span class="action">view more</span>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" fill="currentColor">
              <path d="M12.78 5.22a.749.749 0 0 1 0 1.06l-4.25 4.25a.749.749 0 0 1-1.06 0L3.22 6.28a.749.749 0 1 1 1.06-1.06L8 8.939l3.72-3.719a.749.749 0 0 1 1.06 0Z"></path>
            </svg>
          </div>
        </div>
        ${this.getVotesWrapper()}
      `
      }
      else {
        return /*html*/`
        <div class="content" id="content">
          ${this.innerHTML}
        </div>
        ${this.getVotesWrapper()}
      `
      }
    }

    getVotesWrapper = () => {
      return /*html*/`
      <votes-wrapper reload="false" votes="${this.getAttribute('votes')}" selected="${this.getAttribute('selected')}"
        hash="${this.getAttribute('hash')}" end-time="${this.getAttribute('end-time')}" voted="${this.getAttribute('voted')}"
        options="${this.getAttribute('options')}">
      </votes-wrapper>
    `
    }

    getStory = () => {
      let images = this.getAttribute('images');
      images = images  && images !== 'null' ? images.split(',') : [];
      let str = this.getHTML();
      let title = this.getAttribute('story-title');
      str = str.replace(/<[^>]*>/g, '');

      str = str.trim();
      const filteredTitle = title && title !== 'null' ? `<h3 class="story-title">${title}</h3>` : '';
      const content = `<p>${this.trimContent(str)}</p>`;

      return /*html*/`
      <div class="content" id="content">
        ${filteredTitle}
        ${content}
      </div>
      ${this.getImages(images)}
    `
    }

    getHTML = () => {
      const text = this.innerHTML;
      const parser = new DOMParser();
      const doc = parser.parseFromString(text, 'text/html');
      return doc.body.innerHTML;
    }

    trimContent = text => {
      // if text is less than 150 characters
      if (text.length <= 200) return text;

      // check for mobile view
      const mql = window.matchMedia('(max-width: 660px)');

      // Check if its a mobile view
      if (mql.matches) {
        // return text substring: 150 characters + ...
        return text.substring(0, 200) + '...';
      } else {
        // trim the text to 250 characters
        return text.substring(0, 300) + '...';
      }
    }

    getPost = () => {
      const mql = window.matchMedia('(max-width: 660px)');
      let images = this.getAttribute('images');
      images = images  && images !== 'null' ? images.split(',') : [];
      // Remove html tags
      const contentStr = this.innerHTML.replace(/<[^>]*>/g, '');
      const contentLength = contentStr.length;

      let chars = 250;

      // Check if its a mobile view
      if (mql.matches) {
        chars = 200;
      }

      // Check if content length is greater than: chars
      if (contentLength > chars) {
        return /*html*/`
        <div class="content extra ${chars <= 200 ? 'feed' : ''}" id="content">
          ${this.innerHTML}
          <div class="read-more">
            <span class="action">view more</span>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" fill="currentColor">
              <path d="M12.78 5.22a.749.749 0 0 1 0 1.06l-4.25 4.25a.749.749 0 0 1-1.06 0L3.22 6.28a.749.749 0 1 1 1.06-1.06L8 8.939l3.72-3.719a.749.749 0 0 1 1.06 0Z"></path>
            </svg>
          </div>
        </div>
        ${this.getImages(images)}
      `
      }
      else {
        return /*html*/`
        <div class="content" id="content">
          ${this.innerHTML}
        </div>
        ${this.getImages(images)}
      `
      }
    }

    getImages = imageArray => {
      // if length is greater is less than 1
      if(!imageArray || imageArray.length < 1) return '';

      // return
      return /* html */`
      <images-wrapper images="${imageArray.join(',')}"></images-wrapper>
    `
    }

    styleLastBlock = () => {
      const content = this.shadowObj.querySelector('.content#content');
      if (!content) return;

      const lastBlock = content.lastElementChild;
      if (!lastBlock) return;

      // style the last block
      lastBlock.style.setProperty('padding', '0 0 0');
      lastBlock.style.setProperty('margin', '0 0 0');
    }

    openReadMore = () => {
      // Get the read more button
      const readMore = this.shadowObj.querySelector('.content .read-more');

      // Get the content
      const content = this.shadowObj.querySelector('.content');

      // Check if the read more button exists
      if (readMore && content) {
        readMore.addEventListener('click', e => {
          // prevent the default action
          e.preventDefault();

          // prevent the propagation of the event
          e.stopPropagation();

          // Prevent event from reaching any immediate nodes.
          e.stopImmediatePropagation();

          // Toggle the active class
          content.classList.remove('extra');

          // remove the read more button
          readMore.remove();
        });
      }
    }

    openUrl = () => {
      // get all the links
      const links = this.shadowObj.querySelectorAll('div#content a');
      const body = document.querySelector('body');

      // loop through the links
      if (!links) return;

      links.forEach(link => {
        // add event listener to the link
        link.addEventListener('click', event => {
          event.preventDefault();
          event.stopPropagation();
          event.stopImmediatePropagation();
          // get the url
          const url = link.getAttribute('href');

          // link pop up
          let linkPopUp = `<url-popup url="${url}"></url-popup>`;

          // open the popup
          body.insertAdjacentHTML('beforeend', linkPopUp);
        });
      });
    }

    getActions = (likes, views) => {
      const viewUrl = this.getAttribute('url');
      const editUrl = viewUrl + '/edit';
      return /*html*/`
      <div class="actions">
        ${this.checkPublished(this.getAttribute('published'), viewUrl, editUrl, likes, views)}
      </div>
    `
    }

    checkPublished = (published, url, editUrl, likes, views) => {
      if(published === 'true') {
        return /*html*/`
        <a href="${editUrl}" class="action edit" id="edit-action">edit</a>
        <a href="${url}" class="action view" id="view-action">view</a>
        <span class="action likes plain">
          <span class="no">${this.formatNumber(likes)}</span> <span class="text">${likes === 1 ? 'like' : 'likes'}</span>
        </span>
        <span class="action views plain">
          <span class="no">${this.formatNumber(views)}</span> <span class="text">${views === 1 ? 'view' : 'views'}</span>
        </span>
      `
      }
      else {
        return /*html*/`
        <a href="${editUrl}" class="action edit" id="edit-action">edit</a>
        <span class="action draft plain">Drafted</span>
      `
      }
    }

    getFullPost = kind => {
      const parent = this.getAttribute('parent');
      let text = parent ? `parent="${parent}"` : '';
      const images = this.getAttribute('images');
      if (kind === "poll") {
        return /* html */`
        <app-post story="poll" tab="replies" url="${this.getAttribute('url')}" hash="${this.getAttribute('hash')}"
          likes="${this.getAttribute('likes')}" replies="${this.getAttribute('replies')}"
          replies-url="${this.getAttribute('replies-url')}" likes-url="${this.getAttribute('likes-url')}"
          options='${this.getAttribute("options")}' voted="${this.getAttribute('voted')}" selected="${this.getAttribute('selected')}"
          end-time="${this.getAttribute('end-time')}" votes="${this.getAttribute('votes')}" author-contact='${this.getAttribute("author-contact")}'
          liked="${this.getAttribute('liked')}" views="${this.getAttribute('views')}" time="${this.getAttribute('time')}"
          author-you="${this.getAttribute('author-you')}" author-stories="${this.getAttribute('author-stories')}" author-replies="${this.getAttribute('author-replies')}"
          author-hash="${this.getAttribute('author-hash')}" author-url="${this.getAttribute('author-url')}"
          author-img="${this.getAttribute('author-img')}" author-verified="${this.getAttribute('author-verified')}" author-name="${this.getAttribute('author-name')}"
          author-followers="${this.getAttribute('author-followers')}" author-following="${this.getAttribute('author-following')}" author-follow="${this.getAttribute('author-follow')}"
          author-bio="${this.getAttribute('author-bio')}">
          ${this.innerHTML}
        </app-post>
      `
      } else if(kind === "post"){
        return /* html */`
        <app-post story="quick" tab="replies" url="${this.getAttribute('url')}" hash="${this.getAttribute('hash')}"
          likes="${this.getAttribute('likes')}" replies="${this.getAttribute('replies')}" ${text} images='${images}'
          replies-url="${this.getAttribute('replies-url')}" likes-url="${this.getAttribute('likes-url')}"
          liked="${this.getAttribute('liked')}" views="${this.getAttribute('views')}" time="${this.getAttribute('time')}"
          author-stories="${this.getAttribute('author-stories')}" author-replies="${this.getAttribute('author-replies')}" author-contact='${this.getAttribute("author-contact")}'
          author-you="${this.getAttribute('author-you')}" author-hash="${this.getAttribute('author-hash')}" author-url="${this.getAttribute('author-url')}"
          author-img="${this.getAttribute('author-img')}" author-verified="${this.getAttribute('author-verified')}" author-name="${this.getAttribute('author-name')}"
          author-followers="${this.getAttribute('author-followers')}" author-following="${this.getAttribute('author-following')}" author-follow="${this.getAttribute('author-follow')}"
          author-bio="${this.getAttribute('author-bio')}">
          ${this.innerHTML}
        </app-post>
      `
      } else if(kind === "story"){
        return /* html */`
        <app-story  story="story" tab="replies" hash="${this.getAttribute('hash')}"  url="${this.getAttribute('url')}" topics="${this.getAttribute('topics')}" 
          story-title="${this.getAttribute('story-title')}" time="${this.getAttribute('time')}"
          replies-url="${this.getAttribute('replies-url')}" likes-url="${this.getAttribute('likes-url')}"
          likes="${this.getAttribute('likes')}" replies="${this.getAttribute('replies')}" liked="${this.getAttribute('liked')}" views="${this.getAttribute('views')}"
          author-you="${this.getAttribute('author-you')}" images='${images}'
          author-stories="${this.getAttribute('author-stories')}" author-replies="${this.getAttribute('author-replies')}"
          author-hash="${this.getAttribute('author-hash')}" author-url="${this.getAttribute('author-url')}" author-contact='${this.getAttribute("author-contact")}'
          author-img="${this.getAttribute('author-img')}" author-verified="${this.getAttribute('author-verified')}" author-name="${this.getAttribute('author-name')}"
          author-followers="${this.getAttribute('author-followers')}" author-following="${this.getAttribute('author-following')}" author-follow="${this.getAttribute('author-follow')}"
          author-bio="${this.getAttribute('author-bio')}">
          ${this.innerHTML}
        </app-story>
      `
      }
    }

    getStyles() {
      return /* css */`
      <style>
        *,
        *:after,
        *:before {
          box-sizing: border-box !important;
          font-family: inherit;
          -webkit-box-sizing: border-box !important;
        }

        *:focus {
          outline: inherit !important;
        }

        *::-webkit-scrollbar {
          -webkit-appearance: none;
        }

        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
          padding: 0;
          margin: 0;
          font-family: inherit;
        }

        p,
        ul,
        ol {
          padding: 0;
          margin: 0;
        }

        a {
          text-decoration: none;
        }

        :host {
          font-size: 16px;
          display: flex;
          flex-flow: column;
          gap: 5px;
          padding: 10px 0;
          border-bottom: var(--border);
          width: 100%;
        }

        .content {
          width: 100%;
          display: flex;
          flex-flow: column;
          color: var(--text-color);
          font-family: var(--font-main), sans-serif;
          line-height: 1.4;
          gap: 0;
          margin: 0;
          padding: 0;
        }

        .content.extra {
          max-height: 200px;
          overflow: hidden;
          position: relative;
        }

        .content.extra.feed {
          max-height: 150px;
        }

        .content.extra .read-more {
          position: absolute;
          bottom: -5px;
          right: 0;
          left: 0;
          width: 100%;
          padding: 5px 0;
          display: flex;
          align-items: end;
          justify-content: center;
          min-height: 80px;
          gap: 3px;
          cursor: pointer;
          font-weight: 500;
          font-family: var(--font-main), sans-serif;
          color: var(--gray-color);
          background: var(--fade-linear-gradient);
        }

        .content.extra .read-more svg {
          display: inline-block;
          width: 16px;
          height: 16px;
          margin: 0 0 2px 0;
        }

        .content h6,
        .content h5,
        .content h4,
        .content h3,
        .content h1 {
          padding: 0;
          font-size: 1.2rem !important;
          color: var(--title-color);
          font-weight: 500;
          line-height: 1.5;
          margin: 5px 0;
        }

        .content p {
          font-size: 1rem;
          margin: 0 0 5px;
          line-height: 1.4;
        }

        .content a {
          text-decoration: none;
          cursor: pointer;
          color: var(--anchor-color) !important;
        }

        .content a:hover {
          text-decoration: underline;
        }

        .content blockquote {
          margin: 2px 0;
          padding: 5px 0;
          font-style: italic;
          background: var(--background);
          color: var(--text-color);
          font-weight: 400;
          line-height: 1.4;
        }

        .content blockquote p {
          margin: 0;
        }

        .content blockquote * {
          margin: 0;
        }

        .content hr {
          border: none;
          background-color: var(--text-color);
          height: 1px;
          margin: 10px 0;
        }

        .content code {
          background: var(--gray-background);
          padding: 0 5px;
          font-family: var(--font-mono);
          font-size: 0.9rem;
          border-radius: 5px;
        }

        .content b,
        .content strong {
          font-weight: 700;
          line-height: 1.4;

        }

        .content ul,
        .content ol {
          margin: 5px 0 15px 20px;
          padding: 0 0 0 15px;
          color: inherit;
          line-height: 1.4;
        }

        .content ul li,
        .content ol li {
          margin: 6px 0;
          padding: 0;
          color: inherit;
        }

        .content > h3.story-title {
          margin: 0;
          color: var(--text-color);
          font-family: var(--font-main), sans-serif;
          line-height: 1.5;
          font-size: 1.15rem;
          font-weight: 500;
        }

        .actions {
          display: flex;
          font-family: var(--font-main), sans-serif;
          width: 100%;
          flex-flow: row;
          align-items: center;
          gap: 15px;
          margin: 5px 0 0 0;
        }
        
        .actions > .action {
          border: var(--border-button);
          text-decoration: none;
          color: var(--gray-color);
          font-size: 0.9rem;
          display: flex;
          width: max-content;
          flex-flow: row;
          align-items: center;
          text-transform: lowercase;
          justify-content: center;
          padding: 1.5px 10px 2.5px;
          border-radius: 10px;
        }

        .actions > .action.edit {
          border: none;
          background: var(--gray-background);
          color: var(--text-color);
          font-size: 0.9rem;
          padding: 2.5px 12px 3.5px;
        }

        .actions > .action.publish {
          text-transform: capitalize;
          padding: 2.5px 10px 3.5px;
        }

        .actions > .action.plain {
          padding: 0;
          font-weight: 500;
          pointer-events: none;
          font-family: var(--font-text), sans-serif;
          color: var(--gray-color);
          border: none;
          background: none;
          padding: 2.5px 0 3.5px 0;
        }

        .actions > .action.plain.draft {
          text-transform: capitalize;
          font-family: var(--font-main), sans-serif;
          font-size: 0.9rem;
          font-weight: 500;
          color: var(--text-color);
          padding: 2.5px 0 3.5px 0;
        }
        
        .actions > .action.plain > span.no {
          font-family: var(--font-main), sans-serif;
          font-size: 0.85rem;
          color: var(--text-color);
        }

        .actions > .action.plain > span.text {
          display: inline-block;
          padding: 0 0 0 3px;
        }

        @media screen and (max-width:660px) {
          ::-webkit-scrollbar {
            -webkit-appearance: none;
          }

          .actions {
            width: 100%;
          }

          .actions > .action.plain > span.no {
            font-family: var(--font-main), sans-serif;
            font-size: 0.8rem;
            color: var(--text-color);
          }

          button.fetch,
          .content.extra .read-more,
          .actions > .action.close,
          a {
            cursor: default !important;
          }
        }
      </style>
    `;
    }
  }

  class ContentReply extends HTMLElement {
    constructor() {
      // We are not even going to touch this.
      super();

      // let's create our shadow root
      this.shadowObj = this.attachShadow({ mode: "open" });

      this.render();
    }

    // observe the attributes
    static get observedAttributes() {
      return ['reload', 'images'];
    }

    // listen for changes in the attributes
    attributeChangedCallback(name, oldValue, newValue) {
      // check if old value is not equal to new value
      if (name === 'reload') {
        this.render();
      } else if (name === 'images') {
        this.addOrEditImages(newValue);
      }
    }

    addOrEditImages = images => {
      const imageWrapper = this.shadowObj.querySelector('images-wrapper');
      const content = this.shadowObj.querySelector('.content');
      // if images is null , empty or is 'null': remove the images
      if (!images || images === 'null' || images === '') {
        if (imageWrapper) imageWrapper.remove();
        return;
      }

      // if images is not null, empty or is not 'null': add the images
      if (!imageWrapper && content) {
        content.insertAdjacentHTML('afterend', `<images-wrapper images="${images}"></images-wrapper>`);
      } else {
        imageWrapper.setAttribute('images', images);
      }
    }

    render() {
      this.shadowObj.innerHTML = this.getTemplate();
      // open post
      this.openPost();

      // activate edit button
      this.activateEditButton();

      // style last block
      this.styleLastBlock();

      // open read more
      this.openReadMore();

      // open url
      this.openUrl();
    }

    connectedCallback() {
    }

    disableScroll() {
      // Get the current page scroll position
      let scrollTop = window.scrollY || document.documentElement.scrollTop;
      let scrollLeft = window.scrollX || document.documentElement.scrollLeft;
      document.body.classList.add("stop-scrolling");

      // if any scroll is attempted, set this to the previous value
      window.onscroll = function () {
        window.scrollTo(scrollLeft, scrollTop);
      };
    }

    enableScroll() {
      document.body.classList.remove("stop-scrolling");
      window.onscroll = function () { };
    }

    openPost = () => {
      // get url
      let url = this.getAttribute('url');

      url = url.trim().toLowerCase();

      // Get the body
      const body = document.querySelector('body');

      // get current content
      const content = this.shadowObj.querySelector('.actions>.action#view-action');

      if(body && content) {
        content.addEventListener('click', event => {
          event.preventDefault();
          event.stopPropagation();
          event.stopImmediatePropagation();

          // Get full post
          const post =  this.getFullPost();

          // replace and push states
          this.replaceAndPushStates(url, body, post);

          body.innerHTML = post;
        });
      }
    }

    replaceAndPushStates = (url, body, post) => {
      // get the first custom element in the body
      const firstElement = body.firstElementChild;

      // convert the custom element to a string
       const elementString = firstElement.outerHTML;

      // get window location
      const pageUrl = window.location.href;
      window.history.replaceState(
        { page: 'page', content: elementString },
        url, pageUrl
      );

      // Updating History State
      window.history.pushState(
        { page: 'page', content: post},
        url, url
      );
    }

    activateEditButton = () => {
      // Get the body element
      const body = document.querySelector('body');
      // Get the edit button
      const editButton = this.shadowObj.querySelector('.actions>.action#edit-action');
      if(!editButton) return;
      // Add an event listener to the post button
      editButton.addEventListener('click', e => {
        e.preventDefault();
        // Get the content of the topic page
        const content = this.getEdit();

        // set to be deleted:
        window.toBeChanged = this;

        // insert the content into the body
        body.insertAdjacentHTML('beforeend', content);
      });
    }

    getEdit = () => {
      // Show Post Page Here
      return /* html */`
      <post-options kind="reply" url="${this.getAttribute('url')}" hash="${this.getAttribute('hash')}"
        drafted="false" story="false" images="${this.getAttribute('images')}">
        ${this.innerHTML}
      </post-options>
    `;
    }

    formatNumber = n => {
      if (n >= 0 && n <= 999) {
        return n.toString();
      } else if (n >= 1000 && n <= 9999) {
        const value = (n / 1000).toFixed(2);
        return `${value}k`;
      } else if (n >= 10000 && n <= 99999) {
        const value = (n / 1000).toFixed(1);
        return `${value}k`;
      } else if (n >= 100000 && n <= 999999) {
        const value = (n / 1000).toFixed(0);
        return `${value}k`;
      } else if (n >= 1000000 && n <= 9999999) {
        const value = (n / 1000000).toFixed(2);
        return `${value}M`;
      } else if (n >= 10000000 && n <= 99999999) {
        const value = (n / 1000000).toFixed(1);
        return `${value}M`;
      } else if (n >= 100000000 && n <= 999999999) {
        const value = (n / 1000000).toFixed(0);
        return `${value}M`;
      } else if (n >= 1000000000) {
        return "1B+";
      }
      else {
        return 0;
      }
    }

    parseToNumber = num_str => {
      // Try parsing the string to an integer
      const num = parseInt(num_str);

      // Check if parsing was successful
      if (!isNaN(num)) {
        return num;
      } else {
        return 0;
      }
    }

    getTemplate() {
      // Show HTML Here
      return `
      ${this.getBody()}
      ${this.getStyles()}
    `;
    }

    getBody = () => {
      const likes = this.parseToNumber(this.getAttribute('likes'));
      const views = this.parseToNumber(this.getAttribute('views'));
      return /* html */`
      ${this.getPost()}
      ${this.getActions(likes, views)}
    `;
    }

    getPost = () => {
      const mql = window.matchMedia('(max-width: 660px)');
      let images = this.getAttribute('images');
      images = images  && images !== 'null' ? images.split(',') : [];
      // Remove html tags
      const contentStr = this.innerHTML.replace(/<[^>]*>/g, '');
      const contentLength = contentStr.length;

      let chars = 250;

      // Check if its a mobile view
      if (mql.matches) {
        chars = 200;
      }

      // Check if content length is greater than: chars
      if (contentLength > chars) {
        return /*html*/`
        <div class="content extra ${chars <= 200 ? 'feed' : ''}" id="content">
          ${this.innerHTML}
          <div class="read-more">
            <span class="action">view more</span>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" fill="currentColor">
              <path d="M12.78 5.22a.749.749 0 0 1 0 1.06l-4.25 4.25a.749.749 0 0 1-1.06 0L3.22 6.28a.749.749 0 1 1 1.06-1.06L8 8.939l3.72-3.719a.749.749 0 0 1 1.06 0Z"></path>
            </svg>
          </div>
        </div>
        ${this.getImages(images)}
      `
      }
      else {
        return /*html*/`
        <div class="content" id="content">
          ${this.innerHTML}
        </div>
        ${this.getImages(images)}
      `
      }
    }

    getImages = imageArray => {
      // if length is greater is less than 1
      if(!imageArray || imageArray.length < 1) return '';

      // return
      return /* html */`
      <images-wrapper images="${imageArray.join(',')}"></images-wrapper>
    `
    }

    styleLastBlock = () => {
      const content = this.shadowObj.querySelector('.content#content');
      if (!content) return;

      const lastBlock = content.lastElementChild;
      if (!lastBlock) return;

      // style the last block
      lastBlock.style.setProperty('padding', '0 0 0');
      lastBlock.style.setProperty('margin', '0 0 0');
    }

    openReadMore = () => {
      // Get the read more button
      const readMore = this.shadowObj.querySelector('.content .read-more');

      // Get the content
      const content = this.shadowObj.querySelector('.content');

      // Check if the read more button exists
      if (readMore && content) {
        readMore.addEventListener('click', e => {
          // prevent the default action
          e.preventDefault();

          // prevent the propagation of the event
          e.stopPropagation();

          // Prevent event from reaching any immediate nodes.
          e.stopImmediatePropagation();

          // Toggle the active class
          content.classList.remove('extra');

          // remove the read more button
          readMore.remove();
        });
      }
    }

    openUrl = () => {
      // get all the links
      const links = this.shadowObj.querySelectorAll('div#content a');
      const body = document.querySelector('body');

      // loop through the links
      if (!links) return;

      links.forEach(link => {
        // add event listener to the link
        link.addEventListener('click', event => {
          event.preventDefault();
          event.stopPropagation();
          event.stopImmediatePropagation();
          // get the url
          const url = link.getAttribute('href');

          // link pop up
          let linkPopUp = `<url-popup url="${url}"></url-popup>`;

          // open the popup
          body.insertAdjacentHTML('beforeend', linkPopUp);
        });
      });
    }

    getActions = (likes, views) => {
      const viewUrl = this.getAttribute('url');
      const editUrl = viewUrl + '/edit';
      return /*html*/`
      <div class="actions">
        <a href="${editUrl}" class="action edit" id="edit-action">edit</a>
        <a href="${viewUrl}" class="action view" id="view-action">view</a>
        <span class="action likes plain">
          <span class="no">${this.formatNumber(likes)}</span> <span class="text">${likes === 1 ? 'like' : 'likes'}</span>
        </span>
        <span class="action views plain">
          <span class="no">${this.formatNumber(views)}</span> <span class="text">${views === 1 ? 'view' : 'views'}</span>
        </span>
      </div>
    `
    }

    getFullPost = () => {
      const parent = this.getAttribute('parent');
      let text = parent ? `parent="${parent}"` : '';
      const images = this.getAttribute('images');
      return /* html */`
      <app-post story="reply" tab="replies" url="${this.getAttribute('url')}" hash="${this.getAttribute('hash')}"
        likes="${this.getAttribute('likes')}" replies="${this.getAttribute('replies')}" ${text} preview="full"
        replies-url="${this.getAttribute('replies-url')}" likes-url="${this.getAttribute('likes-url')}" images='${images}'
        liked="${this.getAttribute('liked')}" views="${this.getAttribute('views')}" time="${this.getAttribute('time')}"
        author-stories="${this.getAttribute('author-stories')}" author-replies="${this.getAttribute('author-replies')}" author-contact='${this.getAttribute("author-contact")}'
        author-you="${this.getAttribute('author-you')}" author-hash="${this.getAttribute('author-hash')}" author-url="${this.getAttribute('author-url')}"
        author-img="${this.getAttribute('author-img')}" author-verified="${this.getAttribute('author-verified')}" author-name="${this.getAttribute('author-name')}"
        author-followers="${this.getAttribute('author-followers')}" author-following="${this.getAttribute('author-following')}" author-follow="${this.getAttribute('author-follow')}"
        author-bio="${this.getAttribute('author-bio')}">
        ${this.innerHTML}
      </app-post>
    `
    }

    getStyles() {
      return /* css */`
      <style>
        *,
        *:after,
        *:before {
          box-sizing: border-box !important;
          font-family: inherit;
          -webkit-box-sizing: border-box !important;
        }

        *:focus {
          outline: inherit !important;
        }

        *::-webkit-scrollbar {
          -webkit-appearance: none;
        }

        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
          padding: 0;
          margin: 0;
          font-family: inherit;
        }

        p,
        ul,
        ol {
          padding: 0;
          margin: 0;
        }

        a {
          text-decoration: none;
        }

        :host {
          font-size: 16px;
          display: flex;
          flex-flow: column;
          gap: 5px;
          padding: 10px 0;
          border-bottom: var(--border);
          width: 100%;
        }

        .content {
          width: 100%;
          display: flex;
          flex-flow: column;
          color: var(--text-color);
          font-family: var(--font-main), sans-serif;
          line-height: 1.4;
          gap: 0;
          margin: 0;
          padding: 0;
        }

        .content.extra {
          max-height: 200px;
          overflow: hidden;
          position: relative;
        }

        .content.extra.feed {
          max-height: 150px;
        }

        .content.extra .read-more {
          position: absolute;
          bottom: -5px;
          right: 0;
          left: 0;
          width: 100%;
          padding: 5px 0;
          display: flex;
          align-items: end;
          justify-content: center;
          min-height: 80px;
          gap: 3px;
          font-weight: 500;
          font-family: var(--font-main), sans-serif;
          color: var(--gray-color);
          background: var(--fade-linear-gradient);
        }

        .content.extra .read-more svg {
          display: inline-block;
          width: 16px;
          height: 16px;
          margin: 0 0 2px 0;
        }

        .content h6,
        .content h5,
        .content h4,
        .content h3,
        .content h1 {
          padding: 0;
          font-size: 1.05rem !important;
          color: var(--title-color);
          font-weight: 500;
          line-height: 1.5;
          margin: 5px 0;
        }

        .content p {
          font-size: 1rem;
          margin: 0 0 5px;
          line-height: 1.4;
        }

        .content a {
          text-decoration: none;
          cursor: pointer;
          color: var(--anchor-color) !important;
        }

        .content a:hover {
          text-decoration: underline;
        }

        .content blockquote {
          margin: 2px 0;
          padding: 5px 0;
          font-style: italic;
          background: var(--background);
          color: var(--text-color);
          font-weight: 400;
          line-height: 1.4;
        }

        .content blockquote p {
          margin: 0;
        }

        .content blockquote * {
          margin: 0;
        }

        .content hr {
          border: none;
          background-color: var(--text-color);
          height: 1px;
          margin: 10px 0;
        }

        .content code {
          background: var(--gray-background);
          padding: 0 5px;
          font-family: var(--font-mono);
          font-size: 0.9rem;
          border-radius: 5px;
        }

        .content b,
        .content strong {
          font-weight: 700;
          line-height: 1.4;

        }

        .content ul,
        .content ol {
          margin: 5px 0 15px 20px;
          padding: 0 0 0 15px;
          color: inherit;
          line-height: 1.4;
        }

        .content ul li,
        .content ol li {
          margin: 6px 0;
          padding: 0;
          color: inherit;
        }

        .content > h3.story-title {
          margin: 0;
          color: var(--text-color);
          font-family: var(--font-main), sans-serif;
          line-height: 1.5;
          font-size: 1.15rem;
          font-weight: 500;
        }

        .actions {
          display: flex;
          font-family: var(--font-main), sans-serif;
          width: 100%;
          flex-flow: row;
          align-items: center;
          gap: 15px;
          margin: 5px 0 0 0;
        }
        
        .actions > .action {
          border: var(--border-button);
          text-decoration: none;
          color: var(--gray-color);
          font-size: 0.9rem;
          display: flex;
          width: max-content;
          flex-flow: row;
          align-items: center;
          text-transform: lowercase;
          justify-content: center;
          padding: 1.5px 10px 2.5px;
          border-radius: 10px;
        }

        .actions > .action.edit {
          border: none;
          background: var(--gray-background);
          color: var(--text-color);
          font-size: 0.9rem;
          padding: 2.5px 12px 3.5px;
        }

        .actions > .action.publish {
          text-transform: capitalize;
          padding: 2.5px 10px 3.5px;
        }

        .actions > .action.plain {
          padding: 0;
          font-weight: 500;
          pointer-events: none;
          font-family: var(--font-text), sans-serif;
          color: var(--gray-color);
          border: none;
          background: none;
          padding: 2.5px 0 3.5px 0;
        }

        .actions > .action.plain.draft {
          text-transform: capitalize;
          font-family: var(--font-main), sans-serif;
          font-size: 0.9rem;
          font-weight: 500;
          color: var(--text-color);
          padding: 2.5px 0 3.5px 0;
        }
        
        .actions > .action.plain > span.no {
          font-family: var(--font-main), sans-serif;
          font-size: 0.85rem;
          color: var(--text-color);
        }

        .actions > .action.plain > span.text {
          display: inline-block;
          padding: 0 0 0 3px;
        }

        @media screen and (max-width:660px) {
          ::-webkit-scrollbar {
            -webkit-appearance: none;
          }

          .actions {
            width: 100%;
          }

          .actions > .action.plain > span.no {
            font-family: var(--font-main), sans-serif;
            font-size: 0.8rem;
            color: var(--text-color);
          }

          button.fetch,
          .content.extra .read-more,
          .actions > .action.close,
          a {
            cursor: default !important;
          }
        }
      </style>
    `;
    }
  }

  class AuthorWrapper extends HTMLElement {
    constructor() {
      // We are not even going to touch this.
      super();

      // check if the user is authenticated
      this._authenticated = window.hash ? true : false;

      // Check if user is the owner of the profile
      this._you = this.getAttribute('you') === 'true' ;

      // let's create our shadow root
      this.shadowObj = this.attachShadow({ mode: "open" });

      this.parent = this.getRootNode().host;

      this.render();
    }


    // observe the attributes
    static get observedAttributes() {
      return ['followers', 'user-follow', 'reload'];
    }

    setAttributes = (name, value) => {
      this.parent.setAttribute(name, value);
    }

    render() {
      this.shadowObj.innerHTML = this.getTemplate();
    }

    // listen for changes in the attributes
    attributeChangedCallback(name, oldValue, newValue) {
      // check if old value is not equal to new value
      if (name==='reload' && newValue === 'true') {
        this.setAttribute('reload', 'false');
        // get the followers element
        const followers = this.shadowObj.querySelector('.stats > span.followers > .number');

        // Update the followers
        if(followers) {
          const totalFollowers = this.parseToNumber(this.getAttribute('followers'));
          followers.textContent = totalFollowers >= 0 ? this.formatNumber(totalFollowers) : '0';
        }

        // get the follow button
        const followBtn = this.shadowObj.querySelector('.actions > .action#follow-action');

        // Update the follow button
        if(followBtn) {
          this.updateFollowBtn(this.textToBoolean(this.getAttribute('user-follow')), followBtn);
        }
      }  
    }
    
    connectedCallback() {
      // get url
      let url = this.getAttribute('url');

      url = url.trim().toLowerCase();

      // Get the body
      const body = document.querySelector('body');

      this.expandCollapse();

      this.handleUserClick(url, body);
      this.handleActionClick(url, body);

      // Perform actions
      this.performActions();

      // open highlights
      this.openHighlights(body);
    }

    textToBoolean = text => {
      return text === 'true' ? true : false;
    }

    openHighlights = body => {
      // Get the stats action and subscribe action
      const statsBtn = this.shadowObj.querySelector('.actions>.action#highlights-action');

      // add event listener to the stats action
      if (statsBtn) {
        statsBtn.addEventListener('click', e => {
          e.preventDefault();
          e.stopPropagation();

          // Open the highlights popup
          body.insertAdjacentHTML('beforeend', this.getHighlights());
        });
      }
    }

    // Open user profile
    handleUserClick = (url, body) => {
      const outerThis = this;
      // get a.meta.link
      const content = this.shadowObj.querySelector('a#username');

      if(body && content) { 
        content.addEventListener('click', event => {
          event.preventDefault();
          
          // Get full post
          const profile =  outerThis.getProfile();
          
          // replace and push states
          outerThis.replaceAndPushStates(url, body, profile);

          body.innerHTML = profile;
        });
      }
    }

    // Open user profile
    handleActionClick = (url, body) => {
      const outerThis = this;
      // get a.meta.link
      const content = this.shadowObj.querySelector('a.action.view');

      if(body && content) { 
        content.addEventListener('click', event => {
          event.preventDefault();

          // Get full post
          const profile =  outerThis.getProfile();
          
          // replace and push states
          outerThis.replaceAndPushStates(url, body, profile);

          body.innerHTML = profile;
        });
      }
    }

    replaceAndPushStates = (url, body, profile) => {
      // Replace the content with the current url and body content
      // get the first custom element in the body
      const firstElement = body.firstElementChild;

      // convert the custom element to a string
      const elementString = firstElement.outerHTML;
      // get window location
      const pageUrl = window.location.href;
      window.history.replaceState(
        { page: 'page', content: elementString },
        url, pageUrl
      );

      // Updating History State
      window.history.pushState(
        { page: 'page', content: profile},
        url, url
      );
    }

    disableScroll() {
      // Get the current page scroll position
      let scrollTop = window.scrollY || document.documentElement.scrollTop;
      let scrollLeft = window.scrollX || document.documentElement.scrollLeft;
      document.body.classList.add("stop-scrolling");

      // if any scroll is attempted, set this to the previous value
      window.onscroll = function () {
        window.scrollTo(scrollLeft, scrollTop);
      };
    }

    enableScroll() {
      document.body.classList.remove("stop-scrolling");
      window.onscroll = function () { };
    }

    // perform actions
    performActions = () => {
      const outerThis = this;
      // get body 
      const body = document.querySelector('body');

      // get url to 
      let hash = this.getAttribute('hash');
      // trim and convert to lowercase
      hash = hash.trim().toLowerCase();

      // base api
      const url = '/api/v1/u/' + hash;

      // Get the follow action and subscribe action
      const followBtn = this.shadowObj.querySelector('.actions>.action#follow-action');

      // add event listener to the follow action
      if (followBtn) {
        // construct options
        const options = {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json',
          }
        };

        followBtn.addEventListener('click', e => {
          e.preventDefault();
          e.stopPropagation();

          let action = false;

          // Check if the user is authenticated
          if (!this._authenticated) {
            // Open the join popup
            this.openJoin(body);
          } 
          else {
            // Update the follow button
            if (followBtn.classList.contains('following')) {
              action = true;
              outerThis.updateFollowBtn(false, followBtn);
            }
            else {
              outerThis.updateFollowBtn(true, followBtn);
            }

            // Follow the topic
            this.followUser(`${url}/follow`, options, followBtn, action);
          }
        });
      }
    }

    followUser = (url, options, followBtn, followed) => {
      const outerThis = this;
      this.fetchWithTimeout(url, options)
        .then(response => {
          response.json()
          .then(data => {
            // If data has unverified, open the join popup
            if (data.unverified) {
              // Get body
              const body = document.querySelector('body');

              // Open the join popup
              outerThis.openJoin(body);

              // revert the follow button
              outerThis.updateFollowBtn(followed, followBtn);
            }

            // if success is false, show toast message
            if (!data.success) {
              outerThis.showToast(data.message, false);

              // revert the follow button
              outerThis.updateFollowBtn(followed, followBtn);
            }
            else {
              // Show toast message
              outerThis.showToast(data.message, true);

              // Check for followed boolean
              outerThis.updateFollowBtn(data.followed, followBtn);

              // Update the followers
              // outerThis.updateFollowers(data.followed);
            }
          });
        })
        .catch(_error => {
          // console.log(_error);
          // show toast message
          outerThis.showToast('An error occurred!', false);

          // revert the follow button
          outerThis.updateFollowBtn(followed, followBtn);
        });
    }

    fetchWithTimeout = async (url, options = {}, timeout = 9500) => {
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), timeout);
    
      try {
        const response = await fetch(url, {
          ...options,
          signal: controller.signal
        });

        return response;
      } catch (error) {
        if (error.name === 'AbortError') {
          throw new Error('Request timed out');
        }
        throw new Error(`Network error: ${error.message}`);
      } finally {
        clearTimeout(timeoutId);
      }
    };

    updateFollowBtn = (following, btn) => {
      if (following) {
        // Change the text to following
        btn.textContent = 'following';

        // remove the follow class
        btn.classList.remove('follow');

        // add the following class
        btn.classList.add('following');
      }
      else {
        // Change the text to follow
        btn.textContent = 'follow';

        // remove the following class
        btn.classList.remove('following');

        // add the follow class
        btn.classList.add('follow');
      }
    }

    showToast = (text, success) => {
      // Get the toast element
      const toast = this.getToast(text, success);

      // Get body element
      const body = document.querySelector('body');

      // Insert the toast into the DOM
      body.insertAdjacentHTML('beforeend', toast);

      // Remove the toast after 3 seconds
      setTimeout(() => {
        // Select the toast element
        const toast = body.querySelector('.toast');

        // Remove the toast
        if(toast) {
          toast.remove();
        }
      }, 3000);
    }

    getToast = (text, success) => {
      if (success) {
        return /* html */`
        <div class="toast true">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" fill="currentColor">
          <path d="M8 16A8 8 0 1 1 8 0a8 8 0 0 1 0 16Zm3.78-9.72a.751.751 0 0 0-.018-1.042.751.751 0 0 0-1.042-.018L6.75 9.19 5.28 7.72a.751.751 0 0 0-1.042.018.751.751 0 0 0-.018 1.042l2 2a.75.75 0 0 0 1.06 0Z"></path>
        </svg>
          <p class="toast-message">${text}</p>
        </div>
      `;
      }
      else {
        return /* html */`
      <div class="toast false">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" fill="currentColor">
          <path d="M2.343 13.657A8 8 0 1 1 13.658 2.343 8 8 0 0 1 2.343 13.657ZM6.03 4.97a.751.751 0 0 0-1.042.018.751.751 0 0 0-.018 1.042L6.94 8 4.97 9.97a.749.749 0 0 0 .326 1.275.749.749 0 0 0 .734-.215L8 9.06l1.97 1.97a.749.749 0 0 0 1.275-.326.749.749 0 0 0-.215-.734L9.06 8l1.97-1.97a.749.749 0 0 0-.326-1.275.749.749 0 0 0-.734.215L8 6.94Z"></path>
        </svg>
          <p class="toast-message">${text}</p>
        </div>
      `;
      }
      
    }

    openJoin = body => {
      // Insert getJoin beforeend
      body.insertAdjacentHTML('beforeend', this.getJoin());
    }

    getJoin = () => {
      // get url from the : only the path
      const url = window.location.pathname;

      return /* html */`
      <join-popup register="/join/register" login="/join/login" next="${url}"></join-popup>
    `
    }

    updateFollowers = (followed) => {
      const outerThis = this;
      let value = followed ? 1 : -1;
      // Get followers attribute : convert to number then add value

      let followers = this.parseToNumber(this.getAttribute('followers')) + value;

      // if followers is less than 0, set it to 0
      followers = followers < 0 ? 0 : followers;

      // Set the followers attribute
      // this.setAttribute('followers', followers.toString());
      this.setAttribute('user-follow', followed.toString());

      // this.setAttributes('author-followers', followers.toString());
      this.setAttributes('author-follow', followed.toString());

      // select the followers element
      const followersStat = outerThis.shadowObj.querySelector('.stats > span.followers');
      if (followersStat) {
        // select no element
        const no = followersStat.querySelector('.number');
        const text = followersStat.querySelector('.label');

        // Update the followers
        no.textContent = this.formatNumber(followers);

        // Update the text
        text.textContent = followers === 1 ? 'follower' : 'followers';
      }
    }

    // Expand and collapse the author info
    expandCollapse = () => {
      // mql is a media query list
      const mql = window.matchMedia('(max-width: 660px)');

      // check if the screen is mobile
      if (mql.matches) {
        const contentContainer = this.shadowObj.querySelector('div.content-container');
        const svg = this.shadowObj.querySelector('svg');

        // check if the content container and svg exist
        if (contentContainer && svg) {

          // Select bio, stats, and actions
          const bio = this.shadowObj.querySelector('.bio');
          const stats = this.shadowObj.querySelector('.stats');
          const actions = this.shadowObj.querySelector('.actions');

          if (bio && stats && actions) {

            // Add event listener to the svg
            svg.addEventListener('click', () => {
              // if the content container is expanded, collapse it
              if (contentContainer.dataset.expanded === 'false') {
                // add gap to the content container
                contentContainer.style.gap = '8px';

                // Set the height to max for bio, stats, and actions
                stats.style.setProperty('max-height', 'max-content');
                bio.style.setProperty('max-height', 'max-content');
                actions.style.setProperty('max-height', 'max-content');

                actions.style.setProperty('padding', '5px 0 15px');
                actions.style.setProperty('border-bottom', 'var(--border)');

                // Collapse the content container
                svg.style.transform = 'rotate(180deg)';
                contentContainer.dataset.expanded = 'true';
              }
              else {
                // Remove gap from the content container
                contentContainer.style.gap = '0';

                // Set the height to 0 for bio, stats, and actions
                actions.style.setProperty('max-height', '0');
                bio.style.setProperty('max-height', '0');
                stats.style.setProperty('max-height', '0');

                actions.style.setProperty('padding', '0');
                actions.style.setProperty('border-bottom', 'none');

                // Expand the content container
                svg.style.transform = 'rotate(0deg)';
                contentContainer.dataset.expanded = 'false';
              }
            });
          }
        }
      }
    }

    formatNumber = n => {
      if (n >= 0 && n <= 999) {
        return n.toString();
      } else if (n >= 1000 && n <= 9999) {
        const value = (n / 1000).toFixed(2);
        return `${value}k`;
      } else if (n >= 10000 && n <= 99999) {
        const value = (n / 1000).toFixed(1);
        return `${value}k`;
      } else if (n >= 100000 && n <= 999999) {
        const value = (n / 1000).toFixed(0);
        return `${value}k`;
      } else if (n >= 1000000 && n <= 9999999) {
        const value = (n / 1000000).toFixed(2);
        return `${value}M`;
      } else if (n >= 10000000 && n <= 99999999) {
        const value = (n / 1000000).toFixed(1);
        return `${value}M`;
      } else if (n >= 100000000 && n <= 999999999) {
        const value = (n / 1000000).toFixed(0);
        return `${value}M`;
      } else if (n >= 1000000000) {
        return "1B+";
      }
      else {
        return 0;
      }
    }

    parseToNumber = num_str => {
      // Try parsing the string to an integer
      const num = parseInt(num_str);

      // Check if parsing was successful
      if (!isNaN(num)) {
        return num;
      } else {
        return 0;
      }
    }

    getTemplate() {
      // Show HTML Here
      return `
      ${this.getBody()}
      ${this.getStyles()}
    `;
    }

    getBody = () => {
      return /* html */`
      <div data-expanded="false" class="content-container">
        ${this.getContent()}
      </div>
    `
    }

    getContent = () => {
      const mql = window.matchMedia('(max-width: 660px)');
      return /* html */`
      ${this.getSvg()}
		  ${this.getHeader()}
      ${this.getStats()}
      ${this.getBio(mql.matches)}
      ${this.getActions()}
		`
    }

    getSvg = () => {
      // check if screen is mobile using mql
      const mql = window.matchMedia('(max-width: 660px)');

      // check if the screen is mobile
      if (mql.matches) {
        return /* html */`
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" fill="currentColor">
          <path d="M12.78 5.22a.749.749 0 0 1 0 1.06l-4.25 4.25a.749.749 0 0 1-1.06 0L3.22 6.28a.749.749 0 1 1 1.06-1.06L8 8.939l3.72-3.719a.749.749 0 0 1 1.06 0Z"></path>
        </svg>
      `
      }
      else {
        return ''
      }
    }

    getHeader = () => {
      // Get name and check if it's greater than 20 characters
      const name = this.getAttribute('name');

      // GET url
      const url = this.getAttribute('url');

      // Check if the name is greater than 20 characters: replace the rest with ...
      let displayName = name.length > 20 ? `${name.substring(0, 20)}..` : name;

      return /* html */ `
      <div class="top">
        ${this.getPicture(this.getAttribute('picture'))}
        <div class="name">
          <h4 class="name">
            <span class="name">${displayName}</span>
          </h4>
          <a href="${url.toLowerCase()}" class="username" id="username">
            <span class="text">${this.getAttribute('hash')}</span>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" fill="currentColor">
              <path d="M4.53 4.75A.75.75 0 0 1 5.28 4h6.01a.75.75 0 0 1 .75.75v6.01a.75.75 0 0 1-1.5 0v-4.2l-5.26 5.261a.749.749 0 0 1-1.275-.326.749.749 0 0 1 .215-.734L9.48 5.5h-4.2a.75.75 0 0 1-.75-.75Z" />
            </svg>
          </a>
        </div>
      </div>
    `
    }

    getPicture = picture => {
      // check if picture is empty || null || === "null"
      if (picture === '' || picture === null || picture === 'null') {
        return /*html*/`
        <div class="avatar svg">
          <div class="svg-avatar">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
              <path d="M12 2.5a5.5 5.5 0 0 1 3.096 10.047 9.005 9.005 0 0 1 5.9 8.181.75.75 0 1 1-1.499.044 7.5 7.5 0 0 0-14.993 0 .75.75 0 0 1-1.5-.045 9.005 9.005 0 0 1 5.9-8.18A5.5 5.5 0 0 1 12 2.5ZM8 8a4 4 0 1 0 8 0 4 4 0 0 0-8 0Z"></path>
            </svg>
          </div>
          ${this.checkVerified(this.getAttribute('verified'))}
        </div>
      `
      }
      else {
        return /*html*/`
        <div class="avatar">
          <img src="${picture}" alt="Author picture">
          ${this.checkVerified(this.getAttribute('verified'))}
        </div>
      `
      }
    }

    checkVerified = verified => {
      if (verified === 'true') {
        return /*html*/`
        <svg width="26" height="26" viewBox="0 0 26 26" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M16.3592 1.41412C15.9218 0.966482 15.3993 0.610789 14.8224 0.367944C14.2455 0.125098 13.6259 0 13 0C12.3741 0 11.7545 0.125098 11.1776 0.367944C10.6007 0.610789 10.0782 0.966482 9.64079 1.41412L8.62993 2.45091L7.18354 2.43304C6.55745 2.42563 5.93619 2.54347 5.35631 2.77964C4.77642 3.01581 4.24962 3.36554 3.80687 3.80826C3.36413 4.25098 3.01438 4.77775 2.77819 5.3576C2.542 5.93744 2.42415 6.55866 2.43156 7.18472L2.44781 8.63102L1.41421 9.64181C0.966543 10.0792 0.610827 10.6017 0.367967 11.1785C0.125106 11.7554 0 12.3749 0 13.0008C0 13.6267 0.125106 14.2462 0.367967 14.8231C0.610827 15.3999 0.966543 15.9224 1.41421 16.3598L2.44944 17.3706L2.43156 18.8169C2.42415 19.443 2.542 20.0642 2.77819 20.644C3.01438 21.2239 3.36413 21.7506 3.80687 22.1934C4.24962 22.6361 4.77642 22.9858 5.35631 23.222C5.93619 23.4582 6.55745 23.576 7.18354 23.5686L8.62993 23.5523L9.64079 24.5859C10.0782 25.0335 10.6007 25.3892 11.1776 25.6321C11.7545 25.8749 12.3741 26 13 26C13.6259 26 14.2455 25.8749 14.8224 25.6321C15.3993 25.3892 15.9218 25.0335 16.3592 24.5859L17.3701 23.5507L18.8165 23.5686C19.4426 23.576 20.0638 23.4582 20.6437 23.222C21.2236 22.9858 21.7504 22.6361 22.1931 22.1934C22.6359 21.7506 22.9856 21.2239 23.2218 20.644C23.458 20.0642 23.5758 19.443 23.5684 18.8169L23.5522 17.3706L24.5858 16.3598C25.0335 15.9224 25.3892 15.3999 25.632 14.8231C25.8749 14.2462 26 13.6267 26 13.0008C26 12.3749 25.8749 11.7554 25.632 11.1785C25.3892 10.6017 25.0335 10.0792 24.5858 9.64181L23.5506 8.63102L23.5684 7.18472C23.5758 6.55866 23.458 5.93744 23.2218 5.3576C22.9856 4.77775 22.6359 4.25098 22.1931 3.80826C21.7504 3.36554 21.2236 3.01581 20.6437 2.77964C20.0638 2.54347 19.4426 2.42563 18.8165 2.43304L17.3701 2.44929L16.3592 1.41412Z" 
            fill="currentColor" id="top"/>
          <path d="M15.3256 4.97901C15.0228 4.6691 14.661 4.42285 14.2616 4.25473C13.8623 4.08661 13.4333 4 13 4C12.5667 4 12.1377 4.08661 11.7384 4.25473C11.339 4.42285 10.9772 4.6691 10.6744 4.97901L9.97457 5.69678L8.97322 5.68441C8.53977 5.67928 8.10967 5.76086 7.70821 5.92437C7.30675 6.08787 6.94204 6.32999 6.63553 6.63649C6.32901 6.94298 6.08688 7.30767 5.92336 7.70911C5.75985 8.11054 5.67826 8.54061 5.68339 8.97403L5.69464 9.97532L4.97907 10.6751C4.66914 10.9779 4.42288 11.3396 4.25475 11.739C4.08661 12.1383 4 12.5673 4 13.0006C4 13.4339 4.08661 13.8628 4.25475 14.2621C4.42288 14.6615 4.66914 15.0232 4.97907 15.326L5.69577 16.0258L5.68339 17.0271C5.67826 17.4605 5.75985 17.8906 5.92336 18.292C6.08688 18.6935 6.32901 19.0581 6.63553 19.3646C6.94204 19.6711 7.30675 19.9133 7.70821 20.0768C8.10967 20.2403 8.53977 20.3218 8.97322 20.3167L9.97457 
            20.3055L10.6744 21.021C10.9772 21.3309 11.339 21.5771 11.7384 21.7453C12.1377 21.9134 12.5667 22 13 22C13.4333 22 13.8623 21.9134 14.2616 21.7453C14.661 21.5771 15.0228 21.3309 15.3256 21.021L16.0254 20.3043L17.0268 20.3167C17.4602 20.3218 17.8903 20.2403 18.2918 20.0768C18.6932 19.9133 19.058 19.6711 19.3645 19.3646C19.671 19.0581 19.9131 18.6935 20.0766 18.292C20.2402 17.8906 20.3217 17.4605 20.3166 17.0271L20.3054 16.0258L21.0209 15.326C21.3309 15.0232 21.5771 14.6615 21.7453 14.2621C21.9134 13.8628 22 13.4339 22 13.0006C22 12.5673 21.9134 12.1383 21.7453 11.739C21.5771 11.3396 21.3309 10.9779 21.0209 10.6751L20.3042 9.97532L20.3166 8.97403C20.3217 8.54061 20.2402 8.11054 20.0766 7.70911C19.9131 7.30767 19.671 6.94298 19.3645 6.63649C19.058 6.32999 18.6932 6.08787 18.2918 5.92437C17.8903 5.76086 17.4602 5.67928 17.0268 5.68441L16.0254 5.69566L15.3256 4.97901ZM15.6485 11.7113L12.2732 15.0864C12.2209 15.1388 12.1588 15.1803 12.0905 15.2087C12.0222 15.2371 11.9489 15.2517 11.8749 15.2517C11.8009 15.2517 11.7276 15.2371 11.6593 15.2087C11.5909 15.1803 11.5289 15.1388 11.4766 15.0864L9.78893 13.3988C9.73662 13.3465 9.69513 13.2844 9.66683 13.2161C9.63852 13.1478 9.62395 13.0745 9.62395 13.0006C9.62395 12.9266 9.63852 12.8534 9.66683 12.785C9.69513 12.7167 9.73662 12.6546 9.78893 12.6023C9.84123 12.55 9.90333 12.5085 9.97166 12.4802C10.04 12.4519 10.1132 12.4373 10.1872 12.4373C10.2612 12.4373 10.3344 12.4519 10.4028 12.4802C10.4711 12.5085 10.5332 12.55 10.5855 12.6023L11.8749 13.8927L14.8519 10.9147C14.9576 10.8091 15.1008 10.7498 15.2502 10.7498C15.3996 10.7498 15.5429 10.8091 15.6485 10.9147C15.7542 11.0204 15.8135 11.1636 15.8135 11.313C15.8135 11.4624 15.7542 11.6056 15.6485 11.7113Z" 
            fill="currentColor" id="bottom"/>
        </svg>
			`
      }
      else {
        return ''
      }
    }

    getStats = () => {
      // Get total followers & following and parse to integer
      const followers = this.getAttribute('followers') || 0;
      const following = this.getAttribute('following') || 0;

      // Convert the followers & following to a number
      const totalFollowers = this.parseToNumber(followers);
      const totalFollowing = this.parseToNumber(following);

      //  format the number
      const followersFormatted = this.formatNumber(totalFollowers);
      const followingFormatted = this.formatNumber(totalFollowing);


      return /* html */`
      <div class="stats">
        <span class="stat followers">
          <span class="number">${followersFormatted}</span>
          <span class="label">${totalFollowers === 1 ? 'follower' : 'followers'}</span>
        </span>
        <span class="sp">•</span>
        <span class="stat following">
          <span class="number">${followingFormatted}</span>
          <span class="label">Following</span>
        </span>
      </div>
		`
    }

    getBio = mql => {
      // Get bio content
      let bio = this.getAttribute('bio') || 'The user has not added their bio yet.';

      // trim white spaces
      bio = bio.trim();

      let bioLines = bio.length > 150 ? `<p>${bio.substring(0, 150)}..</p>` : `<p>${bio}</p>`;

      if (!mql) {
        // separate by new lines
        const bioArray = bio.split('\n');

        // trim each line and ignore empty lines
        bioLines = bioArray.map(line => line.trim()).filter(line => line !== '').map(line => `<p>${line}</p>`).join('');
      }

      return /*html*/`
      <div class="bio">
        ${bioLines}
      </div>
    `
    }

    getActions() {
      return /*html*/`
      <div class="actions">
        ${this.checkYou(this._you)}
      </div>
    `;
    }

    checkYou = you => {
      // get url
      let url = this.getAttribute('url');

      // trim white spaces and convert to lowercase
      url = url.trim().toLowerCase();

      if (you) {
        return /*html*/`
        <span  class="action you">You</span>
        <a href="${url}" class="action view">view</a>
        <span class="action highlights" id="highlights-action">stats</span>
      `
      }
      else {
        return /*html*/`
        <a href="${url}" class="action view">view</a>
        ${this.checkFollowing(this.getAttribute('user-follow'))}
        <span class="action highlights" id="highlights-action">stats</span>
      `
      }
    }

    checkFollowing = following => {
      if (following === 'true') {
        return /*html*/`
        <span class="action following" id="follow-action">Following</span>
      `
      }
      else {
        return /*html*/`
        <span class="action follow" id="follow-action">Follow</span>
      `
      }
    }

    getProfile = () => {
      // get url
      let url = this.getAttribute('url');
   
      // trim white spaces and convert to lowercase
      url = url.trim().toLowerCase();

     return /* html */`
      <app-profile tab="stories" you="${this.getAttribute('you')}" url="${url}" tab="stories"
        stories-url="/api/v1${url}/stories" replies-url="/api/v1${url}/replies" stories="${this.getAttribute('stories')}" replies="${this.getAttribute('replies')}"
        followers-url="/api/v1${url}/followers" following-url="/api/v1${url}/following"
        hash="${this.getAttribute('hash')}" picture="${this.getAttribute('picture')}" verified="${this.getAttribute('verified')}"
        name="${this.getAttribute('name')}" followers="${this.getAttribute('followers')}" contact='${this.getAttribute("contact")}'
        following="${this.getAttribute('following')}" user-follow="${this.getAttribute('user-follow')}" bio="${this.getAttribute('bio')}">
      </app-profile>
    `
    }

    getHighlights = () => {
      // get url
      const url = this.getAttribute('url');
    
      // trim white spaces and convert to lowercase
      let formattedUrl = url.toLowerCase();

      return /* html */`
      <stats-popup url="/api/v1${formattedUrl}/stats" name="${this.getAttribute('name')}"
        followers="${this.getAttribute('followers')}" following="${this.getAttribute('following')}" 
        stories="${this.getAttribute('stories')}" replies="${this.getAttribute('replies')}">
      </stats-popup>
    `
    }

    getStyles() {
      return /* css */`
      <style>
        *,
        *:after,
        *:before {
          box-sizing: border-box !important;
          font-family: inherit;
          -webkit-box-sizing: border-box !important;
        }

        *:focus {
          outline: inherit !important;
        }

        *::-webkit-scrollbar {
          -webkit-appearance: none;
        }

        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
          padding: 0;
          margin: 0;
          font-family: inherit;
        }

        p,
        ul,
        ol {
          padding: 0;
          margin: 0;
        }

        a {
          text-decoration: none;
        }

        :host {
          font-size: 16px;
          padding: 0;
          width: 100%;
          display: flex;
          flex-flow: column;
          align-items: start;
          gap: 0px;
        }

        .content-container {
          position: relative;
          width: 100%;
          display: flex;
          flex-flow: column;
          align-items: start;
          gap: 8px;
        }

        .content-container > svg {
          display: none;
        }

        .top {
          display: flex;
          width: 100%;
          flex-flow: row;
          align-items: center;
          padding: 5px 5px 8px;
          background: var(--gray-background);
          border-radius: 10px;
          gap: 5px;
        }

        .top > .avatar {
          position: relative;
          width: 45px;
          height: 45px;
          border-radius: 50%;
          -webkit-border-radius: 50%;
          -moz-border-radius: 50%;
        }

        .top > .avatar.svg {
          background: var(--gray-background);
        }

        .top > .avatar > .svg-avatar {
          border: var(--border-button);
          width: 100%;
          height: 100%;
          display: flex;
          align-items: center;
          justify-content: center;
          border-radius: 50%;
          -webkit-border-radius: 50%;
          -moz-border-radius: 50%;
        }

        .top > .avatar > .svg-avatar svg {
          width: 25px;
          height: 25px;
          color: var(--gray-color);
        }

        .top > .avatar > img {
          width: 100%;
          height: 100%;
          overflow: hidden;
          object-fit: cover;
          border-radius: 50%;
          -webkit-border-radius: 50%;
          -moz-border-radius: 50%;
        }

        .top > .avatar > svg  {
          position: absolute;
          bottom: -1px;
          right: -4px;
          width: 23px;
          height: 23px;
          z-index: 1;
          fill: var(--background);
          display: flex;
          align-items: center;
          justify-content: center;
        }

        .top > .avatar > svg path#top {
          color: var(--gray-background);
        }
        
        .top > .avatar > svg path#bottom {
          color: var(--accent-color);
        }

        .top > .name {
          display: flex;
          justify-content: center;
          flex-flow: column;
          gap: 0;
        }

        .top > .name > h4.name {
          margin: 0;
          display: flex;
          align-items: center;
          gap: 5px;
          color: var(--text-color);
          font-family: var(--font-text), sans-serif;
          font-size: 1.1rem;
          font-weight: 600;
        }

        .top > .name > h4.name svg {
          color: var(--alt-color);
          margin: 5px 0 0 0;
        }

        .top > .name > a.username {
          color: var(--gray-color);
          font-family: var(--font-mono), monospace;
          font-size: 0.9rem;
          font-weight: 500;
          text-decoration: none;
          display: flex;
          gap: 2px;
          align-items: center;
        }

        .top > .name > a.username svg {
          color: var(--gray-color);
          width: 15px;
          height: 15px;
          margin: 3px 0 0 0;
        }

        .top > .name > a.username:hover {
          color: transparent;
          background: var(--accent-linear);
          background-clip: text;
          -webkit-background-clip: text;
        }

        .top > .name > a.username:hover svg {
          color: var(--accent-color);
        }

        .stats {
          color: var(--gray-color);
          display: flex;
          width: 100%;
          flex-flow: row;
          align-items: center;
          gap: 10px;
        }

        .stats > .stat {
          display: flex;
          flex-flow: row;
          align-items: center;
          gap: 5px;
        }

        .stats > .stat > .label {
          color: var(--gray-color);
          font-family: var(--font-main), sans-serif;
          text-transform: lowercase;
          font-size: 1rem;
          font-weight: 400;
        }

        .stats > .stat > .number {
          color: var(--text-color);
          font-family: var(--font-main), sans-serif;
          font-size: 0.84rem;
          font-weight: 500;
        }

        .bio {
          display: flex;
          flex-flow: column;
          gap: 5px;
          color: var(--text-color);
          font-family: var(--font-text), sans-serif;
          font-size: 1rem;
          line-height: 1.4;
          font-weight: 400;
        }

        .bio > p {
          all: inherit;
        }

        .actions {
          border-bottom: var(--border);
          display: flex;
          font-family: var(--font-main), sans-serif;
          width: 100%;
          flex-flow: row;
          align-items: center;
          gap: 12px;
          padding: 5px 0 15px;
        }
        
        .actions > .action {
          border: var(--action-border);
          padding: 4px 12px 4px;
          background: none;
          border: var(--border-mobile);
          color: var(--gray-color);
          font-family: var(--font-main), sans-serif;
          font-weight: 400;
          font-size: 0.95rem;
          cursor: pointer;
          display: flex;
          width: max-content;
          flex-flow: row;
          align-items: center;
          text-transform: lowercase;
          justify-content: center;
          border-radius: 12px;
          -webkit-border-radius: 12px;
          -moz-border-radius: 12px;
        }

        .actions > .action.you {
          text-transform: capitalize;
          padding: 5px 12px 5px;
          cursor: default;
          pointer-events: none;
          border: none;
          background: var(--gray-background);
        }
        
        .actions > .action.follow {
          border: none;
          padding: 5px 12px 5px;
          font-weight: 500;
          background: var(--accent-linear);
          color: var(--white-color);
        }

        @media screen and (max-width: 660px) {
          :host {
            font-size: 16px;
            border-bottom: none;
            border: none;
          }

          .top > .avatar > .svg-avatar {
            border: none;
          }

          .top > .avatar > svg path#top {
            color: var(--background);
          }

          .content-container {
            border: none;
            position: relative;
            padding: 10px 0 5px;
            width: 100%;
            max-height: max-content;
            display: flex;
            flex-flow: column;
            align-items: start;
            gap: 0;
            transition: all 0.3s ease;
            -webkit-transition: all 0.3s ease;
            -moz-transition: all 0.3s ease;
            -ms-transition: all 0.3s ease;
            -o-transition: all 0.3s ease;
          }

          .content-container > .stats,
          .content-container > .bio,
          .content-container > .actions {
            transition: all 0.5s ease;
            border: none;
            max-height: 0;
            overflow: hidden;
            margin: 0;
            padding: 0;
            overflow: hidden;
          }

          .content-container > .actions {
            border-bottom: none;
            display: flex;
            font-family: var(--font-main), sans-serif;
            width: 100%;
            max-height: 0;
            flex-flow: row;
            align-items: center;
            gap: 12px;
            padding: 0;
          }

          .top {
            display: flex;
            width: 100%;
            flex-flow: row;
            align-items: center;
            padding: 0;
            background: none;
            border-radius: 10px;
            gap: 5px;
          }

          ::-webkit-scrollbar {
            -webkit-appearance: none;
          }

          a,
          .stats > .stat {
            cursor: default !important;
          }

          a,
          span.stat,
          span.action {
            cursor: default !important;
          }

          .content-container > svg {
            display: inline-block;
            position: absolute;
            top: 20px;
            right: 5px;
            color: var(--title-color);
            cursor: default !important;
            width: 22px;
            height: 22px;
            transition: all 0.5s ease;
          }
        }
      </style>
    `;
    }
  }

  class HeaderWrapper extends HTMLElement {
    constructor() {
      // We are not even going to touch this.
      super();

      // check if the user is authenticated
      this._authenticated = window.hash ? true : false;

      this._user = null;
      this._unverified = false;

      this.fetchUpdate();

      // let's create our shadow root
      this.shadowObj = this.attachShadow({ mode: "open" });

      this.render();
    }

    // add attribute to watch for changes
    static get observedAttributes() {
      return ['section', 'type'];
    }

    render() {
      this.shadowObj.innerHTML = this.getTemplate();
    }

    // check for attribute changes
    attributeChangedCallback(name, oldValue, newValue) {
      if (oldValue !== newValue) {
        // check if the attribute is section
        if (name === 'section') {
          // select the title element
          const title = this.shadowObj.querySelector('h3.name');
          // update the title
          title.textContent = newValue;
        }
      }
    }

    connectedCallback() {
      const body = document.querySelector('body');
      // select the back svg
      const back = this.shadowObj.querySelector('nav.nav > .left svg');

      const links = this.shadowObj.querySelectorAll('div.links > a.link');

      if(links) {
        this.updateActive(links);
      }

      if (back) {
        // activate the back button
        this.activateBackButton(back);
      }

      this.handleUserClick(body);
    }

    disconnectedCallback() {
      this.enableScroll();
    }

    // handle icons click
    handleUserClick = body => {
      const outerThis = this;
      // get a.meta.link
      const links = this.shadowObj.querySelectorAll('div.links > a.link');

      if(body && links) { 
        links.forEach(link => {
          link.addEventListener('click', event => {
            event.preventDefault();
            event.stopImmediatePropagation();
            event.stopPropagation();

            const name = link.getAttribute('name');
            const url = link.getAttribute('href');

            try {
              if (name === 'logon') {
                // replace and push states
                this.replaceAndPushStates(url, body, outerThis.getLogon(document.location.pathname));
              } else if(name === 'updates'){
                // replace and push states
                this.replaceAndPushStates(url, body, outerThis.getUser(outerThis._user, 'updates'));
              } else if(name === 'profile'){
                // replace and push states
                this.replaceAndPushStates(url, body, outerThis.getUser(outerThis._user, ''));
              } else if(name === 'search') {
                // replace and push states
                this.replaceAndPushStates(url, body, outerThis.getSearch());
              } else if (name === 'home') {
                // replace and push states
                this.replaceAndPushStates(url, body, outerThis.getHome());
              }
            } catch (error) {
              // console.log(error)
              outerThis.navigateToUser(url);
            }
          });
        });
      }
    }

    updateActive = links  => {
      const current = window.location.pathname;
      for(let i=0; i<links.length; i++) {
        const link = links[i];
        const name = link.getAttribute('href');

        if (current === name) {
          link.classList.add('active');
        }
      }
    }

    // Replace and push states
    replaceAndPushStates = (url, body, profile) => {
      // Replace the content with the current url and body content
      // get the first custom element in the body
      const firstElement = body.firstElementChild;

      // convert the custom element to a string
       const elementString = firstElement.outerHTML;
      // get window location
      const pageUrl = window.location.href;
      window.history.replaceState(
        { page: 'page', content: elementString },
        url, pageUrl
      );

      // Updating History State
      window.history.pushState(
        { page: 'page', content: profile},
        url, url
      );

      // update the body content
      body.innerHTML = profile;
    }

    getNext = () => {
      const body = document.querySelector('body');
      const firstElement = body.firstElementChild;

      // convert the custom element to a string
      return firstElement.outerHTML;
    }

    fetchUpdate = () => {
      const outerThis = this;
  		// fetch the user stats
      const options = {
        method: "GET",
        headers: {
          "Content-Type": "application/json",
          // set the cache control to max-age to 1 day
          "Cache-Control": "max-age=86400",
          "Accept": "application/json"
        }
      };

      const url = '/api/v1/u/author/info';

      this.getCacheData(url, 86400, options)
        .then(result => {
          if (result.unverified) {
            outerThis._unverified = true;
            return;
          }
          // check for success response
          if (result.success) {
            if(!result.user) {
              // display empty message
              outerThis._user = null;
              return;
            }

            outerThis._user = result.user;
          }
          else {
            outerThis._user = null;
          }
        })
        .catch(error => {
          console.log(error);
          outerThis._user = null;
        });
  	}

    navigateToUser = href => {
      window.location.href = href;
      return;
    }

    fetchWithTimeout = async (url, options = {}, timeout = 9500) => {
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), timeout);
    
      try {
        const response = await fetch(url, {
          ...options,
          signal: controller.signal
        });

        return response;
      } catch (error) {
        if (error.name === 'AbortError') {
          throw new Error('Request timed out');
        }
        throw new Error(`Network error: ${error.message}`);
      } finally {
        clearTimeout(timeoutId);
      }
    };

    getCacheData = async (url, maxAge, options = {}) => {
      const cacheName = "user-cache";
    
      try {
        const cache = await caches.open(cacheName);
        const cachedResponse = await cache.match(url);
    
        if (cachedResponse) {
          const cachedData = await cachedResponse.json();
          const cacheTime = cachedData.timestamp;
    
          // Check if cache is still valid
          if (Date.now() - cacheTime < maxAge) {
            return cachedData.data;
          }
        }
    
        // If cache doesn't exist or is expired, fetch new data
        const networkResponse = await this.fetchWithTimeout(url, options);
        const data = await networkResponse.clone().json();
    
        // Store the new data in cache with a timestamp
        const cacheData = {
          data: data,
          timestamp: Date.now()
        };
        
        const cacheResponse = new Response(JSON.stringify(cacheData));
        await cache.put(url, cacheResponse);
    
        return data;
      } catch (error) {
        console.error('Error fetching data:', error);
        throw error;
      }
    };

    activateBackButton = btn => {
      btn.addEventListener('click', () => {
        // check window history is greater or equal to 1
        if (window.history.length >= 1) {
          // check if the history has state
          if (window.history.state) {
            // go back
            window.history.back();
            // console.log(window.history.state);
          }
          else {
            // redirect to home
            window.location.href = '/home';
          }
        }
      });
    }

    disableScroll() {
      // Get the current page scroll position
      let scrollTop = window.scrollY || document.documentElement.scrollTop;
      let scrollLeft = window.scrollX || document.documentElement.scrollLeft;
      document.body.classList.add("stop-scrolling");

      // if any scroll is attempted, set this to the previous value
      window.onscroll = function () {
        window.scrollTo(scrollLeft, scrollTop);
      };
    }

    enableScroll() {
      document.body.classList.remove("stop-scrolling");
      window.onscroll = function () { };
    }

    getTemplate() {
      // Show HTML Here
      return `
      ${this.getBody()}
      ${this.getStyles()}
    `;
    }

    getBody = () => {
      const title = this.getAttribute('section');
      return /* html */`
      <nav data-expanded="false" class="nav">
        ${this.getContent(title)}
      </nav>
    `
    }

    getContent = title => {
      // mql to check for mobile
      const mql = window.matchMedia('(max-width: 660px)');
      return /* html */ `
      ${this.getTitle(this.getAttribute('type'), mql.matches)}
      ${this.getTopIcons(this._authenticated)}
    `
    }

    getTopIcons = authenticated => {
      if (authenticated) {
        return /* html */ `
        <div class="links">
          <a href="/home" class="link discover" name="home" title="Home">
            <!--<svg width="21" height="22" viewBox="0 0 21 22" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M7.65722 19.7714V16.7047C7.6572 15.9246 8.29312 15.2908 9.08101 15.2856H11.9671C12.7587 15.2856 13.4005 15.9209 13.4005 16.7047V16.7047V19.7809C13.4003 20.4432 13.9343 20.9845 14.603 21H16.5271C18.4451 21 20 19.4607 20 17.5618V17.5618V8.83784C19.9898 8.09083 19.6355 7.38935 19.038 6.93303L12.4577 1.6853C11.3049 0.771566 9.6662 0.771566 8.51342 1.6853L1.96203 6.94256C1.36226 7.39702 1.00739 8.09967 1 8.84736V17.5618C1 19.4607 2.55488 21 4.47291 21H6.39696C7.08235 21 7.63797 20.4499 7.63797 19.7714V19.7714" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>-->
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" fill="currentColor">
              <path d="M6.906.664a1.749 1.749 0 0 1 2.187 0l5.25 4.2c.415.332.657.835.657 1.367v7.019A1.75 1.75 0 0 1 13.25 15h-3.5a.75.75 0 0 1-.75-.75V9H7v5.25a.75.75 0 0 1-.75.75h-3.5A1.75 1.75 0 0 1 1 13.25V6.23c0-.531.242-1.034.657-1.366l5.25-4.2Zm1.25 1.171a.25.25 0 0 0-.312 0l-5.25 4.2a.25.25 0 0 0-.094.196v7.019c0 .138.112.25.25.25H5.5V8.25a.75.75 0 0 1 .75-.75h3.5a.75.75 0 0 1 .75.75v5.25h2.75a.25.25 0 0 0 .25-.25V6.23a.25.25 0 0 0-.094-.195Z"></path>
            </svg>        
          </a>
          <a href="/user" class="link profile" name="profile" title="User">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" fill="currentColor">
              <path d="M8 0a8.2 8.2 0 0 1 .701.031C9.444.095 9.99.645 10.16 1.29l.288 1.107c.018.066.079.158.212.224.231.114.454.243.668.386.123.082.233.09.299.071l1.103-.303c.644-.176 1.392.021 1.82.63.27.385.506.792.704 1.218.315.675.111 1.422-.364 1.891l-.814.806c-.049.048-.098.147-.088.294.016.257.016.515 0 .772-.01.147.038.246.088.294l.814.806c.475.469.679 1.216.364 1.891a7.977 7.977 0 0 1-.704 1.217c-.428.61-1.176.807-1.82.63l-1.102-.302c-.067-.019-.177-.011-.3.071a5.909 5.909 0 0 1-.668.386c-.133.066-.194.158-.211.224l-.29 1.106c-.168.646-.715 1.196-1.458 1.26a8.006 8.006 0 0 1-1.402 0c-.743-.064-1.289-.614-1.458-1.26l-.289-1.106c-.018-.066-.079-.158-.212-.224a5.738 5.738 0 0 1-.668-.386c-.123-.082-.233-.09-.299-.071l-1.103.303c-.644.176-1.392-.021-1.82-.63a8.12 8.12 0 0 1-.704-1.218c-.315-.675-.111-1.422.363-1.891l.815-.806c.05-.048.098-.147.088-.294a6.214 6.214 0 0 1 0-.772c.01-.147-.038-.246-.088-.294l-.815-.806C.635 6.045.431 5.298.746 4.623a7.92 7.92 0 0 1 .704-1.217c.428-.61 1.176-.807 1.82-.63l1.102.302c.067.019.177.011.3-.071.214-.143.437-.272.668-.386.133-.066.194-.158.211-.224l.29-1.106C6.009.645 6.556.095 7.299.03 7.53.01 7.764 0 8 0Zm-.571 1.525c-.036.003-.108.036-.137.146l-.289 1.105c-.147.561-.549.967-.998 1.189-.173.086-.34.183-.5.29-.417.278-.97.423-1.529.27l-1.103-.303c-.109-.03-.175.016-.195.045-.22.312-.412.644-.573.99-.014.031-.021.11.059.19l.815.806c.411.406.562.957.53 1.456a4.709 4.709 0 0 0 0 .582c.032.499-.119 1.05-.53 1.456l-.815.806c-.081.08-.073.159-.059.19.162.346.353.677.573.989.02.03.085.076.195.046l1.102-.303c.56-.153 1.113-.008 1.53.27.161.107.328.204.501.29.447.222.85.629.997 1.189l.289 1.105c.029.109.101.143.137.146a6.6 6.6 0 0 0 1.142 0c.036-.003.108-.036.137-.146l.289-1.105c.147-.561.549-.967.998-1.189.173-.086.34-.183.5-.29.417-.278.97-.423 1.529-.27l1.103.303c.109.029.175-.016.195-.045.22-.313.411-.644.573-.99.014-.031.021-.11-.059-.19l-.815-.806c-.411-.406-.562-.957-.53-1.456a4.709 4.709 0 0 0 0-.582c-.032-.499.119-1.05.53-1.456l.815-.806c.081-.08.073-.159.059-.19a6.464 6.464 0 0 0-.573-.989c-.02-.03-.085-.076-.195-.046l-1.102.303c-.56.153-1.113.008-1.53-.27a4.44 4.44 0 0 0-.501-.29c-.447-.222-.85-.629-.997-1.189l-.289-1.105c-.029-.11-.101-.143-.137-.146a6.6 6.6 0 0 0-1.142 0ZM11 8a3 3 0 1 1-6 0 3 3 0 0 1 6 0ZM9.5 8a1.5 1.5 0 1 0-3.001.001A1.5 1.5 0 0 0 9.5 8Z"></path>
            </svg>
          </a>
          <a href="/user/updates" class="link updates" name="updates" title="Updates">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" fill="currentColor">
              <path d="M8 16a2 2 0 0 0 1.985-1.75c.017-.137-.097-.25-.235-.25h-3.5c-.138 0-.252.113-.235.25A2 2 0 0 0 8 16ZM3 5a5 5 0 0 1 10 0v2.947c0 .05.015.098.042.139l1.703 2.555A1.519 1.519 0 0 1 13.482 13H2.518a1.516 1.516 0 0 1-1.263-2.36l1.703-2.554A.255.255 0 0 0 3 7.947Zm5-3.5A3.5 3.5 0 0 0 4.5 5v2.947c0 .346-.102.683-.294.97l-1.703 2.556a.017.017 0 0 0-.003.01l.001.006c0 .002.002.004.004.006l.006.004.007.001h10.964l.007-.001.006-.004.004-.006.001-.007a.017.017 0 0 0-.003-.01l-1.703-2.554a1.745 1.745 0 0 1-.294-.97V5A3.5 3.5 0 0 0 8 1.5Z"></path>
            </svg>
            <!--<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" fill="currentColor">
              <path d="M9.504.43a1.516 1.516 0 0 1 2.437 1.713L10.415 5.5h2.123c1.57 0 2.346 1.909 1.22 3.004l-7.34 7.142a1.249 1.249 0 0 1-.871.354h-.302a1.25 1.25 0 0 1-1.157-1.723L5.633 10.5H3.462c-1.57 0-2.346-1.909-1.22-3.004L9.503.429Zm1.047 1.074L3.286 8.571A.25.25 0 0 0 3.462 9H6.75a.75.75 0 0 1 .694 1.034l-1.713 4.188 6.982-6.793A.25.25 0 0 0 12.538 7H9.25a.75.75 0 0 1-.683-1.06l2.008-4.418.003-.006a.036.036 0 0 0-.004-.009l-.006-.006-.008-.001c-.003 0-.006.002-.009.004Z"></path>
            </svg>-->
          </a>
          <a href="/search" class="link search" name="search" title="Search">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <circle cx="11.7666" cy="11.7667" r="8.98856" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
              <path d="M18.0183 18.4853L21.5423 22.0001" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
            </svg>
          </a>
        </div>
      `
      }
      else {
        return /* html */ `
        <div class="links">
          <a href="/join/login" class="link signin" name="logon">
            <span class="text">Sign in</span>
          </a>
          <a href="" class="link search" name="search" title="Search">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <circle cx="11.7666" cy="11.7667" r="8.98856" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" />
              <path d="M18.0183 18.4853L21.5423 22.0001" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" />
            </svg>
          </a>
        </div>
      `
      }
    }

    getTitle = (type, mql) => {
      const section = this.getAttribute('section');

      switch (type) {
        case 'home':
          return /*html*/`
          <div class="left home">
            <h3 class="name">${section}</h3>
          </div>
        `
        case 'user':
          if (mql) {
            return /*html*/`
            <div class="left user">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" fill="currentColor">
                <path d="M7.78 12.53a.75.75 0 0 1-1.06 0L2.47 8.28a.75.75 0 0 1 0-1.06l4.25-4.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042L4.81 7h7.44a.75.75 0 0 1 0 1.5H4.81l2.97 2.97a.75.75 0 0 1 0 1.06Z"></path>
              </svg>
              <h3 class="name">${section}</h3>
            </div>
          `
          }
          else {
            return /*html*/`
            <div class="left user">
              <h3 class="name">${section}</h3>
            </div>
          `
          }
        default:
          return /*html*/`
          <div class="left">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" fill="currentColor">
              <path d="M7.78 12.53a.75.75 0 0 1-1.06 0L2.47 8.28a.75.75 0 0 1 0-1.06l4.25-4.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042L4.81 7h7.44a.75.75 0 0 1 0 1.5H4.81l2.97 2.97a.75.75 0 0 1 0 1.06Z"></path>
            </svg>
            <h3 class="name">${section}</h3>
          </div>
        `
      }
    }

    getHome = () => {
      return /* html */ `
      <app-home url="/home" recent-url="/api/v1/h/recent" feeds-url="/api/v1/h/feeds"
        trending-people="/api/v1/q/trending/people" trending-url="/api/v1/h/trending">
      </app-home>
    `
    }

    getLogon = next => {
      return /* html */ `
      <app-logon
        name="join" next="${next}" api-login="/api/v1/a/login"
        api-register="/api/v1/a/register" api-check-email="/api/v1/a/check-email"
        api-forgot-password="/api/v1/a/forgot-password" api-verify-token="/api/v1/a/verify-token"
        api-reset-password="/api/v1/a/reset-password" join-url="/join" login="/join/login"
        register="/join/register" forgot="/join/recover">
        ${this.getNext()}
      </app-logon>
    `
    }

    getSearch = () => {
      return /* html */ `
      <app-search url="/search" query="" page="1" tab="stories" stories-url="/api/v1/q/stories"
        replies-url="/api/v1/q/replies" people-url="/api/v1/q/people" topics-url="/api/v1/q/topics"
        trending-stories="/api/v1/q/trending/stories" trending-people="/api/v1/q/trending/people"
        trending-topics="/api/v1/q/trending/topics" trending-replies="/api/v1/q/trending/replies">
      </app-search>
    `
    }

    getUser = (data, current) => {
      // console.log(data)
      if(!data) throw new Error("User not found");

      const url = `/u/${data.hash.toLowerCase()}`;
      const contact = data.contact ? JSON.stringify(data.contact) : null;
      let bio = data.bio ? data.bio : 'This user has not added a bio yet.';
      // replace all " and ' with &quot; and &apos; to avoid breaking the html
      bio = bio.replace(/"/g, '&quot;').replace(/'/g, '&apos;');

      return /*html*/ `
      <app-user hash="${data.hash}" home-url="/home" current="${current}" 
        verified="${data.verified}" email="${data.email}" stories-url="/api/v1${url}/stories" 
        replies-url="/api/v1${url}/replies" stories="${data.stories}" replies="${data.replies}"
        user-link="${data.contact?.link}" user-email="${data.contact?.email}" 
        user-x="${data.contact?.x}" user-threads="${data.contact?.threads}" user-linkedin="${data.contact?.linkedin}" 
        user-username="${data.hash}" user-you="true" user-url="${url}" user-img="${data.picture}"  user-verified="${data.verified}" 
        user-name="${data.name}" user-followers="${data.followers}" user-contact='${contact}' user-following="${data.following}" 
        user-follow="false" user-bio="${bio}">
      </app-user>
    `;
    }

    getStyles() {
      const kind = this.getAttribute('type');
      return /* css */`
      <style>
        *,
        *:after,
        *:before {
          box-sizing: border-box !important;
          font-family: inherit;
          -webkit-box-sizing: border-box !important;
        }

        *:focus {
          outline: inherit !important;
        }

        *::-webkit-scrollbar {
          -webkit-appearance: none;
        }

        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
          padding: 0;
          margin: 0;
          font-family: inherit;
        }

        p,
        ul,
        ol {
          padding: 0;
          margin: 0;
        }

        a {
          text-decoration: none;
        }

        :host {
          font-size: 16px;
          width: 100%;
          height: max-content;
          background-color: var(--background);
          gap: 0;
          display: block;
          position: sticky;
          top: 0;
          z-index: 10;
          margin: ${kind === 'story' ? '0' : '0 0 10px'};
        }

        nav.nav {
          border-bottom: var(--border);
          color: var(--title-color);
          display: flex;
          flex-flow: row;
          align-items: center;
          justify-content: space-between;
          width: 100%;
          gap: 10px;
          height: 60px;
          max-height: 60px;
          padding: 22px 0 8px;
        }

        nav.nav.short {
          border-bottom: none;
          max-height: 10px;
          padding: 0;
          margin: 0 0 10px;
        }

        nav.nav > .left {
          color: var(--title-color);
          display: flex;
          flex-flow: row;
          align-items: center;
          gap: 10px;
        }

        nav.nav > .left h3 {
          margin: 0;
          font-family: var(--font-main), sans-serif;
          font-size: 1.3rem;
          font-weight: 600;
        }

        nav.nav > .left.home h3 {
          margin: 0 0 -2px 0;
          padding: 0 0 0 2px;
          font-weight: 600;
          color: transparent;
          font-size: 1.5rem;
          background: var(--accent-linear);
          background-clip: text;
          -webkit-background-clip: text;
          font-family: var(--read-text);
        }

        nav.nav > .left svg {
          color: var(--title-color);
          cursor: pointer;
          width: 28px;
          height: 28px;
          margin: 0 0 0 -3px;
        }

        nav.nav > .left > svg:hover {
          color: var(--accent-color);
        }

        nav.nav > .links {
          padding: 0 10px 0 0;
          width: 100%;
          display: flex;
          align-items: center;
          justify-content: center;
          width: max-content;
          gap: 15px;
        }

        nav.nav > .links > a.link {
          text-decoration: none;
          color: var(--gray-color);
          display: flex;
          align-items: center;
          justify-content: center;
        }

        nav.nav > .links > a.link.updates:hover,
        nav.nav > .links > a.link.discover:hover,
        nav.nav > .links > a.link.profile:hover,
        nav.nav > .links > a.link.search:hover {
          transition: color 0.3s ease-in-out;
          -webkit-transition: color 0.3s ease-in-out;
          -moz-transition: color 0.3s ease-in-out;
          -ms-transition: color 0.3s ease-in-out;
          -o-transition: color 0.3s ease-in-out;
          color: var(--accent-color);
        }

        nav.nav > .links > a.link.active {
          transition: color 0.3s ease-in-out;
          -webkit-transition: color 0.3s ease-in-out;
          -moz-transition: color 0.3s ease-in-out;
          -ms-transition: color 0.3s ease-in-out;
          -o-transition: color 0.3s ease-in-out;
          color: var(--accent-color);
        }

        nav.nav > .links a.link.search a svg {
          margin: 0;
          width: 22px;
          height: 22px;
          margin: 0 0 -3px 0;
        }

        nav.nav > .links > a.link.discover > svg {
          width: 22px;
          height: 22px;
          margin: 1px 0 0 0;
        }

        nav.nav > .links > a.link.updates > svg{
          width: 23px;
          height: 23px;
          margin: 1px 0 0 0;
        }

        nav.nav > .links > a.link.profile > svg {
          width: 23px;
          height: 23px;
          margin: 1px 0 0 0;
        }

        nav.nav > .links > a.link.signin {
          border: var(--action-border);
          font-weight: 600;
          padding: 5px 15px 5px;
          font-family: var(--font-read);
          border-radius: 12px;
          -webkit-border-radius: 12px;
          -moz-border-radius: 12px;
          -ms-border-radius: 12px;
          -o-border-radius: 12px;
        }

        @media screen and (max-width: 660px) {
          :host {
            width: 100dvw;
            min-width: 100vw;
            font-size: 16px;
            margin: 0 -10px;
            padding: 0 10px;
          }

          nav.nav {
            border-bottom: var(--border);
            height: 50px;
            max-height: 50px;
            padding: 10px 0;
          }


          nav.nav > .left {
            gap: 5px;
            width: calc(100% - 130px);
          }

          nav.nav > .left h3 {
            margin: 0;
            font-family: var(--font-main), sans-serif;
            font-size: 1.2rem;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            width: 100%;
          }

          nav.nav > .links {
            width: 130px;
            padding: 0;
          }

          nav.nav > .links > a.link.signin {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
          }

          ::-webkit-scrollbar {
            -webkit-appearance: none;
          }

          a,
          nav.nav > .left svg,
          .stats > .stat {
            cursor: default !important;
          }
        }
      </style>
    `;
    }
  }

  class PersonWrapper extends HTMLElement {
    constructor() {
      // We are not even going to touch this.
      super();

      // check if the user is authenticated
      this._authenticated = window.hash ? true : false;

      // Check if user is the owner of the profile
      this._you = this.getAttribute('you') === 'true' ;

      // let's create our shadow root
      this.shadowObj = this.attachShadow({ mode: "open" });

      this.boundHandleWsMessage = this.handleWsMessage.bind(this);
      this.checkAndAddHandler = this.checkAndAddHandler.bind(this);

      this.render();
    }

    // observe the attributes
    static get observedAttributes() {
      return ['followers', 'user-follow', 'reload'];
    }

    render() {
      this.shadowObj.innerHTML = this.getTemplate();
    }

    // listen for changes in the attributes
    attributeChangedCallback(name, oldValue, newValue) {
      // get the follow button
      const followBtn = this.shadowObj.querySelector('button.action#follow-action');
      // check if old value is not equal to new value
      if (name === 'reload') {
        if(newValue === 'true') {
          this.setAttribute('reload', 'false');

          // Update the follow button
          if(followBtn) {
            this.updateFollowBtn(this.textToBoolean(this.getAttribute('user-follow')), followBtn);
          }
        }
      }  
    }

    connectedCallback() {
      // get url
      let url = this.getAttribute('url');

      url = url.trim().toLowerCase();

      // Check and add handler
      this.checkAndAddHandler();

      // Get the body
      const body = document.querySelector('body');

      this.handleUserClick(url, body);

      // Perform actions
      this.performActions();
    }

    checkAndAddHandler() {
      if (window.wss) {
        window.wss.addMessageHandler(this.boundHandleWsMessage);
        // console.log('WebSocket handler added successfully');
      } else {
        // console.log('WebSocket manager not available, retrying...');
        setTimeout(this.checkAndAddHandler, 500); // Retry after 500ms
      }
    }

    disconnectedCallback() {
      if (window.wss) {
        window.wss.removeMessageHandler(this.boundHandleWsMessage);
      }
    }

    handleWsMessage = message => {
      // Handle the message in this component
      // console.log('Message received in component:', message);
      const data = message.data;

      if (message.type !== 'action') return;

      const userHash = window.hash;
      const authorHash = this.getAttribute('hash').toUpperCase();

      if (data.action === 'connect' && data.kind === 'user') {
        this.handleConnectAction(data, userHash, authorHash);
      }
    }

    handleConnectAction = (data, userHash, authorHash) => {
      const to = data.hashes.to;
      if(to === authorHash) {
        const followers = this.parseToNumber(this.getAttribute('followers')) + data.value;
        this.setAttribute('followers', followers);

        if (data.hashes.from === userHash) {
          const value = data.value === 1 ? 'true' : 'false';
    
          // update user-follow/auth-follow attribute
          this.setAttribute('user-follow', value);
        }

        this.setAttribute('reload', 'true');
      }
    }

    sendWsMessage(data) {
      window.wss.sendMessage(data);
    }

    textToBoolean = text => {
      return text === 'true' ? true : false;
    }

    // Open user profile
    handleUserClick = (url, body) => {
      const outerThis = this;
      // get a.meta.link
      const content = this.shadowObj.querySelector('a#username');

      if(body && content) { 
        content.addEventListener('click', event => {
          event.preventDefault();

          // Get full post
          const profile =  this.getProfile();
          
          // replace and push states
          outerThis.replaceAndPushStates(url, body, profile);

          body.innerHTML = profile;
        });
      }
    }

    // Replace and push states
    replaceAndPushStates = (url, body, profile) => {
      // Replace the content with the current url and body content
      // get the first custom element in the body
      const firstElement = body.firstElementChild;

      // convert the custom element to a string
       const elementString = firstElement.outerHTML;
      // get window location
      const pageUrl = window.location.href;
      window.history.replaceState(
        { page: 'page', content: elementString },
        url, pageUrl
      );

      // Updating History State
      window.history.pushState(
        { page: 'page', content: profile},
        url, url
      );
    }

    // perform actions
    performActions = () => {
      const outerThis = this;
      // get body 
      const body = document.querySelector('body');

      // get url to 
      let hash = this.getAttribute('hash');
      // trim and convert to lowercase
      hash = hash.trim().toLowerCase();

      // base api
      const url = '/api/v1/u/' + hash;

      // Get the follow action and subscribe action
      const followBtn = this.shadowObj.querySelector('button.action#follow-action');

      // add event listener to the follow action
      if (followBtn) {
        // construct options
        const options = {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json',
          }
        };

        followBtn.addEventListener('click', e => {
          e.preventDefault();
          e.stopPropagation();

          let action = false;

          // Check if the user is authenticated
          if (!this._authenticated) {
            // Open the join popup
            this.openJoin(body);
          } 
          else {
            // Update the follow button
            if (followBtn.classList.contains('following')) {
              action = true;
              outerThis.updateFollowBtn(false, followBtn);
            }
            else {
              outerThis.updateFollowBtn(true, followBtn);
            }

            // Follow the topic
            this.followUser(`${url}/follow`, options, followBtn, action);
          }
        });
      }
    }

    followUser = (url, options, followBtn, followed) => {
      const outerThis = this;
      this.fetchWithTimeout(url, options)
        .then(response => {
          response.json()
          .then(data => {
            // If data has unverified, open the join popup
            if (data.unverified) {
              // Get body
              const body = document.querySelector('body');

              // Open the join popup
              outerThis.openJoin(body);

              // revert the follow button
              outerThis.updateFollowBtn(followed, followBtn);
            }

            // if success is false, show toast message
            if (!data.success) {
              outerThis.showToast(data.message, false);

              // revert the follow button
              outerThis.updateFollowBtn(followed, followBtn);
            }
            else {
              // Show toast message
              outerThis.showToast(data.message, true);

              // Check for followed boolean
              outerThis.updateFollowBtn(data.followed, followBtn);

              // Update the followers
              outerThis.updateFollowers(data.followed);
            }
          });
        })
        .catch(_error => {
          // console.log(_error);
          // show toast message
          outerThis.showToast('An error occurred!', false);

          // revert the follow button
          outerThis.updateFollowBtn(followed, followBtn);
        });
    }

    fetchWithTimeout = async (url, options = {}, timeout = 9500) => {
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), timeout);
    
      try {
        const response = await fetch(url, {
          ...options,
          signal: controller.signal
        });

        return response;
      } catch (error) {
        if (error.name === 'AbortError') {
          throw new Error('Request timed out');
        }
        throw new Error(`Network error: ${error.message}`);
      } finally {
        clearTimeout(timeoutId);
      }
    };

    updateFollowBtn = (following, btn) => {
      if (following) {
        // Change the text to following
        btn.textContent = 'following';

        // remove the follow class
        btn.classList.remove('follow');

        // add the following class
        btn.classList.add('following');
      }
      else {
        // Change the text to follow
        btn.textContent = 'follow';

        // remove the following class
        btn.classList.remove('following');

        // add the follow class
        btn.classList.add('follow');
      }
    }

    showToast = (text, success) => {
      // Get the toast element
      const toast = this.getToast(text, success);

      // Get body element
      const body = document.querySelector('body');

      // Insert the toast into the DOM
      body.insertAdjacentHTML('beforeend', toast);

      // Remove the toast after 3 seconds
      setTimeout(() => {
        // Select the toast element
        const toast = body.querySelector('.toast');

        // Remove the toast
        if(toast) {
          toast.remove();
        }
      }, 3000);
    }

    getToast = (text, success) => {
      if (success) {
        return /* html */`
        <div class="toast true">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" fill="currentColor">
          <path d="M8 16A8 8 0 1 1 8 0a8 8 0 0 1 0 16Zm3.78-9.72a.751.751 0 0 0-.018-1.042.751.751 0 0 0-1.042-.018L6.75 9.19 5.28 7.72a.751.751 0 0 0-1.042.018.751.751 0 0 0-.018 1.042l2 2a.75.75 0 0 0 1.06 0Z"></path>
        </svg>
          <p class="toast-message">${text}</p>
        </div>
      `;
      }
      else {
        return /* html */`
      <div class="toast false">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" fill="currentColor">
          <path d="M2.343 13.657A8 8 0 1 1 13.658 2.343 8 8 0 0 1 2.343 13.657ZM6.03 4.97a.751.751 0 0 0-1.042.018.751.751 0 0 0-.018 1.042L6.94 8 4.97 9.97a.749.749 0 0 0 .326 1.275.749.749 0 0 0 .734-.215L8 9.06l1.97 1.97a.749.749 0 0 0 1.275-.326.749.749 0 0 0-.215-.734L9.06 8l1.97-1.97a.749.749 0 0 0-.326-1.275.749.749 0 0 0-.734.215L8 6.94Z"></path>
        </svg>
          <p class="toast-message">${text}</p>
        </div>
      `;
      }
      
    }

    openJoin = body => {
      // Insert getJoin beforeend
      body.insertAdjacentHTML('beforeend', this.getJoin());
    }

    getJoin = () => {
      // get url from the : only the path
      const url = window.location.pathname;

      return /* html */`
      <join-popup register="/join/register" login="/join/login" next="${url}"></join-popup>
    `
    }

    updateFollowers = followed => {
      let value = followed ? 1 : -1;
      // Get followers attribute : convert to number then add value

      this.parseToNumber(this.getAttribute('followers')) + value;

      // Set the followers attribute
      // this.setAttribute('followers', followers.toString());
      // this.setAttribute('user-follow', followed.toString());
    }

    parseToNumber = num_str => {
      // Try parsing the string to an integer
      const num = parseInt(num_str);

      // Check if parsing was successful
      if (!isNaN(num)) {
        return num;
      } else {
        return 0;
      }
    }

    getTemplate() {
      // Show HTML Here
      return `
      ${this.getBody()}
      ${this.getStyles()}
    `;
    }

    getBody = () => {
      // Get name and check if it's greater than 20 characters
      const name = this.getAttribute('name');

      // GET url
      const url = this.getAttribute('url');

      // Check if the name is greater than 20 characters: replace the rest with ...
      let displayName = name.length > 17 ? `${name.substring(0, 17)}..` : name;

      return /*html*/`
      <div class="head">
        ${this.getPicture(this.getAttribute('picture'))}
        <div class="name">
          <h4 class="uid">${displayName}</h4>
          <a href="${url.toLowerCase()}" class="username" id="username">
            <span class="text">${this.getAttribute('hash')}</span>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" fill="currentColor">
              <path d="M4.53 4.75A.75.75 0 0 1 5.28 4h6.01a.75.75 0 0 1 .75.75v6.01a.75.75 0 0 1-1.5 0v-4.2l-5.26 5.261a.749.749 0 0 1-1.275-.326.749.749 0 0 1 .215-.734L9.48 5.5h-4.2a.75.75 0 0 1-.75-.75Z" />
            </svg>
          </a>
        </div>
      </div>
      ${this.checkYou(this.getAttribute('user-follow'))}
    `
    }

    getPicture = picture => {
      // check if picture is empty || null || === "null"
      if (picture === '' || picture === null || picture === 'null') {
        return /*html*/`
        <div class="avatar svg">
          <div class="svg-avatar">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
              <path d="M12 2.5a5.5 5.5 0 0 1 3.096 10.047 9.005 9.005 0 0 1 5.9 8.181.75.75 0 1 1-1.499.044 7.5 7.5 0 0 0-14.993 0 .75.75 0 0 1-1.5-.045 9.005 9.005 0 0 1 5.9-8.18A5.5 5.5 0 0 1 12 2.5ZM8 8a4 4 0 1 0 8 0 4 4 0 0 0-8 0Z"></path>
            </svg>
          </div>
          ${this.checkVerified(this.getAttribute('verified'))}
        </div>
      `
      }
      else {
        return /*html*/`
        <div class="avatar">
          <div class="img-avatar">
            <img class="img" src="${picture}" alt="Author picture"/>
          </div>
          ${this.checkVerified(this.getAttribute('verified'))}
        </div>
      `
      }
    }

    checkYou = following => {
      if (this._you) {
        return /*html*/`
        <button class="action you">You</button>
      `
      }
      else {
        return /*html*/`
        ${this.checkFollow(following)}
      `
      }
    }

    checkFollow = following => {
      if (following === 'true') {
        return /*html*/`
        <button class="action following" id="follow-action">following</button>
			`
      }
      else {
        return /*html*/`
        <button class="action follow" id="follow-action">follow</button>
			`
      }
    }

    checkVerified = verified => {
      if (verified === 'true') {
        return /*html*/`
        <svg width="26" height="26" viewBox="0 0 26 26" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M16.3592 1.41412C15.9218 0.966482 15.3993 0.610789 14.8224 0.367944C14.2455 0.125098 13.6259 0 13 0C12.3741 0 11.7545 0.125098 11.1776 0.367944C10.6007 0.610789 10.0782 0.966482 9.64079 1.41412L8.62993 2.45091L7.18354 2.43304C6.55745 2.42563 5.93619 2.54347 5.35631 2.77964C4.77642 3.01581 4.24962 3.36554 3.80687 3.80826C3.36413 4.25098 3.01438 4.77775 2.77819 5.3576C2.542 5.93744 2.42415 6.55866 2.43156 7.18472L2.44781 8.63102L1.41421 9.64181C0.966543 10.0792 0.610827 10.6017 0.367967 11.1785C0.125106 11.7554 0 12.3749 0 13.0008C0 13.6267 0.125106 14.2462 0.367967 14.8231C0.610827 15.3999 0.966543 15.9224 1.41421 16.3598L2.44944 17.3706L2.43156 18.8169C2.42415 19.443 2.542 20.0642 2.77819 20.644C3.01438 21.2239 3.36413 21.7506 3.80687 22.1934C4.24962 22.6361 4.77642 22.9858 5.35631 23.222C5.93619 23.4582 6.55745 23.576 7.18354 23.5686L8.62993 23.5523L9.64079 24.5859C10.0782 25.0335 10.6007 25.3892 11.1776 25.6321C11.7545 25.8749 12.3741 26 13 26C13.6259 26 14.2455 25.8749 14.8224 25.6321C15.3993 25.3892 15.9218 25.0335 16.3592 24.5859L17.3701 23.5507L18.8165 23.5686C19.4426 23.576 20.0638 23.4582 20.6437 23.222C21.2236 22.9858 21.7504 22.6361 22.1931 22.1934C22.6359 21.7506 22.9856 21.2239 23.2218 20.644C23.458 20.0642 23.5758 19.443 23.5684 18.8169L23.5522 17.3706L24.5858 16.3598C25.0335 15.9224 25.3892 15.3999 25.632 14.8231C25.8749 14.2462 26 13.6267 26 13.0008C26 12.3749 25.8749 11.7554 25.632 11.1785C25.3892 10.6017 25.0335 10.0792 24.5858 9.64181L23.5506 8.63102L23.5684 7.18472C23.5758 6.55866 23.458 5.93744 23.2218 5.3576C22.9856 4.77775 22.6359 4.25098 22.1931 3.80826C21.7504 3.36554 21.2236 3.01581 20.6437 2.77964C20.0638 2.54347 19.4426 2.42563 18.8165 2.43304L17.3701 2.44929L16.3592 1.41412Z" 
            fill="currentColor" id="top"/>
          <path d="M15.3256 4.97901C15.0228 4.6691 14.661 4.42285 14.2616 4.25473C13.8623 4.08661 13.4333 4 13 4C12.5667 4 12.1377 4.08661 11.7384 4.25473C11.339 4.42285 10.9772 4.6691 10.6744 4.97901L9.97457 5.69678L8.97322 5.68441C8.53977 5.67928 8.10967 5.76086 7.70821 5.92437C7.30675 6.08787 6.94204 6.32999 6.63553 6.63649C6.32901 6.94298 6.08688 7.30767 5.92336 7.70911C5.75985 8.11054 5.67826 8.54061 5.68339 8.97403L5.69464 9.97532L4.97907 10.6751C4.66914 10.9779 4.42288 11.3396 4.25475 11.739C4.08661 12.1383 4 12.5673 4 13.0006C4 13.4339 4.08661 13.8628 4.25475 14.2621C4.42288 14.6615 4.66914 15.0232 4.97907 15.326L5.69577 16.0258L5.68339 17.0271C5.67826 17.4605 5.75985 17.8906 5.92336 18.292C6.08688 18.6935 6.32901 19.0581 6.63553 19.3646C6.94204 19.6711 7.30675 19.9133 7.70821 20.0768C8.10967 20.2403 8.53977 20.3218 8.97322 20.3167L9.97457 
            20.3055L10.6744 21.021C10.9772 21.3309 11.339 21.5771 11.7384 21.7453C12.1377 21.9134 12.5667 22 13 22C13.4333 22 13.8623 21.9134 14.2616 21.7453C14.661 21.5771 15.0228 21.3309 15.3256 21.021L16.0254 20.3043L17.0268 20.3167C17.4602 20.3218 17.8903 20.2403 18.2918 20.0768C18.6932 19.9133 19.058 19.6711 19.3645 19.3646C19.671 19.0581 19.9131 18.6935 20.0766 18.292C20.2402 17.8906 20.3217 17.4605 20.3166 17.0271L20.3054 16.0258L21.0209 15.326C21.3309 15.0232 21.5771 14.6615 21.7453 14.2621C21.9134 13.8628 22 13.4339 22 13.0006C22 12.5673 21.9134 12.1383 21.7453 11.739C21.5771 11.3396 21.3309 10.9779 21.0209 10.6751L20.3042 9.97532L20.3166 8.97403C20.3217 8.54061 20.2402 8.11054 20.0766 7.70911C19.9131 7.30767 19.671 6.94298 19.3645 6.63649C19.058 6.32999 18.6932 6.08787 18.2918 5.92437C17.8903 5.76086 17.4602 5.67928 17.0268 5.68441L16.0254 5.69566L15.3256 4.97901ZM15.6485 11.7113L12.2732 15.0864C12.2209 15.1388 12.1588 15.1803 12.0905 15.2087C12.0222 15.2371 11.9489 15.2517 11.8749 15.2517C11.8009 15.2517 11.7276 15.2371 11.6593 15.2087C11.5909 15.1803 11.5289 15.1388 11.4766 15.0864L9.78893 13.3988C9.73662 13.3465 9.69513 13.2844 9.66683 13.2161C9.63852 13.1478 9.62395 13.0745 9.62395 13.0006C9.62395 12.9266 9.63852 12.8534 9.66683 12.785C9.69513 12.7167 9.73662 12.6546 9.78893 12.6023C9.84123 12.55 9.90333 12.5085 9.97166 12.4802C10.04 12.4519 10.1132 12.4373 10.1872 12.4373C10.2612 12.4373 10.3344 12.4519 10.4028 12.4802C10.4711 12.5085 10.5332 12.55 10.5855 12.6023L11.8749 13.8927L14.8519 10.9147C14.9576 10.8091 15.1008 10.7498 15.2502 10.7498C15.3996 10.7498 15.5429 10.8091 15.6485 10.9147C15.7542 11.0204 15.8135 11.1636 15.8135 11.313C15.8135 11.4624 15.7542 11.6056 15.6485 11.7113Z" 
            fill="currentColor" id="bottom"/>
        </svg>
			`
      }
      else {
        return ''
      }
    }

    getProfile = () => {
      // get url
      let url = this.getAttribute('url');
   
      // trim white spaces and convert to lowercase
      url = url.trim().toLowerCase();

     return /* html */`
      <app-profile tab="stories" you="${this.getAttribute('you')}" url="${url}" tab="stories"
        stories-url="/api/v1${url}/stories" replies-url="/api/v1${url}/replies" stories="${this.getAttribute('stories')}" replies="${this.getAttribute('replies')}"
        followers-url="/api/v1${url}/followers" following-url="/api/v1${url}/following"
        hash="${this.getAttribute('hash')}" picture="${this.getAttribute('picture')}" verified="${this.getAttribute('verified')}"
        name="${this.getAttribute('name')}" followers="${this.getAttribute('followers')}" contact='${this.getAttribute("contact")}'
        following="${this.getAttribute('following')}" user-follow="${this.getAttribute('user-follow')}" bio="${this.getAttribute('bio')}">
      </app-profile>
    `
    }

    getStyles() {
      return /* css */`
      <style>
        *,
        *:after,
        *:before {
          box-sizing: border-box !important;
          font-family: inherit;
          -webkit-box-sizing: border-box !important;
        }

        *:focus {
          outline: inherit !important;
        }

        *::-webkit-scrollbar {
          width: 3px;
        }

        *::-webkit-scrollbar-track {
          background: var(--scroll-bar-background);
        }

        *::-webkit-scrollbar-thumb {
          width: 3px;
          background: var(--scroll-bar-linear);
          border-radius: 50px;
        }

        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
          padding: 0;
          margin: 0;
          font-family: inherit;
        }

        p,
        ul,
        ol {
          padding: 0;
          margin: 0;
        }

        a {
          text-decoration: none;
        }

        :host {
          font-size: 16px;
          border: none;
          background-color: var(--user-background);
          padding: 14px;
          width: 156px;
          min-width: 156px;
          height: 204px;
          max-height: 204px;
          display: flex;
          flex-flow: column;
          align-items: center;
          justify-content: space-between;
          gap: 0;
          border-radius: 16px;
        }

        .head {
          display: flex;
          flex-flow: column;
          flex-wrap: nowrap;
          align-items: center;
          justify-content: center;
          gap: 10px;
        }

        .head > .avatar {
          position: relative;
          width: 80px;
          height: 80px;
          display: flex;
          align-items: center;
          justify-content: center;
          border-radius: 50px;
          -webkit-border-radius: 50px;
          -moz-border-radius: 50px;
        }

        .head > .avatar > .img-avatar {
          width: 100%;
          height: 100%;
          overflow: hidden;
          display: flex;
          align-items: center;
          justify-content: center;
          border-radius: 50px;
          -webkit-border-radius: 50px;
          -moz-border-radius: 50px;
        }

        .head > .avatar > .img-avatar > img.img {
          width: 100%;
          height: 100%;
          overflow: hidden;
          object-fit: cover;
          border-radius: 50px;
          -webkit-border-radius: 50px;
          -moz-border-radius: 50px;
        }


        .head > .avatar.svg {
          background: var(--gray-background);
        }

        .head > .avatar > .svg-avatar {
          width: 100%;
          height: 100%;
          display: flex;
          align-items: center;
          justify-content: center;
          border-radius: 50px;
          -webkit-border-radius: 50px;
          -moz-border-radius: 50px;
        }

        .head > .avatar > .svg-avatar svg {
          display: inline-block;
          width: 40px;
          height: 40px;
          color: var(--gray-color);
          margin: 0 0 3px 0;
        }

        .head > .avatar > svg {
          position: absolute;
          bottom: 0px;
          right: -2px;
          width: 30px;
          height: 30px;
          z-index: 1;
          display: flex;
          align-items: center;
          justify-content: center;
          border-radius: 50%;
          color: var(--user-background);
        }

        .head > .avatar > svg path#top {
          color: var(--user-background);
        }
        
        .head > .avatar > svg path#bottom {
          color: var(--accent-color);
        }

        .head > .name {
          padding: 0;
          display: flex;
          flex-flow: column;
          align-items: center;
          justify-content: center;
          flex-wrap: nowrap;
          gap:  0;
          position: relative;
        }

        .head > .name h4.uid {
          color: var(--text-color);
          font-family: var(--font-text), sans serif;
          font-weight: 500;
          font-size: 0.9rem;
          white-space: nowrap;
          overflow: hidden;
        }

        .name > a.username {
          color: var(--gray-color);
          font-family: var(--font-mono), monospace;
          font-size: 0.8rem;
          font-weight: 500;
          text-decoration: none;
          display: flex;
          gap: 2px;
          align-items: center;
        }
        
        .name > a.username svg {
          color: var(--gray-color);
          width: 15px;
          height: 15px;
          margin: 2px 0 0 0;
        }
        
        .name > a.username:hover {
          color: transparent;
          background: var(--accent-linear);
          background-clip: text;
          -webkit-background-clip: text;
        }
        
        .name > a.username:hover svg {
          color: var(--accent-color);
        }

        button.action {
          display: flex;
          align-items: center;
          justify-content: center;
          padding: 5px 10px 6px;
          height: max-content;
          width: 120px;
          border-radius: 10px;
          -webkit-border-radius: 10px;
          -moz-border-radius: 10px;
          background-color: var(--action-background);
          color: var(--white-color);
          font-weight: 500;
          font-size: 0.9rem;
          line-height: 1.3;
          font-weight: 500;
          font-family: var(--font-text), sans-serif;
          cursor: pointer;
          outline: none;
          border: none;
          text-transform: capitalize;
        }

        button.action.you {
          background-color: var(--gray-background);
          width: max-content;
        }
        
        button.action.following {
          background: none;
          padding: 5px 10px 5.5px;
          border: var(--border-mobile);
          color: var(--text-color);
          font-weight: 400;
          font-size: 0.9rem;
        } 

        @media screen and (max-width:660px) {
          :host {
            font-size: 16px;
          }

          .action,
          a {
            cursor: default !important;
          }
      </style>
    `;
    }
  }

  class ProfileWrapper extends HTMLElement {
    constructor() {
      // We are not even going to touch this.
      super();

      // check if the user is authenticated
      this._authenticated = window.hash ? true : false;

      // Get if the user is the current user
      this._you = this.getAttribute('you') === 'true';

      // let's create our shadow root
      this.shadowObj = this.attachShadow({ mode: "open" });

      this.parent = this.getRootNode().host;

      this.render();
    }

    // observe the attributes
    static get observedAttributes() {
      return ['followers', 'user-follow', 'reload'];
    }

    render() {
      this.shadowObj.innerHTML = this.getTemplate();
    }

    // listen for changes in the attributes
    attributeChangedCallback(name, oldValue, newValue) {
      // check if old value is not equal to new value
      if (name==='reload' && newValue === 'true') {
        this.setAttribute('reload', 'false');
        // get the followers element
        const followers = this.shadowObj.querySelector('.stats > span.followers > .number');

        // Update the followers
        if(followers) {
          const totalFollowers = this.parseToNumber(this.getAttribute('followers'));
          followers.textContent = totalFollowers >= 0 ? this.formatNumber(totalFollowers) : '0';
        }

        // get the follow button
        const followBtn = this.shadowObj.querySelector('.actions > .action#follow-action');

        // Update the follow button
        if(followBtn) {
          this.updateFollowBtn(this.textToBoolean(this.getAttribute('user-follow')), followBtn);
        }
      }  
    }

    connectedCallback() {
      const body = document.querySelector('body');

      // perform actions
      this.performActions();

      // open highlights
      this.openHighlights();
      this.openContact();
      this.openSettings(body);
    }

    textToBoolean = text => {
      return text === 'true' ? true : false;
    }

    setAttributes = (name, value) => {
      this.parent.setAttribute(name, value);
    }

     disableScroll() {
      // Get the current page scroll position
      let scrollTop = window.scrollY || document.documentElement.scrollTop;
      let scrollLeft = window.scrollX || document.documentElement.scrollLeft;
      document.body.classList.add("stop-scrolling");

      // if any scroll is attempted, set this to the previous value
      window.onscroll = function () {
        window.scrollTo(scrollLeft, scrollTop);
      };
    }

    enableScroll() {
      document.body.classList.remove("stop-scrolling");
      window.onscroll = function () { };
    }

    // Open user profile
    openSettings = (body) => {
      const outerThis = this;
      // get a.meta.link
      const content = this.shadowObj.querySelector('.actions > a.action.edit');

      if(body && content) { 
        content.addEventListener('click', event => {
          event.preventDefault();

          const url = content.getAttribute('href');

          try {
            const profile =  outerThis.getEdit();
          
            // replace and push states
            outerThis.replaceAndPushStates(url, body, profile);
            body.innerHTML = profile;
          } catch (error) {
            window.location.href = url;
          }
        });
      }
    }

    replaceAndPushStates = (url, body, profile) => {
      // Replace the content with the current url and body content
      // get the first custom element in the body
      const firstElement = body.firstElementChild;

      // convert the custom element to a string
      const elementString = firstElement.outerHTML;
      // get window location
      const pageUrl = window.location.href;
      window.history.replaceState(
        { page: 'page', content: elementString },
        url, pageUrl
      );

      // Updating History State
      window.history.pushState(
        { page: 'page', content: profile},
        url, url
      );
    }

    openHighlights = () => {
      // Get body
      const body = document.querySelector('body');
      // Get the stats action and subscribe action
      const statsBtn = this.shadowObj.querySelector('.actions>.action#highlights-action');

      // add event listener to the stats action
      if (statsBtn) {
        statsBtn.addEventListener('click', e => {
          e.preventDefault();
          e.stopPropagation();

          // Open the highlights popup
          body.insertAdjacentHTML('beforeend', this.getHighlights());
        });
      }
    }

    openContact = () => {
      // Get body
      const body = document.querySelector('body');
      // Get the social action and subscribe action
      const socialBtn = this.shadowObj.querySelector('.actions>.action#socials-action');

      // add event listener to the social action
      if (socialBtn) {
        socialBtn.addEventListener('click', e => {
          e.preventDefault();
          e.stopPropagation();

          // Open the highlights popup
          body.insertAdjacentHTML('beforeend', this.getContact());
        });
      }
    }

    // perform actions
    performActions = () => {
      const outerThis = this;
      // get body 
      const body = document.querySelector('body');

      // get url to 
      let hash = this.getAttribute('hash');
      // trim and convert to lowercase
      hash = hash.trim().toLowerCase();

      // base api
      const url = '/api/v1/u/' + hash;

      // Get the follow action and subscribe action
      const followBtn = this.shadowObj.querySelector('.actions>.action#follow-action');

      // add event listener to the follow action
      if (followBtn) {
        // construct options
        const options = {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json',
          }
        };

        followBtn.addEventListener('click', e => {
          e.preventDefault();
          e.stopPropagation();

          let action = false;

          // Check if the user is authenticated
          if (!this._authenticated) {
            // Open the join popup
            this.openJoin(body);
          } 
          else {
            // Update the follow button
            if (followBtn.classList.contains('following')) {
              action = true;
              outerThis.updateFollowBtn(false, followBtn);
            }
            else {
              outerThis.updateFollowBtn(true, followBtn);
            }

            // Follow the topic
            this.followUser(`${url}/follow`, options, followBtn, action);
          }
        });
      }
    }

    followUser = (url, options, followBtn, followed) => {
      const outerThis = this;
      this.fetchWithTimeout(url, options)
        .then(response => {
          response.json()
          .then(data => {
            // If data has unverified, open the join popup
            if (data.unverified) {
              // Get body
              const body = document.querySelector('body');

              // Open the join popup
              outerThis.openJoin(body);

              // revert the follow button
              outerThis.updateFollowBtn(followed, followBtn);
            }

            // if success is false, show toast message
            if (!data.success) {
              outerThis.showToast(data.message, false);

              // revert the follow button
              outerThis.updateFollowBtn(followed, followBtn);
            }
            else {
              // Show toast message
              outerThis.showToast(data.message, true);

              // Check for followed boolean
              outerThis.updateFollowBtn(data.followed, followBtn);

              // Update the followers
              // outerThis.updateFollowers(data.followed);
            }
          });
        })
        .catch(_error => {
          // console.log(_error);
          // show toast message
          outerThis.showToast('An error occurred!', false);

          // revert the follow button
          outerThis.updateFollowBtn(followed, followBtn);
        });
    }

    fetchWithTimeout = async (url, options = {}, timeout = 9500) => {
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), timeout);
    
      try {
        const response = await fetch(url, {
          ...options,
          signal: controller.signal
        });

        return response;
      } catch (error) {
        if (error.name === 'AbortError') {
          throw new Error('Request timed out');
        }
        throw new Error(`Network error: ${error.message}`);
      } finally {
        clearTimeout(timeoutId);
      }
    };

    updateFollowBtn = (following, btn) => {
      if (following) {
        // Change the text to following
        btn.textContent = 'following';

        // remove the follow class
        btn.classList.remove('follow');

        // add the following class
        btn.classList.add('following');
      }
      else {
        // Change the text to follow
        btn.textContent = 'follow';

        // remove the following class
        btn.classList.remove('following');

        // add the follow class
        btn.classList.add('follow');
      }
    }

    showToast = (text, success) => {
      // Get the toast element
      const toast = this.getToast(text, success);

      // Get body element
      const body = document.querySelector('body');

      // Insert the toast into the DOM
      body.insertAdjacentHTML('beforeend', toast);

      // Remove the toast after 3 seconds
      setTimeout(() => {
        // Select the toast element
        const toast = body.querySelector('.toast');

        // Remove the toast
        if(toast) {
          toast.remove();
        }
      }, 3000);
    }

    getToast = (text, success) => {
      if (success) {
        return /* html */`
        <div class="toast true">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" fill="currentColor">
          <path d="M8 16A8 8 0 1 1 8 0a8 8 0 0 1 0 16Zm3.78-9.72a.751.751 0 0 0-.018-1.042.751.751 0 0 0-1.042-.018L6.75 9.19 5.28 7.72a.751.751 0 0 0-1.042.018.751.751 0 0 0-.018 1.042l2 2a.75.75 0 0 0 1.06 0Z"></path>
        </svg>
          <p class="toast-message">${text}</p>
        </div>
      `;
      }
      else {
        return /* html */`
      <div class="toast false">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" fill="currentColor">
          <path d="M2.343 13.657A8 8 0 1 1 13.658 2.343 8 8 0 0 1 2.343 13.657ZM6.03 4.97a.751.751 0 0 0-1.042.018.751.751 0 0 0-.018 1.042L6.94 8 4.97 9.97a.749.749 0 0 0 .326 1.275.749.749 0 0 0 .734-.215L8 9.06l1.97 1.97a.749.749 0 0 0 1.275-.326.749.749 0 0 0-.215-.734L9.06 8l1.97-1.97a.749.749 0 0 0-.326-1.275.749.749 0 0 0-.734.215L8 6.94Z"></path>
        </svg>
          <p class="toast-message">${text}</p>
        </div>
      `;
      }
      
    }

    openJoin = body => {
      // Insert getJoin beforeend
      body.insertAdjacentHTML('beforeend', this.getJoin());
    }

    getJoin = () => {
      // get url from the : only the path
      const url = window.location.pathname;

      return /* html */`
      <join-popup register="/join/register" login="/join/login" next="${url}"></join-popup>
    `
    }

    updateFollowers = (followed) => {
      const outerThis = this;
      let value = followed ? 1 : -1;
      // Get followers attribute : convert to number then add value

      let followers = this.parseToNumber(this.getAttribute('followers')) + value;

      // if followers is less than 0, set it to 0
      followers = followers < 0 ? 0 : followers;

      // set user follow attribute
      this.setAttribute('user-follow', followed.toString());

      // Set the followers attribute
      // this.setAttribute('followers', followers.toString());

      // this.setAttributes('followers', followers)

      this.setAttributes('user-follow', followed.toString());

      // select the followers element
      const followersStat = outerThis.shadowObj.querySelector('.stats > span.followers');
      if (followersStat) {
        // select no element
        const no = followersStat.querySelector('.number');
        const text = followersStat.querySelector('.label');

        // Update the followers
        no.textContent = this.formatNumber(followers);

        // Update the text
        text.textContent = followers === 1 ? 'follower' : 'followers';
      }
    }

    formatNumber = n => {
      if (n >= 0 && n <= 999) {
        return n.toString();
      } else if (n >= 1000 && n <= 9999) {
        const value = (n / 1000).toFixed(2);
        return `${value}k`;
      } else if (n >= 10000 && n <= 99999) {
        const value = (n / 1000).toFixed(1);
        return `${value}k`;
      } else if (n >= 100000 && n <= 999999) {
        const value = (n / 1000).toFixed(0);
        return `${value}k`;
      } else if (n >= 1000000 && n <= 9999999) {
        const value = (n / 1000000).toFixed(2);
        return `${value}M`;
      } else if (n >= 10000000 && n <= 99999999) {
        const value = (n / 1000000).toFixed(1);
        return `${value}M`;
      } else if (n >= 100000000 && n <= 999999999) {
        const value = (n / 1000000).toFixed(0);
        return `${value}M`;
      } else if (n >= 1000000000) {
        return "1B+";
      }
      else {
        return 0;
      }
    }

    parseToNumber = num_str => {
      // Try parsing the string to an integer
      const num = parseInt(num_str);

      // Check if parsing was successful
      if (!isNaN(num)) {
        return num;
      } else {
        return 0;
      }
    }

    getTemplate = () => {
      // Show HTML Here
      return `
      ${this.getContent()}
      ${this.getStyles()}
    `;
    }

    getContent = () => {
      return /* html */`
      ${this.getHeader()}
      ${this.getBio()}
      ${this.getActions()}
		`
    }

    getHeader = () => {
      // Get name and check if it's greater than 20 characters
      const name = this.getAttribute('name');

      // Check if the name is greater than 20 characters: replace the rest with ...
      let displayName = name.length > 25 ? `${name.substring(0, 25)}..` : name;

      return /* html */ `
      <div class="top">
        ${this.getPicture(this.getAttribute('picture'))}
        <div class="info">
          <div class="name">
            <h4 class="name">
              <span class="name">${displayName}</span>
            </h4>
            <span class="username">
              <span class="text">${this.getAttribute('hash')}</span>
            </span>
          </div>
          ${this.getStats()}
        </div>
      </div>
    `
    }

    getPicture = picture => {
      // check if picture is empty || null || === "null"
      if (picture === '' || picture === null || picture === 'null') {
        return /*html*/`
        <div class="avatar svg">
          <div class="svg-avatar">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
              <path d="M12 2.5a5.5 5.5 0 0 1 3.096 10.047 9.005 9.005 0 0 1 5.9 8.181.75.75 0 1 1-1.499.044 7.5 7.5 0 0 0-14.993 0 .75.75 0 0 1-1.5-.045 9.005 9.005 0 0 1 5.9-8.18A5.5 5.5 0 0 1 12 2.5ZM8 8a4 4 0 1 0 8 0 4 4 0 0 0-8 0Z"></path>
            </svg>
          </div>
          ${this.checkVerified(this.getAttribute('verified'))}
        </div>
      `
      }
      else {
        return /*html*/`
        <div class="avatar">
          <img src="${picture}" alt="Author picture">
          ${this.checkVerified(this.getAttribute('verified'))}
        </div>
      `
      }
    }

    checkVerified = verified => {
      if (verified === 'true') {
        return /*html*/`
        <svg width="26" height="26" viewBox="0 0 26 26" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M16.3592 1.41412C15.9218 0.966482 15.3993 0.610789 14.8224 0.367944C14.2455 0.125098 13.6259 0 13 0C12.3741 0 11.7545 0.125098 11.1776 0.367944C10.6007 0.610789 10.0782 0.966482 9.64079 1.41412L8.62993 2.45091L7.18354 2.43304C6.55745 2.42563 5.93619 2.54347 5.35631 2.77964C4.77642 3.01581 4.24962 3.36554 3.80687 3.80826C3.36413 4.25098 3.01438 4.77775 2.77819 5.3576C2.542 5.93744 2.42415 6.55866 2.43156 7.18472L2.44781 8.63102L1.41421 9.64181C0.966543 10.0792 0.610827 10.6017 0.367967 11.1785C0.125106 11.7554 0 12.3749 0 13.0008C0 13.6267 0.125106 14.2462 0.367967 14.8231C0.610827 15.3999 0.966543 15.9224 1.41421 16.3598L2.44944 17.3706L2.43156 18.8169C2.42415 19.443 2.542 20.0642 2.77819 20.644C3.01438 21.2239 3.36413 21.7506 3.80687 22.1934C4.24962 22.6361 4.77642 22.9858 5.35631 23.222C5.93619 23.4582 6.55745 23.576 7.18354 23.5686L8.62993 23.5523L9.64079 24.5859C10.0782 25.0335 10.6007 25.3892 11.1776 25.6321C11.7545 25.8749 12.3741 26 13 26C13.6259 26 14.2455 25.8749 14.8224 25.6321C15.3993 25.3892 15.9218 25.0335 16.3592 24.5859L17.3701 23.5507L18.8165 23.5686C19.4426 23.576 20.0638 23.4582 20.6437 23.222C21.2236 22.9858 21.7504 22.6361 22.1931 22.1934C22.6359 21.7506 22.9856 21.2239 23.2218 20.644C23.458 20.0642 23.5758 19.443 23.5684 18.8169L23.5522 17.3706L24.5858 16.3598C25.0335 15.9224 25.3892 15.3999 25.632 14.8231C25.8749 14.2462 26 13.6267 26 13.0008C26 12.3749 25.8749 11.7554 25.632 11.1785C25.3892 10.6017 25.0335 10.0792 24.5858 9.64181L23.5506 8.63102L23.5684 7.18472C23.5758 6.55866 23.458 5.93744 23.2218 5.3576C22.9856 4.77775 22.6359 4.25098 22.1931 3.80826C21.7504 3.36554 21.2236 3.01581 20.6437 2.77964C20.0638 2.54347 19.4426 2.42563 18.8165 2.43304L17.3701 2.44929L16.3592 1.41412Z" 
            fill="currentColor" id="top"/>
          <path d="M15.3256 4.97901C15.0228 4.6691 14.661 4.42285 14.2616 4.25473C13.8623 4.08661 13.4333 4 13 4C12.5667 4 12.1377 4.08661 11.7384 4.25473C11.339 4.42285 10.9772 4.6691 10.6744 4.97901L9.97457 5.69678L8.97322 5.68441C8.53977 5.67928 8.10967 5.76086 7.70821 5.92437C7.30675 6.08787 6.94204 6.32999 6.63553 6.63649C6.32901 6.94298 6.08688 7.30767 5.92336 7.70911C5.75985 8.11054 5.67826 8.54061 5.68339 8.97403L5.69464 9.97532L4.97907 10.6751C4.66914 10.9779 4.42288 11.3396 4.25475 11.739C4.08661 12.1383 4 12.5673 4 13.0006C4 13.4339 4.08661 13.8628 4.25475 14.2621C4.42288 14.6615 4.66914 15.0232 4.97907 15.326L5.69577 16.0258L5.68339 17.0271C5.67826 17.4605 5.75985 17.8906 5.92336 18.292C6.08688 18.6935 6.32901 19.0581 6.63553 19.3646C6.94204 19.6711 7.30675 19.9133 7.70821 20.0768C8.10967 20.2403 8.53977 20.3218 8.97322 20.3167L9.97457 
            20.3055L10.6744 21.021C10.9772 21.3309 11.339 21.5771 11.7384 21.7453C12.1377 21.9134 12.5667 22 13 22C13.4333 22 13.8623 21.9134 14.2616 21.7453C14.661 21.5771 15.0228 21.3309 15.3256 21.021L16.0254 20.3043L17.0268 20.3167C17.4602 20.3218 17.8903 20.2403 18.2918 20.0768C18.6932 19.9133 19.058 19.6711 19.3645 19.3646C19.671 19.0581 19.9131 18.6935 20.0766 18.292C20.2402 17.8906 20.3217 17.4605 20.3166 17.0271L20.3054 16.0258L21.0209 15.326C21.3309 15.0232 21.5771 14.6615 21.7453 14.2621C21.9134 13.8628 22 13.4339 22 13.0006C22 12.5673 21.9134 12.1383 21.7453 11.739C21.5771 11.3396 21.3309 10.9779 21.0209 10.6751L20.3042 9.97532L20.3166 8.97403C20.3217 8.54061 20.2402 8.11054 20.0766 7.70911C19.9131 7.30767 19.671 6.94298 19.3645 6.63649C19.058 6.32999 18.6932 6.08787 18.2918 5.92437C17.8903 5.76086 17.4602 5.67928 17.0268 5.68441L16.0254 5.69566L15.3256 4.97901ZM15.6485 11.7113L12.2732 15.0864C12.2209 15.1388 12.1588 15.1803 12.0905 15.2087C12.0222 15.2371 11.9489 15.2517 11.8749 15.2517C11.8009 15.2517 11.7276 15.2371 11.6593 15.2087C11.5909 15.1803 11.5289 15.1388 11.4766 15.0864L9.78893 13.3988C9.73662 13.3465 9.69513 13.2844 9.66683 13.2161C9.63852 13.1478 9.62395 13.0745 9.62395 13.0006C9.62395 12.9266 9.63852 12.8534 9.66683 12.785C9.69513 12.7167 9.73662 12.6546 9.78893 12.6023C9.84123 12.55 9.90333 12.5085 9.97166 12.4802C10.04 12.4519 10.1132 12.4373 10.1872 12.4373C10.2612 12.4373 10.3344 12.4519 10.4028 12.4802C10.4711 12.5085 10.5332 12.55 10.5855 12.6023L11.8749 13.8927L14.8519 10.9147C14.9576 10.8091 15.1008 10.7498 15.2502 10.7498C15.3996 10.7498 15.5429 10.8091 15.6485 10.9147C15.7542 11.0204 15.8135 11.1636 15.8135 11.313C15.8135 11.4624 15.7542 11.6056 15.6485 11.7113Z" 
            fill="currentColor" id="bottom"/>
        </svg>
			`
      }
      else {
        return ''
      }
    }

    getStats = () => {
      // Get total followers & following and parse to integer
      const followers = this.getAttribute('followers') || 0;
      const following = this.getAttribute('following') || 0;

      // Convert the followers & following to a number
      const totalFollowers = this.parseToNumber(followers);
      const totalFollowing = this.parseToNumber(following);

      //  format the number
      const followersFormatted = this.formatNumber(totalFollowers);
      const followingFormatted = this.formatNumber(totalFollowing);


      return /* html */`
      <div class="stats">
        <span class="stat followers">
          <span class="number">${followersFormatted}</span>
          <span class="label">${totalFollowers === 1 ? 'follower' : 'followers'}</span>
        </span>
        <span class="sp">•</span>
        <span class="stat following">
          <span class="number">${followingFormatted}</span>
          <span class="label">following</span>
        </span>
      </div>
		`
    }

    getBio = () => {
      // Get bio content
      let bio = this.getAttribute('bio') || 'The user has not added a bio yet';

      /// trim white spaces
      bio = bio.trim();

      // separate by new lines
      const bioArray = bio.split('\n');

      // trim each line and ignore empty lines
      const bioLines = bioArray.map(line => line.trim()).filter(line => line !== '').map(line => `<p>${line}</p>`).join('');

      return /*html*/`
      <div class="bio">
        ${bioLines}
      </div>
    `
    }

    getActions = () => {
      // You is true
      if (this._you) {
        return /*html*/`
        <div class="actions">
          <span class="action highlights" id="highlights-action">stats</span>
          <a href="/user/name" class="action edit" id="edit-action">Edit</a>
          <span class="action socials" id="socials-action">socials</span>
        </div>
      `
      }
      else {
        return /*html*/`
        <div class="actions">
          <span class="action highlights" id="highlights-action">stats</span>
          ${this.checkFollowing(this.getAttribute('user-follow'))}
          <span class="action socials" id="socials-action">socials</span>
        </div>
      `
      }
    }

    checkFollowing = following => {
      if (following === 'true') {
        return /*html*/`
			  <span class="action following" id="follow-action">Following</span>
			`
      }
      else {
        return /*html*/`
			  <span class="action follow" id="follow-action">Follow</span>
			`
      }
    }

    getHighlights = () => {
      // get url
      const url = this.getAttribute('url');
    
      // trim white spaces and convert to lowercase
      let formattedUrl = url.toLowerCase();

      return /* html */`
      <stats-popup url="/api/v1${formattedUrl}/stats" name="${this.getAttribute('name')}"
        followers="${this.getAttribute('followers')}" following="${this.getAttribute('following')}" 
        stories="${this.getAttribute('stories')}" replies="${this.getAttribute('replies')}">
      </stats-popup>
    `
    }

    getContact = () => {
      // get url
      const url = this.getAttribute('url');
    
      // trim white spaces and convert to lowercase
      let formattedUrl = url.toLowerCase();

      return /* html */`
      <contact-popup url="/api/v1${formattedUrl}/contact" name="${this.getAttribute('name')}" contact='${this.getAttribute("contact")}'></contact-popup>
    `
    }

    getEdit = () => {
      const url = this.getAttribute('url');
      const str = this.getAttribute('contact');
      let contact= {};
      if (str !== null || str !== '' || str !== 'null') {
        try {
          contact = JSON.parse(str);
        }
        catch (error) {
          contact = {};
        }
      }
      let bio = this.getAttribute('author-bio') || 'This author has not provided a bio yet.';
      // replace all " and ' with &quot; and &apos; to avoid breaking the html
      bio = bio.replace(/"/g, '&quot;').replace(/'/g, '&apos;');
      return /*html*/`
      <app-user hash="${this.getAttribute('hash')}" home-url="/home" current="name" verified="${this.getAttribute('verified')}"
        stories-url="/api/v1${url}/stories" replies-url="/api/v1${url}/replies" stories="${this.getAttribute('stories')}" replies="${this.getAttribute('replies')}" 
        user-link="${contact?.link ? contact.link : ''}" user-email="${contact?.email ? contact.email : ''}" user-x="${contact?.x ? contact.x : ''}" 
        user-threads="${contact?.threads ? contact.threads : ''}" user-linkedin="${contact.linkedin ? contact.linkedin : ''}" email="${contact?.email ? contact.email : ''}" 
        user-username="${this.getAttribute('hash')}" user-contact='${str}'
        user-you="true" user-url="${url}" user-img="${this.getAttribute('picture')}" user-verified="${this.getAttribute('verified')}"
        user-name="${this.getAttribute('name')}" user-followers="${this.getAttribute('followers')}" user-following="${this.getAttribute('following')}"
        user-follow="${this.getAttribute('user-follow')}" user-bio="${bio}">
      </app-user>
    `
    }

    getStyles() {
      return /* css */`
      <style>
        *,
        *:after,
        *:before {
          box-sizing: border-box !important;
          font-family: inherit;
          -webkit-box-sizing: border-box !important;
        }

        *:focus {
          outline: inherit !important;
        }

        *::-webkit-scrollbar {
          -webkit-appearance: none;
        }

        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
          padding: 0;
          margin: 0;
          font-family: inherit;
        }

        p,
        ul,
        ol {
          padding: 0;
          margin: 0;
        }

        a {
          text-decoration: none;
        }

        :host {
          font-size: 16px;
          padding: 0;
          width: 100%;
          min-width: 100%;
          display: flex;
          flex-flow: column;
          align-items: start;
          gap: 0px;
        }

        .top {
          display: flex;
          width: 100%;
          flex-flow: row;
          align-items: center;
          gap: 8px;
        }

        .top > .avatar {
          position: relative;
          display: flex;
          align-items: center;
          justify-content: center;
          width: 100px;
          height: 100px;
          min-width: 100px;
          min-height: 100px;
          border-radius: 50%;
          -webkit-border-radius: 50%;
          -moz-border-radius: 50%;
        }

        .top > .avatar.svg {
          background: var(--gray-background);
        }

        .top > .avatar > .svg-avatar {
          display: flex;
          align-items: center;
          justify-content: center;
          width: 100%;
          height: 100%;
          border-radius: 50%;
          -webkit-border-radius: 50%;
          -moz-border-radius: 50%;
        }

        .top > .avatar > .svg-avatar svg {
          width: 50px;
          height: 50px;
          color: var(--gray-color);
          display: inline-block;
          margin: 0 0 5px 0;
        }

        .top > .avatar > img {
          width: 99px;
          height: 99px;
          object-fit: cover;
          overflow: hidden;
          border-radius: 50%;
          -webkit-border-radius: 50%;
          -moz-border-radius: 50%;
        }

        .top > .avatar > svg {
          position: absolute;
          bottom: 0px;
          right: -3px;
          width: 30px;
          height: 30px;
          z-index: 1;
          display: flex;
          align-items: center;
          justify-content: center;
          border-radius: 50%;
        }

        .top > .avatar > svg path#top {
          color: var(--background);
        }
        
        .top > .avatar > svg path#bottom {
          color: var(--accent-color);
        }

        .top > .info {
          display: flex;
          flex-flow: column;
          padding: 5px 0 0 10px;
          gap: 10px;
          align-items: start;
          justify-content: center;
          align-content: center;
          width: calc(100% - 100px);
          max-width: calc(100% - 100px);
          height: 100px;
          max-height: 100px;
        }

        .top > .info > .name {
          display: flex;
          justify-content: center;
          flex-flow: column;
          gap: 0;
        }

        .top > .info > .name > h4.name {
          margin: 0;
          display: flex;
          align-items: center;
          gap: 5px;
          color: var(--text-color);
          font-family: var(--font-read), sans-serif;
          font-size: 1.5rem;
          font-weight: 600;
        }

        .top > .info > .name > span.username {
          color: transparent;
          background: var(--accent-linear);
          background-clip: text;
          -webkit-background-clip: text;
          font-family: var(--font-mono), monospace;
          font-size: 0.9rem;
          font-weight: 500;
          text-decoration: none;
          display: flex;
          gap: 2px;
          align-items: center;
        }

        .top > .info > .name > span.username svg {
          color: var(--gray-color);
          width: 15px;
          height: 15px;
          margin: 2px 0 0 0;
        }

        .top > .info > .name > span.username:hover {
          color: transparent;
          background: var(--accent-linear);
          background-clip: text;
          -webkit-background-clip: text;
        }

        .top > .info > .name > span.username:hover svg {
          color: var(--accent-color);
        }

        .stats {
          color: var(--gray-color);
          display: flex;
          margin: 10px 0 5px 0;
          width: 100%;
          flex-flow: row;
          align-items: center;
          gap: 5px;
        }

        .stats > .stat {
          display: flex;
          flex-flow: row;
          align-items: center;
          gap: 3px;
        }

        .stats > .stat > .label {
          color: var(--gray-color);
          font-family: var(--font-main), sans-serif;
          text-transform: lowercase;
          font-size: 0.9rem;
          font-weight: 400;
        }

        .stats > .stat > .number {
          color: var(--highlight-color);
          font-family: var(--font-main), sans-serif;
          font-size: 0.84rem;
          font-weight: 500;
        }

        .bio {
          display: flex;
          flex-flow: column;
          margin: 5px 0;
          gap: 0;
          color: var(--text-color);
          font-family: var(--font-text), sans-serif;
          font-size: 1rem;
          line-height: 1.4;
          font-weight: 400;
        }

        .bio > p {
          all: inherit;
          margin: 0 0 2px;
        }

        .actions {
          border-bottom: var(--border);
          width: 100%;
          display: flex;
          flex-flow: row;
          gap: 20px;
          padding: 3px 0 15px 0;
          margin: 0;
        }

        .actions > .action {
          text-decoration: none;
          padding: 3px 12px 4px;
          font-weight: 500;
          background: var(--accent-linear);
          color: var(--white-color);
          font-family: var(--font-main), sans-serif;
          cursor: pointer;
          width: max-content;
          text-transform: lowercase;
          font-size: 0.9rem;
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 10px;
          border-radius: 12px;
        }

        .actions > .action.donate {
          background: var(--second-linear);
        }

        .actions > .action.you {
          text-transform: capitalize;
          padding: 3px 12px 4px;
          cursor: default;
          pointer-events: none;
          border: none;
          color: var(--gray-color);
          background: var(--gray-background);
        }

        .actions > .action.edit,
        .actions > .action.socials,
        .actions > .action.following,
        .actions > .action.settings {
          padding: 4px 12px 5px;
          background: unset;
          border: var(--action-border);
          color: var(--gray-color);
        }

        .actions > .action.highlights {
          background: var(--gray-background);
          color: var(--gray-color);
          padding: 5px 12px 6px;
        }

        @media screen and (max-width: 660px) {
          ::-webkit-scrollbar {
            -webkit-appearance: none;
          }

          a,
          .stats > .stat {
            cursor: default !important;
          }

          a,
          span.stat,
          span.action {
            cursor: default !important;
          }

          .top > .avatar {
            width: 80px;
            height: 80px;
            min-width: 80px;
            min-height: 80px;
            border-radius: 50%;
            -webkit-border-radius: 50%;
            -moz-border-radius: 50%;
          }
  
          .top > .avatar > img {
            width: 100%;
            height: 100%;
          }
  
          .top > .avatar > .icon {
            background: var(--background);
            position: absolute;
            bottom: 0;
            right: 0;
            width: 25px;
            height: 25px;
            z-index: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
          }
          
          .top > .avatar > .icon svg {
            width: 18px;
            height: 18px;
            color: var(--accent-color);
          }
  
          .top > .info {
            display: flex;
            flex-flow: column;
            padding: 0 0 0 10px;
            gap: 10px;
          }

          .top > .info > .name > h4.name {
            margin: 0;
            display: flex;
            align-items: center;
            gap: 5px;
            color: var(--text-color);
            font-family: var(--font-text), sans-serif;
            font-size: 1.3rem;
            font-weight: 600;
          }

          .stats {
            margin: 0 5px 0 0;
            width: 100%;
            gap: 5px;
          }
        }
      </style>
    `;
    }
  }

  class ShareWrapper extends HTMLElement {
    constructor() {
      // We are not even going to touch this.
      super();

      // let's create our shadow root
      this.shadowObj = this.attachShadow({ mode: "open" });

      this.render();
    }

    render() {
      this.shadowObj.innerHTML = this.getTemplate();
    }

    connectedCallback() {
      // Copy link
      this.copyLink();

      // Watch for media query changes
      const mql = window.matchMedia('(max-width: 660px)');
      this.openShare(mql.matches);
    }

    // fn to open the share overlay
    openShare = mql => {
      // Get share button
      const shareButton = this.shadowObj.querySelector('div.host');

      // Check if the overlay exists
      if (shareButton) {
        // Get overlay
        const overlay = shareButton.querySelector('.share.overlay');

        const content = shareButton.querySelector('.share > .content');

        const close = shareButton.querySelector('span.close');

        // Add event listener to the share button
        shareButton.addEventListener('click', e => {
          // prevent the default action
          // e.preventDefault()

          // prevent the propagation of the event
          e.stopPropagation();

          // Toggle the overlay
          overlay.classList.add('active');
          // disable scroll

          if (mql) {
            this.disableScroll();
          }

          if (!mql) {
            // add event to run once when the overlay is active: when user click outside the overlay
            document.addEventListener('click', e => {
              e.preventDefault();
              e.stopPropagation();
              e.stopImmediatePropagation();
    
              // Check if the target is not the overlay
              if (!content.contains(e.target)) {
                // Remove the active class
                overlay.classList.remove('active');
                this.enableScroll();
              }
            }, { once: true });
          }
          else {
            // add event to run once when the overlay is active: when user click outside the overlay
            close.addEventListener('click', e => {
              e.preventDefault();
              e.stopPropagation();
              e.stopImmediatePropagation();
    
              overlay.classList.remove('active');
              this.enableScroll();
            }, { once: true });
          }
        });
      }
    }

    // Handle copy link
    copyLink = () => {
      // Select the copy span: .share-buttons > span.copy
      const copyLink = this.shadowObj.querySelector('.share-buttons > span.copy');

      if (copyLink) {
        copyLink.addEventListener('click', () => {
          // Get the url to copy
          const url = copyLink.getAttribute('url');

          // Copy the url to the clipboard
          this.copyToClipboard(url);
          
          // Show a toast message
          this.showToast('Link copied to clipboard');
        });
      }
    }

    // Perform the copy action using the Clipboard API if failed show a toast message
    copyToClipboard = text => {
      // Use the Clipboard API to copy the url
      navigator.clipboard.writeText(text).then(() => {
        // Show a toast message
        this.showToast('Link copied to clipboard', true);
      }).catch(() => {
        // Show a toast message
        this.showToast('Failed to copy link to clipboard', false);
      });
    }

    // Show toast message
    showToast = (text, success) => {
      // Get the toast element
      const toast = this.getToast(text, success);

      // Get body element
      const body = document.querySelector('body');

      // Insert the toast into the DOM
      body.insertAdjacentHTML('beforeend', toast);

      // Remove the toast after 3 seconds
      setTimeout(() => {
        // Select the toast element
        const toast = body.querySelector('.toast');

        // Remove the toast
        if(toast) {
          toast.remove();
        }
      }, 3000);
    }

    disableScroll() {
      // Get the current page scroll position
      let scrollTop = window.scrollY || document.documentElement.scrollTop;
      let scrollLeft = window.scrollX || document.documentElement.scrollLeft;
      document.body.classList.add("stop-scrolling");

      // if any scroll is attempted, set this to the previous value
      window.onscroll = function () {
        window.scrollTo(scrollLeft, scrollTop);
      };
    }

      enableScroll() {
      document.body.classList.remove("stop-scrolling");
      window.onscroll = function () { };
    }

    getTemplate() {
      // Show HTML Here
      return `
      ${this.getContent()}
      ${this.getStyles()}
    `;
    }

    getContent = () => {
      return /* html */`
      <div class="host">
        <span class="icon">
          <span class="sp">•</span>
          <span class="sp">•</span>
        </span>
        <div class="share overlay">
          <span class="close"></span>
          <div class="content">
            <span class="pointer"></span>
            <p class="title">Share</p>
            ${this.getShareOptions()}
          </div>
        </div>
      </div>
		`
    }

    getShareOptions = () => {
      // Get summary text of the post
      const summary = this.getAttribute('summary');

      // Get url of the post
      const url = this.getAttribute('url');

      return /* html */`
      <div class="share-buttons" >
        <a class="x"
          href="https://twitter.com/intent/tweet?text=${summary}&url=${url}"
          target="_blank" rel="noopener" title="Share on Twitter">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-twitter-x" viewBox="0 0 16 16">
            <path  d="M12.6.75h2.454l-5.36 6.142L16 15.25h-4.937l-3.867-5.07-4.425 5.07H.316l5.733-6.57L0 .75h5.063l3.495 4.633L12.601.75Zm-.86 13.028h1.36L4.323 2.145H2.865z" />
          </svg>
        </a>
        <a class="facebook" href="https://www.facebook.com/sharer/sharer.php?u=${url}"
          target="_blank" rel="noopener" title="Share on Facebook">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-facebook" viewBox="0 0 16 16">
            <path d="M16 8.049c0-4.446-3.582-8.05-8-8.05C3.58 0-.002 3.603-.002 8.05c0 4.017 2.926 7.347 6.75 7.951v-5.625h-2.03V8.05H6.75V6.275c0-2.017 1.195-3.131 3.022-3.131.876 0 1.791.157 1.791.157v1.98h-1.009c-.993 0-1.303.621-1.303 1.258v1.51h2.218l-.354 2.326H9.25V16c3.824-.604 6.75-3.934 6.75-7.951" />
          </svg>
        </a>
        <a class="linkedin" href="https://www.linkedin.com/sharing/share-offsite/?url=${url}"
          target="_blank" rel="noopener" title="Share on LinkedIn">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-linkedin" viewBox="0 0 16 16">
            <path d="M0 1.146C0 .513.526 0 1.175 0h13.65C15.474 0 16 .513 16 1.146v13.708c0 .633-.526 1.146-1.175 1.146H1.175C.526 16 0 15.487 0 14.854zm4.943 12.248V6.169H2.542v7.225zm-1.2-8.212c.837 0 1.358-.554 1.358-1.248-.015-.709-.52-1.248-1.342-1.248S2.4 3.226 2.4 3.934c0 .694.521 1.248 1.327 1.248zm4.908 8.212V9.359c0-.216.016-.432.08-.586.173-.431.568-.878 1.232-.878.869 0 1.216.662 1.216 1.634v3.865h2.401V9.25c0-2.22-1.184-3.252-2.764-3.252-1.274 0-1.845.7-2.165 1.193v.025h-.016l.016-.025V6.169h-2.4c.03.678 0 7.225 0 7.225z" />
          </svg>
        </a>
        <a class="whatsapp"
          href="https://wa.me/?text=${url}"
          target="_blank" rel="noopener" title="Share on WhatsApp">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-whatsapp" viewBox="0 0 16 16">
            <path d="M13.601 2.326A7.85 7.85 0 0 0 7.994 0C3.627 0 .068 3.558.064 7.926c0 1.399.366 2.76 1.057 3.965L0 16l4.204-1.102a7.9 7.9 0 0 0 3.79.965h.004c4.368 0 7.926-3.558 7.93-7.93A7.9 7.9 0 0 0 13.6 2.326zM7.994 14.521a6.6 6.6 0 0 1-3.356-.92l-.24-.144-2.494.654.666-2.433-.156-.251a6.56 6.56 0 0 1-1.007-3.505c0-3.626 2.957-6.584 6.591-6.584a6.56 6.56 0 0 1 4.66 1.931 6.56 6.56 0 0 1 1.928 4.66c-.004 3.639-2.961 6.592-6.592 6.592m3.615-4.934c-.197-.099-1.17-.578-1.353-.646-.182-.065-.315-.099-.445.099-.133.197-.513.646-.627.775-.114.133-.232.148-.43.05-.197-.1-.836-.308-1.592-.985-.59-.525-.985-1.175-1.103-1.372-.114-.198-.011-.304.088-.403.087-.088.197-.232.296-.346.1-.114.133-.198.198-.33.065-.134.034-.248-.015-.347-.05-.099-.445-1.076-.612-1.47-.16-.389-.323-.335-.445-.34-.114-.007-.247-.007-.38-.007a.73.73 0 0 0-.529.247c-.182.198-.691.677-.691 1.654s.71 1.916.81 2.049c.098.133 1.394 2.132 3.383 2.992.47.205.84.326 1.129.418.475.152.904.129 1.246.08.38-.058 1.171-.48 1.338-.943.164-.464.164-.86.114-.943-.049-.084-.182-.133-.38-.232" />
          </svg>
        </a>
        <a class="mail"
          href="mailto:?subject=Check out this awesome story&body=${summary}.. : ${url}"
          target="_blank" rel="noopener" title="Share via Email">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-envelope-paper" viewBox="0 0 16 16">
            <path d="M4 0a2 2 0 0 0-2 2v1.133l-.941.502A2 2 0 0 0 0 5.4V14a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V5.4a2 2 0 0 0-1.059-1.765L14 3.133V2a2 2 0 0 0-2-2zm10 4.267.47.25A1 1 0 0 1 15 5.4v.817l-1 .6zm-1 3.15-3.75 2.25L8 8.917l-1.25.75L3 7.417V2a1 1 0 0 1 1-1h8a1 1 0 0 1 1 1zm-11-.6-1-.6V5.4a1 1 0 0 1 .53-.882L2 4.267zm13 .566v5.734l-4.778-2.867zm-.035 6.88A1 1 0 0 1 14 15H2a1 1 0 0 1-.965-.738L8 10.083zM1 13.116V7.383l4.778 2.867L1 13.117Z" />
          </svg>
        </a>
        <a class="reddit" href="https://reddit.com/submit?url=${url}&title=${summary}"
        target="_blank" rel="noopener" title="Share on Reddit">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-reddit" viewBox="0 0 16 16">
            <path d="M6.167 8a.83.83 0 0 0-.83.83c0 .459.372.84.83.831a.831.831 0 0 0 0-1.661m1.843 3.647c.315 0 1.403-.038 1.976-.611a.23.23 0 0 0 0-.306.213.213 0 0 0-.306 0c-.353.363-1.126.487-1.67.487-.545 0-1.308-.124-1.671-.487a.213.213 0 0 0-.306 0 .213.213 0 0 0 0 .306c.564.563 1.652.61 1.977.61zm.992-2.807c0 .458.373.83.831.83s.83-.381.83-.83a.831.831 0 0 0-1.66 0z" />
           <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0m-3.828-1.165c-.315 0-.602.124-.812.325-.801-.573-1.9-.945-3.121-.993l.534-2.501 1.738.372a.83.83 0 1 0 .83-.869.83.83 0 0 0-.744.468l-1.938-.41a.2.2 0 0 0-.153.028.2.2 0 0 0-.086.134l-.592 2.788c-1.24.038-2.358.41-3.17.992-.21-.2-.496-.324-.81-.324a1.163 1.163 0 0 0-.478 2.224q-.03.17-.029.353c0 1.795 2.091 3.256 4.669 3.256s4.668-1.451 4.668-3.256c0-.114-.01-.238-.029-.353.401-.181.688-.592.688-1.069 0-.65-.525-1.165-1.165-1.165" />
          </svg>
        </a>
        <a class="telegram" href="https://t.me/share/url?url=${url}&text=${summary}"
          target="_blank" rel="noopener" title="Share on Telegram">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-telegram" viewBox="0 0 16 16">
            <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0M8.287 5.906q-1.168.486-4.666 2.01-.567.225-.595.442c-.03.243.275.339.69.47l.175.055c.408.133.958.288 1.243.294q.39.01.868-.32 3.269-2.206 3.374-2.23c.05-.012.12-.026.166.016s.042.12.037.141c-.03.129-1.227 1.241-1.846 1.817-.193.18-.33.307-.358.336a8 8 0 0 1-.188.186c-.38.366-.664.64.015 1.088.327.216.589.393.85.571.284.194.568.387.936.629q.14.092.27.187c.331.236.63.448.997.414.214-.02.435-.22.547-.82.265-1.417.786-4.486.906-5.751a1.4 1.4 0 0 0-.013-.315.34.34 0 0 0-.114-.217.53.53 0 0 0-.31-.093c-.3.005-.763.166-2.984 1.09" />
          </svg>
        </a>
        <span class="copy" class="copy-link" url="${url}" title="Copy link">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-copy" viewBox="0 0 16 16">
            <path fill-rule="evenodd" d="M4 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2zm2-1a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1zM2 5a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1v-1h1v1a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h1v1z" />
          </svg>
        </span>
      </div >
		`
    }

    getToast = (text, success) => {
      if (success) {
        return /* html */`
        <div class="toast true">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" fill="currentColor">
          <path d="M8 16A8 8 0 1 1 8 0a8 8 0 0 1 0 16Zm3.78-9.72a.751.751 0 0 0-.018-1.042.751.751 0 0 0-1.042-.018L6.75 9.19 5.28 7.72a.751.751 0 0 0-1.042.018.751.751 0 0 0-.018 1.042l2 2a.75.75 0 0 0 1.06 0Z"></path>
        </svg>
          <p class="toast-message">${text}</p>
        </div>
      `;
      }
      else {
        return /* html */`
      <div class="toast false">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" fill="currentColor">
          <path d="M2.343 13.657A8 8 0 1 1 13.658 2.343 8 8 0 0 1 2.343 13.657ZM6.03 4.97a.751.751 0 0 0-1.042.018.751.751 0 0 0-.018 1.042L6.94 8 4.97 9.97a.749.749 0 0 0 .326 1.275.749.749 0 0 0 .734-.215L8 9.06l1.97 1.97a.749.749 0 0 0 1.275-.326.749.749 0 0 0-.215-.734L9.06 8l1.97-1.97a.749.749 0 0 0-.326-1.275.749.749 0 0 0-.734.215L8 6.94Z"></path>
        </svg>
          <p class="toast-message">${text}</p>
        </div>
      `;
      }
      
    }

    getStyles() {
      return /* css */`
      <style>
        *,
        *:after,
        *:before {
          box-sizing: border-box !important;
          font-family: inherit;
          -webkit-box-sizing: border-box !important;
        }

        *:focus {
          outline: inherit !important;
        }

        *::-webkit-scrollbar {
          -webkit-appearance: none;
        }

        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
          padding: 0;
          margin: 0;
          font-family: inherit;
        }

        p,
        ul,
        ol {
          padding: 0;
          margin: 0;
        }

        a {
          text-decoration: none;
        }

        .host {
          position: relative;
          min-height: 35px;
          height: 30px;
          width: max-content;
          position: relative;
          padding: 5px 10px;
          cursor: pointer;
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 5px;
          font-size: 1rem;
          font-weight: 400;
          color: var(--action-color);
          color: var(--gray-color);
          border-radius: 50px;
          -webkit-border-radius: 50px;
          -moz-border-radius: 50px;
          -ms-border-radius: 50px;
          -o-border-radius: 50px;
        }

        .host:hover {
          background: var(--hover-background);
        }

        span.icon {
          padding: 0;
          width: 100%;
          height: 100%;
          display: flex;
          align-items: center;
          justify-content: center;
          width: max-content;
          gap: 0;
          overflow-x: scroll;
          scrollbar-width: none;
          -webkit-scrollbar-width: none;
        }

        span.icon > span.sp {
          font-size: 1.2rem;
        }

        span.pointer {
          position: absolute;
          top: -6px;
          left: calc(50% - 6px);
          width: 12px;
          rotate: 45deg;
          height: 12px;
          cursor: pointer;
          z-index: 1;
          background: var(--background);
          border-left: var(--border);
          border-top: var(--border);
          border-radius: 3px;
        }

        .share {
          display: none;
          position: absolute;
          top: 35px;
          z-index: 4;
          left: calc(50% - 100px);
          padding: 0;
          border: var(--border-button);
          background: var(--background);
          box-shadow: var(--card-box-shadow);
          width: 200px;
          max-width: 200px;
          height: max-content;
          border-radius: 12px;
        }

        .content {
          display: flex;
          flex-flow: column;
          align-items: center;
          justify-content: center;
          gap: 5px;
          padding: 5px 12px 15px 12px;
        }

        .share.active {
          display: flex;
        }

        .title {
          color: var(--text-color);
          width: 95%;
          font-size: 1.35rem;
          font-weight: 600;
          margin: 0 0 5px;
          padding: 0 10px;
          text-align: center;
          border-radius: 12px;
          font-family: var(--font-read), sans-serif;
          color: var(--text-color);
          font-weight: 500;
        }

        .share-buttons {
          padding: 0;
          width: 100%;
          display: flex;
          flex-wrap: wrap;
          align-items: center;
          justify-content: center;
          gap: 10px;
        }

        .share-buttons > span.copy,
        .share-buttons > a {
          display: flex;
          align-items: center;
          justify-content: center;
          cursor: pointer;
          height: 30px;
          width: 30px;
          min-height: 30px;
          min-width: 30px;
          max-height: 30px;
          max-width: 30px;
          padding: 2px;
          margin: 3px;
          border-radius: 50px;
          -webkit-border-radius: 50px;
          -moz-border-radius: 50px;
          background: var(--accent-linear);
          color: var(--white-color);
          font-size: 0.9rem;
          font-weight: 500;
          text-transform: capitalize;
        }

        .share-buttons > a.x {
          background: linear-gradient(103.53deg, #1DA1F2 -6.72%, #0A95D7 109.77%);
        }

        .share-buttons > a.facebook {
          background: linear-gradient(103.53deg, #1877F2 -6.72%, #0A5A9C 109.77%);
        }

        .share-buttons > a.linkedin {
          background: linear-gradient(103.53deg, #0077B5 -6.72%, #005684 109.77%);;
        }

        .share-buttons > a.mail {
          background: linear-gradient(103.53deg, #D44638 -6.72%, #D44638 109.77%);
        }

        .share-buttons > a.reddit {
          background: linear-gradient(103.53deg, #FF4500 -6.72%, #FF4500 109.77%);
        }

        .share-buttons > a.telegram {
          background: linear-gradient(103.53deg, #0088CC -6.72%, #0088CC 109.77%);
        }

        .share-buttons > a.whatsapp {
          background: linear-gradient(103.53deg, #25D366 -6.72%, #25D366 109.77%);
        }

        .share-buttons > span.copy > svg,
        .share-buttons > a > svg {
          height: 15px;
          width: 15px;
          display: flex;
          align-items: center;
          justify-content: center;
        }

        .share-buttons > a.facebook > svg {
          height: 17px;
          width: 17px;
        }

        .share-buttons > a.reddit > svg {
          height: 18px;
          width: 18px;
        }

        .share-buttons > a.telegram > svg {
          height: 18px;
          width: 18px;
        }

        @media screen and (max-width: 660px) {
          ::-webkit-scrollbar {
            -webkit-appearance: none;
          }

          .host {
            margin: 0;
          }

          .share {
            position: fixed;
            z-index: 100;
            background: transparent;
            background: var(--modal-overlay);
            padding: 0;
            margin: 0;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            min-height: 100dvh;
            min-width: 100dvw;
            height: 100%;
            width: 100%;
            border-radius: 0;
            border: none;
            transition: all 300ms ease-in-out;
          }

          a,
          span.pointer,
          .host,
          .share-buttons > span.copy {
            cursor: default !important;
          }

          .host:hover {
            background: transparent;
          }
  
          .overlay span.close {
            display: flex;
            position: absolute;
            background: var(--modal-overlay);
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
          }

          .share .content {
            display: flex;
            align-items: center;
            justify-content: space-around;
            z-index: 1;
            gap: 0;
            box-shadow: var(--card-box-shadow);
            width: 100%;
            padding: 15px 8px;
            position: absolute;
            bottom: -2px;
            right: 0;
            left: 0;
            background: var(--background);
            border: var(--story-border-mobile);
            border-bottom-left-radius: 0;
            border-bottom-right-radius: 0;
            border-top-left-radius: 15px;
            border-top-right-radius: 15px;
          }

          .title {
            color: var(--text-color);
            width: 95%;
            font-size: 1.35rem;
            font-weight: 600;
            margin: 0 0 10px;
            padding: 10px 10px;
            background-color: var(--gray-background);
            text-align: center;
            border-radius: 12px;
            font-family: var(--font-read), sans-serif;
            color: var(--text-color);
            font-weight: 500;
          }

          span.pointer {
            display: none;
          }

          .share-buttons > span.copy,
          .share-buttons > a {
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            height: 45px;
            width: 45px;
            min-height: 45px;
            min-width: 45px;
            max-height: 45px;
            max-width: 45px;
            padding: 2px;
            margin: 3px;
          }

          .share-buttons > span.copy > svg,
          .share-buttons > a > svg {
            height: 23px;
            width: 23px;
            display: flex;
            align-items: center;
            justify-content: center;
          }

          .share-buttons > a.facebook > svg {
            height: 25px;
            width: 25px;
          }

          .share-buttons > a.reddit > svg {
            height: 26px;
            width: 26px;
          }

          .share-buttons > a.telegram > svg {
            height: 26px;
            width: 26px;
          }
        }
      </style>
    `;
    }
  }

  class UserWrapper extends HTMLElement {
    constructor() {
      // We are not even going to touch this.
      super();

      // get you
      this._you = this.getAttribute('you') === 'true';

      // check if the user is authenticated
      this._authenticated = window.hash ? true : false;

      // let's create our shadow root
      this.shadowObj = this.attachShadow({ mode: "open" });

      this.boundHandleWsMessage = this.handleWsMessage.bind(this);
      this.checkAndAddHandler = this.checkAndAddHandler.bind(this);

      this.render();
    }

    // attributes to observe
    static get observedAttributes() {
      return ["hash", "picture", "name", "followers", "following", "user-follow", "verified", "url", "reload"];
    }

    // listen for changes in the attributes
    attributeChangedCallback(name, oldValue, newValue) {
      // get the followers element
      const followers = this.shadowObj.querySelector('.stats > span.followers > .number');
      // get the follow button
      const followBtn = this.shadowObj.querySelector('.actions > .action#follow-action');
      // check if old value is not equal to new value
      if (name === 'reload') {
        if(newValue === 'true') {
          this.setAttribute('reload', 'false');

          // Update the followers
          if(followers) {
            const totalFollowers = this.parseToNumber(this.getAttribute('followers'));
            followers.textContent = totalFollowers >= 0 ? this.formatNumber(totalFollowers) : '0';
          }

          // Update the follow button
          if(followBtn) {
            this.updateFollowBtn(this.textToBoolean(this.getAttribute('user-follow')), followBtn);
          }
        }
      }  
    }

    render() {
      this.shadowObj.innerHTML = this.getTemplate();
    }

    connectedCallback() {
      // get url
      let url = this.getAttribute('url');

      url = url.trim().toLowerCase();

      // Check and add handler
      this.checkAndAddHandler();

      // Get the body
      const body = document.querySelector('body');

      this.handleUserClick(url, body);
      this.handleActionClick(url, body);

      // perform actions
      this.performActions();

      // open highlights
      this.openHighlights(body);
    }

    checkAndAddHandler() {
      if (window.wss) {
        window.wss.addMessageHandler(this.boundHandleWsMessage);
        // console.log('WebSocket handler added successfully');
      } else {
        // console.log('WebSocket manager not available, retrying...');
        setTimeout(this.checkAndAddHandler, 500); // Retry after 500ms
      }
    }

    disconnectedCallback() {
      if (window.wss) {
        window.wss.removeMessageHandler(this.boundHandleWsMessage);
      }
    }

    handleWsMessage = message => {
      // Handle the message in this component
      // console.log('Message received in component:', message);
      const data = message.data;

      if (message.type !== 'action') return;

      const userHash = window.hash;

      const authorHash = this.getAttribute('hash').toUpperCase();

      if (data.action === 'connect' && data.kind === 'user') {
        this.handleConnectAction(data, userHash, authorHash);
      }
    }

    handleConnectAction = (data, userHash, authorHash) => {
      const to = data.hashes.to;
      if(to === authorHash) {
        const followers = this.parseToNumber(this.getAttribute('followers')) + data.value;
        this.setAttribute('followers', followers);

        if (data.hashes.from === userHash) {
          const value = data.value === 1 ? 'true' : 'false';
    
          // update user-follow/auth-follow attribute
          this.setAttribute('user-follow', value);
        }

        this.setAttribute('reload', 'true');
      }
    }

    sendWsMessage(data) {
      window.wss.sendMessage(data);
    }

    updateFollowersEl = (element, value) => {
      element.setAttribute('followers', value);
    }

    textToBoolean = text => {
      return text === 'true' ? true : false;
    }

    openHighlights = body => {
      // Get the stats action and subscribe action
      const statsBtn = this.shadowObj.querySelector('.actions>.action#highlights-action');

      // add event listener to the stats action
      if (statsBtn) {
        statsBtn.addEventListener('click', e => {
          e.preventDefault();
          e.stopPropagation();

          // Open the highlights popup
          body.insertAdjacentHTML('beforeend', this.getHighlights());
        });
      }
    }

    // Open user profile
    handleUserClick = (url, body) => {
      const outerThis = this;
      // get a.meta.link
      const content = this.shadowObj.querySelector('a#username');

      // Get full post
      const profile =  this.getProfile();

      if(body && content) { 
        content.addEventListener('click', event => {
          event.preventDefault();
          
          // replace and push states
          outerThis.replaceAndPushStates(url, body, profile);

          body.innerHTML = profile;
        });
      }
    }

    // Open user profile
    handleActionClick = (url, body) => {
      const outerThis = this;
      // get a.meta.link
      const content = this.shadowObj.querySelector('a.action.view');

      // Get full post
      const profile =  this.getProfile();

      if(body && content) { 
        content.addEventListener('click', event => {
          event.preventDefault();
          
          // replace and push states
          outerThis.replaceAndPushStates(url, body, profile);

          body.innerHTML = profile;
        });
      }
    }

    // Replace and push states
    replaceAndPushStates = (url, body, profile) => {
      // Replace the content with the current url and body content
      // get the first custom element in the body
      const firstElement = body.firstElementChild;

      // convert the custom element to a string
       const elementString = firstElement.outerHTML;
      // get window location
      const pageUrl = window.location.href;
      window.history.replaceState(
        { page: 'page', content: elementString },
        url, pageUrl
      );

      // Updating History State
      window.history.pushState(
        { page: 'page', content: profile},
        url, url
      );
    }

    // perform actions
    performActions = () => {
      const outerThis = this;
      // get body 
      const body = document.querySelector('body');

      // get url to 
      let hash = this.getAttribute('hash');
      // trim and convert to lowercase
      hash = hash.trim().toLowerCase();

      // base api
      const url = '/api/v1/u/' + hash;

      // Get the follow action and subscribe action
      const followBtn = this.shadowObj.querySelector('.actions>.action#follow-action');

      // add event listener to the follow action
      if (followBtn) {
        // construct options
        const options = {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json',
          }
        };

        followBtn.addEventListener('click', e => {
          e.preventDefault();
          e.stopPropagation();

          let action = false;

          // Check if the user is authenticated
          if (!this._authenticated) {
            // Open the join popup
            this.openJoin(body);
          } 
          else {
            // Update the follow button
            if (followBtn.classList.contains('following')) {
              action = true;
              outerThis.updateFollowBtn(false, followBtn);
            }
            else {
              outerThis.updateFollowBtn(true, followBtn);
            }

            // Follow the topic
            this.followUser(`${url}/follow`, options, followBtn, action);
          }
        });
      }
    }

    followUser = (url, options, followBtn, followed) => {
      const outerThis = this;
      this.fetchWithTimeout(url, options)
        .then(response => {
          response.json()
          .then(data => {
            // If data has unverified, open the join popup
            if (data.unverified) {
              // Get body
              const body = document.querySelector('body');

              // Open the join popup
              outerThis.openJoin(body);

              // revert the follow button
              outerThis.updateFollowBtn(followed, followBtn);
            }

            // if success is false, show toast message
            if (!data.success) {
              outerThis.showToast(data.message, false);

              // revert the follow button
              outerThis.updateFollowBtn(followed, followBtn);
            }
            else {
              // Show toast message
              outerThis.showToast(data.message, true);

              // Check for followed boolean
              outerThis.updateFollowBtn(data.followed, followBtn);

              // Update the followers
              outerThis.updateFollowers(data.followed);
            }
          });
        })
        .catch(_error => {
          // console.log(_error);
          // show toast message
          outerThis.showToast('An error occurred!', false);

          // revert the follow button
          outerThis.updateFollowBtn(followed, followBtn);
        });
    }

    fetchWithTimeout = async (url, options = {}, timeout = 9500) => {
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), timeout);
    
      try {
        const response = await fetch(url, {
          ...options,
          signal: controller.signal
        });

        return response;
      } catch (error) {
        if (error.name === 'AbortError') {
          throw new Error('Request timed out');
        }
        throw new Error(`Network error: ${error.message}`);
      } finally {
        clearTimeout(timeoutId);
      }
    };

    updateFollowBtn = (following, btn) => {
      if (following) {
        // Change the text to following
        btn.textContent = 'following';

        // remove the follow class
        btn.classList.remove('follow');

        // add the following class
        btn.classList.add('following');
      }
      else {
        // Change the text to follow
        btn.textContent = 'follow';

        // remove the following class
        btn.classList.remove('following');

        // add the follow class
        btn.classList.add('follow');
      }
    }

    showToast = (text, success) => {
      // Get the toast element
      const toast = this.getToast(text, success);

      // Get body element
      const body = document.querySelector('body');

      // Insert the toast into the DOM
      body.insertAdjacentHTML('beforeend', toast);

      // Remove the toast after 3 seconds
      setTimeout(() => {
        // Select the toast element
        const toast = body.querySelector('.toast');

        // Remove the toast
        if(toast) {
          toast.remove();
        }
      }, 3000);
    }

    getToast = (text, success) => {
      if (success) {
        return /* html */`
        <div class="toast true">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" fill="currentColor">
          <path d="M8 16A8 8 0 1 1 8 0a8 8 0 0 1 0 16Zm3.78-9.72a.751.751 0 0 0-.018-1.042.751.751 0 0 0-1.042-.018L6.75 9.19 5.28 7.72a.751.751 0 0 0-1.042.018.751.751 0 0 0-.018 1.042l2 2a.75.75 0 0 0 1.06 0Z"></path>
        </svg>
          <p class="toast-message">${text}</p>
        </div>
      `;
      }
      else {
        return /* html */`
      <div class="toast false">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" fill="currentColor">
          <path d="M2.343 13.657A8 8 0 1 1 13.658 2.343 8 8 0 0 1 2.343 13.657ZM6.03 4.97a.751.751 0 0 0-1.042.018.751.751 0 0 0-.018 1.042L6.94 8 4.97 9.97a.749.749 0 0 0 .326 1.275.749.749 0 0 0 .734-.215L8 9.06l1.97 1.97a.749.749 0 0 0 1.275-.326.749.749 0 0 0-.215-.734L9.06 8l1.97-1.97a.749.749 0 0 0-.326-1.275.749.749 0 0 0-.734.215L8 6.94Z"></path>
        </svg>
          <p class="toast-message">${text}</p>
        </div>
      `;
      }
      
    }

    openJoin = body => {
      // Insert getJoin beforeend
      body.insertAdjacentHTML('beforeend', this.getJoin());
    }

    getJoin = () => {
      // get url from the : only the path
      const url = window.location.pathname;

      return /* html */`
      <join-popup register="/join/register" login="/join/login" next="${url}"></join-popup>
    `
    }

    updateFollowers = (followed) => {
      const outerThis = this;
      let value = followed ? 1 : -1;
      // Get followers attribute : convert to number then add value

      let followers = this.parseToNumber(this.getAttribute('followers')) + value;

      // if followers is less than 0, set it to 0
      followers = followers < 0 ? 0 : followers;

      // Set the followers attribute
      this.setAttribute('followers', followers.toString());

      // select the followers element
      const followersStat = outerThis.shadowObj.querySelector('.stats > span.followers');
      if (followersStat) {
        // select no element
        const no = followersStat.querySelector('.number');
        const text = followersStat.querySelector('.label');

        // Update the followers
        no.textContent = this.formatNumber(followers);

        // Update the text
        text.textContent = followers === 1 ? 'follower' : 'followers';
      }
    }

    formatNumber = n => {
      if (n >= 0 && n <= 999) {
        return n.toString();
      } else if (n >= 1000 && n <= 9999) {
        const value = (n / 1000).toFixed(2);
        return `${value}k`;
      } else if (n >= 10000 && n <= 99999) {
        const value = (n / 1000).toFixed(1);
        return `${value}k`;
      } else if (n >= 100000 && n <= 999999) {
        const value = (n / 1000).toFixed(0);
        return `${value}k`;
      } else if (n >= 1000000 && n <= 9999999) {
        const value = (n / 1000000).toFixed(2);
        return `${value}M`;
      } else if (n >= 10000000 && n <= 99999999) {
        const value = (n / 1000000).toFixed(1);
        return `${value}M`;
      } else if (n >= 100000000 && n <= 999999999) {
        const value = (n / 1000000).toFixed(0);
        return `${value}M`;
      } else if (n >= 1000000000) {
        return "1B+";
      }
      else {
        return 0;
      }
    }

    parseToNumber = num_str => {
      // Try parsing the string to an integer
      const num = parseInt(num_str);

      // Check if parsing was successful
      if (!isNaN(num)) {
        return num;
      } else {
        return 0;
      }
    }

    getTemplate() {
      // Show HTML Here
      return `
      ${this.getUser()}
      ${this.getStyles()}
    `;
    }

    getUser = () => {
      // Get name and check if it's greater than 20 characters
      const name = this.getAttribute('name');

      // GET url
      let url = this.getAttribute('url');

      // trim white spaces and convert to lowercase
      url = url.trim().toLowerCase();

      // Check if the name is greater than 20 characters: replace the rest with ...
      let displayName = name.length > 20 ? `${name.substring(0, 20)}..` : name;

      return /* html */ `
      <div class="author">
        <div class="author-info">
          ${this.getPicture(this.getAttribute('picture'))}
          <div class="name">
            <h4 class="name">
              <span class="name">${displayName}</span>
            </h4>
            <a href="${url}" class="username" id="username">
              <span class="text">${this.getAttribute('hash')}</span>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" fill="currentColor">
                <path d="M4.53 4.75A.75.75 0 0 1 5.28 4h6.01a.75.75 0 0 1 .75.75v6.01a.75.75 0 0 1-1.5 0v-4.2l-5.26 5.261a.749.749 0 0 1-1.275-.326.749.749 0 0 1 .215-.734L9.48 5.5h-4.2a.75.75 0 0 1-.75-.75Z" />
              </svg>
            </a>
          </div>
        </div>
      </div>
      ${this.getBio()}
      ${this.getStats()}
      <div class="actions">
        ${this.checkYou(this._you)}
      </div>
    `
    }

    getPicture = picture => {
      // check if picture is empty || null || === "null"
      if (picture === '' || picture === null || picture === 'null') {
        return /*html*/`
        <div class="avatar svg">
          <div class="svg-avatar">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
              <path d="M12 2.5a5.5 5.5 0 0 1 3.096 10.047 9.005 9.005 0 0 1 5.9 8.181.75.75 0 1 1-1.499.044 7.5 7.5 0 0 0-14.993 0 .75.75 0 0 1-1.5-.045 9.005 9.005 0 0 1 5.9-8.18A5.5 5.5 0 0 1 12 2.5ZM8 8a4 4 0 1 0 8 0 4 4 0 0 0-8 0Z"></path>
            </svg>
          </div>
          ${this.checkVerified(this.getAttribute('verified'))}
        </div>
      `
      }
      else {
        return /*html*/`
        <div class="avatar">
          <img src="${picture}" alt="Author picture">
          ${this.checkVerified(this.getAttribute('verified'))}
        </div>
      `
      }
    }

    getBio = () => {
      // get bio
      let bio = this.getAttribute('bio') || '';

      bio = bio.trim();

      // check if bio is empty
      if (bio === '') {
        return '';
      }
      else {
        // check if bio is greater than 70 characters
        let displayBio = bio.length > 150 ? `${bio.substring(0, 150)}..` : bio;

        return /*html*/`
        <p class="bio">${displayBio}</p>
      `
      }
    }

    checkVerified = verified => {
      if (verified === 'true') {
        return /*html*/`
        <svg width="26" height="26" viewBox="0 0 26 26" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M16.3592 1.41412C15.9218 0.966482 15.3993 0.610789 14.8224 0.367944C14.2455 0.125098 13.6259 0 13 0C12.3741 0 11.7545 0.125098 11.1776 0.367944C10.6007 0.610789 10.0782 0.966482 9.64079 1.41412L8.62993 2.45091L7.18354 2.43304C6.55745 2.42563 5.93619 2.54347 5.35631 2.77964C4.77642 3.01581 4.24962 3.36554 3.80687 3.80826C3.36413 4.25098 3.01438 4.77775 2.77819 5.3576C2.542 5.93744 2.42415 6.55866 2.43156 7.18472L2.44781 8.63102L1.41421 9.64181C0.966543 10.0792 0.610827 10.6017 0.367967 11.1785C0.125106 11.7554 0 12.3749 0 13.0008C0 13.6267 0.125106 14.2462 0.367967 14.8231C0.610827 15.3999 0.966543 15.9224 1.41421 16.3598L2.44944 17.3706L2.43156 18.8169C2.42415 19.443 2.542 20.0642 2.77819 20.644C3.01438 21.2239 3.36413 21.7506 3.80687 22.1934C4.24962 22.6361 4.77642 22.9858 5.35631 23.222C5.93619 23.4582 6.55745 23.576 7.18354 23.5686L8.62993 23.5523L9.64079 24.5859C10.0782 25.0335 10.6007 25.3892 11.1776 25.6321C11.7545 25.8749 12.3741 26 13 26C13.6259 26 14.2455 25.8749 14.8224 25.6321C15.3993 25.3892 15.9218 25.0335 16.3592 24.5859L17.3701 23.5507L18.8165 23.5686C19.4426 23.576 20.0638 23.4582 20.6437 23.222C21.2236 22.9858 21.7504 22.6361 22.1931 22.1934C22.6359 21.7506 22.9856 21.2239 23.2218 20.644C23.458 20.0642 23.5758 19.443 23.5684 18.8169L23.5522 17.3706L24.5858 16.3598C25.0335 15.9224 25.3892 15.3999 25.632 14.8231C25.8749 14.2462 26 13.6267 26 13.0008C26 12.3749 25.8749 11.7554 25.632 11.1785C25.3892 10.6017 25.0335 10.0792 24.5858 9.64181L23.5506 8.63102L23.5684 7.18472C23.5758 6.55866 23.458 5.93744 23.2218 5.3576C22.9856 4.77775 22.6359 4.25098 22.1931 3.80826C21.7504 3.36554 21.2236 3.01581 20.6437 2.77964C20.0638 2.54347 19.4426 2.42563 18.8165 2.43304L17.3701 2.44929L16.3592 1.41412Z" 
            fill="currentColor" id="top"/>
          <path d="M15.3256 4.97901C15.0228 4.6691 14.661 4.42285 14.2616 4.25473C13.8623 4.08661 13.4333 4 13 4C12.5667 4 12.1377 4.08661 11.7384 4.25473C11.339 4.42285 10.9772 4.6691 10.6744 4.97901L9.97457 5.69678L8.97322 5.68441C8.53977 5.67928 8.10967 5.76086 7.70821 5.92437C7.30675 6.08787 6.94204 6.32999 6.63553 6.63649C6.32901 6.94298 6.08688 7.30767 5.92336 7.70911C5.75985 8.11054 5.67826 8.54061 5.68339 8.97403L5.69464 9.97532L4.97907 10.6751C4.66914 10.9779 4.42288 11.3396 4.25475 11.739C4.08661 12.1383 4 12.5673 4 13.0006C4 13.4339 4.08661 13.8628 4.25475 14.2621C4.42288 14.6615 4.66914 15.0232 4.97907 15.326L5.69577 16.0258L5.68339 17.0271C5.67826 17.4605 5.75985 17.8906 5.92336 18.292C6.08688 18.6935 6.32901 19.0581 6.63553 19.3646C6.94204 19.6711 7.30675 19.9133 7.70821 20.0768C8.10967 20.2403 8.53977 20.3218 8.97322 20.3167L9.97457 
            20.3055L10.6744 21.021C10.9772 21.3309 11.339 21.5771 11.7384 21.7453C12.1377 21.9134 12.5667 22 13 22C13.4333 22 13.8623 21.9134 14.2616 21.7453C14.661 21.5771 15.0228 21.3309 15.3256 21.021L16.0254 20.3043L17.0268 20.3167C17.4602 20.3218 17.8903 20.2403 18.2918 20.0768C18.6932 19.9133 19.058 19.6711 19.3645 19.3646C19.671 19.0581 19.9131 18.6935 20.0766 18.292C20.2402 17.8906 20.3217 17.4605 20.3166 17.0271L20.3054 16.0258L21.0209 15.326C21.3309 15.0232 21.5771 14.6615 21.7453 14.2621C21.9134 13.8628 22 13.4339 22 13.0006C22 12.5673 21.9134 12.1383 21.7453 11.739C21.5771 11.3396 21.3309 10.9779 21.0209 10.6751L20.3042 9.97532L20.3166 8.97403C20.3217 8.54061 20.2402 8.11054 20.0766 7.70911C19.9131 7.30767 19.671 6.94298 19.3645 6.63649C19.058 6.32999 18.6932 6.08787 18.2918 5.92437C17.8903 5.76086 17.4602 5.67928 17.0268 5.68441L16.0254 5.69566L15.3256 4.97901ZM15.6485 11.7113L12.2732 15.0864C12.2209 15.1388 12.1588 15.1803 12.0905 15.2087C12.0222 15.2371 11.9489 15.2517 11.8749 15.2517C11.8009 15.2517 11.7276 15.2371 11.6593 15.2087C11.5909 15.1803 11.5289 15.1388 11.4766 15.0864L9.78893 13.3988C9.73662 13.3465 9.69513 13.2844 9.66683 13.2161C9.63852 13.1478 9.62395 13.0745 9.62395 13.0006C9.62395 12.9266 9.63852 12.8534 9.66683 12.785C9.69513 12.7167 9.73662 12.6546 9.78893 12.6023C9.84123 12.55 9.90333 12.5085 9.97166 12.4802C10.04 12.4519 10.1132 12.4373 10.1872 12.4373C10.2612 12.4373 10.3344 12.4519 10.4028 12.4802C10.4711 12.5085 10.5332 12.55 10.5855 12.6023L11.8749 13.8927L14.8519 10.9147C14.9576 10.8091 15.1008 10.7498 15.2502 10.7498C15.3996 10.7498 15.5429 10.8091 15.6485 10.9147C15.7542 11.0204 15.8135 11.1636 15.8135 11.313C15.8135 11.4624 15.7542 11.6056 15.6485 11.7113Z" 
            fill="currentColor" id="bottom"/>
        </svg>
			`
      }
      else {
        return ''
      }
    }

    // check is the current user: you === true
    checkYou = you => {
      // get url
      let url = this.getAttribute('url');

      // trim white spaces and convert to lowercase
      url = url.trim().toLowerCase();

      if (you) {
        return /*html*/`
        <span class="action you" id="you-action">you</span>
        <span class="action highlights" id="highlights-action">stats</span>
        <a href="${url}" class="action view" id="view-action">view</a>
      `
      }
      else {
        return /*html*/`
        <a href="${url}" class="action view" id="view-action">view</a>
        ${this.checkFollowing(this.getAttribute('user-follow'))}
        <span class="action highlights" id="highlights-action">stats</span>
      `
      }
    }

    checkFollowing = following => {
      if (following === 'true') {
        return /*html*/`
        <span class="action following" id="follow-action">Following</span>
      `
      }
      else {
        return /*html*/`
        <span class="action follow" id="follow-action">Follow</span>
      `
      }
    }

    getStats = () => {
      // Get total followers & following and parse to integer
      const followers = this.getAttribute('followers') || 0;
      const following = this.getAttribute('following') || 0;

      // Convert the followers & following to a number
      const totalFollowers = this.parseToNumber(followers);
      const totalFollowing = this.parseToNumber(following);

      //  format the number
      const followersFormatted = this.formatNumber(totalFollowers);
      const followingFormatted = this.formatNumber(totalFollowing);


      return /* html */`
      <div class="stats">
        <span class="stat followers">
          <span class="number">${followersFormatted}</span>
          <span class="label">${totalFollowers === 1 ? 'follower' : 'followers'}</span>
        </span>
        <span class="sp">•</span>
        <span class="stat following">
          <span class="number">${followingFormatted}</span>
          <span class="label">following</span>
        </span>
      </div>
		`
    }

    getProfile = () => {
      // get url
      let url = this.getAttribute('url');
   
      // trim white spaces and convert to lowercase
      url = url.trim().toLowerCase();

     return /* html */`
      <app-profile tab="stories" you="${this.getAttribute('you')}" url="${url}"
        stories-url="/api/v1${url}/stories" replies-url="/api/v1${url}/replies" stories="${this.getAttribute('stories')}" replies="${this.getAttribute('replies')}"
        followers-url="/api/v1${url}/followers" following-url="/api/v1${url}/following"
        hash="${this.getAttribute('hash')}" picture="${this.getAttribute('picture')}" verified="${this.getAttribute('verified')}"
        name="${this.getAttribute('name')}" followers="${this.getAttribute('followers')}" contact='${this.getAttribute("contact")}'
        following="${this.getAttribute('following')}" user-follow="${this.getAttribute('user-follow')}" bio="${this.getAttribute('bio')}">
      </app-profile>
   `
    }

    getHighlights = () => {
      // get url
      const url = this.getAttribute('url');
    
      // trim white spaces and convert to lowercase
      let formattedUrl = url.toLowerCase();

      return /* html */`
      <stats-popup url="/api/v1${formattedUrl}/stats" name="${this.getAttribute('name')}"
        followers="${this.getAttribute('followers')}" following="${this.getAttribute('following')}" 
        stories="${this.getAttribute('stories')}" replies="${this.getAttribute('replies')}">
      </stats-popup>
    `
    }

    getStyles() {
      return /* css */`
      <style>
        *,
        *:after,
        *:before {
          box-sizing: border-box !important;
          font-family: inherit;
          -webkit-box-sizing: border-box !important;
        }

        *:focus {
          outline: inherit !important;
        }

        *::-webkit-scrollbar {
          width: 3px;
        }

        *::-webkit-scrollbar-track {
          background: var(--scroll-bar-background);
        }

        *::-webkit-scrollbar-thumb {
          width: 3px;
          background: var(--scroll-bar-linear);
          border-radius: 50px;
        }

        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
          padding: 0;
          margin: 0;
          font-family: inherit;
        }

        p,
        ul,
        ol {
          padding: 0;
          margin: 0;
        }

        a {
          text-decoration: none;
        }

        :host {
          font-size: 16px;
          border-bottom: var(--border);
          padding: 10px 0;
          width: 100%;
          display: flex;
          align-items: center;
          flex-flow: column;
          gap: 10px;
        }

        .author {
          display: flex;
          width: 100%;
          flex-flow: column;
          align-items: start;
        }
        
        .author-info {
          display: flex;
          width: 100%;
          flex-flow: row;
          align-items: center;
          gap: 10px;
        }
        
        .author-info > .avatar {
          position: relative;
          width: 42px;
          height: 42px;
          border-radius: 50%;
          -webkit-border-radius: 50%;
          -moz-border-radius: 50%;
        }

        .author-info > .avatar.svg {
          background: var(--gray-background);
        }
        
        .author-info > .avatar > img {
          width: 100%;
          height: 100%;
          overflow: hidden;
          object-fit: cover;
          border-radius: 50%;
          -webkit-border-radius: 50%;
          -moz-border-radius: 50%;
        }

        .author-info > .avatar.svg > .svg-avatar {
          display: flex;
          align-items: center;
          justify-content: center;
          width: 100%;
          height: 100%;
          border-radius: 50%;
          -webkit-border-radius: 50%;
          -moz-border-radius: 50%;
        }

        .author-info > .avatar.svg > .svg-avatar > svg {
          width: 26px;
          height: 26px;
          color: var(--gray-color);
          display: flex;
          margin: 0 0 2px 0;
        }
        
        .author-info > .avatar > svg {
          position: absolute;
          bottom: 0px;
          right: -3px;
          width: 20px;
          height: 20px;
          z-index: 1;
          display: flex;
          align-items: center;
          justify-content: center;
          border-radius: 50%;
        }

        .author-info > .avatar > svg path#top {
          color: var(--background);
        }
        
        .author-info > .avatar > svg path#bottom {
          color: var(--accent-color);
        }
        
        .author-info > .name {
          display: flex;
          justify-content: center;
          flex-flow: column;
          gap: 0;
        }
        
        .author-info > .name > h4.name {
          margin: 0;
          display: flex;
          align-items: center;
          gap: 3px;
          color: var(--text-color);
          font-family: var(--font-main), sans-serif;
          font-size: 1rem;
          font-weight: 500;
        }
        
        .author-info > .name > a.username {
          color: var(--gray-color);
          font-family: var(--font-mono), monospace;
          font-size: 0.8rem;
          font-weight: 500;
          text-decoration: none;
          display: flex;
          gap: 2px;
          align-items: center;
        }
        
        .author-info > .name > a.username svg {
          color: var(--gray-color);
          width: 15px;
          height: 15px;
          margin: 2px 0 0 0;
        }
        
        .author-info > .name > a.username:hover {
          color: transparent;
          background: var(--accent-linear);
          background-clip: text;
          -webkit-background-clip: text;
        }
        
        .author-info > .name > a.username:hover svg {
          color: var(--accent-color);
        }

        p.bio {
          color: var(--gray-color);
          font-family: var(--font-main), sans-serif;
          font-size: 0.9rem;
          font-weight: 400;
          width: 100%;
          text-align: start;
        }

        .stats {
          color: var(--gray-color);
          display: flex;
          width: 100%;
          flex-flow: row;
          align-items: center;
          gap: 10px;
        }

        .stats > .stat {
          display: flex;
          flex-flow: row;
          align-items: center;
          gap: 5px;
        }

        .stats > .stat > .label {
          color: var(--gray-color);
          font-family: var(--font-main), sans-serif;
          text-transform: lowercase;
          font-size: 0.9rem;
          font-weight: 400;
        }

        .stats > .stat > .number {
          color: var(--text-color);
          font-family: var(--font-main), sans-serif;
          font-size: 0.8rem;
          font-weight: 500;
        }
        
        .actions {
          display: flex;
          font-family: var(--font-main), sans-serif;
          width: 100%;
          flex-flow: row;
          align-items: center;
          gap: 12px;
          padding: 0;
        }
        
        .actions > .action {
          border: var(--action-border);
          padding: 2.5px 15px 4px;
          background: none;
          font-family: var(--font-main), sans-serif;
          border: var(--border-mobile);
          color: var(--gray-color);
          font-weight: 400;
          font-size: 0.9rem;
          cursor: pointer;
          display: flex;
          width: max-content;
          flex-flow: row;
          align-items: center;
          text-transform: lowercase;
          text-align: center;
          justify-content: center;
          border-radius: 10px;
          -webkit-border-radius: 10px;
          -moz-border-radius: 10px;
        }

        .actions > .action.you {
          text-transform: capitalize;
          padding: 3px 15px 4px;
          cursor: default;
          pointer-events: none;
          border: none;
          background: var(--gray-background);
        }
        
        .actions > .action.follow {
          border: none;
          padding: 3px 15px 4px;
          font-weight: 500;
          background: var(--accent-linear);
          color: var(--white-color);
        }

        @media screen and (max-width:660px) {
          :host {
            font-size: 16px;
          }

          .actions > .action,
          a {
            cursor: default !important;
          }
      </style>
    `;
    }
  }

  class TopicWrapper extends HTMLElement {
    constructor() {
      // We are not even going to touch this.
      super();

      // check if the user is authenticated
      this._authenticated = window.hash ? true : false;

      // let's create our shadow root
      this.shadowObj = this.attachShadow({ mode: "open" });

      this.boundHandleWsMessage = this.handleWsMessage.bind(this);
      this.checkAndAddHandler = this.checkAndAddHandler.bind(this);

      this.render();
    }

    render() {
      this.shadowObj.innerHTML = this.getTemplate();
    }

    connectedCallback() {
      // get url
      let url = this.getAttribute('url');

      url = url.trim().toLowerCase();

      // connect to the WebSocket
      this.checkAndAddHandler();
   
      // Get the body
      const body = document.querySelector('body');
   
      this.openTopicPage(url, body);

      // perform actions
      this.performActions();

      // open highlights
      this.openHighlights(body);
    }

    checkAndAddHandler() {
      if (window.wss) {
        window.wss.addMessageHandler(this.boundHandleWsMessage);
        // console.log('WebSocket handler added successfully');
      } else {
        // console.log('WebSocket manager not available, retrying...');
        setTimeout(this.checkAndAddHandler, 500); // Retry after 500ms
      }
    }

    disconnectedCallback() {
      if (window.wss) {
        window.wss.removeMessageHandler(this.boundHandleWsMessage);
      }
    }

    handleWsMessage = message => {
      // Handle the message in this component
      // console.log('Message received in component:', message);
      const data = message.data;

      if (message.type !== 'action') return;

      const userHash = window.hash;

      const hash = this.getAttribute('hash').toUpperCase();
      const authorHash = this.getAttribute('author-hash').toUpperCase();

      const author = this.shadowObj.querySelector('author-wrapper');

      const target = data.hashes.target;

      // handle connect action
      if (data.action === 'connect' && data.kind === 'user') {
        this.handleConnectAction(data, author, userHash, authorHash);
      }
      else if (data.kind === 'topic' && target === hash) {
        this.handleTopicAction(data, data.value, userHash);

      }
    }

    sendWsMessage(data) {
      window.wss.sendMessage(data);
    }

    handleConnectAction = (data, author,userHash, authorHash) => {
      const to = data.hashes.to;
      if(to === authorHash) {
        const followers = this.parseToNumber(this.getAttribute('author-followers')) + data.value;
        this.setAttribute('author-followers', followers);
        this.updateFollowers(author, followers);

        if (data.hashes.from === userHash) {
          const value = data.value === 1 ? 'true' : 'false';
          // update user-follow/auth-follow attribute
          this.setAttribute('author-follow', value);
          if(author) {
            author.setAttribute('user-follow', value);
          }
        }

        if(author) {
          author.setAttribute('reload', 'true');
        }
      }
    }

    handleTopicAction = (data, value, userHash) => {
      if (data.user === userHash)  return;

      // if action is follow
      if (data.action === 'follow') {
        this.updateFollowers(value === 1);
      }
      else if (data.action === 'subscribe') {
        const subscribers = this.parseToNumber(this.getAttribute('subscribers')) + value;
        this.setAttribute('subscribers', subscribers.toString());

        // select subscribers element
        const subscribersStat = this.shadowObj.querySelector('.stats > span.subscribers');
        if (subscribersStat) {
          // select no element
          const no = subscribersStat.querySelector('.number');
          const text = subscribersStat.querySelector('.label');

          // Update the subscribers
          no.textContent = this.formatNumber(subscribers);

          // Update the text
          text.textContent = subscribers === 1 ? 'subscriber' : 'subscribers';
        }
      }
    }

    openHighlights = body => {
      // Get the stats action and subscribe action
      const statsBtn = this.shadowObj.querySelector('.actions>.action#stats-action');

      // add event listener to the stats action
      if (statsBtn) {
        statsBtn.addEventListener('click', e => {
          e.preventDefault();
          e.stopPropagation();

          // Open the highlights popup
          body.insertAdjacentHTML('beforeend', this.getHighlights());
        });
      }
    }

    // perform actions
    performActions = () => {
      const outerThis = this;
      // get body 
      const body = document.querySelector('body');

      // get url to 
      let hash = this.getAttribute('hash');
      // trim and convert to lowercase
      hash = hash.trim().toLowerCase();

      // base api
      const url = '/api/v1/t/' + hash;

      // Get the follow action and subscribe action
      const followBtn = this.shadowObj.querySelector('.actions>.action#follow-action');

      // add event listener to the follow action
      if (followBtn) {
        // construct options
        const options = {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json',
          }
        };

        followBtn.addEventListener('click', e => {
          e.preventDefault();
          e.stopPropagation();

          let action = false;

          // Check if the user is authenticated
          if (!this._authenticated) {
            // Open the join popup
            this.openJoin(body);
          } 
          else {
            // Update the follow button
            if (followBtn.classList.contains('following')) {
              action = true;
              outerThis.updateFollowBtn(false, followBtn);
            }
            else {
              outerThis.updateFollowBtn(true, followBtn);
            }

            // Follow the topic
            this.followTopic(`${url}/follow`, options, followBtn, action);
          }
        });
      }
    }

    followTopic = (url, options, followBtn, followed) => {
      const outerThis = this;
      this.fetchWithTimeout(url, options)
        .then(response => {
          response.json()
          .then(data => {
            // If data has unverified, open the join popup
            if (data.unverified) {
              // Get body
              const body = document.querySelector('body');

              // Open the join popup
              outerThis.openJoin(body);

              // revert the follow button
              outerThis.updateFollowBtn(followed, followBtn);
            }

            // if success is false, show toast message
            if (!data.success) {
              outerThis.showToast(data.message, false);

              // revert the follow button
              outerThis.updateFollowBtn(followed, followBtn);
            }
            else {
              // Show toast message
              outerThis.showToast(data.message, true);

              // Check for followed boolean
              outerThis.updateFollowBtn(data.followed, followBtn);

              // Update the followers
              outerThis.updateFollowers(data.followed);
            }
          });
        })
        .catch(_error => {
          // console.log(_error);
          // show toast message
          outerThis.showToast('An error occurred!', false);

          // revert the follow button
          outerThis.updateFollowBtn(followed, followBtn);
        });
    }

    fetchWithTimeout = async (url, options = {}, timeout = 9500) => {
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), timeout);
    
      try {
        const response = await fetch(url, {
          ...options,
          signal: controller.signal
        });

        return response;
      } catch (error) {
        if (error.name === 'AbortError') {
          throw new Error('Request timed out');
        }
        throw new Error(`Network error: ${error.message}`);
      } finally {
        clearTimeout(timeoutId);
      }
    };;

    updateFollowBtn = (following, btn) => {
      if (following) {
        // Change the text to following
        btn.textContent = 'following';

        // remove the follow class
        btn.classList.remove('follow');

        // add the following class
        btn.classList.add('following');
      }
      else {
        // Change the text to follow
        btn.textContent = 'follow';

        // remove the following class
        btn.classList.remove('following');

        // add the follow class
        btn.classList.add('follow');
      }
    }

    showToast = (text, success) => {
      // Get the toast element
      const toast = this.getToast(text, success);

      // Get body element
      const body = document.querySelector('body');

      // Insert the toast into the DOM
      body.insertAdjacentHTML('beforeend', toast);

      // Remove the toast after 3 seconds
      setTimeout(() => {
        // Select the toast element
        const toast = body.querySelector('.toast');

        // Remove the toast
        if(toast) {
          toast.remove();
        }
      }, 3000);
    }

    getToast = (text, success) => {
      if (success) {
        return /* html */`
        <div class="toast true">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" fill="currentColor">
          <path d="M8 16A8 8 0 1 1 8 0a8 8 0 0 1 0 16Zm3.78-9.72a.751.751 0 0 0-.018-1.042.751.751 0 0 0-1.042-.018L6.75 9.19 5.28 7.72a.751.751 0 0 0-1.042.018.751.751 0 0 0-.018 1.042l2 2a.75.75 0 0 0 1.06 0Z"></path>
        </svg>
          <p class="toast-message">${text}</p>
        </div>
      `;
      }
      else {
        return /* html */`
      <div class="toast false">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" fill="currentColor">
          <path d="M2.343 13.657A8 8 0 1 1 13.658 2.343 8 8 0 0 1 2.343 13.657ZM6.03 4.97a.751.751 0 0 0-1.042.018.751.751 0 0 0-.018 1.042L6.94 8 4.97 9.97a.749.749 0 0 0 .326 1.275.749.749 0 0 0 .734-.215L8 9.06l1.97 1.97a.749.749 0 0 0 1.275-.326.749.749 0 0 0-.215-.734L9.06 8l1.97-1.97a.749.749 0 0 0-.326-1.275.749.749 0 0 0-.734.215L8 6.94Z"></path>
        </svg>
          <p class="toast-message">${text}</p>
        </div>
      `;
      }
      
    }

    openJoin = body => {
      // Insert getJoin beforeend
      body.insertAdjacentHTML('beforeend', this.getJoin());
    }

    getJoin = () => {
      // get url from the : only the path
      const url = window.location.pathname;

      return /* html */`
      <join-popup register="/join/register" login="/join/login" next="${url}"></join-popup>
    `
    }

    updateFollowers = (followed) => {
      const outerThis = this;
      let value = followed ? 1 : -1;
      // Get followers attribute : concvert to number then add value

      let followers = this.parseToNumber(this.getAttribute('followers')) + value;

      // if followers is less than 0, set it to 0
      followers = followers < 0 ? 0 : followers;

      // Set the followers attribute
      this.setAttribute('followers', followers.toString());

      // Set topic-follow attribute to true or false based on followed bool
      this.setAttribute('topic-follow', `${followed}`);

      // select the followers element
      const followersStat = outerThis.shadowObj.querySelector('.stats > span.followers');
      if (followersStat) {
        // select no element
        const no = followersStat.querySelector('.number');
        const text = followersStat.querySelector('.label');

        // Update the followers
        no.textContent = this.formatNumber(followers);

        // Update the text
        text.textContent = followers === 1 ? 'follower' : 'followers';
      }
    }

    // Open topic page
    openTopicPage = (url, body) => {
      const outerThis = this;
      // get a.meta.link
      const content = this.shadowObj.querySelector('a.action.view');

      if(body && content) { 
        content.addEventListener('click', event => {
          event.preventDefault();

          // Get full post
          const topic =  this.getTopic();
          
          // replace and push states
          outerThis.replaceAndPushStates(url, body, topic);

          body.innerHTML = topic;
        });
      }
    }

    // Replace and push states
    replaceAndPushStates = (url, body, topic) => {
      // Replace the content with the current url and body content
      // get the first custom element in the body
      const firstElement = body.firstElementChild;

      // convert the custom element to a string
       const elementString = firstElement.outerHTML;
      // get window location
      const pageUrl = window.location.href;
      window.history.replaceState(
        { page: 'page', content: elementString },
        url, pageUrl
      );

      // Updating History State
      window.history.pushState(
        { page: 'page', content: topic},
        url, url
      );
    }

    formatNumber = n => {
      if (n >= 0 && n <= 999) {
        return n.toString();
      } else if (n >= 1000 && n <= 9999) {
        const value = (n / 1000).toFixed(2);
        return `${value}k`;
      } else if (n >= 10000 && n <= 99999) {
        const value = (n / 1000).toFixed(1);
        return `${value}k`;
      } else if (n >= 100000 && n <= 999999) {
        const value = (n / 1000).toFixed(0);
        return `${value}k`;
      } else if (n >= 1000000 && n <= 9999999) {
        const value = (n / 1000000).toFixed(2);
        return `${value}M`;
      } else if (n >= 10000000 && n <= 99999999) {
        const value = (n / 1000000).toFixed(1);
        return `${value}M`;
      } else if (n >= 100000000 && n <= 999999999) {
        const value = (n / 1000000).toFixed(0);
        return `${value}M`;
      } else if (n >= 1000000000) {
        return "1B+";
      }
      else {
        return 0;
      }
    }

    parseToNumber = num_str => {
      // Try parsing the string to an integer
      const num = parseInt(num_str);

      // Check if parsing was successful
      if (!isNaN(num)) {
        return num;
      } else {
        return 0;
      }
    }

    getTemplate() {
      // Show HTML Here
      return `
      ${this.getInfo()}
      ${this.getStyles()}
    `;
    }

    getInfo = () => {
      // Get name and check if it's greater than 20 characters
      let name = this.getAttribute('name');

      // Replace - with space and capitalize first letter of the first word using regex: heath-care becomes Heath care
      name = name.toLowerCase().replace(/-/g, ' ');
      
      // Capitalize the first letter of the first word
      const formattedName = name.replace(/^\w/, c => c.toUpperCase());

      return /* html */ `
      <div class="topic">
        <h4 class="name">
          <span class="name">${formattedName}</span>
        </h4>
        ${this.getDescription()}
        ${this.getStats()}
        <div class="actions">
          ${this.checkFollowing(this.getAttribute('topic-follow'))}
        </div>
      </div>
    `
    }

    getDescription = () => {
      // get innerHTML
      const innerHTML = this.innerHTML;

      // remove tags and &gt; and &lt;
      let description = innerHTML.replace(/<[^>]*>/g, '').replace(/&gt;/g, '>').replace(/&lt;/g, '<');

      // Check if the description is greater than 100 characters: replace the rest with ...
      let displayDescription = description.length > 120 ? `${description.substring(0, 120)}...` : description;

      return /* html */ `
      <p class="description">${displayDescription}</p>
    `
    }

    checkFollowing = following => {
      // GET url
      const url = this.getAttribute('url');

      if (following === 'true') {
        return /*html*/` 
        <a href="${url.toLowerCase()}" class="action view" id="view-action">view</a>
        <span class="action following" id="follow-action">following</span>
        <span class="action contribute" id="stats-action">stats</span>
			`
      }
      else {
        return /*html*/`
        <a href="${url.toLowerCase()}" class="action view" id="view-action">view</a>
        <span class="action follow" id="follow-action">follow</span>
        <span class="action contribute" id="stats-action">stats</span>
			`
      }
    }

    getStats = () => {
      // Get total followers & following and parse to integer
      const followers = this.getAttribute('followers') || 0;
      const subscribers = this.getAttribute('subscribers') || 0;

      // Convert the followers & following to a number
      const totalFollowers = this.parseToNumber(followers);
      const totalSubscribers = this.parseToNumber(subscribers);

      //  format the number
      const followersFormatted = this.formatNumber(totalFollowers);
      const subscribersFormatted = this.formatNumber(totalSubscribers);


      return /* html */`
      <div class="stats">
        <span class="stat followers">
          <span class="number">${followersFormatted}</span>
          <span class="label">follower${ totalFollowers === 1 ? '' : 's'}</span>
        </span>
        <span class="sp">•</span>
        <span class="stat subscribers">
          <span class="number">${subscribersFormatted}</span>
          <span class="label">subscriber${ totalSubscribers === 1 ? '' : 's'}</span>
        </span>
      </div>
		`
    }

    getTopic = () => {
      // get url
      let url = this.getAttribute('url');
   
      // trim white spaces and convert to lowercase
      url = url.trim().toLowerCase();

      let apiUrl = `/api/v1/t/${this.getAttribute('slug')}`;

     return /* html */`
    <app-topic tab="article" hash="${this.getAttribute('hash')}" subscribers="${this.getAttribute('subscribers')}"
      followers="${this.getAttribute('followers')}" views="${this.getAttribute('views')}"
      stories="${this.getAttribute('stories')}" subscribed="${this.getAttribute('subscribed')}" topic-follow="${this.getAttribute('topic-follow')}"
      name="${this.getAttribute('name')}" url="${url}" slug="${this.getAttribute('slug')}"
      stories-url="${apiUrl}/stories" followers-url="${apiUrl}/followers" 
      author-hash="${this.getAttribute('author-hash')}" author-you="${this.getAttribute('author-you')}" author-contact='${this.getAttribute("author-contact")}'
      author-stories="${this.getAttribute('author-stories')}" author-img="${this.getAttribute('author-img')}" 
      author-follow="${this.getAttribute('author-follow')}" author-replies="${this.getAttribute('author-replies')}" 
      author-name="${this.getAttribute('author-name')}" author-followers="${this.getAttribute('author-followers')}" 
      author-following="${this.getAttribute('author-following')}" author-verified="${this.getAttribute('author-verified')}" 
      author-bio="${this.getAttribute('author-bio')}">
      ${this.innerHTML}
    </app-topic>
   `
    }

    getHighlights = () => {
      return /* html */`
      <topic-popup url="/api/v1/t/${this.getAttribute('hash').toLowerCase()}/stats" name="${this.getAttribute('name')}" views="${this.getAttribute('views')}"
        followers="${this.getAttribute('followers')}" subscribers="${this.getAttribute('subscribers')}" 
        stories="${this.getAttribute('stories')}">
      </topic-popup>
    `
    }

    getStyles() {
      return /* css */`
      <style>
        *,
        *:after,
        *:before {
          box-sizing: border-box !important;
          font-family: inherit;
          -webkit-box-sizing: border-box !important;
        }

        *:focus {
          outline: inherit !important;
        }

        *::-webkit-scrollbar {
          width: 3px;
        }

        *::-webkit-scrollbar-track {
          background: var(--scroll-bar-background);
        }

        *::-webkit-scrollbar-thumb {
          width: 3px;
          background: var(--scroll-bar-linear);
          border-radius: 50px;
        }

        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
          padding: 0;
          margin: 0;
          font-family: inherit;
        }

        p,
        ul,
        ol {
          padding: 0;
          margin: 0;
        }

        a {
          text-decoration: none;
        }

        :host {
          font-size: 16px;
          border-bottom: var(--border);
          padding: 10px 0 15px;
          width: 100%;
          display: flex;
          align-items: center;
          flex-flow: column;
          gap: 8px;
        }

        .topic {
          display: flex;
          width: 100%;
          padding: 0;
          display: flex;
          width: 100%;
          flex-flow: column;
          gap: 0;
        }
        
        .topic > h4.name {
          margin: 0;
          display: flex;
          align-items: center;
          color: var(--title-color);
          font-family: var(--font-main), sans-serif;
          font-size: 1.15rem;
          line-height: 1.3;
          font-weight: 500;
          break-word: break-all;
          word-wrap: break-word;
        }
        
        .topic > .hori > a.hash {
          color: var(--gray-color);
          font-family: var(--font-mono), monospace;
          font-size: 0.9rem;
          font-weight: 500;
          text-decoration: none;
          display: flex;
          gap: 2px;
          padding: 8px 0 0 0;
          align-items: center;
        }

        p.description {
          color: var(--text-color);
          font-family: var(--font-main), sans-serif;
          font-size: 0.93rem;
          font-weight: 400;
          margin: 0;
          line-height: 1.3;
          padding: 0;
          margin: 5px 0;
        }

        div.actions {
          display: flex;
          flex-flow: row;
          width: 100%;
          gap: 10px;
          margin: 10px 0 0 0;
          padding: 0;
        }
        
        div.actions > .action {
          display: flex;
          align-items: center;
          justify-content: center;
          padding: 2.5px 10px;
          height: max-content;
          width: max-content;
          border-radius: 10px;
          -webkit-border-radius: 10px;
          -moz-border-radius: 10px;
          background: var(--accent-linear);
          color: var(--white-color);
          font-weight: 500;
          font-size: 0.9rem;
          line-height: 1.3;
          font-weight: 500;
          font-family: var(--font-text), sans-serif;
          cursor: pointer;
          outline: none;
          border: none;
          text-transform: lowercase;
        }
        
        div.actions > .action.contribute,
        div.actions > .action.view,
        div.actions > .action.following {
          padding: 2px 10px;
          background: none;
          border: var(--border-button);
          color: var(--gray-color);
          font-weight: 500;
          font-size: 0.9rem;
        }

        .stats {
          color: var(--gray-color);
          display: flex;
          width: 100%;
          flex-flow: row;
          align-items: center;
          gap: 5px;
          padding: 0;
          margin: 5px 0;
        }

        .stats > span.sp {
          margin: 0 0 0px 0;
          font-size: 0.8rem;
        }

        .stats > .stat {
          display: flex;
          flex-flow: row;
          align-items: center;
          justify-content: center;
          gap: 5px;
        }

        .stats > .stat > .label {
          color: var(--gray-color);
          font-family: var(--font-main), sans-serif;
          text-transform: lowercase;
          font-size: 0.93rem;
          font-weight: 400;
        }

        .stats > .stat > .number {
          color: var(--highlight-color);
          font-family: var(--font-main), sans-serif;
          font-size: 0.9rem;
          font-weight: 500;
        }     

        @media screen and (max-width:660px) {
          :host {
            font-size: 16px;
            border-bottom: none;
          }

          button.action,
          div.actions > .action,
          a {
            cursor: default !important;
          }
      </style>
    `;
    }
  }

  class HoverAuthor extends HTMLElement {
    constructor() {
      // We are not even going to touch this.
      super();

      // check if the user is authenticated
      this._authenticated = window.hash ? true : false;

      // Check if user is the owner of the profile
      this._you = this.getAttribute('you') === 'true' ;

      // let's create our shadow root
      this.shadowObj = this.attachShadow({ mode: "open" });

      this.parent = this.getRootNode().host;

      this.render();
    }

    // observe the attributes
    static get observedAttributes() {
      return ['followers', 'user-follow', 'reload'];
    }

    render() {
      this.shadowObj.innerHTML = this.getTemplate();
    }

    // listen for changes in the attributes
    attributeChangedCallback(name, oldValue, newValue) {
      // get the followers element
      const followers = this.shadowObj.querySelector('.stats > span.followers > .number');
      // get the follow button
      const followBtn = this.shadowObj.querySelector('.actions > .action#follow-action');
      // check if old value is not equal to new value
      if (name === 'reload') {
        if(newValue === 'true') {
          this.setAttribute('reload', 'false');

          // Update the followers
          if(followers) {
            const totalFollowers = this.parseToNumber(this.getAttribute('followers'));
            followers.textContent = totalFollowers >= 0 ? this.formatNumber(totalFollowers) : '0';
          }

          // Update the follow button
          if(followBtn) {
            this.updateFollowBtn(this.textToBoolean(this.getAttribute('user-follow')), followBtn);
          }
        }
      }  
    }

    setAttributes = (name, value) => {
      this.parent.setAttribute(name, value);
    }

    connectedCallback() {
      // Get the media query list
      const mql = window.matchMedia('(max-width: 660px)');

      // get url
      let url = this.getAttribute('url');

      url = url.trim().toLowerCase();
   
      // Get the body
      const body = document.querySelector('body');

      const contentContainer = this.shadowObj.querySelector('div.content-container');

      if (contentContainer) {
        this.mouseEvents(url, mql.matches, contentContainer);
      }

      // handle user click
      this.handleUserClick(mql.matches, url, body, contentContainer);
    }

    textToBoolean = text => {
      return text === 'true' ? true : false;
    }

    disconnectedCallback() {
      this.enableScroll();
      this.remove();
    }

    openHighlights = (body, contentContainer) => {
      // Get the stats action and subscribe action
      const statsBtn = this.shadowObj.querySelector('.actions>.action#highlights-action');

      // add event listener to the stats action
      if (statsBtn) {
        statsBtn.addEventListener('click', e => {
          e.preventDefault();
          e.stopPropagation();

          contentContainer.style.display = 'none';

          // Open the highlights popup
          body.insertAdjacentHTML('beforeend', this.getHighlights());
        });
      }
    }

    // Open user profile
    handleUserClick = (mql, url, body, contentContainer) => {
      const outerThis = this;
      // get a.meta.link
      const content = this.shadowObj.querySelector('a.meta.link');

      if(body && content) { 
        content.addEventListener('click', event => {
          event.preventDefault();

          this.enableScroll();

          // Get full post
          const profile =  outerThis.getProfile();

          if (mql) {
            // change the display of the content container
            contentContainer.style.display = 'flex';

            // Fetch content
            outerThis.fetchContent(url, mql, contentContainer);
          }
          else {
            // replace and push states
            this.replaceAndPushStates(url, body, profile);

            body.innerHTML = profile;
          }
        });
      }
    }

    // Replace and push states
    replaceAndPushStates = (url, body, profile) => {
      this.enableScroll();
      // Replace the content with the current url and body content
      // get the first custom element in the body
      const firstElement = body.firstElementChild;

      // convert the custom element to a string
      const elementString = firstElement.outerHTML;

      body.classList.remove('stop-scrolling');

      // get window location
      const pageUrl = window.location.href;
      window.history.replaceState(
        { page: 'page', content: elementString },
        url, pageUrl
      );

      // Updating History State
      window.history.pushState(
        { page: 'page', content: profile},
        url, url
      );
    }

    mouseEvents = (url, mql, contentContainer) => {
      const outerThis = this;
      // get meta link
      const metaLink = this.shadowObj.querySelector('div.author');

      if (metaLink) {
        // check if its not a mobile device
        if (!mql) {
          // add mouse enter event listener and mouse leave event listener
          metaLink.addEventListener('mouseenter', () => {
            
            // change the display of the content container
            contentContainer.style.display = 'flex';

            // Fetch content
            outerThis.fetchContent(url, mql, contentContainer);
          });

          // add mouse leave event listener
          metaLink.addEventListener('mouseleave', () => {
            // change the display of the content container
            contentContainer.style.display = 'none';

            // remove the content from the content container
            contentContainer.innerHTML = outerThis.getLoader();
          });
        }
        else {
          // add click event listener
          metaLink.addEventListener('click', e => {
            e.preventDefault();
            e.stopPropagation();
            e.stopImmediatePropagation();

            outerThis.disableScroll();

            // change the display of the content container
            contentContainer.style.display = 'flex';

            // Fetch content
            outerThis.fetchContent(url, mql, contentContainer);
          });
        }
      }
    }

    fetchContent = (url, mql, contentContainer) => {
      const outerThis = this;
      // Get the body
      const body = document.querySelector('body');
      const content = this.getContent();
      setTimeout(() => {
        // change the content of the content container
        contentContainer.innerHTML = content;

        // Activate view
        outerThis.activateView(url, body);

        // perform actions
        outerThis.performActions();

        // Activate username link
        outerThis.activateUsernameLink(url, body);

        // open Highlights
        outerThis.openHighlights(body, contentContainer);

        if (mql) {
          const overlayBtn = outerThis.shadowObj.querySelector('span.pointer');
          // if overlayBtn
          if (overlayBtn) {
            // add mouse leave event listener
            overlayBtn.addEventListener('click', e => {
              e.preventDefault();
              e.stopImmediatePropagation();
              e.stopPropagation();
    
              // change the display of the content container
              contentContainer.style.display = 'none';

              outerThis.enableScroll();
    
              // remove the content from the content container
              contentContainer.innerHTML = outerThis.getLoader();
            });
          }      }
      }, 2000);
    }

    // Open user profile
    activateView = (url, body) => {
      const outerThis = this;
      // get a.action.view
      const content = this.shadowObj.querySelector('.actions > a.action.view');

      if(body && content) {
        content.addEventListener('click', event => {
          event.preventDefault();

          // Get full post
          const profile =  outerThis.getProfile();
    
          // replace and push states
          this.replaceAndPushStates(url, body, profile);

          body.innerHTML = profile;

          setTimeout(() => {
            outerThis.enableScroll();
          }, 2000);
        });
      }
    }

    // Open user profile
    activateUsernameLink = (url, body) => {
      const outerThis = this;
      // get div.name > a.username
      const content = this.shadowObj.querySelector('.top > .name > a.username');

      if(body && content) {
        content.addEventListener('click', event => {
          event.preventDefault();

          outerThis.enableScroll();

          body.classList.remove('stop-scrolling');

          // Get full post
          const profile =  outerThis.getProfile();
    
          // replace and push states
          this.replaceAndPushStates(url, body, profile);

          body.innerHTML = profile;

          setTimeout(() => {
            outerThis.enableScroll();
          }, 2000);
        });
      }
    }

    disableScroll() {
      // Get the current page scroll position
      let scrollTop = window.scrollY || document.documentElement.scrollTop;
      let scrollLeft = window.scrollX || document.documentElement.scrollLeft;
      document.body.classList.add("stop-scrolling");

      // if any scroll is attempted, set this to the previous value
      window.onscroll = function () {
        window.scrollTo(scrollLeft, scrollTop);
      };
    }

    enableScroll() {
      const body = document.querySelector('body');
      body.classList.remove("stop-scrolling");
      window.onscroll = function () { };
    }

    // perform actions
    performActions = () => {
      const contentContainer = this.shadowObj.querySelector('div.content-container');
      const outerThis = this;
      // get body 
      const body = document.querySelector('body');

      // get url to 
      let hash = this.getAttribute('hash');
      // trim and convert to lowercase
      hash = hash.trim().toLowerCase();

      // base api
      const url = '/api/v1/u/' + hash;

      // Get the follow action and subscribe action
      const followBtn = this.shadowObj.querySelector('.actions>.action#follow-action');

      // add event listener to the follow action
      if (followBtn) {
        // construct options
        const options = {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json',
          }
        };

        followBtn.addEventListener('click', e => {
          e.preventDefault();
          e.stopPropagation();

          let action = false;

          // Check if the user is authenticated
          if (!this._authenticated) {
            // Open the join popup
            this.openJoin(body, contentContainer);
          } 
          else {
            // Update the follow button
            if (followBtn.classList.contains('following')) {
              action = true;
              outerThis.updateFollowBtn(false, followBtn);
            }
            else {
              outerThis.updateFollowBtn(true, followBtn);
            }

            // Follow the topic
            this.followUser(`${url}/follow`, options, followBtn, action);
          }
        });
      }
    }

    followUser = (url, options, followBtn, followed) => {
      const contentContainer = this.shadowObj.querySelector('div.content-container');
      const outerThis = this;
      this.fetchWithTimeout(url, options)
        .then(response => {
          response.json()
          .then(data => {
            // If data has unverified, open the join popup
            if (data.unverified) {
              // Get body
              const body = document.querySelector('body');

              // Open the join popup
              outerThis.openJoin(body, contentContainer);

              // revert the follow button
              outerThis.updateFollowBtn(followed, followBtn);
            }

            // if success is false, show toast message
            if (!data.success) {
              outerThis.showToast(data.message, false);

              // revert the follow button
              outerThis.updateFollowBtn(followed, followBtn);
            }
            else {
              // Show toast message
              outerThis.showToast(data.message, true);

              // Check for followed boolean
              outerThis.updateFollowBtn(data.followed, followBtn);

              // Update the followers
              // outerThis.updateFollowers(data.followed);
            }
          });
        })
        .catch(_error => {
          // console.log(_error);
          // show toast message
          outerThis.showToast('An error occurred!', false);

          // revert the follow button
          outerThis.updateFollowBtn(followed, followBtn);
        });
    }

    fetchWithTimeout = async (url, options = {}, timeout = 9500) => {
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), timeout);
    
      try {
        const response = await fetch(url, {
          ...options,
          signal: controller.signal
        });

        return response;
      } catch (error) {
        if (error.name === 'AbortError') {
          throw new Error('Request timed out');
        }
        throw new Error(`Network error: ${error.message}`);
      } finally {
        clearTimeout(timeoutId);
      }
    };;

    updateFollowBtn = (following, btn) => {
      if (following) {
        // Change the text to following
        btn.textContent = 'following';

        // remove the follow class
        btn.classList.remove('follow');

        // add the following class
        btn.classList.add('following');
      }
      else {
        // Change the text to follow
        btn.textContent = 'follow';

        // remove the following class
        btn.classList.remove('following');

        // add the follow class
        btn.classList.add('follow');
      }
    }

    showToast = (text, success) => {
      // Get the toast element
      const toast = this.getToast(text, success);

      // Get body element
      const body = document.querySelector('body');

      // Insert the toast into the DOM
      body.insertAdjacentHTML('beforeend', toast);

      // Remove the toast after 3 seconds
      setTimeout(() => {
        // Select the toast element
        const toast = body.querySelector('.toast');

        // Remove the toast
        if(toast) {
          toast.remove();
        }
      }, 3000);
    }

    getToast = (text, success) => {
      if (success) {
        return /* html */`
        <div class="toast true">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" fill="currentColor">
          <path d="M8 16A8 8 0 1 1 8 0a8 8 0 0 1 0 16Zm3.78-9.72a.751.751 0 0 0-.018-1.042.751.751 0 0 0-1.042-.018L6.75 9.19 5.28 7.72a.751.751 0 0 0-1.042.018.751.751 0 0 0-.018 1.042l2 2a.75.75 0 0 0 1.06 0Z"></path>
        </svg>
          <p class="toast-message">${text}</p>
        </div>
      `;
      }
      else {
        return /* html */`
      <div class="toast false">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" fill="currentColor">
          <path d="M2.343 13.657A8 8 0 1 1 13.658 2.343 8 8 0 0 1 2.343 13.657ZM6.03 4.97a.751.751 0 0 0-1.042.018.751.751 0 0 0-.018 1.042L6.94 8 4.97 9.97a.749.749 0 0 0 .326 1.275.749.749 0 0 0 .734-.215L8 9.06l1.97 1.97a.749.749 0 0 0 1.275-.326.749.749 0 0 0-.215-.734L9.06 8l1.97-1.97a.749.749 0 0 0-.326-1.275.749.749 0 0 0-.734.215L8 6.94Z"></path>
        </svg>
          <p class="toast-message">${text}</p>
        </div>
      `;
      }
      
    }

    openJoin = (body, contentContainer) => {
      // change the display of the content container
      contentContainer.style.display = 'none';
      // Insert getJoin beforeend
      body.insertAdjacentHTML('beforeend', this.getJoin());
    }

    getJoin = () => {
      // get url from the : only the path
      const url = window.location.pathname;

      return /* html */`
      <join-popup register="/join/register" login="/join/login" next="${url}"></join-popup>
    `
    }

    updateFollowers = (followed) => {
      const outerThis = this;
      let value = followed ? 1 : -1;
      // Get followers attribute : convert to number then add value

      let followers = this.parseToNumber(this.getAttribute('followers')) + value;

      // if followers is less than 0, set it to 0
      followers = followers < 0 ? 0 : followers;

      // Set the followers attribute
      this.setAttribute('followers', followers.toString());
      this.setAttribute('user-follow', followed.toString());

      this.setAttribute('updated', 'true');

      this.setAttributes('author-followers', followers.toString());
      this.setAttributes('author-follow', followed.toString());

      // select the followers element
      const followersStat = outerThis.shadowObj.querySelector('.stats > span.followers');
      if (followersStat) {
        // select no element
        const no = followersStat.querySelector('.number');
        const text = followersStat.querySelector('.label');

        // Update the followers
        no.textContent = this.formatNumber(followers);

        // Update the text
        text.textContent = followers === 1 ? 'follower' : 'followers';
      }
    }

    formatNumber = n => {
      if (n >= 0 && n <= 999) {
        return n.toString();
      } else if (n >= 1000 && n <= 9999) {
        const value = (n / 1000).toFixed(2);
        return `${value}k`;
      } else if (n >= 10000 && n <= 99999) {
        const value = (n / 1000).toFixed(1);
        return `${value}k`;
      } else if (n >= 100000 && n <= 999999) {
        const value = (n / 1000).toFixed(0);
        return `${value}k`;
      } else if (n >= 1000000 && n <= 9999999) {
        const value = (n / 1000000).toFixed(2);
        return `${value}M`;
      } else if (n >= 10000000 && n <= 99999999) {
        const value = (n / 1000000).toFixed(1);
        return `${value}M`;
      } else if (n >= 100000000 && n <= 999999999) {
        const value = (n / 1000000).toFixed(0);
        return `${value}M`;
      } else if (n >= 1000000000) {
        return "1B+";
      }
      else {
        return 0;
      }
    }

    parseToNumber = num_str => {
      // Try parsing the string to an integer
      const num = parseInt(num_str);

      // Check if parsing was successful
      if (!isNaN(num)) {
        return num;
      } else {
        return 0;
      }
    }

    getTemplate() {
      // Show HTML Here
      return `
      ${this.getBody()}
      ${this.getStyles()}
    `;
    }

    getBody = () => {
      return /* html */`
      <div class="author">
        ${this.getLink()}
        <div data-expanded="false" class="content-container">
          ${this.getLoader()}
        </div>
      </div>
    `
    }

    getContent = () => {
      return /* html */`
      <span class="pointer"></span>
      <div class="overlay">
        ${this.getHeader()}
        ${this.getStats()}
        ${this.getBio()}
        ${this.getActions()}
      </div>
		`
    }

    getLink = () => {
      // Get username
      let username = this.getAttribute('hash');

      // GET url
      let url = this.getAttribute('url');

      // trim white spaces and convert to lowercase
      url = url.trim().toLowerCase();

      // trim white spaces to username and convert to uppercase
      username = username.trim().toUpperCase();

      return /* html */`
      <a href="${url}" class="meta link">${username}</a>
    `
    }

    getHeader = () => {
      // Get username
      let username = this.getAttribute('hash');

      // trim username and convert to uppercase
      username = username.trim().toUpperCase();

      // Get name and check if it's greater than 20 characters
      const name = this.getAttribute('name');

      // GET url
      let url = this.getAttribute('url');

      // trim white spaces and convert to lowercase
      url = url.trim().toLowerCase();

      // Check if the name is greater than 20 characters: replace the rest with ...
      let displayName = name.length > 20 ? `${name.substring(0, 20)}..` : name;

      return /* html */ `
      <div class="top">
        ${this.getPicture(this.getAttribute('picture'))}
        <div class="name">
          <h4 class="name">
            <span class="name">${displayName}</span>
          </h4>
          <a href="${url}" class="username">
            <span class="text">${username}</span>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" fill="currentColor">
              <path d="M4.53 4.75A.75.75 0 0 1 5.28 4h6.01a.75.75 0 0 1 .75.75v6.01a.75.75 0 0 1-1.5 0v-4.2l-5.26 5.261a.749.749 0 0 1-1.275-.326.749.749 0 0 1 .215-.734L9.48 5.5h-4.2a.75.75 0 0 1-.75-.75Z" />
            </svg>
          </a>
        </div>
      </div>
    `
    }

    getPicture = picture => {
      // check if picture is empty || null || === "null"
      if (picture === '' || picture === null || picture === 'null') {
        return /*html*/`
        <div class="avatar svg">
          <div class="svg-avatar">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
              <path d="M12 2.5a5.5 5.5 0 0 1 3.096 10.047 9.005 9.005 0 0 1 5.9 8.181.75.75 0 1 1-1.499.044 7.5 7.5 0 0 0-14.993 0 .75.75 0 0 1-1.5-.045 9.005 9.005 0 0 1 5.9-8.18A5.5 5.5 0 0 1 12 2.5ZM8 8a4 4 0 1 0 8 0 4 4 0 0 0-8 0Z"></path>
            </svg>
          </div>
          ${this.checkVerified(this.getAttribute('verified'))}
        </div>
      `
      }
      else {
        return /*html*/`
        <div class="avatar">
          <img src="${picture}" alt="Author picture">
          ${this.checkVerified(this.getAttribute('verified'))}
        </div>
      `
      }
    }

    checkVerified = verified => {
      if (verified === 'true') {
        return /*html*/`
        <svg width="26" height="26" viewBox="0 0 26 26" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M16.3592 1.41412C15.9218 0.966482 15.3993 0.610789 14.8224 0.367944C14.2455 0.125098 13.6259 0 13 0C12.3741 0 11.7545 0.125098 11.1776 0.367944C10.6007 0.610789 10.0782 0.966482 9.64079 1.41412L8.62993 2.45091L7.18354 2.43304C6.55745 2.42563 5.93619 2.54347 5.35631 2.77964C4.77642 3.01581 4.24962 3.36554 3.80687 3.80826C3.36413 4.25098 3.01438 4.77775 2.77819 5.3576C2.542 5.93744 2.42415 6.55866 2.43156 7.18472L2.44781 8.63102L1.41421 9.64181C0.966543 10.0792 0.610827 10.6017 0.367967 11.1785C0.125106 11.7554 0 12.3749 0 13.0008C0 13.6267 0.125106 14.2462 0.367967 14.8231C0.610827 15.3999 0.966543 15.9224 1.41421 16.3598L2.44944 17.3706L2.43156 18.8169C2.42415 19.443 2.542 20.0642 2.77819 20.644C3.01438 21.2239 3.36413 21.7506 3.80687 22.1934C4.24962 22.6361 4.77642 22.9858 5.35631 23.222C5.93619 23.4582 6.55745 23.576 7.18354 23.5686L8.62993 23.5523L9.64079 24.5859C10.0782 25.0335 10.6007 25.3892 11.1776 25.6321C11.7545 25.8749 12.3741 26 13 26C13.6259 26 14.2455 25.8749 14.8224 25.6321C15.3993 25.3892 15.9218 25.0335 16.3592 24.5859L17.3701 23.5507L18.8165 23.5686C19.4426 23.576 20.0638 23.4582 20.6437 23.222C21.2236 22.9858 21.7504 22.6361 22.1931 22.1934C22.6359 21.7506 22.9856 21.2239 23.2218 20.644C23.458 20.0642 23.5758 19.443 23.5684 18.8169L23.5522 17.3706L24.5858 16.3598C25.0335 15.9224 25.3892 15.3999 25.632 14.8231C25.8749 14.2462 26 13.6267 26 13.0008C26 12.3749 25.8749 11.7554 25.632 11.1785C25.3892 10.6017 25.0335 10.0792 24.5858 9.64181L23.5506 8.63102L23.5684 7.18472C23.5758 6.55866 23.458 5.93744 23.2218 5.3576C22.9856 4.77775 22.6359 4.25098 22.1931 3.80826C21.7504 3.36554 21.2236 3.01581 20.6437 2.77964C20.0638 2.54347 19.4426 2.42563 18.8165 2.43304L17.3701 2.44929L16.3592 1.41412Z" 
            fill="currentColor" id="top"/>
          <path d="M15.3256 4.97901C15.0228 4.6691 14.661 4.42285 14.2616 4.25473C13.8623 4.08661 13.4333 4 13 4C12.5667 4 12.1377 4.08661 11.7384 4.25473C11.339 4.42285 10.9772 4.6691 10.6744 4.97901L9.97457 5.69678L8.97322 5.68441C8.53977 5.67928 8.10967 5.76086 7.70821 5.92437C7.30675 6.08787 6.94204 6.32999 6.63553 6.63649C6.32901 6.94298 6.08688 7.30767 5.92336 7.70911C5.75985 8.11054 5.67826 8.54061 5.68339 8.97403L5.69464 9.97532L4.97907 10.6751C4.66914 10.9779 4.42288 11.3396 4.25475 11.739C4.08661 12.1383 4 12.5673 4 13.0006C4 13.4339 4.08661 13.8628 4.25475 14.2621C4.42288 14.6615 4.66914 15.0232 4.97907 15.326L5.69577 16.0258L5.68339 17.0271C5.67826 17.4605 5.75985 17.8906 5.92336 18.292C6.08688 18.6935 6.32901 19.0581 6.63553 19.3646C6.94204 19.6711 7.30675 19.9133 7.70821 20.0768C8.10967 20.2403 8.53977 20.3218 8.97322 20.3167L9.97457 
            20.3055L10.6744 21.021C10.9772 21.3309 11.339 21.5771 11.7384 21.7453C12.1377 21.9134 12.5667 22 13 22C13.4333 22 13.8623 21.9134 14.2616 21.7453C14.661 21.5771 15.0228 21.3309 15.3256 21.021L16.0254 20.3043L17.0268 20.3167C17.4602 20.3218 17.8903 20.2403 18.2918 20.0768C18.6932 19.9133 19.058 19.6711 19.3645 19.3646C19.671 19.0581 19.9131 18.6935 20.0766 18.292C20.2402 17.8906 20.3217 17.4605 20.3166 17.0271L20.3054 16.0258L21.0209 15.326C21.3309 15.0232 21.5771 14.6615 21.7453 14.2621C21.9134 13.8628 22 13.4339 22 13.0006C22 12.5673 21.9134 12.1383 21.7453 11.739C21.5771 11.3396 21.3309 10.9779 21.0209 10.6751L20.3042 9.97532L20.3166 8.97403C20.3217 8.54061 20.2402 8.11054 20.0766 7.70911C19.9131 7.30767 19.671 6.94298 19.3645 6.63649C19.058 6.32999 18.6932 6.08787 18.2918 5.92437C17.8903 5.76086 17.4602 5.67928 17.0268 5.68441L16.0254 5.69566L15.3256 4.97901ZM15.6485 11.7113L12.2732 15.0864C12.2209 15.1388 12.1588 15.1803 12.0905 15.2087C12.0222 15.2371 11.9489 15.2517 11.8749 15.2517C11.8009 15.2517 11.7276 15.2371 11.6593 15.2087C11.5909 15.1803 11.5289 15.1388 11.4766 15.0864L9.78893 13.3988C9.73662 13.3465 9.69513 13.2844 9.66683 13.2161C9.63852 13.1478 9.62395 13.0745 9.62395 13.0006C9.62395 12.9266 9.63852 12.8534 9.66683 12.785C9.69513 12.7167 9.73662 12.6546 9.78893 12.6023C9.84123 12.55 9.90333 12.5085 9.97166 12.4802C10.04 12.4519 10.1132 12.4373 10.1872 12.4373C10.2612 12.4373 10.3344 12.4519 10.4028 12.4802C10.4711 12.5085 10.5332 12.55 10.5855 12.6023L11.8749 13.8927L14.8519 10.9147C14.9576 10.8091 15.1008 10.7498 15.2502 10.7498C15.3996 10.7498 15.5429 10.8091 15.6485 10.9147C15.7542 11.0204 15.8135 11.1636 15.8135 11.313C15.8135 11.4624 15.7542 11.6056 15.6485 11.7113Z" 
            fill="currentColor" id="bottom"/>
        </svg>
			`
      }
      else {
        return ''
      }
    }

    getStats = () => {
      // Get total followers & following and parse to integer
      const followers = this.getAttribute('followers') || 0;
      const following = this.getAttribute('following') || 0;

      // Convert the followers & following to a number
      const totalFollowers = this.parseToNumber(followers);
      const totalFollowing = this.parseToNumber(following);

      //  format the number
      const followersFormatted = this.formatNumber(totalFollowers);
      const followingFormatted = this.formatNumber(totalFollowing);


      return /* html */`
      <div class="stats">
        <span class="stat followers">
          <span class="number">${followersFormatted}</span>
          <span class="label">${totalFollowers === 1 ? 'follower' : 'followers'}</span>
        </span>
        <span class="sp">•</span>
        <span class="stat following">
          <span class="number">${followingFormatted}</span>
          <span class="label">Following</span>
        </span>
      </div>
		`
    }

    getBio = () => {
      //mql
      const mql = window.matchMedia('(max-width: 660px)');

    
      // Get bio content
      let bio = this.getAttribute('bio') || 'The user has not added their bio yet.';

      // trim white spaces
      bio = bio.trim();

      if(mql.matches) {
        let bioArray = bio.split('\n');
        // Check if bio is greater than 100 characters: replace the rest with ...
        let html = bioArray.map(line => `<p>${line}</p>`).join('');
        return /*html*/`
        <div class="bio">${html}</div>
      `
      }
      else {
        // Check if bio is greater than 100 characters: replace the rest with ...
        let html = bio.length > 85 ? `<p>${bio.substring(0, 90)}...</p>` : `<p>${bio}</p>`;

        return /*html*/`
        <div class="bio">${html}</div>
      `
      }
    }

    getActions = () => {
      return /*html*/`
      <div class="actions">
        ${this.checkYou(this._you)}
      </div>
    `;
    }

    // check is the current user: you === true
    checkYou = you => {
      // get url
      let url = this.getAttribute('url');

      // trim white spaces and convert to lowercase
      url = url.trim().toLowerCase();

      if (you) {
        return /*html*/`
        <span class="action you">You</span>
        <a href="${url}" class="action view" id="view-action">view</a>
        <span class="action highlights" id="highlights-action">stats</span>
      `
      }
      else {
        return /*html*/`
        <a href="${url}" class="action view" id="view-action">view</a>
        ${this.checkFollowing(this.getAttribute('user-follow'))}
        <span class="action highlights" id="highlights-action">stats</span>
      `
      }
    }

    checkFollowing = following => {
      if (following === 'true') {
        return /*html*/`
        <span class="action following" id="follow-action">Following</span>
			`
      }
      else {
        return /*html*/`
        <span class="action follow" id="follow-action">Follow</span>
			`
      }
    }

    getLoader = () => {
      return /*html*/`
      <span class="pointer"></span>
      <div class="overlay">
        <hover-loader speed="300"></hover-loader>
      </div>
		`
    }

    getProfile = () => {
      // get url
      let url = this.getAttribute('url');
    
      // trim white spaces and convert to lowercase
      url = url.trim().toLowerCase();

      return /* html */`
      <app-profile you="${this.getAttribute('you')}" url="${url}" tab="stories"
        stories-url="/api/v1${url}/stories" replies-url="/api/v1${url}/replies" stories="${this.getAttribute('stories')}" replies="${this.getAttribute('replies')}"
        followers-url="/api/v1${url}/followers" following-url="/api/v1${url}/following"
        hash="${this.getAttribute('hash')}" picture="${this.getAttribute('picture')}" verified="${this.getAttribute('verified')}"
        name="${this.getAttribute('name')}" followers="${this.getAttribute('followers')}" contact='${this.getAttribute("contact")}'
        following="${this.getAttribute('following')}" user-follow="${this.getAttribute('user-follow')}" bio="${this.getAttribute('bio')}">
      </app-profile>
    `
    }

    getHighlights = () => {
      // get url
      const url = this.getAttribute('url');
    
      // trim white spaces and convert to lowercase
      let formattedUrl = url.toLowerCase();

      return /* html */`
      <stats-popup url="/api/v1${formattedUrl}/stats" name="${this.getAttribute('name')}"
        followers="${this.getAttribute('followers')}" following="${this.getAttribute('following')}" 
        stories="${this.getAttribute('stories')}" replies="${this.getAttribute('replies')}">
      </stats-popup>
    `
    }

    getStyles() {
      return /* css */`
      <style>
        *,
        *:after,
        *:before {
          box-sizing: border-box !important;
          font-family: inherit;
          -webkit-box-sizing: border-box !important;
        }

        *:focus {
          outline: inherit !important;
        }

        *::-webkit-scrollbar {
          -webkit-appearance: none;
        }

        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
          padding: 0;
          margin: 0;
          font-family: inherit;
        }

        p,
        ul,
        ol {
          padding: 0;
          margin: 0;
        }

        a {
          text-decoration: none;
        }

        :host {
          /*border: var(--border);*/
          font-size: 16px;
          padding: 0;
          display: flex;
          flex-flow: column;
          gap: 0;
          margin: 0 0 -1px 0;
        }

        .author {
          position: relative;
          padding: 0;
          height: 30px;
          width: max-content;
          display: flex;
          flex-flow: column;
          justify-content: center;
          gap: 0px;
        }
        
        a.meta.link {
          height: max-content;
          display: flex;
          height: 30px;
          align-items: center;
          font-family: var(--font-mono),monospace;
          gap: 5px;
          font-size: 0.9rem;
          line-height: 1.5;
          text-decoration: none;
          text-decoration: none;
          color: transparent;
          background: var(--accent-linear);
          background-clip: text;
          -webkit-background-clip: text;
        }
        
        .content-container {
          border: var(--border);
          position: absolute;
          z-index: 4;
          background-color: var(--background);
          top: 0;
          left: -30px;
          top: calc(100% - 1px);
          box-shadow: var(--card-box-shadow-alt);
          padding: 10px;
          width: 380px;
          height: max-content;
          display: none;
          flex-flow: column;
          align-items: start;
          gap: 8px;
          border-radius: 12px;
          -webkit-border-radius: 12px;
          -moz-border-radius: 12px;
        }

        @keyframes fadeIn {
          from {
            opacity: 0;
          }
          to {
            opacity: 1;
          }
        }
        
        .author:hover .content-container {
          animation: fadeIn 500ms ease-in-out;
        }
        
        .content-container  span.pointer {
          position: absolute;
          top: -5px;
          left: 70px;
          rotate: 45deg;
          width: 10px;
          height: 10px;
          background: var(--background);
          border-left: var(--border);
          border-top: var(--border);
        }

        .content-container > .overlay {
          display: flex;
          flex-flow: column;
          align-items: start;
          gap: 8px;
          width: 100%;
        }
        
        .top {
          display: flex;
          width: 100%;
          flex-flow: row;
          align-items: center;
          gap: 8px;
        }
        
        .top > .avatar {
          position: relative;
          width: 45px;
          height: 45px;
          border-radius: 50%;
          -webkit-border-radius: 50%;
          -moz-border-radius: 50%;
        }

        .top > .avatar.svg {
          background: var(--gray-background);
        }

        .top > .avatar.svg > .svg-avatar {
          display: flex;
          align-items: center;
          justify-content: center;
          width: 100%;
          height: 100%;
          border-radius: 50%;
          -webkit-border-radius: 50%;
          -moz-border-radius: 50%;
        }

        .top > .avatar.svg > .svg-avatar > svg {
          width: 26px;
          height: 26px;
          color: var(--gray-color);
          display: flex;
          margin: 0 0 2px 0;
        }
        
        .top > .avatar > img {
          width: 100%;
          height: 100%;
          overflow: hidden;
          object-fit: cover;
          border-radius: 50%;
          -webkit-border-radius: 50%;
          -moz-border-radius: 50%;
        }

        .top > .avatar > svg {
          position: absolute;
          bottom: 0px;
          right: -3px;
          width: 20px;
          height: 20px;
          z-index: 1;
          display: flex;
          align-items: center;
          justify-content: center;
          border-radius: 50%;
        }

        .top > .avatar > svg path#top {
          color: var(--background);
        }
        
        .top > .avatar > svg path#bottom {
          color: var(--accent-color);
        }
        
        .top > .name {
          display: flex;
          justify-content: center;
          flex-flow: column;
          gap: 0;
        }
        
        .top > .name > h4.name {
          margin: 0;
          display: flex;
          align-items: center;
          gap: 5px;
          line-height: 1.2;
          color: var(--title-color);
          font-family: var(--font-main), sans-serif;
          font-size: 1.1rem;
          font-weight: 600;
        }
        
        .top > .name > h4.name svg {
          color: var(--alt-color);
          margin: 5px 0 0 0;
        }
        
        .top > .name > a.username {
          color: var(--gray-color);
          font-family: var(--font-mono), monospace;
          font-size: 0.9rem;
          font-weight: 500;
          text-decoration: none;
          display: flex;
          gap: 2px;
          align-items: center;
        }

        .top > .name > a.username svg {
          color: var(--gray-color);
          width: 15px;
          height: 15px;
          margin: 3px 0 0 0;
        }

        .top > .name > a.username:hover {
          color: transparent;
          background: var(--accent-linear);
          background-clip: text;
          -webkit-background-clip: text;
        }

        .top > .name > a.username:hover svg {
          color: var(--accent-color);
        }
        
        .stats {
          color: var(--gray-color);
          display: flex;
          width: 100%;
          flex-flow: row;
          align-items: center;
          gap: 10px;
        }

        .stats > span.sp {
          margin: 0 0 -3px 0;
        }
        
        .stats > .stat {
          display: flex;
          flex-flow: row;
          align-items: center;
          gap: 5px;
        }
        
        .stats > .stat > .label {
          color: var(--gray-color);
          font-family: var(--font-main), sans-serif;
          text-transform: lowercase;
          font-size: 1rem;
          font-weight: 400;
        }
        
        .stats > .stat > .number {
          color: var(--highlight-color);
          font-family: var(--font-main), sans-serif;
          font-size: 0.85rem;
          font-weight: 500;
          margin: 0 0 -2px 0;
        }
        
        .bio {
          display: flex;
          flex-flow: column;
          gap: 5px;
          color: var(--text-color);
          font-family: var(--font-text), sans-serif;
        }
        
        .bio > p {
          margin: 0;
          font-size: 1rem;
          font-weight: 400;
          line-height: 1.4;
        }
        
        .actions {
          display: flex;
          font-family: var(--font-main), sans-serif;
          width: 100%;
          flex-flow: row;
          align-items: center;
          gap: 20px;
          margin: 5px 0 3px;
        }
        
        .actions > .action {
          border: var(--action-border);
          text-decoration: none;
          color: var(--text-color);
          font-size: 0.9rem;
          cursor: pointer;
          display: flex;
          width: max-content;
          flex-flow: row;
          align-items: center;
          text-transform: lowercase;
          justify-content: center;
          padding: 2px 12px 3px;
          border-radius: 10px;
          -webkit-border-radius: 10px;
          -moz-border-radius: 10px;
        }

        .actions > .action.you {
          text-transform: capitalize;
          padding: 3px 12px 3px;
          cursor: default;
          pointer-events: none;
          border: none;
          background: var(--gray-background);
        }
        
        .actions > .action.follow {
          border: none;
          padding: 3px 12px 3px;
          font-weight: 500;
          background: var(--accent-linear);
          color: var(--white-color);
        }

        @media screen and (max-width: 660px) {
          ::-webkit-scrollbar {
            -webkit-appearance: none;
          }

          a,
          span.stat,
          .actions > .action,
          span.action {
            cursor: default !important;
          }

          a.meta.link {
            height: max-content;
            display: flex;
            height: 30px;
            align-items: center;
            font-family: var(--font-mono),monospace;
            gap: 5px;
            font-size: 0.9rem;
            font-weight: 500;
            line-height: 1.5;
            text-decoration: none;
            text-decoration: none;
            color: transparent;
            background: var(--accent-linear);
            background-clip: text;
            -webkit-background-clip: text;
          }

          .content-container {
            border: none;
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            z-index: 100;
            background-color: var(--modal-overlay);
            backdrop-filter: blur(3px);
            -webkit-backdrop-filter: blur(3px);
            min-width: 100dvw;
            width: 100dvw;
            height: 100dvh;
            padding: 0;
            width: max-content;
            display: none;
            flex-flow: column;
            border-radius: 0;
          }
        
          .content-container > .overlay {
            position: absolute;
            background-color: var(--background);
            bottom: 0;
            width: 100%;
            gap: 10px;
            z-index: 1000;
            padding: 18px 10px 20px;
            border-top-left-radius: 15px;
            border-top-right-radius: 15px;
          }
        
          .content-container  span.pointer {
            border: none;
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            min-width: 100dvw;
            min-height: 100dvh;
            rotate: 0deg;
            background-color: var(--modal-overlay);
          }
        }
      </style>
    `;
    }
  }

  class VotesAuthor extends HTMLElement {
    constructor() {
      // We are not even going to touch this.
      super();

      // check if the user is authenticated
      this._authenticated = window.hash ? true : false;

       // Get array of objects for poll options and parse to Array
      this._options = this.combinePollAndVotes(this.getAttribute('options'), this.getAttribute('votes'));

      // Get the end time for the poll
      this._endTime = new Date(this.getAttribute('end-time'));

      // Check if user has voted and convert to boolean
      this._voted = this.getAttribute('voted') === 'true' ;

      this._selected = this.getAttribute('selected') || 'none';

      // Check if user is the owner of the profile
      this._you = this.getAttribute('you') === 'true' ;

      // let's create our shadow root
      this.shadowObj = this.attachShadow({ mode: "open" });

      this.parent = this.getRootNode().host;

      this.render();
    }

    setAttributes = (name, value) => {
      this.parent.setAttribute(name, value);
    }

    combinePollAndVotes = (poll, votes) => {
      // convert the poll string to an array
      const pollArray = poll.split(',');

      // convert the votes string to an array
      const votesArray = votes.split(',');

      // combine the poll and votes arrays to an object named options
      return pollArray.map((option, index) => {
        return {
          name: index + 1,
          text: option,
          votes: this.parseToNumber(votesArray[index])
        }
      });
    }

    separatePollAndVotes = options => {
      // get the options
      const poll = options.map(option => option.text).join(',');

      // get the votes
      const votes = options.map(option => option.votes).join(',');

      return { poll, votes };
    }

    // observe the attributes
    static get observedAttributes() {
      return ['options', 'votes', 'end-time', 'voted', 'selected', 'you', 'reload', 'vote'];
    }

    // listen for changes in the attributes
    attributeChangedCallback(name, oldValue, newValue) {
      // Check if the attribute is reload
      if (name === 'reload') {

        if (newValue === 'true') {
          // re-render the component
          this.render();

          this.setAttribute('reload', false);

          // re attach the event listeners
          this.updatePollTime();
          // Check if user has voted
          if (this._voted) {
            // disable all inputs
            this.disableInputs();
          }
          else {
            // Listen for checked radio button
            this.listenForChecked();
          }
        }
      }

      if (name === 'vote') {
        const value = this.parseToNumber(this.getAttribute('vote'));
        if(value === 0) {
          return;
        }

        this.setAttribute('vote', 0);
        // add one to the option votes where the option name is equal to the new value
        this._options = this._options.map(option => {
          if (option.name === value) {
            return { ...option, votes: option.votes + 1 };
          }
          else {
            return option;
          }
        });
        

        // update votes attribute
        this.setAttribute('votes', this._options.map(option => option.votes).join(','));

        this.render();

        // re attach the event listeners
        this.updatePollTime();
        // Check if user has voted
        if (this._voted) {
          // disable all inputs
          this.disableInputs();
        }
        else {
          // Listen for checked radio button
          this.listenForChecked();
        }
      }  
    }

    render() {
      this.shadowObj.innerHTML = this.getTemplate();
    }

    connectedCallback() {
      // Update poll expiry time per second
      this.updatePollTime();

      // Check if user has voted
      if (this._voted) {
        // disable all inputs
        this.disableInputs();
      }
      else {
        // Listen for checked radio button
        this.listenForChecked();
      }
    }

    convertToBool = str => {
      return str === 'true' ? true : false;
    }

    disableScroll() {
      // Get the current page scroll position
      let scrollTop = window.scrollY || document.documentElement.scrollTop;
      let scrollLeft = window.scrollX || document.documentElement.scrollLeft;
      document.body.classList.add("stop-scrolling");

      // if any scroll is attempted, set this to the previous value
      window.onscroll = function () {
        window.scrollTo(scrollLeft, scrollTop);
      };
    }

    enableScroll() {
      document.body.classList.remove("stop-scrolling");
      window.onscroll = function () { };
    }

    // perform actions
    performVote = (option, selected, votes) => {
      // get url to 
      let hash = this.getAttribute('hash');
      // trim and convert to lowercase
      hash = hash.trim().toLowerCase();

      // base api
      const url = `/api/v1/p/${hash}/vote/${option}`;

      // define options 
      const options = {
        method: 'POST',
        headers: {
          'Content-Type': 'application',
          'Accept': 'application/json',
        }
      };

      // Vote for the story
      this.vote(url, options, selected, votes);
    }

    vote = (url, options, selectedOption, votes) => {
      const outerThis = this;
      this.fetchWithTimeout(url, options)
        .then(response => {
          response.json()
          .then(data => {
            // If data has unverified, open the join popup
            if (data.unverified) {
              // Get body
              const body = document.querySelector('body');

              // Open the join popup
              outerThis.openJoin(body);

              outerThis.showToast(data.message, false);

              // revert selected to null
              outerThis.setAttribute('selected', null);

              outerThis.setAttribute('voted', 'false');

              selectedOption.setAttribute('votes', votes);

              outerThis._voted = false;
              
              // update reload attribute to true
              outerThis.setAttribute('reload', 'true');
            }

            // if success is false, show toast message
            if (!data.success) {
              outerThis.showToast(data.message, false);

              // revert selected to null
              outerThis.setAttribute('selected', null);

              outerThis.setAttribute('voted', 'false');
              selectedOption.setAttribute('votes', votes);

              outerThis._voted = false;
              
              // update reload attribute to true
              outerThis.setAttribute('reload', 'true');
            }
            else {
              // Show toast message
              outerThis.showToast(data.message, true);

              outerThis._voted = true;

              // update the voted attribute
              const sepObj = outerThis.separatePollAndVotes(outerThis._options);
              // set attributes
              outerThis.setAttributes('options', sepObj.poll);
              outerThis.setAttributes('votes', sepObj.votes);
              outerThis.setAttributes('voted', 'true');
              outerThis.setAttributes('selected', data.vote[0].option);
            }
          });
        })
        .catch(_error => {
          outerThis.showToast('An error occurred!', false);

          outerThis.setAttribute('voted', 'false');
          selectedOption.setAttribute('votes', votes);
          outerThis._voted = false;
          // revert selected to null
          outerThis.setAttribute('selected', null);
          // update reload attribute to true
          outerThis.setAttribute('reload', 'true');
        });
    }

    fetchWithTimeout = async (url, options = {}, timeout = 9500) => {
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), timeout);
    
      try {
        const response = await fetch(url, {
          ...options,
          signal: controller.signal
        });

        return response;
      } catch (error) {
        if (error.name === 'AbortError') {
          throw new Error('Request timed out');
        }
        throw new Error(`Network error: ${error.message}`);
      } finally {
        clearTimeout(timeoutId);
      }
    };

    showToast = (text, success) => {
      // Get the toast element
      const toast = this.getToast(text, success);

      // Get body element
      const body = document.querySelector('body');

      // Insert the toast into the DOM
      body.insertAdjacentHTML('beforeend', toast);

      // Remove the toast after 3 seconds
      setTimeout(() => {
        // Select the toast element
        const toast = body.querySelector('.toast');

        // Remove the toast
        if(toast) {
          toast.remove();
        }
      }, 3000);
    }

    getToast = (text, success) => {
      if (success) {
        return /* html */`
        <div class="toast true">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" fill="currentColor">
          <path d="M8 16A8 8 0 1 1 8 0a8 8 0 0 1 0 16Zm3.78-9.72a.751.751 0 0 0-.018-1.042.751.751 0 0 0-1.042-.018L6.75 9.19 5.28 7.72a.751.751 0 0 0-1.042.018.751.751 0 0 0-.018 1.042l2 2a.75.75 0 0 0 1.06 0Z"></path>
        </svg>
          <p class="toast-message">${text}</p>
        </div>
      `;
      }
      else {
        return /* html */`
      <div class="toast false">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" fill="currentColor">
          <path d="M2.343 13.657A8 8 0 1 1 13.658 2.343 8 8 0 0 1 2.343 13.657ZM6.03 4.97a.751.751 0 0 0-1.042.018.751.751 0 0 0-.018 1.042L6.94 8 4.97 9.97a.749.749 0 0 0 .326 1.275.749.749 0 0 0 .734-.215L8 9.06l1.97 1.97a.749.749 0 0 0 1.275-.326.749.749 0 0 0-.215-.734L9.06 8l1.97-1.97a.749.749 0 0 0-.326-1.275.749.749 0 0 0-.734.215L8 6.94Z"></path>
        </svg>
          <p class="toast-message">${text}</p>
        </div>
      `;
      }
      
    }

    openJoin = body => {
      // Insert getJoin beforeend
      body.insertAdjacentHTML('beforeend', this.getJoin());
    }

    getJoin = () => {
      // get url from the : only the path
      const url = window.location.pathname;

      return /* html */`
      <join-popup register="/join/register" login="/join/login" next="${url}"></join-popup>
    `
    }

    // fn to take number and return a string with commas
    numberWithCommas = x => {
      return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }

    formatNumber = n => {
      if (n >= 0 && n <= 999) {
        return n.toString();
      } else if (n >= 1000 && n <= 9999) {
        const value = (n / 1000).toFixed(2);
        return `${value}k`;
      } else if (n >= 10000 && n <= 99999) {
        const value = (n / 1000).toFixed(1);
        return `${value}k`;
      } else if (n >= 100000 && n <= 999999) {
        const value = (n / 1000).toFixed(0);
        return `${value}k`;
      } else if (n >= 1000000 && n <= 9999999) {
        const value = (n / 1000000).toFixed(2);
        return `${value}M`;
      } else if (n >= 10000000 && n <= 99999999) {
        const value = (n / 1000000).toFixed(1);
        return `${value}M`;
      } else if (n >= 100000000 && n <= 999999999) {
        const value = (n / 1000000).toFixed(0);
        return `${value}M`;
      } else if (n >= 1000000000) {
        return "1B+";
      }
      else {
        return 0;
      }
    }

    parseToNumber = num_str => {
      // Try parsing the string to an integer
      const num = parseInt(num_str);

      // Check if parsing was successful
      if (!isNaN(num)) {
        return num;
      } else {
        return 0;
      }
    }

    formatDateWithRelativeTime = isoDateStr => {
      // 1. Convert ISO date string with timezone to local Date object
      let date;
      try {
        date = new Date(isoDateStr);
      }
      catch (error) {
        date = new Date(Date.now());
      }

      // Get date
      const localDate = date.toLocaleDateString('en-US', {
        year: 'numeric', month: 'short', day: '2-digit'
      });

      // Get time
      let localTime = date.toLocaleDateString('en-US', {
        hour: 'numeric', minute: '2-digit', hour12: true
      });

      localTime = localTime.split(',')[1].trim();

      return { dateStr: localDate, timeStr: localTime }
    }

    // Disable all inputs
    disableInputs = () => {
      // Select radio inputs
      const inputs = this.shadowObj.querySelectorAll('input[type="radio"]');

      // Loop through the inputs and disable them
      if (inputs) {
        inputs.forEach(input => {
          input.disabled = true;
        });
      }
    }

    // revert all inputs to unchecked
    revertInputs = inputs =>{
      inputs.forEach(input => {
        input.checked = false;
      });
    }

    // Listen for checked radio button
    listenForChecked = () => {
      const outerThis = this;
      // Get the poll options container
      const pollOptions = this.shadowObj.querySelector('.poll-options');

      const body = document.querySelector('body');

      // Check if the poll options container exists
      if (pollOptions) {
        // Get all the poll inputs
        const inputs = pollOptions.querySelectorAll('input[type="radio"]');

        // Add event listener to the poll options container
        inputs.forEach(input => {
          // add event listener to the input
          input.addEventListener('change', e => {
            // prevent the default action
            e.preventDefault();

            // prevent the propagation of the event
            e.stopPropagation();

            // Check if the checked value is true
            if (input.checked) {
              // Check if the user is authenticated
              if (!outerThis._authenticated) {
                // Open the join popup
                outerThis.openJoin(body);

                // revert any checked input
                outerThis.revertInputs(inputs);

                // prevent this function from proceeding
                return;
              } 

              // Get the selected option
              const selectedOption = e.target.parentElement;

              // Get the selected option name
              const selectedOptionName = outerThis.parseToNumber(selectedOption.dataset.name);

              // Get the new options
              const newOptions = outerThis._options.map(option => {
                // Check if the option is the selected option
                if (option.name === selectedOptionName) {
                  return { ...option, votes: option.votes + 1 };
                }
                else {
                  return option;
                }
              });

              // Update the options
              outerThis._options = newOptions;

              // Calculate the total percentage for each option based on the total votes
              const totalVotes = newOptions.reduce((acc, option) => acc + option.votes, 0);

              // Calculate the percentage for each option
              newOptions.forEach(option => { option.percentage = (option.votes / totalVotes) * 100; });

              // update votes attribute in the selected option
              let votes = outerThis.parseToNumber(selectedOption.getAttribute('votes'));

              selectedOption.setAttribute('votes', votes + 1);
              // console.log(selectedOption.getAttribute('votes'));

              // Update the selected attribute
              outerThis.setAttribute('selected', selectedOptionName);

              // Update the voted attribute
              outerThis.setAttribute('voted', 'true');

              // Update the options attribute
              // outerThis.setAttribute('options', JSON.stringify(newOptions));

              // update the fill width for each option fill element
              outerThis.updateFillWidth();

              // update the total votes element
              outerThis.updateTotalVotes();

              // disable all inputs after voting
              outerThis.disableInputs();

              // call the perform vote function
              outerThis.performVote(selectedOptionName, input.parentElement, votes);
            }
          });
        });

      }
    }

    // Update width of the fill element for each option
    updateFillWidth = () => {
      // Get the poll options container
      const pollOptions = this.shadowObj.querySelector('.poll-options');

      // Check if the poll options container exists
      if (pollOptions) {
        // Get all the poll options
        const options = pollOptions.querySelectorAll('.poll-option');

        // Loop through the options and update the fill width
        options.forEach(option => {
          // Get the fill element
          const fill = option.querySelector('.fill');

          // Get the votes for the option
          const votes = this.parseToNumber(option.getAttribute('votes'));

          // Get the total votes
          const totalVotes = this._options.reduce((acc, option) => acc + option.votes, 0);

          // Check if the current option has the highest number of votes
          const isHighest = votes >= Math.max(...this._options.map(option => option.votes));

          // add the high class if the option has the highest number of votes
          isHighest ? option.classList.add('high') : option.classList.remove('high');

          // Calculate the percentage for the option
          let percentage = (votes / totalVotes) * 100;

          // if percentage is a whole number, don't add decimal otherwise fix to 1 decimal place
          percentage = percentage % 1 === 0 ? percentage : percentage.toFixed(1);

          // Update the fill width
          fill.style.width = `${percentage}%`;

          // Update the percentage text
          let html = `
          <span class="percentage">${percentage}%</span>
        `;

          // Insert the html beforeend of the label
          option.querySelector('label').insertAdjacentHTML('beforeend', html);
        });
      }
    }

    // Update total votes element
    updateTotalVotes = () => {
      // Select the total votes element
      const totalVotes = this.shadowObj.querySelector('.info > .total > span.total');

      if (totalVotes) {
        // Get the total votes
        const votes = this._options.reduce((acc, option) => acc + option.votes, 0);

        // Convert the total votes to a string with commas
        const votesStr = this.numberWithCommas(votes);

        // Update the total votes
        totalVotes.textContent = votesStr;
      }
    }

    // Update poll expiry time per second
    updatePollTime = () => {
      // select the poll time element
      const pollTime = this.shadowObj.querySelector('span.count');

      const endTime = this._endTime;

      // Convert the end time to local time
      const localEndTime = new Date(endTime.toLocaleString('en-US', { timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone }));

      // Get the current time
      const currentTime = new Date(Date.now());

      // Get the difference between the current time and the end time
      let timeDiff = localEndTime - currentTime;

      // Check if the poll time element exists
      if (pollTime) {
        // Check if the time difference is less than 0
        if (timeDiff <= 0) {
          pollTime.textContent = "Poll ended";
        }
        else {
          // Update the poll time every second
          setInterval(() => {
            if (timeDiff < 1) {
              pollTime.textContent = "Poll ended";
            }

            pollTime.textContent = this.getRemainingTime(timeDiff);

            // update the time difference
            timeDiff = localEndTime - new Date(Date.now());
          }, 1000);
        }
      }
    }

    // Get remaining time for the poll
    getRemainingTime = timeDiff => {
      // get the number of hours if any in the time difference
      let hours = Math.floor(timeDiff / (1000 * 60 * 60));

      // Get the number of minutes if any in the time difference excluding days and hours
      let minutes = Math.floor((timeDiff % (1000 * 60 * 60)) / (1000 * 60));

      // Get the number of seconds if any in the time difference excluding days, hours and minutes
      let seconds = Math.floor((timeDiff % (1000 * 60)) / 1000);


      // Check if total hours is less than 10, add a leading zero
      hours = hours < 10 ? `0${hours}` : hours;

      // Check if minutes is less than 10, add a leading zero
      minutes = minutes < 10 ? `0${minutes}` : minutes;

      // Check if seconds is less than 10, add a leading zero
      seconds = seconds < 10 ? `0${seconds}` : seconds;

      return `${hours}:${minutes}:${seconds}`;
    }

    getTemplate() {
      // Show HTML Here
      return `
      ${this.getPoll()}
      ${this.getStyles()}
    `;
    }

    getPoll = () =>  {
      // Calculate the total percentage for each option based on the total votes
      const totalVotes = this._options.reduce((acc, option) => acc + option.votes, 0);

      // convert the total votes to a string with commas
      const totalVotesStr = this.numberWithCommas(totalVotes);

      return /*html*/`
      <div class="poll-options">
        ${this.getPollOptions()}
      </div>

      <span class="info">
        <span class="total">
          <span class="total">${totalVotesStr}</span>
          <span class="text">votes</span>
        </span>
        <span class="sp">•</span>
        <span class="count">00:00:00</span>
      </span>
    `
    }

    getPollOptions = () => {
      // Check if poll has ended
      const pollEnded = new Date(Date.now()) > this._endTime;

      // Check if poll has ended
      if (pollEnded) {
        return this.getEndedOptions();
      }
      // Check if user has voted
      else if (this._voted) {
        return this.getVotedOptions();
      }
      else {
        return this.getOptions();
      }
    }

    getEndedOptions = () => {
      // Get the options
      const options = this._options;

      // get selected option
      const selected = this.parseToNumber(this.getAttribute('selected'));

      // Calculate the total percentage for each option based on the total votes
      const totalVotes = options.reduce((acc, option) => acc + option.votes, 0);

      // Calculate the percentage for each option
      options.forEach(option => { option.percentage = (option.votes / totalVotes) * 100; });

      // if percentage is a whole number, don't add decimal otherwise fix to 1 decimal place
      options.forEach(option => { option.percentage = option.percentage % 1 === 0 ? option.percentage : option.percentage.toFixed(1); });

      // get the option highest number of votes
      const highestVotes = Math.max(...options.map(option => option.votes));

      // loop through the options and return the html
      return options.map((option, index) => {
        // Check which option is selected
        const isSelected = selected === option.name;

        // Check if the option has the highest number of votes
        const isHighest = option.votes === highestVotes;

        return /*html*/`
        <div votes="${option.votes}" data-name="${option.name}" class="poll-option ${isSelected ? 'selected' : ''} ${isHighest ? 'high' : ''}">
          <input type="radio" name="poll" id="poll-${index + 1}" ${isSelected ? 'checked="true"' : ''} disabled="true">
          <label for="poll-${index + 1}">
            <span class="text">${option.text}</span>
            <span is="custom-span" width="${option.percentage}%" class="fill"></span>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" fill="currentColor">
              <path d="M8 16A8 8 0 1 1 8 0a8 8 0 0 1 0 16Zm3.78-9.72a.751.751 0 0 0-.018-1.042.751.751 0 0 0-1.042-.018L6.75 9.19 5.28 7.72a.751.751 0 0 0-1.042.018.751.751 0 0 0-.018 1.042l2 2a.75.75 0 0 0 1.06 0Z"></path>
            </svg>
            <span class="percentage">${option.percentage}%</span>
          </label>
        </div>
      `;
      }).join('');
    }

    getOptions = () => {
      // get the options
      const options = this._options;

      // Map through the options and return the html
      return options.map((option, index) => {
        return /*html*/`
        <div votes="${option.votes}" data-name="${option.name}" class="poll-option">
          <input type="radio" name="poll" id="poll-${index + 1}">
          <label for="poll-${index + 1}">
            <span class="text">${option.text}</span>
            <span is="custom-span" width="0" class="fill"></span>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" fill="currentColor">
              <path d="M8 16A8 8 0 1 1 8 0a8 8 0 0 1 0 16Zm3.78-9.72a.751.751 0 0 0-.018-1.042.751.751 0 0 0-1.042-.018L6.75 9.19 5.28 7.72a.751.751 0 0 0-1.042.018.751.751 0 0 0-.018 1.042l2 2a.75.75 0 0 0 1.06 0Z"></path>
            </svg>
          </label>
        </div>
      `;
      }).join('');
    }

    getVotedOptions = () => {
      // Get the options
      const options = this._options;

      // get selected option
      const selected = this.parseToNumber(this.getAttribute('selected'));

      // Calculate the total percentage for each option based on the total votes
      const totalVotes = options.reduce((acc, option) => acc + option.votes, 0);

      // Calculate the percentage for each option
      options.forEach(option => { option.percentage = (option.votes / totalVotes) * 100; });

      // if percentage is a whole number, don't add decimal otherwise fix to 1 decimal place
      options.forEach(option => { option.percentage = option.percentage % 1 === 0 ? option.percentage : option.percentage.toFixed(1); });

      // get the option highest number of votes
      const highestVotes = Math.max(...options.map(option => option.votes));

      // loop through the options and return the html
      return options.map((option, index) => {
        // Check which option is selected
        const isSelected = selected === option.name;

        // Check if the option has the highest number of votes
        const isHighest = option.votes === highestVotes;

        return /*html*/`
        <div votes="${option.votes}" data-name="${option.name}" class="poll-option ${isSelected ? 'selected' : ''} ${isHighest ? 'high' : ''}">
          <input type="radio" name="poll" id="poll-${index+1}" ${isSelected ? 'checked' : ''}>
          <label for="poll-${index+1}">
            <span class="text">${option.text}</span>
            <span is="custom-span" width="${option.percentage}%" class="fill"></span>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" fill="currentColor">
              <path d="M8 16A8 8 0 1 1 8 0a8 8 0 0 1 0 16Zm3.78-9.72a.751.751 0 0 0-.018-1.042.751.751 0 0 0-1.042-.018L6.75 9.19 5.28 7.72a.751.751 0 0 0-1.042.018.751.751 0 0 0-.018 1.042l2 2a.75.75 0 0 0 1.06 0Z"></path>
            </svg>
            <span class="percentage">${option.percentage}%</span>
          </label>
        </div>
      `;
      }).join('');
    }

    getStyles() {
      return /* css */`
      <style>
        *,
        *:after,
        *:before {
          box-sizing: border-box !important;
          font-family: inherit;
          -webkit-box-sizing: border-box !important;
        }

        *:focus {
          outline: inherit !important;
        }

        *::-webkit-scrollbar {
          -webkit-appearance: none;
        }

        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
          padding: 0;
          margin: 0;
          font-family: inherit;
        }

        p,
        ul,
        ol {
          padding: 0;
          margin: 0;
        }

        a {
          text-decoration: none;
        }

        :host {
          padding: 10px 0 0 0;
          margin: 0;
          display: flex;
          flex-flow: column;
          gap: 15px;
        }

        .poll-options {
          padding: 0;
          display: flex;
          flex-flow: column;
          gap: 8px;
        }

        .poll-options > .poll-option {
          padding: 0;
          display: flex;
          flex-flow: row;
          gap: 0;
        }

        .poll-options > .poll-option label {
          display: inline-block;
          position: relative;
          height: 35px;
          width: 100%;
          cursor: pointer;
          line-height: 1.5;
          border: var(--border);
          padding: 0;
          font-family: var(--font-text), sans-serif;
          color: var(--gray-color);
          border-radius: 10px;
          -webkit-border-radius: 12px;
          -moz-border-radius: 12px;
          -ms-border-radius: 12px;
          -o-border-radius: 12px;
        }

        .poll-options > .poll-option label span.text {
          position: absolute;
          left: 0;
          top: 0;
          bottom: 0;
          right: 0;
          min-height: 100%;
          max-height: 100%;
          display: flex;
          align-items: center;
          z-index: 1;
          width: 70%;
          height: max-content;
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
          padding: 2px 8px;
          transition: width 0.5s ease-in-out;
          -webkit-transition: width 0.5s ease-in-out;
          -moz-transition: width 0.5s ease-in-out;
          -ms-transition: width 0.5s ease-in-out;
          -o-transition: width 0.5s ease-in-out;
        }

        .poll-options > .poll-option label svg {
          position: absolute;
          display: none;
          right: 50px;
          top: 50%;
          z-index: 2;
          transform: translateY(-50%);
          color: var(--gray-color);
        }

        .poll-options > .poll-option label span.percentage {
          position: absolute;
          right: 5px;
          top: 50%;
          z-index: 2;
          transform: translateY(-50%);
          font-family: var(--font-main), sans-serif;
          color: var(--gray-color);
          font-size: 0.75rem;
          font-weight: 500;
        }

        .poll-options > .poll-option.high label span.percentage {
          font-weight: 600;
          color: transparent;
          background: var(--second-linear);
          background-clip: text;
          -webkit-background-clip: text;
        }

        .poll-options > .poll-option label span.fill {
          position: absolute;
          left: 0;
          top: 0;
          bottom: 0;
          display: inline-block;
          z-index: 0;
          height: 100%;
          background: var(--poll-background);
          border-radius: 9px;
          transition: width 0.5s ease-in-out;
          -webkit-transition: width 0.5s ease-in-out;
          -moz-transition: width 0.5s ease-in-out;
          -ms-transition: width 0.5s ease-in-out;
          -o-transition: width 0.5s ease-in-out;
        }

        .poll-options > .poll-option input[type="radio"] {
          display: none;
        }

        .poll-options > .poll-option.high label span.fill {
          background: var(--light-linear);
        }

        .poll-options > .poll-option.high label span.text {
          font-weight: 500;
          color: var(--title-color);
        }

        .poll-options > .poll-option input[type="radio"]:checked + label svg {
          display: inline-block;
        }

        .poll-options > .poll-option.high input[type="radio"]:checked + label svg {
          display: inline-block;
          color: var(--alt-color);
        }

        .info {
          padding: 0;
          display: flex;
          flex-flow: row;
          align-items: center;
          justify-content: start;
          color: var(--gray-color);
          gap: 5px;
          font-size: 0.97rem;
        }

        .info .sp {
          font-size: 0.83rem;
          margin: 0;
        }

        .info > .total .total {
          font-family: var(--font-main), sans-serif;
          color: var(--highlight-color);
          font-weight: 600;
          font-size: 0.8rem;
          display: inline-block;
          margin: 1px 0 0 0;
        }
        .info .count {
          font-family: var(--font-main), sans-serif;
          font-weight: 500;
          font-size: 0.75rem;
          display: inline-block;
          margin: 2px 0 0 0;
        }

        @media screen and (max-width: 660px) {
          ::-webkit-scrollbar {
            -webkit-appearance: none;
          }

          :host {
            padding: 10px 0 0 0;
            margin: 0;
          }


          a,
          .poll-options > .poll-option label {
            cursor: default !important;
          }
        }
      </style>
    `;
    }
  }

  class ActionWrapper extends HTMLElement {
    constructor() {
      // We are not even going to touch this.
      super();

      // check if the user is authenticated
      this._authenticated = window.hash ? true : false;

      // let's create our shadow root
      this.shadowObj = this.attachShadow({ mode: "open" });

      this.parent = this.getRootNode().host;

      this.render();
    }

    // observe the attributes
    static get observedAttributes() {
      return ['reload', 'likes', 'views', 'replies', 'liked'];
    }

    // listen for changes in the attributes
    attributeChangedCallback(name, oldValue, newValue) {
      // check if old value is not equal to new value
      if (name==='reload') {
        if(newValue === 'true') {
          // set the value of reload to false
          this.setAttribute('reload', 'false');
          this.reRender();
        }
      }
    }

    render() {
      this.shadowObj.innerHTML = this.getTemplate();
    }

    reRender = () => {
      this.render();
      // like post
      this.likePost();
      // Check if user has liked the post
      const liked = this.convertToBool(this.getAttribute('liked'));

      const body = document.querySelector('body');
       
      // scroll likes
      this.scrollLikes(liked);

      // activate reply button
      this.activateReplyButton();

      // open the highlights
      this.openHighlights(body);
    }

    connectedCallback() {
      // like post
      this.likePost();
      // Check if user has liked the post
      const liked = this.convertToBool(this.getAttribute('liked'));

      const body = document.querySelector('body');
       
      // scroll likes
      this.scrollLikes(liked);

      // activate reply button
      this.activateReplyButton();

      // open the highlights
      this.openHighlights(body);
    }

    updateViews = (element, value) => {
      // update views in the element and this element
      this.setAttribute('views', value);
      element.textContent = value;
    }

    updateReplies = (element, value) => {
      // update replies in the element and this element
      this.setAttribute('replies', value);
      element.textContent = value;
    }

    setAttributes = (name, value) => {
      this.parent.setAttribute(name, value);
    }

    openHighlights = body => {
      // Get the stats action and subscribe action
      const statsBtn = this.shadowObj.querySelector('.stats > .stat.views');

      // add event listener to the stats action
      if (statsBtn) {
        statsBtn.addEventListener('click', e => {
          e.preventDefault();
          e.stopPropagation();

          // Open the highlights popup
          body.insertAdjacentHTML('beforeend', this.getHighlights());
        });
      }
    }

    convertToBool = str => {
      switch (str) {
        case 'true':
          return true;
        case 'false':
          return false;
        default:
          return false;
      }
    }

    disableScroll() {
      // Get the current page scroll position
      let scrollTop = window.scrollY || document.documentElement.scrollTop;
      let scrollLeft = window.scrollX || document.documentElement.scrollLeft;
      document.body.classList.add("stop-scrolling");

      // if any scroll is attempted, set this to the previous value
      window.onscroll = function () {
        window.scrollTo(scrollLeft, scrollTop);
      };
    }

    enableScroll() {
      document.body.classList.remove("stop-scrolling");
      window.onscroll = function () { };
    }

    activateReplyButton = () => {
      // Get the article button
      const replyButton = this.shadowObj.querySelector('span.action.write');
      // Add an event listener to the article button
      replyButton.addEventListener('click', e => {
        e.preventDefault();

        // Get the body element
        const body = document.querySelector('body');

        // Get the content
        const content = this.getReply();

        // insert the content into the body
        body.insertAdjacentHTML('beforeend', content);
      });
    }

    getReply = () => {
      // get kind from the attribute
      const kind = this.getAttribute('kind');
      const hash = this.getAttribute('hash').toLowerCase();
      let url = `/api/v1/s/${hash}/reply`;

      // if kind is reply, change the url
      if (kind === 'reply') {
        url = `/api/v1/r/${hash}/reply`;
      }

      return /* html */`
      <div is="create-reply" api="${url}" method="PUT" kind="${kind}"
        hash="${this.getAttribute('hash')}" preview-title="${this.getAttribute('preview-title')}" time="${this.getAttribute('time')}"
        author-hash="${this.getAttribute('author-hash')}">
        ${this.innerHTML}
      </div>
    `;
    }

    performActions = (likeBtn, liked) => {
      // get url to 
      let baseUrl = this.getAttribute('url');

      // base api
      const url = `/api/v1${baseUrl}/like`;

      const options = {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json',
        }
      };

      // Follow the topic
      this.like(url, options, likeBtn, liked);
    }

    like = (url, options, likeBtn, liked) => {
      const outerThis = this;
      this.fetchWithTimeout(url, options)
        .then(response => {
          response.json()
          .then(data => {
            // If data has unverified, open the join popup
            if (data.unverified) {
              // Get body
              const body = document.querySelector('body');

              // Open the join popup
              outerThis.openJoin(body);

              // revert the like button
              outerThis.updateLikeBtn(likeBtn, liked);
            }

            // if success is false, show toast message
            if (!data.success) {
              outerThis.showToast(data.message, false);

              // revert the like button
              outerThis.updateLikeBtn(likeBtn, liked);
            }
            else {
              // Show toast message
              outerThis.showToast(data.message, true);

              // check the data.liked
              if (data.liked !== liked) {
                // revert the like button
                outerThis.updateLikeBtn(likeBtn, data.liked ? false : true); 
              }
            }
          });
        })
        .catch(_error => {
          // console.log(_error);
          // show toast message
          outerThis.showToast('An error occurred!', false);

          // revert the like button
          outerThis.updateLikeBtn(likeBtn, liked);
        });
    }

    fetchWithTimeout = async (url, options = {}, timeout = 9500) => {
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), timeout);
    
      try {
        const response = await fetch(url, {
          ...options,
          signal: controller.signal
        });

        return response;
      } catch (error) {
        if (error.name === 'AbortError') {
          throw new Error('Request timed out');
        }
        throw new Error(`Network error: ${error.message}`);
      } finally {
        clearTimeout(timeoutId);
      }
    }

    showToast = (text, success) => {
      // Get the toast element
      const toast = this.getToast(text, success);

      // Get body element
      const body = document.querySelector('body');

      // Insert the toast into the DOM
      body.insertAdjacentHTML('beforeend', toast);

      // Remove the toast after 3 seconds
      setTimeout(() => {
        // Select the toast element
        const toast = body.querySelector('.toast');

        // Remove the toast
        if(toast) {
          toast.remove();
        }
      }, 3000);
    }

    getToast = (text, success) => {
      if (success) {
        return /* html */`
        <div class="toast true">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" fill="currentColor">
          <path d="M8 16A8 8 0 1 1 8 0a8 8 0 0 1 0 16Zm3.78-9.72a.751.751 0 0 0-.018-1.042.751.751 0 0 0-1.042-.018L6.75 9.19 5.28 7.72a.751.751 0 0 0-1.042.018.751.751 0 0 0-.018 1.042l2 2a.75.75 0 0 0 1.06 0Z"></path>
        </svg>
          <p class="toast-message">${text}</p>
        </div>
      `;
      }
      else {
        return /* html */`
      <div class="toast false">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" fill="currentColor">
          <path d="M2.343 13.657A8 8 0 1 1 13.658 2.343 8 8 0 0 1 2.343 13.657ZM6.03 4.97a.751.751 0 0 0-1.042.018.751.751 0 0 0-.018 1.042L6.94 8 4.97 9.97a.749.749 0 0 0 .326 1.275.749.749 0 0 0 .734-.215L8 9.06l1.97 1.97a.749.749 0 0 0 1.275-.326.749.749 0 0 0-.215-.734L9.06 8l1.97-1.97a.749.749 0 0 0-.326-1.275.749.749 0 0 0-.734.215L8 6.94Z"></path>
        </svg>
          <p class="toast-message">${text}</p>
        </div>
      `;
      }
      
    }

    openJoin = body => {
      // Insert getJoin beforeend
      body.insertAdjacentHTML('beforeend', this.getJoin());
    }

    getJoin = () => {
      // get url from the : only the path
      const url = window.location.pathname;

      return /* html */`
      <join-popup register="/join/register" login="/join/login" next="${url}"></join-popup>
    `
    }

    updateLikeBtn = (btn, liked) => {
      const svg = btn.querySelector("svg");

      // Toggle the active class
      btn.classList.toggle("true");

      // Parse the likes to an integer
      const totalLikes = this.parseToNumber(this.getAttribute("likes"));

      // add scaling to the svg: reduce the size of the svg
      svg.style.transform = "scale(0.8)";

      // Add a transition to the svg
      svg.style.transition = "transform 0.2s ease-in-out";

      this.scrollLikes(liked ? false : true);

      // Check if the user has liked the post
      if (liked) {
        // Set the new value of likes
        this.setAttribute("likes", totalLikes - 1);

        // Set the new value of liked
        this.setAttribute("liked", "false");

        // replace the svg with the new svg
        setTimeout(() => {
          svg.innerHTML = `
              <path d="m8 14.25.345.666a.75.75 0 0 1-.69 0l-.008-.004-.018-.01a7.152 7.152 0 0 1-.31-.17 22.055 22.055 0 0 1-3.434-2.414C2.045 10.731 0 8.35 0 5.5 0 2.836 2.086 1 4.25 1 5.797 1 7.153 1.802 8 3.02 8.847 1.802 10.203 1 11.75 1 13.914 1 16 2.836 16 5.5c0 2.85-2.045 5.231-3.885 6.818a22.066 22.066 0 0 1-3.744 2.584l-.018.01-.006.003h-.002ZM4.25 2.5c-1.336 0-2.75 1.164-2.75 3 0 2.15 1.58 4.144 3.365 5.682A20.58 20.58 0 0 0 8 13.393a20.58 20.58 0 0 0 3.135-2.211C12.92 9.644 14.5 7.65 14.5 5.5c0-1.836-1.414-3-2.75-3-1.373 0-2.609.986-3.029 2.456a.749.749 0 0 1-1.442 0C6.859 3.486 5.623 2.5 4.25 2.5Z"></path>
            `;
          // scale the svg back to 1
          svg.style.transform = "scale(1)";
        }, 200);
      } else {
        // Set the new value of likes
        this.setAttribute("likes", totalLikes + 1);

        // Set the new value of liked
        this.setAttribute("liked", "true");

        // replace the svg with the new svg
        setTimeout(() => {
          svg.innerHTML = `
              <path d="M7.655 14.916v-.001h-.002l-.006-.003-.018-.01a22.066 22.066 0 0 1-3.744-2.584C2.045 10.731 0 8.35 0 5.5 0 2.836 2.086 1 4.25 1 5.797 1 7.153 1.802 8 3.02 8.847 1.802 10.203 1 11.75 1 13.914 1 16 2.836 16 5.5c0 2.85-2.044 5.231-3.886 6.818a22.094 22.094 0 0 1-3.433 2.414 7.152 7.152 0 0 1-.31.17l-.018.01-.008.004a.75.75 0 0 1-.69 0Z"></path>
            `;

          // scale the svg back to 1
          svg.style.transform = "scale(1)";
        }, 200);
      }
    }

    // fn to like a post
    likePost = () => {
      const outerThis = this;
      // Select like button
      const likeButton = this.shadowObj.querySelector('.action.like');

      const body = document.querySelector('body');

      // If like button, add event listener
      if (likeButton) {
        // Get the svg node
        const svg = likeButton.querySelector('svg');

        likeButton.addEventListener('click', e => {
          // prevent the default action
          e.preventDefault();

          // prevent the propagation of the event
          e.stopPropagation();

          // check if the user is authenticated
          // Check if the user is authenticated
          if (!outerThis._authenticated) {
            // Open the join popup
            outerThis.openJoin(body);

            // prevent this function from proceeding
            return;
          } 

          // Toggle the active class
          likeButton.classList.toggle('true');

          // Get the current like status
          const liked = outerThis.convertToBool(this.getAttribute('liked'));

          // Parse the likes to an integer
          const totalLikes = this.parseToNumber(this.getAttribute('likes'));

          // add scaling to the svg: reduce the size of the svg
          svg.style.transform = 'scale(0.8)';

          // Add a transition to the svg
          svg.style.transition = 'transform 0.2s ease-in-out';

          // Check if the user has liked the post
          if (liked) {
            // Set the new value of likes
            this.setAttribute('likes', totalLikes - 1);
            outerThis.setAttributes('likes', totalLikes - 1);

            // Set the new value of liked
            this.setAttribute('liked', 'false');
            outerThis.setAttributes('liked', 'false');

            // replace the svg with the new svg
            setTimeout(() => {
              svg.innerHTML = `
              <path d="m8 14.25.345.666a.75.75 0 0 1-.69 0l-.008-.004-.018-.01a7.152 7.152 0 0 1-.31-.17 22.055 22.055 0 0 1-3.434-2.414C2.045 10.731 0 8.35 0 5.5 0 2.836 2.086 1 4.25 1 5.797 1 7.153 1.802 8 3.02 8.847 1.802 10.203 1 11.75 1 13.914 1 16 2.836 16 5.5c0 2.85-2.045 5.231-3.885 6.818a22.066 22.066 0 0 1-3.744 2.584l-.018.01-.006.003h-.002ZM4.25 2.5c-1.336 0-2.75 1.164-2.75 3 0 2.15 1.58 4.144 3.365 5.682A20.58 20.58 0 0 0 8 13.393a20.58 20.58 0 0 0 3.135-2.211C12.92 9.644 14.5 7.65 14.5 5.5c0-1.836-1.414-3-2.75-3-1.373 0-2.609.986-3.029 2.456a.749.749 0 0 1-1.442 0C6.859 3.486 5.623 2.5 4.25 2.5Z"></path>
            `;
              // scale the svg back to 1
              svg.style.transform = 'scale(1)';
            }, 200);

            // perform like
            outerThis.performActions(likeButton, false);
          }
          else {
            // Set the new value of likes
            this.setAttribute('likes', totalLikes + 1);
            outerThis.setAttributes('likes', totalLikes + 1);

            // Set the new value of liked
            this.setAttribute('liked', 'true');
            outerThis.setAttributes('liked', 'true');

            // replace the svg with the new svg
            setTimeout(() => {
              svg.innerHTML = `
              <path d="M7.655 14.916v-.001h-.002l-.006-.003-.018-.01a22.066 22.066 0 0 1-3.744-2.584C2.045 10.731 0 8.35 0 5.5 0 2.836 2.086 1 4.25 1 5.797 1 7.153 1.802 8 3.02 8.847 1.802 10.203 1 11.75 1 13.914 1 16 2.836 16 5.5c0 2.85-2.044 5.231-3.886 6.818a22.094 22.094 0 0 1-3.433 2.414 7.152 7.152 0 0 1-.31.17l-.018.01-.008.004a.75.75 0 0 1-.69 0Z"></path>
            `;

              // scale the svg back to 1
              svg.style.transform = 'scale(1)';
            }, 200);

            // perform like
            outerThis.performActions(likeButton, true);
          }
          // Scroll the likes
          this.scrollLikes(liked ? false : true);
        });
      }
    }

    // fn to scroll likes numbers: bring the appropriate number into view
    scrollLikes = liked => {
      // Get the numbers container
      const numbers = this.shadowObj.querySelector('.numbers.likes');

      // Get the previous and next elements
      if (numbers) {
        const prevElement = numbers.querySelector('#prev');
        const nextElement = numbers.querySelector('#next');

        // Check if the elements exist
        if (prevElement && nextElement) {
          // Get the height of the container
          const containerHeight = numbers.clientHeight;

          // Get the height of the previous and next elements
          // const prevHeight = prevElement.clientHeight;
          const nextHeight = nextElement.clientHeight;

          // If the user has liked the post, scroll to the next element
          if (liked) {
            // Scroll to the next element
            // numbers.scrollTo({ top: nextElement.offsetTop - containerHeight + nextHeight, behavior: 'smooth' });
            // numbers.scrollTo({ top: nextElement.offsetTop - containerHeight + nextHeight, behavior: 'smooth' });

            // Scroll to the next element using custom scrollTo
            this.scrollTo(numbers, nextElement.offsetTop - containerHeight + nextHeight, 200);
          }
          else {
            // Scroll to the top of the container
            // numbers.scrollTo({ top: 0, behavior: 'smooth' });

            // Scroll to the top of the container using custom scrollTo
            this.scrollTo(numbers, 0, 200);
          }
        }
      }
    }

    // Define the easeInOutQuad function for smoother scrolling
    easeInOutQuad = (t, b, c, d) => {
      t /= d / 2;
      if (t < 1) return c / 2 * t * t + b;
      t--;
      return -c / 2 * (t * (t - 2) - 1) + b;
    };

    // Create a custom smooth scrollTo to accommodate chrome and other browsers
    scrollTo = (element, to, duration) => {
      const outThis = this;

      // Get the current scroll position
      let start = element.scrollTop,
        change = to - start,
        currentTime = 0,
        increment = 20;

      // Create the animation
      const animateScroll = function () {
        currentTime += increment;
        let val = outThis.easeInOutQuad(currentTime, start, change, duration);
        element.scrollTop = val;
        if (currentTime < duration) {
          setTimeout(animateScroll, increment);
        }
      };
      animateScroll();
    }

    formatNumber = n => {
      if (n >= 0 && n <= 999) {
        return n.toString();
      } else if (n >= 1000 && n <= 9999) {
        const value = (n / 1000).toFixed(2);
        return `${value}k`;
      } else if (n >= 10000 && n <= 99999) {
        const value = (n / 1000).toFixed(1);
        return `${value}k`;
      } else if (n >= 100000 && n <= 999999) {
        const value = (n / 1000).toFixed(0);
        return `${value}k`;
      } else if (n >= 1000000 && n <= 9999999) {
        const value = (n / 1000000).toFixed(2);
        return `${value}M`;
      } else if (n >= 10000000 && n <= 99999999) {
        const value = (n / 1000000).toFixed(1);
        return `${value}M`;
      } else if (n >= 100000000 && n <= 999999999) {
        const value = (n / 1000000).toFixed(0);
        return `${value}M`;
      } else if (n >= 1000000000) {
        return "1B+";
      }
      else {
        return 0;
      }
    }

    parseToNumber = str => {
      // Try parsing the string to an integer
      const num = parseInt(str);

      // Check if parsing was successful
      if (!isNaN(num)) {
        return num;
      } else {
        return 0;
      }
    }

    getTemplate = () => {
      // Show HTML Here
      return `
      ${this.getStats()}
      ${this.getStyles()}
    `;
    }

    getStats = () => {
      return /* html */`
      <div class="actions stats">
        ${this.getWrite()}
        ${this.getLike(this.getAttribute('liked'))}
        ${this.getViews()}
        ${this.getShare()}
      </div>
		`
    }

    getWrite = () => {
      return /*html*/`
      <span class="action write">
        <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M8.00016 1.83337C3.3755 1.83337 1.8335 3.37537 1.8335 8.00004C1.8335 12.6247 3.3755 14.1667 8.00016 14.1667C12.6248 14.1667 14.1668 12.6247 14.1668 8.00004" stroke="currentColor" stroke-width="1.3" stroke-linecap="round" stroke-linejoin="round" />
          <path fill-rule="evenodd" clip-rule="evenodd" d="M13.0189 2.86915V2.86915C12.3569 2.28315 11.3456 2.34449 10.7596 3.00649C10.7596 3.00649 7.84694 6.29649 6.83694 7.43849C5.8256 8.57982 6.56694 10.1565 6.56694 10.1565C6.56694 10.1565 8.23627 10.6852 9.23227 9.55982C10.2289 8.43449 13.1563 5.12849 13.1563 5.12849C13.7423 4.46649 13.6803 3.45515 13.0189 2.86915Z" stroke="currentColor" stroke-width="1.3" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M10.0061 3.86719L12.4028 5.98919" stroke="currentColor" stroke-width="1.3" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        ${this.getReplies()}
      </span>
    `
    }

    getReplies = () => {
      // Get total replies and parse to integer
      const replies = this.getAttribute('replies') || 0;

      // Convert the replies to a number
      const totalReplies = this.parseToNumber(replies);

      //  format the number
      const opinionsFormatted = this.formatNumber(totalReplies);

      return /*html*/`
      <span class="numbers">
        <span id="prev">${opinionsFormatted}</span>
      </span>
    `
    }

    getViews = () => {
      // Get total views and parse to integer
      const views = this.getAttribute('views') || 0;

      // Convert the views to a number
      const totalViews = this.parseToNumber(views);

      // Format the number
      const viewsFormatted = this.formatNumber(totalViews);

      return /*html*/`
      <span class="stat views">
        <svg width="16" height="16" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg">
          <rect x="2" y="4.48" width="1.5" height="11.52" fill="currentColor"/>
          <rect x="7" y="0.32" width="1.5" height="15.68" fill="currentColor"/>
          <rect x="12" y="7.68" width="1.5" height="8.32" fill="currentColor"/>
        </svg>
        <span class="views-numbers">${viewsFormatted}</span>
      </span>
    `
    }

    getLike = liked => {
      if (liked === 'true') {
        return /*html*/`
        <span class="action like true">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" fill="currentColor">
            <path d="M7.655 14.916v-.001h-.002l-.006-.003-.018-.01a22.066 22.066 0 0 1-3.744-2.584C2.045 10.731 0 8.35 0 5.5 0 2.836 2.086 1 4.25 1 5.797 1 7.153 1.802 8 3.02 8.847 1.802 10.203 1 11.75 1 13.914 1 16 2.836 16 5.5c0 2.85-2.044 5.231-3.886 6.818a22.094 22.094 0 0 1-3.433 2.414 7.152 7.152 0 0 1-.31.17l-.018.01-.008.004a.75.75 0 0 1-.69 0Z"></path>
          </svg>
          <span class="numbers likes">
            ${this.getLikeNumbers()}
          </span>
        </span>
			`
      }
      else {
        return /*html*/`
        <span class="action like">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" fill="currentColor">
            <path d="m8 14.25.345.666a.75.75 0 0 1-.69 0l-.008-.004-.018-.01a7.152 7.152 0 0 1-.31-.17 22.055 22.055 0 0 1-3.434-2.414C2.045 10.731 0 8.35 0 5.5 0 2.836 2.086 1 4.25 1 5.797 1 7.153 1.802 8 3.02 8.847 1.802 10.203 1 11.75 1 13.914 1 16 2.836 16 5.5c0 2.85-2.045 5.231-3.885 6.818a22.066 22.066 0 0 1-3.744 2.584l-.018.01-.006.003h-.002ZM4.25 2.5c-1.336 0-2.75 1.164-2.75 3 0 2.15 1.58 4.144 3.365 5.682A20.58 20.58 0 0 0 8 13.393a20.58 20.58 0 0 0 3.135-2.211C12.92 9.644 14.5 7.65 14.5 5.5c0-1.836-1.414-3-2.75-3-1.373 0-2.609.986-3.029 2.456a.749.749 0 0 1-1.442 0C6.859 3.486 5.623 2.5 4.25 2.5Z"></path>
          </svg>
          <span class="numbers likes">
            ${this.getLikeNumbers()}
          </span>
        </span>
			`
      }
    }

    getLikeNumbers = () => {
      // Get total likes and parse to integer
      const likes = this.getAttribute('likes') || 0;
      const totalLikes = this.parseToNumber(likes);

      // Format the number
      const likesFormatted = this.formatNumber(totalLikes);

      // Check if user has liked the post
      const liked = this.getAttribute('liked') || 'false';

      // Check if the user has liked the post
      if (liked === 'true') {
        // next value is the current value
        const nextValue = likesFormatted;

        // Get the previous value by subtracting 1, if the value is less than 0, return 0: wrap in formatNumber
        const prevValue = this.formatNumber(totalLikes - 1 >= 0 ? totalLikes - 1 : 0);


        // Return the HTML for prev and next values
        return /*html*/`
        <span id="prev">${prevValue}</span>
        <span id="next">${nextValue}</span>
      `
      }
      else {
        // next value is the current value + 1
        const nextValue = this.formatNumber(totalLikes + 1);

        // the previous value is the current value
        const prevValue = likesFormatted;

        // Return the HTML for prev and next values
        return /*html*/`
        <span id="prev">${prevValue}</span>
        <span id="next">${nextValue}</span>
      `
      }
    }

    getShare = () => {
      // Get url to share
      const url = this.getAttribute('url');

      // Get window host url including https/http part
      let host = window.location.protocol + '//' + window.location.host;

      // combine the url with the host
      const shareUrl = `${host}${url}`;

      // Get the title of the story
      const title = this.getAttribute('summary');


      return /* html */`
      <share-wrapper url="${shareUrl.toLowerCase()}" summary="${title}"></share-wrapper>
    `
    }

    getHighlights = () => {
      return /* html */`
      <views-popup name="post"likes="${this.getAttribute('likes')}" liked="${this.getAttribute('liked')}" views="${this.getAttribute('views')}"
        replies="${this.getAttribute('replies')}">
      </views-popup>
    `
    }

    getStyles() {
      return /* css */`
      <style>
        *,
        *:after,
        *:before {
          box-sizing: border-box !important;
          font-family: inherit;
          -webkit-box-sizing: border-box !important;
        }

        *:focus {
          outline: inherit !important;
        }

        *::-webkit-scrollbar {
          -webkit-appearance: none;
        }

        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
          padding: 0;
          margin: 0;
          font-family: inherit;
        }

        p,
        ul,
        ol {
          padding: 0;
          margin: 0;
        }

        a {
          text-decoration: none;
        }

        :host {
          margin: 0;
          width: 100%;
          display: flex;
          flex-flow: column;
          gap: 0;
          padding: 5px 0 0 0;
        }

        .actions.stats {
          padding: 0;
          margin: 0 0 0 0;
          display: flex;
          flex-flow: row;
          align-items: center;
          gap: 0;
        }

        span.write.action {
          cursor: pointer;
          position: relative;
          display: flex;
          align-items: center;
          font-family: var(--font-text) sans-serif;
          font-size: 0.95rem;
          justify-content: start;
          gap: 5px;
          padding: 5px 10px 5px 7px;
          height: 30px;
          border-radius: 50px;
          font-weight: 500;
          font-size: 1rem;
          color: var(--gray-color);
          -webkit-border-radius: 50px;
          -moz-border-radius: 50px;
          -ms-border-radius: 50px;
          -o-border-radius: 50px;
        }

        span.write.action > svg {
          width: 19px;
          height: 19px;
          margin: -1px 0 0 0;
        }

        span.write.action span.line {
          background: var(--accent-linear);
          position: absolute;
          top: 30px;
          left: 18px;
          display: none;
          width: 3px;
          height: 16px;
          border-radius: 5px;
        }

        span.write.action.open span.line {
          display: inline-block;
        }

        span.write.action.open {
          color: var(--accent-color);
        }

        span.write.action.open > span.numbers {
          color: transparent;
          background: var(--accent-linear);
          font-weight: 500;
          background-clip: text;
          -webkit-background-clip: text;
        }

        span.stat,
        span.action {
          min-height: 35px;
          height: 30px;
          width: max-content;
          position: relative;
          padding: 5px 10px;
          cursor: pointer;
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 5px;
          font-size: 1rem;
          font-weight: 400;
          color: var(--action-color);
          color: var(--gray-color);
          border-radius: 50px;
          -webkit-border-radius: 50px;
          -moz-border-radius: 50px;
          -ms-border-radius: 50px;
          -o-border-radius: 50px;
        }

        span:first-of-type {
          margin: 0 0 0 -7px;
        }

        span.play:hover,
        span.stat:hover,
        span.action:hover {
          background: var(--hover-background);
        }

        .action span.numbers {
          font-family: var(--font-main), sans-serif;
          font-size: 1rem;
          font-weight: 500;
        }

        .action span {
          padding: 0;
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 3px;
          font-size: 1rem;
          font-weight: 400;
        }

        .action > .numbers {
          height: 21px;
          min-height: 21px;
          padding: 0;
          margin: 0;
          display: flex;
          overflow-y: scroll;
          scroll-snap-type: y mandatory;
          scroll-behavior: smooth;
          scrollbar-width: none;
          gap: 0;
          align-items: start;
          justify-content: start;
          flex-flow: column;
          transition: height 0.5s ease, min-height 0.5s ease; 
          -ms-overflow-style: none;
          scrollbar-width: none;
          will-change: transform;
        }

        span > .numbers::-webkit-scrollbar {
          display: none !important;
          visibility: hidden;
        }

        span > .numbers > span {
          scroll-snap-align: start;
          transition: height 0.5s ease, min-height 0.5s ease;
          line-height: 1;
          display: flex;
          align-items: center;
          justify-content: center;
          height: 21px;
          min-height: 21px;
          padding: 3px 0;
          margin: 0;
          font-weight: 500;
          font-family: var(--font-main), sans-serif;
          font-size: 0.95rem;
        }

        span.true > .numbers > span,
        span.active > .numbers > span {
          color: transparent;
          background: var(--second-linear);
          background-clip: text;
          -webkit-background-clip: text;
        }

        span.up > .numbers > span {
          color: transparent;
          background: var(--accent-linear);
          background-clip: text;
          -webkit-background-clip: text;
        }

        span.down > .numbers > span {
          color: transparent;
          background: var(--error-linear);
          background-clip: text;
          -webkit-background-clip: text;
        }

        .stat > .views-numbers {
          display: flex;
          align-items: center;
          justify-content: center;
          padding: 0;
          margin: 0 0 -1.5px 0;
          font-size: 0.95rem;
          font-weight: 400;
          font-family: var(--font-main), sans-serif;
        }

        span svg {
          color: inherit;
          width: 16px;
          height: 16px;
        }

        span.action.like svg {
          margin: -1px 0 0 0;
          width: 16px;
          height: 16px;
          transition: transform 0.5s ease;
        }

        span.stat.views svg {
          color: inherit;
          width: 16px;
          height: 16px;
          margin: -3px 0 0 0;
        }

        span.stat.up svg {
          color: var(--accent-color);
        }

        span.stat.down svg {
          color: var(--error-color);
        }

        span.true svg,
        span.active svg {
          color: var(--alt-color);
        }

        @media screen and (max-width: 660px) {
          ::-webkit-scrollbar {
            -webkit-appearance: none;
          }

          a,
          span.stat,
          span.action {
            cursor: default !important;
          }

          span.play:hover,
          span.stat:hover,
          span.action:hover {
            background: none;
          }
        }
      </style>
    `;
    }
  }

  class ImagesWrapper extends HTMLElement {
  	constructor() {
  		// We are not even going to touch this.
  		super();

  		// let's create our shadow root
  		this.shadowObj = this.attachShadow({ mode: "open" });

  		this.render();
  	}

  	// observe the attributes
    static get observedAttributes() {
      return ['images'];
    }

    // listen for changes in the attributes
    attributeChangedCallback(name, oldValue, newValue) {
      // check if old value is not equal to new value
      if (name === 'images') {
        this.render();
      }
    }

  	render() {
  		this.shadowObj.innerHTML = this.getTemplate();
  		this.addImageLoadListeners();
  	}

  	connectedCallback() {
  	}

  	clickImage = img => {
  		const current = img.getAttribute("index");
  		img.addEventListener("click", e => {
  			e.preventDefault();

  			this.openImagePopup(current);
  		});
  	}

  	addImageLoadListeners() {
      const images = this.shadowObj.querySelectorAll('img');
      images.forEach(img => {
        img.addEventListener('load', () => {
  				// change loaded attribute to true
  				img.setAttribute('loaded', 'true');
  				// remove loader and blur(.loading) class)
  				img.parentElement.classList.remove('loading');
  				const loader = img.parentElement.querySelector('#btn-loader');
  				if(loader) { loader.remove(); }

  				// add click event listener
  				this.clickImage(img);
        });
        img.addEventListener('error', () => {
          img.parentElement.classList.add('error');
        });
      });
    }

  	openImagePopup = current => {
  		const body = document.querySelector("body");
  		const popup = this.getImagePopup(current);

  		if(body && popup) {
  			// insert popup before body end
  			body.insertAdjacentHTML("beforeend", popup);
  		}
  	}

  	getTemplate = () => {
  		const imagesArrayStr = this.getAttribute("images");
  		const images = imagesArrayStr.split(",");
  		// Show HTML Here
  		return `
			<div class="images">
      	${this.getBody(images)}
			</div>
      ${this.getStyles()}
    `;
  	}

  	getBody = images => {
  		const total = images.length;
  		return images.map((image, index) => {
  			return /* html */`
				<div class="image-container loading ${total === 1 ? "single" : "multi"}">
					<img src="${image}" index="${index + 1}" alt="Post Image" loading="lazy" loaded="false" />
					${this.getButtonLoader()}
				</div>
			`;
  		}).join("");
  	}

  	getImagePopup = current => {
  		return /* html */`
			<image-popup images="${this.getAttribute('images')}" current="${current}"></image-popup>
		`;
  	}

  	getButtonLoader() {
      return /*html*/`
      <span id="btn-loader">
				<span class="loader"></span>
			</span>
    `
    }

  	getStyles() {
  		return /* css */`
	    <style>
	      *,
	      *:after,
	      *:before {
	        box-sizing: border-box !important;
	        font-family: inherit;
	        -webkit-box-sizing: border-box !important;
	      }

	      *:focus {
	        outline: inherit !important;
	      }

	      *::-webkit-scrollbar {
	        width: 3px;
	      }

	      *::-webkit-scrollbar-track {
	        background: var(--scroll-bar-background);
	      }

	      *::-webkit-scrollbar-thumb {
	        width: 3px;
	        background: var(--scroll-bar-linear);
	        border-radius: 50px;
	      }

	      h1,
	      h2,
	      h3,
	      h4,
	      h5,
	      h6 {
	        padding: 0;
	        margin: 0;
	        font-family: inherit;
	      }

	      p,
	      ul,
	      ol {
	        padding: 0;
	        margin: 0;
	      }

	      a {
	        text-decoration: none;
	      }

	      :host {
        	font-size: 16px;
					width: 100%;
					max-width: 100%;
					margin: 0;
				  padding: 10px 0 3px;
					display: flex;
					flex-flow: row;
					gap: 0;
					position: relative;
					justify-content: start;
					align-items: center;
					margin: 0;
          overflow-x: scroll;
          -ms-overflow-style: none;
          scrollbar-width: none;
        }

        ::-webkit-scrollbar {
          display: none !important;
          visibility: hidden;
        }

        #btn-loader {
          position: absolute;
          top: 0;
          left: 0;
          bottom: 0;
          right: 0;
          z-index: 1;
          display: flex;
          align-items: center;
          justify-content: center;
          border-radius: inherit;
        }

        #btn-loader > .loader {
          width: 30px;
          aspect-ratio: 1;
          --_g: no-repeat radial-gradient(farthest-side, #18A565 94%, #0000);
          --_g1: no-repeat radial-gradient(farthest-side, #21D029 94%, #0000);
          --_g2: no-repeat radial-gradient(farthest-side, #df791a 94%, #0000);
          --_g3: no-repeat radial-gradient(farthest-side, #f09c4e 94%, #0000);
          background: var(--_g) 0 0,  var(--_g1) 100% 0, var(--_g2) 100% 100%, var(--_g3) 0 100%;
          background-size: 30% 30%;
          animation: l38 .9s infinite ease-in-out;
          -webkit-animation: l38 .9s infinite ease-in-out;
        }

        @keyframes l38 {
          100% {
            background-position: 100% 0, 100% 100%, 0 100%, 0 0
          }
        }

				div.images {
					width: max-content;
					margin: 0;
					display: flex;
					flex-flow: row;
					gap: 9px;
					position: relative;
					justify-content: start;
					align-items: center;
					margin: 0;
        }
				
				.image-container {
					border: var(--border);
					position: relative;
					display: flex;
					justify-content: center;
					align-items: center;
					position: relative;
					cursor: pointer;
					overflow: hidden;
					height: 150px;
					min-width: 105px;
					border-radius: 12px;
				}

				.image-container.loading img {
					filter: blur(8px);
				}

				.image-container.error {
					border: var(--input-border-error);
				}

				.image-container > img {
					height: 100%;
					width: auto;
					min-width: 105px;
					max-height: 150px;
					object-fit: cover;
					object-position: center;
					border-radius: 12px;
					overflow: hidden;
					transition: transform 0.4s ease-in-out;
				}

				.image-container:hover img {
					/*transform: scale(1.3);*/
				}

				@media screen and (max-width:660px) {
					:host {
        		font-size: 16px;
						margin-left: -10px;
						margin-right: -10px;
						width: calc(100% + 20px);
						max-width: calc(100% + 20px);
						padding: 10px 10px 3px;
					}

					::-webkit-scrollbar {
						-webkit-appearance: none;
					}

					div.image-container,
					a {
						cursor: default !important;
					}
				}
	    </style>
    `;
  	}
  }

  class ImagesUploader extends HTMLElement {
    constructor() {
      super();
      this.api = this.getAttribute("api");
      this.uploadCount = 0;
      this.maxUploads = 10;
      this.render();
    }

    render() {
      this.innerHTML = this.getTemplate();
      this.setupEventListeners();
    }

    connectedCallback() {
      // Component connected to the DOM
    }

    setupEventListeners() {
      const addButton = this.querySelector('.add');
      const fileInput = this.querySelector('#fileInput');

      addButton.addEventListener('click', () => fileInput.click());
      fileInput.addEventListener('change', this.handleFileUpload.bind(this));
    }

    sendDeleteUrl = url => {
      const data = {
        type: 'update',
        frontend: true,
        data: {
          url: url,
          kind: 'delete'
        }
      };

      // send the view data
      if (window.wss) {
        window.wss.sendMessage(data);
      } else {
        console.warn('WebSocket connection not available. view information not sent.');
      }
    }

    async handleFileUpload(event) {
      const imagesContainer = this.querySelector('div.images');
      if (this.uploadCount >= this.maxUploads) {
        imagesContainer.insertAdjacentHTML('beforebegin', this.getServerSuccessMsg(false, 'You have reached the maximum uploads'));
        return;
      }

      const file = event.target.files[0];
      if (!file) return;

      const addDiv = this.querySelector('div.add');

      // check file size: uploads more than 1MB to be downsized/downgraded

      try {
        // add loader to the addDiv
        addDiv.innerHTML = this.getButtonLoader();

        // display pointer-events: none on the addDiv
        addDiv.style.pointerEvents = 'none';

        const webpBlob = await this.convertToWebP(file);
        const formData = new FormData();
        formData.append('file', webpBlob, 'image.webp');

        const response = await this.fetchWithTimeout(this.api, {
          method: 'POST',
          body: formData
        });

        const data = await response.json();

        if (data.success) {
          this.addImageToGallery(data.url);
          this.addImageToAttribute(data.url);
          this.uploadCount++;
          
          if (this.uploadCount >= this.maxUploads) {
            this.hideAddButton();
          } else {
            addDiv.innerHTML = this.getSvg();
            addDiv.style.pointerEvents = 'all';
          }
        } else {
          imagesContainer.insertAdjacentHTML('beforebegin', this.getServerSuccessMsg(false, data.message));
        }
      } catch (error) {
        console.error('Error uploading image:', error);
        imagesContainer.insertAdjacentHTML('beforebegin', this.getServerSuccessMsg(false, error.message));

        // remove message after 3 seconds
        setTimeout(() => {
          const serverStatus = this.querySelector('.server-status');
          if (serverStatus) {
            serverStatus.remove();
          }
        }, 3000);

        // remove loader and show add button
        addDiv.innerHTML = this.getSvg();
        addDiv.style.pointerEvents = 'all';
      }
    }

    async convertToWebP(file) {
      return new Promise((resolve) => {
        const img = new Image();
        img.onload = () => {
          const canvas = document.createElement('canvas');
          let width = img.width;
          let height = img.height;

          // Only downscale if the image is larger than 1MB
          if (file.size > 1024 * 1024) {
            const aspectRatio = width / height;
            const maxWidth = 1280;
            const maxHeight = 1280;

            if (width > maxWidth || height > maxHeight) {
              if (aspectRatio > 1) {
                // Landscape image
                width = maxWidth;
                height = width / aspectRatio;
              } else {
                // Portrait image
                height = maxHeight;
                width = height * aspectRatio;
              }
            }
          }

          // Set canvas dimensions
          canvas.width = width;
          canvas.height = height;

          // Draw image on canvas
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0, width, height);

          // Convert to WebP
          canvas.toBlob((blob) => {
            // Generate a unique filename
            const filename = `image_${Date.now()}.webp`;
            resolve(new File([blob], filename, { type: 'image/webp' }));
          }, 'image/webp', 0.9); // Increased quality to 0.9
        };
        img.src = URL.createObjectURL(file);
      });
    }

    addImageToGallery(imageUrl) {
      const imageDiv = document.createElement('div');
      imageDiv.className = 'image-container loading';
      imageDiv.innerHTML = `<img src="${imageUrl}" alt="Post Image" loading="lazy"> ${this.getButtonLoader()} ${this.getCancel()}`;
      this.querySelector('.add').insertAdjacentElement('beforebegin', imageDiv);

      // add load listener to the image
      this.addImageLoadListener(imageDiv.querySelector('img'));

      // add remove listener to the cancel button
      this.removeFromGallery(imageDiv.querySelector('.cancel-btn'));
    }

    removeFromGallery = btn => {
      btn.addEventListener('click', () => {
        const imageDiv = btn.parentElement;
        const imageUrl = imageDiv.querySelector('img').src;

        // remove image from gallery
        imageDiv.remove();

        // remove image from attribute
        this.removeImageFromAttribute(imageUrl);

        // decrement upload count
        this.uploadCount--;

        // show add button
        this.showAddButton();

        // send delete url to server
        this.sendDeleteUrl(imageUrl);
      });
    }

    removeImageFromAttribute = imageUrl => {
      // get images attribute: array
      let images = this.getAttribute("images").split(',');
      const index = images.indexOf(imageUrl);
      images.splice(index, 1);

      // remove empty strings, null, 'null' and whose length is less than 5
      images = images.filter(image => image.trim() !== '' && image !== 'null' && image.length > 5);

      // set images attribute: array
      this.setAttribute("images", images.join(','));
    }

    addImageToAttribute(imageUrl) {
      try {
        // get images attribute: array
        let images = this.getAttribute("images").split(',');
        images.push(imageUrl);

        // remove empty strings, null, 'null' and whose length is less than 5
        images = images.filter(image => image.trim() !== '' && image !== 'null' && image.length > 5);

        // set images attribute: array
        this.setAttribute("images", images.join(','));
      } catch (error) {
        console.error('Error adding image to attribute:', error);
      }
    }

    hideAddButton() {
      const addButton = this.querySelector('.add');
      addButton.style.display = 'none';
    }

    showAddButton() {
      const addButton = this.querySelector('.add');
      addButton.innerHTML = this.getSvg();
      addButton.style.pointerEvents = 'all';
      addButton.style.display = 'flex';
    }

    addImageLoadListener = img => {
      img.addEventListener('load', () => {
        // remove loader and blur(.loading) class)
  			img.parentElement.classList.remove('loading');
  			const loader = img.parentElement.querySelector('#btn-loader');
  			if(loader) { loader.remove(); }
      });
      img.addEventListener('error', () => {
        img.parentElement.classList.add('error');
      });
    }

    fetchWithTimeout = async (url, options = {}, timeout = 9500) => {
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), timeout);
    
      try {
        const response = await fetch(url, {
          ...options,
          signal: controller.signal
        });

        return response;
      } catch (error) {
        if (error.name === 'AbortError') {
          throw new Error('Request timed out');
        }
        throw new Error(`Network error: ${error.message}`);
      } finally {
        clearTimeout(timeoutId);
      }
    }

    getTemplate = () => {
      return `
      <div class="images">
        ${this.getBody()}
      </div>
      ${this.getStyles()}
    `;
    }

    getServerSuccessMsg = (success, text) => {
      if (!success) {
        return `
        <p class="server-status">${text}</p>
      `
      }
      return `
      <p class="server-status success">${text}</p>
    `
    }

    getBody = () => {
      return /* html */`
      <div class="add">
        ${this.getSvg()}
        <input type="file" id="fileInput" accept=".avif, image/*, image/webp, image/avif" style="display: none;">
      </div>
    `;
    }

    getSvg = () => {
      return /* svg */`
      <svg id="Image" width="24" height="24" viewBox="0 0 25 25" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path fill-rule="evenodd" clip-rule="evenodd" d="M8.58093 11.8089C7.30893 11.8089 6.27393 10.7739 6.27393 9.50187C6.27393 8.22787 7.30893 7.19287 8.58093 7.19287C9.85393 7.19387 10.8889 8.22987 10.8889 9.50187C10.8889 10.7739 9.85293 11.8089 8.58093 11.8089ZM8.57993 8.69287C8.13593 8.69287 7.77393 9.05487 7.77393 9.50187C7.77393 9.94687 8.13593 10.3089 8.58093 10.3089C9.02693 10.3089 9.38893 9.94687 9.38893 9.50187C9.38893 9.05587 9.02593 8.69387 8.57993 8.69287Z" fill="currentColor"/>
        <path d="M6.06878 17.604C5.95678 17.604 5.84178 17.579 5.73478 17.525C5.36478 17.34 5.21478 16.892 5.39778 16.522C5.50278 16.311 6.46278 14.468 8.06378 14.468C8.88778 14.468 9.49078 14.916 9.97578 15.278C10.4478 15.628 10.7568 15.843 11.1598 15.843C11.4448 15.839 12.1838 14.95 12.5808 14.471C13.4278 13.451 14.3048 12.395 15.4218 12.395C17.3358 12.395 18.5258 14.94 18.6548 15.23C18.8228 15.608 18.6538 16.05 18.2758 16.219C17.9008 16.39 17.4548 16.22 17.2848 15.842C16.9998 15.207 16.1678 13.895 15.4218 13.895C15.0097 13.895 14.2454 14.8147 13.7384 15.4247L13.7348 15.429C12.9178 16.414 12.1458 17.343 11.1598 17.343C10.2398 17.343 9.59678 16.865 9.08078 16.481C8.65278 16.164 8.37578 15.968 8.06378 15.968C7.52878 15.968 6.94178 16.792 6.74078 17.19C6.60878 17.453 6.34378 17.604 6.06878 17.604Z" fill="currentColor"/>
        <path fill-rule="evenodd" clip-rule="evenodd" d="M2 12.396C2 19.779 4.617 22.396 12 22.396C19.383 22.396 22 19.779 22 12.396C22 5.013 19.383 2.396 12 2.396C4.617 2.396 2 5.013 2 12.396ZM3.5 12.396C3.5 5.882 5.486 3.896 12 3.896C18.514 3.896 20.5 5.882 20.5 12.396C20.5 18.91 18.514 20.896 12 20.896C5.486 20.896 3.5 18.91 3.5 12.396Z" fill="currentColor"/>
      </svg>
    `;
    }

    getCancel = () => {
      return /* svg */`
      <span class="cancel-btn">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" fill="currentColor">
          <path d="M3.72 3.72a.75.75 0 0 1 1.06 0L8 6.94l3.22-3.22a.749.749 0 0 1 1.275.326.749.749 0 0 1-.215.734L9.06 8l3.22 3.22a.749.749 0 0 1-.326 1.275.749.749 0 0 1-.734-.215L8 9.06l-3.22 3.22a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042L6.94 8 3.72 4.78a.75.75 0 0 1 0-1.06Z"></path>
        </svg>
      </span>
    `;
    }

    getButtonLoader() {
      return /*html*/`
      <span id="btn-loader">
				<span class="loader"></span>
			</span>
    `
    }

  	getStyles() {
  		return /* css */`
	    <style>
	      *,
	      *:after,
	      *:before {
	        box-sizing: border-box !important;
	        font-family: inherit;
	        -webkit-box-sizing: border-box !important;
	      }

	      *:focus {
	        outline: inherit !important;
	      }

	      *::-webkit-scrollbar {
	        width: 3px;
	      }

	      *::-webkit-scrollbar-track {
	        background: var(--scroll-bar-background);
	      }

	      *::-webkit-scrollbar-thumb {
	        width: 3px;
	        background: var(--scroll-bar-linear);
	        border-radius: 50px;
	      }

	      h1,
	      h2,
	      h3,
	      h4,
	      h5,
	      h6 {
	        padding: 0;
	        margin: 0;
	        font-family: inherit;
	      }

	      p,
	      ul,
	      ol {
	        padding: 0;
	        margin: 0;
	      }

	      a {
	        text-decoration: none;
	      }

        p.server-status {
          margin: 0;
          width: 100%;
          text-align: start;
          font-family: var(--font-read), sans-serif;
          color: var(--error-color);
          font-weight: 500;
          line-height: 1.5;
          font-size: 1.18rem;
        }

        p.server-status.success {
          color: transparent;
          background: var(--accent-linear);
          background-clip: text;
          -webkit-background-clip: text;
        }

        #btn-loader {
          position: absolute;
          top: 0;
          left: 0;
          bottom: 0;
          right: 0;
          z-index: 5;
          display: flex;
          align-items: center;
          justify-content: center;
          border-radius: inherit;
        }

        #btn-loader > .loader {
          width: 20px;
          aspect-ratio: 1;
          --_g: no-repeat radial-gradient(farthest-side, #18A565 94%, #0000);
          --_g1: no-repeat radial-gradient(farthest-side, #21D029 94%, #0000);
          --_g2: no-repeat radial-gradient(farthest-side, #df791a 94%, #0000);
          --_g3: no-repeat radial-gradient(farthest-side, #f09c4e 94%, #0000);
          background: var(--_g) 0 0,  var(--_g1) 100% 0, var(--_g2) 100% 100%, var(--_g3) 0 100%;
          background-size: 30% 30%;
          animation: l38 .9s infinite ease-in-out;
          -webkit-animation: l38 .9s infinite ease-in-out;
        }

        @keyframes l38 {
          100% {
            background-position: 100% 0, 100% 100%, 0 100%, 0 0
          }
        }

	      div.images {
          width: 100%;
          max-width: 100%;
          display: flex;
          flex-flow: row;
          gap: 10px;
          position: relative;
          justify-content: start;
          align-items: center;
          margin: 0;
          padding: 10px 0;
          overflow-x: scroll;
          -ms-overflow-style: none;
          scrollbar-width: none;
        }

        ::-webkit-scrollbar {
          display: none !important;
          visibility: hidden;
        }
        
        div.images > .image-container {
					border: var(--border);
					position: relative;
					display: flex;
					justify-content: center;
					align-items: center;
					position: relative;
					cursor: pointer;
					overflow: hidden;
					height: 80px;
					min-width: 60px;
					border-radius: 12px;
				}

				div.images > .image-container.error {
					border: var(--input-border-error);
				}

        div.images > .image-container.loading img {
					filter: blur(8px);
				}

				div.images > .image-container > img {
					height: 100%;
					width: auto;
					min-width: 60px;
					max-height: 80px;
					object-fit: cover;
					object-position: center;
					border-radius: 12px;
					overflow: hidden;
					transition: transform 0.4s ease-in-out;
				}

        div.images > .image-container > span.cancel-btn {
          position: absolute;
          top: 5px;
          right: 5px;
          padding: 0;
          cursor: pointer;
          display: flex;
          flex-flow: column;
          gap: 0px;
          justify-content: center;
        }

        div.images > .image-container > span.cancel-btn svg {
          width: 15px;
          height: 15px;
          color: var(--error-color);
        }

				div.images > .image-container:hover img {
					transform: scale(1.3);
				}
        
        div.images > div.add {
          height: 50px;
          min-width: 50px;
          background: var(--gray-background);
          display: flex;
          justify-content: center;
          align-items: center;
          position: relative;
          cursor: pointer;
          overflow: hidden;
          max-height: 60px;
          box-shadow: var(--image-shadow);
          border-radius: 12px;
        }
        
        div.images > div.add > svg {
          height: 30px;
          width: 30px;
          color: var(--gray-color);
          transition: all 0.3s ease;
        }
        
        div.images > div.add:hover svg {
          color: var(--accent-color);
        }

				@media screen and (max-width:660px) {
					:host {
        		font-size: 16px;
					}

					::-webkit-scrollbar {
						-webkit-appearance: none;
					}

          div.image-container,
          div.images > div.add,
					a {
						cursor: default !important;
					}
				}
	    </style>
    `;
  	}
  }

  class JoinPopup extends HTMLElement {
    constructor() {

      // We are not even going to touch this.
      super();

      // let's create our shadow root
      this.shadowObj = this.attachShadow({mode: 'open'});

      this.render();

    }

    render() {
      this.shadowObj.innerHTML = this.getTemplate();
    }

    connectedCallback() {
      
      this.disableScroll();

      // Const body element
      const body = document.querySelector('body');

      // Handle action click
      this.handleActionClick(body);

      // Select the close button & overlay
      const overlay = this.shadowObj.querySelector('div.overlay');

      // Close the modal
      if (overlay) {
        this.closePopup(overlay);
      }
    }

    // Open user profile
    handleActionClick = (body) => {
      const outerThis = this;
      // get a.meta.link
      const actions = this.shadowObj.querySelectorAll('.actions > a.action');

      if(body && actions) { 
        actions.forEach(content => {
          content.addEventListener('click', event => {
            event.preventDefault();

            // get join
            const join = outerThis.getJoin(content.dataset.name);

            // get url
            let url = content.dataset.name === 'login' ? outerThis.getAttribute('login') : outerThis.getAttribute('register');

            if (content.dataset.name === 'forgot') {
              url = '/join/recover';   
            }
            
            // replace and push states
            outerThis.replaceAndPushStates(url, body, join);

            body.innerHTML = join;
          });
        });
      }
    }

    replaceAndPushStates = (url, body, join) => {
       // get the first custom element in the body
       const firstElement = body.firstElementChild;

       // convert the custom element to a string
       const elementString = firstElement.outerHTML;

      // get window location
      const pageUrl = window.location.href;
      window.history.replaceState(
        { page: 'page', content: elementString },
        url, pageUrl
      );

      // Updating History State
      window.history.pushState(
        { page: 'page', content: join},
        url, url
      );
    }

    disconnectedCallback() {
      this.enableScroll();
    }

    disableScroll() {
      // Get the current page scroll position
      let scrollTop = window.scrollY || document.documentElement.scrollTop;
      let scrollLeft = window.scrollX || document.documentElement.scrollLeft;
      document.body.classList.add("stop-scrolling");

      // if any scroll is attempted, set this to the previous value
      window.onscroll = function() {
        window.scrollTo(scrollLeft, scrollTop);
      };
    }

    enableScroll() {
      document.body.classList.remove("stop-scrolling");
      window.onscroll = function() {};
    }

    // close the modal
    closePopup = overlay => {
      overlay.addEventListener('click', e => {
        e.preventDefault();
        this.remove();
      });
    }

    getTemplate() {
      // Show HTML Here
      return /*html*/`
      <div class="overlay"></div>
      <section id="content" class="content">
        ${this.getWelcome()}
      </section>
    ${this.getStyles()}`
    }

    getWelcome() {
      return /*html*/`
      <div class="welcome">
				<p>Please note that you need to be logged in order to perform certain actions on this platform.</p>
        <p>Although you can still view content, you will not be able to interact with it.</p>
        <div class="actions">
          <a data-name="login" href="${this.getAttribute('login')}?next=${this.getAttribute('next')}" class="login action">Login</a>
          <a data-name="register" href="${this.getAttribute('register')}?next=${this.getAttribute('next')}" class="register action">Register</a>
          <a data-name="forgot" href="/join/recover?next=${this.getAttribute('next')}" class="recover action">Recover</a>
        </div>
			</div>
    `
    }

    getJoin = action => {
     return /* html */`
    <app-logon name="${action}" next="${this.getAttribute('next')}" api-login="/api/v1/a/login" 
      api-register="/api/v1/a/register" api-check-email="/api/v1/a/check-email" 
      api-forgot-password="/api/v1/a/forgot-password" api-verify-token="/api/v1/a/verify-token" 
      api-reset-password="/api/v1/a/reset-password" join-url="/join" login="/join/login" 
      register="/join/register" forgot="/join/recover">
    </app-logon>
   `
    }

    getStyles() {
      return /*css*/`
      <style>
        * {
          box-sizing: border-box !important;
        }

        :host{
          border: none;
          padding: 0;
          justify-self: end;
          display: flex;
          flex-flow: column;
          align-items: center;
          justify-content: center;
          gap: 10px;
          z-index: 100;
          width: 100%;
          min-width: 100vw;
          position: fixed;
          right: 0;
          top: 0;
          bottom: 0;
          left: 0;
        }

        div.overlay {
          position: absolute;
          top: 0;
          right: 0;
          bottom: 0;
          left: 0;
          height: 100%;
          width: 100%;
          background-color: var(--modal-background);
          backdrop-filter: blur(3px);
          -webkit-backdrop-filter: blur(3px);
        }

        #content {
          z-index: 1;
          background-color: var(--background);
          padding: 15px 10px 15px;
          display: flex;
          flex-flow: column;
          align-items: center;
          justify-content: center;
          gap: 0;
          width: 700px;
          max-height: 90%;
          height: max-content;
          border-radius: 25px;
          position: relative;
        }

        .welcome {
          width: 98%;
          display: flex;
          flex-flow: column;
          align-items: center;
          justify-content: center;
          row-gap: 0;
        }

        .welcome > h2 {
          width: 100%;
          font-size: 1.35rem;
          font-weight: 600;
          margin: 0 0 10px;
          padding: 10px 10px;
          background-color: var(--gray-background);
          text-align: center;
          border-radius: 12px;
          font-family: var(--font-read), sans-serif;
          color: var(--text-color);
          font-weight: 500;
          position: relative;
        }

        .welcome > h2 > span.control {
          padding: 0;
          cursor: pointer;
          display: flex;
          flex-flow: column;
          gap: 0px;
          justify-content: center;
          position: absolute;
          top: 50%;
          left: 10px;
          transform: translateY(-50%);
        }

        .welcome > h2 > span.control svg {
          width: 20px;
          height: 20px;
          color: var(--text-color);
        }

        .welcome > h2 > span.control svg:hover{
          color: var(--error-color);
        }

        .welcome  p {
          width: 100%;
          margin: 0;
          font-family: var(--font-main), sans-serif;
          color: var(--text-color);
          line-height: 1.5;
          font-size: 1rem;
        }

        .welcome > .actions {
          margin: 10px 0 5px;
          width: 100%;
          display: flex;
          flex-flow: row;
          align-items: center;
          justify-content: start;
          gap: 30px;
        }

        .welcome > .actions a {
          text-decoration: none;
          background: none;
          border: var(--action-border);
          text-decoration: none;
          padding: 6px 12px 6px;
          font-size: 1rem;
          cursor: pointer;
          margin: 0;
          width: max-content;
          justify-self: center;
          text-align: center;
          color: var(--text-color);
          font-weight: 500;
          border-radius: 12px;
        }

        .welcome > .actions a.login {
          padding: 7.5px 15px 7.5px;
          border: none;
          background: var(--gray-background);
          color: var(--text-color);
        }

        @media screen and ( max-width: 850px ){
          #content {
            width: 90%;
          }
        }
        @media screen and ( max-width: 600px ){
          :host {
            border: none;
            background-color: var(--modal-background);
            padding: 0px;
            justify-self: end;
            display: flex;
            flex-flow: column;
            align-items: center;
            justify-content: end;
            gap: 0;
            z-index: 20;
            position: fixed;
            right: 0;
            top: 0;
            bottom: 0;
            left: 0;
          }

          #content {
            box-sizing: border-box !important;
            padding: 10px 0 0 0;
            margin: 0;
            width: 100%;
            max-width: 100%;
            max-height: 90%;
            min-height: max-content;
            border-radius: 0px;
            border-top: var(--mobile-border);
            border-top-right-radius: 10px;
            border-top-left-radius: 10px;
          }

          .welcome {
            width: 100%;
            gap: 5px;
            padding: 0 10px;
          }

          .welcome > h2 {
            margin: 0 0 10px;
          }

          .welcome > .actions {
            margin: 9px 0 17px;
            width: 100%;
            display: flex;
            flex-flow: row;
            align-items: center;
            justify-content: start;
            gap: 30px;
          }

          .welcome > .actions a {
            margin: 0;
          }

          .welcome > h2 > span.control,
          .welcome > .actions > .action {
            cursor: default !important;
          }
        }
      </style>
    `;
    }
  }

  class UrlPopup extends HTMLElement {
    constructor() {

      // We are not even going to touch this.
      super();

      // let's create our shadow root
      this.shadowObj = this.attachShadow({mode: 'open'});

      this.render();

    }

    render() {
      this.shadowObj.innerHTML = this.getTemplate();
    }

    connectedCallback() {
      this.disableScroll();

      // Select the close button & overlay
      const overlay = this.shadowObj.querySelector('.overlay');
      const btns = this.shadowObj.querySelectorAll('.cancel-btn');

      // Close the modal
      if (overlay && btns) {
        this.closePopup(overlay, btns);
      }
    }

    disconnectedCallback() {
      this.enableScroll();
    }

    disableScroll() {
      // Get the current page scroll position
      let scrollTop = window.scrollY || document.documentElement.scrollTop;
      let scrollLeft = window.scrollX || document.documentElement.scrollLeft;
      document.body.classList.add("stop-scrolling");

      // if any scroll is attempted, set this to the previous value
      window.onscroll = function() {
        window.scrollTo(scrollLeft, scrollTop);
      };
    }

    enableScroll() {
      document.body.classList.remove("stop-scrolling");
      window.onscroll = function() {};
    }

    closePopup = (overlay, btns) => {
      overlay.addEventListener('click', e => {
        e.preventDefault();
        this.remove();
      });

      btns.forEach(btn => {
        btn.addEventListener('click', e => {
          e.preventDefault();
          this.remove();
        });
      });
    }

    getTemplate() {
      // Show HTML Here
      return `
      <div class="overlay"></div>
      <section id="content" class="content">
        ${this.getWelcome()}
      </section>
    ${this.getStyles()}`
    }

    getWelcome() {
      const url = this.getAttribute('url');
      let max = url.length > 50 ? url.substring(0, 50) + '...' : url;
      return /*html*/`
      <div class="welcome">
				<p>You are about to leave the application and visit an external website.</p> 
        <p> We are not responsible for the content of the external website, click continue to visit below address.</p>
        <span class="url">${max}</span>
        <div class="actions">
          <button class="action cancel-btn">Cancel</button>
          <a noopenner="true" blank="true" target="_blank" href="${url}" class="action">Continue</a>
        </div>
			</div>
    `
    }

    getStyles() {
      return /*css*/`
      <style>
        * {
          box-sizing: border-box !important;
        }

        :host{
          border: none;
          padding: 0;
          justify-self: end;
          display: flex;
          flex-flow: column;
          align-items: center;
          justify-content: center;
          gap: 10px;
          z-index: 100;
          width: 100%;
          min-width: 100vw;
          position: fixed;
          right: 0;
          top: 0;
          bottom: 0;
          left: 0;
        }

        div.overlay {
          position: absolute;
          top: 0;
          right: 0;
          bottom: 0;
          left: 0;
          height: 100%;
          width: 100%;
          background-color: var(--modal-background);
          backdrop-filter: blur(3px);
          -webkit-backdrop-filter: blur(3px);
        }

        #content {
          z-index: 1;
          background-color: var(--background);
          padding: 20px 10px 20px;
          display: flex;
          flex-flow: column;
          align-items: center;
          justify-content: center;
          gap: 0;
          width: 700px;
          max-height: 90%;
          height: max-content;
          border-radius: 25px;
          position: relative;
        }
  
        .welcome {
          width: 98%;
          display: flex;
          flex-flow: column;
          align-items: center;
          justify-content: center;
          row-gap: 0;
        }

        .welcome > h2 {
          width: 100%;
          font-size: 1.5rem;
          font-weight: 600;
          margin: 0 0 10px;
          padding: 10px 10px;
          background-color: var(--gray-background);
          text-align: center;
          border-radius: 12px;
          font-family: var(--font-main), sans-serif;
          color: var(--text-color);
          font-weight: 500;
          position: relative;
        }

        .welcome > h2 > span.control {
          padding: 0;
          cursor: pointer;
          display: flex;
          flex-flow: column;
          gap: 0px;
          justify-content: center;
          position: absolute;
          top: 50%;
          left: 10px;
          transform: translateY(-50%);
        }

        .welcome > h2 > span.control svg {
          width: 20px;
          height: 20px;
          color: var(--text-color);
        }

        .welcome > h2 > span.control svg:hover{
          color: var(--error-color);
        }

        .welcome  p {
          margin: 10px 0 0;
          width: 100%;
          text-align: center;
          font-family: var(--font-main), sans-serif;
          color: var(--text-color);
          line-height: 1.4;
          font-size: 1rem;
        }

        .welcome span.url {
          display: flex;
          width: 100%;
          padding: 0;
          text-align: center;
          align-items: center;
          justify-content: center;
          margin: 10px 0 5px;
          font-family: var(--font-read), sans-serif;
          font-size: 0.9rem;
          font-weight: 400;
          border-radius: 5px;
          color: var(--gray-color);
        }

        .welcome > .actions {
          display: flex;
          font-family: var(--font-main), sans-serif;
          width: 100%;
          flex-flow: row;
          align-items: center;
          justify-content: center;
          gap: 20px;
          margin: 10px 0 0;
        }
        
        .welcome > .actions > .action {
          border: none;
          background: var(--gray-background);
          color: var(--text-color);
          font-family: var(--font-main), sans-serif;
          text-decoration: none;
          font-size: 1rem;
          font-weight: 600;
          cursor: pointer;
          display: flex;
          flex-flow: row;
          align-items: center;
          text-transform: capitalize;
          justify-content: center;
          padding: 7px 15px 7px;
          min-width: 100px;
          width: 100px;
          position: relative;
          border-radius: 12px;
          -webkit-border-radius: 12px;
          -moz-border-radius: 12px;
        }

        .welcome > .actions > .action.cancel-btn {
          border: var(--action-border);
          background: none;
          background-color: none;
          color: var(--text-color);
          padding: 6px 15px 6px;
        }

        @media screen and ( max-width: 850px ){
          #content {
            width: 90%;
          }
        }
        @media screen and ( max-width: 600px ){
          :host {
            border: none;
            background-color: var(--modal-background);
            padding: 0px;
            justify-self: end;
            display: flex;
            flex-flow: column;
            align-items: center;
            justify-content: end;
            gap: 10px;
            z-index: 20;
            position: fixed;
            right: 0;
            top: 0;
            bottom: 0;
            left: 0;
          }

          #content {
            box-sizing: border-box !important;
            padding: 5px 0 0 0;
            margin: 0;
            width: 100%;
            max-width: 100%;
            max-height: 90%;
            min-height: max-content;
            border-radius: 0px;
            border-top: var(--mobile-border);
            border-top-right-radius: 15px;
            border-top-left-radius: 15px;
          }

          .welcome {
            width: 100%;
            padding: 5px 15px;
          }

          .welcome  p {
            margin: 5px 0 0;
            font-family: var(--font-main), sans-serif;
            color: var(--text-color);
            line-height: 1.4;
            font-size: 1rem;
          }

          .welcome > .actions {
            margin: 15px 0;
            width: 100%;
            gap: 35px;
          }

          .welcome > h2 > span.control,
          .welcome > .actions > .action {
            cursor: default !important;
          }
        }
      </style>
    `;
    }
  }

  class StatsPopup extends HTMLElement {
    constructor() {

      // We are not even going to touch this.
      super();

      this._url = this.getAttribute('url');

      // let's create our shadow root
      this.shadowObj = this.attachShadow({mode: 'open'});

      this.render();
    }

    render() {
      this.shadowObj.innerHTML = this.getTemplate();
    }

    connectedCallback() {
      this.disableScroll();

      // Select the close button & overlay
      const overlay = this.shadowObj.querySelector('.overlay');
      const btns = this.shadowObj.querySelectorAll('.cancel-btn');
      const contentContainer = this.shadowObj.querySelector('ul.highlights');

      // Close the modal
      if (overlay && btns && contentContainer) {
        this.closePopup(overlay, btns);
        this.fetchTopics(contentContainer);
      }
    }

    fetchTopics = (contentContainer) => {
      const outerThis = this;
  		const topicsLoader = this.shadowObj.querySelector('.loader-container');
  		setTimeout(() => {
        // fetch the user stats
        const options = {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          }
        };
    
        this.fetchWithTimeout(this._url, options)
          .then(response => {
            return response.json();
          })
          .then(data => {
            // check for success response
            if (data.success) {
              // update the content
              const content = outerThis.getHighlights(data.data);
              // remove the loader
              topicsLoader.remove();
              // insert the content
              contentContainer.insertAdjacentHTML('beforeend', content);
            }
            else {
              // display error message
              const content = outerThis.getEmpty();
              topicsLoader.remove();
              contentContainer.insertAdjacentHTML('beforeend', content);
            }
          })
          .catch(error => {
            // display error message
            const content = outerThis.getEmpty();
            topicsLoader.remove();
            contentContainer.insertAdjacentHTML('beforeend', content);
          });
  		}, 2000);
  	}

    fetchWithTimeout = async (url, options = {}, timeout = 9500) => {
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), timeout);
    
      try {
        const response = await fetch(url, {
          ...options,
          signal: controller.signal
        });

        return response;
      } catch (error) {
        if (error.name === 'AbortError') {
          throw new Error('Request timed out');
        }
        throw new Error(`Network error: ${error.message}`);
      } finally {
        clearTimeout(timeoutId);
      }
    };

    formatNumber = n => {
      if (n >= 0 && n <= 999) {
        return n.toString();
      } else if (n >= 1000 && n <= 9999) {
        const value = (n / 1000).toFixed(2);
        return `${value}k`;
      } else if (n >= 10000 && n <= 99999) {
        const value = (n / 1000).toFixed(1);
        return `${value}k`;
      } else if (n >= 100000 && n <= 999999) {
        const value = (n / 1000).toFixed(0);
        return `${value}k`;
      } else if (n >= 1000000 && n <= 9999999) {
        const value = (n / 1000000).toFixed(2);
        return `${value}M`;
      } else if (n >= 10000000 && n <= 99999999) {
        const value = (n / 1000000).toFixed(1);
        return `${value}M`;
      } else if (n >= 100000000 && n <= 999999999) {
        const value = (n / 1000000).toFixed(0);
        return `${value}M`;
      } else if (n >= 1000000000) {
        return "1B+";
      }
      else {
        return 0;
      }
    }

    parseToNumber = num_str => {
      // Try parsing the string to an integer
      const num = parseInt(num_str);

      // Check if parsing was successful
      if (!isNaN(num)) {
        return num;
      } else {
        return 0;
      }
    }

    disconnectedCallback() {
      this.enableScroll();
    }

    disableScroll() {
      // Get the current page scroll position
      let scrollTop = window.scrollY || document.documentElement.scrollTop;
      let scrollLeft = window.scrollX || document.documentElement.scrollLeft;
      document.body.classList.add("stop-scrolling");

      // if any scroll is attempted, set this to the previous value
      window.onscroll = function() {
        window.scrollTo(scrollLeft, scrollTop);
      };
    }

    enableScroll() {
      document.body.classList.remove("stop-scrolling");
      window.onscroll = function() {};
    }

    // close the modal
    closePopup = (overlay, btns) => {
      overlay.addEventListener('click', e => {
        e.preventDefault();
        this.remove();
      });

      btns.forEach(btn => {
        btn.addEventListener('click', e => {
          e.preventDefault();
          this.remove();
        });
      });
    }

    getTemplate() {
      // Show HTML Here
      return `
      <div class="overlay"></div>
      <section id="content" class="content">
        ${this.getWelcome()}
      </section>
    ${this.getStyles()}`
    }

    getWelcome() {
      return /* html */`
      <div class="welcome">
				<ul class="highlights">
          ${this.getLoader()}
        </ul>
			</div>
    `
    }

    getHighlights = data => {
      // Get the number of followers, views, stories and topics
      const followers = this.parseToNumber(this.getAttribute('followers'));
      data.all;
      const stories = this.parseToNumber(this.getAttribute('stories'));
      const topics = data.topics;

      const replies = this.parseToNumber(this.getAttribute('replies'));

      // get current and last month views
      const currentMonthViews = data.current;
      const lastMonthViews = data.last;

      let name = this.getAttribute('name');

      if (name) {
        name = name.split(' ');

        name = name[0];
        name = name.toLowerCase();
      }
      else {
        name = 'User';
      }

      // calculate the percentage increase or decrease in views
      const percentage = lastMonthViews === 0 ? 100 : ((currentMonthViews - lastMonthViews) / lastMonthViews) * 100;

      let increaseOrDecrease = this.getLevel(name);

      // check if last month views is 0 and this month views is also 0
      if (lastMonthViews > 0 || currentMonthViews > 0) {
        // convert percentage to 1 decimal place if it is a decimal
        const percentageFormatted = percentage % 1 === 0 ? percentage : percentage.toFixed(1);

        // get the increase or decrease in views
        increaseOrDecrease = percentage > 0 ? this.getIncrease(percentageFormatted) : this.getDecrease(Math.abs(percentageFormatted));
      }

      // format the number of followers, views, stories and topics
      const followersFormatted = this.formatNumber(followers);
      const viewsFormatted = this.formatNumber(currentMonthViews);
      const storiesFormatted = this.formatNumber(stories);
      const topicsFormatted = this.formatNumber(topics);

      return /* html */`
      <li class="item">
        <span class="icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" fill="currentColor">
            <path d="M2 5.5a3.5 3.5 0 1 1 5.898 2.549 5.508 5.508 0 0 1 3.034 4.084.75.75 0 1 1-1.482.235 4 4 0 0 0-7.9 0 .75.75 0 0 1-1.482-.236A5.507 5.507 0 0 1 3.102 8.05 3.493 3.493 0 0 1 2 5.5ZM11 4a3.001 3.001 0 0 1 2.22 5.018 5.01 5.01 0 0 1 2.56 3.012.749.749 0 0 1-.885.954.752.752 0 0 1-.549-.514 3.507 3.507 0 0 0-2.522-2.372.75.75 0 0 1-.574-.73v-.352a.75.75 0 0 1 .416-.672A1.5 1.5 0 0 0 11 5.5.75.75 0 0 1 11 4Zm-5.5-.5a2 2 0 1 0-.001 3.999A2 2 0 0 0 5.5 3.5Z"></path>
          </svg>
        </span>
        <span class="link">
          <span class="numbers" id="followers">${followersFormatted}</span> ${followers === 1 ? 'person' : 'people'} follows ${name.toLowerCase()}
        </span>
      </li>
      <li class="item">
        <span class="icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" fill="currentColor">
            <path d="M6 2c.306 0 .582.187.696.471L10 10.731l1.304-3.26A.751.751 0 0 1 12 7h3.25a.75.75 0 0 1 0 1.5h-2.742l-1.812 4.528a.751.751 0 0 1-1.392 0L6 4.77 4.696 8.03A.75.75 0 0 1 4 8.5H.75a.75.75 0 0 1 0-1.5h2.742l1.812-4.529A.751.751 0 0 1 6 2Z"></path>
          </svg>
        </span>
        <span class="link">
          <span class="numbers" id="views">${viewsFormatted}</span> content views this month
        </span>
      </li>
      ${increaseOrDecrease}
      <li class="item">
        <span class="icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" fill="currentColor">
            <path d="M0 3.75C0 2.784.784 2 1.75 2h12.5c.966 0 1.75.784 1.75 1.75v8.5A1.75 1.75 0 0 1 14.25 14H1.75A1.75 1.75 0 0 1 0 12.25Zm1.75-.25a.25.25 0 0 0-.25.25v8.5c0 .138.112.25.25.25h12.5a.25.25 0 0 0 .25-.25v-8.5a.25.25 0 0 0-.25-.25ZM3.5 6.25a.75.75 0 0 1 .75-.75h7a.75.75 0 0 1 0 1.5h-7a.75.75 0 0 1-.75-.75Zm.75 2.25h4a.75.75 0 0 1 0 1.5h-4a.75.75 0 0 1 0-1.5Z"></path>
          </svg>
        </span>
        <span class="link">
          <span class="numbers" id="stories">${storiesFormatted}</span> published ${stories === 1 ? 'story' : 'stories'}/${stories === 1 ? 'post' : 'posts'}
        </span>
      </li>
      <li class="item">
        <span class="icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" fill="currentColor">
            <path d="M6.78 1.97a.75.75 0 0 1 0 1.06L3.81 6h6.44A4.75 4.75 0 0 1 15 10.75v2.5a.75.75 0 0 1-1.5 0v-2.5a3.25 3.25 0 0 0-3.25-3.25H3.81l2.97 2.97a.749.749 0 0 1-.326 1.275.749.749 0 0 1-.734-.215L1.47 7.28a.75.75 0 0 1 0-1.06l4.25-4.25a.75.75 0 0 1 1.06 0Z"></path>
          </svg>
        </span>
        <span class="link">
          <span class="numbers" id="replies">${replies}</span> repl${replies === 1 ? 'y' : 'ies'} added so far
        </span>
      </li>
      <li class="item">
        <span class="icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" fill="currentColor">
            <path d="M6.368 1.01a.75.75 0 0 1 .623.859L6.57 4.5h3.98l.46-2.868a.75.75 0 0 1 1.48.237L12.07 4.5h2.18a.75.75 0 0 1 0 1.5h-2.42l-.64 4h2.56a.75.75 0 0 1 0 1.5h-2.8l-.46 2.869a.75.75 0 0 1-1.48-.237l.42-2.632H5.45l-.46 2.869a.75.75 0 0 1-1.48-.237l.42-2.632H1.75a.75.75 0 0 1 0-1.5h2.42l.64-4H2.25a.75.75 0 0 1 0-1.5h2.8l.46-2.868a.75.75 0 0 1 .858-.622ZM9.67 10l.64-4H6.33l-.64 4Z"></path>
          </svg>
        </span>
        <span class="link">
          subscribed to <span class="numbers" id="topics">${topicsFormatted}</span> topic${topics === 1 ? '' : 's'}
        </span>
      </li>
      <div class="empty">
        <p class="italics">
          This is a summary of the user's content and interactions performance on the platform.
        </p>
      </div>
    `
    }

    getIncrease = percentage => {
      return /*html*/`
      <li class="item">
        <span class="icon increase">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" fill="currentColor">
            <path d="M4.53 4.75A.75.75 0 0 1 5.28 4h6.01a.75.75 0 0 1 .75.75v6.01a.75.75 0 0 1-1.5 0v-4.2l-5.26 5.261a.749.749 0 0 1-1.275-.326.749.749 0 0 1 .215-.734L9.48 5.5h-4.2a.75.75 0 0 1-.75-.75Z"></path>
          </svg>
        </span>
        <span class="link">
          <span class="numbers" id="percentage">${percentage}%</span> increase in views this month
        </span>
      </li>
    `
    }

    getLevel = name => {
      return /*html*/`
      <li class="item">
        <span class="icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" fill="currentColor">
            <path d="M11.93 8.5a4.002 4.002 0 0 1-7.86 0H.75a.75.75 0 0 1 0-1.5h3.32a4.002 4.002 0 0 1 7.86 0h3.32a.75.75 0 0 1 0 1.5Zm-1.43-.75a2.5 2.5 0 1 0-5 0 2.5 2.5 0 0 0 5 0Z"></path>
          </svg>
        </span>
        <span class="link">
          ${name} has no content views yet
        </span>
      </li>
    `
    }

    getDecrease = percentage => {
      return /*html*/`
      <li class="item">
        <span class="icon decrease">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" fill="currentColor">
            <path d="M4.22 4.179a.75.75 0 0 1 1.06 0l5.26 5.26v-4.2a.75.75 0 0 1 1.5 0v6.01a.75.75 0 0 1-.75.75H5.28a.75.75 0 0 1 0-1.5h4.2L4.22 5.24a.75.75 0 0 1 0-1.06Z"></path>
          </svg>
        </span>
        <span class="link">
          <span class="numbers" id="percentage">${percentage}%</span> decrease in views this month
        </span>
      </li>
    `
    }

    getEmpty = () => {
      return /* html */`
      <div class="empty">
        <p>User highlights were not loaded, and error while fetching data</p>
        <p>Try refreshing the page or check your internet connection. If the problem persists, please contact support.</p>
      </div>
    `
    }

    getLoader() {
      return /* html */`
      <div class="loader-container">
        <span id="btn-loader">
          <span class="loader-alt"></span>
        </span>
      </div>
    `
    }

    getStyles() {
      return /*css*/`
      <style>
        * {
          box-sizing: border-box !important;
        }

        :host{
          border: none;
          padding: 0;
          justify-self: end;
          display: flex;
          flex-flow: column;
          align-items: center;
          justify-content: center;
          gap: 10px;
          z-index: 100;
          width: 100%;
          min-width: 100vw;
          position: fixed;
          right: 0;
          top: 0;
          bottom: 0;
          left: 0;
        }

        div.overlay {
          position: absolute;
          top: 0;
          right: 0;
          bottom: 0;
          left: 0;
          height: 100%;
          width: 100%;
          background-color: var(--modal-background);
          backdrop-filter: blur(3px);
          -webkit-backdrop-filter: blur(3px);
        }

        div.loader-container {
          position: relative;
          width: 100%;
          height: 150px;
          padding: 20px 0 0 0;
        }

        #btn-loader {
          position: absolute;
          top: 0;
          left: 0;
          bottom: 0;
          right: 0;
          z-index: 5;
          display: flex;
          align-items: center;
          justify-content: center;
          border-radius: inherit;
        }

        #btn-loader > .loader-alt {
          width: 35px;
          aspect-ratio: 1;
          --_g: no-repeat radial-gradient(farthest-side, #18A565 94%, #0000);
          --_g1: no-repeat radial-gradient(farthest-side, #21D029 94%, #0000);
          --_g2: no-repeat radial-gradient(farthest-side, #df791a 94%, #0000);
          --_g3: no-repeat radial-gradient(farthest-side, #f09c4e 94%, #0000);
          background:    var(--_g) 0 0,    var(--_g1) 100% 0,    var(--_g2) 100% 100%,    var(--_g3) 0 100%;
          background-size: 30% 30%;
          animation: l38 .9s infinite ease-in-out;
          -webkit-animation: l38 .9s infinite ease-in-out;
        }

        #btn-loader > .loader {
          width: 20px;
          aspect-ratio: 1;
          --_g: no-repeat radial-gradient(farthest-side, #ffffff 94%, #0000);
          --_g1: no-repeat radial-gradient(farthest-side, #ffffff 94%, #0000);
          --_g2: no-repeat radial-gradient(farthest-side, #df791a 94%, #0000);
          --_g3: no-repeat radial-gradient(farthest-side, #f09c4e 94%, #0000);
          background:    var(--_g) 0 0,    var(--_g1) 100% 0,    var(--_g2) 100% 100%,    var(--_g3) 0 100%;
          background-size: 30% 30%;
          animation: l38 .9s infinite ease-in-out;
          -webkit-animation: l38 .9s infinite ease-in-out;
        }

        @keyframes l38 {
          100% {
            background-position: 100% 0, 100% 100%, 0 100%, 0 0
          }
        }

        #content {
          z-index: 1;
          background-color: var(--background);
          padding: 20px 10px;
          display: flex;
          flex-flow: column;
          align-items: center;
          justify-content: center;
          gap: 0;
          width: 700px;
          max-height: 90%;
          height: max-content;
          border-radius: 25px;
          position: relative;
        }

        .welcome {
          width: 98%;
          display: flex;
          flex-flow: column;
          align-items: center;
          justify-content: center;
          row-gap: 0;
        }

        .welcome > h2 {
          width: 100%;
          font-size: 1.35rem;
          font-weight: 600;
          margin: 0 0 10px;
          padding: 10px 10px;
          background-color: var(--gray-background);
          text-align: center;
          border-radius: 12px;
          font-family: var(--font-read), sans-serif;
          color: var(--text-color);
          font-weight: 500;
          position: relative;
        }

        .welcome > h2 > span.control {
          padding: 0;
          cursor: pointer;
          display: flex;
          flex-flow: column;
          gap: 0px;
          justify-content: center;
          position: absolute;
          top: 50%;
          left: 10px;
          transform: translateY(-50%);
        }

        .welcome > h2 > span.control svg {
          width: 20px;
          height: 20px;
          color: var(--text-color);
        }

        .welcome > h2 > span.control svg:hover{
          color: var(--error-color);
        }

        div.empty {
          width: 100%;
          padding: 0;
          margin: 0;
          display: flex;
          flex-flow: column;
          gap: 8px;
        }

        div.empty > p {
          width: 100%;
          padding: 0;
          margin: 0;
          color: var(--text-color);
          font-family: var(--font-text), sans-serif;
          font-size: 1rem;
          font-weight: 400;
        }

        div.empty > p.italics {
          font-family: var(--font-main), sans-serif;
        }
        
        ul.highlights {
          width: 100%;
          padding: 0;
          margin: 0;
          list-style-type: none;
          display: flex;
          flex-flow: column;
          gap: 10px;
        }
        
        ul.highlights > li.item {
          padding: 0;
          margin: 0;
          width: 100%;
          display: flex;
          flex-flow: row;
          align-items: center;
          flex-wrap: nowrap;
          gap: 10px;
        }
        
        ul.highlights > li.item > .icon {
          display: flex;
          align-items: center;
          justify-content: center;
          height: 26px;
          width: 26px;
          min-height: 26px;
          min-width: 26px;
          max-height: 26px;
          max-width: 26px;
          padding: 3px;
          border-radius: 50px;
          -webkit-border-radius: 50px;
          -moz-border-radius: 50px;
          background-color: var(--gray-background);
          color: var(--gray-color);
          font-size: 0.9rem;
          font-weight: 500;
          text-transform: capitalize;
        }
        
        ul.highlights > li.item > .icon > svg {
          height: 15px;
          width: 15px;
        }

        ul.highlights > li.item > .icon.increase {
          background: var(--accent-linear);
          color: var(--white-color);
        }

        ul.highlights > li.item > .icon.decrease {
          background: var(--error-linear);
          color: var(--white-color);
        }
        
        ul.highlights > li.item > .link {
          color: var(--text-color);
          font-family: var(--font-main), sans-serif;
          font-size: 1rem;
          font-weight: 400;
          text-decoration: none;
        }
        
        ul.highlights > li.item > a.link:hover {
          color: var(--text-color);
        }
        
        ul.highlights > li.item > .link .numbers {
          color: var(--highlight-color);
          font-weight: 600;
          font-family: var(--font-main), sans-serif;
          font-size: 0.95rem;
          display: inline-block;
          margin: 0 0 -2px 0;
        }
        
        ul.highlights > li.item.last {
          background-color: var(--gray-background);
          padding: 10px;
          margin: 5px 0;
          border-radius: 12px;
          -webkit-border-radius: 12px;
        }

        @media screen and ( max-width: 850px ){
          #content {
            width: 90%;
          }
        }

        @media screen and ( max-width: 600px ){
          :host {
            border: none;
            background-color: var(--modal-background);
            padding: 0px;
            justify-self: end;
            display: flex;
            flex-flow: column;
            align-items: center;
            justify-content: end;
            gap: 10px;
            z-index: 20;
            position: fixed;
            right: 0;
            top: 0;
            bottom: 0;
            left: 0;
          }

          #content {
            box-sizing: border-box !important;
            padding: 5px 0 0 0;
            margin: 0;
            width: 100%;
            max-width: 100%;
            max-height: 90%;
            min-height: max-content;
            border-radius: 0px;
            border-top: var(--mobile-border);
            border-top-right-radius: 15px;
            border-top-left-radius: 15px;
          }

          .welcome {
            width: 100%;
            padding: 0 15px 20px;
            display: flex;
            flex-flow: column;
            align-items: center;
            justify-content: center;
          }

          .welcome > h2 {
            width: 100%;
            font-size: 1.2rem;
            margin: 0 0 10px;
            padding: 10px 10px;
            background-color: var(--gray-background);
            text-align: center;
            border-radius: 12px;
          }

          .welcome > .actions {
            width: 100%;
          }

          .welcome > .actions .action {
            background: var(--stage-no-linear);
            text-decoration: none;
            padding: 7px 20px 8px;
            cursor: default;
            margin: 10px 0;
            width: 120px;
            cursor: default !important;
            border-radius: 12px;
          }

          .welcome > h2 > span.control,
          .welcome > .actions > .action {
            cursor: default !important;
          }
          
        }
      </style>
    `;
    }
  }

  class ContactPopup extends HTMLElement {
    constructor() {

      // We are not even going to touch this.
      super();

      this._url = this.getAttribute('url');

      // let's create our shadow root
      this.shadowObj = this.attachShadow({mode: 'open'});

      this.render();
    }

    render() {
      this.shadowObj.innerHTML = this.getTemplate();
    }

    connectedCallback() {
      this.disableScroll();

      // Select the close button & overlay
      const overlay = this.shadowObj.querySelector('.overlay');
      const btns = this.shadowObj.querySelectorAll('.cancel-btn');
      const contentContainer = this.shadowObj.querySelector('div.options');

      // Close the modal
      if (overlay && btns && contentContainer) {
        this.closePopup(overlay, btns);
        this.fetchTopics(contentContainer);
      }
    }

    fetchTopics = (contentContainer) => {
      const outerThis = this;
  		const topicsLoader = this.shadowObj.querySelector('.loader-container');
      const str = this.getAttribute('contact');
      // console.log(str)
      let contact= null;
      if (str !== null || str !== '' || str !== 'null') {
        try {
          contact = JSON.parse(str);
        }
        catch (error) {
          console.log(error);
          contact = null;
        }
      }
  		setTimeout(() => {
        if (contact === undefined || contact === null) {
          // display error message
          const content = outerThis.getEmpty();
          topicsLoader.remove();
          contentContainer.insertAdjacentHTML('beforeend', content);
          return;
        }
        // update the content
        const content = outerThis.getContactOptions(contact);
        // remove the loader
        topicsLoader.remove();
        // insert the content
        contentContainer.insertAdjacentHTML('beforeend', content);
  		}, 2000);
  	}

    disconnectedCallback() {
      
      this.enableScroll();
    }

    disableScroll() {
      // Get the current page scroll position
      let scrollTop = window.scrollY || document.documentElement.scrollTop;
      let scrollLeft = window.scrollX || document.documentElement.scrollLeft;
      document.body.classList.add("stop-scrolling");

      // if any scroll is attempted, set this to the previous value
      window.onscroll = function() {
        window.scrollTo(scrollLeft, scrollTop);
      };
    }

    enableScroll() {
      document.body.classList.remove("stop-scrolling");
      window.onscroll = function() {};
    }

    // close the modal
    closePopup = (overlay, btns) => {
      overlay.addEventListener('click', e => {
        e.preventDefault();
        this.remove();
      });

      btns.forEach(btn => {
        btn.addEventListener('click', e => {
          e.preventDefault();
          this.remove();
        });
      });
    }

    getTemplate() {
      // Show HTML Here
      return /*html*/`
      <div class="overlay"></div>
      <section id="content" class="content">
        ${this.getWelcome()}
      </section>
    ${this.getStyles()}`
    }

    getWelcome() {
      return /*html*/`
      <div class="welcome">
				<div class="options">
          ${this.getLoader()}
        </div>
			</div>
    `
    }

    getContactOptions = data => {
      return /* html */`
      ${data.x ? this.getX(data.x) : ''}
      ${data.linkedin ? this.getLinkedIn(data.linkedin) : ''}
      ${data.threads ? this.getThreads(data.threads) : ''}
      ${data.email ? this.getEmail(data.email) : ''}
      ${data.website ? this.getWebsite(data.website) : ''}
      <div class="empty">
        <p class="italics">The above is only contact information shared by the user.</p>
      </div>
		`
    }

    getX = username => {
      return /*html*/`
      <a href="https://x.com/${username}" target="_blank" rel="noopener" class="link x">
        <span class="icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-twitter-x" viewBox="0 0 16 16">
            <path  d="M12.6.75h2.454l-5.36 6.142L16 15.25h-4.937l-3.867-5.07-4.425 5.07H.316l5.733-6.57L0 .75h5.063l3.495 4.633L12.601.75Zm-.86 13.028h1.36L4.323 2.145H2.865z" />
          </svg>
        </span>
        <span class="text">X(Twitter)</span>
      </a>
    `
    }

    getLinkedIn = username => {
      return /*html*/`
      <a href="https://linkedin.com/in/${username}" target="_blank" rel="noopener" class="link linkedin">
        <span class="icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-linkedin" viewBox="0 0 16 16">
            <path d="M0 1.146C0 .513.526 0 1.175 0h13.65C15.474 0 16 .513 16 1.146v13.708c0 .633-.526 1.146-1.175 1.146H1.175C.526 16 0 15.487 0 14.854zm4.943 12.248V6.169H2.542v7.225zm-1.2-8.212c.837 0 1.358-.554 1.358-1.248-.015-.709-.52-1.248-1.342-1.248S2.4 3.226 2.4 3.934c0 .694.521 1.248 1.327 1.248zm4.908 8.212V9.359c0-.216.016-.432.08-.586.173-.431.568-.878 1.232-.878.869 0 1.216.662 1.216 1.634v3.865h2.401V9.25c0-2.22-1.184-3.252-2.764-3.252-1.274 0-1.845.7-2.165 1.193v.025h-.016l.016-.025V6.169h-2.4c.03.678 0 7.225 0 7.225z" />
          </svg>
        </span>
        <span class="text">LinkedIn</span>
      </a>
    `
    }

    getThreads = username => {
      return /*html*/`
      <a href="https://threads.net/@${username}" target="_blank" rel="noopener" class="link threads">
        <span class="icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-threads" viewBox="0 0 16 16">
            <path d="M6.321 6.016c-.27-.18-1.166-.802-1.166-.802.756-1.081 1.753-1.502 3.132-1.502.975 0 1.803.327 2.394.948s.928 1.509 1.005 2.644q.492.207.905.484c1.109.745 1.719 1.86 1.719 3.137 0 2.716-2.226 5.075-6.256 5.075C4.594 16 1 13.987 1 7.994 1 2.034 4.482 0 8.044 0 9.69 0 13.55.243 15 5.036l-1.36.353C12.516 1.974 10.163 1.43 8.006 1.43c-3.565 0-5.582 2.171-5.582 6.79 0 4.143 2.254 6.343 5.63 6.343 2.777 0 4.847-1.443 4.847-3.556 0-1.438-1.208-2.127-1.27-2.127-.236 1.234-.868 3.31-3.644 3.31-1.618 0-3.013-1.118-3.013-2.582 0-2.09 1.984-2.847 3.55-2.847.586 0 1.294.04 1.663.114 0-.637-.54-1.728-1.9-1.728-1.25 0-1.566.405-1.967.868ZM8.716 8.19c-2.04 0-2.304.87-2.304 1.416 0 .878 1.043 1.168 1.6 1.168 1.02 0 2.067-.282 2.232-2.423a6.2 6.2 0 0 0-1.528-.161"/>
          </svg>
        </span>
        <span class="text">Threads</span>
      </a>
    `
    }

    getEmail = email => {
      return /*html*/`
      <a href="mailto:${email}" class="link email">
        <span class="icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-envelope-paper" viewBox="0 0 16 16">
            <path d="M4 0a2 2 0 0 0-2 2v1.133l-.941.502A2 2 0 0 0 0 5.4V14a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V5.4a2 2 0 0 0-1.059-1.765L14 3.133V2a2 2 0 0 0-2-2zm10 4.267.47.25A1 1 0 0 1 15 5.4v.817l-1 .6zm-1 3.15-3.75 2.25L8 8.917l-1.25.75L3 7.417V2a1 1 0 0 1 1-1h8a1 1 0 0 1 1 1zm-11-.6-1-.6V5.4a1 1 0 0 1 .53-.882L2 4.267zm13 .566v5.734l-4.778-2.867zm-.035 6.88A1 1 0 0 1 14 15H2a1 1 0 0 1-.965-.738L8 10.083zM1 13.116V7.383l4.778 2.867L1 13.117Z" />
          </svg>
        </span>
        <span class="text">Email</span>
      </a>
    `
    }

    getWebsite = website => {
      return /*html*/`
      <a href="${website}" target="_blank" rel="noopener" class="link website">
        <span class="icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-link-45deg" viewBox="0 0 16 16">
            <path d="M4.715 6.542 3.343 7.914a3 3 0 1 0 4.243 4.243l1.828-1.829A3 3 0 0 0 8.586 5.5L8 6.086a1 1 0 0 0-.154.199 2 2 0 0 1 .861 3.337L6.88 11.45a2 2 0 1 1-2.83-2.83l.793-.792a4 4 0 0 1-.128-1.287z"/>
            <path d="M6.586 4.672A3 3 0 0 0 7.414 9.5l.775-.776a2 2 0 0 1-.896-3.346L9.12 3.55a2 2 0 1 1 2.83 2.83l-.793.792c.112.42.155.855.128 1.287l1.372-1.372a3 3 0 1 0-4.243-4.243z"/>
          </svg>
        </span>
        <span class="text">Website</span>
      </a>
    `
    }

    getEmpty = () => {
      return /* html */`
      <div class="empty">
        <p>This user hasn't publicly shared any contact information. Note that this information is only available if the user chose to share it publicly.</p>
        <p class="italics">You can still interact with the user via public information on their profile.</p>
      </div>
    `
    }

    getLoader() {
      return /* html */`
      <div class="loader-container">
        <span id="btn-loader">
          <span class="loader-alt"></span>
        </span>
      </div>
    `
    }

    getStyles() {
      return /*css*/`
      <style>
        * {
          box-sizing: border-box !important;
        }

        :host{
          border: none;
          padding: 0;
          justify-self: end;
          display: flex;
          flex-flow: column;
          align-items: center;
          justify-content: center;
          gap: 10px;
          z-index: 100;
          width: 100%;
          min-width: 100vw;
          position: fixed;
          right: 0;
          top: 0;
          bottom: 0;
          left: 0;
        }

        div.overlay {
          position: absolute;
          top: 0;
          right: 0;
          bottom: 0;
          left: 0;
          height: 100%;
          width: 100%;
          background-color: var(--modal-background);
          backdrop-filter: blur(3px);
          -webkit-backdrop-filter: blur(3px);
        }

        div.loader-container {
          position: relative;
          width: 100%;
          height: 150px;
          padding: 20px 0 0 0;
        }

        #btn-loader {
          position: absolute;
          top: 0;
          left: 0;
          bottom: 0;
          right: 0;
          z-index: 5;
          display: flex;
          align-items: center;
          justify-content: center;
          border-radius: inherit;
        }

        #btn-loader > .loader-alt {
          width: 35px;
          aspect-ratio: 1;
          --_g: no-repeat radial-gradient(farthest-side, #18A565 94%, #0000);
          --_g1: no-repeat radial-gradient(farthest-side, #21D029 94%, #0000);
          --_g2: no-repeat radial-gradient(farthest-side, #df791a 94%, #0000);
          --_g3: no-repeat radial-gradient(farthest-side, #f09c4e 94%, #0000);
          background:    var(--_g) 0 0,    var(--_g1) 100% 0,    var(--_g2) 100% 100%,    var(--_g3) 0 100%;
          background-size: 30% 30%;
          animation: l38 .9s infinite ease-in-out;
          -webkit-animation: l38 .9s infinite ease-in-out;
        }

        #btn-loader > .loader {
          width: 20px;
          aspect-ratio: 1;
          --_g: no-repeat radial-gradient(farthest-side, #ffffff 94%, #0000);
          --_g1: no-repeat radial-gradient(farthest-side, #ffffff 94%, #0000);
          --_g2: no-repeat radial-gradient(farthest-side, #df791a 94%, #0000);
          --_g3: no-repeat radial-gradient(farthest-side, #f09c4e 94%, #0000);
          background:    var(--_g) 0 0,    var(--_g1) 100% 0,    var(--_g2) 100% 100%,    var(--_g3) 0 100%;
          background-size: 30% 30%;
          animation: l38 .9s infinite ease-in-out;
          -webkit-animation: l38 .9s infinite ease-in-out;
        }

        @keyframes l38 {
          100% {
            background-position: 100% 0, 100% 100%, 0 100%, 0 0
          }
        }

        #content {
          z-index: 1;
          background-color: var(--background);
          padding: 20px 10px;
          display: flex;
          flex-flow: column;
          align-items: center;
          justify-content: center;
          gap: 0;
          width: 700px;
          max-height: 90%;
          height: max-content;
          border-radius: 25px;
          position: relative;
        }
  
        .welcome {
          width: 98%;
          display: flex;
          flex-flow: column;
          align-items: center;
          justify-content: center;
          row-gap: 0;
        }

        .welcome > h2 {
          width: 100%;
          font-size: 1.35rem;
          font-weight: 600;
          margin: 0 0 10px;
          padding: 10px 10px;
          background-color: var(--gray-background);
          text-align: center;
          border-radius: 12px;
          font-family: var(--font-read), sans-serif;
          color: var(--text-color);
          font-weight: 500;
          position: relative;
        }

        .welcome > h2 > span.control {
          padding: 0;
          cursor: pointer;
          display: flex;
          flex-flow: column;
          gap: 0px;
          justify-content: center;
          position: absolute;
          top: 50%;
          left: 10px;
          transform: translateY(-50%);
        }

        .welcome > h2 > span.control svg {
          width: 20px;
          height: 20px;
          color: var(--text-color);
        }

        .welcome > h2 > span.control svg:hover{
          color: var(--error-color);
        }

        div.empty {
          width: 100%;
          padding: 0;
          margin: 0;
          display: flex;
          flex-flow: column;
          gap: 8px;
        }

        div.empty > p {
          width: 100%;
          text-align: center;
          padding: 0;
          margin: 0;
          color: var(--text-color);
          font-family: var(--font-text), sans-serif;
          font-size: 1rem;
          font-weight: 400;
        }

        div.empty > p.italics {
          margin: 5px 0 0 0;
          font-style: italic;
        }
        
        .options {
          width: 100%;
          padding: 5px 0;
          display: flex;
          flex-flow: row;
          flex-wrap: wrap;
          gap: 15px;
          align-items: center;
          justify-content: center;
        }

        .options a.link {
          display: flex;
          flex-flow: row;
          align-items: center;
          justify-content: center;
          gap: 5px;
          margin: 5px 8px 0;
          padding: 5px 15px 5px 12px;
          background-color: var(--gray-background);
          border-radius: 12px;
          text-decoration: none;
          color: var(--text-color);
          font-family: var(--font-text), sans-serif;
          font-size: 1rem;
          font-weight: 400;
        }

        .options a.link > .icon {
          width: 25px;
          height: 25px;
          display: flex;
          align-items: center;
          justify-content: center;
        }

        .options a.link.x {
          background: linear-gradient(103.53deg, #1DA1F2 -6.72%, #0A95D7 109.77%);
          color: var(--white-color);
        }

        .options a.link.facebook {
          background: linear-gradient(103.53deg, #1877F2 -6.72%, #0A5A9C 109.77%);
          color: var(--white-color);
        }

        .options a.link.linkedin {
          background: linear-gradient(103.53deg, #0077B5 -6.72%, #005684 109.77%);
          color: var(--white-color);
        }

        .options a.link.mail {
          background: linear-gradient(103.53deg, #D44638 -6.72%, #D44638 109.77%);
          color: var(--white-color);
        }

        .share-buttons > a.whatsapp {
          background: linear-gradient(103.53deg, #25D366 -6.72%, #25D366 109.77%);
        }

        .options a.link > .icon svg {
          width: 15px;
          height: 15px;
          color: inherit;
        }

        .options a.link > .text {
          display: flex;
          align-items: center;
          justify-content: center;
          color: inherit;
        }

        @media screen and ( max-width: 850px ){
          #content {
            width: 90%;
          }
        }

        @media screen and ( max-width: 600px ){
          :host {
            border: none;
            background-color: var(--modal-background);
            padding: 0px;
            justify-self: end;
            display: flex;
            flex-flow: column;
            align-items: center;
            justify-content: end;
            gap: 10px;
            z-index: 20;
            position: fixed;
            right: 0;
            top: 0;
            bottom: 0;
            left: 0;
          }

          a {
            cursor: default !important;
          }

          #content {
            box-sizing: border-box !important;
            padding: 5px 0 0 0;
            margin: 0;
            width: 100%;
            max-width: 100%;
            max-height: 90%;
            min-height: max-content;
            border-radius: 0px;
            border-top: var(--mobile-border);
            border-top-right-radius: 15px;
            border-top-left-radius: 15px;
          }

          .welcome {
            width: 100%;
            padding: 0 15px 20px;
            display: flex;
            flex-flow: column;
            align-items: center;
            justify-content: center;
          }

          .welcome > h2 {
            width: 100%;
            font-size: 1.2rem;
            margin: 0 0 10px;
            padding: 10px 10px;
            background-color: var(--gray-background);
            text-align: center;
            border-radius: 12px;
          }

          .welcome > .actions {
            width: 100%;
          }

          .welcome > h2 > span.control,
          .welcome > .actions > .action {
            cursor: default !important;
          }
        }
      </style>
    `;
    }
  }

  class TopicPopup extends HTMLElement {
    constructor() {

      // We are not even going to touch this.
      super();

      this._url = this.getAttribute('url');

      // let's create our shadow root
      this.shadowObj = this.attachShadow({mode: 'open'});

      this.render();
    }

    render() {
      this.shadowObj.innerHTML = this.getTemplate();
    }

    connectedCallback() {
      this.disableScroll();

      // Select the close button & overlay
      const overlay = this.shadowObj.querySelector('.overlay');
      const btns = this.shadowObj.querySelectorAll('.cancel-btn');
      const contentContainer = this.shadowObj.querySelector('ul.highlights');

      // Close the modal
      if (overlay && btns && contentContainer) {
        this.closePopup(overlay, btns);
        this.fetchTopics(contentContainer);
      }
    }

    fetchTopics = (contentContainer) => {
      const outerThis = this;
  		const topicsLoader = this.shadowObj.querySelector('.loader-container');
  		setTimeout(() => {
        // fetch the user stats
        const options = {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          }
        };
    
        this.fetchWithTimeout(this._url, options)
          .then(response => {
            return response.json();
          })
          .then(data => {
            // check for success response
            if (data.success) {
              // update the content
              const content = outerThis.getHighlights(data.data);
              // remove the loader
              topicsLoader.remove();
              // insert the content
              contentContainer.insertAdjacentHTML('beforeend', content);
            }
            else {
              // display error message
              const content = outerThis.getEmpty();
              topicsLoader.remove();
              contentContainer.insertAdjacentHTML('beforeend', content);
            }
          })
          .catch(error => {
            // display error message
            const content = outerThis.getEmpty();
            topicsLoader.remove();
            contentContainer.insertAdjacentHTML('beforeend', content);
          });
  		}, 2000);
  	}

    fetchWithTimeout = async (url, options = {}, timeout = 9500) => {
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), timeout);
    
      try {
        const response = await fetch(url, {
          ...options,
          signal: controller.signal
        });

        return response;
      } catch (error) {
        if (error.name === 'AbortError') {
          throw new Error('Request timed out');
        }
        throw new Error(`Network error: ${error.message}`);
      } finally {
        clearTimeout(timeoutId);
      }
    };

    formatNumber = n => {
      if (n >= 0 && n <= 999) {
        return n.toString();
      } else if (n >= 1000 && n <= 9999) {
        const value = (n / 1000).toFixed(2);
        return `${value}k`;
      } else if (n >= 10000 && n <= 99999) {
        const value = (n / 1000).toFixed(1);
        return `${value}k`;
      } else if (n >= 100000 && n <= 999999) {
        const value = (n / 1000).toFixed(0);
        return `${value}k`;
      } else if (n >= 1000000 && n <= 9999999) {
        const value = (n / 1000000).toFixed(2);
        return `${value}M`;
      } else if (n >= 10000000 && n <= 99999999) {
        const value = (n / 1000000).toFixed(1);
        return `${value}M`;
      } else if (n >= 100000000 && n <= 999999999) {
        const value = (n / 1000000).toFixed(0);
        return `${value}M`;
      } else if (n >= 1000000000) {
        return "1B+";
      }
      else {
        return 0;
      }
    }

    parseToNumber = num_str => {
      // Try parsing the string to an integer
      const num = parseInt(num_str);

      // Check if parsing was successful
      if (!isNaN(num)) {
        return num;
      } else {
        return 0;
      }
    }

    disconnectedCallback() {
      this.enableScroll();
    }

    disableScroll() {
      // Get the current page scroll position
      let scrollTop = window.scrollY || document.documentElement.scrollTop;
      let scrollLeft = window.scrollX || document.documentElement.scrollLeft;
      document.body.classList.add("stop-scrolling");

      // if any scroll is attempted, set this to the previous value
      window.onscroll = function() {
        window.scrollTo(scrollLeft, scrollTop);
      };
    }

    enableScroll() {
      document.body.classList.remove("stop-scrolling");
      window.onscroll = function() {};
    }

    // close the modal
    closePopup = (overlay, btns) => {
      overlay.addEventListener('click', e => {
        e.preventDefault();
        this.remove();
      });

      btns.forEach(btn => {
        btn.addEventListener('click', e => {
          e.preventDefault();
          this.remove();
        });
      });
    }

    getTemplate() {
      // Show HTML Here
      return /*html*/`
      <div class="overlay"></div>
      <section id="content" class="content">
        ${this.getWelcome()}
      </section>
    ${this.getStyles()}`
    }

    getWelcome() {
      return /*html*/`
      <div class="welcome">
				<ul class="highlights">
          ${this.getLoader()}
        </ul>
			</div>
    `
    }

    getHighlights = data => {
      // Get the number of followers, views, stories and topics
      const followers = this.parseToNumber(this.getAttribute('followers'));
      const views = this.parseToNumber(this.getAttribute('views'));
      const stories = this.parseToNumber(this.getAttribute('stories'));

      const subscribers = this.parseToNumber(this.getAttribute('subscribers'));

      // get current and last month views
      const currentMonthViews = data.current;
      const lastMonthViews = data.last;

      let name = this.getAttribute('name');

      // calculate the percentage increase or decrease in views
      const percentage = lastMonthViews === 0 ? 100 : ((currentMonthViews - lastMonthViews) / lastMonthViews) * 100;

      let increaseOrDecrease = this.getLevel(name);

      // check if last month views is 0 and this month views is also 0
      if (lastMonthViews > 0 || currentMonthViews > 0) {
        // convert percentage to 1 decimal place if it is a decimal
        const percentageFormatted = percentage % 1 === 0 ? percentage : percentage.toFixed(1);

        // get the increase or decrease in views
        increaseOrDecrease = percentage > 0 ? this.getIncrease(percentageFormatted) : this.getDecrease(Math.abs(percentageFormatted));
      }

      // format the number of followers, views, stories and topics
      const followersFormatted = this.formatNumber(followers);
      const viewsFormatted = this.formatNumber(views);
      const storiesFormatted = this.formatNumber(stories);
      const subFormatted = this.formatNumber(subscribers);

      return /* html */`
      <li class="item">
        <span class="icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" fill="currentColor">
            <path d="M2 5.5a3.5 3.5 0 1 1 5.898 2.549 5.508 5.508 0 0 1 3.034 4.084.75.75 0 1 1-1.482.235 4 4 0 0 0-7.9 0 .75.75 0 0 1-1.482-.236A5.507 5.507 0 0 1 3.102 8.05 3.493 3.493 0 0 1 2 5.5ZM11 4a3.001 3.001 0 0 1 2.22 5.018 5.01 5.01 0 0 1 2.56 3.012.749.749 0 0 1-.885.954.752.752 0 0 1-.549-.514 3.507 3.507 0 0 0-2.522-2.372.75.75 0 0 1-.574-.73v-.352a.75.75 0 0 1 .416-.672A1.5 1.5 0 0 0 11 5.5.75.75 0 0 1 11 4Zm-5.5-.5a2 2 0 1 0-.001 3.999A2 2 0 0 0 5.5 3.5Z"></path>
          </svg>
        </span>
        <span class="link">
          <span class="numbers" id="followers">${followersFormatted}</span> ${followers === 1 ? 'person' : 'people'} follows ${name.toLowerCase()}
        </span>
      </li>
      <li class="item">
        <span class="icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" fill="currentColor">
            <path d="M6 2c.306 0 .582.187.696.471L10 10.731l1.304-3.26A.751.751 0 0 1 12 7h3.25a.75.75 0 0 1 0 1.5h-2.742l-1.812 4.528a.751.751 0 0 1-1.392 0L6 4.77 4.696 8.03A.75.75 0 0 1 4 8.5H.75a.75.75 0 0 1 0-1.5h2.742l1.812-4.529A.751.751 0 0 1 6 2Z"></path>
          </svg>
        </span>
        <span class="link">
          <span class="numbers" id="views">${viewsFormatted}</span> all time views
        </span>
      </li>
      <li class="item">
        <span class="icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" fill="currentColor">
            <path d="M10.5 3.5H1.75a.25.25 0 0 0-.25.25v.32L8 7.88l3.02-1.77a.75.75 0 0 1 .758 1.295L8.379 9.397a.75.75 0 0 1-.758 0L1.5 5.809v6.441c0 .138.112.25.25.25h12.5a.25.25 0 0 0 .25-.25v-4.5a.75.75 0 0 1 1.5 0v4.5A1.75 1.75 0 0 1 14.25 14H1.75A1.75 1.75 0 0 1 0 12.25V4.513a.75.75 0 0 1 0-.027V3.75C0 2.784.784 2 1.75 2h8.75a.75.75 0 0 1 0 1.5Z"></path><path d="M14 6a2 2 0 1 0 0-4 2 2 0 0 0 0 4Z"></path>
          </svg>
        </span>
        <span class="link">
          <span class="numbers" id="views">${subFormatted}</span> total subscribers
        </span>
      </li>
      ${increaseOrDecrease}
      <li class="item">
        <span class="icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" fill="currentColor">
            <path d="M0 3.75C0 2.784.784 2 1.75 2h12.5c.966 0 1.75.784 1.75 1.75v8.5A1.75 1.75 0 0 1 14.25 14H1.75A1.75 1.75 0 0 1 0 12.25Zm1.75-.25a.25.25 0 0 0-.25.25v8.5c0 .138.112.25.25.25h12.5a.25.25 0 0 0 .25-.25v-8.5a.25.25 0 0 0-.25-.25ZM3.5 6.25a.75.75 0 0 1 .75-.75h7a.75.75 0 0 1 0 1.5h-7a.75.75 0 0 1-.75-.75Zm.75 2.25h4a.75.75 0 0 1 0 1.5h-4a.75.75 0 0 1 0-1.5Z"></path>
          </svg>
        </span>
        <span class="link">
          <span class="numbers" id="stories">${storiesFormatted}</span> ${stories === 1 ? 'story' : 'stories'} published under this topic
        </span>
      </li>
      <div class="empty">
        <p class="italics">This is a summary of the topic ${name.toLowerCase()} highlights</p>
      </div>
    `
    }

    getIncrease = percentage => {
      return /*html*/`
      <li class="item">
        <span class="icon increase">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" fill="currentColor">
            <path d="M4.53 4.75A.75.75 0 0 1 5.28 4h6.01a.75.75 0 0 1 .75.75v6.01a.75.75 0 0 1-1.5 0v-4.2l-5.26 5.261a.749.749 0 0 1-1.275-.326.749.749 0 0 1 .215-.734L9.48 5.5h-4.2a.75.75 0 0 1-.75-.75Z"></path>
          </svg>
        </span>
        <span class="link">
          <span class="numbers" id="percentage">${percentage}%</span> increase in views this month
        </span>
      </li>
    `
    }

    getLevel = name => {
      return /*html*/`
      <li class="item">
        <span class="icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" fill="currentColor">
            <path d="M11.93 8.5a4.002 4.002 0 0 1-7.86 0H.75a.75.75 0 0 1 0-1.5h3.32a4.002 4.002 0 0 1 7.86 0h3.32a.75.75 0 0 1 0 1.5Zm-1.43-.75a2.5 2.5 0 1 0-5 0 2.5 2.5 0 0 0 5 0Z"></path>
          </svg>
        </span>
        <span class="link">
          ${name} has no recent content views.
        </span>
      </li>
    `
    }

    getDecrease = percentage => {
      return /*html*/`
      <li class="item">
        <span class="icon decrease">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" fill="currentColor">
            <path d="M4.22 4.179a.75.75 0 0 1 1.06 0l5.26 5.26v-4.2a.75.75 0 0 1 1.5 0v6.01a.75.75 0 0 1-.75.75H5.28a.75.75 0 0 1 0-1.5h4.2L4.22 5.24a.75.75 0 0 1 0-1.06Z"></path>
          </svg>
        </span>
        <span class="link">
          <span class="numbers" id="percentage">${percentage}%</span> decrease in views this month
        </span>
      </li>
    `
    }

    getEmpty = () => {
      return /* html */`
      <div class="empty">
        <p>Topic highlights could not be retrieved at the moment.</p>
        <p>Try refreshing the page or check your internet connection. If the problem persists, please contact support.</p>
      </div>
    `
    }

    getLoader() {
      return /* html */`
      <div class="loader-container">
        <span id="btn-loader">
          <span class="loader-alt"></span>
        </span>
      </div>
    `
    }

    getStyles() {
      return /*css*/`
      <style>
        * {
          box-sizing: border-box !important;
        }

        :host{
          border: none;
          padding: 0;
          justify-self: end;
          display: flex;
          flex-flow: column;
          align-items: center;
          justify-content: center;
          gap: 10px;
          z-index: 100;
          width: 100%;
          min-width: 100vw;
          position: fixed;
          right: 0;
          top: 0;
          bottom: 0;
          left: 0;
        }

        div.overlay {
          position: absolute;
          top: 0;
          right: 0;
          bottom: 0;
          left: 0;
          height: 100%;
          width: 100%;
          background-color: var(--modal-background);
          backdrop-filter: blur(3px);
          -webkit-backdrop-filter: blur(3px);
        }

        div.loader-container {
          position: relative;
          width: 100%;
          height: 150px;
          padding: 20px 0 0 0;
        }

        #btn-loader {
          position: absolute;
          top: 0;
          left: 0;
          bottom: 0;
          right: 0;
          z-index: 5;
          display: flex;
          align-items: center;
          justify-content: center;
          border-radius: inherit;
        }

        #btn-loader > .loader-alt {
          width: 35px;
          aspect-ratio: 1;
          --_g: no-repeat radial-gradient(farthest-side, #18A565 94%, #0000);
          --_g1: no-repeat radial-gradient(farthest-side, #21D029 94%, #0000);
          --_g2: no-repeat radial-gradient(farthest-side, #df791a 94%, #0000);
          --_g3: no-repeat radial-gradient(farthest-side, #f09c4e 94%, #0000);
          background:    var(--_g) 0 0,    var(--_g1) 100% 0,    var(--_g2) 100% 100%,    var(--_g3) 0 100%;
          background-size: 30% 30%;
          animation: l38 .9s infinite ease-in-out;
          -webkit-animation: l38 .9s infinite ease-in-out;
        }

        #btn-loader > .loader {
          width: 20px;
          aspect-ratio: 1;
          --_g: no-repeat radial-gradient(farthest-side, #ffffff 94%, #0000);
          --_g1: no-repeat radial-gradient(farthest-side, #ffffff 94%, #0000);
          --_g2: no-repeat radial-gradient(farthest-side, #df791a 94%, #0000);
          --_g3: no-repeat radial-gradient(farthest-side, #f09c4e 94%, #0000);
          background:    var(--_g) 0 0,    var(--_g1) 100% 0,    var(--_g2) 100% 100%,    var(--_g3) 0 100%;
          background-size: 30% 30%;
          animation: l38 .9s infinite ease-in-out;
          -webkit-animation: l38 .9s infinite ease-in-out;
        }

        @keyframes l38 {
          100% {
            background-position: 100% 0, 100% 100%, 0 100%, 0 0
          }
        }

        #content {
          z-index: 1;
          background-color: var(--background);
          padding: 20px 10px;
          display: flex;
          flex-flow: column;
          align-items: center;
          justify-content: center;
          gap: 0;
          width: 700px;
          max-height: 90%;
          height: max-content;
          border-radius: 25px;
        }
  
        .welcome {
          width: 98%;
          display: flex;
          flex-flow: column;
          align-items: center;
          justify-content: center;
          gap: 0;
        }

        .welcome > h2 {
          width: 100%;
          font-size: 1.35rem;
          font-weight: 600;
          margin: 0;
          padding: 10px 10px;
          background-color: var(--gray-background);
          text-align: center;
          border-radius: 12px;
          font-family: var(--font-read), sans-serif;
          color: var(--text-color);
          font-weight: 500;
          position: relative;
        }

        .welcome > h2 > span.control {
          padding: 0;
          cursor: pointer;
          display: flex;
          flex-flow: column;
          gap: 0px;
          justify-content: center;
          position: absolute;
          width: max-content;
          top: 50%;
          left: 10px;
          transform: translateY(-50%);
        }

        .welcome > h2 > span.control svg {
          width: 20px;
          height: 20px;
          color: var(--text-color);
        }

        .welcome > h2 > span.control svg:hover{
          color: var(--error-color);
        }

        div.empty {
          width: 100%;
          padding: 0;
          margin: 0;
          display: flex;
          flex-flow: column;
          gap: 8px;
        }

        div.empty > p {
          width: 100%;
          padding: 0;
          margin: 0;
          color: var(--text-color);
          font-family: var(--font-main), sans-serif;
          font-size: 1rem;
          font-weight: 400;
        }

        div.empty > p.italics {
          font-family: var(--font-main), sans-serif;
        }
        
        ul.highlights {
          width: 100%;
          padding: 0;
          margin: 0;
          list-style-type: none;
          display: flex;
          flex-flow: column;
          gap: 10px;
        }
        
        ul.highlights > li.item {
          padding: 0;
          margin: 0;
          width: 100%;
          display: flex;
          flex-flow: row;
          align-items: center;
          flex-wrap: nowrap;
          gap: 10px;
        }
        
        ul.highlights > li.item > .icon {
          display: flex;
          align-items: center;
          justify-content: center;
          height: 26px;
          width: 26px;
          min-height: 26px;
          min-width: 26px;
          max-height: 26px;
          max-width: 26px;
          padding: 3px;
          border-radius: 50px;
          -webkit-border-radius: 50px;
          -moz-border-radius: 50px;
          background-color: var(--gray-background);
          color: var(--gray-color);
          font-size: 0.9rem;
          font-weight: 500;
          text-transform: capitalize;
        }
        
        ul.highlights > li.item > .icon > svg {
          height: 15px;
          width: 15px;
        }

        ul.highlights > li.item > .icon.increase {
          background: var(--accent-linear);
          color: var(--white-color);
        }

        ul.highlights > li.item > .icon.decrease {
          background: var(--error-linear);
          color: var(--white-color);
        }
        
        ul.highlights > li.item > .link {
          color: var(--text-color);
          font-family: var(--font-main), sans-serif;
          font-size: 1rem;
          font-weight: 400;
          text-decoration: none;
        }
        
        ul.highlights > li.item > a.link:hover {
          color: var(--text-color);
        }
        
        ul.highlights > li.item > .link .numbers {
          color: var(--text-color);
          font-weight: 500;
          font-family: var(--font-main), sans-serif;
          font-size: 0.95rem;
          display: inline-block;
          margin: 0 0 -2px 0;
        }
        
        ul.highlights > li.item.last {
          background-color: var(--gray-background);
          padding: 10px;
          margin: 5px 0;
          border-radius: 12px;
          -webkit-border-radius: 12px;
        }

        @media screen and ( max-width: 850px ){
          #content {
            width: 90%;
          }
        }

        @media screen and ( max-width: 600px ) {

          :host {
            border: none;
            background-color: var(--modal-background);
            padding: 0px;
            justify-self: end;
            display: flex;
            flex-flow: column;
            align-items: center;
            justify-content: end;
            gap: 10px;
            z-index: 20;
            position: fixed;
            right: 0;
            top: 0;
            bottom: 0;
            left: 0;
          }

          #content {
            box-sizing: border-box !important;
            padding: 5px 0 0 0;
            margin: 0;
            width: 100%;
            max-width: 100%;
            max-height: 90%;
            min-height: max-content;
            border-radius: 0px;
            border-top: var(--mobile-border);
            border-top-right-radius: 15px;
            border-top-left-radius: 15px;
          }

          .welcome {
            width: 100%;
            padding: 0 15px 20px;
            display: flex;
            flex-flow: column;
            align-items: center;
            justify-content: center;
          }

          .welcome > h2 {
            width: 100%;
            font-size: 1.2rem;
            margin: 0 0 10px;
            padding: 10px 10px;
            background-color: var(--gray-background);
            text-align: center;
            border-radius: 12px;
          }

          .welcome > .actions {
            width: 100%;
          }

          .welcome > .actions .action {
            background: var(--stage-no-linear);
            text-decoration: none;
            padding: 7px 20px 8px;
            cursor: default;
            margin: 10px 0;
            width: 120px;
            cursor: default !important;
            border-radius: 12px;
          }

          .welcome > h2 > span.control,
          .welcome > .actions > .action {
            cursor: default !important;
          }
        }
      </style>
    `;
    }
  }

  class ViewsPopup extends HTMLElement {
    constructor() {

      // We are not even going to touch this.
      super();

      // let's create our shadow root
      this.shadowObj = this.attachShadow({mode: 'open'});

      this.render();
    }

    render() {
      this.shadowObj.innerHTML = this.getTemplate();
    }

    connectedCallback() {
      
      this.disableScroll();

      // Select the close button & overlay
      const overlay = this.shadowObj.querySelector('.overlay');
      const btns = this.shadowObj.querySelectorAll('.cancel-btn');
      const contentContainer = this.shadowObj.querySelector('ul.highlights');

      // Close the modal
      if (overlay && btns && contentContainer) {
        this.closePopup(overlay, btns);
        this.fetchTopics(contentContainer);
      }
    }

    fetchTopics = (contentContainer) => {
      const outerThis = this;
  		const statsLoader = this.shadowObj.querySelector('.loader-container');
  		setTimeout(() => {
        const content = outerThis.getHighlights();
          // remove the loader
          statsLoader.remove();
          // insert the content
          contentContainer.insertAdjacentHTML('beforeend', content);
  		}, 1000);
  	}

    convertToBool = str => {
      switch (str) {
        case 'true':
          return true;
        case 'false':
          return false;
        default:
          return false;
      }
    }

    formatNumber = n => {
      if (n >= 0 && n <= 999) {
        return n.toString();
      } else if (n >= 1000 && n <= 9999) {
        const value = (n / 1000).toFixed(2);
        return `${value}k`;
      } else if (n >= 10000 && n <= 99999) {
        const value = (n / 1000).toFixed(1);
        return `${value}k`;
      } else if (n >= 100000 && n <= 999999) {
        const value = (n / 1000).toFixed(0);
        return `${value}k`;
      } else if (n >= 1000000 && n <= 9999999) {
        const value = (n / 1000000).toFixed(2);
        return `${value}M`;
      } else if (n >= 10000000 && n <= 99999999) {
        const value = (n / 1000000).toFixed(1);
        return `${value}M`;
      } else if (n >= 100000000 && n <= 999999999) {
        const value = (n / 1000000).toFixed(0);
        return `${value}M`;
      } else if (n >= 1000000000) {
        return "1B+";
      }
      else {
        return 0;
      }
    }

    parseToNumber = num_str => {
      // Try parsing the string to an integer
      const num = parseInt(num_str);

      // Check if parsing was successful
      if (!isNaN(num)) {
        return num;
      } else {
        return 0;
      }
    }

    disconnectedCallback() {
      this.enableScroll();
    }

    disableScroll() {
      // Get the current page scroll position
      let scrollTop = window.scrollY || document.documentElement.scrollTop;
      let scrollLeft = window.scrollX || document.documentElement.scrollLeft;
      document.body.classList.add("stop-scrolling");

      // if any scroll is attempted, set this to the previous value
      window.onscroll = function() {
        window.scrollTo(scrollLeft, scrollTop);
      };
    }

    enableScroll() {
      document.body.classList.remove("stop-scrolling");
      window.onscroll = function() {};
    }

    // close the modal
    closePopup = (overlay, btns) => {
      overlay.addEventListener('click', e => {
        e.preventDefault();
        this.remove();
      });

      btns.forEach(btn => {
        btn.addEventListener('click', e => {
          e.preventDefault();
          this.remove();
        });
      });
    }

    getTemplate() {
      // Show HTML Here
      return `
      <div class="overlay"></div>
      <section id="content" class="content">
        ${this.getWelcome()}
      </section>
    ${this.getStyles()}`
    }

    getWelcome() {
      return /*html*/`
      <div class="welcome">
				<ul class="highlights">
          ${this.getLoader()}
        </ul>
			</div>
    `
    }

    getHighlights = () => {
      // Get the number of followers, views, stories and topics
      const likes = this.parseToNumber(this.getAttribute('likes'));
      const you = this.convertToBool(this.getAttribute('liked'));
      const views = this.parseToNumber(this.getAttribute('views'));
      const replies = this.parseToNumber(this.getAttribute('replies'));

      // format the number of followers, views, stories and topics
      const likesFormatted = this.formatNumber(likes);
      const viewsFormatted = this.formatNumber(views);

      // construct you text
      let youText = you ? 'You and ' : '';

      let textContent = `${youText}<span class="numbers">${this.formatNumber(likes - 1)}</span> other ${likes - 1 === 1 ? 'person' : 'people'} likes this`;
      
      if(you && likes === 1) {
        textContent = `You like this content`;
      }
      else if (!you) {
        textContent = `<span class="numbers">${likesFormatted}</span> ${likes === 1 ? 'person' : 'people'} likes this content`;
      }


      return /* html */`
      <li class="item">
        <span class="icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" fill="currentColor">
            <path d="m8 14.25.345.666a.75.75 0 0 1-.69 0l-.008-.004-.018-.01a7.152 7.152 0 0 1-.31-.17 22.055 22.055 0 0 1-3.434-2.414C2.045 10.731 0 8.35 0 5.5 0 2.836 2.086 1 4.25 1 5.797 1 7.153 1.802 8 3.02 8.847 1.802 10.203 1 11.75 1 13.914 1 16 2.836 16 5.5c0 2.85-2.045 5.231-3.885 6.818a22.066 22.066 0 0 1-3.744 2.584l-.018.01-.006.003h-.002ZM4.25 2.5c-1.336 0-2.75 1.164-2.75 3 0 2.15 1.58 4.144 3.365 5.682A20.58 20.58 0 0 0 8 13.393a20.58 20.58 0 0 0 3.135-2.211C12.92 9.644 14.5 7.65 14.5 5.5c0-1.836-1.414-3-2.75-3-1.373 0-2.609.986-3.029 2.456a.749.749 0 0 1-1.442 0C6.859 3.486 5.623 2.5 4.25 2.5Z"></path>
          </svg>
        </span>
        <span class="link">
          ${textContent}
        </span>
      </li>
      <li class="item">
        <span class="icon increase">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" fill="currentColor">
            <path d="M4.53 4.75A.75.75 0 0 1 5.28 4h6.01a.75.75 0 0 1 .75.75v6.01a.75.75 0 0 1-1.5 0v-4.2l-5.26 5.261a.749.749 0 0 1-1.275-.326.749.749 0 0 1 .215-.734L9.48 5.5h-4.2a.75.75 0 0 1-.75-.75Z"></path>
          </svg>
        </span>
        <span class="link">
          This content has <span class="numbers" id="views">${viewsFormatted}</span> total ${views === 1 ? 'view' : 'views'}
        </span>
      </li>
      <li class="item">
        <span class="icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" fill="currentColor">
            <path d="M6.78 1.97a.75.75 0 0 1 0 1.06L3.81 6h6.44A4.75 4.75 0 0 1 15 10.75v2.5a.75.75 0 0 1-1.5 0v-2.5a3.25 3.25 0 0 0-3.25-3.25H3.81l2.97 2.97a.749.749 0 0 1-.326 1.275.749.749 0 0 1-.734-.215L1.47 7.28a.75.75 0 0 1 0-1.06l4.25-4.25a.75.75 0 0 1 1.06 0Z"></path>
          </svg>
        </span>
        <span class="link">
          This content has <span class="numbers" id="replies">${replies === 0 ? 'no' : replies}</span> repl${replies === 1 ? 'y' : 'ies'} so far
        </span>
      </li>
      <div class="empty">
        <p> 
          Views are simply the number of times the this content has been viewed by others.
        </p>
      </div>
    `
    }

    getLoader() {
      return /* html */`
      <div class="loader-container">
        <span id="btn-loader">
          <span class="loader-alt"></span>
        </span>
      </div>
    `
    }

    getStyles() {
      return /*css*/`
      <style>
        * {
          box-sizing: border-box !important;
        }

        :host{
          border: none;
          padding: 0;
          justify-self: end;
          display: flex;
          flex-flow: column;
          align-items: center;
          justify-content: center;
          gap: 10px;
          z-index: 100;
          width: 100%;
          min-width: 100vw;
          position: fixed;
          right: 0;
          top: 0;
          bottom: 0;
          left: 0;
        }

        div.overlay {
          position: absolute;
          top: 0;
          right: 0;
          bottom: 0;
          left: 0;
          height: 100%;
          width: 100%;
          background-color: var(--modal-background);
          backdrop-filter: blur(3px);
          -webkit-backdrop-filter: blur(3px);
        }

        div.loader-container {
          position: relative;
          width: 100%;
          height: 150px;
          padding: 20px 0 0 0;
        }

        #btn-loader {
          position: absolute;
          top: 0;
          left: 0;
          bottom: 0;
          right: 0;
          z-index: 5;
          display: flex;
          align-items: center;
          justify-content: center;
          border-radius: inherit;
        }

        #btn-loader > .loader-alt {
          width: 35px;
          aspect-ratio: 1;
          --_g: no-repeat radial-gradient(farthest-side, #18A565 94%, #0000);
          --_g1: no-repeat radial-gradient(farthest-side, #21D029 94%, #0000);
          --_g2: no-repeat radial-gradient(farthest-side, #df791a 94%, #0000);
          --_g3: no-repeat radial-gradient(farthest-side, #f09c4e 94%, #0000);
          background:    var(--_g) 0 0,    var(--_g1) 100% 0,    var(--_g2) 100% 100%,    var(--_g3) 0 100%;
          background-size: 30% 30%;
          animation: l38 .9s infinite ease-in-out;
          -webkit-animation: l38 .9s infinite ease-in-out;
        }

        #btn-loader > .loader {
          width: 20px;
          aspect-ratio: 1;
          --_g: no-repeat radial-gradient(farthest-side, #ffffff 94%, #0000);
          --_g1: no-repeat radial-gradient(farthest-side, #ffffff 94%, #0000);
          --_g2: no-repeat radial-gradient(farthest-side, #df791a 94%, #0000);
          --_g3: no-repeat radial-gradient(farthest-side, #f09c4e 94%, #0000);
          background:    var(--_g) 0 0,    var(--_g1) 100% 0,    var(--_g2) 100% 100%,    var(--_g3) 0 100%;
          background-size: 30% 30%;
          animation: l38 .9s infinite ease-in-out;
          -webkit-animation: l38 .9s infinite ease-in-out;
        }

        @keyframes l38 {
          100% {
            background-position: 100% 0, 100% 100%, 0 100%, 0 0
          }
        }

        #content {
          z-index: 1;
          background-color: var(--background);
          padding: 20px 10px;
          display: flex;
          flex-flow: column;
          align-items: center;
          justify-content: center;
          gap: 0;
          width: 700px;
          max-height: 90%;
          height: max-content;
          border-radius: 25px;
          position: relative;
        }
  
        .welcome {
          width: 98%;
          display: flex;
          flex-flow: column;
          align-items: center;
          justify-content: center;
          row-gap: 0;
        }

        .welcome > h2 {
          width: 100%;
          font-size: 1.35rem;
          font-weight: 600;
          margin: 0 0 10px;
          padding: 10px 10px;
          background-color: var(--gray-background);
          text-align: center;
          border-radius: 12px;
          font-family: var(--font-read), sans-serif;
          color: var(--text-color);
          font-weight: 500;
          position: relative;
        }

        .welcome > h2 > span.control {
          padding: 0;
          cursor: pointer;
          display: flex;
          flex-flow: column;
          gap: 0px;
          justify-content: center;
          position: absolute;
          top: 50%;
          left: 10px;
          transform: translateY(-50%);
        }

        .welcome > h2 > span.control svg {
          width: 20px;
          height: 20px;
          color: var(--text-color);
        }

        .welcome > h2 > span.control svg:hover{
          color: var(--error-color);
        }

        div.empty {
          width: 100%;
          padding: 0;
          margin: 0;
          display: flex;
          flex-flow: column;
          gap: 8px;
        }

        div.empty > p {
          width: 100%;
          padding: 0;
          margin: 0;
          color: var(--text-color);
          font-family: var(--font-text), sans-serif;
          font-size: 1rem;
          font-weight: 400;
        }

        div.empty > p.italics {
          font-style: italic;
        }
        
        ul.highlights {
          width: 100%;
          padding: 0;
          margin: 0;
          list-style-type: none;
          display: flex;
          flex-flow: column;
          gap: 10px;
        }
        
        ul.highlights > li.item {
          padding: 0;
          margin: 0;
          width: 100%;
          display: flex;
          flex-flow: row;
          align-items: center;
          flex-wrap: nowrap;
          gap: 10px;
        }
        
        ul.highlights > li.item > .icon {
          display: flex;
          align-items: center;
          justify-content: center;
          height: 26px;
          width: 26px;
          min-height: 26px;
          min-width: 26px;
          max-height: 26px;
          max-width: 26px;
          padding: 3px;
          border-radius: 50px;
          -webkit-border-radius: 50px;
          -moz-border-radius: 50px;
          background-color: var(--gray-background);
          color: var(--gray-color);
          font-size: 0.9rem;
          font-weight: 500;
          text-transform: capitalize;
        }
        
        ul.highlights > li.item > .icon > svg {
          height: 15px;
          width: 15px;
        }

        ul.highlights > li.item > .icon.increase {
          background: var(--accent-linear);
          color: var(--white-color);
        }

        ul.highlights > li.item > .icon.decrease {
          background: var(--error-linear);
          color: var(--white-color);
        }
        
        ul.highlights > li.item > .link {
          color: var(--text-color);
          font-family: var(--font-main), sans-serif;
          font-size: 1rem;
          font-weight: 400;
          text-decoration: none;
        }
        
        ul.highlights > li.item > a.link:hover {
          color: var(--text-color);
        }
        
        ul.highlights > li.item > .link .numbers {
          color: var(--highlight-color);
          font-weight: 600;
          font-family: var(--font-main), sans-serif;
          font-size: 0.95rem;
          display: inline-block;
          margin: 0 0 -2px 0;
        }
        
        ul.highlights > li.item.last {
          background-color: var(--gray-background);
          padding: 10px;
          margin: 5px 0;
          border-radius: 12px;
          -webkit-border-radius: 12px;
        }

        @media screen and ( max-width: 850px ){
          #content {
            width: 90%;
          }
        }

        @media screen and ( max-width: 600px ){
          :host {
            border: none;
            background-color: var(--modal-background);
            padding: 0px;
            justify-self: end;
            display: flex;
            flex-flow: column;
            align-items: center;
            justify-content: end;
            gap: 10px;
            z-index: 20;
            position: fixed;
            right: 0;
            top: 0;
            bottom: 0;
            left: 0;
          }

          #content {
            box-sizing: border-box !important;
            padding: 5px 0 0 0;
            margin: 0;
            width: 100%;
            max-width: 100%;
            max-height: 90%;
            min-height: max-content;
            border-radius: 0px;
            border-top: var(--mobile-border);
            border-top-right-radius: 15px;
            border-top-left-radius: 15px;
          }

          .welcome {
            width: 100%;
            padding: 0 15px 20px;
            display: flex;
            flex-flow: column;
            align-items: center;
            justify-content: center;
          }

          .welcome > h2 {
            width: 100%;
            font-size: 1.2rem;
            margin: 0 0 10px;
            padding: 10px 10px;
            background-color: var(--gray-background);
            text-align: center;
            border-radius: 12px;
          }

          .welcome > .actions {
            width: 100%;
          }

          .welcome > .actions .action {
            background: var(--stage-no-linear);
            text-decoration: none;
            padding: 7px 20px 8px;
            cursor: default;
            margin: 10px 0;
            width: 120px;
            cursor: default !important;
            border-radius: 12px;
          }

          div.empty {
            width: 100%;
            padding: 0;
            margin: 0;
            display: flex;
            flex-flow: column;
            align-items: center;
            justify-content: center;
            gap: 8px;
          }
  
          div.empty > p {
            width: 100%;
            padding: 0;
            margin: 0;
            text-align: start;
            color: var(--text-color);
            font-family: var(--font-text), sans-serif;
            font-size: 1rem;
            font-weight: 400;
          }

          .welcome > h2 > span.control,
          .welcome > .actions > .action {
            cursor: default !important;
          }
        }
      </style>
    `;
    }
  }

  class PreviewPopup extends HTMLElement {
    constructor() {
      // We are not even going to touch this.
      super();

      this._url = this.getAttribute('url');

      this._story = '';

      // let's create our shadow root
      this.shadowObj = this.attachShadow({mode: 'open'});

      this.render();
    }

    render() {
      this.shadowObj.innerHTML = this.getTemplate();
    }

    connectedCallback() {
      this.disableScroll();

      // Select the close button & overlay
      const overlay = this.shadowObj.querySelector('.overlay');
      const btns = this.shadowObj.querySelectorAll('.cancel-btn');
      const contentContainer = this.shadowObj.querySelector('div.preview');

      // Close the modal
      if (overlay && btns && contentContainer) {
        this.fetchPreview(contentContainer);
        this.closePopup(overlay, btns);
      }
    }

    fetchPreview = (contentContainer) => {
      const outerThis = this;
  		const previewLoader = this.shadowObj.querySelector('.loader-container');
  		setTimeout(() => {
        // fetch the user stats
        const options = {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          }
        };
    
        this.fetchWithTimeout(this._url, options)
          .then(response => {
            return response.json();
          })
          .then(result => {
            // check for success response
            if (result.success) {
              if(result.reply) {
                const reply = result.reply;
                outerThis._story = outerThis.mapReply(reply);
                const replyContent = outerThis.populateReply(reply);
                // remove the loader
                previewLoader.remove();
                // insert the content
                contentContainer.insertAdjacentHTML('beforeend', replyContent);

                // open the story
                this.openStory();

                // open the read more
                this.openReadMore();
                // open the url
                this.openUrl();
                // style lastBlock
                this.styleLastBlock();
              }
              else if (result.story){
                const story = result.story;
                outerThis._story = outerThis.mapStory(story);
                // remove the loader
                previewLoader.remove();

                // switch between the different kind of story
                if (story.kind === 'post') {
                  const postContent = outerThis.populatePost(story);
                  contentContainer.insertAdjacentHTML('beforeend', postContent);
                } else if (story.kind === 'poll') {
                  const pollContent = outerThis.populatePoll(story);
                  contentContainer.insertAdjacentHTML('beforeend', pollContent);
                } else if (story.kind === 'story') {
                  const storyContent = outerThis.populateStory(story);
                  contentContainer.insertAdjacentHTML('beforeend', storyContent);
                }

                this.openStory();

                // open the read more
                this.openReadMore();
                // open the url
                this.openUrl();
                // style lastBlock
                this.styleLastBlock();
              }
              else if (result.user){
                const user = result.user;
                const bio = user.bio === null ? 'This user has not added a bio yet.' : user.bio;
                const userContent = outerThis.removeHtml(bio, user.name);
                outerThis._story = outerThis.mapUser(user);
                const content = outerThis.getUserContent(userContent, `/u/${user.hash.toLowerCase()}`, user.hash, user.followers, user.following);

                // remove the loader
                previewLoader.remove();

                // insert the content
                contentContainer.insertAdjacentHTML('beforeend', content);

                // open the story
                this.openStory();

                // open the read more
                this.openReadMore();
                // open the url
                this.openUrl();
                // style lastBlock
                this.styleLastBlock();
              }
              else if (result.topic){
                const topic = result.topic;
                const topicContent = outerThis.removeHtml(topic.summary, topic.name);
                outerThis._story = outerThis.mapTopic(topic);
                const content = outerThis.getTopicContent(topicContent, `/t/${topic.hash.toLowerCase()}`, topic.author, topic.followers);

                // remove the loader
                previewLoader.remove();

                // insert the content
                contentContainer.insertAdjacentHTML('beforeend', content);

                // open the story
                this.openStory();

                // open the read more
                this.openReadMore();
                // open the url
                this.openUrl();
                // style lastBlock
                this.styleLastBlock();
              }

              else {
                // display error message
                const content = outerThis.getEmpty();
                previewLoader.remove();
                contentContainer.insertAdjacentHTML('beforeend', content);
              }
            }
            else {
              // display error message
              const content = outerThis.getEmpty();
              previewLoader.remove();
              contentContainer.insertAdjacentHTML('beforeend', content);
            }
          })
          .catch(error => {
            // display error message
            const content = outerThis.getEmpty();
            previewLoader.remove();
            contentContainer.insertAdjacentHTML('beforeend', content);
          });
  		}, 2000);
  	}

    fetchWithTimeout = async (url, options = {}, timeout = 9500) => {
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), timeout);
    
      try {
        const response = await fetch(url, {
          ...options,
          signal: controller.signal
        });

        return response;
      } catch (error) {
        if (error.name === 'AbortError') {
          throw new Error('Request timed out');
        }
        throw new Error(`Network error: ${error.message}`);
      } finally {
        clearTimeout(timeoutId);
      }
    }

    populateStory = story => {
      const author = story.story_author;
      author.you = story.you;
      author.time = story.createdAt;
      const url = `/p/${story.hash.toLowerCase()}`;
      const itemContent = this.getStory(story.content, story.title, story.images);
      return this.getContent(itemContent, url, story.author, story.views, story.likes);
    }

    populateReply = reply => {
      const author = reply.reply_author;
      author.you = reply.you;
      author.time = reply.createdAt;
      const url = `/r/${reply.hash.toLowerCase()}`;
      const itemContent = this.getPost(reply.content, reply.images);
      return this.getContent(itemContent, url, reply.author, reply.views, reply.likes);
    }

    populatePost = story => {
      const author = story.story_author;
      author.you = story.you;
      author.time = story.createdAt;
      const url = `/p/${story.hash.toLowerCase()}`;
      const itemContent = this.getPost(story.content, story.images);
      return this.getContent(itemContent, url, story.author, story.views, story.likes);
    }

    populatePoll = story => {
      const author =story.story_author;
      author.you = story.you;
      author.time = story.createdAt;
      const poll = { 
        hash: story.hash,
        votes: story.votes,
        selected: story.option,
        end: story.end,
        voted: story.option ? 'true' : 'false',
        options: story.poll,
        content: story.content
      };
      const pollContent = this.getPoll(poll);
      const url =`/p/${story.hash.toLowerCase()}`;
      return this.getContent(pollContent, url, story.author, story.views, story.likes);
    }

    getPoll = poll =>  {
      const mql = window.matchMedia('(max-width: 660px)');
      // Remove html tags
      const contentStr = poll.content.replace(/<[^>]*>/g, '');
      const contentLength = contentStr.length;

      let chars = 250;

      // Check if its a mobile view
      if (mql.matches) {
        chars = 200;
      }

      // Check if content length is greater than :chars
      if (contentLength > chars) {
        return /*html*/`
        <div class="post extra ${chars <= 200 ? 'mobile' : ''}" id="post">
          ${poll.content}
          <div class="read-more">
            <span class="action">view more</span>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" fill="currentColor">
              <path d="M12.78 5.22a.749.749 0 0 1 0 1.06l-4.25 4.25a.749.749 0 0 1-1.06 0L3.22 6.28a.749.749 0 1 1 1.06-1.06L8 8.939l3.72-3.719a.749.749 0 0 1 1.06 0Z"></path>
            </svg>
          </div>
        </div>
        <votes-wrapper reload="false" votes="${poll.votes}" selected="${poll.selected}"
          hash="${poll.hash}"
          end-time="${poll.end}" voted="${poll.voted}" options="${poll.options}">
        </votes-wrapper>
      `
      }
      else {
        return /*html*/`
        <div class="post" id="post">
          ${poll.content}
        </div>
        <votes-wrapper reload="false" votes="${poll.votes}" selected="${poll.selected}"
          hash="${poll.hash}"
          end-time="${poll.end}" voted="${poll.voted}" options="${poll.options}">
        </votes-wrapper>
      `
      }
    }

    getStory = (text, title, images)=> {
      let str = this.getHTML();
      str = text.replace(/<[^>]*>/g, '');

      str = str.trim();
      const filteredTitle = title ? `<h3>${title}</h3>` : '';
      const content = `<p>${this.trimContent(str)}</p>`;

      return /*html*/`
      <div class="post" id="post">
        ${filteredTitle}
        ${content}
      </div>
      ${this.getImages(images)}
    `
    }

    removeHtml = (text, title)=> {
      let str = this.getHTML();
      str = text.replace(/<[^>]*>/g, '');
      

      str = str.trim();
      const filteredTitle = title ? `<h3>${title}</h3>` : '';
      const content = `<p>${this.trimContent(str)}</p>`;


      return `
      ${filteredTitle}
      ${content}
    `
    }

    trimContent = text => {
      // if text is less than 150 characters
      if (text.length <= 200) return text;

      // check for mobile view
      const mql = window.matchMedia('(max-width: 660px)');

      // Check if its a mobile view
      if (mql.matches) {
        // return text substring: 150 characters + ...
        return text.substring(0, 200) + '...';
      } else {
        // trim the text to 250 characters
        return text.substring(0, 300) + '...';
      }
    }

    getPost = (content, images) => {
      const mql = window.matchMedia('(max-width: 660px)');
      // Remove html tags
      const contentStr = content.replace(/<[^>]*>/g, '');
      const contentLength = contentStr.length;

      let chars = 250;

      // Check if its a mobile view
      if (mql.matches) {
        chars = 200;
      }

      // Check if content length is greater than: chars
      if (contentLength > chars) {
        return /*html*/`
        <div class="post extra ${chars <= 200 ? 'feed' : ''}" id="post">
          ${content}
          <div class="read-more">
            <span class="action">view more</span>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" fill="currentColor">
              <path d="M12.78 5.22a.749.749 0 0 1 0 1.06l-4.25 4.25a.749.749 0 0 1-1.06 0L3.22 6.28a.749.749 0 1 1 1.06-1.06L8 8.939l3.72-3.719a.749.749 0 0 1 1.06 0Z"></path>
            </svg>
          </div>
        </div>
        ${this.getImages(images)}
      `
      }
      else {
        return /*html*/`
        <div class="post" id="post">
          ${content}
        </div>
        ${this.getImages(images)}
      `
      }
    }

    getHTML = () => {
      const text = this.innerHTML;
      const parser = new DOMParser();
      const doc = parser.parseFromString(text, 'text/html');
      return doc.body.innerHTML;
    }

    openReadMore = () => {
      // Get the read more button
      const readMore = this.shadowObj.querySelector('.post .read-more');

      // Get the content
      const content = this.shadowObj.querySelector('.post');

      // Check if the read more button exists
      if (readMore && content) {
        readMore.addEventListener('click', e => {
          // prevent the default action
          e.preventDefault();

          // prevent the propagation of the event
          e.stopPropagation();

          // Prevent event from reaching any immediate nodes.
          e.stopImmediatePropagation();

          // Toggle the active class
          content.classList.remove('extra');

          // remove the read more button
          readMore.remove();
        });
      }
    }

    openUrl = () => {
      // get all the links
      const links = this.shadowObj.querySelectorAll('div#post a');
      const body = document.querySelector('body');

      // loop through the links
      if (!links) return;

      links.forEach(link => {
        // add event listener to the link
        link.addEventListener('click', event => {
          event.preventDefault();
          event.stopPropagation();
          event.stopImmediatePropagation();
          // get the url
          const url = link.getAttribute('href');

          // link pop up
          let linkPopUp = `<url-popup url="${url}"></url-popup>`;

          // open the popup
          body.insertAdjacentHTML('beforeend', linkPopUp);
        });
      });
    }

    openStory = () => {
      // Get the body
      const body = document.querySelector('body');

      // get current content
      const content = this.shadowObj.querySelector('.actions > .action#view-action');

      if(body && content) {
        content.addEventListener('click', event => {
          event.preventDefault();

          let url = content.getAttribute('href');

          // Get full post
          const post =  this._story;
    
          // replace and push states
          this.replaceAndPushStates(url, body, post);

          body.innerHTML = post;
        });
      }
    }

    // Replace and push states
    replaceAndPushStates = (url, body, post) => {
      // get the first custom element in the body
      const firstElement = body.firstElementChild;

      // convert the custom element to a string
      const elementString = firstElement.outerHTML;

      // Replace the content with the current url and body content
      // get window location
      const pageUrl = window.location.href;
      window.history.replaceState(
        { page: 'page', content: elementString },
        url, pageUrl
      );

      // Updating History State
      window.history.pushState(
        { page: 'page', content: post},
        url, url
      );
    }

    mapStory = story => {
      const author = story.story_author;
      const url = `/p/${story.hash.toLowerCase()}`;
      const images = story.images ? story.images.join(',') : '';
      if (story.kind === "post") {
        return /*html*/`
        <app-post story="quick" tab="replies" url="${url}" hash="${story.hash}" likes="${story.likes}" replies="${story.replies}" 
          replies-url="/api/v1${url}/replies" likes-url="/api/v1${url}/likes" images='${images}'
          views="${story.views}"  time="${story.createdAt}" liked="${story.liked ? 'true' : 'false'}" 
          author-url="/u/${author.hash}" author-stories="${author.stories}" author-replies="${author.replies}"
          author-hash="${author.hash}" author-you="${story.you ? 'true' : 'false'}" author-img="${author.picture}" 
          author-verified="${author.verified ? 'true' : 'false'}" author-name="${author.name}" author-followers="${author.followers}" 
          author-following="${author.following}" author-follow="${author.is_following ? 'true' : 'false'}" author-contact='${author.contact ? JSON.stringify(author.contact) : null}'
          author-bio="${author.bio === null ? 'This user has not added a bio yet.' : author.bio}">
          ${story.content}
        </app-post>
      `
      }
      else if (story.kind === "poll") {
        return /*html*/`
        <app-post story="poll" tab="replies" url="${url}" hash="${story.hash}" likes="${story.likes}"
          replies="${story.replies}" liked="${story.liked ? 'true' : 'false'}" views="${story.views}" time="${story.createdAt}"
          replies-url="/api/v1${url}/replies" likes-url="/api/v1${url}/likes" options='${story.poll}' voted="${story.option ? 'true' : 'false'}" 
          selected="${story.option}" end-time="${story.end}" votes="${story.votes}" 
          author-url="/u/${author.hash}" author-stories="${author.stories}" author-replies="${author.replies}"
          author-hash="${author.hash}" author-you="${story.you ? 'true' : 'false'}" author-img="${author.picture}" 
          author-verified="${author.verified ? 'true' : 'false'}" author-name="${author.name}" author-followers="${author.followers}" 
          author-following="${author.following}" author-follow="${author.is_following ? 'true' : 'false'}" author-contact='${author.contact ? JSON.stringify(author.contact) : null}' 
          author-bio="${author.bio === null ? 'This user has not added a bio yet.' : author.bio}">
          ${story.content}
        </app-post>
      `
      }
      else if (story.kind === "story") {
        return /*html*/`
        <app-story story="story" hash="${story.hash}" url="${url}" tab="replies" topics="${story.topics.length === 0 ? 'story' : story.topics}" 
          story-title="${story.title}" time="${story.createdAt}" replies-url="/api/v1${url}/replies" images='${images}'
          likes-url="/api/v1${url}/likes" likes="${story.likes}" replies="${story.replies}" liked="${story.liked ? 'true' : 'false'}" views="${story.views}" 
          author-url="/u/${author.hash}" author-stories="${author.stories}" author-replies="${author.replies}"
          author-hash="${author.hash}" author-you="${story.you ? 'true' : 'false'}" author-contact='${author.contact ? JSON.stringify(author.contact) : null}' 
          author-img="${author.picture}" author-verified="${author.verified ? 'true' : 'false'}" author-name="${author.name}" 
          author-followers="${author.followers}" author-following="${author.following}" author-follow="${author.is_following ? 'true' : 'false'}" 
          author-bio="${author.bio === null ? 'This user has not added a bio yet.' : author.bio}">
          ${story.content}
        </app-story>
      `
      }
    }

    mapReply = reply => {
      const author = reply.reply_author;
      return /*html*/`
      <app-post story="reply" tab="replies" hash="${reply.hash}" url="/r/${reply.hash.toLowerCase()}" likes="${reply.likes}" liked="${reply.liked}"
        replies="${reply.replies}" views="${reply.views}" time="${reply.createdAt}" replies-url="/api/v1/r/${reply.hash}/replies" 
        parent="${reply.story ? reply.story : reply.reply}" preview="full" likes-url="/api/v1/r/${reply.hash}/likes" 
        author-url="/u/${author.hash}" author-hash="${author.hash}" author-you="${reply.you}" author-stories="${author.stories}" 
        author-replies="${author.replies}" author-img="${author.picture}" author-verified="${author.verified}" author-contact='${author.contact ? JSON.stringify(author.contact) : null}'
        author-name="${author.name}" author-followers="${author.followers}" author-following="${author.following}" 
        author-follow="${author.is_following}" author-bio="${author.bio === null ? 'The author has no bio yet!' : author.bio}">
        ${reply.content}
      </app-post>
    `
    }

    mapUser = user => {
      const url = `/u/${user.hash.toLowerCase()}`;
      return /*html*/`
			<app-profile tab="stories" hash="${user.hash}" you="${user.you}" url="${url}" stories="${user.stories}" replies="${user.replies}"
        picture="${user.picture}" verified="${user.verified}" name="${user.name}" followers="${user.followers}" contact='${user.contact ? JSON.stringify(user.contact) : null}'
        following="${user.following}" user-follow="${user.is_following}" bio="${user.bio === null ? 'The author has no bio yet!': user.bio }"
        followers-url="/api/v1${url}/followers" following-url="/api/v1${url}/following"
        stories-url="/api/v1${url}/stories" replies-url="/api/v1${url}/replies">
			</app-profile>
    `
    }

    mapTopic = topic => {
      const author = topic.topic_author;
      const url = `/t/${topic.hash.toLowerCase()}`;
      return /*html*/`
      <topic-wrapper hash="${topic.hash}" name="${topic.name}" slug="${topic.slug}"
        topic-follow="${topic.is_following}" subscribed="${topic.is_subscribed}" url="${url}" views="${topic.views}"
        subscribers="${topic.subscribers}" followers="${topic.followers}" stories="${topic.stories}"
        author-hash="${author.hash}" author-you="${topic.you}" author-url="/u/${author.hash}"
        author-img="${author.picture}" author-verified="${author.verified}" author-name="${author.name}" author-followers="${author.followers}"
        author-following="${author.following}" author-follow="${author.is_following}" author-contact='${author.contact ? JSON.stringify(author.contact) : null}'
        author-bio="${author.bio === null ? 'The has not added their bio yet' : author.bio}">
        ${this.topicContent(topic.summary)}
      </topic-wrapper>
    `
    }

    // style the last paragraph or the last block element in content
    styleLastBlock = () => {
      const content = this.shadowObj.querySelector('.post#post');
      if (!content) return;

      const lastBlock = content.lastElementChild;
      if (!lastBlock) return;

      // style the last block
      lastBlock.style.setProperty('padding', '0 0 0');
      lastBlock.style.setProperty('margin', '0 0 0');
    }

    topicContent = data => {
      if (data.length <= 0 || !data) {
        return /*html*/`
        <div class="empty">
          <p>The topic has no information yet.
            More information will be available once the author(s) adds more content.
          </p>
        </div>
      `;
      }
      else {
        return data
      }
    }

    formatNumber = n => {
      if (n >= 0 && n <= 999) {
        return n.toString();
      } else if (n >= 1000 && n <= 9999) {
        const value = (n / 1000).toFixed(2);
        return `${value}k`;
      } else if (n >= 10000 && n <= 99999) {
        const value = (n / 1000).toFixed(1);
        return `${value}k`;
      } else if (n >= 100000 && n <= 999999) {
        const value = (n / 1000).toFixed(0);
        return `${value}k`;
      } else if (n >= 1000000 && n <= 9999999) {
        const value = (n / 1000000).toFixed(2);
        return `${value}M`;
      } else if (n >= 10000000 && n <= 99999999) {
        const value = (n / 1000000).toFixed(1);
        return `${value}M`;
      } else if (n >= 100000000 && n <= 999999999) {
        const value = (n / 1000000).toFixed(0);
        return `${value}M`;
      } else if (n >= 1000000000) {
        return "1B+";
      }
      else {
        return 0;
      }
    }

    parseToNumber = num_str => {
      // Try parsing the string to an integer
      const num = parseInt(num_str);

      // Check if parsing was successful
      if (!isNaN(num)) {
        return num;
      } else {
        return 0;
      }
    }

    disconnectedCallback() {
      this.enableScroll();
    }

    disableScroll() {
      // Get the current page scroll position
      let scrollTop = window.scrollY || document.documentElement.scrollTop;
      let scrollLeft = window.scrollX || document.documentElement.scrollLeft;
      document.body.classList.add("stop-scrolling");

      // if any scroll is attempted, set this to the previous value
      window.onscroll = function() {
        window.scrollTo(scrollLeft, scrollTop);
      };
    }

    enableScroll() {
      document.body.classList.remove("stop-scrolling");
      window.onscroll = function() {};
    }

    // close the modal
    closePopup = (overlay, btns) => {
      overlay.addEventListener('click', e => {
        e.preventDefault();
        this.remove();
      });

      btns.forEach(btn => {
        btn.addEventListener('click', e => {
          e.preventDefault();
          this.remove();
        });
      });
    }

    getTemplate() {
      // Show HTML Here
      return /*html*/`
      <div class="overlay"></div>
      <section id="content" class="content">
        ${this.getWelcome()}
      </section>
    ${this.getStyles()}`
    }

    getWelcome() {
      return /*html*/`
      <div class="welcome">
        <div class="preview">
				  ${this.getLoader()}
        </div>
			</div>
    `
    }

    getContent = (content, url, hash, views, likes) => {
      return /*html*/`
      ${content}
      <span class="meta">
        <span class="by">by</span>
        <span class="hash">${hash}</span>
      </span>
      ${this.getActions(likes, views, url)}
    `
    }

    getUserContent = (content, url, hash, followers, following) => {
      return /*html*/`
      ${content}
      <span class="meta">
        <span class="by">@</span>
        <span class="hash">${hash}</span>
      </span>
      ${this.getUserActions(followers, following, url)}
    `
    }

    getTopicContent = (content, url, hash, followers) => {
      return /*html*/`
      ${content}
      <span class="meta">
        <span class="by">by</span>
        <span class="hash">${hash}</span>
      </span>
      ${this.getTopicActions(followers, url)}
    `
    }

    getActions = (likes, views, url) => {
      return /*html*/`
      <div class="actions">
        <a href="${url}" class="action view" id="view-action">view</a>
        <span class="action likes plain">
          <span class="no">${this.formatNumber(likes)}</span> <span class="text">likes</span>
        </span>
        <span class="action views plain">
          <span class="no">${this.formatNumber(views)}</span> <span class="text">views</span>
        </span>
      </div>
    `
    }

    getUserActions = (followers, following, url) => {
      return /*html*/`
      <div class="actions">
        <a href="${url}" class="action view" id="view-action">view</a>
        <span class="action likes plain">
          <span class="no">${this.formatNumber(followers)}</span> <span class="text">followers</span>
        </span>
        <span class="action views plain">
          <span class="no">${this.formatNumber(following)}</span> <span class="text">following</span>
        </span>
      </div>
    `
    }

    getTopicActions = (followers, url) => {
      return /*html*/`
      <div class="actions">
        <a href="${url}" class="action view" id="view-action">view</a>
        <span class="action likes plain">
          <span class="no">${this.formatNumber(followers)}</span> <span class="text">followers</span>
        </span>
      </div>
    `
    }

    getEmpty = () => {
      return /* html */`
      <div class="empty">
        <p>There was an error fetching the preview.</p>
        <p>Try refreshing the page or check your internet connection. If the problem persists, please contact support.</p>
      </div>
    `
    }

    getLoader() {
      return /* html */`
      <div class="loader-container">
        <span id="btn-loader">
          <span class="loader-alt"></span>
        </span>
      </div>
    `
    }

    getImages = imageArray => {
      // if length is greater is less than 1
      if(!imageArray || imageArray.length < 1) return '';

      // return
      return /* html */`
      <images-wrapper images="${imageArray.join(',')}"></images-wrapper>
    `
    }

    getStyles() {
      return /*css*/`
      <style>
        * {
          box-sizing: border-box !important;
        }

        :host{
          border: none;
          padding: 0;
          justify-self: end;
          display: flex;
          flex-flow: column;
          align-items: center;
          justify-content: center;
          gap: 10px;
          z-index: 100;
          width: 100%;
          min-width: 100vw;
          position: fixed;
          right: 0;
          top: 0;
          bottom: 0;
          left: 0;
        }

        div.overlay {
          position: absolute;
          top: 0;
          right: 0;
          bottom: 0;
          left: 0;
          height: 100%;
          width: 100%;
          background-color: var(--modal-background);
          backdrop-filter: blur(3px);
          -webkit-backdrop-filter: blur(3px);
        }

        div.loader-container {
          position: relative;
          width: 100%;
          height: 150px;
          padding: 20px 0 0 0;
        }

        #btn-loader {
          position: absolute;
          top: 0;
          left: 0;
          bottom: 0;
          right: 0;
          z-index: 5;
          display: flex;
          align-items: center;
          justify-content: center;
          border-radius: inherit;
        }

        #btn-loader > .loader-alt {
          width: 35px;
          aspect-ratio: 1;
          --_g: no-repeat radial-gradient(farthest-side, #18A565 94%, #0000);
          --_g1: no-repeat radial-gradient(farthest-side, #21D029 94%, #0000);
          --_g2: no-repeat radial-gradient(farthest-side, #df791a 94%, #0000);
          --_g3: no-repeat radial-gradient(farthest-side, #f09c4e 94%, #0000);
          background:    var(--_g) 0 0,    var(--_g1) 100% 0,    var(--_g2) 100% 100%,    var(--_g3) 0 100%;
          background-size: 30% 30%;
          animation: l38 .9s infinite ease-in-out;
          -webkit-animation: l38 .9s infinite ease-in-out;
        }

        #btn-loader > .loader {
          width: 20px;
          aspect-ratio: 1;
          --_g: no-repeat radial-gradient(farthest-side, #ffffff 94%, #0000);
          --_g1: no-repeat radial-gradient(farthest-side, #ffffff 94%, #0000);
          --_g2: no-repeat radial-gradient(farthest-side, #df791a 94%, #0000);
          --_g3: no-repeat radial-gradient(farthest-side, #f09c4e 94%, #0000);
          background:    var(--_g) 0 0,    var(--_g1) 100% 0,    var(--_g2) 100% 100%,    var(--_g3) 0 100%;
          background-size: 30% 30%;
          animation: l38 .9s infinite ease-in-out;
          -webkit-animation: l38 .9s infinite ease-in-out;
        }

        @keyframes l38 {
          100% {
            background-position: 100% 0, 100% 100%, 0 100%, 0 0
          }
        }

        #content {
          z-index: 1;
          background-color: var(--background);
          padding: 20px 10px;
          display: flex;
          flex-flow: column;
          align-items: center;
          justify-content: center;
          gap: 0;
          width: 700px;
          max-height: 90%;
          height: max-content;
          border-radius: 25px;
          position: relative;
        }

        .preview {
          width: 100%;
          display: flex;
          flex-flow: column;
          color: var(--text-color);
          line-height: 1.4;
          gap: 4px;
          margin: 0;
          padding: 0;
        }

        .preview p,
        .preview h3 {
          margin: 0;
          line-height: 1.2;
        }

        .preview h3 {
          margin: 0 0 5px 0;
        }

        .meta {
          height: max-content;
          display: flex;
          position: relative;
          color: var(--gray-color);
          align-items: center;
          font-family: var(--font-mono),monospace;
          gap: 5px;
          font-size: 0.9rem;
          line-height: 1.5;
        }

        .meta > span.sp {
          margin: 1px 0 0 0;
        }

        .meta > span.by {
          font-weight: 500;
          font-size: 0.93rem;
          margin: 0 0 1px 1px;
        }

        .meta > span.hash {
          background: var(--action-linear);
          font-family: var(--font-mono), monospace;
          font-size: 0.9rem;
          line-height: 1;
          color: transparent;
          font-weight: 600;
          background-clip: text;
          -webkit-background-clip: text;
          -moz-background-clip: text;
        }

        .meta > time.time {
          font-family: var(--font-text), sans-serif;
          font-size: 0.83rem;
          font-weight: 500;
          margin: 1px 0 0 0;
        }

        .preview > p {
          margin: 0 0 5px 0;
          padding: 0;
          line-height: 1.4;
          font-family: var(--font-text), sans-serif;
        }

        .welcome {
          width: 98%;
          display: flex;
          flex-flow: column;
          align-items: center;
          justify-content: center;
          row-gap: 0;
        }

        .welcome > h2 {
          width: 100%;
          font-size: 1.35rem;
          font-weight: 600;
          margin: 0 0 10px;
          padding: 10px 10px;
          background-color: var(--gray-background);
          text-align: center;
          border-radius: 12px;
          font-family: var(--font-read), sans-serif;
          color: var(--text-color);
          font-weight: 500;
          position: relative;
        }

        .welcome > h2 > span.control {
          padding: 0;
          cursor: pointer;
          display: flex;
          flex-flow: column;
          gap: 0px;
          justify-content: center;
          position: absolute;
          top: 50%;
          left: 10px;
          transform: translateY(-50%);
        }

        .welcome > h2 > span.control svg {
          width: 20px;
          height: 20px;
          color: var(--text-color);
        }

        .welcome > h2 > span.control svg:hover{
          color: var(--error-color);
        }

        .post {
          width: 100%;
          display: flex;
          cursor: pointer;
          flex-flow: column;
          color: var(--text-color);
          font-family: var(--font-main), sans-serif;
          line-height: 1.4;
          gap: 0;
          margin: 0;
          padding: 0;
        }

        .post.extra {
          max-height: 200px;
          overflow: hidden;
          position: relative;
        }

        .post.extra.mobile {
          max-height: 120px;
        }

        .post.extra.feed {
          max-height: 150px;
        }

        .post.extra .read-more {
          position: absolute;
          bottom: -5px;
          right: 0;
          left: 0;
          width: 100%;
          padding: 5px 0;
          display: flex;
          align-items: end;
          justify-content: center;
          min-height: 80px;
          gap: 3px;
          cursor: pointer;
          font-weight: 500;
          font-family: var(--font-main), sans-serif;
          color: var(--gray-color);
          background: var(--fade-linear-gradient);
        }

        .post.extra .read-more svg {
          display: inline-block;
          width: 16px;
          height: 16px;
          margin: 0 0 2px 0;
        }

        .post h6,
        .post h5,
        .post h4,
        .post h3,
        .post h1 {
          padding: 0;
          font-size: 1.3rem !important;
          color: var(--title-color);
          font-weight: 500;
          line-height: 1.5;
          margin: 5px 0;
        }

        .post p {
          font-size: 1rem;
          margin: 0 0 5px 0;
          line-height: 1.4;
        }

        .post a {
          text-decoration: none;
          cursor: pointer;
          color: var(--anchor-color) !important;
        }

        .post a:hover {
          text-decoration: underline;
        }

        .post blockquote {
          margin: 0;
          padding: 0 0 5px;
          font-style: italic;
          background: var(--background);
          color: var(--text-color);
          font-weight: 400;
          line-height: 1.4;
        }

        .post blockquote p {
          margin: 0;
        }

        .post blockquote * {
          margin: 0;
        }

        .post hr {
          border: none;
          background-color: var(--text-color);
          height: 1px;
          margin: 10px 0;
        }

        .post code {
          background: var(--gray-background);
          padding: 0 5px;
          font-family: var(--font-mono);
          font-size: 0.9rem;
          border-radius: 5px;
        }

        .post b,
        .post strong {
          font-weight: 700;
          line-height: 1.4;

        }

        .post ul,
        .post ol {
          margin: 0 0 15px 20px;
          padding: 0 0 0 15px;
          color: inherit;
          line-height: 1.4;
        }

        .post ul li,
        .post ol li {
          margin: 6px 0;
          padding: 0;
          color: inherit;
        }

        div.empty {
          width: 100%;
          padding: 0;
          margin: 0;
          display: flex;
          flex-flow: column;
          gap: 8px;
        }

        div.empty > p {
          width: 100%;
          padding: 0;
          margin: 0;
          color: var(--text-color);
          font-family: var(--font-text), sans-serif;
          font-size: 1rem;
          font-weight: 400;
        }
        
        .actions {
          display: flex;
          font-family: var(--font-main), sans-serif;
          width: 100%;
          flex-flow: row;
          align-items: center;
          gap: 20px;
          margin: 10px 0 0;
        }
        
        .actions > .action {
          background: var(--gray-background);
          text-decoration: none;
          color: var(--text-color);
          font-size: 0.95rem;
          display: flex;
          width: max-content;
          flex-flow: row;
          align-items: center;
          text-transform: lowercase;
          justify-content: center;
          padding: 3px 15px 4px;
          border-radius: 12px;
          -webkit-border-radius: 12px;
          -moz-border-radius: 12px;
        }

        .actions > .action.plain {
          padding: 0;
          font-size: 1rem;
          pointer-events: none;
          font-family: var(--font-text), sans-serif;
          color: var(--gray-color);
          border: none;
          background: none;
        }
        
        .actions > .action.plain > span.no {
          font-family: var(--font-main), sans-serif;
          font-size: 1rem;
          font-weight: 500;
          color: var(--text-color);
        }

        .actions > .action.plain > span.text {
          display: inline-block;
          padding: 0 0 0 3px;
        }
        
        @media screen and ( max-width: 850px ){
          #content {
            width: 90%;
          }
        }

        @media screen and ( max-width: 600px ){
          :host {
            border: none;
            background-color: var(--modal-background);
            padding: 0px;
            justify-self: end;
            display: flex;
            flex-flow: column;
            align-items: center;
            justify-content: end;
            gap: 10px;
            z-index: 20;
            position: fixed;
            right: 0;
            top: 0;
            bottom: 0;
            left: 0;
          }

          #content {
            box-sizing: border-box !important;
            padding: 10px 0;
            margin: 0;
            width: 100%;
            max-width: 100%;
            max-height: 100%;
            min-height: max-content;
            border-radius: 0px;
            border-top: var(--mobile-border);
            border-top-right-radius: 15px;
            border-top-left-radius: 15px;
          }

          .welcome {
            width: 100%;
            padding: 0 15px 20px;
            display: flex;
            flex-flow: column;
          }

          .welcome > h2 {
            width: 100%;
            font-size: 1.2rem;
            margin: 0 0 10px;
            padding: 10px 10px;
            background-color: var(--gray-background);
            border-radius: 12px;
          }

          .welcome > .actions {
            width: 100%;
          }

          .welcome > .actions .action {
            background: var(--stage-no-linear);
            text-decoration: none;
            padding: 7px 20px 8px;
            cursor: default;
            margin: 10px 0;
            width: 120px;
            cursor: default !important;
            border-radius: 12px;
          }

          button.fetch,
          .content.extra .read-more,
          .actions > .action.close,
          a {
            cursor: default !important;
          }

          .welcome > h2 > span.control,
          .welcome > .actions > .action {
            cursor: default !important;
          }
        }
      </style>
    `;
    }
  }

  class NotifyPopup extends HTMLElement {
    constructor() {

      // We are not even going to touch this.
      super();

      // let's create our shadow root
      this.shadowObj = this.attachShadow({mode: 'open'});

      this.render();

    }

    render() {
      this.shadowObj.innerHTML = this.getTemplate();
    }

    connectedCallback() {
      this.disableScroll();

      // Select the close button & overlay
      const overlay = this.shadowObj.querySelector('.overlay');
      const btns = this.shadowObj.querySelectorAll('.cancel-btn');

      const notifyBtn = this.shadowObj.querySelector('.notify-btn');

      // Close the modal
      if (overlay && btns) {
        this.closePopup(overlay, btns);
      }

      // Request notification permission
      if (notifyBtn) {
        this.requestNotificationPermission(notifyBtn);
      }
    }

    disconnectedCallback() {
      this.enableScroll();
    }

    disableScroll() {
      // Get the current page scroll position
      let scrollTop = window.scrollY || document.documentElement.scrollTop;
      let scrollLeft = window.scrollX || document.documentElement.scrollLeft;
      document.body.classList.add("stop-scrolling");

      // if any scroll is attempted, set this to the previous value
      window.onscroll = function() {
        window.scrollTo(scrollLeft, scrollTop);
      };
    }

    enableScroll() {
      document.body.classList.remove("stop-scrolling");
      window.onscroll = function() {};
    }

    // close the modal
    closePopup = (overlay, btns) => {
      overlay.addEventListener('click', e => {
        e.preventDefault();
        this.remove();
      });

      btns.forEach(btn => {
        btn.addEventListener('click', e => {
          e.preventDefault();
          this.remove();
        });
      });
    }

    requestNotificationPermission = async btn => {
      btn.addEventListener('click', async e => {
        e.preventDefault();
        // Request permission
        if(window.notify && !window.notify.permission) {
          await window.notify.requestPermission();
        }
        // Close the modal
        this.remove();
      });
    }

    getTemplate() {
      // Show HTML Here
      return /*html*/`
      <div class="overlay"></div>
      <section id="content" class="content">
        ${this.getWelcome()}
      </section>
    ${this.getStyles()}`
    }

    getWelcome() {
      return /*html*/`
      <div class="welcome">
        <h2 class="pop-title">
          <span class="control cancel-btn">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" fill="currentColor">
              <path d="M3.72 3.72a.75.75 0 0 1 1.06 0L8 6.94l3.22-3.22a.749.749 0 0 1 1.275.326.749.749 0 0 1-.215.734L9.06 8l3.22 3.22a.749.749 0 0 1-.326 1.275.749.749 0 0 1-.734-.215L8 9.06l-3.22 3.22a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042L6.94 8 3.72 4.78a.75.75 0 0 1 0-1.06Z"></path>
            </svg>
          </span>
          <span class="text">Notification</span>
        </h2>
				<p>
          We would like to send you notifications about new updates and features on this platform.
          You can choose to cancel this action if you don't want to receive notifications.
        </p>
        <div class="actions">
          <span class="cancel-btn action">Cancel</span>
          <span blank="true" class="notify-btn action">Allow</span>
        </div>
			</div>
    `
    }

    getStyles() {
      return /*css*/`
      <style>
        * {
          box-sizing: border-box !important;
        }

        :host{
          border: none;
          padding: 0;
          justify-self: end;
          display: flex;
          flex-flow: column;
          align-items: center;
          justify-content: center;
          gap: 10px;
          z-index: 100;
          width: 100%;
          min-width: 100vw;
          position: fixed;
          right: 0;
          top: 0;
          bottom: 0;
          left: 0;
        }

        div.overlay {
          position: absolute;
          top: 0;
          right: 0;
          bottom: 0;
          left: 0;
          height: 100%;
          width: 100%;
          background-color: var(--modal-background);
          backdrop-filter: blur(3px);
          -webkit-backdrop-filter: blur(3px);
        }

        #content {
          z-index: 1;
          background-color: var(--background);
          padding: 20px 10px 20px;
          display: flex;
          flex-flow: column;
          align-items: center;
          justify-content: center;
          gap: 0;
          width: 700px;
          max-height: 90%;
          height: max-content;
          border-radius: 25px;
          position: relative;
        }
  
        .welcome {
          width: 98%;
          display: flex;
          flex-flow: column;
          align-items: start;
          justify-content: center;
          row-gap: 0;
        }

        .welcome > h2 {
          width: 100%;
          font-size: 1.5rem;
          font-weight: 600;
          margin: 0 0 10px;
          padding: 10px 10px;
          background-color: var(--gray-background);
          text-align: center;
          border-radius: 12px;
          font-family: var(--font-read), sans-serif;
          color: var(--text-color);
          font-weight: 500;
          position: relative;
        }

        .welcome > h2 > span.control {
          padding: 0;
          cursor: pointer;
          display: flex;
          flex-flow: column;
          gap: 0px;
          justify-content: center;
          position: absolute;
          top: 50%;
          left: 10px;
          transform: translateY(-50%);
        }

        .welcome > h2 > span.control svg {
          width: 20px;
          height: 20px;
          color: var(--text-color);
        }

        .welcome > h2 > span.control svg:hover{
          color: var(--error-color);
        }

        .welcome  p {
          margin: 10px 0 10px;
          text-align: start;
          font-family: var(--font-main), sans-serif;
          color: var(--text-color);
          line-height: 1.3;
          font-size: 1rem;
        }

        .welcome p span.url {
          display: inline-block;
          padding: 2px 8px 3px;
          margin: 0 5px;
          width: max-content;
          font-size: 0.8rem;
          font-weight: 400;
          border-radius: 5px;
          background-color: var(--gray-background);
          font-family: var(--font-mono), monospace;
          color: var(--gray-color);
          font-weight: 500;
          border-radius: 5px;
        }

        .welcome > .actions {
          display: flex;
          font-family: var(--font-main), sans-serif;
          width: 100%;
          flex-flow: row;
          align-items: center;
          gap: 20px;
          margin: 10px 0 0;
        }
        
        .welcome > .actions > .action {
          background: var(--accent-linear);
          text-decoration: none;
          color: var(--white-color);
          font-size: 0.95rem;
          font-weight: 500;
          cursor: pointer;
          display: flex;
          width: max-content;
          flex-flow: row;
          align-items: center;
          text-transform: lowercase;
          justify-content: center;
          padding: 4px 15px 5px;
          border-radius: 10px;
          -webkit-border-radius: 10px;
          -moz-border-radius: 10px;
        }

        .welcome > .actions .action.cancel-btn {
          background: var(--gray-background);
          color: var(--text-color);
        }

        @media screen and ( max-width: 850px ){
          #content {
            width: 90%;
          }
        }

        @media screen and ( max-width: 600px ){
          :host {
            border: none;
            background-color: var(--modal-background);
            padding: 0px;
            justify-self: end;
            display: flex;
            flex-flow: column;
            align-items: center;
            justify-content: end;
            gap: 10px;
            z-index: 20;
            position: fixed;
            right: 0;
            top: 0;
            bottom: 0;
            left: 0;
          }

          #content {
            box-sizing: border-box !important;
            padding: 18px 0 0 0;
            margin: 0;
            width: 100%;
            max-width: 100%;
            max-height: 90%;
            min-height: max-content;
            border-radius: 0px;
            border-top: var(--mobile-border);
            border-top-right-radius: 15px;
            border-top-left-radius: 15px;
          }

          .welcome {
            width: 100%;
            padding: 0 15px;
          }

          .welcome > h2 {
            width: 100%;
            font-size: 1.35rem;
            font-weight: 600;
            margin: 0 0 10px;
            padding: 10px 10px;
            background-color: var(--gray-background);
            border-radius: 12px;
            color: var(--text-color);
            font-weight: 500;
          }

          .welcome  p {
            margin: 4px 0 0;
            color: var(--text-color);
            line-height: 1.3;
            font-size: 1rem;
          }

          .welcome > .actions {
            margin: 18px 0;
            width: 100%;
            gap: 35px;
          }

          .welcome > h2 > span.control,
          .welcome > .actions > .action {
            cursor: default !important;
          }
        }
      </style>
    `;
    }
  }

  class PostOptions extends HTMLElement {
    constructor() {
      // We are not even going to touch this.
      super();

      this.editor = null;

      // let's create our shadow root
      this.shadowObj = this.attachShadow({ mode: "open" });

      this._option = this.capitalizeFirstLetter(this.getAttribute('kind'));

      this.hash = this.getAttribute('hash').toLowerCase();

      this.kind = this.getAttribute('kind');

      this.drafted = this.convertToBool(this.getAttribute('drafted'));

      this.removeApi  = this.getAttribute('kind') === 'reply' ? `/api/v1/r/${this.hash}/remove` : `/api/v1/s/${this.hash}/remove`;

      this.render();
    }

    capitalizeFirstLetter = string => {
      return string.charAt(0).toUpperCase() + string.slice(1);
    }

    render() {
      this.shadowObj.innerHTML = this.getTemplate();
    }

    connectedCallback() {
      // select section
      const section = this.shadowObj.querySelector('section.content');
      if (section) {
        // activate the edit button
        this.activateEditButton();
        // activate the publish button
        this.activatePublishButton();
        // activate the delete button
        this.activateDeleteButton();
      }
      
      const btns = this.shadowObj.querySelectorAll('.cancel-btn');
      const overlay = this.shadowObj.querySelector('.overlay');

      // Close the modal
      if (overlay && btns) {
        this.closePopup(overlay, btns);
      }

      this.disableScroll();
    }

    disconnectedCallback() {
      this.enableScroll();
    }

    convertToBool = str => {
  		return str === 'true' ? true : false;
  	}

    closePopup = (overlay, btns) => {
      overlay.addEventListener('click', e => {
        e.preventDefault();
        this.remove();
      });

      btns.forEach(btn => {
        btn.addEventListener('click', e => {
          e.preventDefault();
          this.remove();
        });
      });
    }

    disableScroll() {
      // Get the current page scroll position
      let scrollTop = window.scrollY || document.documentElement.scrollTop;
      let scrollLeft = window.scrollX || document.documentElement.scrollLeft;
      document.body.classList.add("stop-scrolling");

      // if any scroll is attempted, set this to the previous value
      window.onscroll = function () {
        window.scrollTo(scrollLeft, scrollTop);
      };
    }

    enableScroll() {
      document.body.classList.remove("stop-scrolling");
      window.onscroll = function () { };
    }

    activateEditButton = () => {
      // Get the body element
      const body = document.querySelector('body');
      // Get the edit button
      const editButton = this.shadowObj.querySelector('div.post-type > div.types > div.type.edit');
      if(!editButton) return;
      // Add an event listener to the post button
      editButton.addEventListener('click', e => {
        e.preventDefault();
        // Get the content of the topic page
        const content = this.kind === 'story' ? this.getArticleEdit() : this.getEdit();

        // insert the content into the body
        body.insertAdjacentHTML('beforeend', content);

        // Remove the current popup
        this.remove();
      });
    }

    getEdit = () => {
      const hash = this.getAttribute('hash').toLowerCase();
      const api = this.getAttribute('kind') === 'reply' ? `/api/v1/r/${hash}/edit` : `/api/v1/s/${hash}/edit/content`;
      // Show Post Page Here
      return /* html */`
      <div is="edit-post" api="${api}" method="PUT" kind="${this.getAttribute('kind')}" images="${this.getAttribute('images')}"
        url="${this.getAttribute('url')}" hash="${this.getAttribute('hash')}" published="${this.getAttribute('published')}">
        ${this.innerHTML}
      </div>
    `;
    }

    getArticleEdit = () => {
      const hash = this.getAttribute('hash').toLowerCase();
      const api = `/api/v1/s/${hash}/edit`;
      // Show Post Page Here
      return /* html */`
      <div is="edit-article" api="${api}" method="PUT" kind="${this.kind}" story-title="${this.getAttribute('story-title')}" slug="${this.getAttribute('slug')}"
        url="${this.getAttribute('url')}" hash="${this.getAttribute('hash')}"  images="${this.getAttribute('images')}">
        ${this.innerHTML}
      </div>
    `;
    }

    activatePublishButton = () => {
      const publishButton = this.shadowObj.querySelector('div.post-type > div.types > div.type.publish');
      if(!publishButton) return;
      publishButton.addEventListener('click', e => {
        e.preventDefault();
        const content = this.getPublish();
        this.shadowObj.querySelector('div.fields').innerHTML = content;
        this.activatePublishAction(this.shadowObj.querySelector('div.finish.publish'));
      });
    }

    activatePublishAction = publish => {
      const button = publish.querySelector('button.finish.publish');
      if (button) {
        button.addEventListener('click', e => {
          e.preventDefault();

          // disable pointer events
          button.style.pointerEvents = 'none';

          const section = this.shadowObj.querySelector('section.content');

          this.publishPost(section, button);
        });
      }
    }

    publishPost = async (section, button) => {
      button.innerHTML = this.getButtonLoader();
      const url = `/api/v1/s/${this.hash}/publish`;
      const options = {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
        }
      };

      try {
        const response = await this.fetchWithTimeout(url, options);
        const data = await response.json();
        if (data.success) {
          // select fields container
          const fields = this.shadowObj.querySelector('div.fields');

          // replace the fields with the finish message
          fields.innerHTML = this.getFinish('publish');
          // activate the finish button
          this.activateFinish(this.shadowObj.querySelector('div.finish'));

          if(window.toBeChanged) {
            window.toBeChanged.setAttribute('published', 'true');
            window.toBeChanged.setAttribute('reload', 'true');
            window.toBeChanged = null;
          }
        } else {
          // show error message
          button.innerHTML = 'Publish';
          // enable pointer events
          button.style.pointerEvents = 'auto';

          const status = this.getServerSuccessMsg(data.success, data.message);
        
          // insert the status message before the button
          button.insertAdjacentHTML('beforebegin', status);

          // remove success message
          setTimeout(() => {
            const serverStatus = section.querySelector('.server-status');
            if (serverStatus) {
              serverStatus.remove();
            }
          }, 5000);
        }
      } catch (error) {
        // show error message
        button.innerHTML = 'Publish';
        // enable pointer events
        button.style.pointerEvents = 'auto';

        const status = this.getServerSuccessMsg(false, 'An error occurred. Please try again later.');
        
        // insert the status message before the button
        button.insertAdjacentHTML('beforebegin', status);

        setTimeout(() => {
          const serverStatus = section.querySelector('.server-status');
          if (serverStatus) {
            serverStatus.remove();
          }
        }, 5000);
      }
    }

    activateDeleteButton = () => {
      const deleteButton = this.shadowObj.querySelector('div.post-type > div.types > div.type.delete');
      if(!deleteButton) return;
      deleteButton.addEventListener('click', e => {
        e.preventDefault();
        const content = this.getDelete();
        this.shadowObj.querySelector('div.fields').innerHTML = content;
        this.activateDeleteAction(this.shadowObj.querySelector('div.finish.delete'));
      });
    }

    activateDeleteAction = del => {
      const button = del.querySelector('button.finish.delete');
      if (button) {
        button.addEventListener('click', e => {
          e.preventDefault();

          // disable pointer events
          button.style.pointerEvents = 'none';

          const section = this.shadowObj.querySelector('section.content');

          this.deletePost(section, button);
        });
      }
    }

    deletePost = async (section, button) => {
      button.innerHTML = this.getButtonLoader();
      const options = {
        method: 'DELETE',
        headers: {
          'Content-Type': 'application/json',
        }
      };

      try {
        const response = await this.fetchWithTimeout(this.removeApi, options);
        const data = await response.json();
        if (data.success) {
          // replace the fields with the finish message
          section.innerHTML = this.getFinish('delete');
          // activate the finish button
          this.activateFinish(this.shadowObj.querySelector('div.finish'));
          if(window.toBeChanged) {
            window.toBeChanged.remove();
            window.toBeChanged = null;
          }
        } else {
          // show error message
          button.innerHTML = 'Delete';
          // enable pointer events
          button.style.pointerEvents = 'auto';

          const status = this.getServerSuccessMsg(data.success, data.message);
        
          // insert the status message before the button
          button.insertAdjacentHTML('beforebegin', status);

          setTimeout(() => {
            const serverStatus = section.querySelector('.server-status');
            if (serverStatus) {
              serverStatus.remove();
            }
          }, 5000);
        }
      } catch (error) {
        // show error message
        button.innerHTML = 'Delete';
        // enable pointer events
        button.style.pointerEvents = 'auto';

        const status = this.getServerSuccessMsg(false, 'An error occurred. Please try again later.');
        
        // insert the status message before the button
        button.insertAdjacentHTML('beforebegin', status);

        setTimeout(() => {
          const serverStatus = section.querySelector('.server-status');
          if (serverStatus) {
            serverStatus.remove();
          }
        }, 5000);
      }
    }

    fetchWithTimeout = async (url, options = {}, timeout = 9500) => {
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), timeout);
    
      try {
        const response = await fetch(url, {
          ...options,
          signal: controller.signal
        });

        return response;
      } catch (error) {
        if (error.name === 'AbortError') {
          throw new Error('Request timed out');
        }
        throw new Error(`Network error: ${error.message}`);
      } finally {
        clearTimeout(timeoutId);
      }
    }

    getServerSuccessMsg = (success, text) => {
      if (!success) {
        return `
        <p class="server-status">${text}</p>
      `
      }
      return `
      <p class="server-status success">${text}</p>
    `
    }

    getTemplate() {
      // Show HTML Here
      return /*html*/`
      <div class="overlay"></div>
      <section id="content" class="content">
        ${this.getBody()}
      </section>
      ${this.getStyles()}
    `
    }

    getBody = () => {
      return /* html */`
      <div class="fields" id="fields-container">
        ${this.getOptions()}
      </div>
    `;
    }

    getOptions = () => {
      return /* html */`
      <div class="post-type">
        <div class="types">
          <div class="type edit">
            <h4 class="title">Edit</h4>
            <p class="desc">
              Make changes to the ${this._option} contents.
            </p>
          </div>
          ${this.getPublished(this.convertToBool(this.getAttribute('story')))}
          <div class="type delete">
            <h4 class="title">Delete</h4>
            <p class="desc">
              Remove this ${this._option} from the platform.
            </p>
          </div>
        </div>
      </div>
    `;
    }

    getPublished = story => {
      if (story) {
        if (this.drafted) {
          return /*html*/`
          <div class="type publish" data-name="publish">
            <h4 class="title">Publish</h4>
            <p class="desc">
              This will make the story appear public.
            </p>
          </div>
        `
        } else return '';
      } else return '';
    }

    getPublish = () => {
      return /* html */`
      <div class="finish publish">
        <h2 class="title">Please confirm</h2>
        <p class="desc">
          Your ${this._option.toLowerCase()} will be made publicly available to everyone on this platform.
          Your ${this._option.toLowerCase()} may also appear in web search.
        </p>
        <button class="finish publish">Publish</button>
      </div>
    `;
    }

    getDelete = () => {
      return /* html */`
      <div class="finish delete">
        <h2 class="title">Please confirm</h2>
        <p class="desc">
          Your are about to remove the ${this._option.toLowerCase()} completely from the Platform.
          Once this ${this._option.toLowerCase()} removed, you cannot recover it.
        </p>
        <button class="finish delete">Delete</button>
      </div>
    `;
    }

    getFinish = action => {
      if (action === 'publish') {
        return /* html */`
        <div class="finish">
          <h2 class="title">Published</h2>
          <p class="desc">
            Your ${this._option.toLowerCase()} has been successfully published.
            To view the ${this._option.toLowerCase()}, go to the feeds or from your profile.
          </p>
          <button class="finish">Close</button>
        </div>
      `;
      } else if (action === 'delete') {
        return /* html */`
        <div class="finish">
          <h2 class="title">Deleted</h2>
          <p class="desc">
            Your ${this._option.toLowerCase()} has been deleted successfully.
            The ${this._option.toLowerCase()} is no longer available on the platform.
          </p>
          <button class="finish">Close</button>
        </div>
      `;
      } else {
        return /* html */`
        <div class="finish">
          <h2 class="title">You're all set!</h2>
          <p class="desc">
            Your action has been successfully completed.
            You can now close this dialog.
          </p>
          <button class="finish">Close</button>
        </div>
      `;
      }
    }

    activateFinish = finish => {
      const button = finish.querySelector('button.finish');
      if (button) {
        button.addEventListener('click', e => {
          e.preventDefault();
          this.remove();
        });
      }
    }

    getButtonLoader() {
      return /*html*/`
      <span id="btn-loader">
				<span class="loader"></span>
			</span>
    `
    }

    getStyles() {
      return /* css */`
      <style>
        *,
        *:after,
        *:before {
          box-sizing: border-box !important;
          font-family: inherit;
          -webkit-box-sizing: border-box !important;
        }

        *:focus {
          outline: inherit !important;
        }

        *::-webkit-scrollbar {
          -webkit-appearance: none;
        }

        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
          padding: 0;
          margin: 0;
          font-family: inherit;
        }

        p,
        ul,
        ol {
          font-family: inherit;
        }

        a {
          text-decoration: none;
        }

        :host {
          border: none;
          padding: 0;
          justify-self: end;
          display: flex;
          flex-flow: column;
          align-items: center;
          justify-content: center;
          gap: 10px;
          z-index: 90;
          width: 100%;
          min-width: 100vw;
          position: fixed;
          right: 0;
          top: 0;
          bottom: 0;
          left: 0;
        }

        div.overlay {
          position: absolute;
          top: 0;
          right: 0;
          bottom: 0;
          left: 0;
          height: 100%;
          width: 100%;
          background-color: var(--modal-background);
          backdrop-filter: blur(3px);
          -webkit-backdrop-filter: blur(3px);
        }

        #content {
          z-index: 1;
          background-color: var(--background);
          padding: 20px;
          display: flex;
          flex-flow: column;
          align-items: center;
          justify-content: start;
          gap: 10px;
          width: 700px;
          max-height: 95%;
          height: 90%;
          height: max-content;
          border-radius: 15px;
          position: relative;
          overflow-y: auto;
        }

        p.server-status {
          margin: 0;
          width: 100%;
          text-align: center;
          font-family: var(--font-read), sans-serif;
          color: var(--error-color);
          font-weight: 500;
          line-height: 1.4;
          font-size: 1.18rem;
        }

        p.server-status.success {
          color: transparent;
          background: var(--accent-linear);
          background-clip: text;
          -webkit-background-clip: text;
        }

        #btn-loader {
          position: absolute;
          top: 0;
          left: 0;
          bottom: 0;
          right: 0;
          z-index: 5;
          display: flex;
          align-items: center;
          justify-content: center;
          border-radius: inherit;
        }

        #btn-loader > .loader {
          width: 20px;
          aspect-ratio: 1;
          --_g: no-repeat radial-gradient(farthest-side, #18A565 94%, #0000);
          --_g1: no-repeat radial-gradient(farthest-side, #21D029 94%, #0000);
          --_g2: no-repeat radial-gradient(farthest-side, #df791a 94%, #0000);
          --_g3: no-repeat radial-gradient(farthest-side, #f09c4e 94%, #0000);
          background: var(--_g) 0 0,  var(--_g1) 100% 0, var(--_g2) 100% 100%, var(--_g3) 0 100%;
          background-size: 30% 30%;
          animation: l38 .9s infinite ease-in-out;
          -webkit-animation: l38 .9s infinite ease-in-out;
        }

        @keyframes l38 {
          100% {
            background-position: 100% 0, 100% 100%, 0 100%, 0 0
          }
        }

        h2.pop-title {
          width: 100%;
          font-size: 1.35rem;
          font-weight: 600;
          margin: 0;
          padding: 10px 10px;
          background-color: var(--gray-background);
          text-align: center;
          border-radius: 12px;
          font-family: var(--font-read), sans-serif;
          color: var(--text-color);
          font-weight: 500;
          position: relative;
        }

        h2.pop-title > span.control {
          padding: 0;
          cursor: pointer;
          display: flex;
          flex-flow: column;
          gap: 0px;
          justify-content: center;
          position: absolute;
          top: 50%;
          left: 10px;
          transform: translateY(-50%);
        }

        h2.pop-title > span.control svg {
          width: 21px;
          height: 21px;
          color: var(--text-color);
        }

        h2.pop-title > span.control svg:hover{
          color: var(--error-color);
        }

        h2.pop-title > span.text:first-letter {
          text-transform: capitalize;
        }

        .top {
          display: flex;
          flex-flow: column;
          gap: 5px;
          padding: 0;
          width: 100%;
        }

        .top > .desc {
          margin: 0;
          padding: 10px 0 20px;
          color: var(--text-color);
          font-size: 0.95rem;
          font-family: var(--font-main), sans-serif;
        }

        .top > .desc > span {
          display: inline-block;
          margin: 10px 0 5px;
          color: var(--gray-color);
          font-size: 0.85rem;
          font-style: italic;
          font-family: var(--font-read), sans-serif;
        }

        div.fields {
          margin: 0;
          width: 100%;
          min-width: 100%;
          height: auto;
          display: flex;
          flex-flow: column;
          justify-content: center;
          align-items: center;
          gap: 0;
        }

        div.post-type {
          width: 100%;
          display: flex;
          flex-flow: column;
          gap: 15px;
          padding: 10px 0;
        }

        div.post-type > h2.title {
          width: 100%;
          margin: 0;
          padding: 0;
          font-size: 1.25rem;
          text-align: center;
          font-weight: 500;
          font-family: var(--font-main), sans-serif;
          color: var(--text-color);
        }

        div.post-type > div.types {
          width: 100%;
          display: flex;
          flex-flow: row;
          gap: 20px;
        }

        div.post-type > div.types > div.type {
          width: 100%;
          display: flex;
          flex-flow: column;
          gap: 5px;
          padding: 10px;
          border-radius: 12px;
          background: var(--create-background);
          cursor: pointer;
        }

        div.post-type > div.types > div.type:hover {
          background: var(--background);
          border: var(--border);
          padding: 9px;
        }

        div.post-type > div.types > div.type > h4.title {
          margin: 0;
          padding: 0;
          font-size: 1.1rem;
          font-weight: 500;
          font-family: var(--font-main), sans-serif;
          color: var(--text-color);
        }

        div.post-type > div.types > div.type.delete > h4.title{
          color: var(--error-color);
        }

        div.post-type > div.types > div.type > p.desc {
          margin: 0;
          padding: 5px 0;
          font-size: 0.85rem;
          font-family: var(--font-read), sans-serif;
          color: var(--gray-color);
        }

        div.finish {
          padding: 15px 0;
          width: 100%;
          min-width: 100%;
          height: auto;
          display: flex;
          flex-flow: column;
          justify-content: center;
          align-items: center;
          gap: 15px;
        }

        div.finish > h2.title {
          margin: 0;
          font-size: 1.25rem;
          font-weight: 600;
          font-family: var(--font-main), sans-serif;
          color: var(--text-color);
        }

        div.finish > p.desc {
          margin: 0;
          font-size: 0.95rem;
          font-family: var(--font-read), sans-serif;
          color: var(--text-color);
          line-height: 1.4;
          text-align: center;
        }

        div.finish > button.finish {
          border: none;
          background: var(--accent-linear);
          font-family: var(--font-main), sans-serif;
          text-decoration: none;
          color: var(--white-color);
          font-size: 1rem;
          font-weight: 600;
          cursor: pointer;
          display: flex;
          width: max-content;
          flex-flow: row;
          align-items: center;
          text-transform: capitalize;
          justify-content: center;
          position: relative;
          min-width: 50px;
          min-height: 40px;
          width: max-content;
          padding: 7px 15px 8px;
          border-radius: 50px;
          -webkit-border-radius: 50px;
          -moz-border-radius: 50px;
        }

        div.finish > button.finish.delete {
          border: none;
          background: var(--error-linear);
          color: var(--white-color);
        }

        @media screen and (max-width:600px) {
          :host {
            border: none;
            background-color: var(--modal-background);
            padding: 0px;
            justify-self: end;
            display: flex;
            flex-flow: column;
            align-items: center;
            justify-content: end;
            gap: 10px;
            z-index: 20;
            position: fixed;
            right: 0;
            top: 0;
            bottom: 0;
            left: 0;
          }

          #content {
            box-sizing: border-box !important;
            padding: 5px 10px 10px 10px;
            margin: 0;
            width: 100%;
            max-width: 100%;
            max-height: 90%;
            min-height: max-content;
            border-radius: 0px;
            border-top: var(--mobile-border);
            border-top-right-radius: 15px;
            border-top-left-radius: 15px;
          }

          #content span.control {
            cursor: default !important;
          }

          ::-webkit-scrollbar {
            -webkit-appearance: none;
          }

          h2.pop-title {
            width: 100%;
            font-size: 1.2rem;
            padding: 10px 10px;
            background-color: var(--gray-background);
            text-align: center;
            border-radius: 12px;
          }

          .top > .desc {
            margin: 0;
            padding: 6px 0 10px;
            font-size: 0.95rem;
            line-height: 1.5;
            font-family: var(--font-main), sans-serif;
          }

          div.post-type > div.types > div.type {
            width: 100%;
            display: flex;
            flex-flow: column;
            gap: 2px;
            cursor: default !important;
          }

          div.finish {
            padding: 25px 0 10px;
            width: 100%;
            min-width: 100%;
            height: auto;
            display: flex;
            flex-flow: column;
            justify-content: center;
            align-items: center;
            gap: 18px;
          }

          div.post-type > div.types {
            width: 100%;
            display: flex;
            flex-flow: column;
            gap: 20px;
          }

          div.fields .actions {
            align-items: center;
            width: 100%;
            gap: 25px;
          }

          div.finish > button.finish {
            margin: 10px 0 0;
          }

          div.finish > button.finish,
          div.fields .actions > .action {
            cursor: default !important;
          }
        }
      </style>
    `;
    }
  }

  class ImagePopup extends HTMLElement {
    constructor() {
      super();
      this.shadowObj = this.attachShadow({ mode: "open" });
      this.imagesLength = this.getAttribute("images").split(",").length;
      this.index = this.parseToNumber(this.getAttribute("current"));
      this.render();
      this.isScrolling = false;
      this.targetScrollLeft = 0;
      this.handlePopState = this.handlePopState.bind(this);
      this.preventContextMenu = this.preventContextMenu.bind(this);
      this.preventTouchHold = this.preventTouchHold.bind(this);
    }

    render() {
      this.shadowObj.innerHTML = this.getTemplate();
    }

    connectedCallback() {
      const btns = this.shadowObj.querySelectorAll('.cancel-btn');
      const overlay = this.shadowObj.querySelector('.overlay');

      if (overlay && btns) {
        this.closePopup(overlay, btns);
      }

      this.addImageLoadListeners();
      this.scrollToCurrentImage();
      this.setupScrolling();
      this.disableScroll();
      this.setupBackButtonHandler();
      this.setupDownloadPrevention();
    }

    disconnectedCallback() {
      this.enableScroll();
      this.removeBackButtonHandler();
      this.removeDownloadPrevention();
    }

    setupDownloadPrevention() {
      const imagesContainer = this.shadowObj.querySelector('.images');
      imagesContainer.addEventListener('contextmenu', this.preventContextMenu);
      imagesContainer.addEventListener('touchstart', this.preventTouchHold);
      
      // Prevent drag & drop
      imagesContainer.addEventListener('dragstart', (e) => e.preventDefault());
    }

    removeDownloadPrevention() {
      const imagesContainer = this.shadowObj.querySelector('.images');
      imagesContainer.removeEventListener('contextmenu', this.preventContextMenu);
      imagesContainer.removeEventListener('touchstart', this.preventTouchHold);
    }

    preventContextMenu(e) {
      e.preventDefault();
      e.stopPropagation();
      return false;
    }

    preventTouchHold(e) {
      const touch = e.touches[0];
      let touchHoldTimer;

      const clearTouchHoldTimer = () => {
        if (touchHoldTimer) {
          clearTimeout(touchHoldTimer);
        }
      };

      touchHoldTimer = setTimeout(() => {
        e.preventDefault();
        e.stopPropagation();
      }, 500); // Adjust this value to change the hold duration

      const touchEnd = () => {
        clearTouchHoldTimer();
        document.removeEventListener('touchend', touchEnd);
        document.removeEventListener('touchmove', touchMove);
      };

      const touchMove = (moveEvent) => {
        if (
          Math.abs(moveEvent.touches[0].pageX - touch.pageX) > 10 ||
          Math.abs(moveEvent.touches[0].pageY - touch.pageY) > 10
        ) {
          clearTouchHoldTimer();
        }
      };

      document.addEventListener('touchend', touchEnd);
      document.addEventListener('touchmove', touchMove);
    }

    setupBackButtonHandler() {
      // Push a new state to the history when the popup opens
      history.pushState({ popup: true }, '');

      // Add event listener for popstate
      // window.addEventListener('popstate', this.handlePopState.bind(this));
      window.onpopstate = this.handlePopState.bind(this);
    }

    removeBackButtonHandler() {
      window.removeEventListener('popstate', this.handlePopState.bind(this));
    }

    handlePopState(event) {
      // Prevent other popstate event handlers from being called
      event.stopImmediatePropagation();

      // Close the popup when the back button is pressed
      this.remove();
    }

    closeAndRemove() {
      // Remove the event listener before closing
      this.removeBackButtonHandler();
      
      // Remove the state we added when opening the popup
      // history.back();
      
      // Remove the popup from the DOM
      this.remove();
    }

    closePopup = (overlay, btns) => {
      overlay.addEventListener('click', e => {
        e.preventDefault();
        this.closeAndRemove();
        // Remove the state we added when opening the popup
        history.back();  closePopup = (overlay, btns) => {
          overlay.addEventListener('click', e => {
            e.preventDefault();
            this.remove();
          });
      
          btns.forEach(btn => {
            btn.addEventListener('click', e => {
              e.preventDefault();
              this.remove();
            });
          });
        };
      });

      btns.forEach(btn => {
        btn.addEventListener('click', e => {
          e.preventDefault();
          this.closeAndRemove();
          // Remove the state we added when opening the popup
          history.back();
        });
      });

      // remove the popup when the user presses the escape key
      document.addEventListener('keydown', e => {
        if (e.key === 'Escape') {
          this.closeAndRemove();
          // Remove the state we added when opening the popup
          history.back();
        }
      });
    }

    scrollToCurrentImage() {
      const imagesContainer = this.shadowObj.querySelector('.images');
      const imageWidth = imagesContainer.offsetWidth;
      this.smoothScroll(imagesContainer, (this.index - 1) * imageWidth);
    }

    setupScrolling() {
      const imagesContainer = this.shadowObj.querySelector('.images');
      let startX;
      let scrollLeft;

      imagesContainer.addEventListener('touchstart', (e) => {
        startX = e.touches[0].pageX - imagesContainer.offsetLeft;
        scrollLeft = imagesContainer.scrollLeft;
      });

      imagesContainer.addEventListener('touchmove', (e) => {
        e.preventDefault();
        const x = e.touches[0].pageX - imagesContainer.offsetLeft;
        const walk = (x - startX) * 2;
        imagesContainer.scrollLeft = scrollLeft - walk;
      });

      imagesContainer.addEventListener('touchend', () => {
        this.snapToNearestImage(imagesContainer);
      });

      imagesContainer.addEventListener('wheel', (e) => {
        e.preventDefault();
        if (e.deltaX > 0) {
          this.scrollToNextImage(imagesContainer);
        } else if (e.deltaX < 0) {
          this.scrollToPreviousImage(imagesContainer);
        }
      });

      // Add keyboard navigation
      document.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowRight') {
          this.scrollToNextImage(imagesContainer);
        } else if (e.key === 'ArrowLeft') {
          this.scrollToPreviousImage(imagesContainer);
        }
      });
    }

    snapToNearestImage(container) {
      const imageWidth = container.offsetWidth;
      const scrollPosition = container.scrollLeft;
      const imageIndex = Math.round(scrollPosition / imageWidth);
      this.smoothScroll(container, imageIndex * imageWidth);
    }

    scrollToNextImage(container) {
      const imageWidth = container.offsetWidth;
      const currentIndex = Math.floor(container.scrollLeft / imageWidth);
      if (currentIndex < this.imagesLength - 1) {
        this.smoothScroll(container, (currentIndex + 1) * imageWidth);
      }
    }

    scrollToPreviousImage(container) {
      const imageWidth = container.offsetWidth;
      const currentIndex = Math.ceil(container.scrollLeft / imageWidth);
      if (currentIndex > 0) {
        this.smoothScroll(container, (currentIndex - 1) * imageWidth);
      }
    }

    smoothScroll(container, target) {
      this.isScrolling = true;
      this.targetScrollLeft = target;
      
      const startScrollLeft = container.scrollLeft;
      const distance = this.targetScrollLeft - startScrollLeft;
      const duration = 300; // milliseconds
      let startTime = null;

      const animation = (currentTime) => {
        if (startTime === null) startTime = currentTime;
        const timeElapsed = currentTime - startTime;
        const run = this.easeInOutQuad(timeElapsed, startScrollLeft, distance, duration);
        container.scrollLeft = run;
        if (timeElapsed < duration) {
          requestAnimationFrame(animation);
        } else {
          container.scrollLeft = this.targetScrollLeft;
          this.isScrolling = false;
          this.index = Math.round(this.targetScrollLeft / container.offsetWidth) + 1;
        }
      };

      requestAnimationFrame(animation);
    }

    easeInOutQuad(t, b, c, d) {
      t /= d / 2;
      if (t < 1) return c / 2 * t * t + b;
      t--;
      return -c / 2 * (t * (t - 2) - 1) + b;
    }

    parseToNumber = num_str => {
      // Try parsing the string to an integer
      const num = parseInt(num_str);

      // Check if parsing was successful
      if (!isNaN(num)) {
        return num;
      } else {
        return 0;
      }
    }

    addImageLoadListeners() {
      const images = this.shadowObj.querySelectorAll('img');
      images.forEach(img => {
        img.addEventListener('load', () => {
  				// remove loader and blur(.loading) class)
  				img.parentElement.classList.remove('loading');
  				const loader = img.parentElement.querySelector('#btn-loader');
  				if(loader) { loader.remove(); }
        });
        img.addEventListener('error', () => {
          img.parentElement.classList.add('error');
        });
      });
    }

    disableScroll() {
      // Get the current page scroll position
      let scrollTop = window.scrollY || document.documentElement.scrollTop;
      let scrollLeft = window.scrollX || document.documentElement.scrollLeft;
      document.body.classList.add("stop-scrolling");

      // if any scroll is attempted, set this to the previous value
      window.onscroll = function () {
        window.scrollTo(scrollLeft, scrollTop);
      };
    }

    enableScroll() {
      document.body.classList.remove("stop-scrolling");
      window.onscroll = function () { };
    }

    getTemplate() {
      const imagesArrayStr = this.getAttribute("images");
  		const images = imagesArrayStr.split(",");
      return /*html*/`
      <div class="overlay"></div>
      <section id="content" class="content">
        <span class="control cancel-btn">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" fill="currentColor">
            <path d="M3.72 3.72a.75.75 0 0 1 1.06 0L8 6.94l3.22-3.22a.749.749 0 0 1 1.275.326.749.749 0 0 1-.215.734L9.06 8l3.22 3.22a.749.749 0 0 1-.326 1.275.749.749 0 0 1-.734-.215L8 9.06l-3.22 3.22a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042L6.94 8 3.72 4.78a.75.75 0 0 1 0-1.06Z"></path>
          </svg>
        </span>
        <div class="images">
          ${this.getBody(images)}
        </div>
      </section>
      ${this.getStyles()}
    `
    }

    getBody = images => {
      return images.map(image => {
        return /* html */`
        <div class="image-container loading">
          <img src="${image}" alt="Post Image" loading="lazy" draggable="false">
          ${this.getButtonLoader()}
        </div>
      `;
      }).join("");
    }

  	getButtonLoader() {
      return /*html*/`
      <span id="btn-loader">
				<span class="loader"></span>
			</span>
    `
    }

    getStyles() {
      return /* css */`
      <style>
        *,
        *:after,
        *:before {
          box-sizing: border-box !important;
          font-family: inherit;
          -webkit-box-sizing: border-box !important;
        }

        *:focus {
          outline: inherit !important;
        }

        *::-webkit-scrollbar {
          -webkit-appearance: none;
        }

        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
          padding: 0;
          margin: 0;
          font-family: inherit;
        }

        p,
        ul,
        ol {
          font-family: inherit;
        }

        a {
          text-decoration: none;
        }

        :host {
          border: none;
          padding: 0;
          justify-self: end;
          display: flex;
          flex-flow: column;
          align-items: center;
          justify-content: center;
          gap: 10px;
          z-index: 90;
          width: 100%;
          min-width: 100vw;
          position: fixed;
          right: 0;
          top: 0;
          bottom: 0;
          left: 0;
        }

        div.overlay {
          position: absolute;
          top: 0;
          right: 0;
          bottom: 0;
          left: 0;
          height: 100%;
          width: 100%;
          background-color: var(--modal-background);
          backdrop-filter: blur(3px);
          -webkit-backdrop-filter: blur(3px);
        }

        #content {
          z-index: 1;
          background-color: var(--background);
          padding: 20px;
          display: flex;
          flex-flow: column;
          align-items: center;
          justify-content: start;
          gap: 10px;
          width: 700px;
          height: 90%;
          min-height: 400px;
          max-height: 90%;
          height: max-content;
          border-radius: 15px;
          position: relative;
          overflow-y: auto;
        }

        #btn-loader {
          position: absolute;
          top: 0;
          left: 0;
          bottom: 0;
          right: 0;
          z-index: 5;
          display: flex;
          align-items: center;
          justify-content: center;
          border-radius: inherit;
        }

        #btn-loader > .loader {
          width: 35px;
          aspect-ratio: 1;
          --_g: no-repeat radial-gradient(farthest-side, #18A565 94%, #0000);
          --_g1: no-repeat radial-gradient(farthest-side, #21D029 94%, #0000);
          --_g2: no-repeat radial-gradient(farthest-side, #df791a 94%, #0000);
          --_g3: no-repeat radial-gradient(farthest-side, #f09c4e 94%, #0000);
          background: var(--_g) 0 0,  var(--_g1) 100% 0, var(--_g2) 100% 100%, var(--_g3) 0 100%;
          background-size: 30% 30%;
          animation: l38 .9s infinite ease-in-out;
          -webkit-animation: l38 .9s infinite ease-in-out;
        }

        @keyframes l38 {
          100% {
            background-position: 100% 0, 100% 100%, 0 100%, 0 0
          }
        }

        span.control {
          background: var(--gray-background);
          padding: 0;
          cursor: pointer;
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 0;
          z-index: 10;
          justify-content: center;
          position: absolute;
          top: 10px;
          right: 10px;
          width: 30px;
          height: 30px;
          border-radius: 50%;
        }

        span.control svg {
          width: 20px;
          height: 20px;
          color: var(--text-color);
        }

        span.control svg:hover{
          color: var(--error-color);
        }

        div.images {
					width: max-content;
					margin: 0;
          min-width: 100%;
          width: 100%;
          height: 100%;
          max-height: 100%;
					gap: 0;
					position: relative;
					justify-content: start;
					align-items: center;
					margin: 0;
          display: flex;
          overflow-x: scroll;
          scroll-snap-type: x mandatory;
          scrollbar-width: none;
          -ms-overflow-style: none;
        }

        div.images::-webkit-scrollbar {
          display: none !important;
          visibility: hidden;
        }
				
				.image-container {
          flex: 0 0 100%;
          scroll-snap-align: start;
					position: relative;
					display: flex;
					justify-content: center;
					align-items: center;
					position: relative;
					overflow: hidden;
					max-height: 100%;
					min-width: 100%;
          max-width: 100%;
          min-height: 100%;
				}

				.image-container.loading img {
					filter: blur(8px);
				}

				.image-container.error {
					border: var(--input-border-error);
				}

				.image-container > img {
					height: auto;
					width: 100%;
          max-width: 100%;
          overflow: hidden;
					object-fit: cover;
          object-position: contain;
          overflow: hidden;
          user-select: none;
          -webkit-user-select: none;
          -webkit-touch-callout: none;
				}

        @media screen and (max-width:600px) {
          :host {
            border: none;
            background-color: var(--modal-background);
            padding: 0px;
            justify-self: end;
            display: flex;
            flex-flow: column;
            align-items: center;
            justify-content: end;
            gap: 0;
            z-index: 20;
            position: fixed;
            right: 0;
            top: 0;
            bottom: 0;
            left: 0;
          }

          #content {
            box-sizing: border-box !important;
            padding: 0;
            margin: 0;
            position: fixed;
            right: 0;
            top: 0;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 100%;
            min-width: 100%;
            max-width: 100%;
            max-height: 100%;
            min-height: 100%;
            border-radius: 0px;
          }

          #content span.control {
            cursor: default !important;
          }

          ::-webkit-scrollbar {
            -webkit-appearance: none;
          }

					a {
						cursor: default !important;
					}
        }
      </style>
    `;
    }
  }

  // set hash if user is logged
  const setHash = name => {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);

    const cookie = parts.length === 2 ? parts.pop().split(';').shift() : null;

    // add cookie to the window
    window.hash = cookie;
  };

  const setTheme = currentTheme =>{
    // Check the current theme
    const htmlElement = document.documentElement;
    const metaThemeColor = document.querySelector("meta[name=theme-color]");

    // Check if the current theme is: system
    if (currentTheme === 'system') {
      // Update the data-theme attribute
      htmlElement.setAttribute('data-theme', currentTheme);

      // Store the preference in local storage
      localStorage.setItem('theme', 'system');

      // Update the theme-color meta tag
      metaThemeColor.setAttribute("content", currentTheme === 'dark' ? '#000000' : '#ffffff');
      return;
    }
    
    // Update the data-theme attribute
    htmlElement.setAttribute('data-theme', currentTheme);
    
    // Store the preference in local storage
    localStorage.setItem('theme', currentTheme);

    // Update the theme-color meta tag
    metaThemeColor.setAttribute("content", currentTheme === 'dark' ? '#000000' : '#ffffff');
  };

  const prefersDarkScheme = window.matchMedia("(prefers-color-scheme: dark)");

  // listen for theme change
  prefersDarkScheme.addEventListener('change', (event) => {
    // get local storage theme
    const currentTheme = localStorage.getItem('theme') || 'light';

    // if the theme is system
    if (currentTheme === 'system') {
      // set the theme
      setTheme('system');
      return;
    }
  });

  // get theme from local storage
  const currentTheme = localStorage.getItem('theme') || 'light';

  // set the theme
  setTheme(currentTheme);

  // set hash
  setHash('hash');

  // get host name
  const host = window.location.hostname;

  window.wss = new WebSocketManager(`${host}`);
  window.wss.connect();

  // Start NotificationManager
  // Create a global instance
  window.notify = new NotificationManager();

  // Register apps
  customElements.define("app-home", AppHome);
  customElements.define("app-post", AppPost);
  customElements.define("app-profile", AppProfile);
  customElements.define("app-logon", AppLogon);
  customElements.define("app-search", AppSearch);
  customElements.define("app-story", AppStory);
  customElements.define("app-topic", AppTopic);
  customElements.define("app-user", AppUser);
  customElements.define("app-offline", AppOffline);

  // Register Create
  customElements.define("create-topic", CreateTopic, { extends: "div" });
  customElements.define("create-post", NewPost, { extends: "div" });
  customElements.define("create-article", CreateArticle, { extends: "div" });
  customElements.define("edit-post", EditPost, { extends: "div" });
  customElements.define("edit-article", EditArticle, { extends: "div" });
  customElements.define("create-reply", CreateReply, { extends: "div" });
  customElements.define("images-editor", ImagesEditor, { extends: "div" });

  // Register containers
  customElements.define("add-container", FormContainer$1);
  customElements.define("activity-container", ActivityContainer);
  customElements.define("form-container", FormContainer);
  customElements.define("highlights-container", HighlightsContainer);
  customElements.define("info-container", InfoContainer);
  customElements.define("people-container", PeopleContainer);
  customElements.define("discover-people", DiscoverPeople);
  customElements.define("stat-container", StatContainer);
  customElements.define("stories-container", StoriesContainer);
  customElements.define("topics-container", TopicsContainer);
  customElements.define("feed-container", FeedContainer);
  customElements.define("update-container", UpdateContainer);
  customElements.define("content-container", ContentContainer);

  // Register custom elements
  customElements.define("custom-span", CustomSpan, { extends: "span" });

  // Register posts
  customElements.define("quick-post", QuickPost);
  customElements.define("poll-post", PollPost);
  customElements.define("story-post", StoryPost);
  customElements.define("preview-post", PreviewPost);
  customElements.define("reply-post", ReplyPost);

  // Register feeds
  customElements.define("activity-feed", ActivityFeed);
  customElements.define("people-feed", PeopleFeed);
  customElements.define("stories-feed", StoryFeed);
  customElements.define("replies-feed", RepliesFeed);
  customElements.define("stat-feed", StatFeed);
  customElements.define("topics-feed", TopicFeed);
  customElements.define("home-feed", HomeFeed);
  customElements.define("update-feed", UpdateFeed);
  customElements.define("content-feed", ContentFeed);

  // Register forms
  customElements.define("bio-form", FormBio);
  customElements.define("email-form", FormEmail);
  customElements.define("password-form", FormPassword);
  customElements.define("profile-form", FormProfile);
  customElements.define("name-form", FormName$1);
  customElements.define("social-form", FormName);

  // Register loaders
  customElements.define("authors-loader", AuthorsLoader);
  customElements.define("info-loader", InfoLoader);
  customElements.define("people-loader", PeopleLoader);
  customElements.define("post-loader", PostLoader);
  customElements.define("story-loader", StoryLoader);
  customElements.define("topics-loader", TopicsLoader);
  customElements.define("topic-loader", TopicLoader);
  customElements.define("hover-loader", HoverLoader);

  // Register sections
  customElements.define("post-section", PostSection);
  customElements.define("profile-section", ProfileSection);
  customElements.define("topic-section", TopicSection);

  // Register stats
  customElements.define("activity-item", ActivityItem);
  customElements.define("all-stat", AllStat);
  customElements.define("replies-stat", RepliesStat);
  customElements.define("stat-reply", StatReply);
  customElements.define("stat-story", StatStory);
  customElements.define("stories-stat", StoriesStat);
  customElements.define("users-stat", UsersStat);
  customElements.define("month-stat", MonthStat);
  customElements.define("update-item", UpdateItem);
  customElements.define("content-story", ContentStory);
  customElements.define("content-reply", ContentReply);

  // Register wrappers
  customElements.define("author-wrapper", AuthorWrapper);
  customElements.define("header-wrapper", HeaderWrapper);
  customElements.define("person-wrapper", PersonWrapper);
  customElements.define("profile-wrapper", ProfileWrapper);
  customElements.define("share-wrapper", ShareWrapper);
  customElements.define("user-wrapper", UserWrapper);
  customElements.define("topic-wrapper", TopicWrapper);
  customElements.define("hover-author", HoverAuthor);
  customElements.define("votes-wrapper", VotesAuthor);
  customElements.define("action-wrapper", ActionWrapper);
  customElements.define("images-wrapper", ImagesWrapper);
  customElements.define("images-uploader", ImagesUploader);

  // Register popups
  customElements.define("join-popup", JoinPopup);
  customElements.define("url-popup", UrlPopup);
  customElements.define("stats-popup", StatsPopup);
  customElements.define("contact-popup", ContactPopup);
  customElements.define("topic-popup", TopicPopup);
  customElements.define("views-popup", ViewsPopup);
  customElements.define("preview-popup", PreviewPopup);
  customElements.define("notify-popup", NotifyPopup);
  customElements.define("post-options", PostOptions);
  customElements.define("image-popup", ImagePopup);


  // add event listener document loaded
  document.addEventListener("DOMContentLoaded", () => {
    // create app manager
    const appManager = new AppManager();
    appManager.start();
  });

  window.matchMedia('(display-mode: standalone)').addEventListener('change', (evt) => {
    let displayMode = 'browser';
    if (evt.matches) {
      displayMode = 'standalone';
    }
    // Log display mode change to analytics
    console.log('DISPLAY_MODE_CHANGED', displayMode);
  });

})();
